<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ti › wlcore › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is part of wl1271</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008-2010 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Contact: Luciano Coelho &lt;luciano.coelho@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/wl12xx.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &quot;wlcore.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;wl12xx_80211.h&quot;</span>
<span class="cp">#include &quot;io.h&quot;</span>
<span class="cp">#include &quot;event.h&quot;</span>
<span class="cp">#include &quot;tx.h&quot;</span>
<span class="cp">#include &quot;rx.h&quot;</span>
<span class="cp">#include &quot;ps.h&quot;</span>
<span class="cp">#include &quot;init.h&quot;</span>
<span class="cp">#include &quot;debugfs.h&quot;</span>
<span class="cp">#include &quot;cmd.h&quot;</span>
<span class="cp">#include &quot;boot.h&quot;</span>
<span class="cp">#include &quot;testmode.h&quot;</span>
<span class="cp">#include &quot;scan.h&quot;</span>
<span class="cp">#include &quot;hw_ops.h&quot;</span>

<span class="cp">#define WL1271_BOOT_RETRIES 3</span>

<span class="cp">#define WL1271_BOOT_RETRIES 3</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fwlog_param</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">bug_on_recovery</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">no_recovery</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__wl1271_op_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
					 <span class="n">bool</span> <span class="n">reset_tx_queues</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">wl1271_op_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">wl1271_free_ap_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_set_authorized</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">!=</span> <span class="n">BSS_TYPE_STA_BSS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_STATE_SENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_set_peer_state</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl12xx_croc</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">);</span>

	<span class="n">wl1271_info</span><span class="p">(</span><span class="s">&quot;Association completed.&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_reg_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">regulatory_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">band</span> <span class="o">=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">band</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">band</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_RADAR</span><span class="p">)</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
				     <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_set_rx_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				   <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* we should hold wl-&gt;mutex */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_ps_rx_streaming</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_RX_STREAMING_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_RX_STREAMING_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * this function is being called when the rx_streaming interval</span>
<span class="cm"> * has beed changed or rx_streaming should be disabled</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wl1271_recalc_rx_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">period</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx_streaming</span><span class="p">.</span><span class="n">interval</span><span class="p">;</span>

	<span class="cm">/* don&#39;t reconfigure if rx_streaming is disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_RX_STREAMING_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* reconfigure/disable according to new streaming_period */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">period</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx_streaming</span><span class="p">.</span><span class="n">always</span> <span class="o">||</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_SOFT_GEMINI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_set_rx_streaming</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_set_rx_streaming</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="cm">/* don&#39;t cancel_work_sync since we might deadlock */</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rx_streaming_timer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_rx_streaming_enable_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span><span class="p">,</span>
						<span class="n">rx_streaming_enable_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_RX_STREAMING_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx_streaming</span><span class="p">.</span><span class="n">always</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_SOFT_GEMINI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx_streaming</span><span class="p">.</span><span class="n">interval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_set_rx_streaming</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

	<span class="cm">/* stop it after some time of inactivity */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rx_streaming_timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx_streaming</span><span class="p">.</span><span class="n">duration</span><span class="p">));</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_rx_streaming_disable_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span><span class="p">,</span>
						<span class="n">rx_streaming_disable_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_RX_STREAMING_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_set_rx_streaming</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_rx_streaming_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rx_streaming_disable_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* wl-&gt;mutex must be taken */</span>
<span class="kt">void</span> <span class="nf">wl12xx_rearm_tx_watchdog_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* if the watchdog is not armed, don&#39;t do anything */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_allocated_blocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_watchdog_work</span><span class="p">);</span>
	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_watchdog_work</span><span class="p">,</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_watchdog_timeout</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_tx_watchdog_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>

	<span class="n">dwork</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">delayed_work</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl1271</span><span class="p">,</span> <span class="n">tx_watchdog_work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Tx went out in the meantime - everything is ok */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_allocated_blocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if a ROC is in progress, we might not have any Tx for a long</span>
<span class="cm">	 * time (e.g. pending Tx on the non-ROC channels)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">find_first_bit</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">roc_map</span><span class="p">,</span> <span class="n">WL12XX_MAX_ROLES</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WL12XX_MAX_ROLES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_TX</span><span class="p">,</span> <span class="s">&quot;No Tx (in FW) for %d ms due to ROC&quot;</span><span class="p">,</span>
			     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_watchdog_timeout</span><span class="p">);</span>
		<span class="n">wl12xx_rearm_tx_watchdog_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * if a scan is in progress, we might not have any Tx for a long</span>
<span class="cm">	 * time</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WL1271_SCAN_STATE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_TX</span><span class="p">,</span> <span class="s">&quot;No Tx (in FW) for %d ms due to scan&quot;</span><span class="p">,</span>
			     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_watchdog_timeout</span><span class="p">);</span>
		<span class="n">wl12xx_rearm_tx_watchdog_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	* AP might cache a frame for a long time for a sleeping station,</span>
<span class="cm">	* so rearm the timer if there&#39;s an AP interface with stations. If</span>
<span class="cm">	* Tx is genuinely stuck we will most hopefully discover it when all</span>
<span class="cm">	* stations are removed due to inactivity.</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_sta_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_TX</span><span class="p">,</span> <span class="s">&quot;No Tx (in FW) for %d ms. AP has &quot;</span>
			     <span class="s">&quot; %d stations&quot;</span><span class="p">,</span>
			      <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_watchdog_timeout</span><span class="p">,</span>
			      <span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_sta_count</span><span class="p">);</span>
		<span class="n">wl12xx_rearm_tx_watchdog_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Tx stuck (in FW) for %d ms. Starting recovery&quot;</span><span class="p">,</span>
		     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_watchdog_timeout</span><span class="p">);</span>
	<span class="n">wl12xx_queue_recovery_work</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wlcore_adjust_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Adjust settings according to optional module parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwlog_param</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">fwlog_param</span><span class="p">,</span> <span class="s">&quot;continuous&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WL12XX_FWLOG_CONTINUOUS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">fwlog_param</span><span class="p">,</span> <span class="s">&quot;ondemand&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WL12XX_FWLOG_ON_DEMAND</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">fwlog_param</span><span class="p">,</span> <span class="s">&quot;dbgpins&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">WL12XX_FWLOG_CONTINUOUS</span><span class="p">;</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">WL12XX_FWLOG_OUTPUT_DBG_PINS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">fwlog_param</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">mem_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">WL12XX_FWLOG_OUTPUT_NONE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Unknown fwlog parameter %s&quot;</span><span class="p">,</span> <span class="n">fwlog_param</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_plt_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw_init</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_init_mem_config</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_acx_mem_cfg</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_memmap</span><span class="p">;</span>

	<span class="cm">/* Enable data path */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_data_path</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_memmap</span><span class="p">;</span>

	<span class="cm">/* Configure for CAM power saving (ie. always active) */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_sleep_auth</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">WL1271_PSM_CAM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_memmap</span><span class="p">;</span>

	<span class="cm">/* configure PM */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_pm_config</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_memmap</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free_memmap:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">target_mem_map</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">target_mem_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_irq_ps_regulate_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">hlid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tx_pkts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">fw_ps</span><span class="p">,</span> <span class="n">single_sta</span><span class="p">;</span>

	<span class="n">fw_ps</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">hlid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_fw_ps_map</span><span class="p">);</span>
	<span class="n">single_sta</span> <span class="o">=</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_sta_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wake up from high level PS if the STA is asleep with too little</span>
<span class="cm">	 * packets in FW or if the STA is awake.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw_ps</span> <span class="o">||</span> <span class="n">tx_pkts</span> <span class="o">&lt;</span> <span class="n">WL1271_PS_STA_MAX_PACKETS</span><span class="p">)</span>
		<span class="n">wl12xx_ps_link_end</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">hlid</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start high-level PS if the STA is asleep with enough blocks in FW.</span>
<span class="cm">	 * Make an exception if this is the only connected station. In this</span>
<span class="cm">	 * case FW-memory congestion is not a problem.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">single_sta</span> <span class="o">&amp;&amp;</span> <span class="n">fw_ps</span> <span class="o">&amp;&amp;</span> <span class="n">tx_pkts</span> <span class="o">&gt;=</span> <span class="n">WL1271_PS_STA_MAX_PACKETS</span><span class="p">)</span>
		<span class="n">wl12xx_ps_link_start</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">hlid</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_irq_update_links_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">wl_fw_status</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_link</span> <span class="o">*</span><span class="n">lnk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_fw_ps_map</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hlid</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/* TODO: also use link_fast_bitmap here */</span>

	<span class="n">cur_fw_ps_map</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">link_ps_bitmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_fw_ps_map</span> <span class="o">!=</span> <span class="n">cur_fw_ps_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_PSM</span><span class="p">,</span>
			     <span class="s">&quot;link ps prev 0x%x cur 0x%x changed 0x%x&quot;</span><span class="p">,</span>
			     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_fw_ps_map</span><span class="p">,</span> <span class="n">cur_fw_ps_map</span><span class="p">,</span>
			     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_fw_ps_map</span> <span class="o">^</span> <span class="n">cur_fw_ps_map</span><span class="p">);</span>

		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_fw_ps_map</span> <span class="o">=</span> <span class="n">cur_fw_ps_map</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">hlid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">sta_hlid_map</span><span class="p">,</span> <span class="n">WL12XX_MAX_LINKS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lnk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">hlid</span><span class="p">];</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">tx_lnk_free_pkts</span><span class="p">[</span><span class="n">hlid</span><span class="p">]</span> <span class="o">-</span>
			<span class="n">lnk</span><span class="o">-&gt;</span><span class="n">prev_freed_pkts</span><span class="p">;</span>

		<span class="n">lnk</span><span class="o">-&gt;</span><span class="n">prev_freed_pkts</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">tx_lnk_free_pkts</span><span class="p">[</span><span class="n">hlid</span><span class="p">];</span>
		<span class="n">lnk</span><span class="o">-&gt;</span><span class="n">allocated_pkts</span> <span class="o">-=</span> <span class="n">cnt</span><span class="p">;</span>

		<span class="n">wl12xx_irq_ps_regulate_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">hlid</span><span class="p">,</span>
					    <span class="n">lnk</span><span class="o">-&gt;</span><span class="n">allocated_pkts</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_fw_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">wl_fw_status</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">old_tx_blk_count</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_available</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">avail</span><span class="p">,</span> <span class="n">freed_blocks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">status_len</span><span class="p">;</span>

	<span class="n">status_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">status</span><span class="p">)</span> <span class="o">+</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status_priv_len</span><span class="p">;</span>

	<span class="n">wlcore_raw_read_data</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">REG_RAW_FW_STATUS_ADDR</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			     <span class="n">status_len</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;intr: 0x%x (fw_rx_counter = %d, &quot;</span>
		     <span class="s">&quot;drv_rx_counter = %d, tx_results_counter = %d)&quot;</span><span class="p">,</span>
		     <span class="n">status</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">,</span>
		     <span class="n">status</span><span class="o">-&gt;</span><span class="n">fw_rx_counter</span><span class="p">,</span>
		     <span class="n">status</span><span class="o">-&gt;</span><span class="n">drv_rx_counter</span><span class="p">,</span>
		     <span class="n">status</span><span class="o">-&gt;</span><span class="n">tx_results_counter</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* prevent wrap-around in freed-packets counter */</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_allocated_pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span>
				<span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">tx_released_pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span>
				<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_pkts_freed</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_pkts_freed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">counters</span><span class="p">.</span><span class="n">tx_released_pkts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* prevent wrap-around in total blocks counter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_freed</span> <span class="o">&lt;=</span>
		   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">total_released_blks</span><span class="p">)))</span>
		<span class="n">freed_blocks</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">total_released_blks</span><span class="p">)</span> <span class="o">-</span>
			       <span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_freed</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">freed_blocks</span> <span class="o">=</span> <span class="mh">0x100000000LL</span> <span class="o">-</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_freed</span> <span class="o">+</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">total_released_blks</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_freed</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">total_released_blks</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_allocated_blocks</span> <span class="o">-=</span> <span class="n">freed_blocks</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the FW freed some blocks:</span>
<span class="cm">	 * If we still have allocated blocks - re-arm the timer, Tx is</span>
<span class="cm">	 * not stuck. Otherwise, cancel the timer (no Tx currently).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freed_blocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_allocated_blocks</span><span class="p">)</span>
			<span class="n">wl12xx_rearm_tx_watchdog_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_watchdog_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">avail</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">tx_total</span><span class="p">)</span> <span class="o">-</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_allocated_blocks</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The FW might change the total number of TX memblocks before</span>
<span class="cm">	 * we get a notification about blocks being released. Thus, the</span>
<span class="cm">	 * available blocks calculation might yield a temporary result</span>
<span class="cm">	 * which is lower than the actual available blocks. Keeping in</span>
<span class="cm">	 * mind that only blocks that were allocated can be moved from</span>
<span class="cm">	 * TX to RX, tx_blocks_available should never decrease here.</span>
<span class="cm">	 */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_available</span> <span class="o">=</span> <span class="n">max</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_available</span><span class="p">,</span>
				      <span class="n">avail</span><span class="p">);</span>

	<span class="cm">/* if more blocks are available now, tx work can be scheduled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_available</span> <span class="o">&gt;</span> <span class="n">old_tx_blk_count</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_FW_TX_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* for AP update num of allocated TX blocks per link and ps status */</span>
	<span class="n">wl12xx_for_each_wlvif_ap</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl12xx_irq_update_links_status</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* update the host-chipset time offset */</span>
	<span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">time_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">timespec_to_ns</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span>
		<span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">fw_localtime</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_flush_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* Pass all received frames to the network stack */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">deferred_rx_queue</span><span class="p">)))</span>
		<span class="n">ieee80211_rx_ni</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* Return sent skbs to the network stack */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">deferred_tx_queue</span><span class="p">)))</span>
		<span class="n">ieee80211_tx_status_ni</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_netstack_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl1271</span><span class="p">,</span> <span class="n">netstack_work</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">wl1271_flush_deferred_work</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">deferred_rx_queue</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define WL1271_IRQ_MAX_LOOPS 256</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wl1271_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loopcount</span> <span class="o">=</span> <span class="n">WL1271_IRQ_MAX_LOOPS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="p">)</span><span class="n">cookie</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">defer_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* TX might be handled here, avoid redundant work */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_TX_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case edge triggered interrupt must be used, we cannot iterate</span>
<span class="cm">	 * more than once without introducing race conditions with the hardirq.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">platform_quirks</span> <span class="o">&amp;</span> <span class="n">WL12XX_PLATFORM_QUIRK_EDGE_IRQ</span><span class="p">)</span>
		<span class="n">loopcount</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;IRQ work&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="n">loopcount</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * In order to avoid a race with the hardirq, clear the flag</span>
<span class="cm">		 * before acknowledging the chip. Since the mutex is held,</span>
<span class="cm">		 * wl1271_ps_elp_wakeup cannot be called concurrently.</span>
<span class="cm">		 */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_IRQ_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">smp_mb__after_clear_bit</span><span class="p">();</span>

		<span class="n">wl12xx_fw_status</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">);</span>

		<span class="n">wlcore_hw_tx_immediate_compl</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

		<span class="n">intr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
		<span class="n">intr</span> <span class="o">&amp;=</span> <span class="n">WL1271_INTR_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1271_ACX_INTR_WATCHDOG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;watchdog interrupt received! &quot;</span>
				     <span class="s">&quot;starting recovery.&quot;</span><span class="p">);</span>
			<span class="n">wl12xx_queue_recovery_work</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

			<span class="cm">/* restarting the chip. ignore any other interrupt. */</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1271_ACX_INTR_DATA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;WL1271_ACX_INTR_DATA&quot;</span><span class="p">);</span>

			<span class="n">wl12xx_rx</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">);</span>

			<span class="cm">/* Check if any tx blocks were freed */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_FW_TX_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">wl1271_tx_total_queue_count</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * In order to avoid starvation of the TX path,</span>
<span class="cm">				 * call the work function directly.</span>
<span class="cm">				 */</span>
				<span class="n">wl1271_tx_work_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* check for tx results */</span>
			<span class="n">wlcore_hw_tx_delayed_compl</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

			<span class="cm">/* Make sure the deferred queues don&#39;t get too long */</span>
			<span class="n">defer_count</span> <span class="o">=</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">deferred_tx_queue</span><span class="p">)</span> <span class="o">+</span>
				      <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">deferred_rx_queue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">defer_count</span> <span class="o">&gt;</span> <span class="n">WL1271_DEFERRED_QUEUE_LIMIT</span><span class="p">)</span>
				<span class="n">wl1271_flush_deferred_work</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1271_ACX_INTR_EVENT_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;WL1271_ACX_INTR_EVENT_A&quot;</span><span class="p">);</span>
			<span class="n">wl1271_event_handle</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1271_ACX_INTR_EVENT_B</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;WL1271_ACX_INTR_EVENT_B&quot;</span><span class="p">);</span>
			<span class="n">wl1271_event_handle</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1271_ACX_INTR_INIT_COMPLETE</span><span class="p">)</span>
			<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span>
				     <span class="s">&quot;WL1271_ACX_INTR_INIT_COMPLETE&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1271_ACX_INTR_HW_AVAILABLE</span><span class="p">)</span>
			<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;WL1271_ACX_INTR_HW_AVAILABLE&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* In case TX was not handled here, queue TX work */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_TX_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_FW_TX_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wl1271_tx_total_queue_count</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">vif_counter_data</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">counter</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">cur_vif</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cur_vif_running</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_vif_count_iter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vif_counter_data</span> <span class="o">*</span><span class="n">counter</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">counter</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">counter</span><span class="o">-&gt;</span><span class="n">cur_vif</span> <span class="o">==</span> <span class="n">vif</span><span class="p">)</span>
		<span class="n">counter</span><span class="o">-&gt;</span><span class="n">cur_vif_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* caller must not hold wl-&gt;mutex, as it might deadlock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_get_vif_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">cur_vif</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">vif_counter_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">));</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">cur_vif</span> <span class="o">=</span> <span class="n">cur_vif</span><span class="p">;</span>

	<span class="n">ieee80211_iterate_active_interfaces</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					    <span class="n">wl12xx_vif_count_iter</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_fetch_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">bool</span> <span class="n">plt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_name</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">wl12xx_fw_type</span> <span class="n">fw_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">plt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fw_type</span> <span class="o">=</span> <span class="n">WL12XX_FW_TYPE_PLT</span><span class="p">;</span>
		<span class="n">fw_name</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">plt_fw_name</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * we can&#39;t call wl12xx_get_vif_count() here because</span>
<span class="cm">		 * wl-&gt;mutex is taken, so use the cached last_vif_count value</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">last_vif_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fw_type</span> <span class="o">=</span> <span class="n">WL12XX_FW_TYPE_MULTI</span><span class="p">;</span>
			<span class="n">fw_name</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">mr_fw_name</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fw_type</span> <span class="o">=</span> <span class="n">WL12XX_FW_TYPE_NORMAL</span><span class="p">;</span>
			<span class="n">fw_name</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">sr_fw_name</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_type</span> <span class="o">==</span> <span class="n">fw_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_BOOT</span><span class="p">,</span> <span class="s">&quot;booting firmware %s&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;could not get firmware %s: %d&quot;</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;firmware size is not multiple of 32 bits: %zu&quot;</span><span class="p">,</span>
			     <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_type</span> <span class="o">=</span> <span class="n">WL12XX_FW_TYPE_NONE</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_len</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;could not allocate memory for the firmware&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_type</span> <span class="o">=</span> <span class="n">fw_type</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_fetch_nvs</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">WL12XX_NVS_NAME</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;could not get nvs file %s: %d&quot;</span><span class="p">,</span> <span class="n">WL12XX_NVS_NAME</span><span class="p">,</span>
			     <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;could not allocate memory for the nvs file&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs_len</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wl12xx_queue_recovery_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_RECOVERY_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">recovery_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">size_t</span> <span class="nf">wl12xx_copy_fwlog</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">memblock</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">maxlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* The FW log is a length-value list, find where the log end */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memblock</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">memblock</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">maxlen</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">memblock</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure we have enough room */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_size</span><span class="p">));</span>

	<span class="cm">/* Fill the FW log file, consumed by the sysfs fwlog entry */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog</span> <span class="o">+</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_size</span><span class="p">,</span> <span class="n">memblock</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_size</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_read_fwlog_panic</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">first_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">WLCORE_QUIRK_FWLOG_NOT_IMPLEMENTED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">WL12XX_FWLOG_ON_DEMAND</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">mem_blocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wl1271_info</span><span class="p">(</span><span class="s">&quot;Reading FW panic log&quot;</span><span class="p">);</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">WL12XX_HW_BLOCK_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure the chip is awake and the logger isn&#39;t active.</span>
<span class="cm">	 * This might fail if the firmware hanged.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span>
		<span class="n">wl12xx_cmd_stop_fwlog</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="cm">/* Read the first memory block address */</span>
	<span class="n">wl12xx_fw_status</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">);</span>
	<span class="n">first_addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="o">-&gt;</span><span class="n">log_start_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first_addr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Traverse the memory blocks linked list */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">first_addr</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WL12XX_HW_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">wl1271_read_hwaddr</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">WL12XX_HW_BLOCK_SIZE</span><span class="p">,</span>
				   <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Memory blocks are linked to one another. The first 4 bytes</span>
<span class="cm">		 * of each memory block hold the hardware address of the next</span>
<span class="cm">		 * one. The last memory block points to the first one.</span>
<span class="cm">		 */</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">le32_to_cpup</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">block</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl12xx_copy_fwlog</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">block</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span>
				       <span class="n">WL12XX_HW_BLOCK_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">first_addr</span><span class="p">));</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_waitq</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_recovery_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl1271</span><span class="p">,</span> <span class="n">recovery_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WL1271_STATE_ON</span> <span class="o">||</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">plt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="cm">/* Avoid a recursive recovery */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_RECOVERY_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">wl12xx_read_fwlog_panic</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">wl1271_info</span><span class="p">(</span><span class="s">&quot;Hardware recovery in progress. FW ver: %s pc: 0x%x&quot;</span><span class="p">,</span>
		    <span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">fw_ver_str</span><span class="p">,</span>
		    <span class="n">wlcore_read_reg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">REG_PC_ON_RECOVERY</span><span class="p">));</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bug_on_recovery</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_INTENDED_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_recovery</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_info</span><span class="p">(</span><span class="s">&quot;No recovery (chosen on module load). Fw will remain stuck.&quot;</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_RECOVERY_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bug_on_recovery</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Advance security sequence number to overcome potential progress</span>
<span class="cm">	 * in the firmware during recovery. This doens&#39;t hurt if the network is</span>
<span class="cm">	 * not encrypted.</span>
<span class="cm">	 */</span>
	<span class="n">wl12xx_for_each_wlvif</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_AP_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">tx_security_seq</span> <span class="o">+=</span>
				<span class="n">WL1271_TX_SQN_POST_RECOVERY_PADDING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Prevent spurious TX during FW restart */</span>
	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">sched_scanning</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_sched_scan_stopped</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">sched_scanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reboot the chipset */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlvif_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wlvif</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlvif_list</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">wl12xx_vif</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>
		<span class="n">__wl1271_op_remove_interface</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wl1271_op_stop</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_RECOVERY_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">ieee80211_restart_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Its safe to enable TX now - the queues are stopped after a request</span>
<span class="cm">	 * to restart the HW.</span>
<span class="cm">	 */</span>
	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_fw_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wl1271_raw_write32</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">HW_ACCESS_ELP_CTRL_REG</span><span class="p">,</span> <span class="n">ELPCTRL_WAKE_UP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_res_if</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_res_if</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_res_if</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_set_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="n">WL1271_PRE_POWER_ON_SLEEP</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_power_on</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">WL1271_POWER_ON_SLEEP</span><span class="p">);</span>
	<span class="n">wl1271_io_reset</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">wl1271_io_init</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">wlcore_set_partition</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ptable</span><span class="p">[</span><span class="n">PART_BOOT</span><span class="p">]);</span>

	<span class="cm">/* ELP module wake up */</span>
	<span class="n">wl1271_fw_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_chip_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">bool</span> <span class="n">plt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_set_power_on</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For wl127x based devices we could use the default block</span>
<span class="cm">	 * size (512 bytes), but due to a bug in the sdio driver, we</span>
<span class="cm">	 * need to set it explicitly after the chip is powered on.  To</span>
<span class="cm">	 * simplify the code and since the performance impact is</span>
<span class="cm">	 * negligible, we use the same block size for all different</span>
<span class="cm">	 * chip types.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl1271_set_block_size</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">|=</span> <span class="n">WLCORE_QUIRK_TX_BLOCKSIZE_ALIGN</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">identify_chip</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* TODO: make sure the lower driver has set things up correctly */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_setup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_fetch_firmware</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">plt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* No NVS from netlink, try to get it from the filesystem */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_fetch_nvs</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_plt_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="n">WL1271_BOOT_RETRIES</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wl1271_notice</span><span class="p">(</span><span class="s">&quot;power up&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WL1271_STATE_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;cannot go into PLT state because not &quot;</span>
			     <span class="s">&quot;in off state: %d&quot;</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retries</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_chip_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">power_off</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">boot</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">power_off</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_plt_init</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">irq_disable</span><span class="p">;</span>

		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">plt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL1271_STATE_ON</span><span class="p">;</span>
		<span class="n">wl1271_notice</span><span class="p">(</span><span class="s">&quot;firmware booted in PLT mode (%s)&quot;</span><span class="p">,</span>
			      <span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">fw_ver_str</span><span class="p">);</span>

		<span class="cm">/* update hw/fw version info in wiphy struct */</span>
		<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">hw_version</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">fw_ver_str</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>

		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">irq_disable:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="cm">/* Unlocking the mutex in the middle of handling is</span>
<span class="cm">		   inherently unsafe. In this case we deem it safe to do,</span>
<span class="cm">		   because we need to let any possibly pending IRQ out of</span>
<span class="cm">		   the system (and while we are WL1271_STATE_OFF the IRQ</span>
<span class="cm">		   work function will not do anything.) Also, any other</span>
<span class="cm">		   possible concurrent operations will fail due to the</span>
<span class="cm">		   current state, hence the wl1271 struct should be safe. */</span>
		<span class="n">wlcore_disable_interrupts</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="n">wl1271_flush_deferred_work</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">netstack_work</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">power_off:</span>
		<span class="n">wl1271_power_off</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;firmware boot in PLT mode failed despite %d retries&quot;</span><span class="p">,</span>
		     <span class="n">WL1271_BOOT_RETRIES</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_plt_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_notice</span><span class="p">(</span><span class="s">&quot;power down&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Interrupts must be disabled before setting the state to OFF.</span>
<span class="cm">	 * Otherwise, the interrupt handler might be called and exit without</span>
<span class="cm">	 * reading the interrupt status.</span>
<span class="cm">	 */</span>
	<span class="n">wlcore_disable_interrupts</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">plt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * This will not necessarily enable interrupts as interrupts</span>
<span class="cm">		 * may have been disabled when op_stop was called. It will,</span>
<span class="cm">		 * however, balance the above call to disable_interrupts().</span>
<span class="cm">		 */</span>
		<span class="n">wlcore_enable_interrupts</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;cannot power down because not in PLT &quot;</span>
			     <span class="s">&quot;state: %d&quot;</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wl1271_flush_deferred_work</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">netstack_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">recovery_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">elp_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_watchdog_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">connection_loss_work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wl1271_power_off</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL1271_STATE_OFF</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">plt</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_op_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q</span><span class="p">,</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hlid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="p">)</span>
		<span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="n">mapping</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">wl1271_tx_get_queue</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>

	<span class="n">hlid</span> <span class="o">=</span> <span class="n">wl12xx_tx_get_hlid</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* queue the packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hlid</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_LINK_ID</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wlvif</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">hlid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">links_map</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_TX</span><span class="p">,</span> <span class="s">&quot;DROP skb hlid %d q %d&quot;</span><span class="p">,</span> <span class="n">hlid</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
		<span class="n">ieee80211_free_txskb</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_TX</span><span class="p">,</span> <span class="s">&quot;queue skb hlid %d q %d len %d&quot;</span><span class="p">,</span>
		     <span class="n">hlid</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">hlid</span><span class="p">].</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_count</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The workqueue is slow to process the tx_queue and we need stop</span>
<span class="cm">	 * the queue here, otherwise the queue will get too long.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_count</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">WL1271_TX_QUEUE_HIGH_WATERMARK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_TX</span><span class="p">,</span> <span class="s">&quot;op_tx: stopping queues for q %d&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
		<span class="n">ieee80211_stop_queue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">stopped_queues_map</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The chip specific setup must run before the first TX packet -</span>
<span class="cm">	 * before that, the tx_work will not be initialized!</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_FW_TX_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_TX_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_tx_dummy_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q</span><span class="p">;</span>

	<span class="cm">/* no need to queue a new dummy packet if one is already pending */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_DUMMY_PACKET_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">wl1271_tx_get_queue</span><span class="p">(</span><span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dummy_packet</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_DUMMY_PACKET_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_count</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* The FW is low on RX memory blocks, so send the dummy packet asap */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_FW_TX_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">wl1271_tx_work_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the FW TX is busy, TX work will be scheduled by the threaded</span>
<span class="cm">	 * interrupt handler function</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The size of the dummy packet should be at least 1400 bytes. However, in</span>
<span class="cm"> * order to minimize the number of bus transactions, aligning it to 512 bytes</span>
<span class="cm"> * boundaries could be beneficial, performance wise</span>
<span class="cm"> */</span>
<span class="cp">#define TOTAL_TX_DUMMY_PACKET_SIZE (ALIGN(1400, 512))</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">wl12xx_alloc_dummy_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dummy_packet_size</span><span class="p">;</span>

	<span class="n">dummy_packet_size</span> <span class="o">=</span> <span class="n">TOTAL_TX_DUMMY_PACKET_SIZE</span> <span class="o">-</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_tx_hw_descr</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">TOTAL_TX_DUMMY_PACKET_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Failed to allocate a dummy packet skb&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_tx_hw_descr</span><span class="p">));</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span>
					 <span class="n">IEEE80211_STYPE_NULLFUNC</span> <span class="o">|</span>
					 <span class="n">IEEE80211_FCTL_TODS</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dummy_packet_size</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dummy_packet_size</span><span class="p">);</span>

	<span class="cm">/* Dummy packets require the TID to be management */</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">WL1271_TID_MGMT</span><span class="p">;</span>

	<span class="cm">/* Initialize all fields that might be used */</span>
	<span class="n">skb_set_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_info</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">wl1271_validate_wowlan_pattern</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_wowlan_trig_pkt_pattern</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num_fields</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">in_field</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fields_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pattern_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;No mask in WoWLAN pattern&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The pattern is broken up into segments of bytes at different offsets</span>
<span class="cm">	 * that need to be checked by the FW filter. Each segment is called</span>
<span class="cm">	 * a field in the FW API. We verify that the total number of fields</span>
<span class="cm">	 * required for this pattern won&#39;t exceed FW limits (8)</span>
<span class="cm">	 * as well as the total fields buffer won&#39;t exceed the FW limit.</span>
<span class="cm">	 * Note that if there&#39;s a pattern which crosses Ethernet/IP header</span>
<span class="cm">	 * boundary a new field is required.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pattern_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_field</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">in_field</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">pattern_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">WL1271_RX_FILTER_ETH_HEADER_SIZE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">num_fields</span><span class="o">++</span><span class="p">;</span>
					<span class="n">fields_size</span> <span class="o">+=</span> <span class="n">pattern_len</span> <span class="o">+</span>
						<span class="n">RX_FILTER_FIELD_OVERHEAD</span><span class="p">;</span>
					<span class="n">pattern_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">pattern_len</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">in_field</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">in_field</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">fields_size</span> <span class="o">+=</span> <span class="n">pattern_len</span> <span class="o">+</span>
					<span class="n">RX_FILTER_FIELD_OVERHEAD</span><span class="p">;</span>
				<span class="n">num_fields</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fields_size</span> <span class="o">+=</span> <span class="n">pattern_len</span> <span class="o">+</span> <span class="n">RX_FILTER_FIELD_OVERHEAD</span><span class="p">;</span>
		<span class="n">num_fields</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_fields</span> <span class="o">&gt;</span> <span class="n">WL1271_RX_FILTER_MAX_FIELDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;RX Filter too complex. Too many segments&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fields_size</span> <span class="o">&gt;</span> <span class="n">WL1271_RX_FILTER_MAX_FIELDS_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;RX filter pattern is too big&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">wl12xx_rx_filter</span> <span class="o">*</span><span class="nf">wl1271_rx_filter_alloc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_rx_filter</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wl1271_rx_filter_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_rx_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">num_fields</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_rx_filter_alloc_field</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_rx_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">pattern</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_rx_filter_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">num_fields</span> <span class="o">==</span> <span class="n">WL1271_RX_FILTER_MAX_FIELDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Max fields per RX filter. can&#39;t alloc another&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">field</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">filter</span><span class="o">-&gt;</span><span class="n">num_fields</span><span class="p">];</span>

	<span class="n">field</span><span class="o">-&gt;</span><span class="n">pattern</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Failed to allocate RX filter pattern&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">filter</span><span class="o">-&gt;</span><span class="n">num_fields</span><span class="o">++</span><span class="p">;</span>

	<span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">field</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_rx_filter_get_fields_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_rx_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fields_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">num_fields</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fields_size</span> <span class="o">+=</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_rx_filter_field</span><span class="p">)</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fields_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wl1271_rx_filter_flatten_fields</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_rx_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">,</span>
				    <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_rx_filter_field</span> <span class="o">*</span><span class="n">field</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">num_fields</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_rx_filter_field</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

		<span class="n">field</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">field</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">field</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">field</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern</span><span class="p">,</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_rx_filter_field</span><span class="p">)</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">+</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocates an RX filter returned through f</span>
<span class="cm"> * which needs to be freed using rx_filter_free()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_convert_wowlan_pattern_to_rx_filter</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">cfg80211_wowlan_trig_pkt_pattern</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">wl12xx_rx_filter</span> <span class="o">**</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_rx_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">filter</span> <span class="o">=</span> <span class="n">wl1271_rx_filter_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Failed to alloc rx filter&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pattern_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pattern_len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">WL1271_RX_FILTER_ETH_HEADER_SIZE</span> <span class="o">&amp;&amp;</span>
			    <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">WL1271_RX_FILTER_ETH_HEADER_SIZE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">WL1271_RX_FILTER_ETH_HEADER_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">WL1271_RX_FILTER_FLAG_ETHERNET_HEADER</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">WL1271_RX_FILTER_ETH_HEADER_SIZE</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">WL1271_RX_FILTER_FLAG_IP_HEADER</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_rx_filter_alloc_field</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span>
						   <span class="n">offset</span><span class="p">,</span>
						   <span class="n">flags</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pattern</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">filter</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">FILTER_SIGNAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="n">filter</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">wl1271_rx_filter_free</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
	<span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_configure_wowlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wow</span> <span class="o">||</span> <span class="n">wow</span><span class="o">-&gt;</span><span class="n">any</span> <span class="o">||</span> <span class="o">!</span><span class="n">wow</span><span class="o">-&gt;</span><span class="n">n_patterns</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_acx_default_rx_filter_enable</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FILTER_SIGNAL</span><span class="p">);</span>
		<span class="n">wl1271_rx_filter_clear_all</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">wow</span><span class="o">-&gt;</span><span class="n">n_patterns</span> <span class="o">&gt;</span> <span class="n">WL1271_MAX_RX_FILTERS</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Validate all incoming patterns before clearing current FW state */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wow</span><span class="o">-&gt;</span><span class="n">n_patterns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_validate_wowlan_pattern</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wow</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Bad wowlan pattern %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wl1271_acx_default_rx_filter_enable</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FILTER_SIGNAL</span><span class="p">);</span>
	<span class="n">wl1271_rx_filter_clear_all</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="cm">/* Translate WoWLAN patterns into filters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wow</span><span class="o">-&gt;</span><span class="n">n_patterns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cfg80211_wowlan_trig_pkt_pattern</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">wl12xx_rx_filter</span> <span class="o">*</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wow</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_convert_wowlan_pattern_to_rx_filter</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">filter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Failed to create an RX filter from &quot;</span>
				       <span class="s">&quot;wowlan pattern %d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_rx_filter_enable</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">filter</span><span class="p">);</span>

		<span class="n">wl1271_rx_filter_free</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_default_rx_filter_enable</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FILTER_DROP</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_configure_suspend_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl1271_configure_wowlan</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wow</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_wake_up_conditions</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span>
				    <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">suspend_wake_up_event</span><span class="p">,</span>
				    <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">suspend_listen_interval</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;suspend: set wake up conditions failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_configure_suspend_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_AP_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_beacon_filter_opt</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_configure_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">wl1271_configure_suspend_sta</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">wow</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">wl1271_configure_suspend_ap</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_configure_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_ap</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_sta</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">is_ap</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">is_sta</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_configure_wowlan</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_wake_up_conditions</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span>
				    <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">wake_up_event</span><span class="p">,</span>
				    <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">listen_interval</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;resume: wake up conditions failed: %d&quot;</span><span class="p">,</span>
				     <span class="n">ret</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_beacon_filter_opt</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wow</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 suspend wow=%d&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="n">wow</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wow</span><span class="p">);</span>

	<span class="n">wl1271_tx_flush</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wow_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">wl12xx_for_each_wlvif</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_configure_suspend</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">wow</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;couldn&#39;t prepare device to suspend&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="cm">/* flush any remaining work */</span>
	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;flushing remaining works&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * disable and re-enable interrupts in order to flush</span>
<span class="cm">	 * the threaded_irq</span>
<span class="cm">	 */</span>
	<span class="n">wlcore_disable_interrupts</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set suspended flag to avoid triggering a new threaded_irq</span>
<span class="cm">	 * work. no need for spinlock as interrupts are disabled.</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">wlcore_enable_interrupts</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">flush_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="n">flush_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">elp_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">run_irq_work</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 resume wow=%d&quot;</span><span class="p">,</span>
		     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">wow_enabled</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wow_enabled</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * re-enable irq_work enqueuing, and call irq_work directly if</span>
<span class="cm">	 * there is a pending work.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_PENDING_WORK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">run_irq_work</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">run_irq_work</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span>
			     <span class="s">&quot;run postponed irq_work directly&quot;</span><span class="p">);</span>
		<span class="n">wl1271_irq</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
		<span class="n">wlcore_enable_interrupts</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wl12xx_for_each_wlvif</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_configure_resume</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wow_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 start&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We have to delay the booting of the hardware because</span>
<span class="cm">	 * we need to know the local MAC address before downloading and</span>
<span class="cm">	 * initializing the firmware. The MAC address cannot be changed</span>
<span class="cm">	 * after boot, and without the proper MAC address, the firmware</span>
<span class="cm">	 * will not function properly.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The MAC address is first known when the corresponding interface</span>
<span class="cm">	 * is added. That is where we will initialize the hardware.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_op_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 stop&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Interrupts must be disabled before setting the state to OFF.</span>
<span class="cm">	 * Otherwise, the interrupt handler might be called and exit without</span>
<span class="cm">	 * reading the interrupt status.</span>
<span class="cm">	 */</span>
	<span class="n">wlcore_disable_interrupts</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * This will not necessarily enable interrupts as interrupts</span>
<span class="cm">		 * may have been disabled when op_stop was called. It will,</span>
<span class="cm">		 * however, balance the above call to disable_interrupts().</span>
<span class="cm">		 */</span>
		<span class="n">wlcore_enable_interrupts</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * this must be before the cancel_work calls below, so that the work</span>
<span class="cm">	 * functions don&#39;t perform further work.</span>
<span class="cm">	 */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL1271_STATE_OFF</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wl1271_flush_deferred_work</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_complete_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">netstack_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">elp_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_watchdog_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">connection_loss_work</span><span class="p">);</span>

	<span class="cm">/* let&#39;s notify MAC80211 about the remaining pending TX frames */</span>
	<span class="n">wl12xx_tx_reset</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wl1271_power_off</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">WL1271_DEFAULT_POWER_LEVEL</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_available</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_allocated_blocks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_results_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_packets_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">time_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_fw_ps_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_ps_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">sched_scanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">roles_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">roles_map</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">links_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">links_map</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">roc_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">roc_map</span><span class="p">));</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_sta_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* The system link is always allocated */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">WL12XX_SYSTEM_HLID</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">links_map</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * this is performed after the cancel_work calls and the associated</span>
<span class="cm">	 * mutex_lock, so that wl1271_op_add_interface does not accidentally</span>
<span class="cm">	 * get executed before all these vars have been reset.</span>
<span class="cm">	 */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_freed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_pkts_freed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_allocated_pkts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debugfs_reset</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_res_if</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_res_if</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">target_mem_map</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">target_mem_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_allocate_rate_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">policy</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rate_policies_map</span><span class="p">,</span>
					<span class="n">WL12XX_MAX_RATE_POLICIES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">policy</span> <span class="o">&gt;=</span> <span class="n">WL12XX_MAX_RATE_POLICIES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">rate_policies_map</span><span class="p">);</span>
	<span class="o">*</span><span class="n">idx</span> <span class="o">=</span> <span class="n">policy</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_free_rate_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">WL12XX_MAX_RATE_POLICIES</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">__clear_bit</span><span class="p">(</span><span class="o">*</span><span class="n">idx</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">rate_policies_map</span><span class="p">);</span>
	<span class="o">*</span><span class="n">idx</span> <span class="o">=</span> <span class="n">WL12XX_MAX_RATE_POLICIES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">wl12xx_get_role_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BSS_TYPE_AP_BSS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">p2p</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">WL1271_ROLE_P2P_GO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">WL1271_ROLE_AP</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BSS_TYPE_STA_BSS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">p2p</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">WL1271_ROLE_P2P_CL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">WL1271_ROLE_STA</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">BSS_TYPE_IBSS</span>:
		<span class="k">return</span> <span class="n">WL1271_ROLE_IBSS</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;invalid bss_type: %d&quot;</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">WL12XX_INVALID_ROLE_TYPE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_init_vif_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* clear everything but the persistent data */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wlvif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_vif</span><span class="p">,</span> <span class="n">persistent</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ieee80211_vif_type_p2p</span><span class="p">(</span><span class="n">vif</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_CLIENT</span>:
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">p2p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fall-through */</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">=</span> <span class="n">BSS_TYPE_STA_BSS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">=</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_P2P_GO</span>:
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">p2p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* fall-through */</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">=</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">=</span> <span class="n">MAX_BSS_TYPE</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_ROLE_ID</span><span class="p">;</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_ROLE_ID</span><span class="p">;</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_hlid</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span> <span class="o">||</span>
	    <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* init sta/ibss data */</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">;</span>
		<span class="n">wl12xx_allocate_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">basic_rate_idx</span><span class="p">);</span>
		<span class="n">wl12xx_allocate_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ap_rate_idx</span><span class="p">);</span>
		<span class="n">wl12xx_allocate_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">p2p_rate_idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* init ap data */</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_hlid</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">;</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">global_hlid</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">;</span>
		<span class="n">wl12xx_allocate_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">mgmt_rate_idx</span><span class="p">);</span>
		<span class="n">wl12xx_allocate_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_rate_idx</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONF_TX_MAX_AC_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">wl12xx_allocate_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">ucast_rate_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bitrate_masks</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">basic_rate</span><span class="p">;</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bitrate_masks</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">basic_rate_5</span><span class="p">;</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span> <span class="o">=</span> <span class="n">CONF_TX_RATE_MASK_BASIC</span><span class="p">;</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span> <span class="o">=</span> <span class="n">CONF_TX_RATE_MASK_BASIC</span><span class="p">;</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span> <span class="o">=</span> <span class="n">CONF_TX_RATE_MASK_BASIC</span><span class="p">;</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">beacon_int</span> <span class="o">=</span> <span class="n">WL1271_DEFAULT_BEACON_INT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * mac80211 configures some values globally, while we treat them</span>
<span class="cm">	 * per-interface. thus, on init, we have to copy them from wl</span>
<span class="cm">	 */</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rx_streaming_enable_work</span><span class="p">,</span>
		  <span class="n">wl1271_rx_streaming_enable_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rx_streaming_disable_work</span><span class="p">,</span>
		  <span class="n">wl1271_rx_streaming_disable_work</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rx_streaming_timer</span><span class="p">,</span> <span class="n">wl1271_rx_streaming_timer</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">wl12xx_init_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="n">WL1271_BOOT_RETRIES</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">booted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retries</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_chip_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">power_off</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">boot</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">power_off</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_hw_init</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">irq_disable</span><span class="p">;</span>

		<span class="n">booted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="nl">irq_disable:</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="cm">/* Unlocking the mutex in the middle of handling is</span>
<span class="cm">		   inherently unsafe. In this case we deem it safe to do,</span>
<span class="cm">		   because we need to let any possibly pending IRQ out of</span>
<span class="cm">		   the system (and while we are WL1271_STATE_OFF the IRQ</span>
<span class="cm">		   work function will not do anything.) Also, any other</span>
<span class="cm">		   possible concurrent operations will fail due to the</span>
<span class="cm">		   current state, hence the wl1271 struct should be safe. */</span>
		<span class="n">wlcore_disable_interrupts</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="n">wl1271_flush_deferred_work</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">netstack_work</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">power_off:</span>
		<span class="n">wl1271_power_off</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">booted</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;firmware boot failed despite %d retries&quot;</span><span class="p">,</span>
			     <span class="n">WL1271_BOOT_RETRIES</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_info</span><span class="p">(</span><span class="s">&quot;firmware booted (%s)&quot;</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">fw_ver_str</span><span class="p">);</span>

	<span class="cm">/* update hw/fw version info in wiphy struct */</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">hw_version</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">fw_ver_str</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we know if 11a is supported (info from the NVS), so disable</span>
<span class="cm">	 * 11a channels if not supported</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">enable_11a</span><span class="p">)</span>
		<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;11a is %ssupported&quot;</span><span class="p">,</span>
		     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">enable_11a</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL1271_STATE_ON</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">booted</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">wl12xx_dev_role_started</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_hlid</span> <span class="o">!=</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check whether a fw switch (i.e. moving from one loaded</span>
<span class="cm"> * fw to another) is needed. This function is also responsible</span>
<span class="cm"> * for updating wl-&gt;last_vif_count, so it must be called before</span>
<span class="cm"> * loading a non-plt fw (so the correct fw (single-role/multi-role)</span>
<span class="cm"> * will be used).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">wl12xx_need_fw_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">vif_counter_data</span> <span class="n">vif_counter_data</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">wl12xx_fw_type</span> <span class="n">current_fw</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vif_count</span> <span class="o">=</span> <span class="n">vif_counter_data</span><span class="p">.</span><span class="n">counter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_VIF_CHANGE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* increase the vif count if this is a new vif */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">add</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vif_counter_data</span><span class="p">.</span><span class="n">cur_vif_running</span><span class="p">)</span>
		<span class="n">vif_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">last_vif_count</span> <span class="o">=</span> <span class="n">vif_count</span><span class="p">;</span>

	<span class="cm">/* no need for fw change if the device is OFF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif_count</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">current_fw</span> <span class="o">==</span> <span class="n">WL12XX_FW_TYPE_NORMAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif_count</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">current_fw</span> <span class="o">==</span> <span class="n">WL12XX_FW_TYPE_MULTI</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Enter &quot;forced psm&quot;. Make sure the sta is in psm against the ap,</span>
<span class="cm"> * to make the fw switch a bit more disconnection-persistent.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_force_active_psm</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">;</span>

	<span class="n">wl12xx_for_each_wlvif_sta</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_ps_set_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">STATION_POWER_SAVE_MODE</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vif_counter_data</span> <span class="n">vif_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">role_type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">booted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_VIF_BEACON_FILTER</span> <span class="o">|</span>
			     <span class="n">IEEE80211_VIF_SUPPORTS_CQM_RSSI</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 add interface type %d mac %pM&quot;</span><span class="p">,</span>
		     <span class="n">ieee80211_vif_type_p2p</span><span class="p">(</span><span class="n">vif</span><span class="p">),</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">wl12xx_get_vif_count</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif_count</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * in some very corner case HW recovery scenarios its possible to</span>
<span class="cm">	 * get here before __wl1271_op_remove_interface is complete, so</span>
<span class="cm">	 * opt out if that is the case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_RECOVERY_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_init_vif_data</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span><span class="p">;</span>
	<span class="n">role_type</span> <span class="o">=</span> <span class="n">wl12xx_get_role_type</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">role_type</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_ROLE_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl12xx_need_fw_change</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif_count</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wl12xx_force_active_psm</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_INTENDED_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">wl1271_recovery_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">recovery_work</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: after the nvs issue will be solved, move this block</span>
<span class="cm">	 * to start(), and make sure here the driver is ON.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * we still need this in order to configure the fw</span>
<span class="cm">		 * while uploading the nvs</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">booted</span> <span class="o">=</span> <span class="n">wl12xx_init_fw</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">booted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span> <span class="o">||</span>
	    <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The device role is a special role used for</span>
<span class="cm">		 * rx and tx frames prior to association (as</span>
<span class="cm">		 * the STA role can get packets only from</span>
<span class="cm">		 * its associated bssid)</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_role_enable</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
						 <span class="n">WL1271_ROLE_DEVICE</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_role_enable</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
				     <span class="n">role_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_init_vif_specific</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlvif_list</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">sta_count</span><span class="o">++</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__wl1271_op_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
					 <span class="n">bool</span> <span class="n">reset_tx_queues</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 remove interface&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* because of hardware recovery, we may get here twice */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WL1271_STATE_ON</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wl1271_info</span><span class="p">(</span><span class="s">&quot;down&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WL1271_SCAN_STATE_IDLE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_vif</span> <span class="o">==</span> <span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Rearm the tx watchdog just before idling scan. This</span>
<span class="cm">		 * prevents just-finished scans from triggering the watchdog</span>
<span class="cm">		 */</span>
		<span class="n">wl12xx_rearm_tx_watchdog_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL1271_SCAN_STATE_IDLE</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">scanned_ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">scanned_ch</span><span class="p">));</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ieee80211_scan_completed</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_RECOVERY_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* disable active roles */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">deinit</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span> <span class="o">||</span>
		    <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wl12xx_dev_role_started</span><span class="p">(</span><span class="n">wlvif</span><span class="p">))</span>
				<span class="n">wl12xx_stop_dev</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_role_disable</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">deinit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_role_disable</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">deinit</span><span class="p">;</span>

		<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">deinit:</span>
	<span class="cm">/* clear all hlids (except system_hlid) */</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_hlid</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span> <span class="o">||</span>
	    <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">;</span>
		<span class="n">wl12xx_free_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">basic_rate_idx</span><span class="p">);</span>
		<span class="n">wl12xx_free_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ap_rate_idx</span><span class="p">);</span>
		<span class="n">wl12xx_free_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">p2p_rate_idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_hlid</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">;</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">global_hlid</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">;</span>
		<span class="n">wl12xx_free_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">mgmt_rate_idx</span><span class="p">);</span>
		<span class="n">wl12xx_free_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_rate_idx</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONF_TX_MAX_AC_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">wl12xx_free_rate_policy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">ucast_rate_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">wl1271_free_ap_keys</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">probereq</span><span class="p">);</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">probereq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wl12xx_tx_reset_wlvif</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">last_wlvif</span> <span class="o">==</span> <span class="n">wlvif</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">last_wlvif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">sta_hlid_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">sta_hlid_map</span><span class="p">));</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_ROLE_ID</span><span class="p">;</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_ROLE_ID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">sta_count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rx_streaming_timer</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rx_streaming_enable_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rx_streaming_disable_work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_op_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vif_counter_data</span> <span class="n">vif_count</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cancel_recovery</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">wl12xx_get_vif_count</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif_count</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * wl-&gt;vif can be null here if someone shuts down the interface</span>
<span class="cm">	 * just when hardware recovery has been started.</span>
<span class="cm">	 */</span>
	<span class="n">wl12xx_for_each_wlvif</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span> <span class="o">!=</span> <span class="n">wlvif</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">__wl1271_op_remove_interface</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">iter</span> <span class="o">!=</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl12xx_need_fw_change</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif_count</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wl12xx_force_active_psm</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_INTENDED_FW_RECOVERY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wl12xx_queue_recovery_work</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="n">cancel_recovery</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cancel_recovery</span><span class="p">)</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">recovery_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_op_change_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">new_type</span><span class="p">,</span> <span class="n">bool</span> <span class="n">p2p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_VIF_CHANGE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wl1271_op_remove_interface</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">new_type</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">p2p</span> <span class="o">=</span> <span class="n">p2p</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_op_add_interface</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_VIF_CHANGE_IN_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_join</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			  <span class="n">bool</span> <span class="n">set_assoc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_ibss</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * One of the side effects of the JOIN command is that is clears</span>
<span class="cm">	 * WPA/WPA2 keys from the chipset. Performing a JOIN while associated</span>
<span class="cm">	 * to a WPA/WPA2 access point will therefore kill the data-path.</span>
<span class="cm">	 * Currently the only valid scenario for JOIN during association</span>
<span class="cm">	 * is on roaming, in which case we will also be given new keys.</span>
<span class="cm">	 * Keep the below message for now, unless it starts bothering</span>
<span class="cm">	 * users who really like to roam a lot :)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">wl1271_info</span><span class="p">(</span><span class="s">&quot;JOIN while associated.&quot;</span><span class="p">);</span>

	<span class="cm">/* clear encryption type */</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">encryption_type</span> <span class="o">=</span> <span class="n">KEY_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_assoc</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ibss</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_role_start_ibss</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_role_start_sta</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The join command disable the keep-alive mode, shut down its process,</span>
<span class="cm">	 * and also clear the template config, so we need to reset it all after</span>
<span class="cm">	 * the join. The acx_aid starts the keep-alive process, and the order</span>
<span class="cm">	 * of the commands below is relevant.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_keep_alive_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_aid</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_build_klv_null_data</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_keep_alive_config</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span>
					   <span class="n">CMD_TEMPL_KLV_IDX_NULL_DATA</span><span class="p">,</span>
					   <span class="n">ACX_KEEP_ALIVE_TPL_VALID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_unjoin</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_CS_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>

		<span class="n">wl12xx_cmd_stop_channel_switch</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="n">ieee80211_chswitch_done</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* to stop listening to a channel, we disconnect */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_role_stop_sta</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* reset TX security counters on a clean disconnect */</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">tx_security_last_seq_lsb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">tx_security_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_set_band_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bitrate_masks</span><span class="p">[</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_sta_handle_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">idle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cur_idle</span> <span class="o">=</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_IN_USE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idle</span> <span class="o">==</span> <span class="n">cur_idle</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no need to croc if we weren&#39;t busy (e.g. during boot) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl12xx_dev_role_started</span><span class="p">(</span><span class="n">wlvif</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_stop_dev</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span> <span class="o">=</span>
			<span class="n">wl1271_tx_min_rate_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_sta_rate_policies</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_keep_alive_config</span><span class="p">(</span>
			<span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">CMD_TEMPL_KLV_IDX_NULL_DATA</span><span class="p">,</span>
			<span class="n">ACX_KEEP_ALIVE_TPL_INVALID</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_IN_USE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The current firmware only supports sched_scan in idle */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">sched_scanning</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_scan_sched_scan_stop</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
			<span class="n">ieee80211_sched_scan_stopped</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_start_dev</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_IN_USE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_config_vif</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_ap</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>

	<span class="cm">/* if the channel changes while joined, join again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_CHANNEL</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">!=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">!=</span> <span class="n">channel</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* send all pending packets */</span>
		<span class="n">wl1271_tx_work_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_ap</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * FIXME: the mac80211 should really provide a fixed</span>
<span class="cm">			 * rate to use here. for now, just use the smallest</span>
<span class="cm">			 * possible rate for the band as a fixed rate for</span>
<span class="cm">			 * association frames and other control messages.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">wl1271_set_band_rate</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>

			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span> <span class="o">=</span>
				<span class="n">wl1271_tx_min_rate_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
						       <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_sta_rate_policies</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;rate policy for channel &quot;</span>
					       <span class="s">&quot;failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * change the ROC channel. do it only if we are</span>
<span class="cm">			 * not idle. otherwise, CROC will be called</span>
<span class="cm">			 * anyway.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">wl12xx_dev_role_started</span><span class="p">(</span><span class="n">wlvif</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_IDLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_stop_dev</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

				<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_start_dev</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_PS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_ap</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_IN_PS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>

			<span class="kt">int</span> <span class="n">ps_mode</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">ps_mode_str</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">forced_ps</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ps_mode</span> <span class="o">=</span> <span class="n">STATION_POWER_SAVE_MODE</span><span class="p">;</span>
				<span class="n">ps_mode_str</span> <span class="o">=</span> <span class="s">&quot;forced&quot;</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ps_mode</span> <span class="o">=</span> <span class="n">STATION_AUTO_PS_MODE</span><span class="p">;</span>
				<span class="n">ps_mode_str</span> <span class="o">=</span> <span class="s">&quot;auto&quot;</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_PSM</span><span class="p">,</span> <span class="s">&quot;%s ps enabled&quot;</span><span class="p">,</span> <span class="n">ps_mode_str</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_set_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">ps_mode</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;enter %s ps failed %d&quot;</span><span class="p">,</span>
					       <span class="n">ps_mode_str</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_IN_PS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_PSM</span><span class="p">,</span> <span class="s">&quot;auto ps disabled&quot;</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_set_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span>
						 <span class="n">STATION_ACTIVE_MODE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;exit auto ps failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">!=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_tx_power</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 config ch %d psm %s power %d %s&quot;</span>
		     <span class="s">&quot; changed 0x%x&quot;</span><span class="p">,</span>
		     <span class="n">channel</span><span class="p">,</span>
		     <span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		     <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">,</span>
		     <span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_IDLE</span> <span class="o">?</span> <span class="s">&quot;idle&quot;</span> <span class="o">:</span> <span class="s">&quot;in use&quot;</span><span class="p">,</span>
			 <span class="n">changed</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * mac80211 will go to idle nearly immediately after transmitting some</span>
<span class="cm">	 * frames, such as the deauth. To make sure those frames reach the air,</span>
<span class="cm">	 * wait here until the TX queue is fully flushed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_IDLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_IDLE</span><span class="p">))</span>
		<span class="n">wl1271_tx_flush</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* we support configuring the channel and band even while off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_POWER</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* configure each interface */</span>
	<span class="n">wl12xx_for_each_wlvif</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_config_vif</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">wl1271_filter_params</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">enabled</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mc_list_length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mc_list</span><span class="p">[</span><span class="n">ACX_MC_ADDRESS_GROUP_MAX</span><span class="p">][</span><span class="n">ETH_ALEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">wl1271_op_prepare_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">netdev_hw_addr_list</span> <span class="o">*</span><span class="n">mc_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_filter_params</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Out of memory setting filters.&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* update multicast filtering parameters */</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">mc_list_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netdev_hw_addr_list_count</span><span class="p">(</span><span class="n">mc_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ACX_MC_ADDRESS_GROUP_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">netdev_hw_addr_list_for_each</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mc_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">[</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">mc_list_length</span><span class="p">],</span>
					<span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">fp</span><span class="o">-&gt;</span><span class="n">mc_list_length</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WL1271_SUPPORTED_FILTERS (FIF_PROMISC_IN_BSS | \</span>
<span class="cp">				  FIF_ALLMULTI | \</span>
<span class="cp">				  FIF_FCSFAIL | \</span>
<span class="cp">				  FIF_BCN_PRBRESP_PROMISC | \</span>
<span class="cp">				  FIF_CONTROL | \</span>
<span class="cp">				  FIF_OTHER_BSS)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_op_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total</span><span class="p">,</span> <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_filter_params</span> <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">multicast</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 configure filter changed %x&quot;</span>
		     <span class="s">&quot; total %x&quot;</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="o">*</span><span class="n">total</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="o">*</span><span class="n">total</span> <span class="o">&amp;=</span> <span class="n">WL1271_SUPPORTED_FILTERS</span><span class="p">;</span>
	<span class="n">changed</span> <span class="o">&amp;=</span> <span class="n">WL1271_SUPPORTED_FILTERS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl12xx_for_each_wlvif</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">!=</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total</span> <span class="o">&amp;</span> <span class="n">FIF_ALLMULTI</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_group_address_tbl</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span>
								   <span class="nb">false</span><span class="p">,</span>
								   <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_group_address_tbl</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span>
							<span class="n">fp</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">,</span>
							<span class="n">fp</span><span class="o">-&gt;</span><span class="n">mc_list</span><span class="p">,</span>
							<span class="n">fp</span><span class="o">-&gt;</span><span class="n">mc_list_length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * the fw doesn&#39;t provide an api to configure the filters. instead,</span>
<span class="cm">	 * the filters configuration is based on the active roles / ROC</span>
<span class="cm">	 * state.</span>
<span class="cm">	 */</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_record_ap_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_size</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hlid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx_seq_32</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">tx_seq_16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_ap_key</span> <span class="o">*</span><span class="n">ap_key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;record ap key id %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_size</span> <span class="o">&gt;</span> <span class="n">MAX_KEY_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find next free entry in ap_keys. Also check we are not replacing</span>
<span class="cm">	 * an existing key.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">recorded_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">recorded_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;trying to record key replacement&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_NUM_KEYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ap_key</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ap_key</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_key</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ap_key</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">ap_key</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>
	<span class="n">ap_key</span><span class="o">-&gt;</span><span class="n">key_size</span> <span class="o">=</span> <span class="n">key_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ap_key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_size</span><span class="p">);</span>
	<span class="n">ap_key</span><span class="o">-&gt;</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">hlid</span><span class="p">;</span>
	<span class="n">ap_key</span><span class="o">-&gt;</span><span class="n">tx_seq_32</span> <span class="o">=</span> <span class="n">tx_seq_32</span><span class="p">;</span>
	<span class="n">ap_key</span><span class="o">-&gt;</span><span class="n">tx_seq_16</span> <span class="o">=</span> <span class="n">tx_seq_16</span><span class="p">;</span>

	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">recorded_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ap_key</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_free_ap_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">recorded_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">recorded_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_ap_init_hwenc</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1271_ap_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">wep_key_added</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">hlid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">recorded_keys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">key</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">recorded_keys</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">hlid</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">hlid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hlid</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">)</span>
			<span class="n">hlid</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_hlid</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_set_ap_key</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">KEY_ADD_OR_REPLACE</span><span class="p">,</span>
					    <span class="n">key</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_type</span><span class="p">,</span>
					    <span class="n">key</span><span class="o">-&gt;</span><span class="n">key_size</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
					    <span class="n">hlid</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">tx_seq_32</span><span class="p">,</span>
					    <span class="n">key</span><span class="o">-&gt;</span><span class="n">tx_seq_16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">KEY_WEP</span><span class="p">)</span>
			<span class="n">wep_key_added</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wep_key_added</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_set_default_wep_key</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">default_key</span><span class="p">,</span>
						     <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_hlid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">wl1271_free_ap_keys</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">action</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_type</span><span class="p">,</span>
		       <span class="n">u8</span> <span class="n">key_size</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx_seq_32</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">tx_seq_16</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_ap</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * A role set to GEM cipher requires different Tx settings (namely</span>
<span class="cm">	 * spare blocks). Note when we are in this mode so the HW can adjust.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">KEY_GEM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">KEY_ADD_OR_REPLACE</span><span class="p">)</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">is_gem</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">KEY_REMOVE</span><span class="p">)</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">is_gem</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="n">wl_sta</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">hlid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl_sta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
			<span class="n">hlid</span> <span class="o">=</span> <span class="n">wl_sta</span><span class="o">-&gt;</span><span class="n">hlid</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hlid</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_hlid</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_AP_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We do not support removing keys after AP shutdown.</span>
<span class="cm">			 * Pretend we do to make mac80211 happy.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">!=</span> <span class="n">KEY_ADD_OR_REPLACE</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_record_ap_key</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
					     <span class="n">key_type</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span>
					     <span class="n">key</span><span class="p">,</span> <span class="n">hlid</span><span class="p">,</span> <span class="n">tx_seq_32</span><span class="p">,</span>
					     <span class="n">tx_seq_16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_set_ap_key</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
					     <span class="n">id</span><span class="p">,</span> <span class="n">key_type</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span>
					     <span class="n">key</span><span class="p">,</span> <span class="n">hlid</span><span class="p">,</span> <span class="n">tx_seq_32</span><span class="p">,</span>
					     <span class="n">tx_seq_16</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
		<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">bcast_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span>
		<span class="p">};</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">sta</span> <span class="o">?</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">:</span> <span class="n">bcast_addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* We dont support TX only encryption */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* The wl1271 does not allow to remove unicast keys - they</span>
<span class="cm">		   will be cleared automatically on next CMD_JOIN. Ignore the</span>
<span class="cm">		   request silently, as we dont want the mac80211 to emit</span>
<span class="cm">		   an error message. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">KEY_REMOVE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* don&#39;t remove key if hlid was already deleted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">KEY_REMOVE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_set_sta_key</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
					     <span class="n">id</span><span class="p">,</span> <span class="n">key_type</span><span class="p">,</span> <span class="n">key_size</span><span class="p">,</span>
					     <span class="n">key</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tx_seq_32</span><span class="p">,</span>
					     <span class="n">tx_seq_16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* the default WEP key needs to be configured at least once */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">KEY_WEP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_set_default_wep_key</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
							<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">default_key</span><span class="p">,</span>
							<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key_conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_seq_32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_seq_16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_type</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 set key&quot;</span><span class="p">);</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;CMD: 0x%x sta: %p&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;Key: algo:0x%x, id:%d, len:%d flags 0x%x&quot;</span><span class="p">,</span>
		     <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">,</span>
		     <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">,</span> <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wl1271_dump</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;KEY: &quot;</span><span class="p">,</span> <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">KEY_WEP</span><span class="p">;</span>

		<span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">KEY_TKIP</span><span class="p">;</span>

		<span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>
		<span class="n">tx_seq_32</span> <span class="o">=</span> <span class="n">WL1271_TX_SECURITY_HI32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">tx_security_seq</span><span class="p">);</span>
		<span class="n">tx_seq_16</span> <span class="o">=</span> <span class="n">WL1271_TX_SECURITY_LO16</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">tx_security_seq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">KEY_AES</span><span class="p">;</span>

		<span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_PUT_IV_SPACE</span><span class="p">;</span>
		<span class="n">tx_seq_32</span> <span class="o">=</span> <span class="n">WL1271_TX_SECURITY_HI32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">tx_security_seq</span><span class="p">);</span>
		<span class="n">tx_seq_16</span> <span class="o">=</span> <span class="n">WL1271_TX_SECURITY_LO16</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">tx_security_seq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL1271_CIPHER_SUITE_GEM</span>:
		<span class="n">key_type</span> <span class="o">=</span> <span class="n">KEY_GEM</span><span class="p">;</span>
		<span class="n">tx_seq_32</span> <span class="o">=</span> <span class="n">WL1271_TX_SECURITY_HI32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">tx_security_seq</span><span class="p">);</span>
		<span class="n">tx_seq_16</span> <span class="o">=</span> <span class="n">WL1271_TX_SECURITY_LO16</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">tx_security_seq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Unknown key algo 0x%x&quot;</span><span class="p">,</span> <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_KEY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_set_key</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">KEY_ADD_OR_REPLACE</span><span class="p">,</span>
				 <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">,</span> <span class="n">key_type</span><span class="p">,</span>
				 <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">,</span> <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
				 <span class="n">tx_seq_32</span><span class="p">,</span> <span class="n">tx_seq_16</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Could not add or replace key&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * reconfiguring arp response if the unicast (or common)</span>
<span class="cm">		 * encryption key type was changed</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">sta</span> <span class="o">||</span> <span class="n">key_type</span> <span class="o">==</span> <span class="n">KEY_WEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">encryption_type</span> <span class="o">!=</span> <span class="n">key_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">encryption_type</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_build_arp_rsp</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;build arp rsp failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DISABLE_KEY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_set_key</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">KEY_REMOVE</span><span class="p">,</span>
				     <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">,</span> <span class="n">key_type</span><span class="p">,</span>
				     <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">,</span> <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Could not remove key&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Unsupported key cmd 0x%x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_hw_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 hw scan&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssid</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We cannot return -EBUSY here because cfg80211 will expect</span>
<span class="cm">		 * a call to ieee80211_scan_completed if we do - in this case</span>
<span class="cm">		 * there won&#39;t be any call.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* fail if there is any role in ROC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">find_first_bit</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">roc_map</span><span class="p">,</span> <span class="n">WL12XX_MAX_ROLES</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">WL12XX_MAX_ROLES</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t allow scanning right now */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_scan</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="nl">out_sleep:</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_op_cancel_hw_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 cancel hw scan&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_SCAN_STATE_IDLE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WL1271_SCAN_STATE_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_scan_stop</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Rearm the tx watchdog just before idling scan. This</span>
<span class="cm">	 * prevents just-finished scans from triggering the watchdog</span>
<span class="cm">	 */</span>
	<span class="n">wl12xx_rearm_tx_watchdog_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL1271_SCAN_STATE_IDLE</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">scanned_ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">scanned_ch</span><span class="p">));</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">.</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ieee80211_scan_completed</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_complete_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_sched_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">cfg80211_sched_scan_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_sched_scan_ies</span> <span class="o">*</span><span class="n">ies</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;wl1271_op_sched_scan_start&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_scan_sched_scan_config</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">ies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_scan_sched_scan_start</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">sched_scanning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_op_sched_scan_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;wl1271_op_sched_scan_stop&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl1271_scan_sched_scan_stop</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_set_frag_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_frag_threshold</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;wl1271_op_set_frag_threshold failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_set_rts_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl12xx_for_each_wlvif</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_rts_threshold</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;set rts threshold failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_ssid_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">cfg80211_find_ie</span><span class="p">(</span><span class="n">WLAN_EID_SSID</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span>
					 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;No SSID in IEs!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;SSID is too long!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ptr</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_remove_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">u8</span> <span class="n">eid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ieoffset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ie</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cfg80211_find_ie</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ieoffset</span><span class="p">,</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ieoffset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ie</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">ie</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">next</span><span class="p">);</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_remove_vendor_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oui</span><span class="p">,</span> <span class="n">u8</span> <span class="n">oui_type</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">ieoffset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">next</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ie</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">cfg80211_find_vendor_ie</span><span class="p">(</span><span class="n">oui</span><span class="p">,</span> <span class="n">oui_type</span><span class="p">,</span>
					       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ieoffset</span><span class="p">,</span>
					       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ieoffset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ie</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">ie</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">ie</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">next</span><span class="p">);</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_ap_set_probe_resp_tmpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rates</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_proberesp_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span>
				      <span class="n">CMD_TEMPL_AP_PROBE_RESPONSE</span><span class="p">,</span>
				      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">rates</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_ap_set_probe_resp_tmpl_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
					     <span class="n">u8</span> <span class="o">*</span><span class="n">probe_rsp_data</span><span class="p">,</span>
					     <span class="kt">size_t</span> <span class="n">probe_rsp_len</span><span class="p">,</span>
					     <span class="n">u32</span> <span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">probe_rsp_templ</span><span class="p">[</span><span class="n">WL1271_CMD_TEMPL_MAX_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ssid_ie_offset</span><span class="p">,</span> <span class="n">ie_offset</span><span class="p">,</span> <span class="n">templ_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* no need to change probe response if the SSID is set correctly */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span>
					       <span class="n">CMD_TEMPL_AP_PROBE_RESPONSE</span><span class="p">,</span>
					       <span class="n">probe_rsp_data</span><span class="p">,</span>
					       <span class="n">probe_rsp_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="n">rates</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">probe_rsp_len</span> <span class="o">+</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="n">WL1271_CMD_TEMPL_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;probe_rsp template too big&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* start searching from IE offset */</span>
	<span class="n">ie_offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">probe_resp</span><span class="p">.</span><span class="n">variable</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">cfg80211_find_ie</span><span class="p">(</span><span class="n">WLAN_EID_SSID</span><span class="p">,</span> <span class="n">probe_rsp_data</span> <span class="o">+</span> <span class="n">ie_offset</span><span class="p">,</span>
			       <span class="n">probe_rsp_len</span> <span class="o">-</span> <span class="n">ie_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;No SSID in beacon!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ssid_ie_offset</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">-</span> <span class="n">probe_rsp_data</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">probe_rsp_templ</span><span class="p">,</span> <span class="n">probe_rsp_data</span><span class="p">,</span> <span class="n">ssid_ie_offset</span><span class="p">);</span>

	<span class="cm">/* insert SSID from bss_conf */</span>
	<span class="n">probe_rsp_templ</span><span class="p">[</span><span class="n">ssid_ie_offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
	<span class="n">probe_rsp_templ</span><span class="p">[</span><span class="n">ssid_ie_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">probe_rsp_templ</span> <span class="o">+</span> <span class="n">ssid_ie_offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
	       <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">templ_len</span> <span class="o">=</span> <span class="n">ssid_ie_offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">probe_rsp_templ</span> <span class="o">+</span> <span class="n">ssid_ie_offset</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span>
	       <span class="n">ptr</span><span class="p">,</span> <span class="n">probe_rsp_len</span> <span class="o">-</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">-</span> <span class="n">probe_rsp_data</span><span class="p">));</span>
	<span class="n">templ_len</span> <span class="o">+=</span> <span class="n">probe_rsp_len</span> <span class="o">-</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">-</span> <span class="n">probe_rsp_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span>
				       <span class="n">CMD_TEMPL_AP_PROBE_RESPONSE</span><span class="p">,</span>
				       <span class="n">probe_rsp_templ</span><span class="p">,</span>
				       <span class="n">templ_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">rates</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_bss_erp_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_slot</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_slot</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">SLOT_TIME_SHORT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_slot</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">SLOT_TIME_LONG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Set slot time failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_PREAMBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_preamble</span><span class="p">)</span>
			<span class="n">wl1271_acx_set_preamble</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">ACX_PREAMBLE_SHORT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">wl1271_acx_set_preamble</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">ACX_PREAMBLE_LONG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_CTS_PROT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_cts_prot</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_cts_protect</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span>
						     <span class="n">CTSPROTECT_ENABLE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_cts_protect</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span>
						     <span class="n">CTSPROTECT_DISABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Set ctsprotect failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_bss_beacon_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
					  <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">is_ap</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MASTER</span><span class="p">,</span> <span class="s">&quot;beacon interval updated: %d&quot;</span><span class="p">,</span>
			<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>

		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">beacon_int</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_AP_PROBE_RESP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">wl1271_tx_min_rate_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl1271_ap_set_probe_resp_tmpl</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">vif</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;probe response updated&quot;</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_AP_PROBE_RESP_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">min_rate</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ieoffset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span>
					<span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">tmpl_id</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beacon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MASTER</span><span class="p">,</span> <span class="s">&quot;beacon updated&quot;</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ssid_set</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">beacon</span><span class="p">,</span> <span class="n">ieoffset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">beacon</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">min_rate</span> <span class="o">=</span> <span class="n">wl1271_tx_min_rate_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>
		<span class="n">tmpl_id</span> <span class="o">=</span> <span class="n">is_ap</span> <span class="o">?</span> <span class="n">CMD_TEMPL_AP_BEACON</span> <span class="o">:</span>
				  <span class="n">CMD_TEMPL_BEACON</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span> <span class="n">tmpl_id</span><span class="p">,</span>
					      <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					      <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">min_rate</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">beacon</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * In case we already have a probe-resp beacon set explicitly</span>
<span class="cm">		 * by usermode, don&#39;t use the beacon data.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_AP_PROBE_RESP_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">end_bcn</span><span class="p">;</span>

		<span class="cm">/* remove TIM ie from probe response */</span>
		<span class="n">wl12xx_remove_ie</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">WLAN_EID_TIM</span><span class="p">,</span> <span class="n">ieoffset</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * remove p2p ie from probe response.</span>
<span class="cm">		 * the fw reponds to probe requests that don&#39;t include</span>
<span class="cm">		 * the p2p ie. probe requests with p2p ie will be passed,</span>
<span class="cm">		 * and will be responded by the supplicant (the spec</span>
<span class="cm">		 * forbids including the p2p ie when responding to probe</span>
<span class="cm">		 * requests that didn&#39;t include it).</span>
<span class="cm">		 */</span>
		<span class="n">wl12xx_remove_vendor_ie</span><span class="p">(</span><span class="n">beacon</span><span class="p">,</span> <span class="n">WLAN_OUI_WFA</span><span class="p">,</span>
					<span class="n">WLAN_OUI_TYPE_WFA_P2P</span><span class="p">,</span> <span class="n">ieoffset</span><span class="p">);</span>

		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
						 <span class="n">IEEE80211_STYPE_PROBE_RESP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ap</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ap_set_probe_resp_tmpl_legacy</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span>
						<span class="n">beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						<span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
						<span class="n">min_rate</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span>
						<span class="n">CMD_TEMPL_PROBE_RESPONSE</span><span class="p">,</span>
						<span class="n">beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						<span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">min_rate</span><span class="p">);</span>
<span class="nl">end_bcn:</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">beacon</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;beacon info change failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* AP mode changes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_bss_info_changed_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BASIC_RATES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rates</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">;</span>

		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span> <span class="o">=</span> <span class="n">wl1271_tx_enabled_rates_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span>
								 <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span> <span class="o">=</span> <span class="n">wl1271_tx_min_rate_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
							<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_init_ap_rates</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;AP rate policy change failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ap_init_templates</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_bss_beacon_info_changed</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_AP_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_role_start_ap</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ap_init_hwenc</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">set_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_AP_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;started AP&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_AP_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_role_stop_ap</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="n">clear_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_AP_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_AP_PROBE_RESP_SET</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;stopped AP&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_bss_erp_info_changed</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Handle HT information change */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_HT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_set_ht_information</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span>
					<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ht_operation_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Set ht information failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* STA/IBSS mode changes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_bss_info_changed_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">do_join</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">set_assoc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_ibss</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">ibss_joined</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sta_rate_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sta_exists</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="n">sta_ht_cap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ibss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_bss_beacon_info_changed</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="p">,</span>
						     <span class="n">changed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_IBSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ibss_joined</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_IBSS_JOINED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">ibss_joined</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_IBSS_JOINED</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">wl1271_unjoin</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ibss_joined</span><span class="p">)</span>
		<span class="n">do_join</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Need to update the SSID (for filtering etc) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ibss_joined</span><span class="p">)</span>
		<span class="n">do_join</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ibss_joined</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ADHOC</span><span class="p">,</span> <span class="s">&quot;ad-hoc beaconing: %s&quot;</span><span class="p">,</span>
			     <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

		<span class="n">do_join</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_IDLE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_ibss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_sta_handle_idle</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">idle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;idle mode change failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_CQM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">cqm_rssi_thold</span><span class="p">)</span>
			<span class="n">enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_rssi_snr_trigger</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span>
						  <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">cqm_rssi_thold</span><span class="p">,</span>
						  <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">cqm_rssi_hyst</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rssi_thold</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">cqm_rssi_thold</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_build_null_data</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_build_qos_null_data</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BSS_CHANGED_ASSOC</span> <span class="o">|</span> <span class="n">BSS_CHANGED_HT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">ieee80211_find_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">sta_not_found</span><span class="p">;</span>

		<span class="cm">/* save the supp_rates of the ap */</span>
		<span class="n">sta_rate_set</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
			<span class="n">sta_rate_set</span> <span class="o">|=</span>
			    <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">HW_HT_RATES_OFFSET</span><span class="p">);</span>
		<span class="n">sta_ht_cap</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">;</span>
		<span class="n">sta_exists</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">sta_not_found:</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">rates</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">ieoffset</span><span class="p">;</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">;</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">beacon_int</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">;</span>
			<span class="n">do_join</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">set_assoc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="cm">/* Cancel connection_loss_work */</span>
			<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">connection_loss_work</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * use basic rates from AP, and determine lowest rate</span>
<span class="cm">			 * to use with control frames.</span>
<span class="cm">			 */</span>
			<span class="n">rates</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">;</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span> <span class="o">=</span>
				<span class="n">wl1271_tx_enabled_rates_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span>
							    <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span> <span class="o">=</span>
				<span class="n">wl1271_tx_min_rate_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
						       <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta_rate_set</span><span class="p">)</span>
				<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span> <span class="o">=</span>
					<span class="n">wl1271_tx_enabled_rates_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
								<span class="n">sta_rate_set</span><span class="p">,</span>
								<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_sta_rate_policies</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * with wl1271, we don&#39;t need to update the</span>
<span class="cm">			 * beacon_int and dtim_period, because the firmware</span>
<span class="cm">			 * updates it by itself when the first beacon is</span>
<span class="cm">			 * received after a join.</span>
<span class="cm">			 */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_build_ps_poll</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Get a template for hardware connection maintenance</span>
<span class="cm">			 */</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">probereq</span><span class="p">);</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">probereq</span> <span class="o">=</span> <span class="n">wl1271_cmd_build_ap_probe_req</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
									<span class="n">wlvif</span><span class="p">,</span>
									<span class="nb">NULL</span><span class="p">);</span>
			<span class="n">ieoffset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span>
					    <span class="n">u</span><span class="p">.</span><span class="n">probe_req</span><span class="p">.</span><span class="n">variable</span><span class="p">);</span>
			<span class="n">wl1271_ssid_set</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">probereq</span><span class="p">,</span> <span class="n">ieoffset</span><span class="p">);</span>

			<span class="cm">/* enable the connection monitoring feature */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_conn_monit_params</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* use defaults when not associated */</span>
			<span class="n">bool</span> <span class="n">was_assoc</span> <span class="o">=</span>
			    <span class="o">!!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">bool</span> <span class="n">was_ifup</span> <span class="o">=</span>
			    <span class="o">!!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_STATE_SENT</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* free probe-request template */</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">probereq</span><span class="p">);</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">probereq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* revert back to minimum rates for the current band */</span>
			<span class="n">wl1271_set_band_rate</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span> <span class="o">=</span>
				<span class="n">wl1271_tx_min_rate_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
						       <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_sta_rate_policies</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="cm">/* disable connection monitor features */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_conn_monit_params</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

			<span class="cm">/* Disable the keep-alive feature */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_keep_alive_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="cm">/* restore the bssid filter and go to dummy bssid */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">was_assoc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * we might have to disable roc, if there was</span>
<span class="cm">				 * no IF_OPER_UP notification.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">was_ifup</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_croc</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="cm">/*</span>
<span class="cm">				 * (we also need to disable roc in case of</span>
<span class="cm">				 * roaming on the same channel. until we will</span>
<span class="cm">				 * have a better flow...)</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">roc_map</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_croc</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
							  <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
						<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">wl1271_unjoin</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">idle</span><span class="p">)</span>
					<span class="n">wl12xx_start_dev</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_IBSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ADHOC</span><span class="p">,</span> <span class="s">&quot;ibss_joined: %d&quot;</span><span class="p">,</span>
			     <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ibss_joined</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ibss_joined</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">rates</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">;</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span> <span class="o">=</span>
				<span class="n">wl1271_tx_enabled_rates_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span>
							    <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span> <span class="o">=</span>
				<span class="n">wl1271_tx_min_rate_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
						       <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>

			<span class="cm">/* by default, use 11b + OFDM rates */</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span> <span class="o">=</span> <span class="n">CONF_TX_IBSS_DEFAULT_RATES</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_sta_rate_policies</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_bss_erp_info_changed</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">do_join</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_join</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">set_assoc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;cmd join failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* ROC until connected (after EAPOL exchange) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_ibss</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_roc</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_AUTHORIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">wl12xx_set_authorized</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * stop device role if started (we might already be in</span>
<span class="cm">		 * STA/IBSS role).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl12xx_dev_role_started</span><span class="p">(</span><span class="n">wlvif</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_stop_dev</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle new association with HT. Do this after join. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_exists</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_HT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_set_ht_capabilities</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
							     <span class="o">&amp;</span><span class="n">sta_ht_cap</span><span class="p">,</span>
							     <span class="nb">true</span><span class="p">,</span>
							     <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Set ht cap true failed %d&quot;</span><span class="p">,</span>
					       <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* handle new association without HT and disassociation */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_set_ht_capabilities</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
							     <span class="o">&amp;</span><span class="n">sta_ht_cap</span><span class="p">,</span>
							     <span class="nb">false</span><span class="p">,</span>
							     <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Set ht cap false failed %d&quot;</span><span class="p">,</span>
					       <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle HT information change. Done after join. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_HT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_set_ht_information</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span>
					<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ht_operation_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Set ht information failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Handle arp filtering. Done after join. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ARP_FILTER</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">is_ibss</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_QOS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">__be32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">arp_addr_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">qos</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">!=</span> <span class="n">BSS_TYPE_STA_BSS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">arp_addr_cnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">arp_filter_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ip_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * The template should have been configured only upon</span>
<span class="cm">			 * association. however, it seems that the correct ip</span>
<span class="cm">			 * isn&#39;t being set (when sending), so we have to</span>
<span class="cm">			 * reconfigure the template upon every ip change.</span>
<span class="cm">			 */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_build_arp_rsp</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;build arp rsp failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_arp_ip_filter</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span>
				<span class="p">(</span><span class="n">ACX_ARP_FILTER_ARP_FILTERING</span> <span class="o">|</span>
				 <span class="n">ACX_ARP_FILTER_AUTO_ARP</span><span class="p">),</span>
				<span class="n">addr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ip_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_arp_ip_filter</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_op_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">is_ap</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 bss info changed 0x%x&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">changed</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ap</span><span class="p">)</span>
		<span class="n">wl1271_bss_info_changed_ap</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wl1271_bss_info_changed_sta</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>

	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">queue</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ps_scheme</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 conf tx %d&quot;</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">uapsd</span><span class="p">)</span>
		<span class="n">ps_scheme</span> <span class="o">=</span> <span class="n">CONF_PS_SCHEME_UPSD_TRIGGER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ps_scheme</span> <span class="o">=</span> <span class="n">CONF_PS_SCHEME_LEGACY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * the txop is confed in units of 32us by the mac80211,</span>
<span class="cm">	 * we need us</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_ac_cfg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">wl1271_tx_get_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">,</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_tid_cfg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">wl1271_tx_get_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
				 <span class="n">CONF_CHANNEL_TYPE_EDCF</span><span class="p">,</span>
				 <span class="n">wl1271_tx_get_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
				 <span class="n">ps_scheme</span><span class="p">,</span> <span class="n">CONF_ACK_POLICY_LEGACY</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">wl1271_op_get_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">mactime</span> <span class="o">=</span> <span class="n">ULLONG_MAX</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 get tsf&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_acx_tsf_info</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mactime</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mactime</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_get_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="n">SURVEY_INFO_NOISE_DBM</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_allocate_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="n">wl_sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_sta_count</span> <span class="o">&gt;=</span> <span class="n">AP_MAX_STATIONS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;could not allocate HLID - too much stations&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl_sta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_allocate_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl_sta</span><span class="o">-&gt;</span><span class="n">hlid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;could not allocate HLID - too many links&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">wl_sta</span><span class="o">-&gt;</span><span class="n">hlid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">sta_hlid_map</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">wl_sta</span><span class="o">-&gt;</span><span class="n">hlid</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_sta_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wl1271_free_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hlid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">hlid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">sta_hlid_map</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">hlid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">sta_hlid_map</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">hlid</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">hlid</span><span class="p">].</span><span class="n">ba_bitmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">hlid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_ps_map</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">hlid</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_fw_ps_map</span><span class="p">);</span>
	<span class="n">wl12xx_free_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hlid</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_sta_count</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * rearm the tx watchdog when the last STA is freed - give the FW a</span>
<span class="cm">	 * chance to return STA-buffered packets before complaining.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_sta_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl12xx_rearm_tx_watchdog_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_sta_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="n">wl_sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hlid</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 add sta %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_allocate_sta</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl_sta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">hlid</span> <span class="o">=</span> <span class="n">wl_sta</span><span class="o">-&gt;</span><span class="n">hlid</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_add_peer</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">hlid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl1271_free_sta</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">hlid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_sta_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="n">wl_sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 remove sta %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>

	<span class="n">wl_sta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">wl_sta</span><span class="o">-&gt;</span><span class="n">hlid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">sta_hlid_map</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_remove_peer</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl_sta</span><span class="o">-&gt;</span><span class="n">hlid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_free_sta</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">wl_sta</span><span class="o">-&gt;</span><span class="n">hlid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_update_sta_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">ieee80211_sta_state</span> <span class="n">old_state</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">ieee80211_sta_state</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="n">wl_sta</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hlid</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_ap</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_sta</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl_sta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">hlid</span> <span class="o">=</span> <span class="n">wl_sta</span><span class="o">-&gt;</span><span class="n">hlid</span><span class="p">;</span>

	<span class="cm">/* Add station (AP mode) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_ap</span> <span class="o">&amp;&amp;</span>
	    <span class="n">old_state</span> <span class="o">==</span> <span class="n">IEEE80211_STA_NOTEXIST</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new_state</span> <span class="o">==</span> <span class="n">IEEE80211_STA_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">wl12xx_sta_add</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="cm">/* Remove station (AP mode) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_ap</span> <span class="o">&amp;&amp;</span>
	    <span class="n">old_state</span> <span class="o">==</span> <span class="n">IEEE80211_STA_NONE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new_state</span> <span class="o">==</span> <span class="n">IEEE80211_STA_NOTEXIST</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* must not fail */</span>
		<span class="n">wl12xx_sta_remove</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Authorize station (AP mode) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_ap</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new_state</span> <span class="o">==</span> <span class="n">IEEE80211_STA_AUTHORIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_set_peer_state</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">hlid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_set_ht_capabilities</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
						     <span class="n">hlid</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Authorize station */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_sta</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new_state</span> <span class="o">==</span> <span class="n">IEEE80211_STA_AUTHORIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_AUTHORIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">wl12xx_set_authorized</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_sta</span> <span class="o">&amp;&amp;</span>
	    <span class="n">old_state</span> <span class="o">==</span> <span class="n">IEEE80211_STA_AUTHORIZED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">new_state</span> <span class="o">==</span> <span class="n">IEEE80211_STA_ASSOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_AUTHORIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_op_sta_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">ieee80211_sta_state</span> <span class="n">old_state</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">ieee80211_sta_state</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 sta %d state=%d-&gt;%d&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_update_sta_state</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">old_state</span><span class="p">,</span> <span class="n">new_state</span><span class="p">);</span>

	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">&lt;</span> <span class="n">old_state</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_op_ampdu_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">ieee80211_ampdu_mlme_action</span> <span class="n">action</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ssn</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hlid</span><span class="p">,</span> <span class="o">*</span><span class="n">ba_bitmap</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 ampdu action %d tid %d&quot;</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span>
		     <span class="n">tid</span><span class="p">);</span>

	<span class="cm">/* sanity check - the fields in FW are only 8bits wide */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">tid</span> <span class="o">&gt;</span> <span class="mh">0xFF</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hlid</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">;</span>
		<span class="n">ba_bitmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ba_rx_bitmap</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_AP_BSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="n">wl_sta</span><span class="p">;</span>

		<span class="n">wl_sta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_station</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
		<span class="n">hlid</span> <span class="o">=</span> <span class="n">wl_sta</span><span class="o">-&gt;</span><span class="n">hlid</span><span class="p">;</span>
		<span class="n">ba_bitmap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">hlid</span><span class="p">].</span><span class="n">ba_bitmap</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 ampdu: Rx tid %d action %d&quot;</span><span class="p">,</span>
		     <span class="n">tid</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_START</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ba_support</span> <span class="o">||</span> <span class="o">!</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ba_allowed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ba_rx_session_count</span> <span class="o">&gt;=</span> <span class="n">RX_BA_MAX_SESSIONS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;exceeded max RX BA sessions&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ba_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">tid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;cannot enable RX BA session on active &quot;</span>
				     <span class="s">&quot;tid: %d&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_acx_set_ba_receiver_session</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="o">*</span><span class="n">ssn</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
							 <span class="n">hlid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ba_bitmap</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ba_rx_session_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_STOP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">ba_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">tid</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;no active RX BA session on tid: %d&quot;</span><span class="p">,</span>
				     <span class="n">tid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_acx_set_ba_receiver_session</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
							 <span class="n">hlid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ba_bitmap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ba_rx_session_count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The BA initiator session management in FW independently.</span>
<span class="cm">	 * Falling break here on purpose for all TX APDU commands.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_START</span>:
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_STOP</span>:
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_OPERATIONAL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Incorrect ampdu action id=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_set_bitrate_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">cfg80211_bitrate_mask</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 set_bitrate_mask 0x%x 0x%x&quot;</span><span class="p">,</span>
		<span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">NL80211_BAND_2GHZ</span><span class="p">].</span><span class="n">legacy</span><span class="p">,</span>
		<span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">NL80211_BAND_5GHZ</span><span class="p">].</span><span class="n">legacy</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bitrate_masks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">wl1271_tx_enabled_rates_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
						    <span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">legacy</span><span class="p">,</span>
						    <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">wl1271_set_band_rate</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span> <span class="o">=</span>
			<span class="n">wl1271_tx_min_rate_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_sta_rate_policies</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>

		<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_op_channel_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_channel_switch</span> <span class="o">*</span><span class="n">ch_switch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 channel switch&quot;</span><span class="p">);</span>

	<span class="n">wl1271_tx_flush</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wl12xx_for_each_wlvif_sta</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>
			<span class="n">ieee80211_chswitch_done</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* TODO: change mac80211 to pass vif as param */</span>
	<span class="n">wl12xx_for_each_wlvif_sta</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_channel_switch</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">ch_switch</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_CS_PROGRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">wl1271_tx_frames_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* packets are considered pending if in the TX queue or the FW */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">wl1271_tx_total_queue_count</span><span class="p">(</span><span class="n">wl</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_frames_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* can&#39;t be const, mac80211 writes to this */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">wl1271_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_1MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_1MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_2MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_2MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_5_5MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_5_5MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_11MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_11MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_6MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_6MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_9MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_9MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_12MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_12MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_18MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_18MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_24MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_24MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_36MBPS</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_36MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_48MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_48MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_54MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_54MBPS</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* can&#39;t be const, mac80211 writes to this */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">wl1271_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2412</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2417</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2422</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2427</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2432</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2437</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2442</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2447</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2452</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2457</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2462</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2467</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2472</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2484</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* can&#39;t be const, mac80211 writes to this */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">wl1271_band_2ghz</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">wl1271_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl1271_channels</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">wl1271_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl1271_rates</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* 5 GHz data rates for WL1273 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">wl1271_rates_5ghz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_6MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_6MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_9MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_9MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_12MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_12MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_18MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_18MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_24MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_24MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_36MBPS</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_36MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_48MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_48MBPS</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_54MBPS</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">CONF_HW_BIT_RATE_54MBPS</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* 5 GHz band channels for WL1273 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">wl1271_channels_5ghz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5035</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5040</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5045</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5055</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5060</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5080</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">34</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5170</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5180</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">38</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5190</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5200</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">42</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5210</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">44</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5220</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">46</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5230</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5240</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">52</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5260</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">56</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5280</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5300</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5320</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5500</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">104</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5520</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">108</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5540</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">112</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5560</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">116</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5580</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5600</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">124</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5620</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5640</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">132</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5660</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">136</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5680</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5700</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">149</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5745</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">153</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5765</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">157</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5785</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">161</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5805</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">165</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5825</span><span class="p">,</span> <span class="p">.</span><span class="n">max_power</span> <span class="o">=</span> <span class="mi">25</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">wl1271_band_5ghz</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">wl1271_channels_5ghz</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl1271_channels_5ghz</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">wl1271_rates_5ghz</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl1271_rates_5ghz</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">wl1271_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">wl1271_op_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">wl1271_op_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span> <span class="o">=</span> <span class="n">wl1271_op_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span> <span class="o">=</span> <span class="n">wl1271_op_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_interface</span> <span class="o">=</span> <span class="n">wl12xx_op_change_interface</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">wl1271_op_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">wl1271_op_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">wl1271_op_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_multicast</span> <span class="o">=</span> <span class="n">wl1271_op_prepare_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span> <span class="o">=</span> <span class="n">wl1271_op_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">wl1271_op_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_key</span> <span class="o">=</span> <span class="n">wl1271_op_set_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_scan</span> <span class="o">=</span> <span class="n">wl1271_op_hw_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cancel_hw_scan</span> <span class="o">=</span> <span class="n">wl1271_op_cancel_hw_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sched_scan_start</span> <span class="o">=</span> <span class="n">wl1271_op_sched_scan_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sched_scan_stop</span> <span class="o">=</span> <span class="n">wl1271_op_sched_scan_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span> <span class="o">=</span> <span class="n">wl1271_op_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_frag_threshold</span> <span class="o">=</span> <span class="n">wl1271_op_set_frag_threshold</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rts_threshold</span> <span class="o">=</span> <span class="n">wl1271_op_set_rts_threshold</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conf_tx</span> <span class="o">=</span> <span class="n">wl1271_op_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tsf</span> <span class="o">=</span> <span class="n">wl1271_op_get_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_survey</span> <span class="o">=</span> <span class="n">wl1271_op_get_survey</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_state</span> <span class="o">=</span> <span class="n">wl12xx_op_sta_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ampdu_action</span> <span class="o">=</span> <span class="n">wl1271_op_ampdu_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_frames_pending</span> <span class="o">=</span> <span class="n">wl1271_tx_frames_pending</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bitrate_mask</span> <span class="o">=</span> <span class="n">wl12xx_set_bitrate_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channel_switch</span> <span class="o">=</span> <span class="n">wl12xx_op_channel_switch</span><span class="p">,</span>
	<span class="n">CFG80211_TESTMODE_CMD</span><span class="p">(</span><span class="n">wl1271_tm_cmd</span><span class="p">)</span>
<span class="p">};</span>


<span class="n">u8</span> <span class="nf">wlcore_rate_to_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rate</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">band</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw_tx_rate_tbl_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Illegal RX rate from HW: %d&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">band_rate_to_idx</span><span class="p">[</span><span class="n">band</span><span class="p">][</span><span class="n">rate</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">CONF_HW_RXTX_RATE_UNSUPPORTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Unsupported RX rate from HW: %d&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">wl1271_sysfs_show_bt_coex_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n\n</span><span class="s">0 - off</span><span class="se">\n</span><span class="s">1 - on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">wl</span><span class="o">-&gt;</span><span class="n">sg_enabled</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">wl1271_sysfs_store_bt_coex_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;incorrect value written to bt_coex_mode&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="o">!!</span><span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">sg_enabled</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">sg_enabled</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl1271_acx_sg_enable</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">sg_enabled</span><span class="p">);</span>
	<span class="n">wl1271_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">bt_coex_state</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">wl1271_sysfs_show_bt_coex_state</span><span class="p">,</span>
		   <span class="n">wl1271_sysfs_store_bt_coex_state</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">wl1271_sysfs_show_hw_pg_ver</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw_pg_ver</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw_pg_ver</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;n/a</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">hw_pg_ver</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">wl1271_sysfs_show_hw_pg_ver</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">wl1271_sysfs_read_fwlog</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
				       <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="cm">/* Let only one thread read the log at a time, blocking others */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

		<span class="n">prepare_to_wait_exclusive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_waitq</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
					  <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the fwlog is still valid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Seeking is not supported - old logs are not kept. Disregard pos. */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_size</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Make room for new messages */</span>
	<span class="n">memmove</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_size</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">fwlog_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fwlog&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span><span class="p">},</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">wl1271_sysfs_read_fwlog</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_connection_loss_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">dwork</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">;</span>

	<span class="n">dwork</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">delayed_work</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dwork</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl1271</span><span class="p">,</span> <span class="n">connection_loss_work</span><span class="p">);</span>

	<span class="n">wl1271_info</span><span class="p">(</span><span class="s">&quot;Connection loss work.&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1271_STATE_OFF</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Call mac80211 connection loss */</span>
	<span class="n">wl12xx_for_each_wlvif_sta</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLVIF_FLAG_STA_ASSOCIATED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>
		<span class="n">ieee80211_connection_loss</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl12xx_derive_mac_addresses</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">oui</span><span class="p">,</span> <span class="n">u32</span> <span class="n">nic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_PROBE</span><span class="p">,</span> <span class="s">&quot;base address: oui %06x nic %06x, n %d&quot;</span><span class="p">,</span>
		     <span class="n">oui</span><span class="p">,</span> <span class="n">nic</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nic</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mh">0xffffff</span><span class="p">)</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;NIC part of the MAC address wraps around!&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">oui</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">oui</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">oui</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">nic</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">nic</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">nic</span><span class="p">;</span>
		<span class="n">nic</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_addresses</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">addresses</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_get_hw_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_set_power_on</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">wlcore_read_reg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">REG_CHIP_ID_B</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fuse_oui_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fuse_nic_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw_pg_ver</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_pg_ver</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mac</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_mac</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">wl1271_power_off</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_register_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oui_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nic_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_get_hw_info</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;couldn&#39;t get hw info&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_fetch_nvs</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NOTE: The wl-&gt;nvs-&gt;nvs element must be first, in</span>
<span class="cm">		 * order to simplify the casting, we assume it is at</span>
<span class="cm">		 * the beginning of the wl-&gt;nvs structure.</span>
<span class="cm">		 */</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">nvs_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs</span><span class="p">;</span>

		<span class="n">oui_addr</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">nvs_ptr</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">nvs_ptr</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">nvs_ptr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">nic_addr</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">nvs_ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">nvs_ptr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">nvs_ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* if the MAC address is zeroed in the NVS derive from fuse */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oui_addr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">nic_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">oui_addr</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fuse_oui_addr</span><span class="p">;</span>
		<span class="cm">/* fuse has the BD_ADDR, the WLAN addresses are the next two */</span>
		<span class="n">nic_addr</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fuse_nic_addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl12xx_derive_mac_addresses</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">oui_addr</span><span class="p">,</span> <span class="n">nic_addr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;unable to register mac80211 hw: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">wl1271_debugfs_init</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">wl1271_notice</span><span class="p">(</span><span class="s">&quot;loaded&quot;</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1271_unregister_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">plt</span><span class="p">)</span>
		<span class="n">wl1271_plt_stop</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_init_ieee80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">cipher_suites</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">,</span>
		<span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">,</span>
		<span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">,</span>
		<span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">,</span>
		<span class="n">WL1271_CIPHER_SUITE_GEM</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="cm">/* The tx descriptor buffer and the TKIP space. */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">=</span> <span class="n">WL1271_EXTRA_SPACE_TKIP</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_tx_hw_descr</span><span class="p">);</span>

	<span class="cm">/* unit us */</span>
	<span class="cm">/* FIXME: find a proper value */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_change_time</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_listen_interval</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">max_listen_interval</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SUPPORTS_PS</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SUPPORTS_DYNAMIC_PS</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SUPPORTS_UAPSD</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_HAS_RATE_CONTROL</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_CONNECTION_MONITOR</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_REPORTS_TX_ACK_STATUS</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SPECTRUM_MGMT</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_AP_LINK_PS</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_AMPDU_AGGREGATION</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_TX_AMPDU_SETUP_IN_HW</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SCAN_WHILE_IDLE</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">cipher_suites</span> <span class="o">=</span> <span class="n">cipher_suites</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_cipher_suites</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cipher_suites</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ssids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_sched_scan_ssids</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_match_sets</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Maximum length of elements in scanning probe request templates</span>
<span class="cm">	 * should be the maximum length possible for a template, without</span>
<span class="cm">	 * the IEEE80211 header of the template</span>
<span class="cm">	 */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ie_len</span> <span class="o">=</span> <span class="n">WL1271_CMD_TEMPL_MAX_SIZE</span> <span class="o">-</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_header</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_sched_scan_ie_len</span> <span class="o">=</span> <span class="n">WL1271_CMD_TEMPL_MAX_SIZE</span> <span class="o">-</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_header</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_AP_UAPSD</span> <span class="o">|</span>
				<span class="n">WIPHY_FLAG_HAS_REMAIN_ON_CHANNEL</span><span class="p">;</span>

	<span class="cm">/* make sure all our channels fit in the scanned_ch bitmask */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl1271_channels</span><span class="p">)</span> <span class="o">+</span>
		     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl1271_channels_5ghz</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="n">WL1271_MAX_CHANNELS</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We keep local copies of the band structs because we need to</span>
<span class="cm">	 * modify them on a per-device basis.</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">wl1271_band_2ghz</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">wl1271_band_2ghz</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">ht_cap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">wl1271_band_5ghz</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">wl1271_band_5ghz</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">ht_cap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">));</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">reg_notifier</span> <span class="o">=</span> <span class="n">wl1271_reg_notify</span><span class="p">;</span>

	<span class="cm">/* the FW answers probe-requests in AP-mode */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_AP_PROBE_RESP_OFFLOAD</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">probe_resp_offload</span> <span class="o">=</span>
		<span class="n">NL80211_PROBE_RESP_OFFLOAD_SUPPORT_WPS</span> <span class="o">|</span>
		<span class="n">NL80211_PROBE_RESP_OFFLOAD_SUPPORT_WPS2</span> <span class="o">|</span>
		<span class="n">NL80211_PROBE_RESP_OFFLOAD_SUPPORT_P2P</span><span class="p">;</span>

	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">sta_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_station</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vif_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_vif</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rx_aggregation_subframes</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">ht</span><span class="p">.</span><span class="n">rx_ba_win_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WL1271_DEFAULT_CHANNEL 0</span>

<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="nf">wlcore_alloc_hw</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">priv_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">order</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">AP_MAX_STATIONS</span> <span class="o">&gt;</span> <span class="n">WL12XX_MAX_LINKS</span><span class="p">);</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wl1271_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;could not alloc ieee80211_hw&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_hw_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="p">));</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">priv_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;could not alloc wl priv&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_priv_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlvif_list</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">WL12XX_MAX_LINKS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">links</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">deferred_rx_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">deferred_tx_queue</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">elp_work</span><span class="p">,</span> <span class="n">wl1271_elp_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">netstack_work</span><span class="p">,</span> <span class="n">wl1271_netstack_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">,</span> <span class="n">wl1271_tx_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">recovery_work</span><span class="p">,</span> <span class="n">wl1271_recovery_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scan_complete_work</span><span class="p">,</span> <span class="n">wl1271_scan_complete_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_watchdog_work</span><span class="p">,</span> <span class="n">wl12xx_tx_watchdog_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">connection_loss_work</span><span class="p">,</span>
			  <span class="n">wl1271_connection_loss_work</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">freezable_wq</span> <span class="o">=</span> <span class="n">create_freezable_workqueue</span><span class="p">(</span><span class="s">&quot;wl12xx_wq&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">freezable_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">WL1271_DEFAULT_CHANNEL</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">WL1271_DEFAULT_POWER_LEVEL</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">sg_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw_pg_ver</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_ps_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ap_fw_ps_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">platform_quirks</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">sched_scanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">system_hlid</span> <span class="o">=</span> <span class="n">WL12XX_SYSTEM_HLID</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">active_sta_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_waitq</span><span class="p">);</span>

	<span class="cm">/* The system link is always allocated */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">WL12XX_SYSTEM_HLID</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">links_map</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_frames_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_frames_map</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL1271_STATE_OFF</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_type</span> <span class="o">=</span> <span class="n">WL12XX_FW_TYPE_NONE</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">WL1271_AGGR_BUFFER_SIZE</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">aggr_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">__get_free_pages</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">aggr_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_wq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">dummy_packet</span> <span class="o">=</span> <span class="n">wl12xx_alloc_dummy_packet</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dummy_packet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_aggr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate one page for the FW log */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_dummy_packet</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">mbox</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_fwlog</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hw</span><span class="p">;</span>

<span class="nl">err_fwlog:</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog</span><span class="p">);</span>

<span class="nl">err_dummy_packet:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dummy_packet</span><span class="p">);</span>

<span class="nl">err_aggr:</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">aggr_buf</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>

<span class="nl">err_wq:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">freezable_wq</span><span class="p">);</span>

<span class="nl">err_hw:</span>
	<span class="n">wl1271_debugfs_exit</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>

<span class="nl">err_priv_alloc:</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

<span class="nl">err_hw_alloc:</span>

	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wlcore_alloc_hw</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">wlcore_free_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Unblock any fwlog readers */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up_interruptible_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog_waitq</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwlog_attr</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_hw_pg_ver</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_bt_coex_state</span><span class="p">);</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fwlog</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dummy_packet</span><span class="p">);</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">aggr_buf</span><span class="p">,</span>
			<span class="n">get_order</span><span class="p">(</span><span class="n">WL1271_AGGR_BUFFER_SIZE</span><span class="p">));</span>

	<span class="n">wl1271_debugfs_exit</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_type</span> <span class="o">=</span> <span class="n">WL12XX_FW_TYPE_NONE</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_res_if</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">freezable_wq</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wlcore_free_hw</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wl12xx_hardirq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;IRQ&quot;</span><span class="p">);</span>

	<span class="cm">/* complete the ELP completion */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_IRQ_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">elp_compl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">elp_compl</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">elp_compl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_SUSPENDED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t enqueue a work right now. mark it as pending */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_PENDING_WORK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;should not enqueue work&quot;</span><span class="p">);</span>
		<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">pm_wakeup_event</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_WAKE_THREAD</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">wlcore_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqflags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">||</span> <span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ptable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span> <span class="o">&gt;</span> <span class="n">WLCORE_MAX_TX_DESCRIPTORS</span><span class="p">);</span>

	<span class="cm">/* adjust some runtime configuration parameters */</span>
	<span class="n">wlcore_adjust_conf</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ref_clock</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">board_ref_clock</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tcxo_clock</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">board_tcxo_clock</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">platform_quirks</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">platform_quirks</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">set_power</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">if_ops</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">platform_quirks</span> <span class="o">&amp;</span> <span class="n">WL12XX_PLATFORM_QUIRK_EDGE_IRQ</span><span class="p">)</span>
		<span class="n">irqflags</span> <span class="o">=</span> <span class="n">IRQF_TRIGGER_RISING</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">irqflags</span> <span class="o">=</span> <span class="n">IRQF_TRIGGER_HIGH</span> <span class="o">|</span> <span class="n">IRQF_ONESHOT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">wl12xx_hardirq</span><span class="p">,</span> <span class="n">wl1271_irq</span><span class="p">,</span>
				   <span class="n">irqflags</span><span class="p">,</span>
				   <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;request_irq() failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">enable_irq_wake</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_wake_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">device_init_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">pwr_in_suspend</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">WIPHY_WOWLAN_ANY</span><span class="p">;</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">.</span><span class="n">n_patterns</span> <span class="o">=</span>
				<span class="n">WL1271_MAX_RX_FILTERS</span><span class="p">;</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">.</span><span class="n">pattern_min_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">.</span><span class="n">pattern_max_len</span> <span class="o">=</span>
				<span class="n">WL1271_RX_FILTER_MAX_PATTERN_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_init_ieee80211</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_irq</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_register_hw</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_irq</span><span class="p">;</span>

	<span class="cm">/* Create sysfs file to control bt coex state */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_bt_coex_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to create sysfs file bt_coex_state&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create sysfs file to get HW PG version */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_hw_pg_ver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to create sysfs file hw_pg_ver&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_bt_coex_state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create sysfs file for the FW log */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwlog_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to create sysfs file fwlog&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_hw_pg_ver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">out_hw_pg_ver:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_hw_pg_ver</span><span class="p">);</span>

<span class="nl">out_bt_coex_state:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_bt_coex_state</span><span class="p">);</span>

<span class="nl">out_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>

<span class="nl">out_free_hw:</span>
	<span class="n">wlcore_free_hw</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wlcore_probe</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">wlcore_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_wake_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_init_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">disable_irq_wake</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wl1271_unregister_hw</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
	<span class="n">wlcore_free_hw</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wlcore_remove</span><span class="p">);</span>

<span class="n">u32</span> <span class="n">wl12xx_debug_level</span> <span class="o">=</span> <span class="n">DEBUG_NONE</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wl12xx_debug_level</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="n">wl12xx_debug_level</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="s">&quot;wl12xx debugging level&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">fwlog</span><span class="p">,</span> <span class="n">fwlog_param</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fwlog</span><span class="p">,</span>
		 <span class="s">&quot;FW logger options: continuous, ondemand, dbgpins or disable&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">bug_on_recovery</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bug_on_recovery</span><span class="p">,</span> <span class="s">&quot;BUG() on fw recovery&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">no_recovery</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">no_recovery</span><span class="p">,</span> <span class="s">&quot;Prevent HW recovery. FW will remain stuck.&quot;</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Luciano Coelho &lt;coelho@ti.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Juuso Oikarinen &lt;juuso.oikarinen@nokia.com&gt;&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
