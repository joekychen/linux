<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › rt2x00 › rt2x00mac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>rt2x00mac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	Copyright (C) 2004 - 2009 Ivo van Doorn &lt;IvDoorn@gmail.com&gt;</span>
<span class="cm">	&lt;http://rt2x00.serialmonkey.com&gt;</span>

<span class="cm">	This program is free software; you can redistribute it and/or modify</span>
<span class="cm">	it under the terms of the GNU General Public License as published by</span>
<span class="cm">	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">	(at your option) any later version.</span>

<span class="cm">	This program is distributed in the hope that it will be useful,</span>
<span class="cm">	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm">	GNU General Public License for more details.</span>

<span class="cm">	You should have received a copy of the GNU General Public License</span>
<span class="cm">	along with this program; if not, write to the</span>
<span class="cm">	Free Software Foundation, Inc.,</span>
<span class="cm">	59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm">	Module: rt2x00mac</span>
<span class="cm">	Abstract: rt2x00 generic mac80211 routines.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;rt2x00.h&quot;</span>
<span class="cp">#include &quot;rt2x00lib.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2x00mac_tx_rts_cts</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">data_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">frag_skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">frag_skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">rts_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">)</span>
		<span class="n">data_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_cts</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">data_length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rts</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">data_length</span> <span class="o">+</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARNING</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Failed to create RTS/CTS frame.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span><span class="p">);</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">data_length</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Copy TX information over from original frame to</span>
<span class="cm">	 * RTS/CTS frame. Note that we set the no encryption flag</span>
<span class="cm">	 * since we don&#39;t want this frame to be encrypted.</span>
<span class="cm">	 * RTS frames should be acked, while CTS-to-self frames</span>
<span class="cm">	 * should not. The ready for TX flag is cleared to prevent</span>
<span class="cm">	 * it being automatically send when the descriptor is</span>
<span class="cm">	 * written to the hardware.</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">frag_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	<span class="n">rts_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">rts_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span><span class="p">;</span>
	<span class="n">rts_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">)</span>
		<span class="n">rts_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rts_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">;</span>

	<span class="cm">/* Disable hardware encryption */</span>
	<span class="n">rts_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * RTS/CTS frame should use the length of the frame plus any</span>
<span class="cm">	 * encryption overhead that will be added by the hardware.</span>
<span class="cm">	 */</span>
	<span class="n">data_length</span> <span class="o">+=</span> <span class="n">rt2x00crypto_tx_overhead</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">)</span>
		<span class="n">ieee80211_ctstoself_get</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">,</span>
					<span class="n">frag_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data_length</span><span class="p">,</span> <span class="n">tx_info</span><span class="p">,</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_cts</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">ieee80211_rts_get</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">,</span>
				  <span class="n">frag_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data_length</span><span class="p">,</span> <span class="n">tx_info</span><span class="p">,</span>
				  <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rts</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rt2x00queue_write_tx_frame</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">WARNING</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Failed to send RTS/CTS frame.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00mac_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">data_queue_qid</span> <span class="n">qid</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">data_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mac80211 might be calling this function while we are trying</span>
<span class="cm">	 * to remove the device or perhaps suspending it.</span>
<span class="cm">	 * Note that we can only stop the TX queues inside the TX path</span>
<span class="cm">	 * due to possible race conditions in mac80211.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">exit_free_skb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the ATIM queue if appropriate and present.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_SEND_AFTER_DTIM</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">REQUIRE_ATIM_QUEUE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="n">qid</span> <span class="o">=</span> <span class="n">QID_ATIM</span><span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">rt2x00queue_get_tx_queue</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">qid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span>
		      <span class="s">&quot;Attempt to send packet over invalid queue %d.</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;Please file bug report to %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qid</span><span class="p">,</span> <span class="n">DRV_PROJECT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_free_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If CTS/RTS is required. create and queue that frame first.</span>
<span class="cm">	 * Make sure we have at least enough entries available to send</span>
<span class="cm">	 * this CTS/RTS frame as well as the data frame.</span>
<span class="cm">	 * Note that when the driver has set the set_rts_threshold()</span>
<span class="cm">	 * callback function it doesn&#39;t need software generation of</span>
<span class="cm">	 * either RTS or CTS-to-self frame and handles everything</span>
<span class="cm">	 * inside the hardware.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">set_rts_threshold</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span> <span class="o">|</span>
						<span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00queue_available</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_fail</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00mac_tx_rts_cts</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">exit_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rt2x00queue_write_tx_frame</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">exit_fail</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Pausing queue has to be serialized with rt2x00lib_txdone(). Note</span>
<span class="cm">	 * we should not use spin_lock_bh variant as bottom halve was already</span>
<span class="cm">	 * disabled before ieee80211_xmit() call.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00queue_threshold</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">rt2x00queue_pause_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

 <span class="nl">exit_fail:</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">rt2x00queue_pause_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
 <span class="nl">exit_free_skb:</span>
	<span class="n">ieee80211_free_txskb</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_tx</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2x00mac_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rt2x00lib_start</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_start</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00mac_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rt2x00lib_stop</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_stop</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2x00mac_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt2x00_intf</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">vif_to_intf</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">data_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bcn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t allow interfaces to be added</span>
<span class="cm">	 * the device has disappeared.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t support mixed combinations of</span>
<span class="cm">		 * sta and ap interfaces.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_sta_count</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check if we exceeded the maximum amount</span>
<span class="cm">		 * of supported interfaces.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_ap_count</span> <span class="o">&gt;=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">max_ap_intf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_WDS</span>:
		<span class="cm">/*</span>
<span class="cm">		 * We don&#39;t support mixed combinations of</span>
<span class="cm">		 * sta and ap interfaces.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_ap_count</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check if we exceeded the maximum amount</span>
<span class="cm">		 * of supported interfaces.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_sta_count</span> <span class="o">&gt;=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">max_sta_intf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Loop through all beacon queues to find a free</span>
<span class="cm">	 * entry. Since there are as much beacon entries</span>
<span class="cm">	 * as the maximum interfaces, this search shouldn&#39;t</span>
<span class="cm">	 * fail.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">ENTRY_BCN_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are now absolutely sure the interface can be created,</span>
<span class="cm">	 * increase interface count and start initialization.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_ap_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_sta_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">beacon_skb_mutex</span><span class="p">);</span>
	<span class="n">intf</span><span class="o">-&gt;</span><span class="n">beacon</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The MAC address must be configured after the device</span>
<span class="cm">	 * has been initialized. Otherwise the device can reset</span>
<span class="cm">	 * the MAC registers.</span>
<span class="cm">	 * The BSSID address must only be configured in AP mode,</span>
<span class="cm">	 * however we should not send an empty BSSID address for</span>
<span class="cm">	 * STA interfaces at this time, since this can cause</span>
<span class="cm">	 * invalid behavior in the device.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00lib_config_intf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
			      <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some filters depend on the current working mode. We can force</span>
<span class="cm">	 * an update during the next configure_filter() run by mac80211 by</span>
<span class="cm">	 * resetting the current packet_filter state.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">packet_filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_add_interface</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00mac_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt2x00_intf</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">vif_to_intf</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t allow interfaces to be remove while</span>
<span class="cm">	 * either the device has disappeared or when</span>
<span class="cm">	 * no interface is present.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_ap_count</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_sta_count</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_ap_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_sta_count</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Release beacon entry so it is available for</span>
<span class="cm">	 * new interfaces again.</span>
<span class="cm">	 */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ENTRY_BCN_ASSIGNED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure the bssid and mac address registers</span>
<span class="cm">	 * are cleared to prevent false ACKing of frames.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00lib_config_intf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span>
			      <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_remove_interface</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2x00mac_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * mac80211 might be calling this function while we are trying</span>
<span class="cm">	 * to remove the device or perhaps suspending it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some configuration parameters (e.g. channel and antenna values) can</span>
<span class="cm">	 * only be set when the radio is enabled, but do require the RX to</span>
<span class="cm">	 * be off. During this period we should keep link tuning enabled,</span>
<span class="cm">	 * if for any reason the link tuner must be reset, this will be</span>
<span class="cm">	 * handled by rt2x00lib_config().</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00queue_stop_queue</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * When we&#39;ve just turned on the radio, we want to reprogram</span>
<span class="cm">	 * everything to ensure a consistent state</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00lib_config</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * After the radio has been enabled we need to configure</span>
<span class="cm">	 * the antenna to the default settings. rt2x00lib_config_antenna()</span>
<span class="cm">	 * should determine if any action should be taken based on</span>
<span class="cm">	 * checking if diversity has been enabled or no antenna changes</span>
<span class="cm">	 * have been made since the last configuration change.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00lib_config_antenna</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">);</span>

	<span class="cm">/* Turn RX back on */</span>
	<span class="n">rt2x00queue_start_queue</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_config</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00mac_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">,</span>
				<span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mask off any flags we are going to ignore</span>
<span class="cm">	 * from the total_flags field.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;=</span>
	    <span class="n">FIF_ALLMULTI</span> <span class="o">|</span>
	    <span class="n">FIF_FCSFAIL</span> <span class="o">|</span>
	    <span class="n">FIF_PLCPFAIL</span> <span class="o">|</span>
	    <span class="n">FIF_CONTROL</span> <span class="o">|</span>
	    <span class="n">FIF_PSPOLL</span> <span class="o">|</span>
	    <span class="n">FIF_OTHER_BSS</span> <span class="o">|</span>
	    <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Apply some rules to the filters:</span>
<span class="cm">	 * - Some filters imply different filters to be set.</span>
<span class="cm">	 * - Some things we can&#39;t filter out at all.</span>
<span class="cm">	 * - Multicast filter seems to kill broadcast traffic so never use it.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">total_flags</span> <span class="o">|=</span> <span class="n">FIF_ALLMULTI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;</span> <span class="n">FIF_OTHER_BSS</span> <span class="o">||</span>
	    <span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">)</span>
		<span class="o">*</span><span class="n">total_flags</span> <span class="o">|=</span> <span class="n">FIF_PROMISC_IN_BSS</span> <span class="o">|</span> <span class="n">FIF_OTHER_BSS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the device has a single filter for all control frames,</span>
<span class="cm">	 * FIF_CONTROL and FIF_PSPOLL flags imply each other.</span>
<span class="cm">	 * And if the device has more than one filter for control frames</span>
<span class="cm">	 * of different types, but has no a separate filter for PS Poll frames,</span>
<span class="cm">	 * FIF_CONTROL flag implies FIF_PSPOLL.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_CONTROL_FILTERS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span> <span class="o">||</span> <span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PSPOLL</span><span class="p">)</span>
			<span class="o">*</span><span class="n">total_flags</span> <span class="o">|=</span> <span class="n">FIF_CONTROL</span> <span class="o">|</span> <span class="n">FIF_PSPOLL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_CONTROL_FILTER_PSPOLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">)</span>
			<span class="o">*</span><span class="n">total_flags</span> <span class="o">|=</span> <span class="n">FIF_PSPOLL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if there is any work left for us.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">packet_filter</span> <span class="o">==</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">packet_filter</span> <span class="o">=</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">;</span>

	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">config_filter</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_configure_filter</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00mac_set_tim_iter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_intf</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">vif_to_intf</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_WDS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">DELAYED_UPDATE_BEACON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">delayed_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rt2x00mac_set_tim</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
		      <span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
						   <span class="n">rt2x00mac_set_tim_iter</span><span class="p">,</span>
						   <span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/* queue work to upodate the beacon template */</span>
	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_set_tim</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_RT2X00_LIB_CRYPTO</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">memcpy_tkip</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00lib_crypto</span> <span class="o">*</span><span class="n">crypto</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">NL80211_TKIP_DATA_OFFSET_ENCR_KEY</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="n">NL80211_TKIP_DATA_OFFSET_ENCR_KEY</span><span class="p">],</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">NL80211_TKIP_DATA_OFFSET_TX_MIC_KEY</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">tx_mic</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="n">NL80211_TKIP_DATA_OFFSET_TX_MIC_KEY</span><span class="p">],</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">tx_mic</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">rx_mic</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">key</span><span class="p">[</span><span class="n">NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY</span><span class="p">],</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">rx_mic</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rt2x00mac_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_key</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rt2x00lib_crypto</span> <span class="o">*</span><span class="n">crypto</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rt2x00lib_crypto</span> <span class="n">crypto</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">bcast_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">rt2x00_sta</span> <span class="o">*</span><span class="n">sta_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_HW_CRYPTO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypto</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crypto</span><span class="p">));</span>

	<span class="n">crypto</span><span class="p">.</span><span class="n">bssidx</span> <span class="o">=</span> <span class="n">rt2x00lib_get_bssidx</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="n">crypto</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">rt2x00crypto_key_to_cipher</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">CIPHER_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">crypto</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crypto</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">sta_priv</span> <span class="o">=</span> <span class="n">sta_to_rt2x00_sta</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
		<span class="n">crypto</span><span class="p">.</span><span class="n">wcid</span> <span class="o">=</span> <span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">wcid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">crypto</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">bcast_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">CIPHER_TKIP</span><span class="p">)</span>
		<span class="n">memcpy_tkip</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypto</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">crypto</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Each BSS has a maximum of 4 shared keys.</span>
<span class="cm">	 * Shared key index values:</span>
<span class="cm">	 *	0) BSS0 key0</span>
<span class="cm">	 *	1) BSS0 key1</span>
<span class="cm">	 *	...</span>
<span class="cm">	 *	4) BSS1 key0</span>
<span class="cm">	 *	...</span>
<span class="cm">	 *	8) BSS2 key0</span>
<span class="cm">	 *	...</span>
<span class="cm">	 * Both pairwise as shared key indeces are determined by</span>
<span class="cm">	 * driver. This is required because the hardware requires</span>
<span class="cm">	 * keys to be assigned in correct order (When key 1 is</span>
<span class="cm">	 * provided but key 0 is not, then the key is not found</span>
<span class="cm">	 * by the hardware during RX).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SET_KEY</span><span class="p">)</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">)</span>
		<span class="n">set_key</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">config_pairwise_key</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">set_key</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">config_shared_key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_key</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">set_key</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crypto</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_set_key</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_RT2X00_LIB_CRYPTO */</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">rt2x00mac_sta_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt2x00_sta</span> <span class="o">*</span><span class="n">sta_priv</span> <span class="o">=</span> <span class="n">sta_to_rt2x00_sta</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there&#39;s no space left in the device table store</span>
<span class="cm">	 * -1 as wcid but tell mac80211 everything went ok.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">sta_add</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">))</span>
		<span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">wcid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_sta_add</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2x00mac_sta_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt2x00_sta</span> <span class="o">*</span><span class="n">sta_priv</span> <span class="o">=</span> <span class="n">sta_to_rt2x00_sta</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we never sent the STA to the device no need to clean it up.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">wcid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">sta_remove</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">wcid</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_sta_remove</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00mac_sw_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rt2x00link_stop_tuner</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_sw_scan_start</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00mac_sw_scan_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rt2x00link_start_tuner</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_sw_scan_complete</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2x00mac_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_low_level_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The dot11ACKFailureCount, dot11RTSFailureCount and</span>
<span class="cm">	 * dot11RTSSuccessCount are updated in interrupt time.</span>
<span class="cm">	 * dot11FCSErrorCount is updated in the link tuner.</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">low_level_stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stats</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_get_stats</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00mac_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">changes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt2x00_intf</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">vif_to_intf</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * mac80211 might be calling this function while we are trying</span>
<span class="cm">	 * to remove the device or perhaps suspending it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the BSSID.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">)</span>
		<span class="n">rt2x00lib_config_intf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				      <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the beacon. This is only required on USB devices. PCI</span>
<span class="cm">	 * devices fetch beacons periodically.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span> <span class="o">&amp;&amp;</span> <span class="n">rt2x00_is_usb</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span>
		<span class="n">rt2x00queue_update_beacon</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start/stop beaconing.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span> <span class="o">&amp;&amp;</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt2x00queue_clear_beacon</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
			<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_beaconing</span><span class="o">--</span><span class="p">;</span>
			<span class="n">intf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_beaconing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Last beaconing interface disabled</span>
<span class="cm">				 * -&gt; stop beacon queue.</span>
<span class="cm">				 */</span>
				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">beacon_skb_mutex</span><span class="p">);</span>
				<span class="n">rt2x00queue_stop_queue</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bcn</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">beacon_skb_mutex</span><span class="p">);</span>
			<span class="p">}</span>


		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_beaconing</span><span class="o">++</span><span class="p">;</span>
			<span class="n">intf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_beaconing</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * First beaconing interface enabled</span>
<span class="cm">				 * -&gt; start beacon queue.</span>
<span class="cm">				 */</span>
				<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">beacon_skb_mutex</span><span class="p">);</span>
				<span class="n">rt2x00queue_start_queue</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bcn</span><span class="p">);</span>
				<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">beacon_skb_mutex</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * When the association status has changed we must reset the link</span>
<span class="cm">	 * tuner counter. This is because some drivers determine if they</span>
<span class="cm">	 * should perform link tuning based on the number of seconds</span>
<span class="cm">	 * while associated or not associated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span>
			<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_associated</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_associated</span><span class="o">--</span><span class="p">;</span>

		<span class="n">rt2x00leds_led_assoc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">!!</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_associated</span><span class="p">);</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONFIG_QOS_DISABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for access point which do not support 802.11e . We have to</span>
<span class="cm">	 * generate data frames sequence number in S/W for such AP, because</span>
<span class="cm">	 * of H/W bug.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_QOS</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONFIG_QOS_DISABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * When the erp information has changed, we should perform</span>
<span class="cm">	 * additional configuration steps. For all other changes we are done.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BSS_CHANGED_ERP_CTS_PROT</span> <span class="o">|</span> <span class="n">BSS_CHANGED_ERP_PREAMBLE</span> <span class="o">|</span>
		       <span class="n">BSS_CHANGED_ERP_SLOT</span> <span class="o">|</span> <span class="n">BSS_CHANGED_BASIC_RATES</span> <span class="o">|</span>
		       <span class="n">BSS_CHANGED_BEACON_INT</span> <span class="o">|</span> <span class="n">BSS_CHANGED_HT</span><span class="p">))</span>
		<span class="n">rt2x00lib_config_erp</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">bss_conf</span><span class="p">,</span> <span class="n">changes</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_bss_info_changed</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2x00mac_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">queue_idx</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">rt2x00queue_get_tx_queue</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">queue_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The passed variables are stored as real value ((2^n)-1).</span>
<span class="cm">	 * Ralink registers require to know the bit number &#39;n&#39;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">cw_min</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">cw_min</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* cw_min: 2^5 = 32. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">cw_max</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">cw_max</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* cw_min: 2^10 = 1024. */</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">aifs</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">txop</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">;</span>

	<span class="n">INFO</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span>
	     <span class="s">&quot;Configured TX queue %d - CWmin: %d, CWmax: %d, Aifs: %d, TXop: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">queue_idx</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_conf_tx</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00mac_rfkill_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">active</span> <span class="o">=</span> <span class="o">!!</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">rfkill_poll</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="o">!</span><span class="n">active</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_rfkill_poll</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00mac_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">drop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>

	<span class="n">tx_queue_for_each</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span>
		<span class="n">rt2x00queue_flush_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">drop</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_flush</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2x00mac_set_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx_ant</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_ant</span> <span class="o">*</span><span class="n">ant</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">antenna_setup</span> <span class="o">*</span><span class="n">def</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">antenna_setup</span> <span class="n">setup</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>The antenna value is not supposed to be 0,
or exceed the maximum number of antenna's.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ant</span> <span class="o">||</span> <span class="p">(</span><span class="n">tx_ant</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">rx_ant</span> <span class="o">||</span> <span class="p">(</span><span class="n">rx_ant</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>When the client tried to configure the antenna to or from
diversity mode, we must reset the default antenna as well
as that controls the diversity switch.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANTENNA_TX_DIVERSITY</span> <span class="o">&amp;&amp;</span> <span class="n">tx_ant</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ANTENNA_TX_DIVERSITY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANTENNA_RX_DIVERSITY</span> <span class="o">&amp;&amp;</span> <span class="n">rx_ant</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ANTENNA_RX_DIVERSITY</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>If diversity is being enabled, check if we need hardware
or software diversity. In the latter case, reset the value,
and make sure we update the antenna flags to have the
link tuner pick up the diversity tuning.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ant</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">def</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">==</span> <span class="n">ANTENNA_SW_DIVERSITY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_ant</span> <span class="o">=</span> <span class="n">ANTENNA_SW_DIVERSITY</span><span class="p">;</span>
		<span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ANTENNA_TX_DIVERSITY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_ant</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">def</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">==</span> <span class="n">ANTENNA_SW_DIVERSITY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_ant</span> <span class="o">=</span> <span class="n">ANTENNA_SW_DIVERSITY</span><span class="p">;</span>
		<span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ANTENNA_RX_DIVERSITY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup</span><span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">tx_ant</span><span class="p">;</span>
	<span class="n">setup</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">rx_ant</span><span class="p">;</span>

	<span class="n">rt2x00lib_config_antenna</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">setup</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_set_antenna</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2x00mac_get_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tx_ant</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx_ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_ant</span> <span class="o">*</span><span class="n">ant</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">antenna_setup</span> <span class="o">*</span><span class="n">active</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">.</span><span class="n">active</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>When software diversity is active, we must report this to the
client and not the current active antenna state.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANTENNA_TX_DIVERSITY</span><span class="p">)</span>
		<span class="o">*</span><span class="n">tx_ant</span> <span class="o">=</span> <span class="n">ANTENNA_HW_DIVERSITY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">tx_ant</span> <span class="o">=</span> <span class="n">active</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANTENNA_RX_DIVERSITY</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rx_ant</span> <span class="o">=</span> <span class="n">ANTENNA_HW_DIVERSITY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">rx_ant</span> <span class="o">=</span> <span class="n">active</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_get_antenna</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00mac_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tx_max</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>

	<span class="n">tx_queue_for_each</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tx_max</span> <span class="o">+=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">rx</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rx_max</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_get_ringparam</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">rt2x00mac_tx_frames_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>

	<span class="n">tx_queue_for_each</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00queue_empty</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00mac_tx_frames_pending</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
