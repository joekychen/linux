<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › rt2x00 › rt2800lib.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>rt2800lib.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	Copyright (C) 2010 Willow Garage &lt;http://www.willowgarage.com&gt;</span>
<span class="cm">	Copyright (C) 2010 Ivo van Doorn &lt;IvDoorn@gmail.com&gt;</span>
<span class="cm">	Copyright (C) 2009 Bartlomiej Zolnierkiewicz &lt;bzolnier@gmail.com&gt;</span>
<span class="cm">	Copyright (C) 2009 Gertjan van Wingerde &lt;gwingerde@gmail.com&gt;</span>

<span class="cm">	Based on the original rt2800pci.c and rt2800usb.c.</span>
<span class="cm">	  Copyright (C) 2009 Alban Browaeys &lt;prahal@yahoo.com&gt;</span>
<span class="cm">	  Copyright (C) 2009 Felix Fietkau &lt;nbd@openwrt.org&gt;</span>
<span class="cm">	  Copyright (C) 2009 Luis Correia &lt;luis.f.correia@gmail.com&gt;</span>
<span class="cm">	  Copyright (C) 2009 Mattias Nissler &lt;mattias.nissler@gmx.de&gt;</span>
<span class="cm">	  Copyright (C) 2009 Mark Asselstine &lt;asselsm@gmail.com&gt;</span>
<span class="cm">	  Copyright (C) 2009 Xose Vazquez Perez &lt;xose.vazquez@gmail.com&gt;</span>
<span class="cm">	  &lt;http://rt2x00.serialmonkey.com&gt;</span>

<span class="cm">	This program is free software; you can redistribute it and/or modify</span>
<span class="cm">	it under the terms of the GNU General Public License as published by</span>
<span class="cm">	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">	(at your option) any later version.</span>

<span class="cm">	This program is distributed in the hope that it will be useful,</span>
<span class="cm">	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm">	GNU General Public License for more details.</span>

<span class="cm">	You should have received a copy of the GNU General Public License</span>
<span class="cm">	along with this program; if not, write to the</span>
<span class="cm">	Free Software Foundation, Inc.,</span>
<span class="cm">	59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm">	Module: rt2800lib</span>
<span class="cm">	Abstract: rt2800 generic device routines.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/crc-ccitt.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;rt2x00.h&quot;</span>
<span class="cp">#include &quot;rt2800lib.h&quot;</span>
<span class="cp">#include &quot;rt2800.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Register access.</span>
<span class="cm"> * All access to the CSR registers will go through the methods</span>
<span class="cm"> * rt2800_register_read and rt2800_register_write.</span>
<span class="cm"> * BBP and RF register require indirect register access,</span>
<span class="cm"> * and use the CSR registers BBPCSR and RFCSR to achieve this.</span>
<span class="cm"> * These indirect registers work with busy bits,</span>
<span class="cm"> * and we will try maximal REGISTER_BUSY_COUNT times to access</span>
<span class="cm"> * the register while taking a REGISTER_BUSY_DELAY us delay</span>
<span class="cm"> * between each attampt. When the busy bit is still set at that time,</span>
<span class="cm"> * the access attempt is considered to have failed,</span>
<span class="cm"> * and we will print an error.</span>
<span class="cm"> * The _lock versions must be used if you already hold the csr_mutex</span>
<span class="cm"> */</span>
<span class="cp">#define WAIT_FOR_BBP(__dev, __reg) \</span>
<span class="cp">	rt2800_regbusy_read((__dev), BBP_CSR_CFG, BBP_CSR_CFG_BUSY, (__reg))</span>
<span class="cp">#define WAIT_FOR_RFCSR(__dev, __reg) \</span>
<span class="cp">	rt2800_regbusy_read((__dev), RF_CSR_CFG, RF_CSR_CFG_BUSY, (__reg))</span>
<span class="cp">#define WAIT_FOR_RF(__dev, __reg) \</span>
<span class="cp">	rt2800_regbusy_read((__dev), RF_CSR_CFG0, RF_CSR_CFG0_BUSY, (__reg))</span>
<span class="cp">#define WAIT_FOR_MCU(__dev, __reg) \</span>
<span class="cp">	rt2800_regbusy_read((__dev), H2M_MAILBOX_CSR, \</span>
<span class="cp">			    H2M_MAILBOX_CSR_OWNER, (__reg))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">rt2800_is_305x_soc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check for rt2872 on SoC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00_is_soc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT2872</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* we know for sure that these rf chipsets are used on rt305x boards */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF3020</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF3021</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF3022</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">NOTICE</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Unknown RF chipset on rt305x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_bbp_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">word</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until the BBP becomes available, afterwards we</span>
<span class="cm">	 * can safely write the new data into the register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WAIT_FOR_BBP</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BBP_CSR_CFG_VALUE</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BBP_CSR_CFG_REGNUM</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BBP_CSR_CFG_BUSY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BBP_CSR_CFG_READ_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BBP_CSR_CFG_BBP_RW_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">rt2800_register_write_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BBP_CSR_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_bbp_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">word</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until the BBP becomes available, afterwards we</span>
<span class="cm">	 * can safely write the read request into the register.</span>
<span class="cm">	 * After the data has been written, we wait until hardware</span>
<span class="cm">	 * returns the correct value, if at any time the register</span>
<span class="cm">	 * doesn&#39;t become available in time, reg will be 0xffffffff</span>
<span class="cm">	 * which means we return 0xff to the caller.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WAIT_FOR_BBP</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BBP_CSR_CFG_REGNUM</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BBP_CSR_CFG_BUSY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BBP_CSR_CFG_READ_CONTROL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BBP_CSR_CFG_BBP_RW_MODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">rt2800_register_write_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BBP_CSR_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">WAIT_FOR_BBP</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">BBP_CSR_CFG_VALUE</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_rfcsr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">word</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until the RFCSR becomes available, afterwards we</span>
<span class="cm">	 * can safely write the new data into the register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WAIT_FOR_RFCSR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG_DATA</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG_REGNUM</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG_WRITE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG_BUSY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">rt2800_register_write_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF_CSR_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_rfcsr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">word</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until the RFCSR becomes available, afterwards we</span>
<span class="cm">	 * can safely write the read request into the register.</span>
<span class="cm">	 * After the data has been written, we wait until hardware</span>
<span class="cm">	 * returns the correct value, if at any time the register</span>
<span class="cm">	 * doesn&#39;t become available in time, reg will be 0xffffffff</span>
<span class="cm">	 * which means we return 0xff to the caller.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WAIT_FOR_RFCSR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG_REGNUM</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG_WRITE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG_BUSY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">rt2800_register_write_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF_CSR_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">WAIT_FOR_RFCSR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG_DATA</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_rf_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">word</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until the RF becomes available, afterwards we</span>
<span class="cm">	 * can safely write the new data into the register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WAIT_FOR_RF</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG0_REG_VALUE_BW</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG0_STANDBYMODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG0_SEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RF_CSR_CFG0_BUSY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">rt2800_register_write_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF_CSR_CFG0</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">word</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2800_mcu_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="n">command</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">token</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="n">arg0</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">arg1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * SOC devices don&#39;t support MCU requests.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_soc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait until the MCU becomes available, afterwards we</span>
<span class="cm">	 * can safely write the new data into the register.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WAIT_FOR_MCU</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">H2M_MAILBOX_CSR_OWNER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">H2M_MAILBOX_CSR_CMD_TOKEN</span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">H2M_MAILBOX_CSR_ARG0</span><span class="p">,</span> <span class="n">arg0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">H2M_MAILBOX_CSR_ARG1</span><span class="p">,</span> <span class="n">arg1</span><span class="p">);</span>
		<span class="n">rt2800_register_write_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">H2M_MAILBOX_CSR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HOST_CMD_CSR_HOST_COMMAND</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
		<span class="n">rt2800_register_write_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HOST_CMD_CSR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_mcu_request</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_wait_csr_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REGISTER_BUSY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_CSR0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="o">~</span><span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Unstable hardware.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_wait_csr_ready</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_wait_wpdma_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some devices are really slow to respond here. Wait a whole second</span>
<span class="cm">	 * before timing out.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REGISTER_BUSY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_TX_DMA_BUSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_RX_DMA_BUSY</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;WPDMA TX/RX busy [0x%08x].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_wait_wpdma_ready</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2800_disable_wpdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_ENABLE_TX_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_TX_DMA_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_ENABLE_RX_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_RX_DMA_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_TX_WRITEBACK_DONE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_disable_wpdma</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rt2800_check_firmware_crc</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fw_crc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">crc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The last 2 bytes in the firmware array are the crc checksum itself,</span>
<span class="cm">	 * this means that we should never pass those 2 bytes to the crc</span>
<span class="cm">	 * algorithm.</span>
<span class="cm">	 */</span>
	<span class="n">fw_crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the crc ccitt algorithm.</span>
<span class="cm">	 * This will return the same value as the legacy driver which</span>
<span class="cm">	 * used bit ordering reversion on the both the firmware bytes</span>
<span class="cm">	 * before input input as well as on the final output.</span>
<span class="cm">	 * Obviously using crc ccitt directly is much more efficient.</span>
<span class="cm">	 */</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">crc_ccitt</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * There is a small difference between the crc-itu-t + bitrev and</span>
<span class="cm">	 * the crc-ccitt crc calculation. In the latter method the 2 bytes</span>
<span class="cm">	 * will be swapped, use swab16 to convert the crc to the correct</span>
<span class="cm">	 * value.</span>
<span class="cm">	 */</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">crc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fw_crc</span> <span class="o">==</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rt2800_check_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			  <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">fw_len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">multiple</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * PCI(e) &amp; SOC devices require firmware with a length</span>
<span class="cm">	 * of 8kb. USB devices require firmware files with a length</span>
<span class="cm">	 * of 4kb. Certain USB chipsets however require different firmware,</span>
<span class="cm">	 * which Ralink only provides attached to the original firmware</span>
<span class="cm">	 * file. Thus for USB devices, firmware files have a length</span>
<span class="cm">	 * which is a multiple of 4kb.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_usb</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fw_len</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
		<span class="n">multiple</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fw_len</span> <span class="o">=</span> <span class="mi">8192</span><span class="p">;</span>
		<span class="n">multiple</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate the firmware length</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">fw_len</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">multiple</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="n">fw_len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FW_BAD_LENGTH</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if the chipset requires one of the upper parts</span>
<span class="cm">	 * of the firmware.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_usb</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT2860</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT2872</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">len</span> <span class="o">/</span> <span class="n">fw_len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">FW_BAD_VERSION</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 8kb firmware files must be checked as if it were</span>
<span class="cm">	 * 2 separate firmware files.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2800_check_firmware_crc</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">fw_len</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">FW_BAD_CRC</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">fw_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">FW_OK</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_check_firmware</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If driver doesn&#39;t wake up firmware here,</span>
<span class="cm">	 * rt2800_load_firmware will hang forever when interface is up again.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for stable hardware.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2800_wait_csr_ready</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_pci</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUX_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUX_CTRL_FORCE_PCIE_CLK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUX_CTRL_WAKE_PCIE_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUX_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">PWR_PIN_CFG</span><span class="p">,</span> <span class="mh">0x00000002</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2800_disable_wpdma</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write firmware to the device.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_drv_write_firmware</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for device to stabilize.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REGISTER_BUSY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">PBF_SYS_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">PBF_SYS_CTRL_READY</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">REGISTER_BUSY_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;PBF system register not ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable DMA, will be reenabled later when enabling</span>
<span class="cm">	 * the radio.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_disable_wpdma</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize firmware.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">H2M_BBP_AGENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">H2M_MAILBOX_CSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_usb</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">H2M_INT_SRC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_load_firmware</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2800_write_tx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">txentry_desc</span> <span class="o">*</span><span class="n">txdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">txwi</span> <span class="o">=</span> <span class="n">rt2800_drv_get_txwi</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">word</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize TX Info descriptor</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00_desc_read</span><span class="p">(</span><span class="n">txwi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_FRAG</span><span class="p">,</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">ENTRY_TXD_MORE_FRAG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_MIMO_PS</span><span class="p">,</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">ENTRY_TXD_HT_MIMO_PS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_CF_ACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_TS</span><span class="p">,</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">ENTRY_TXD_REQ_TIMESTAMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_AMPDU</span><span class="p">,</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">ENTRY_TXD_HT_AMPDU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_MPDU_DENSITY</span><span class="p">,</span>
			   <span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ht</span><span class="p">.</span><span class="n">mpdu_density</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_TX_OP</span><span class="p">,</span> <span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ht</span><span class="p">.</span><span class="n">txop</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_MCS</span><span class="p">,</span> <span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ht</span><span class="p">.</span><span class="n">mcs</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_BW</span><span class="p">,</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">ENTRY_TXD_HT_BW_40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_SHORT_GI</span><span class="p">,</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">ENTRY_TXD_HT_SHORT_GI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_STBC</span><span class="p">,</span> <span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ht</span><span class="p">.</span><span class="n">stbc</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_PHYMODE</span><span class="p">,</span> <span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">rate_mode</span><span class="p">);</span>
	<span class="n">rt2x00_desc_write</span><span class="p">(</span><span class="n">txwi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="n">rt2x00_desc_read</span><span class="p">(</span><span class="n">txwi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W1_ACK</span><span class="p">,</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">ENTRY_TXD_ACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W1_NSEQ</span><span class="p">,</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">ENTRY_TXD_GENERATE_SEQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W1_BW_WIN_SIZE</span><span class="p">,</span> <span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ht</span><span class="p">.</span><span class="n">ba_size</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W1_WIRELESS_CLI_ID</span><span class="p">,</span>
			   <span class="n">test_bit</span><span class="p">(</span><span class="n">ENTRY_TXD_ENCRYPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span>
			   <span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">key_idx</span> <span class="o">:</span> <span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ht</span><span class="p">.</span><span class="n">wcid</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W1_MPDU_TOTAL_BYTE_COUNT</span><span class="p">,</span>
			   <span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W1_PACKETID_QUEUE</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">qid</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W1_PACKETID_ENTRY</span><span class="p">,</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_idx</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_desc_write</span><span class="p">(</span><span class="n">txwi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Always write 0 to IV/EIV fields, hardware will insert the IV</span>
<span class="cm">	 * from the IVEIV register when TXD_W3_WIV is set to 0.</span>
<span class="cm">	 * When TXD_W3_WIV is set to 1 it will use the IV data</span>
<span class="cm">	 * from the descriptor. The TXWI_W1_WIRELESS_CLI_ID indicates which</span>
<span class="cm">	 * crypto entry in the registers should be used to encrypt the frame.</span>
<span class="cm">	 */</span>
	<span class="n">_rt2x00_desc_write</span><span class="p">(</span><span class="n">txwi</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="cm">/* skbdesc-&gt;iv[0] */</span><span class="p">);</span>
	<span class="n">_rt2x00_desc_write</span><span class="p">(</span><span class="n">txwi</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span> <span class="cm">/* skbdesc-&gt;iv[1] */</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_write_tx_data</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2800_agc_to_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rxwi_w2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">rssi0</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">rxwi_w2</span><span class="p">,</span> <span class="n">RXWI_W2_RSSI0</span><span class="p">);</span>
	<span class="n">s8</span> <span class="n">rssi1</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">rxwi_w2</span><span class="p">,</span> <span class="n">RXWI_W2_RSSI1</span><span class="p">);</span>
	<span class="n">s8</span> <span class="n">rssi2</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">rxwi_w2</span><span class="p">,</span> <span class="n">RXWI_W2_RSSI2</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">offset0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">offset1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">offset2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">curr_band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">offset0</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG_OFFSET0</span><span class="p">);</span>
		<span class="n">offset1</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG_OFFSET1</span><span class="p">);</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">offset2</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG2_OFFSET2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">offset0</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A_OFFSET0</span><span class="p">);</span>
		<span class="n">offset1</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A_OFFSET1</span><span class="p">);</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">offset2</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A2_OFFSET2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert the value from the descriptor into the RSSI value</span>
<span class="cm">	 * If the value in the descriptor is 0, it is considered invalid</span>
<span class="cm">	 * and the default (extremely low) rssi value is assumed</span>
<span class="cm">	 */</span>
	<span class="n">rssi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">rssi0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">12</span> <span class="o">-</span> <span class="n">offset0</span> <span class="o">-</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">lna_gain</span> <span class="o">-</span> <span class="n">rssi0</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">128</span><span class="p">;</span>
	<span class="n">rssi1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rssi1</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">12</span> <span class="o">-</span> <span class="n">offset1</span> <span class="o">-</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">lna_gain</span> <span class="o">-</span> <span class="n">rssi1</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">128</span><span class="p">;</span>
	<span class="n">rssi2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rssi2</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="o">-</span><span class="mi">12</span> <span class="o">-</span> <span class="n">offset2</span> <span class="o">-</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">lna_gain</span> <span class="o">-</span> <span class="n">rssi2</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">128</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * mac80211 only accepts a single RSSI value. Calculating the</span>
<span class="cm">	 * average doesn&#39;t deliver a fair answer either since -60:-60 would</span>
<span class="cm">	 * be considered equally good as -50:-70 while the second is the one</span>
<span class="cm">	 * which gives less energy...</span>
<span class="cm">	 */</span>
	<span class="n">rssi0</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">rssi0</span><span class="p">,</span> <span class="n">rssi1</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">max</span><span class="p">(</span><span class="n">rssi0</span><span class="p">,</span> <span class="n">rssi2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2800_process_rxwi</span><span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">rxdone_entry_desc</span> <span class="o">*</span><span class="n">rxdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">rxwi</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">word</span><span class="p">;</span>

	<span class="n">rt2x00_desc_read</span><span class="p">(</span><span class="n">rxwi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>

	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">RXWI_W0_UDF</span><span class="p">);</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">RXWI_W0_MPDU_TOTAL_BYTE_COUNT</span><span class="p">);</span>

	<span class="n">rt2x00_desc_read</span><span class="p">(</span><span class="n">rxwi</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">RXWI_W1_SHORT_GI</span><span class="p">))</span>
		<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORT_GI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">RXWI_W1_BW</span><span class="p">))</span>
		<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RX_FLAG_40MHZ</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Detect RX rate, always use MCS as signal type.</span>
<span class="cm">	 */</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">RXDONE_SIGNAL_MCS</span><span class="p">;</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">RXWI_W1_MCS</span><span class="p">);</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">rate_mode</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">RXWI_W1_PHYMODE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mask of 0x8 bit to remove the short preamble flag.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">rate_mode</span> <span class="o">==</span> <span class="n">RATE_MODE_CCK</span><span class="p">)</span>
		<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x8</span><span class="p">;</span>

	<span class="n">rt2x00_desc_read</span><span class="p">(</span><span class="n">rxwi</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert descriptor AGC value to RSSI value.</span>
<span class="cm">	 */</span>
	<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">rt2800_agc_to_rssi</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Remove RXWI descriptor from start of buffer.</span>
<span class="cm">	 */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">RXWI_DESC_SIZE</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_process_rxwi</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2800_txdone_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">txwi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_frame_desc</span> <span class="o">*</span><span class="n">skbdesc</span> <span class="o">=</span> <span class="n">get_skb_frame_desc</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">txdone_entry_desc</span> <span class="n">txdesc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">word</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mcs</span><span class="p">,</span> <span class="n">real_mcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aggr</span><span class="p">,</span> <span class="n">ampdu</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Obtain the status about this packet.</span>
<span class="cm">	 */</span>
	<span class="n">txdesc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rt2x00_desc_read</span><span class="p">(</span><span class="n">txwi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>

	<span class="n">mcs</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_MCS</span><span class="p">);</span>
	<span class="n">ampdu</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">TXWI_W0_AMPDU</span><span class="p">);</span>

	<span class="n">real_mcs</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">TX_STA_FIFO_MCS</span><span class="p">);</span>
	<span class="n">aggr</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">TX_STA_FIFO_TX_AGGRE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If a frame was meant to be sent as a single non-aggregated MPDU</span>
<span class="cm">	 * but ended up in an aggregate the used tx rate doesn&#39;t correlate</span>
<span class="cm">	 * with the one specified in the TXWI as the whole aggregate is sent</span>
<span class="cm">	 * with the same rate.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For example: two frames are sent to rt2x00, the first one sets</span>
<span class="cm">	 * AMPDU=1 and requests MCS7 whereas the second frame sets AMDPU=0</span>
<span class="cm">	 * and requests MCS15. If the hw aggregates both frames into one</span>
<span class="cm">	 * AMDPU the tx status for both frames will contain MCS7 although</span>
<span class="cm">	 * the frame was sent successfully.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Hence, replace the requested rate with the real tx rate to not</span>
<span class="cm">	 * confuse the rate control algortihm by providing clearly wrong</span>
<span class="cm">	 * data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">aggr</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ampdu</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">real_mcs</span> <span class="o">!=</span> <span class="n">mcs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skbdesc</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span> <span class="o">=</span> <span class="n">real_mcs</span><span class="p">;</span>
		<span class="n">mcs</span> <span class="o">=</span> <span class="n">real_mcs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aggr</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">ampdu</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">TXDONE_AMPDU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ralink has a retry mechanism using a global fallback</span>
<span class="cm">	 * table. We setup this fallback table to try the immediate</span>
<span class="cm">	 * lower rate for all rates. In the TX_STA_FIFO, the MCS field</span>
<span class="cm">	 * always contains the MCS used for the last transmission, be</span>
<span class="cm">	 * it successful or not.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">TX_STA_FIFO_TX_SUCCESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Transmission succeeded. The number of retries is</span>
<span class="cm">		 * mcs - real_mcs</span>
<span class="cm">		 */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">TXDONE_SUCCESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">txdesc</span><span class="p">.</span><span class="n">retry</span> <span class="o">=</span> <span class="p">((</span><span class="n">mcs</span> <span class="o">&gt;</span> <span class="n">real_mcs</span><span class="p">)</span> <span class="o">?</span> <span class="n">mcs</span> <span class="o">-</span> <span class="n">real_mcs</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Transmission failed. The number of retries is</span>
<span class="cm">		 * always 7 in this case (for a total number of 8</span>
<span class="cm">		 * frames sent).</span>
<span class="cm">		 */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">TXDONE_FAILURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">txdesc</span><span class="p">.</span><span class="n">retry</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">long_retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * the frame was retried at least once</span>
<span class="cm">	 * -&gt; hw used fallback rates</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">retry</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">TXDONE_FALLBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">rt2x00lib_txdone</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_txdone_entry</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2800_write_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">txentry_desc</span> <span class="o">*</span><span class="n">txdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">skb_frame_desc</span> <span class="o">*</span><span class="n">skbdesc</span> <span class="o">=</span> <span class="n">get_skb_frame_desc</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">beacon_base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">padding_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">orig_reg</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable beaconing while we are reloading the beacon data,</span>
<span class="cm">	 * otherwise we might be sending out invalid data.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">orig_reg</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_BEACON_GEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add space for the TXWI in front of the skb.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">TXWI_DESC_SIZE</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TXWI_DESC_SIZE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register descriptor details in skb frame descriptor.</span>
<span class="cm">	 */</span>
	<span class="n">skbdesc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SKBDESC_DESC_IN_SKB</span><span class="p">;</span>
	<span class="n">skbdesc</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">skbdesc</span><span class="o">-&gt;</span><span class="n">desc_len</span> <span class="o">=</span> <span class="n">TXWI_DESC_SIZE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add the TXWI for the beacon to the skb.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_write_tx_data</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">txdesc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Dump beacon to userspace through debugfs.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00debug_dump_frame</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">DUMP_FRAME_BEACON</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write entire beacon with TXWI and padding to register.</span>
<span class="cm">	 */</span>
	<span class="n">padding_len</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padding_len</span> <span class="o">&amp;&amp;</span> <span class="n">skb_pad</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">padding_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Failure padding beacon, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* skb freed by skb_pad() on failure */</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="n">orig_reg</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">beacon_base</span> <span class="o">=</span> <span class="n">HW_BEACON_OFFSET</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_idx</span><span class="p">);</span>
	<span class="n">rt2800_register_multiwrite</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">beacon_base</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				   <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">padding_len</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable beaconing again.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_BEACON_GEN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clean up beacon skb.</span>
<span class="cm">	 */</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_write_beacon</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rt2800_clear_beacon_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">beacon_base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For the Beacon base registers we only need to clear</span>
<span class="cm">	 * the whole TXWI which (when set to 0) will invalidate</span>
<span class="cm">	 * the entire beacon.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TXWI_DESC_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">))</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">beacon_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2800_clear_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable beaconing while we are reloading the beacon data,</span>
<span class="cm">	 * otherwise we might be sending out invalid data.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_BEACON_GEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear beacon.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_clear_beacon_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span>
				     <span class="n">HW_BEACON_OFFSET</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">entry_idx</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enabled beaconing again.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_BEACON_GEN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_clear_beacon</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_RT2X00_LIB_DEBUGFS</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">rt2x00debug</span> <span class="n">rt2800_rt2x00debug</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">csr</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">rt2800_register_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">rt2800_register_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">RT2X00DEBUGFS_OFFSET</span><span class="p">,</span>
		<span class="p">.</span><span class="n">word_base</span>	<span class="o">=</span> <span class="n">CSR_REG_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">word_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
		<span class="p">.</span><span class="n">word_count</span>	<span class="o">=</span> <span class="n">CSR_REG_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">eeprom</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">rt2x00_eeprom_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">rt2x00_eeprom_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">word_base</span>	<span class="o">=</span> <span class="n">EEPROM_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">word_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span>
		<span class="p">.</span><span class="n">word_count</span>	<span class="o">=</span> <span class="n">EEPROM_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">bbp</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">rt2800_bbp_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">rt2800_bbp_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">word_base</span>	<span class="o">=</span> <span class="n">BBP_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">word_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span>
		<span class="p">.</span><span class="n">word_count</span>	<span class="o">=</span> <span class="n">BBP_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">rf</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">rt2x00_rf_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">rt2800_rf_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">word_base</span>	<span class="o">=</span> <span class="n">RF_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">word_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
		<span class="p">.</span><span class="n">word_count</span>	<span class="o">=</span> <span class="n">RF_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">rfcsr</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">rt2800_rfcsr_read</span><span class="p">,</span>
		<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">rt2800_rfcsr_write</span><span class="p">,</span>
		<span class="p">.</span><span class="n">word_base</span>	<span class="o">=</span> <span class="n">RFCSR_BASE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">word_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span>
		<span class="p">.</span><span class="n">word_count</span>	<span class="o">=</span> <span class="n">RFCSR_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_rt2x00debug</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_RT2X00_LIB_DEBUGFS */</span><span class="cp"></span>

<span class="kt">int</span> <span class="nf">rt2800_rfkill_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_BIT2</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_rfkill_poll</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_RT2X00_LIB_LEDS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_brightness_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt2x00_led</span><span class="p">,</span> <span class="n">led_dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">enabled</span> <span class="o">=</span> <span class="n">brightness</span> <span class="o">!=</span> <span class="n">LED_OFF</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bg_mode</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">curr_band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">polarity</span> <span class="o">=</span>
		<span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">led_mcu_reg</span><span class="p">,</span>
				   <span class="n">EEPROM_FREQ_LED_POLARITY</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ledmode</span> <span class="o">=</span>
		<span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">led_mcu_reg</span><span class="p">,</span>
				   <span class="n">EEPROM_FREQ_LED_MODE</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Check for SoC (SOC devices don&#39;t support MCU requests) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_soc</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LED_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* Set LED Polarity */</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_LED_POLAR</span><span class="p">,</span> <span class="n">polarity</span><span class="p">);</span>

		<span class="cm">/* Set LED Mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LED_TYPE_RADIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_G_LED_MODE</span><span class="p">,</span>
					   <span class="n">enabled</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LED_TYPE_ASSOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_Y_LED_MODE</span><span class="p">,</span>
					   <span class="n">enabled</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LED_TYPE_QUALITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_R_LED_MODE</span><span class="p">,</span>
					   <span class="n">enabled</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LED_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LED_TYPE_RADIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt2800_mcu_request</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MCU_LED</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ledmode</span><span class="p">,</span>
					      <span class="n">enabled</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LED_TYPE_ASSOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt2800_mcu_request</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MCU_LED</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ledmode</span><span class="p">,</span>
					      <span class="n">enabled</span> <span class="o">?</span> <span class="p">(</span><span class="n">bg_mode</span> <span class="o">?</span> <span class="mh">0x60</span> <span class="o">:</span> <span class="mh">0xa0</span><span class="p">)</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">LED_TYPE_QUALITY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The brightness is divided into 6 levels (0 - 5),</span>
<span class="cm">			 * The specs tell us the following levels:</span>
<span class="cm">			 *	0, 1 ,3, 7, 15, 31</span>
<span class="cm">			 * to determine the level in a simple way we can simply</span>
<span class="cm">			 * work with bitshifting:</span>
<span class="cm">			 *	(1 &lt;&lt; level) - 1</span>
<span class="cm">			 */</span>
			<span class="n">rt2800_mcu_request</span><span class="p">(</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MCU_LED_STRENGTH</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
					      <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">brightness</span> <span class="o">/</span> <span class="p">(</span><span class="n">LED_FULL</span> <span class="o">/</span> <span class="mi">6</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="n">polarity</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_init_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">rt2x00_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span> <span class="k">enum</span> <span class="n">led_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">led_dev</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">rt2800_brightness_set</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">LED_INITIALIZED</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_RT2X00_LIB_LEDS */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Configuration handlers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_wcid</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">address</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">wcid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mac_wcid_entry</span> <span class="n">wcid_entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">MAC_WCID_ENTRY</span><span class="p">(</span><span class="n">wcid</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wcid_entry</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wcid_entry</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">address</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wcid_entry</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">rt2800_register_multiwrite</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">wcid_entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wcid_entry</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_delete_wcid_attr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wcid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">MAC_WCID_ATTR_ENTRY</span><span class="p">(</span><span class="n">wcid</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_wcid_attr_bssidx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">wcid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bssidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">MAC_WCID_ATTR_ENTRY</span><span class="p">(</span><span class="n">wcid</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The BSS Idx numbers is split in a main value of 3 bits,</span>
<span class="cm">	 * and a extended field for adding one additional bit to the value.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_WCID_ATTRIBUTE_BSS_IDX</span><span class="p">,</span> <span class="p">(</span><span class="n">bssidx</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_WCID_ATTRIBUTE_BSS_IDX_EXT</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">bssidx</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_wcid_attr_cipher</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">rt2x00lib_crypto</span> <span class="o">*</span><span class="n">crypto</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mac_iveiv_entry</span> <span class="n">iveiv_entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">MAC_WCID_ATTR_ENTRY</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SET_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_WCID_ATTRIBUTE_KEYTAB</span><span class="p">,</span>
				   <span class="o">!!</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * Both the cipher as the BSS Idx numbers are split in a main</span>
<span class="cm">		 * value of 3 bits, and a extended field for adding one additional</span>
<span class="cm">		 * bit to the value.</span>
<span class="cm">		 */</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_WCID_ATTRIBUTE_CIPHER</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">));</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_WCID_ATTRIBUTE_CIPHER_EXT</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_WCID_ATTRIBUTE_RX_WIUDF</span><span class="p">,</span> <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Delete the cipher without touching the bssidx */</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_WCID_ATTRIBUTE_KEYTAB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_WCID_ATTRIBUTE_CIPHER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_WCID_ATTRIBUTE_CIPHER_EXT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_WCID_ATTRIBUTE_RX_WIUDF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">MAC_IVEIV_ENTRY</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iveiv_entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iveiv_entry</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">CIPHER_TKIP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">CIPHER_TKIP_NO_MIC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">CIPHER_AES</span><span class="p">))</span>
		<span class="n">iveiv_entry</span><span class="p">.</span><span class="n">iv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">iveiv_entry</span><span class="p">.</span><span class="n">iv</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">rt2800_register_multiwrite</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">iveiv_entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iveiv_entry</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rt2800_config_shared_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">rt2x00lib_crypto</span> <span class="o">*</span><span class="n">crypto</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_key_entry</span> <span class="n">key_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt2x00_field32</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SET_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">bssidx</span><span class="p">)</span> <span class="o">+</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">key</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">tx_mic</span><span class="p">,</span> <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">tx_mic</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">tx_mic</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">rx_mic</span><span class="p">,</span> <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">rx_mic</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">rx_mic</span><span class="p">));</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">SHARED_KEY_ENTRY</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">);</span>
		<span class="n">rt2800_register_multiwrite</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">key_entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key_entry</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The cipher types are stored over multiple registers</span>
<span class="cm">	 * starting with SHARED_KEY_MODE_BASE each word will have</span>
<span class="cm">	 * 32 bits and contains the cipher types for 2 bssidx each.</span>
<span class="cm">	 * Using the correct defines correctly will cause overhead,</span>
<span class="cm">	 * so just calculate the correct offset.</span>
<span class="cm">	 */</span>
	<span class="n">field</span><span class="p">.</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">%</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">field</span><span class="p">.</span><span class="n">bit_mask</span> <span class="o">=</span> <span class="mh">0x7</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">.</span><span class="n">bit_offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">SHARED_KEY_MODE_ENTRY</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SET_KEY</span><span class="p">)</span> <span class="o">*</span> <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update WCID information</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_config_wcid</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">);</span>
	<span class="n">rt2800_config_wcid_attr_bssidx</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">,</span>
				       <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">bssidx</span><span class="p">);</span>
	<span class="n">rt2800_config_wcid_attr_cipher</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">crypto</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_config_shared_key</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rt2800_find_wcid</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mac_wcid_entry</span> <span class="n">wcid_entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Search for the first free WCID entry and return the corresponding</span>
<span class="cm">	 * index.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Make sure the WCID starts _after_ the last possible shared key</span>
<span class="cm">	 * entry (&gt;32).</span>
<span class="cm">	 *</span>
<span class="cm">	 * Since parts of the pairwise key table might be shared with</span>
<span class="cm">	 * the beacon frame buffers 6 &amp; 7 we should only write into the</span>
<span class="cm">	 * first 222 entries.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">222</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">MAC_WCID_ENTRY</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">rt2800_register_multiread</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wcid_entry</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="n">wcid_entry</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">wcid_entry</span><span class="p">.</span><span class="n">mac</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use -1 to indicate that we don&#39;t have any more space in the WCID</span>
<span class="cm">	 * table.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rt2800_config_pairwise_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">rt2x00lib_crypto</span> <span class="o">*</span><span class="n">crypto</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_key_entry</span> <span class="n">key_entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SET_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allow key configuration only for STAs that are</span>
<span class="cm">		 * known by the hw.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crypto</span><span class="o">-&gt;</span><span class="n">wcid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">wcid</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">key</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">tx_mic</span><span class="p">,</span> <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">tx_mic</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">tx_mic</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">rx_mic</span><span class="p">,</span> <span class="n">crypto</span><span class="o">-&gt;</span><span class="n">rx_mic</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">key_entry</span><span class="p">.</span><span class="n">rx_mic</span><span class="p">));</span>

		<span class="n">offset</span> <span class="o">=</span> <span class="n">PAIRWISE_KEY_ENTRY</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">);</span>
		<span class="n">rt2800_register_multiwrite</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">key_entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key_entry</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update WCID information</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_config_wcid_attr_cipher</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">crypto</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_config_pairwise_key</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_sta_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wcid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt2x00_sta</span> <span class="o">*</span><span class="n">sta_priv</span> <span class="o">=</span> <span class="n">sta_to_rt2x00_sta</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find next free WCID.</span>
<span class="cm">	 */</span>
	<span class="n">wcid</span> <span class="o">=</span> <span class="n">rt2800_find_wcid</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Store selected wcid even if it is invalid so that we can</span>
<span class="cm">	 * later decide if the STA is uploaded into the hw.</span>
<span class="cm">	 */</span>
	<span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">wcid</span> <span class="o">=</span> <span class="n">wcid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No space left in the device, however, we can still communicate</span>
<span class="cm">	 * with the STA -&gt; No error.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wcid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clean up WCID attributes and write STA address to the device.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_delete_wcid_attr</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">wcid</span><span class="p">);</span>
	<span class="n">rt2800_config_wcid</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">wcid</span><span class="p">);</span>
	<span class="n">rt2800_config_wcid_attr_bssidx</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">wcid</span><span class="p">,</span>
				       <span class="n">rt2x00lib_get_bssidx</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">vif</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_sta_add</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_sta_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wcid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Remove WCID entry, no need to clean the attributes as they will</span>
<span class="cm">	 * get renewed when the WCID is reused.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_config_wcid</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">wcid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_sta_remove</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2800_config_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">filter_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start configuration steps.</span>
<span class="cm">	 * Note that the version error will always be dropped</span>
<span class="cm">	 * and broadcast frames will always be accepted since</span>
<span class="cm">	 * there is no filter for it at this time.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RX_FILTER_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_CRC_ERROR</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_PHY_ERROR</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PLCPFAIL</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_NOT_TO_ME</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_NOT_MY_BSSD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_VER_ERROR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_MULTICAST</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_ALLMULTI</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_BROADCAST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_DUPLICATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_CF_END_ACK</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_CF_END</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_ACK</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_CTS</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_RTS</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_PSPOLL</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PSPOLL</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_BA</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_BAR</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_FILTER_CFG_DROP_CNTL</span><span class="p">,</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">));</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RX_FILTER_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_config_filter</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2800_config_intf</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt2x00_intf</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rt2x00intf_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">update_bssid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CONFIG_UPDATE_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Enable synchronisation.</span>
<span class="cm">		 */</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_TSF_SYNC</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">==</span> <span class="n">TSF_SYNC_AP_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Tune beacon queue transmit parameters for AP mode</span>
<span class="cm">			 */</span>
			<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG_BCN_CWMIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG_BCN_AIFSN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG_BCN_EXP_WIN</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG_TBTT_ADJUST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG_BCN_CWMIN</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG_BCN_AIFSN</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG_BCN_EXP_WIN</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG_TBTT_ADJUST</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TBTT_SYNC_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CONFIG_UPDATE_MAC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CONFIG_UPDATE_TYPE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">==</span> <span class="n">TSF_SYNC_AP_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The BSSID register has to be set to our own mac</span>
<span class="cm">			 * address in AP mode.</span>
<span class="cm">			 */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">));</span>
			<span class="n">update_bssid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">((</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_ADDR_DW1_UNICAST_TO_ME_MASK</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rt2800_register_multiwrite</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_ADDR_DW0</span><span class="p">,</span>
					      <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CONFIG_UPDATE_BSSID</span><span class="p">)</span> <span class="o">||</span> <span class="n">update_bssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">((</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_BSSID_DW1_BSS_ID_MASK</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_BSSID_DW1_BSS_BCN_NUM</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
			<span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rt2800_register_multiwrite</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_BSSID_DW0</span><span class="p">,</span>
					      <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_config_intf</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_ht_opmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">rt2x00lib_erp</span> <span class="o">*</span><span class="n">erp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">any_sta_nongf</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">ht_opmode</span> <span class="o">&amp;</span>
				<span class="n">IEEE80211_HT_OP_MODE_NON_GF_STA_PRSNT</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">protection</span> <span class="o">=</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">ht_opmode</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_OP_MODE_PROTECTION</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mm20_mode</span><span class="p">,</span> <span class="n">mm40_mode</span><span class="p">,</span> <span class="n">gf20_mode</span><span class="p">,</span> <span class="n">gf40_mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mm20_rate</span><span class="p">,</span> <span class="n">mm40_rate</span><span class="p">,</span> <span class="n">gf20_rate</span><span class="p">,</span> <span class="n">gf40_rate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* default protection rate for HT20: OFDM 24M */</span>
	<span class="n">mm20_rate</span> <span class="o">=</span> <span class="n">gf20_rate</span> <span class="o">=</span> <span class="mh">0x4004</span><span class="p">;</span>

	<span class="cm">/* default protection rate for HT40: duplicate OFDM 24M */</span>
	<span class="n">mm40_rate</span> <span class="o">=</span> <span class="n">gf40_rate</span> <span class="o">=</span> <span class="mh">0x4084</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">protection</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_HT_OP_MODE_PROTECTION_NONE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * All STAs in this BSS are HT20/40 but there might be</span>
<span class="cm">		 * STAs not supporting greenfield mode.</span>
<span class="cm">		 * =&gt; Disable protection for HT transmissions.</span>
<span class="cm">		 */</span>
		<span class="n">mm20_mode</span> <span class="o">=</span> <span class="n">mm40_mode</span> <span class="o">=</span> <span class="n">gf20_mode</span> <span class="o">=</span> <span class="n">gf40_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_HT_OP_MODE_PROTECTION_20MHZ</span>:
		<span class="cm">/*</span>
<span class="cm">		 * All STAs in this BSS are HT20 or HT20/40 but there</span>
<span class="cm">		 * might be STAs not supporting greenfield mode.</span>
<span class="cm">		 * =&gt; Protect all HT40 transmissions.</span>
<span class="cm">		 */</span>
		<span class="n">mm20_mode</span> <span class="o">=</span> <span class="n">gf20_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mm40_mode</span> <span class="o">=</span> <span class="n">gf40_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_HT_OP_MODE_PROTECTION_NONMEMBER</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Nonmember protection:</span>
<span class="cm">		 * According to 802.11n we _should_ protect all</span>
<span class="cm">		 * HT transmissions (but we don&#39;t have to).</span>
<span class="cm">		 *</span>
<span class="cm">		 * But if cts_protection is enabled we _shall_ protect</span>
<span class="cm">		 * all HT transmissions using a CCK rate.</span>
<span class="cm">		 *</span>
<span class="cm">		 * And if any station is non GF we _shall_ protect</span>
<span class="cm">		 * GF transmissions.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We decide to protect everything</span>
<span class="cm">		 * -&gt; fall through to mixed mode.</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">IEEE80211_HT_OP_MODE_PROTECTION_NONHT_MIXED</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Legacy STAs are present</span>
<span class="cm">		 * =&gt; Protect all HT transmissions.</span>
<span class="cm">		 */</span>
		<span class="n">mm20_mode</span> <span class="o">=</span> <span class="n">mm40_mode</span> <span class="o">=</span> <span class="n">gf20_mode</span> <span class="o">=</span> <span class="n">gf40_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If erp protection is needed we have to protect HT</span>
<span class="cm">		 * transmissions with CCK 11M long preamble.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">cts_protection</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* don&#39;t duplicate RTS/CTS in CCK mode */</span>
			<span class="n">mm20_rate</span> <span class="o">=</span> <span class="n">mm40_rate</span> <span class="o">=</span> <span class="mh">0x0003</span><span class="p">;</span>
			<span class="n">gf20_rate</span> <span class="o">=</span> <span class="n">gf40_rate</span> <span class="o">=</span> <span class="mh">0x0003</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check for STAs not supporting greenfield mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">any_sta_nongf</span><span class="p">)</span>
		<span class="n">gf20_mode</span> <span class="o">=</span> <span class="n">gf40_mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Update HT protection config */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM20_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_PROTECT_RATE</span><span class="p">,</span> <span class="n">mm20_rate</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_PROTECT_CTRL</span><span class="p">,</span> <span class="n">mm20_mode</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM20_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM40_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_PROTECT_RATE</span><span class="p">,</span> <span class="n">mm40_rate</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_PROTECT_CTRL</span><span class="p">,</span> <span class="n">mm40_mode</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM40_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF20_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_PROTECT_RATE</span><span class="p">,</span> <span class="n">gf20_rate</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_PROTECT_CTRL</span><span class="p">,</span> <span class="n">gf20_mode</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF20_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF40_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_PROTECT_RATE</span><span class="p">,</span> <span class="n">gf40_rate</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_PROTECT_CTRL</span><span class="p">,</span> <span class="n">gf40_mode</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF40_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2800_config_erp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt2x00lib_erp</span> <span class="o">*</span><span class="n">erp</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_PREAMBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG_BAC_ACK_POLICY</span><span class="p">,</span>
				   <span class="o">!!</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">short_preamble</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG_AR_PREAMBLE</span><span class="p">,</span>
				   <span class="o">!!</span><span class="n">erp</span><span class="o">-&gt;</span><span class="n">short_preamble</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_CTS_PROT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_PROTECT_CTRL</span><span class="p">,</span>
				   <span class="n">erp</span><span class="o">-&gt;</span><span class="n">cts_protection</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BASIC_RATES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LEGACY_BASIC_RATE</span><span class="p">,</span>
					 <span class="n">erp</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HT_BASIC_RATE</span><span class="p">,</span> <span class="mh">0x00008003</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BKOFF_SLOT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BKOFF_SLOT_CFG_SLOT_TIME</span><span class="p">,</span>
				   <span class="n">erp</span><span class="o">-&gt;</span><span class="n">slot_time</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BKOFF_SLOT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">XIFS_TIME_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">XIFS_TIME_CFG_EIFS</span><span class="p">,</span> <span class="n">erp</span><span class="o">-&gt;</span><span class="n">eifs</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">XIFS_TIME_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_BEACON_INTERVAL</span><span class="p">,</span>
				   <span class="n">erp</span><span class="o">-&gt;</span><span class="n">beacon_int</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_HT</span><span class="p">)</span>
		<span class="n">rt2800_config_ht_opmode</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">erp</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_config_erp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_3572bt_ant</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">led_ctrl</span><span class="p">,</span> <span class="n">led_g_mode</span><span class="p">,</span> <span class="n">led_r_mode</span><span class="p">;</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_SWITCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">curr_band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_SWITCH_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_SWITCH_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_SWITCH_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_SWITCH_1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_SWITCH</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LED_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">led_g_mode</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_LED_POLAR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">led_r_mode</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_LED_POLAR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led_g_mode</span> <span class="o">!=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_G_LED_MODE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">led_r_mode</span> <span class="o">!=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_R_LED_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_FREQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">led_ctrl</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_FREQ_LED_MODE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">led_ctrl</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">led_ctrl</span> <span class="o">&gt;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_G_LED_MODE</span><span class="p">,</span> <span class="n">led_g_mode</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_R_LED_MODE</span><span class="p">,</span> <span class="n">led_r_mode</span><span class="p">);</span>
			<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LED_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rt2800_mcu_request</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MCU_BAND_SELECT</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">led_g_mode</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">led_r_mode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_set_ant_diversity</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">antenna</span> <span class="n">ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">eesk_pin</span> <span class="o">=</span> <span class="p">(</span><span class="n">ant</span> <span class="o">==</span> <span class="n">ANTENNA_A</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gpio_bit3</span> <span class="o">=</span> <span class="p">(</span><span class="n">ant</span> <span class="o">==</span> <span class="n">ANTENNA_A</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_pci</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">E2PROM_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">E2PROM_CSR_DATA_CLOCK</span><span class="p">,</span> <span class="n">eesk_pin</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">E2PROM_CSR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_usb</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span>
		<span class="n">rt2800_mcu_request</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MCU_ANT_SELECT</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
				   <span class="n">eesk_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_GPIOD_BIT3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_BIT3</span><span class="p">,</span> <span class="n">gpio_bit3</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2800_config_ant</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">antenna_setup</span> <span class="o">*</span><span class="n">ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">r1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">r3</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>

	<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1</span><span class="p">);</span>
	<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_BT_COEXIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="n">rt2800_config_3572bt_ant</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure the TX antenna.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">tx_chain_num</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1</span><span class="p">,</span> <span class="n">BBP1_TX_ANTENNA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_BT_COEXIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1</span><span class="p">,</span> <span class="n">BBP1_TX_ANTENNA</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1</span><span class="p">,</span> <span class="n">BBP1_TX_ANTENNA</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1</span><span class="p">,</span> <span class="n">BBP1_TX_ANTENNA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure the RX antenna.</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">rx_chain_num</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span>
					   <span class="n">EEPROM_NIC_CONF1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
						<span class="n">EEPROM_NIC_CONF1_ANT_DIVERSITY</span><span class="p">))</span>
				<span class="n">rt2800_set_ant_diversity</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span>
						<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r3</span><span class="p">,</span> <span class="n">BBP3_RX_ANTENNA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_BT_COEXIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r3</span><span class="p">,</span> <span class="n">BBP3_RX_ADC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r3</span><span class="p">,</span> <span class="n">BBP3_RX_ANTENNA</span><span class="p">,</span>
				<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">curr_band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">);</span>
			<span class="n">rt2800_set_ant_diversity</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">ANTENNA_B</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r3</span><span class="p">,</span> <span class="n">BBP3_RX_ANTENNA</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r3</span><span class="p">,</span> <span class="n">BBP3_RX_ANTENNA</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">r3</span><span class="p">);</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">r1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_config_ant</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_lna_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">rt2x00lib_conf</span> <span class="o">*</span><span class="n">libconf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">lna_gain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">libconf</span><span class="o">-&gt;</span><span class="n">rf</span><span class="p">.</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_LNA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">lna_gain</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_LNA_BG</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">libconf</span><span class="o">-&gt;</span><span class="n">rf</span><span class="p">.</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_LNA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">lna_gain</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_LNA_A0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">libconf</span><span class="o">-&gt;</span><span class="n">rf</span><span class="p">.</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">lna_gain</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG2_LNA_A1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">lna_gain</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A2_LNA_A2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">lna_gain</span> <span class="o">=</span> <span class="n">lna_gain</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_channel_rf2xxx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">rf_channel</span> <span class="o">*</span><span class="n">rf</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">channel_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf4</span><span class="p">,</span> <span class="n">RF4_FREQ_OFFSET</span><span class="p">,</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">freq_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx_chain_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf2</span><span class="p">,</span> <span class="n">RF2_ANTENNA_TX1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx_chain_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf2</span><span class="p">,</span> <span class="n">RF2_ANTENNA_RX1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf2</span><span class="p">,</span> <span class="n">RF2_ANTENNA_RX2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx_chain_num</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf2</span><span class="p">,</span> <span class="n">RF2_ANTENNA_RX2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * When TX power is below 0, we should increase it by 7 to</span>
<span class="cm">		 * make it a positive value (Minimum value is -7).</span>
<span class="cm">		 * However this means that values between 0 and 7 have</span>
<span class="cm">		 * double meaning, and we should set a 7DBm boost flag.</span>
<span class="cm">		 */</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf3</span><span class="p">,</span> <span class="n">RF3_TXPOWER_A_7DBM_BOOST</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>

		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf3</span><span class="p">,</span> <span class="n">RF3_TXPOWER_A</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span><span class="p">);</span>

		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf4</span><span class="p">,</span> <span class="n">RF4_TXPOWER_A_7DBM_BOOST</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>

		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf4</span><span class="p">,</span> <span class="n">RF4_TXPOWER_A</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf3</span><span class="p">,</span> <span class="n">RF3_TXPOWER_G</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf4</span><span class="p">,</span> <span class="n">RF4_TXPOWER_G</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf4</span><span class="p">,</span> <span class="n">RF4_HT40</span><span class="p">,</span> <span class="n">conf_is_ht40</span><span class="p">(</span><span class="n">conf</span><span class="p">));</span>

	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf1</span><span class="p">);</span>
	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf2</span><span class="p">);</span>
	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00000004</span><span class="p">);</span>
	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf4</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf1</span><span class="p">);</span>
	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf2</span><span class="p">);</span>
	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf3</span> <span class="o">|</span> <span class="mh">0x00000004</span><span class="p">);</span>
	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf4</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>

	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf1</span><span class="p">);</span>
	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf2</span><span class="p">);</span>
	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x00000004</span><span class="p">);</span>
	<span class="n">rt2800_rf_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_channel_rf3xxx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">rf_channel</span> <span class="o">*</span><span class="n">rf</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">channel_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2800_drv_data</span> <span class="o">*</span><span class="n">drv_data</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">drv_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rfcsr</span><span class="p">,</span> <span class="n">calib_tx</span><span class="p">,</span> <span class="n">calib_rx</span><span class="p">;</span>

	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf1</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR3_K</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf3</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR6_R1</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf2</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR12_TX_POWER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR13_TX_POWER</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX0_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX0_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX1_PD</span><span class="p">,</span>
				  <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx_chain_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX1_PD</span><span class="p">,</span>
				  <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx_chain_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX1_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX1_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX2_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX2_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx_chain_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX1_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX2_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx_chain_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX1_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX2_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR30_RF_CALIBRATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR30_RF_CALIBRATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR23_FREQ_OFFSET</span><span class="p">,</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">freq_offset</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">calib_tx</span> <span class="o">=</span> <span class="n">conf_is_ht40</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x68</span> <span class="o">:</span> <span class="mh">0x4f</span><span class="p">;</span>
		<span class="n">calib_rx</span> <span class="o">=</span> <span class="n">conf_is_ht40</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x6f</span> <span class="o">:</span> <span class="mh">0x4f</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht40</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">calib_tx</span> <span class="o">=</span> <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw40</span><span class="p">;</span>
			<span class="n">calib_rx</span> <span class="o">=</span> <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw40</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">calib_tx</span> <span class="o">=</span> <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw20</span><span class="p">;</span>
			<span class="n">calib_rx</span> <span class="o">=</span> <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw20</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR24_TX_CALIB</span><span class="p">,</span> <span class="n">calib_tx</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR31_RX_CALIB</span><span class="p">,</span> <span class="n">calib_rx</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR7_RF_TUNING</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR30_RF_CALIBRATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR30_RF_CALIBRATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_channel_rf3052</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">rf_channel</span> <span class="o">*</span><span class="n">rf</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">channel_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2800_drv_data</span> <span class="o">*</span><span class="n">drv_data</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">drv_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rfcsr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">bbp25</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">bbp26</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf3</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR6_R1</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR6_TXDIV</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR6_TXDIV</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR5_R1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR5_R1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR12_DR0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR12_TX_POWER</span><span class="p">,</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR12_DR0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR12_TX_POWER</span><span class="p">,</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span> <span class="o">&amp;</span> <span class="mh">0xC</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR13_DR0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR13_TX_POWER</span><span class="p">,</span>
				  <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR13_DR0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR13_TX_POWER</span><span class="p">,</span>
				<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span> <span class="o">&amp;</span> <span class="mh">0xC</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX0_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX0_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX1_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX1_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX2_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX2_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_BT_COEXIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX0_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX0_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX2_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX2_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx_chain_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX1_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX2_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx_chain_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX1_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX2_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR23_FREQ_OFFSET</span><span class="p">,</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">freq_offset</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht40</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw40</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw40</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw20</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">);</span>
		<span class="n">rfcsr</span> <span class="o">=</span> <span class="mh">0x4c</span><span class="p">;</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR16_TXMIXER_GAIN</span><span class="p">,</span>
				  <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">txmixer_gain_24g</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR7_BIT2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR7_BIT3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR7_BIT4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR7_BITS67</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
		<span class="n">rfcsr</span> <span class="o">=</span> <span class="mh">0x7a</span><span class="p">;</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR16_TXMIXER_GAIN</span><span class="p">,</span>
				  <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">txmixer_gain_5g</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mh">0xb7</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mh">0x74</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0xf4</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_GPIOD_BIT7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_BIT7</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_BIT7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR7_RF_TUNING</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define RT5390_POWER_BOUND     0x27</span>
<span class="cp">#define RT5390_FREQ_OFFSET_BOUND       0x5f</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_channel_rf53xx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">rf_channel</span> <span class="o">*</span><span class="n">rf</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">channel_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rfcsr</span><span class="p">;</span>

	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf3</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR11_R</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">rf2</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span> <span class="o">&gt;</span> <span class="n">RT5390_POWER_BOUND</span><span class="p">)</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR49_TX</span><span class="p">,</span> <span class="n">RT5390_POWER_BOUND</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR49_TX</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RF_BLOCK_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_PLL_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX0_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX0_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">freq_offset</span> <span class="o">&gt;</span> <span class="n">RT5390_FREQ_OFFSET_BOUND</span><span class="p">)</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR17_CODE</span><span class="p">,</span>
				  <span class="n">RT5390_FREQ_OFFSET_BOUND</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR17_CODE</span><span class="p">,</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">freq_offset</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_BT_COEXIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">,</span> <span class="n">REV_RT5390F</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* r55/r59 value array of channel 1~14 */</span>
				<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">r55_bt_rev</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span>
					<span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span>
					<span class="mh">0x53</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">};</span>
				<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">r59_bt_rev</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span>
					<span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span>
					<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">};</span>

				<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span>
						   <span class="n">r55_bt_rev</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span>
						   <span class="n">r59_bt_rev</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">r59_bt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span>
					<span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span>
					<span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">};</span>

				<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="n">r59_bt</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">,</span> <span class="n">REV_RT5390F</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">r55_nonbt_rev</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span>
					<span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
					<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">};</span>
				<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">r59_nonbt_rev</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
					<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
					<span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">};</span>

				<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span>
						   <span class="n">r55_nonbt_rev</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
				<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span>
						   <span class="n">r59_nonbt_rev</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
					   <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">r59_non_bt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span>
					<span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">,</span>
					<span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">};</span>

				<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span>
						   <span class="n">r59_non_bt</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR30_TX_H20M</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR30_RX_H20M</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR30_RF_CALIBRATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">rf_channel</span> <span class="o">*</span><span class="n">rf</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">channel_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_pin</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bbp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span> <span class="o">=</span> <span class="n">TXPOWER_G_TO_DEV</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span> <span class="o">=</span> <span class="n">TXPOWER_G_TO_DEV</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span> <span class="o">=</span> <span class="n">TXPOWER_A_TO_DEV</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power1</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span> <span class="o">=</span> <span class="n">TXPOWER_A_TO_DEV</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_power2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">rf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RF2020</span>:
	<span class="k">case</span> <span class="n">RF3020</span>:
	<span class="k">case</span> <span class="n">RF3021</span>:
	<span class="k">case</span> <span class="n">RF3022</span>:
	<span class="k">case</span> <span class="n">RF3320</span>:
		<span class="n">rt2800_config_channel_rf3xxx</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RF3052</span>:
		<span class="n">rt2800_config_channel_rf3052</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RF5370</span>:
	<span class="k">case</span> <span class="n">RF5372</span>:
	<span class="k">case</span> <span class="n">RF5390</span>:
		<span class="n">rt2800_config_channel_rf53xx</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rt2800_config_channel_rf2xxx</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Change BBP settings</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mh">0x37</span> <span class="o">-</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">lna_gain</span><span class="p">);</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mh">0x37</span> <span class="o">-</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">lna_gain</span><span class="p">);</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mh">0x37</span> <span class="o">-</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">lna_gain</span><span class="p">);</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_EXTERNAL_LNA_BG</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">);</span>
				<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">);</span>
				<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">))</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_EXTERNAL_LNA_A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_BAND_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_BAND_CFG_HT40_MINUS</span><span class="p">,</span> <span class="n">conf_is_ht40_minus</span><span class="p">(</span><span class="n">conf</span><span class="p">));</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_BAND_CFG_A</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_BAND_CFG_BG</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_BAND_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">))</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">tx_pin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Turn on unused PA or LNA when not using 1T or 1R */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx_chain_num</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_PA_PE_A1_EN</span><span class="p">,</span>
				   <span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_PA_PE_G1_EN</span><span class="p">,</span>
				   <span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Turn on unused PA or LNA when not using 1T or 1R */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx_chain_num</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_LNA_PE_A1_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_LNA_PE_G1_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_LNA_PE_A0_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_LNA_PE_G0_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_RFTR_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_TRSW_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_BT_COEXIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_PA_PE_G0_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_PA_PE_G0_EN</span><span class="p">,</span>
				   <span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_PA_PE_A0_EN</span><span class="p">,</span> <span class="n">rf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">);</span>

	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_PIN_CFG</span><span class="p">,</span> <span class="n">tx_pin</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">))</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bbp</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbp</span><span class="p">,</span> <span class="n">BBP4_BANDWIDTH</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">conf_is_ht40</span><span class="p">(</span><span class="n">conf</span><span class="p">));</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bbp</span><span class="p">);</span>

	<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bbp</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbp</span><span class="p">,</span> <span class="n">BBP3_HT40_MINUS</span><span class="p">,</span> <span class="n">conf_is_ht40_minus</span><span class="p">(</span><span class="n">conf</span><span class="p">));</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">bbp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT2860</span><span class="p">,</span> <span class="n">REV_RT2860C</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht40</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">);</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear channel statistic counters</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CH_IDLE_STA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CH_BUSY_STA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CH_BUSY_STA_SEC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2800_get_gain_calibration_delta</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">current_tssi</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">step</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read TSSI boundaries for temperature compensation from</span>
<span class="cm">	 * the EEPROM.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Array idx               0    1    2    3    4    5    6    7    8</span>
<span class="cm">	 * Matching Delta value   -4   -3   -2   -1    0   +1   +2   +3   +4</span>
<span class="cm">	 * Example TSSI bounds  0xF0 0xD0 0xB5 0xA0 0x88 0x45 0x25 0x15 0x00</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">curr_band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TSSI_BOUND_BG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_BG1_MINUS4</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_BG1_MINUS3</span><span class="p">);</span>

		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TSSI_BOUND_BG2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_BG2_MINUS2</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_BG2_MINUS1</span><span class="p">);</span>

		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TSSI_BOUND_BG3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_BG3_REF</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_BG3_PLUS1</span><span class="p">);</span>

		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TSSI_BOUND_BG4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_BG4_PLUS2</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_BG4_PLUS3</span><span class="p">);</span>

		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TSSI_BOUND_BG5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_BG5_PLUS4</span><span class="p">);</span>

		<span class="n">step</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					  <span class="n">EEPROM_TSSI_BOUND_BG5_AGC_STEP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TSSI_BOUND_A1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_A1_MINUS4</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_A1_MINUS3</span><span class="p">);</span>

		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TSSI_BOUND_A2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_A2_MINUS2</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_A2_MINUS1</span><span class="p">);</span>

		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TSSI_BOUND_A3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_A3_REF</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_A3_PLUS1</span><span class="p">);</span>

		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TSSI_BOUND_A4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_A4_PLUS2</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_A4_PLUS3</span><span class="p">);</span>

		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TSSI_BOUND_A5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					<span class="n">EEPROM_TSSI_BOUND_A5_PLUS4</span><span class="p">);</span>

		<span class="n">step</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					  <span class="n">EEPROM_TSSI_BOUND_A5_AGC_STEP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if temperature compensation is supported.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tssi_bounds</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read current TSSI (BBP 49).</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">current_tssi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compare TSSI value (BBP49) with the compensation boundaries</span>
<span class="cm">	 * from the EEPROM and increase or decrease tx power.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_tssi</span> <span class="o">&gt;</span> <span class="n">tssi_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">current_tssi</span> <span class="o">&lt;</span> <span class="n">tssi_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">step</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2800_get_txpower_bw_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">comp_en</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">comp_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">comp_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TXPOWER_DELTA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * HT40 compensation not required.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONFIG_CHANNEL_HT40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">comp_en</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
				 <span class="n">EEPROM_TXPOWER_DELTA_ENABLE_2G</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comp_en</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comp_type</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					   <span class="n">EEPROM_TXPOWER_DELTA_TYPE_2G</span><span class="p">);</span>
			<span class="n">comp_value</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					    <span class="n">EEPROM_TXPOWER_DELTA_VALUE_2G</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">comp_type</span><span class="p">)</span>
				<span class="n">comp_value</span> <span class="o">=</span> <span class="o">-</span><span class="n">comp_value</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">comp_en</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
				 <span class="n">EEPROM_TXPOWER_DELTA_ENABLE_5G</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comp_en</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">comp_type</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					   <span class="n">EEPROM_TXPOWER_DELTA_TYPE_5G</span><span class="p">);</span>
			<span class="n">comp_value</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					    <span class="n">EEPROM_TXPOWER_DELTA_VALUE_5G</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">comp_type</span><span class="p">)</span>
				<span class="n">comp_value</span> <span class="o">=</span> <span class="o">-</span><span class="n">comp_value</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">comp_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">rt2800_compensate_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_rate_b</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span> <span class="kt">int</span> <span class="n">power_level</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">txpower</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">criterion</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">eirp_txpower</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">eirp_txpower_criterion</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_rate_b</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">txpower</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_POWER_LIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check if eirp txpower exceed txpower_limit.</span>
<span class="cm">		 * We use OFDM 6M as criterion and its eirp txpower</span>
<span class="cm">		 * is stored at EEPROM_EIRP_MAX_TX_POWER.</span>
<span class="cm">		 * .11b data rate need add additional 4dbm</span>
<span class="cm">		 * when calculating eirp txpower.</span>
<span class="cm">		 */</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_PWR_CFG_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">criterion</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_PWR_CFG_0_6MBS</span><span class="p">);</span>

		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span>
				   <span class="n">EEPROM_EIRP_MAX_TX_POWER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
			<span class="n">eirp_txpower_criterion</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
						 <span class="n">EEPROM_EIRP_MAX_TX_POWER_2GHZ</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">eirp_txpower_criterion</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
						 <span class="n">EEPROM_EIRP_MAX_TX_POWER_5GHZ</span><span class="p">);</span>

		<span class="n">eirp_txpower</span> <span class="o">=</span> <span class="n">eirp_txpower_criterion</span> <span class="o">+</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">-</span> <span class="n">criterion</span><span class="p">)</span> <span class="o">+</span>
			       <span class="p">(</span><span class="n">is_rate_b</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta</span><span class="p">;</span>

		<span class="n">reg_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">eirp_txpower</span> <span class="o">&gt;</span> <span class="n">power_level</span><span class="p">)</span> <span class="o">?</span>
					<span class="p">(</span><span class="n">eirp_txpower</span> <span class="o">-</span> <span class="n">power_level</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">reg_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">txpower</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">-</span> <span class="n">reg_limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">power_level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">txpower</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">is_rate_b</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">r1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate HT40 compensation delta</span>
<span class="cm">	 */</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="n">rt2800_get_txpower_bw_comp</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * calculate temperature compensation delta</span>
<span class="cm">	 */</span>
	<span class="n">delta</span> <span class="o">+=</span> <span class="n">rt2800_get_gain_calibration_delta</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set to normal bbp tx power control mode: +/- 0dBm</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r1</span><span class="p">,</span> <span class="n">BBP1_TX_POWER_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">r1</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">TX_PWR_CFG_0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EEPROM_TXPOWER_BYRATE_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* just to be safe */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">TX_PWR_CFG_4</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* read the next four txpower values */</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TXPOWER_BYRATE</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>

		<span class="n">is_rate_b</span> <span class="o">=</span> <span class="n">i</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * TX_PWR_CFG_0: 1MBS, TX_PWR_CFG_1: 24MBS,</span>
<span class="cm">		 * TX_PWR_CFG_2: MCS4, TX_PWR_CFG_3: MCS12,</span>
<span class="cm">		 * TX_PWR_CFG_4: unknown</span>
<span class="cm">		 */</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					     <span class="n">EEPROM_TXPOWER_BYRATE_RATE0</span><span class="p">);</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2800_compensate_txpower</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">is_rate_b</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
					     <span class="n">power_level</span><span class="p">,</span> <span class="n">txpower</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_PWR_CFG_RATE0</span><span class="p">,</span> <span class="n">txpower</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * TX_PWR_CFG_0: 2MBS, TX_PWR_CFG_1: 36MBS,</span>
<span class="cm">		 * TX_PWR_CFG_2: MCS5, TX_PWR_CFG_3: MCS13,</span>
<span class="cm">		 * TX_PWR_CFG_4: unknown</span>
<span class="cm">		 */</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					     <span class="n">EEPROM_TXPOWER_BYRATE_RATE1</span><span class="p">);</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2800_compensate_txpower</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">is_rate_b</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
					     <span class="n">power_level</span><span class="p">,</span> <span class="n">txpower</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_PWR_CFG_RATE1</span><span class="p">,</span> <span class="n">txpower</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * TX_PWR_CFG_0: 5.5MBS, TX_PWR_CFG_1: 48MBS,</span>
<span class="cm">		 * TX_PWR_CFG_2: MCS6,  TX_PWR_CFG_3: MCS14,</span>
<span class="cm">		 * TX_PWR_CFG_4: unknown</span>
<span class="cm">		 */</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					     <span class="n">EEPROM_TXPOWER_BYRATE_RATE2</span><span class="p">);</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2800_compensate_txpower</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">is_rate_b</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
					     <span class="n">power_level</span><span class="p">,</span> <span class="n">txpower</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_PWR_CFG_RATE2</span><span class="p">,</span> <span class="n">txpower</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * TX_PWR_CFG_0: 11MBS, TX_PWR_CFG_1: 54MBS,</span>
<span class="cm">		 * TX_PWR_CFG_2: MCS7,  TX_PWR_CFG_3: MCS15,</span>
<span class="cm">		 * TX_PWR_CFG_4: unknown</span>
<span class="cm">		 */</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					     <span class="n">EEPROM_TXPOWER_BYRATE_RATE3</span><span class="p">);</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2800_compensate_txpower</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">is_rate_b</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
					     <span class="n">power_level</span><span class="p">,</span> <span class="n">txpower</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_PWR_CFG_RATE3</span><span class="p">,</span> <span class="n">txpower</span><span class="p">);</span>

		<span class="cm">/* read the next four txpower values */</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TXPOWER_BYRATE</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>

		<span class="n">is_rate_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * TX_PWR_CFG_0: 6MBS, TX_PWR_CFG_1: MCS0,</span>
<span class="cm">		 * TX_PWR_CFG_2: MCS8, TX_PWR_CFG_3: unknown,</span>
<span class="cm">		 * TX_PWR_CFG_4: unknown</span>
<span class="cm">		 */</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					     <span class="n">EEPROM_TXPOWER_BYRATE_RATE0</span><span class="p">);</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2800_compensate_txpower</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">is_rate_b</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
					     <span class="n">power_level</span><span class="p">,</span> <span class="n">txpower</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_PWR_CFG_RATE4</span><span class="p">,</span> <span class="n">txpower</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * TX_PWR_CFG_0: 9MBS, TX_PWR_CFG_1: MCS1,</span>
<span class="cm">		 * TX_PWR_CFG_2: MCS9, TX_PWR_CFG_3: unknown,</span>
<span class="cm">		 * TX_PWR_CFG_4: unknown</span>
<span class="cm">		 */</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					     <span class="n">EEPROM_TXPOWER_BYRATE_RATE1</span><span class="p">);</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2800_compensate_txpower</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">is_rate_b</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
					     <span class="n">power_level</span><span class="p">,</span> <span class="n">txpower</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_PWR_CFG_RATE5</span><span class="p">,</span> <span class="n">txpower</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * TX_PWR_CFG_0: 12MBS, TX_PWR_CFG_1: MCS2,</span>
<span class="cm">		 * TX_PWR_CFG_2: MCS10, TX_PWR_CFG_3: unknown,</span>
<span class="cm">		 * TX_PWR_CFG_4: unknown</span>
<span class="cm">		 */</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					     <span class="n">EEPROM_TXPOWER_BYRATE_RATE2</span><span class="p">);</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2800_compensate_txpower</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">is_rate_b</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
					     <span class="n">power_level</span><span class="p">,</span> <span class="n">txpower</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_PWR_CFG_RATE6</span><span class="p">,</span> <span class="n">txpower</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * TX_PWR_CFG_0: 18MBS, TX_PWR_CFG_1: MCS3,</span>
<span class="cm">		 * TX_PWR_CFG_2: MCS11, TX_PWR_CFG_3: unknown,</span>
<span class="cm">		 * TX_PWR_CFG_4: unknown</span>
<span class="cm">		 */</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					     <span class="n">EEPROM_TXPOWER_BYRATE_RATE3</span><span class="p">);</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">rt2800_compensate_txpower</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">is_rate_b</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
					     <span class="n">power_level</span><span class="p">,</span> <span class="n">txpower</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_PWR_CFG_RATE7</span><span class="p">,</span> <span class="n">txpower</span><span class="p">);</span>

		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="cm">/* next TX_PWR_CFG register */</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2800_gain_calibration</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rt2800_config_txpower</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">curr_band</span><span class="p">,</span>
			      <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">tx_power</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_gain_calibration</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2800_vco_calibration</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>	<span class="n">tx_pin</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">rfcsr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * A voltage-controlled oscillator(VCO) is an electronic oscillator</span>
<span class="cm">	 * designed to be controlled in oscillation frequency by a voltage</span>
<span class="cm">	 * input. Maybe the temperature will affect the frequency of</span>
<span class="cm">	 * oscillation to be shifted. The VCO calibration will be called</span>
<span class="cm">	 * periodically to adjust the frequency to be precision.</span>
<span class="cm">	*/</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_PIN_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">);</span>
	<span class="n">tx_pin</span> <span class="o">&amp;=</span> <span class="n">TX_PIN_CFG_PA_PE_DISABLE</span><span class="p">;</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_PIN_CFG</span><span class="p">,</span> <span class="n">tx_pin</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">rf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RF2020</span>:
	<span class="k">case</span> <span class="n">RF3020</span>:
	<span class="k">case</span> <span class="n">RF3021</span>:
	<span class="k">case</span> <span class="n">RF3022</span>:
	<span class="k">case</span> <span class="n">RF3320</span>:
	<span class="k">case</span> <span class="n">RF3052</span>:
		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR7_RF_TUNING</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RF5370</span>:
	<span class="k">case</span> <span class="n">RF5372</span>:
	<span class="k">case</span> <span class="n">RF5390</span>:
		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR30_RF_CALIBRATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_PIN_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">rf_channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx_chain_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_PA_PE_G2_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_PA_PE_G1_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="nl">default:</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_PA_PE_G0_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx_chain_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_PA_PE_A2_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_PA_PE_A1_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="nl">default:</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pin</span><span class="p">,</span> <span class="n">TX_PIN_CFG_PA_PE_A0_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_PIN_CFG</span><span class="p">,</span> <span class="n">tx_pin</span><span class="p">);</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_vco_calibration</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_retry_limit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">rt2x00lib_conf</span> <span class="o">*</span><span class="n">libconf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_RTY_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTY_CFG_SHORT_RTY_LIMIT</span><span class="p">,</span>
			   <span class="n">libconf</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">short_frame_max_tx_count</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTY_CFG_LONG_RTY_LIMIT</span><span class="p">,</span>
			   <span class="n">libconf</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">long_frame_max_tx_count</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_RTY_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_config_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">rt2x00lib_conf</span> <span class="o">*</span><span class="n">libconf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">dev_state</span> <span class="n">state</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">libconf</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">STATE_SLEEP</span> <span class="o">:</span> <span class="n">STATE_AWAKE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">STATE_SLEEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG_AUTO_LEAD_TIME</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG_TBCN_BEFORE_WAKE</span><span class="p">,</span>
				   <span class="n">libconf</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG_AUTOWAKE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">set_device_state</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG_AUTO_LEAD_TIME</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG_TBCN_BEFORE_WAKE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG_AUTOWAKE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUTOWAKEUP_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">set_device_state</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2800_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">rt2x00lib_conf</span> <span class="o">*</span><span class="n">libconf</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Always recalculate LNA gain before changing configuration */</span>
	<span class="n">rt2800_config_lna_gain</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">libconf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_config_channel</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">libconf</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">libconf</span><span class="o">-&gt;</span><span class="n">rf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">libconf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">rt2800_config_txpower</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">libconf</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span>
				      <span class="n">libconf</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_POWER</span><span class="p">)</span>
		<span class="n">rt2800_config_txpower</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">libconf</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span>
				      <span class="n">libconf</span><span class="o">-&gt;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_RETRY_LIMITS</span><span class="p">)</span>
		<span class="n">rt2800_config_retry_limit</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">libconf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_PS</span><span class="p">)</span>
		<span class="n">rt2800_config_ps</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">libconf</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_config</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Link tuning</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rt2800_link_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_qual</span> <span class="o">*</span><span class="n">qual</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update FCS error count from register.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RX_STA_CNT0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">rx_failed</span> <span class="o">=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">RX_STA_CNT0_CRC_ERR</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_link_stats</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">rt2800_get_default_vgc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">curr_band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
			<span class="k">return</span> <span class="mh">0x1c</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">lna_gain</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mh">0x2e</span> <span class="o">+</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">lna_gain</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONFIG_CHANNEL_HT40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mh">0x32</span> <span class="o">+</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">lna_gain</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mh">0x3a</span> <span class="o">+</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">lna_gain</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rt2800_set_vgc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">link_qual</span> <span class="o">*</span><span class="n">qual</span><span class="p">,</span> <span class="n">u8</span> <span class="n">vgc_level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qual</span><span class="o">-&gt;</span><span class="n">vgc_level</span> <span class="o">!=</span> <span class="n">vgc_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="n">vgc_level</span><span class="p">);</span>
		<span class="n">qual</span><span class="o">-&gt;</span><span class="n">vgc_level</span> <span class="o">=</span> <span class="n">vgc_level</span><span class="p">;</span>
		<span class="n">qual</span><span class="o">-&gt;</span><span class="n">vgc_level_reg</span> <span class="o">=</span> <span class="n">vgc_level</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2800_reset_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_qual</span> <span class="o">*</span><span class="n">qual</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rt2800_set_vgc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">qual</span><span class="p">,</span> <span class="n">rt2800_get_default_vgc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_reset_tuner</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2800_link_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">link_qual</span> <span class="o">*</span><span class="n">qual</span><span class="p">,</span>
		       <span class="k">const</span> <span class="n">u32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT2860</span><span class="p">,</span> <span class="n">REV_RT2860C</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * When RSSI is better then -80 increase VGC level with 0x10</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_set_vgc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">qual</span><span class="p">,</span>
		       <span class="n">rt2800_get_default_vgc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)</span> <span class="o">+</span>
		       <span class="p">((</span><span class="n">qual</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">80</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x10</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_link_tuner</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Initialization functions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2800_init_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rt2800_disable_wpdma</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rt2800_drv_init_registers</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_OFFSET0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_OFFSET0_BCN0</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span> <span class="cm">/* 0x3800 */</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_OFFSET0_BCN1</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">);</span> <span class="cm">/* 0x3a00 */</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_OFFSET0_BCN2</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">);</span> <span class="cm">/* 0x3c00 */</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_OFFSET0_BCN3</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">);</span> <span class="cm">/* 0x3e00 */</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_OFFSET0</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_OFFSET1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_OFFSET1_BCN4</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">);</span> <span class="cm">/* 0x3200 */</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_OFFSET1_BCN5</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span> <span class="cm">/* 0x3400 */</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_OFFSET1_BCN6</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">);</span> <span class="cm">/* 0x1dc0 */</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_OFFSET1_BCN7</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">);</span> <span class="cm">/* 0x1bc0 */</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_OFFSET1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LEGACY_BASIC_RATE</span><span class="p">,</span> <span class="mh">0x0000013f</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HT_BASIC_RATE</span><span class="p">,</span> <span class="mh">0x00008003</span><span class="p">);</span>

	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_BEACON_INTERVAL</span><span class="p">,</span> <span class="mi">1600</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_TSF_TICKING</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_TSF_SYNC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_TBTT_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_BEACON_GEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BCN_TIME_CFG_TX_TIME_COMPENSATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BCN_TIME_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_config_filter</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">FIF_ALLMULTI</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BKOFF_SLOT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BKOFF_SLOT_CFG_SLOT_TIME</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">BKOFF_SLOT_CFG_CC_DELAY_TIME</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">BKOFF_SLOT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG0</span><span class="p">,</span> <span class="mh">0x00000400</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">,</span> <span class="n">REV_RT3071E</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">,</span> <span class="n">REV_RT3090E</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">,</span> <span class="n">REV_RT3390E</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_DAC_TEST</span><span class="p">))</span>
				<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG2</span><span class="p">,</span>
						      <span class="mh">0x0000002c</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG2</span><span class="p">,</span>
						      <span class="mh">0x0000000f</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG2</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG0</span><span class="p">,</span> <span class="mh">0x00000400</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">,</span> <span class="n">REV_RT3070F</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG2</span><span class="p">,</span> <span class="mh">0x0000002c</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG1</span><span class="p">,</span> <span class="mh">0x00080606</span><span class="p">);</span>
			<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG2</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2800_is_305x_soc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG0</span><span class="p">,</span> <span class="mh">0x00000400</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG2</span><span class="p">,</span> <span class="mh">0x00000030</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG0</span><span class="p">,</span> <span class="mh">0x00000400</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG1</span><span class="p">,</span> <span class="mh">0x00080606</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG0</span><span class="p">,</span> <span class="mh">0x00000404</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG1</span><span class="p">,</span> <span class="mh">0x00080606</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG2</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG0</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_SW_CFG1</span><span class="p">,</span> <span class="mh">0x00080606</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_LINK_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_LINK_CFG_REMOTE_MFB_LIFETIME</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_LINK_CFG_MFB_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_LINK_CFG_REMOTE_UMFS_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_LINK_CFG_TX_MRQ_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_LINK_CFG_TX_RDG_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_LINK_CFG_TX_CF_ACK_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_LINK_CFG_REMOTE_MFB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_LINK_CFG_REMOTE_MFS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_LINK_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_TIMEOUT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_TIMEOUT_CFG_MPDU_LIFETIME</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_TIMEOUT_CFG_RX_ACK_TIMEOUT</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_TIMEOUT_CFG_TX_OP_TIMEOUT</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_TIMEOUT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAX_LEN_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAX_LEN_CFG_MAX_MPDU</span><span class="p">,</span> <span class="n">AGGREGATION_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT2872</span><span class="p">,</span> <span class="n">REV_RT2872E</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT2883</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">,</span> <span class="n">REV_RT3070E</span><span class="p">))</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAX_LEN_CFG_MAX_PSDU</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAX_LEN_CFG_MAX_PSDU</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAX_LEN_CFG_MIN_PSDU</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAX_LEN_CFG_MIN_MPDU</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAX_LEN_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LED_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_ON_PERIOD</span><span class="p">,</span> <span class="mi">70</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_OFF_PERIOD</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_SLOW_BLINK_PERIOD</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_R_LED_MODE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_G_LED_MODE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_Y_LED_MODE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LED_CFG_LED_POLAR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LED_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">PBF_MAX_PCNT</span><span class="p">,</span> <span class="mh">0x1f3fbf9f</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_RTY_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTY_CFG_SHORT_RTY_LIMIT</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTY_CFG_LONG_RTY_LIMIT</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTY_CFG_LONG_RTY_THRE</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTY_CFG_NON_AGG_RTY_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTY_CFG_AGG_RTY_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTY_CFG_TX_AUTO_FB_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_RTY_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG_AUTORESPONDER</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG_BAC_ACK_POLICY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG_CTS_40_MMODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG_CTS_40_MREF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG_AR_PREAMBLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG_DUAL_CTS_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG_ACK_CTS_PSM_BIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AUTO_RSP_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CCK_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CCK_PROT_CFG_PROTECT_RATE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CCK_PROT_CFG_PROTECT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CCK_PROT_CFG_PROTECT_NAV_SHORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CCK_PROT_CFG_TX_OP_ALLOW_CCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CCK_PROT_CFG_TX_OP_ALLOW_OFDM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CCK_PROT_CFG_TX_OP_ALLOW_MM20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CCK_PROT_CFG_TX_OP_ALLOW_MM40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CCK_PROT_CFG_TX_OP_ALLOW_GF20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CCK_PROT_CFG_TX_OP_ALLOW_GF40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CCK_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CCK_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_PROTECT_RATE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_PROTECT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_PROTECT_NAV_SHORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_TX_OP_ALLOW_CCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_TX_OP_ALLOW_OFDM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_TX_OP_ALLOW_MM20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_TX_OP_ALLOW_MM40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_TX_OP_ALLOW_GF20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_TX_OP_ALLOW_GF40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM20_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_PROTECT_RATE</span><span class="p">,</span> <span class="mh">0x4004</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_PROTECT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_PROTECT_NAV_SHORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_TX_OP_ALLOW_CCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_TX_OP_ALLOW_OFDM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_TX_OP_ALLOW_MM20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_TX_OP_ALLOW_MM40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_TX_OP_ALLOW_GF20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_TX_OP_ALLOW_GF40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM20_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM40_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_PROTECT_RATE</span><span class="p">,</span> <span class="mh">0x4084</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_PROTECT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_PROTECT_NAV_SHORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_TX_OP_ALLOW_CCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_TX_OP_ALLOW_OFDM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_TX_OP_ALLOW_MM20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_TX_OP_ALLOW_MM40</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_TX_OP_ALLOW_GF20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_TX_OP_ALLOW_GF40</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM40_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF20_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_PROTECT_RATE</span><span class="p">,</span> <span class="mh">0x4004</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_PROTECT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_PROTECT_NAV_SHORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_TX_OP_ALLOW_CCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_TX_OP_ALLOW_OFDM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_TX_OP_ALLOW_MM20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_TX_OP_ALLOW_MM40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_TX_OP_ALLOW_GF20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_TX_OP_ALLOW_GF40</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF20_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF40_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_PROTECT_RATE</span><span class="p">,</span> <span class="mh">0x4084</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_PROTECT_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_PROTECT_NAV_SHORT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_TX_OP_ALLOW_CCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_TX_OP_ALLOW_OFDM</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_TX_OP_ALLOW_MM20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_TX_OP_ALLOW_MM40</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_TX_OP_ALLOW_GF20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_TX_OP_ALLOW_GF40</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF40_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_usb</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">PBF_CFG</span><span class="p">,</span> <span class="mh">0xf40006</span><span class="p">);</span>

		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_ENABLE_TX_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_TX_DMA_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_ENABLE_RX_DMA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_RX_DMA_BUSY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_WP_DMA_BURST_SIZE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_TX_WRITEBACK_DONE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_BIG_ENDIAN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_RX_HDR_SCATTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_HDR_SEG_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The legacy driver also sets TXOP_CTRL_CFG_RESERVED_TRUN_EN to 1</span>
<span class="cm">	 * although it is reserved.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG_TIMEOUT_TRUN_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG_AC_TRUN_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG_TXRATEGRP_TRUN_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG_USER_MODE_TRUN_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG_MIMO_PS_TRUN_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG_RESERVED_TRUN_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG_LSIG_TXOP_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG_EXT_CCA_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG_EXT_CCA_DLY</span><span class="p">,</span> <span class="mi">88</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG_EXT_CWMIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TXOP_CTRL_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TXOP_HLDR_ET</span><span class="p">,</span> <span class="mh">0x00000002</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_RTS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTS_CFG_AUTO_RTS_RETRY_LIMIT</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTS_CFG_RTS_THRES</span><span class="p">,</span>
			   <span class="n">IEEE80211_MAX_RTS_THRESHOLD</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTS_CFG_RTS_FBK_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_RTS_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EXP_ACK_TIME</span><span class="p">,</span> <span class="mh">0x002400ca</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Usually the CCK SIFS time should be set to 10 and the OFDM SIFS</span>
<span class="cm">	 * time should be set to 16. However, the original Ralink driver uses</span>
<span class="cm">	 * 16 for both and indeed using a value of 10 for CCK SIFS results in</span>
<span class="cm">	 * connection problems with 11g + CTS protection. Hence, use the same</span>
<span class="cm">	 * defaults as the Ralink driver: 16 for both, CCK and OFDM SIFS.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">XIFS_TIME_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">XIFS_TIME_CFG_CCKM_SIFS_TIME</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">XIFS_TIME_CFG_OFDM_SIFS_TIME</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">XIFS_TIME_CFG_OFDM_XIFS_TIME</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">XIFS_TIME_CFG_EIFS</span><span class="p">,</span> <span class="mi">314</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">XIFS_TIME_CFG_BB_RXEND_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">XIFS_TIME_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">PWR_PIN_CFG</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ASIC will keep garbage value after boot, clear encryption keys.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span>
					 <span class="n">SHARED_KEY_MODE_ENTRY</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_config_wcid</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">rt2800_delete_wcid_attr</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_IVEIV_ENTRY</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear all beacons</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_clear_beacon_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HW_BEACON_BASE0</span><span class="p">);</span>
	<span class="n">rt2800_clear_beacon_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HW_BEACON_BASE1</span><span class="p">);</span>
	<span class="n">rt2800_clear_beacon_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HW_BEACON_BASE2</span><span class="p">);</span>
	<span class="n">rt2800_clear_beacon_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HW_BEACON_BASE3</span><span class="p">);</span>
	<span class="n">rt2800_clear_beacon_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HW_BEACON_BASE4</span><span class="p">);</span>
	<span class="n">rt2800_clear_beacon_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HW_BEACON_BASE5</span><span class="p">);</span>
	<span class="n">rt2800_clear_beacon_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HW_BEACON_BASE6</span><span class="p">);</span>
	<span class="n">rt2800_clear_beacon_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HW_BEACON_BASE7</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_usb</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">US_CYC_CNT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">US_CYC_CNT_CLOCK_CYCLE</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">US_CYC_CNT</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_pcie</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">US_CYC_CNT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">US_CYC_CNT_CLOCK_CYCLE</span><span class="p">,</span> <span class="mi">125</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">US_CYC_CNT</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HT_FBK_CFG0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG0_HTMCS0FBK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG0_HTMCS1FBK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG0_HTMCS2FBK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG0_HTMCS3FBK</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG0_HTMCS4FBK</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG0_HTMCS5FBK</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG0_HTMCS6FBK</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG0_HTMCS7FBK</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HT_FBK_CFG0</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HT_FBK_CFG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG1_HTMCS8FBK</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG1_HTMCS9FBK</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG1_HTMCS10FBK</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG1_HTMCS11FBK</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG1_HTMCS12FBK</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG1_HTMCS13FBK</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG1_HTMCS14FBK</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">HT_FBK_CFG1_HTMCS15FBK</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">HT_FBK_CFG1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LG_FBK_CFG0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_OFDMMCS0FBK</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_OFDMMCS1FBK</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_OFDMMCS2FBK</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_OFDMMCS3FBK</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_OFDMMCS4FBK</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_OFDMMCS5FBK</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_OFDMMCS6FBK</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_OFDMMCS7FBK</span><span class="p">,</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LG_FBK_CFG0</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LG_FBK_CFG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_CCKMCS0FBK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_CCKMCS1FBK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_CCKMCS2FBK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LG_FBK_CFG0_CCKMCS3FBK</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LG_FBK_CFG1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do not force the BA window size, we use the TXWI to set it</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AMPDU_BA_WINSIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AMPDU_BA_WINSIZE_FORCE_WINSIZE_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">AMPDU_BA_WINSIZE_FORCE_WINSIZE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">AMPDU_BA_WINSIZE</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must clear the error counters.</span>
<span class="cm">	 * These registers are cleared on read,</span>
<span class="cm">	 * so we may pass a useless variable to store the value.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RX_STA_CNT0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RX_STA_CNT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RX_STA_CNT2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_STA_CNT0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_STA_CNT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_STA_CNT2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup leadtime for pre tbtt interrupt to 6ms</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">INT_TIMER_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">INT_TIMER_CFG_PRE_TBTT_TIMER</span><span class="p">,</span> <span class="mi">6</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">INT_TIMER_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up channel statistics timer</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CH_TIME_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CH_TIME_CFG_EIFS_BUSY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CH_TIME_CFG_NAV_BUSY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CH_TIME_CFG_RX_BUSY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CH_TIME_CFG_TX_BUSY</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CH_TIME_CFG_TMR_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CH_TIME_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2800_wait_bbp_rf_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REGISTER_BUSY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_STATUS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_STATUS_CFG_BBP_RF_BUSY</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="n">REGISTER_BUSY_DELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;BBP/RF register access failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2800_wait_bbp_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * BBP was enabled after firmware was loaded,</span>
<span class="cm">	 * but we need to reactivate it now.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">H2M_BBP_AGENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">H2M_MAILBOX_CSR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">REGISTER_BUSY_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">REGISTER_BUSY_DELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;BBP register access failed, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2800_init_bbp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rt2800_wait_bbp_rf_ready</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">rt2800_wait_bbp_ready</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">BBP4_MAC_IF_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2800_is_305x_soc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>

	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">);</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT2860</span><span class="p">,</span> <span class="n">REV_RT2860C</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
			   <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mh">0x59</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2800_is_305x_soc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT2860</span><span class="p">,</span> <span class="n">REV_RT2860D</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
			 <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>

	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">,</span> <span class="n">REV_RT3070F</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">,</span> <span class="n">REV_RT3071E</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">,</span> <span class="n">REV_RT3090E</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">,</span> <span class="n">REV_RT3390E</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2800_is_305x_soc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2800_is_305x_soc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
			 <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>

		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_TXPATH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_RXPATH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x02</span><span class="p">;</span>

		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ant</span><span class="p">,</span> <span class="n">div_mode</span><span class="p">;</span>

		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="n">div_mode</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
					      <span class="n">EEPROM_NIC_CONF1_ANT_DIVERSITY</span><span class="p">);</span>
		<span class="n">ant</span> <span class="o">=</span> <span class="p">(</span><span class="n">div_mode</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* check if this is a Bluetooth combo card */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_BT_COEXIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

			<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_GPIOD_BIT3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_GPIOD_BIT6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_BIT3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_BIT6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ant</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_BIT3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ant</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG_BIT6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_CTRL_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* This chip has hardware antenna diversity*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">,</span> <span class="n">REV_RT5390R</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Disable Antenna Software OFDM */</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Disable Antenna Software CCK */</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Clear previously selected antenna */</span>
		<span class="p">}</span>

		<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ant</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">BBP152_RX_DEFAULT_ANT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">BBP152_RX_DEFAULT_ANT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="cm">/* Init frequency calibration */</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">57</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EEPROM_BBP_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_BBP_START</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span> <span class="o">!=</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="n">eeprom</span> <span class="o">!=</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_id</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_BBP_REG_ID</span><span class="p">);</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_BBP_VALUE</span><span class="p">);</span>
			<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">reg_id</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">rt2800_init_rx_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">bw40</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rfcsr24</span><span class="p">,</span> <span class="n">u8</span> <span class="n">filter_target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bbp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rfcsr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">passband</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stopband</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">overtuned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">rfcsr24</span><span class="p">);</span>

	<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bbp</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbp</span><span class="p">,</span> <span class="n">BBP4_BANDWIDTH</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">bw40</span><span class="p">);</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bbp</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR31_RX_H20M</span><span class="p">,</span> <span class="n">bw40</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
	<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR22_BASEBAND_LOOPBACK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set power &amp; frequency of passband test tone</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">passband</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">passband</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set power &amp; frequency of stopband test tone</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stopband</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">passband</span> <span class="o">-</span> <span class="n">stopband</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">filter_target</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rfcsr24</span><span class="o">++</span><span class="p">;</span>
			<span class="n">overtuned</span> <span class="o">+=</span> <span class="p">((</span><span class="n">passband</span> <span class="o">-</span> <span class="n">stopband</span><span class="p">)</span> <span class="o">==</span> <span class="n">filter_target</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">rfcsr24</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rfcsr24</span> <span class="o">-=</span> <span class="o">!!</span><span class="n">overtuned</span><span class="p">;</span>

	<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">rfcsr24</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rfcsr24</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2800_init_rfcsr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2800_drv_data</span> <span class="o">*</span><span class="n">drv_data</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">drv_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rfcsr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bbp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rt2800_is_305x_soc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Init RF calibration.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR2_RESCAL_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR2_RESCAL_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR30_RF_CALIBRATION</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR30_RF_CALIBRATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x8b</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mh">0x8f</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0xd8</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0xf1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0xb9</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2800_is_305x_soc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mh">0x75</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0xb3</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0xba</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">,</span> <span class="n">REV_RT5390F</span><span class="p">))</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0xc6</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">,</span> <span class="n">REV_RT5390F</span><span class="p">))</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">,</span> <span class="n">REV_RT5390F</span><span class="p">))</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">,</span> <span class="n">REV_RT5390F</span><span class="p">))</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mh">0x7b</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">);</span>

		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">,</span> <span class="n">REV_RT5390F</span><span class="p">))</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">);</span>

		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">,</span> <span class="n">REV_RT5390F</span><span class="p">))</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mh">0xd1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mh">0xdd</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mh">0x8d</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mh">0xbb</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
			<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">,</span> <span class="n">REV_RT3070F</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LDO_CFG0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LDO_CFG0_BGSEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LDO_CFG0_LDO_CORE_VLEVEL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LDO_CFG0</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>

		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR6_R2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LDO_CFG0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LDO_CFG0_BGSEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">,</span> <span class="n">REV_RT3071E</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">,</span> <span class="n">REV_RT3090E</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_DAC_TEST</span><span class="p">))</span>
				<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LDO_CFG0_LDO_CORE_VLEVEL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LDO_CFG0_LDO_CORE_VLEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LDO_CFG0</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_SWITCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_SWITCH_5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_SWITCH</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_SWITCH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GPIO_SWITCH_5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GPIO_SWITCH</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR6_R2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LDO_CFG0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LDO_CFG0_LDO_CORE_VLEVEL</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LDO_CFG0_BGSEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LDO_CFG0</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LDO_CFG0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">LDO_CFG0_BGSEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">LDO_CFG0</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set RX Filter calibration for 20MHz and 40MHz</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw20</span> <span class="o">=</span>
			<span class="n">rt2800_init_rx_filter</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
		<span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw40</span> <span class="o">=</span>
			<span class="n">rt2800_init_rx_filter</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw20</span> <span class="o">=</span>
			<span class="n">rt2800_init_rx_filter</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">);</span>
		<span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">calibration_bw40</span> <span class="o">=</span>
			<span class="n">rt2800_init_rx_filter</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save BBP 25 &amp; 26 values for later use in channel switching</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">bbp25</span><span class="p">);</span>
	<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">bbp26</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set back to initial state</span>
<span class="cm">		 */</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR22_BASEBAND_LOOPBACK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set BBP back to BW20</span>
<span class="cm">		 */</span>
		<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bbp</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbp</span><span class="p">,</span> <span class="n">BBP4_BANDWIDTH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">bbp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">,</span> <span class="n">REV_RT3070F</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">,</span> <span class="n">REV_RT3071E</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">,</span> <span class="n">REV_RT3090E</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">,</span> <span class="n">REV_RT3390E</span><span class="p">))</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">OPT_14_CSR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OPT_14_CSR_BIT0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">OPT_14_CSR</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR17_TX_LO1_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">,</span> <span class="n">REV_RT3071E</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">,</span> <span class="n">REV_RT3090E</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">,</span> <span class="n">REV_RT3390E</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_EXTERNAL_LNA_BG</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
				<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR17_R</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR17_TXMIXER_GAIN</span><span class="p">,</span>
				  <span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">txmixer_gain_24g</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_bbp_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bbp</span><span class="p">);</span>

		<span class="cm">/*  Turn off unused DAC1 and ADC1 to reduce power consumption */</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_RXPATH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbp</span><span class="p">,</span> <span class="n">BBP138_RX_ADC1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_TXPATH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bbp</span><span class="p">,</span> <span class="n">BBP138_TX_DAC1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">rt2800_bbp_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="n">bbp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RF_BLOCK_EN</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX0_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX0_PD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_RX1_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR1_TX1_PD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR15_TX_LO2_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR20_RX_LO1_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR21_RX_LO2_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_lt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">,</span> <span class="n">REV_RT3070F</span><span class="p">))</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR27_R1</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR27_R1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR27_R2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR27_R3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR27_R4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5392</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR38_RX_LO1_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR39_RX_LO2_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>

		<span class="n">rt2800_rfcsr_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">);</span>
		<span class="n">rt2x00_set_field8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rfcsr</span><span class="p">,</span> <span class="n">RFCSR30_RX_VCM</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">rt2800_rfcsr_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">rfcsr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rt2800_enable_radio</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">word</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize all registers.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rt2800_wait_wpdma_ready</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">rt2800_init_registers</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">rt2800_init_bbp</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">rt2800_init_rfcsr</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send signal to firmware during boot time.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_mcu_request</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MCU_BOOT_SIGNAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_usb</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3071</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3572</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
		<span class="n">rt2800_mcu_request</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MCU_CURRENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable RX.</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL_ENABLE_TX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL_ENABLE_RX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_ENABLE_TX_DMA</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_ENABLE_RX_DMA</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_WP_DMA_BURST_SIZE</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG_TX_WRITEBACK_DONE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WPDMA_GLO_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL_ENABLE_TX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL_ENABLE_RX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize LED control</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_LED_AG_CONF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="n">rt2800_mcu_request</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MCU_LED_AG_CONF</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
			   <span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_LED_ACT_CONF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="n">rt2800_mcu_request</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MCU_LED_ACT_CONF</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
			   <span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_LED_POLARITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="n">rt2800_mcu_request</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MCU_LED_LED_POLARITY</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
			   <span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">word</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_enable_radio</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2800_disable_radio</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">rt2800_disable_wpdma</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/* Wait for DMA, ignore error */</span>
	<span class="n">rt2800_wait_wpdma_ready</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL_ENABLE_TX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL_ENABLE_RX</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_SYS_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_disable_radio</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_efuse_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EFUSE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">EFUSE_CTRL_PRESENT</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_efuse_detect</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2800_efuse_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>

	<span class="n">rt2800_register_read_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EFUSE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">EFUSE_CTRL_ADDRESS_IN</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">EFUSE_CTRL_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">EFUSE_CTRL_KICK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rt2800_register_write_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EFUSE_CTRL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Wait until the EEPROM has been loaded */</span>
	<span class="n">rt2800_regbusy_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EFUSE_CTRL</span><span class="p">,</span> <span class="n">EFUSE_CTRL_KICK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Apparently the data is read from end to start */</span>
	<span class="n">rt2800_register_read_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EFUSE_DATA3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="cm">/* The returned value is in CPU order, but eeprom is le */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2800_register_read_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EFUSE_DATA2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2800_register_read_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EFUSE_DATA1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2800_register_read_lock</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EFUSE_DATA0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2800_read_eeprom_efuse</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EEPROM_SIZE</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">rt2800_efuse_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_read_eeprom_efuse</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_validate_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2800_drv_data</span> <span class="o">*</span><span class="n">drv_data</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">drv_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">word</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">default_lna_gain</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start validation of the data that has been read.</span>
<span class="cm">	 */</span>
	<span class="n">mac</span> <span class="o">=</span> <span class="n">rt2x00_eeprom_addr</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_MAC_ADDR_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">random_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
		<span class="n">EEPROM</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;MAC: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_RXPATH</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_TXPATH</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_RF_TYPE</span><span class="p">,</span> <span class="n">RF2820</span><span class="p">);</span>
		<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
		<span class="n">EEPROM</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Antenna: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT2860</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT2872</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * There is a max of 2 RX streams for RT28x0 series</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_RXPATH</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_RXPATH</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_HW_RADIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_EXTERNAL_TX_ALC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_EXTERNAL_LNA_2G</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_EXTERNAL_LNA_5G</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_CARDBUS_ACCEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_BW40M_SB_2G</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_BW40M_SB_5G</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_WPS_PBC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_BW40M_2G</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_BW40M_5G</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_BROADBAND_EXT_LNA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_ANT_DIVERSITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_INTERNAL_TX_ALC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_BT_COEXIST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_DAC_TEST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
		<span class="n">EEPROM</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;NIC: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_FREQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_FREQ_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_FREQ</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
		<span class="n">EEPROM</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Freq: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_FREQ_LED_MODE</span><span class="p">,</span>
				   <span class="n">LED_MODE_TXRX_ACTIVITY</span><span class="p">);</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_FREQ_LED_POLARITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_FREQ</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
		<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_LED_AG_CONF</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">);</span>
		<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_LED_ACT_CONF</span><span class="p">,</span> <span class="mh">0x2221</span><span class="p">);</span>
		<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_LED_POLARITY</span><span class="p">,</span> <span class="mh">0xa9f8</span><span class="p">);</span>
		<span class="n">EEPROM</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Led Mode: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * During the LNA validation we are going to use</span>
<span class="cm">	 * lna0 as correct value. Note that EEPROM_LNA</span>
<span class="cm">	 * is never validated.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_LNA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="n">default_lna_gain</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_LNA_A0</span><span class="p">);</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG_OFFSET0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG_OFFSET0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG_OFFSET1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG_OFFSET1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TXMIXER_GAIN_BG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">txmixer_gain_24g</span> <span class="o">=</span>
			<span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_TXMIXER_GAIN_BG_VAL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">txmixer_gain_24g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG2_OFFSET2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG2_OFFSET2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG2_LNA_A1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">||</span>
	    <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG2_LNA_A1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG2_LNA_A1</span><span class="p">,</span>
				   <span class="n">default_lna_gain</span><span class="p">);</span>
	<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_BG2</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TXMIXER_GAIN_A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">word</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00ff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">txmixer_gain_5g</span> <span class="o">=</span>
			<span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_TXMIXER_GAIN_A_VAL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">drv_data</span><span class="o">-&gt;</span><span class="n">txmixer_gain_5g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A_OFFSET0</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A_OFFSET0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A_OFFSET1</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A_OFFSET1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">word</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A2_OFFSET2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A2_OFFSET2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A2_LNA_A2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">||</span>
	    <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A2_LNA_A2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">rt2x00_set_field16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">word</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A2_LNA_A2</span><span class="p">,</span>
				   <span class="n">default_lna_gain</span><span class="p">);</span>
	<span class="n">rt2x00_eeprom_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_RSSI_A2</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_validate_eeprom</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_init_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read EEPROM word for configuration.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Identify RF chipset by EEPROM value</span>
<span class="cm">	 * RT28xx/RT30xx: defined in &quot;EEPROM_NIC_CONF0_RF_TYPE&quot; field</span>
<span class="cm">	 * RT53xx: defined in &quot;EEPROM_CHIP_ID&quot; field</span>
<span class="cm">	 */</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MAC_CSR0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_CSR0_CHIPSET</span><span class="p">)</span> <span class="o">==</span> <span class="n">RT5390</span> <span class="o">||</span>
		<span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_CSR0_CHIPSET</span><span class="p">)</span> <span class="o">==</span> <span class="n">RT5392</span><span class="p">)</span>
		<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_CHIP_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_RF_TYPE</span><span class="p">);</span>

	<span class="n">rt2x00_set_chip</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_CSR0_CHIPSET</span><span class="p">),</span>
			<span class="n">value</span><span class="p">,</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">MAC_CSR0_REVISION</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">rt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RT2860</span>:
	<span class="k">case</span> <span class="n">RT2872</span>:
	<span class="k">case</span> <span class="n">RT2883</span>:
	<span class="k">case</span> <span class="n">RT3070</span>:
	<span class="k">case</span> <span class="n">RT3071</span>:
	<span class="k">case</span> <span class="n">RT3090</span>:
	<span class="k">case</span> <span class="n">RT3390</span>:
	<span class="k">case</span> <span class="n">RT3572</span>:
	<span class="k">case</span> <span class="n">RT5390</span>:
	<span class="k">case</span> <span class="n">RT5392</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Invalid RT chipset 0x%04x detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">rt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">rf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RF2820</span>:
	<span class="k">case</span> <span class="n">RF2850</span>:
	<span class="k">case</span> <span class="n">RF2720</span>:
	<span class="k">case</span> <span class="n">RF2750</span>:
	<span class="k">case</span> <span class="n">RF3020</span>:
	<span class="k">case</span> <span class="n">RF2020</span>:
	<span class="k">case</span> <span class="n">RF3021</span>:
	<span class="k">case</span> <span class="n">RF3022</span>:
	<span class="k">case</span> <span class="n">RF3052</span>:
	<span class="k">case</span> <span class="n">RF3320</span>:
	<span class="k">case</span> <span class="n">RF5370</span>:
	<span class="k">case</span> <span class="n">RF5372</span>:
	<span class="k">case</span> <span class="n">RF5390</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Invalid RF chipset 0x%04x detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">rf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Identify default antenna configuration.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx_chain_num</span> <span class="o">=</span>
	    <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_TXPATH</span><span class="p">);</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx_chain_num</span> <span class="o">=</span>
	    <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_RXPATH</span><span class="p">);</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3070</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3090</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rt</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT3390</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span>
				<span class="n">EEPROM_NIC_CONF1_ANT_DIVERSITY</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">ANTENNA_A</span><span class="p">;</span>
			<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">ANTENNA_A</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">ANTENNA_A</span><span class="p">;</span>
			<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">ANTENNA_B</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">ANTENNA_A</span><span class="p">;</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">ANTENNA_A</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rt_rev_gte</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RT5390</span><span class="p">,</span> <span class="n">REV_RT5390R</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">ANTENNA_HW_DIVERSITY</span><span class="p">;</span> <span class="cm">/* Unused */</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">default_ant</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">ANTENNA_HW_DIVERSITY</span><span class="p">;</span> <span class="cm">/* Unused */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine external LNA informations.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_EXTERNAL_LNA_5G</span><span class="p">))</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">CAPABILITY_EXTERNAL_LNA_A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_EXTERNAL_LNA_2G</span><span class="p">))</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">CAPABILITY_EXTERNAL_LNA_BG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Detect if this device has an hardware controlled radio.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_HW_RADIO</span><span class="p">))</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">CAPABILITY_HW_BUTTON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Detect if this device has Bluetooth co-existence.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF1_BT_COEXIST</span><span class="p">))</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">CAPABILITY_BT_COEXIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read frequency offset and RF programming sequence.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_FREQ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">freq_offset</span> <span class="o">=</span> <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_FREQ_OFFSET</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Store led settings, for correct led behaviour.</span>
<span class="cm">	 */</span>
<span class="cp">#ifdef CONFIG_RT2X00_LIB_LEDS</span>
	<span class="n">rt2800_init_led</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">led_radio</span><span class="p">,</span> <span class="n">LED_TYPE_RADIO</span><span class="p">);</span>
	<span class="n">rt2800_init_led</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">led_assoc</span><span class="p">,</span> <span class="n">LED_TYPE_ASSOC</span><span class="p">);</span>
	<span class="n">rt2800_init_led</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">led_qual</span><span class="p">,</span> <span class="n">LED_TYPE_QUALITY</span><span class="p">);</span>

	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">led_mcu_reg</span> <span class="o">=</span> <span class="n">eeprom</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_RT2X00_LIB_LEDS */</span><span class="cp"></span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if support EIRP tx power limit feature.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_EIRP_MAX_TX_POWER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_EIRP_MAX_TX_POWER_2GHZ</span><span class="p">)</span> <span class="o">&lt;</span>
					<span class="n">EIRP_MAX_TX_POWER_LIMIT</span><span class="p">)</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">CAPABILITY_POWER_LIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_init_eeprom</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * RF value list for rt28xx</span>
<span class="cm"> * Supports: 2.4 GHz (all) &amp; 5.2 GHz (RF2850 &amp; RF2750)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rf_channel</span> <span class="n">rf_vals</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span>  <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c0786</span><span class="p">,</span> <span class="mh">0x1816b455</span><span class="p">,</span> <span class="mh">0x1800510b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span>  <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c0786</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800519f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">3</span><span class="p">,</span>  <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c078a</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800518b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span>  <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c078a</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800519f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">5</span><span class="p">,</span>  <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c078e</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800518b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">6</span><span class="p">,</span>  <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c078e</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800519f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">7</span><span class="p">,</span>  <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c0792</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800518b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span>  <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c0792</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800519f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span>  <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c0796</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800518b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c0796</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800519f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">11</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c079a</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800518b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">12</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c079a</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800519f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">13</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c079e</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x1800518b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">14</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c07a2</span><span class="p">,</span> <span class="mh">0x18168a55</span><span class="p">,</span> <span class="mh">0x18005193</span> <span class="p">},</span>

	<span class="cm">/* 802.11 UNI / HyperLan 2 */</span>
	<span class="p">{</span> <span class="mi">36</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c099a</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed1a3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">38</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c099e</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed193</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">40</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c0682</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed183</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">44</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c0682</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed1a3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">46</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c0686</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed18b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">48</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c0686</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed19b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">52</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c068a</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed193</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">54</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c068a</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed1a3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">56</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c068e</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed18b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">60</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c0692</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed183</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">62</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c0692</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed193</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">64</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c0692</span><span class="p">,</span> <span class="mh">0x18158a55</span><span class="p">,</span> <span class="mh">0x180ed1a3</span> <span class="p">},</span>

	<span class="cm">/* 802.11 HyperLan 2 */</span>
	<span class="p">{</span> <span class="mi">100</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c06b2</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed783</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">102</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x184c06b2</span><span class="p">,</span> <span class="mh">0x18578a55</span><span class="p">,</span> <span class="mh">0x180ed793</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">104</span><span class="p">,</span> <span class="mh">0x18402ec8</span><span class="p">,</span> <span class="mh">0x185c06b2</span><span class="p">,</span> <span class="mh">0x18578a55</span><span class="p">,</span> <span class="mh">0x180ed1a3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">108</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x185c0a32</span><span class="p">,</span> <span class="mh">0x18578a55</span><span class="p">,</span> <span class="mh">0x180ed193</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">110</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c0a36</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed183</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">112</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c0a36</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed19b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">116</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c0a3a</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed1a3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">118</span><span class="p">,</span> <span class="mh">0x18402ecc</span><span class="p">,</span> <span class="mh">0x184c0a3e</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed193</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">120</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c0382</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed183</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">124</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c0382</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed193</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">126</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c0382</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed15b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">128</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c0382</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed1a3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">132</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c0386</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed18b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">134</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c0386</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed193</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">136</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c0386</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed19b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">140</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c038a</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed183</span> <span class="p">},</span>

	<span class="cm">/* 802.11 UNII */</span>
	<span class="p">{</span> <span class="mi">149</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c038a</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed1a7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">151</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c038e</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed187</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">153</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c038e</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed18f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">157</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c038e</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed19f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">159</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c038e</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed1a7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">161</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c0392</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed187</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">165</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c0392</span><span class="p">,</span> <span class="mh">0x18178a55</span><span class="p">,</span> <span class="mh">0x180ed197</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">167</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c03d2</span><span class="p">,</span> <span class="mh">0x18179855</span><span class="p">,</span> <span class="mh">0x1815531f</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">169</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c03d2</span><span class="p">,</span> <span class="mh">0x18179855</span><span class="p">,</span> <span class="mh">0x18155327</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">171</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c03d6</span><span class="p">,</span> <span class="mh">0x18179855</span><span class="p">,</span> <span class="mh">0x18155307</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">173</span><span class="p">,</span> <span class="mh">0x18402ec4</span><span class="p">,</span> <span class="mh">0x184c03d6</span><span class="p">,</span> <span class="mh">0x18179855</span><span class="p">,</span> <span class="mh">0x1815530f</span> <span class="p">},</span>

	<span class="cm">/* 802.11 Japan */</span>
	<span class="p">{</span> <span class="mi">184</span><span class="p">,</span> <span class="mh">0x15002ccc</span><span class="p">,</span> <span class="mh">0x1500491e</span><span class="p">,</span> <span class="mh">0x1509be55</span><span class="p">,</span> <span class="mh">0x150c0a0b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">188</span><span class="p">,</span> <span class="mh">0x15002ccc</span><span class="p">,</span> <span class="mh">0x15004922</span><span class="p">,</span> <span class="mh">0x1509be55</span><span class="p">,</span> <span class="mh">0x150c0a13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">192</span><span class="p">,</span> <span class="mh">0x15002ccc</span><span class="p">,</span> <span class="mh">0x15004926</span><span class="p">,</span> <span class="mh">0x1509be55</span><span class="p">,</span> <span class="mh">0x150c0a1b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">196</span><span class="p">,</span> <span class="mh">0x15002ccc</span><span class="p">,</span> <span class="mh">0x1500492a</span><span class="p">,</span> <span class="mh">0x1509be55</span><span class="p">,</span> <span class="mh">0x150c0a23</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">208</span><span class="p">,</span> <span class="mh">0x15002ccc</span><span class="p">,</span> <span class="mh">0x1500493a</span><span class="p">,</span> <span class="mh">0x1509be55</span><span class="p">,</span> <span class="mh">0x150c0a13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">212</span><span class="p">,</span> <span class="mh">0x15002ccc</span><span class="p">,</span> <span class="mh">0x1500493e</span><span class="p">,</span> <span class="mh">0x1509be55</span><span class="p">,</span> <span class="mh">0x150c0a1b</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">216</span><span class="p">,</span> <span class="mh">0x15002ccc</span><span class="p">,</span> <span class="mh">0x15004982</span><span class="p">,</span> <span class="mh">0x1509be55</span><span class="p">,</span> <span class="mh">0x150c0a23</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * RF value list for rt3xxx</span>
<span class="cm"> * Supports: 2.4 GHz (all) &amp; 5.2 GHz (RF3052)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rf_channel</span> <span class="n">rf_vals_3x</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">241</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">2</span><span class="p">,</span>  <span class="mi">241</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">242</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span>  <span class="mi">242</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">5</span><span class="p">,</span>  <span class="mi">243</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">6</span><span class="p">,</span>  <span class="mi">243</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span>  <span class="mi">244</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">8</span><span class="p">,</span>  <span class="mi">244</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">9</span><span class="p">,</span>  <span class="mi">245</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">12</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">13</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">14</span><span class="p">,</span> <span class="mi">248</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>

	<span class="cm">/* 802.11 UNI / HyperLan 2 */</span>
	<span class="p">{</span><span class="mi">36</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">38</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">40</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">44</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">46</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">48</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">52</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">54</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">56</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">60</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">62</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">64</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>

	<span class="cm">/* 802.11 HyperLan 2 */</span>
	<span class="p">{</span><span class="mi">100</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">102</span><span class="p">,</span> <span class="mh">0x5b</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">104</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">108</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">110</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">112</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">116</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">118</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">120</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">124</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">126</span><span class="p">,</span> <span class="mh">0x5d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">128</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">132</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">134</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">136</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">140</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>

	<span class="cm">/* 802.11 UNII */</span>
	<span class="p">{</span><span class="mi">149</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">151</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">153</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">157</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">159</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">161</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">165</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">167</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">169</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">171</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">173</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">rt2800_probe_hw_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_mode_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">channel_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">default_power1</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">default_power2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeprom</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable powersaving as default on PCI devices.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_pci</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">rt2x00_is_soc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WIPHY_FLAG_PS_ON_BY_DEFAULT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize all hw fields.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span>
	    <span class="n">IEEE80211_HW_SIGNAL_DBM</span> <span class="o">|</span>
	    <span class="n">IEEE80211_HW_SUPPORTS_PS</span> <span class="o">|</span>
	    <span class="n">IEEE80211_HW_PS_NULLFUNC_STACK</span> <span class="o">|</span>
	    <span class="n">IEEE80211_HW_AMPDU_AGGREGATION</span> <span class="o">|</span>
	    <span class="n">IEEE80211_HW_REPORTS_TX_ACK_STATUS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t set IEEE80211_HW_HOST_BROADCAST_PS_BUFFERING for USB devices</span>
<span class="cm">	 * unless we are capable of sending the buffered frames out after the</span>
<span class="cm">	 * DTIM transmission using rt2x00lib_beacondone. This will send out</span>
<span class="cm">	 * multicast and broadcast traffic immediately instead of buffering it</span>
<span class="cm">	 * infinitly and thus dropping it after some time.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00_is_usb</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
			<span class="n">IEEE80211_HW_HOST_BROADCAST_PS_BUFFERING</span><span class="p">;</span>

	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
				<span class="n">rt2x00_eeprom_addr</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span>
						   <span class="n">EEPROM_MAC_ADDR_0</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * As rt2800 has a global fallback table we cannot specify</span>
<span class="cm">	 * more then one tx rate per frame but since the hw will</span>
<span class="cm">	 * try several rates (based on the fallback table) we should</span>
<span class="cm">	 * initialize max_report_rates to the maximum number of rates</span>
<span class="cm">	 * we are going to try. Otherwise mac80211 will truncate our</span>
<span class="cm">	 * reported tx rates and the rc algortihm will end up with</span>
<span class="cm">	 * incorrect data.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_report_rates</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rate_tries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rt2x00_eeprom_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eeprom</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize hw_mode information.</span>
<span class="cm">	 */</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">supported_bands</span> <span class="o">=</span> <span class="n">SUPPORT_BAND_2GHZ</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">supported_rates</span> <span class="o">=</span> <span class="n">SUPPORT_RATE_CCK</span> <span class="o">|</span> <span class="n">SUPPORT_RATE_OFDM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF2820</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF2720</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">rf_vals</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF2850</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF2750</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">supported_bands</span> <span class="o">|=</span> <span class="n">SUPPORT_BAND_5GHZ</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rf_vals</span><span class="p">);</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">rf_vals</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF3020</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF2020</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF3021</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF3022</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF3320</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF5370</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF5372</span><span class="p">)</span> <span class="o">||</span>
		   <span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF5390</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">rf_vals_3x</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF3052</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">supported_bands</span> <span class="o">|=</span> <span class="n">SUPPORT_BAND_5GHZ</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rf_vals_3x</span><span class="p">);</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">rf_vals_3x</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize HT information.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00_rf</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">RF2020</span><span class="p">))</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">cap</span> <span class="o">=</span>
	    <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span> <span class="o">|</span>
	    <span class="n">IEEE80211_HT_CAP_GRN_FLD</span> <span class="o">|</span>
	    <span class="n">IEEE80211_HT_CAP_SGI_20</span> <span class="o">|</span>
	    <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_TXPATH</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_TX_STBC</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">cap</span> <span class="o">|=</span>
	    <span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_RXPATH</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">IEEE80211_HT_CAP_RX_STBC_SHIFT</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">ampdu_factor</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">ampdu_density</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">=</span>
	    <span class="n">IEEE80211_HT_MCS_TX_DEFINED</span> <span class="o">|</span>
	    <span class="n">IEEE80211_HT_MCS_TX_RX_DIFF</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_TXPATH</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">IEEE80211_HT_MCS_TX_MAX_STREAMS_SHIFT</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00_get_field16</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">EEPROM_NIC_CONF0_RXPATH</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span> <span class="cm">/* MCS32 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create channel information array</span>
<span class="cm">	 */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spec</span><span class="o">-&gt;</span><span class="n">channels_info</span> <span class="o">=</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">default_power1</span> <span class="o">=</span> <span class="n">rt2x00_eeprom_addr</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TXPOWER_BG1</span><span class="p">);</span>
	<span class="n">default_power2</span> <span class="o">=</span> <span class="n">rt2x00_eeprom_addr</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TXPOWER_BG2</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_power1</span> <span class="o">=</span> <span class="n">default_power1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_power2</span> <span class="o">=</span> <span class="n">default_power2</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">default_power1</span> <span class="o">=</span> <span class="n">rt2x00_eeprom_addr</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TXPOWER_A1</span><span class="p">);</span>
		<span class="n">default_power2</span> <span class="o">=</span> <span class="n">rt2x00_eeprom_addr</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">EEPROM_TXPOWER_A2</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_power1</span> <span class="o">=</span> <span class="n">default_power1</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">default_power2</span> <span class="o">=</span> <span class="n">default_power2</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">rf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RF2020</span>:
	<span class="k">case</span> <span class="n">RF3020</span>:
	<span class="k">case</span> <span class="n">RF3021</span>:
	<span class="k">case</span> <span class="n">RF3022</span>:
	<span class="k">case</span> <span class="n">RF3320</span>:
	<span class="k">case</span> <span class="n">RF3052</span>:
	<span class="k">case</span> <span class="n">RF5370</span>:
	<span class="k">case</span> <span class="n">RF5372</span>:
	<span class="k">case</span> <span class="n">RF5390</span>:
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">CAPABILITY_VCO_RECALIBRATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_probe_hw_mode</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * IEEE80211 stack callback functions.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rt2800_get_tkip_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hw_key_idx</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">iv32</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="o">*</span><span class="n">iv16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_iveiv_entry</span> <span class="n">iveiv_entry</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">MAC_IVEIV_ENTRY</span><span class="p">(</span><span class="n">hw_key_idx</span><span class="p">);</span>
	<span class="n">rt2800_register_multiread</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">iveiv_entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iveiv_entry</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">iv16</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iveiv_entry</span><span class="p">.</span><span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iv16</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iv32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iveiv_entry</span><span class="p">.</span><span class="n">iv</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iv32</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_get_tkip_seq</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_set_rts_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">IEEE80211_MAX_RTS_THRESHOLD</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_RTS_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">TX_RTS_CFG_RTS_THRES</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TX_RTS_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CCK_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">CCK_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CCK_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">OFDM_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM20_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM20_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM20_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM40_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">MM40_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">MM40_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF20_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF20_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF20_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF40_PROT_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">GF40_PROT_CFG_RTS_TH_EN</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">GF40_PROT_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_set_rts_threshold</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">queue_idx</span><span class="p">,</span>
		   <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">data_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt2x00_field32</span> <span class="n">field</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First pass the configuration through rt2x00lib, that will</span>
<span class="cm">	 * update the queue settings and validate the input. After that</span>
<span class="cm">	 * we are free to update the registers based on the value</span>
<span class="cm">	 * in the queue parameter.</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rt2x00mac_conf_tx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">queue_idx</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We only need to perform additional register initialization</span>
<span class="cm">	 * for WMM queues/</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue_idx</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">rt2x00queue_get_tx_queue</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">queue_idx</span><span class="p">);</span>

	<span class="cm">/* Update WMM TXOP register */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">WMM_TXOP0_CFG</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">queue_idx</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)));</span>
	<span class="n">field</span><span class="p">.</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">queue_idx</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">field</span><span class="p">.</span><span class="n">bit_mask</span> <span class="o">=</span> <span class="mh">0xffff</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">.</span><span class="n">bit_offset</span><span class="p">;</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Update WMM registers */</span>
	<span class="n">field</span><span class="p">.</span><span class="n">bit_offset</span> <span class="o">=</span> <span class="n">queue_idx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">field</span><span class="p">.</span><span class="n">bit_mask</span> <span class="o">=</span> <span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="p">.</span><span class="n">bit_offset</span><span class="p">;</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WMM_AIFSN_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WMM_AIFSN_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WMM_CWMIN_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WMM_CWMIN_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WMM_CWMAX_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">WMM_CWMAX_CFG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Update EDCA registers */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">EDCA_AC0_CFG</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">queue_idx</span><span class="p">);</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">EDCA_AC0_CFG_TX_OP</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">EDCA_AC0_CFG_AIFSN</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">EDCA_AC0_CFG_CWMIN</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">);</span>
	<span class="n">rt2x00_set_field32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">EDCA_AC0_CFG_CWMAX</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">);</span>
	<span class="n">rt2800_register_write</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_conf_tx</span><span class="p">);</span>

<span class="n">u64</span> <span class="nf">rt2800_get_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tsf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TSF_TIMER_DW1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">tsf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSF_TIMER_DW1_HIGH_WORD</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">TSF_TIMER_DW0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">tsf</span> <span class="o">|=</span> <span class="n">rt2x00_get_field32</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">TSF_TIMER_DW0_LOW_WORD</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tsf</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_get_tsf</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_ampdu_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">ieee80211_ampdu_mlme_action</span> <span class="n">action</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ssn</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_sta</span> <span class="o">*</span><span class="n">sta_priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_sta</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t allow aggregation for stations the hardware isn&#39;t aware</span>
<span class="cm">	 * of because tx status reports for frames to an unknown station</span>
<span class="cm">	 * always contain wcid=255 and thus we can&#39;t distinguish between</span>
<span class="cm">	 * multiple stations which leads to unwanted situations when the</span>
<span class="cm">	 * hw reorders frames due to aggregation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">wcid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_START</span>:
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_STOP</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The hw itself takes care of setting up BlockAck mechanisms.</span>
<span class="cm">		 * So, we only have to allow mac80211 to nagotiate a BlockAck</span>
<span class="cm">		 * agreement. Once that is done, the hw will BlockAck incoming</span>
<span class="cm">		 * AMPDUs without further setup.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_START</span>:
		<span class="n">ieee80211_start_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_STOP</span>:
		<span class="n">ieee80211_stop_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_OPERATIONAL</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARNING</span><span class="p">((</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Unknown AMPDU action</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_ampdu_action</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2800_get_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idle</span><span class="p">,</span> <span class="n">busy</span><span class="p">,</span> <span class="n">busy_ext</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CH_IDLE_STA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idle</span><span class="p">);</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CH_BUSY_STA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">busy</span><span class="p">);</span>
	<span class="n">rt2800_register_read</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">CH_BUSY_STA_SEC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">busy_ext</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idle</span> <span class="o">||</span> <span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="n">SURVEY_INFO_CHANNEL_TIME</span> <span class="o">|</span>
				 <span class="n">SURVEY_INFO_CHANNEL_TIME_BUSY</span> <span class="o">|</span>
				 <span class="n">SURVEY_INFO_CHANNEL_TIME_EXT_BUSY</span><span class="p">;</span>

		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">idle</span> <span class="o">+</span> <span class="n">busy</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_busy</span> <span class="o">=</span> <span class="n">busy</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_ext_busy</span> <span class="o">=</span> <span class="n">busy_ext</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_OFFCHANNEL</span><span class="p">))</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">SURVEY_INFO_IN_USE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2800_get_survey</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_PROJECT</span> <span class="s">&quot;, Bartlomiej Zolnierkiewicz&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Ralink RT2800 library&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
