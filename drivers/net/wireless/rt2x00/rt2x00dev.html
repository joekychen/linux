<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › rt2x00 › rt2x00dev.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>rt2x00dev.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	Copyright (C) 2010 Willow Garage &lt;http://www.willowgarage.com&gt;</span>
<span class="cm">	Copyright (C) 2004 - 2010 Ivo van Doorn &lt;IvDoorn@gmail.com&gt;</span>
<span class="cm">	&lt;http://rt2x00.serialmonkey.com&gt;</span>

<span class="cm">	This program is free software; you can redistribute it and/or modify</span>
<span class="cm">	it under the terms of the GNU General Public License as published by</span>
<span class="cm">	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">	(at your option) any later version.</span>

<span class="cm">	This program is distributed in the hope that it will be useful,</span>
<span class="cm">	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm">	GNU General Public License for more details.</span>

<span class="cm">	You should have received a copy of the GNU General Public License</span>
<span class="cm">	along with this program; if not, write to the</span>
<span class="cm">	Free Software Foundation, Inc.,</span>
<span class="cm">	59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm">	Module: rt2x00lib</span>
<span class="cm">	Abstract: rt2x00 generic device routines.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>

<span class="cp">#include &quot;rt2x00.h&quot;</span>
<span class="cp">#include &quot;rt2x00lib.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Utility functions.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">rt2x00lib_get_bssidx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * When in STA mode, bssidx is always 0 otherwise local_address[5]</span>
<span class="cm">	 * contains the bss number, see BSS_ID_MASK comments for details.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_sta_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">max_ap_intf</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_get_bssidx</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Radio control handlers.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rt2x00lib_enable_radio</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t enable the radio twice.</span>
<span class="cm">	 * And check if the hardware button has been disabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize all data queues.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00queue_init_queues</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable radio.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">set_device_state</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">STATE_RADIO_ON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">set_device_state</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">STATE_RADIO_IRQ_ON</span><span class="p">);</span>

	<span class="n">rt2x00leds_led_radio</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">rt2x00led_led_activity</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable queues.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00queue_start_queues</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00link_start_tuner</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00link_start_agc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_VCO_RECALIBRATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="n">rt2x00link_start_vcocal</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Start watchdog monitoring.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00link_start_watchdog</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00lib_disable_radio</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop watchdog monitoring.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00link_stop_watchdog</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop all queues</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00link_stop_agc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_VCO_RECALIBRATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="n">rt2x00link_stop_vcocal</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00link_stop_tuner</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00queue_stop_queues</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00queue_flush_queues</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable radio.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">set_device_state</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">STATE_RADIO_OFF</span><span class="p">);</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">set_device_state</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">STATE_RADIO_IRQ_OFF</span><span class="p">);</span>
	<span class="n">rt2x00led_led_activity</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">rt2x00leds_led_radio</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_intf_scheduled_iter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rt2x00_intf</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">vif_to_intf</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * It is possible the radio was disabled while the work had been</span>
<span class="cm">	 * scheduled. If that happens we should return here immediately,</span>
<span class="cm">	 * note that in the spinlock protected area above the delayed_flags</span>
<span class="cm">	 * have been cleared correctly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DELAYED_UPDATE_BEACON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">delayed_flags</span><span class="p">))</span>
		<span class="n">rt2x00queue_update_beacon</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_intf_scheduled</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt2x00_dev</span><span class="p">,</span> <span class="n">intf_work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Iterate over each interface and perform the</span>
<span class="cm">	 * requested configurations.</span>
<span class="cm">	 */</span>
	<span class="n">ieee80211_iterate_active_interfaces</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					    <span class="n">rt2x00lib_intf_scheduled_iter</span><span class="p">,</span>
					    <span class="n">rt2x00dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_autowakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt2x00_dev</span><span class="p">,</span> <span class="n">autowakeup_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">set_device_state</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">STATE_AWAKE</span><span class="p">))</span>
		<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Device failed to wakeup.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONFIG_POWERSAVING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt context handlers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_bc_buffer_iter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only AP mode interfaces do broad- and multicast buffering</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send out buffered broad- and multicast frames</span>
<span class="cm">	 */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_get_buffered_bc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00mac_tx</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_get_buffered_bc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_beaconupdate_iter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_WDS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the beacon without locking. This is safe on PCI devices</span>
<span class="cm">	 * as they only update the beacon periodically here. This should</span>
<span class="cm">	 * never be called for USB devices.</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">rt2x00_is_usb</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">));</span>
	<span class="n">rt2x00queue_update_beacon_locked</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00lib_beacondone</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* send buffered bc/mc frames out for every bssid */</span>
	<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
						   <span class="n">rt2x00lib_bc_buffer_iter</span><span class="p">,</span>
						   <span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Devices with pre tbtt interrupt don&#39;t need to update the beacon</span>
<span class="cm">	 * here as they will fetch the next beacon directly prior to</span>
<span class="cm">	 * transmission.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_PRE_TBTT_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* fetch next beacon */</span>
	<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
						   <span class="n">rt2x00lib_beaconupdate_iter</span><span class="p">,</span>
						   <span class="n">rt2x00dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_beacondone</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00lib_pretbtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* fetch next beacon */</span>
	<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
						   <span class="n">rt2x00lib_beaconupdate_iter</span><span class="p">,</span>
						   <span class="n">rt2x00dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_pretbtt</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00lib_dmastart</span><span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ENTRY_OWNER_DEVICE_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rt2x00queue_index_inc</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Q_INDEX</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_dmastart</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00lib_dmadone</span><span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ENTRY_DATA_STATUS_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ENTRY_OWNER_DEVICE_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rt2x00queue_index_inc</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Q_INDEX_DMA_DONE</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_dmadone</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00lib_txdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">txdone_entry_desc</span> <span class="o">*</span><span class="n">txdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">skb_frame_desc</span> <span class="o">*</span><span class="n">skbdesc</span> <span class="o">=</span> <span class="n">get_skb_frame_desc</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">header_length</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate_idx</span><span class="p">,</span> <span class="n">rate_flags</span><span class="p">,</span> <span class="n">retry_rates</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">skbdesc_flags</span> <span class="o">=</span> <span class="n">skbdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">success</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unmap the skb.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00queue_unmap_skb</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Remove the extra tx headroom from the skb.</span>
<span class="cm">	 */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Signal that the TX descriptor is no longer in the skb.</span>
<span class="cm">	 */</span>
	<span class="n">skbdesc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SKBDESC_DESC_IN_SKB</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine the length of 802.11 header.</span>
<span class="cm">	 */</span>
	<span class="n">header_length</span> <span class="o">=</span> <span class="n">ieee80211_get_hdrlen_from_skb</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Remove L2 padding which was added during</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">REQUIRE_L2PAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="n">rt2x00queue_remove_l2pad</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">header_length</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the IV/EIV data was stripped from the frame before it was</span>
<span class="cm">	 * passed to the hardware, we should now reinsert it again because</span>
<span class="cm">	 * mac80211 will expect the same data to be present it the</span>
<span class="cm">	 * frame as it was passed to us.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_HW_CRYPTO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="n">rt2x00crypto_tx_insert_iv</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">header_length</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send frame to debugfs immediately, after this call is completed</span>
<span class="cm">	 * we are going to overwrite the skb-&gt;cb array.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00debug_dump_frame</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">DUMP_FRAME_TXDONE</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine if the frame has been successfully transmitted.</span>
<span class="cm">	 */</span>
	<span class="n">success</span> <span class="o">=</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">TXDONE_SUCCESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">TXDONE_UNKNOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update TX statistics.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">tx_success</span> <span class="o">+=</span> <span class="n">success</span><span class="p">;</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">tx_failed</span> <span class="o">+=</span> <span class="o">!</span><span class="n">success</span><span class="p">;</span>

	<span class="n">rate_idx</span> <span class="o">=</span> <span class="n">skbdesc</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span><span class="p">;</span>
	<span class="n">rate_flags</span> <span class="o">=</span> <span class="n">skbdesc</span><span class="o">-&gt;</span><span class="n">tx_rate_flags</span><span class="p">;</span>
	<span class="n">retry_rates</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">TXDONE_FALLBACK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span>
	    <span class="p">(</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize TX status</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ack_signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Frame was send with retries, hardware tried</span>
<span class="cm">	 * different rates to send out the frame, at each</span>
<span class="cm">	 * retry it lowered the rate 1 step except when the</span>
<span class="cm">	 * lowest rate was used.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">retry_rates</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_TX_MAX_RATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">rate_idx</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">rate_flags</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rate_idx</span> <span class="o">-</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The lowest rate (index 0) was used until the</span>
<span class="cm">			 * number of max retries was reached.</span>
<span class="cm">			 */</span>
			<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">retry_rates</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">IEEE80211_TX_MAX_RATES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* terminate */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
			<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">low_level_stats</span><span class="p">.</span><span class="n">dot11ACKFailureCount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Every single frame has it&#39;s own tx status, hence report</span>
<span class="cm">	 * every frame as ampdu of size 1.</span>
<span class="cm">	 *</span>
<span class="cm">	 * TODO: if we can find out how many frames were aggregated</span>
<span class="cm">	 * by the hw we could provide the real ampdu_len to mac80211</span>
<span class="cm">	 * which would allow the rc algorithm to better decide on</span>
<span class="cm">	 * which rates are suitable.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TXDONE_AMPDU</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_AMPDU</span><span class="p">;</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span> <span class="o">=</span> <span class="n">success</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * TODO: Need to tear down BA session here</span>
<span class="cm">		 * if not successful.</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
			<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">low_level_stats</span><span class="p">.</span><span class="n">dot11RTSSuccessCount</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">low_level_stats</span><span class="p">.</span><span class="n">dot11RTSFailureCount</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only send the status report to mac80211 when it&#39;s a frame</span>
<span class="cm">	 * that originated in mac80211. If this was a extra frame coming</span>
<span class="cm">	 * through a mac80211 library call (RTS/CTS) then we should not</span>
<span class="cm">	 * send the status report back.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skbdesc_flags</span> <span class="o">&amp;</span> <span class="n">SKBDESC_NOT_MAC80211</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">REQUIRE_TASKLET_CONTEXT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
			<span class="n">ieee80211_tx_status</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ieee80211_tx_status_ni</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make this entry available for reuse.</span>
<span class="cm">	 */</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">clear_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="n">rt2x00queue_index_inc</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Q_INDEX_DONE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the data queue was below the threshold before the txdone</span>
<span class="cm">	 * handler we must make sure the packet queue in the mac80211 stack</span>
<span class="cm">	 * is reenabled when the txdone handler has finished. This has to be</span>
<span class="cm">	 * serialized with rt2x00mac_tx(), otherwise we can wake up queue</span>
<span class="cm">	 * before it was stopped.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00queue_threshold</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">rt2x00queue_unpause_queue</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_txdone</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00lib_txdone_noinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">txdone_entry_desc</span> <span class="n">txdesc</span><span class="p">;</span>

	<span class="n">txdesc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">txdesc</span><span class="p">.</span><span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rt2x00lib_txdone</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_txdone_noinfo</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">rt2x00lib_find_ie</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ie</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>

		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt2x00_dev</span><span class="p">,</span> <span class="n">sleep_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check again is powersaving is enabled, to prevent races from delayed</span>
<span class="cm">	 * work execution.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONFIG_POWERSAVING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">rt2x00lib_config</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">,</span>
				 <span class="n">IEEE80211_CONF_CHANGE_PS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_rxdone_check_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">rxdone_entry_desc</span> <span class="o">*</span><span class="n">rxdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tim_ie</span> <span class="o">*</span><span class="n">tim_ie</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tim</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tim_len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cam</span><span class="p">;</span>

	<span class="cm">/* If this is not a beacon, or if mac80211 has no powersaving</span>
<span class="cm">	 * configured, or if the device is already in powersaving mode</span>
<span class="cm">	 * we can exit now. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* min. beacon length + FCS_LEN */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">40</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* and only beacons from the associated BSSID, please */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">RXDONE_MY_BSS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">last_beacon</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">tim</span> <span class="o">=</span> <span class="n">rt2x00lib_find_ie</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">FCS_LEN</span><span class="p">,</span> <span class="n">WLAN_EID_TIM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tim</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tim_ie</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tim_len</span> <span class="o">=</span> <span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">tim_ie</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tim_ie</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tim</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* Check whenever the PHY can be turned off again. */</span>

	<span class="cm">/* 1. What about buffered unicast traffic for our AID? */</span>
	<span class="n">cam</span> <span class="o">=</span> <span class="n">ieee80211_check_tim</span><span class="p">(</span><span class="n">tim_ie</span><span class="p">,</span> <span class="n">tim_len</span><span class="p">,</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>

	<span class="cm">/* 2. Maybe the AP wants to send multicast/broadcast data? */</span>
	<span class="n">cam</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tim_ie</span><span class="o">-&gt;</span><span class="n">bitmap_ctrl</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cam</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONFIG_POWERSAVING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">sleep_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2x00lib_rxdone_read_signal</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">rxdone_entry_desc</span> <span class="o">*</span><span class="n">rxdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rt2x00_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">signal</span> <span class="o">=</span> <span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">RXDONE_SIGNAL_MASK</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">rate_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RATE_MODE_CCK</span>:
	<span class="k">case</span> <span class="n">RATE_MODE_OFDM</span>:
		<span class="cm">/*</span>
<span class="cm">		 * For non-HT rates the MCS value needs to contain the</span>
<span class="cm">		 * actually used rate modulation (CCK or OFDM).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">RXDONE_SIGNAL_MCS</span><span class="p">)</span>
			<span class="n">signal</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">rate_mode</span><span class="p">,</span> <span class="n">signal</span><span class="p">);</span>

		<span class="n">sband</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">curr_band</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">rt2x00_get_rate</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">type</span> <span class="o">==</span> <span class="n">RXDONE_SIGNAL_PLCP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">plcp</span> <span class="o">==</span> <span class="n">signal</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">RXDONE_SIGNAL_BITRATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			      <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">==</span> <span class="n">signal</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">RXDONE_SIGNAL_MCS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			      <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">mcs</span> <span class="o">==</span> <span class="n">signal</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RATE_MODE_HT_MIX</span>:
	<span class="k">case</span> <span class="n">RATE_MODE_HT_GREENFIELD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">signal</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">signal</span> <span class="o">&lt;=</span> <span class="mi">76</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">signal</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARNING</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Frame received with unrecognized signal, &quot;</span>
		<span class="s">&quot;mode=0x%.4x, signal=0x%.4x, type=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">rate_mode</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00lib_rxdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">queue_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rt2x00dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxdone_entry_desc</span> <span class="n">rxdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rx_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">header_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">submit_entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ENTRY_DATA_IO_FAILED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">submit_entry</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate a new sk_buffer. If no new buffer available, drop the</span>
<span class="cm">	 * received frame and reuse the existing buffer.</span>
<span class="cm">	 */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">rt2x00queue_alloc_rxskb</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">submit_entry</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unmap the skb.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00queue_unmap_skb</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Extract the RXD details.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxdesc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxdesc</span><span class="p">));</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">fill_rxdone</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxdesc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for valid size in case we get corrupted descriptor from</span>
<span class="cm">	 * hardware.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rxdesc</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		     <span class="n">rxdesc</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">WARNING</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Wrong frame size %d max %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rxdesc</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">renew_skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The data behind the ieee80211 header must be</span>
<span class="cm">	 * aligned on a 4 byte boundary.</span>
<span class="cm">	 */</span>
	<span class="n">header_length</span> <span class="o">=</span> <span class="n">ieee80211_get_hdrlen_from_skb</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hardware might have stripped the IV/EIV/ICV data,</span>
<span class="cm">	 * in that case it is possible that the data was</span>
<span class="cm">	 * provided separately (through hardware descriptor)</span>
<span class="cm">	 * in which case we should reinsert the data into the frame.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rxdesc</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">RXDONE_CRYPTO_IV</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxdesc</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_IV_STRIPPED</span><span class="p">))</span>
		<span class="n">rt2x00crypto_rx_insert_iv</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">header_length</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">rxdesc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">header_length</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">rxdesc</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">header_length</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">rxdesc</span><span class="p">.</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">RXDONE_L2PAD</span><span class="p">))</span>
		<span class="n">rt2x00queue_remove_l2pad</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">header_length</span><span class="p">);</span>

	<span class="cm">/* Trim buffer to correct size */</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">rxdesc</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Translate the signal to the correct bitrate index.</span>
<span class="cm">	 */</span>
	<span class="n">rate_idx</span> <span class="o">=</span> <span class="n">rt2x00lib_rxdone_read_signal</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxdesc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxdesc</span><span class="p">.</span><span class="n">rate_mode</span> <span class="o">==</span> <span class="n">RATE_MODE_HT_MIX</span> <span class="o">||</span>
	    <span class="n">rxdesc</span><span class="p">.</span><span class="n">rate_mode</span> <span class="o">==</span> <span class="n">RATE_MODE_HT_GREENFIELD</span><span class="p">)</span>
		<span class="n">rxdesc</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RX_FLAG_HT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if this is a beacon, and more frames have been</span>
<span class="cm">	 * buffered while we were in powersaving mode.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00lib_rxdone_check_ps</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxdesc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update extra components</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00link_update_stats</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxdesc</span><span class="p">);</span>
	<span class="n">rt2x00debug_update_crypto</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxdesc</span><span class="p">);</span>
	<span class="n">rt2x00debug_dump_frame</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">DUMP_FRAME_RXDONE</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize RX status information, and send frame</span>
<span class="cm">	 * to mac80211.</span>
<span class="cm">	 */</span>
	<span class="n">rx_status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">mactime</span> <span class="o">=</span> <span class="n">rxdesc</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">curr_band</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">curr_freq</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">rate_idx</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">rxdesc</span><span class="p">.</span><span class="n">rssi</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="n">rxdesc</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">antenna</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>

	<span class="n">ieee80211_rx_ni</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

<span class="nl">renew_skb:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Replace the skb with the freshly allocated one.</span>
<span class="cm">	 */</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

<span class="nl">submit_entry:</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rt2x00queue_index_inc</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Q_INDEX_DONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">clear_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_rxdone</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Driver initialization handlers.</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">rt2x00_rate</span> <span class="n">rt2x00_supported_rates</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_CCK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_CCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_CCK</span> <span class="o">|</span> <span class="n">DEV_RATE_SHORT_PREAMBLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_CCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_CCK</span> <span class="o">|</span> <span class="n">DEV_RATE_SHORT_PREAMBLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_CCK</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_CCK</span> <span class="o">|</span> <span class="n">DEV_RATE_SHORT_PREAMBLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_CCK</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_OFDM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_OFDM</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_OFDM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_OFDM</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_OFDM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_OFDM</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_OFDM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_OFDM</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_OFDM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_OFDM</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_OFDM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x0d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_OFDM</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_OFDM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_OFDM</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">DEV_RATE_OFDM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ratemask</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
		<span class="p">.</span><span class="n">plcp</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="n">RATE_MCS</span><span class="p">(</span><span class="n">RATE_MODE_OFDM</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">tx_power</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX: this assumption about the band is wrong for 802.11j */</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span> <span class="o">?</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">:</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">center_freq</span> <span class="o">=</span> <span class="n">ieee80211_channel_to_frequency</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span>
							    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">max_power</span> <span class="o">=</span> <span class="n">tx_power</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">max_antenna_gain</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
			   <span class="k">const</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rt2x00_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DEV_RATE_SHORT_PREAMBLE</span><span class="p">)</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2x00lib_probe_hw_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">hw_mode_spec</span> <span class="o">*</span><span class="n">spec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rates</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_rates</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">num_rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">supported_rates</span> <span class="o">&amp;</span> <span class="n">SUPPORT_RATE_CCK</span><span class="p">)</span>
		<span class="n">num_rates</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">supported_rates</span> <span class="o">&amp;</span> <span class="n">SUPPORT_RATE_OFDM</span><span class="p">)</span>
		<span class="n">num_rates</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">channels</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">channels</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channels</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rates</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">num_rates</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rates</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rates</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_free_channels</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize Rate list.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_rates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rt2x00lib_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">,</span> <span class="n">rt2x00_get_rate</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize Channel list.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00lib_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				  <span class="n">spec</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">,</span>
				  <span class="n">spec</span><span class="o">-&gt;</span><span class="n">channels_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_power</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Intitialize 802.11b, 802.11g</span>
<span class="cm">	 * Rates: CCK, OFDM.</span>
<span class="cm">	 * Channels: 2.4 GHz</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">supported_bands</span> <span class="o">&amp;</span> <span class="n">SUPPORT_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">n_channels</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">num_rates</span><span class="p">;</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">rates</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">ht_cap</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Intitialize 802.11a</span>
<span class="cm">	 * Rates: OFDM.</span>
<span class="cm">	 * Channels: OFDM, UNII, HiperLAN2.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">supported_bands</span> <span class="o">&amp;</span> <span class="n">SUPPORT_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">n_channels</span> <span class="o">=</span>
		    <span class="n">spec</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">-</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">n_bitrates</span> <span class="o">=</span>
		    <span class="n">num_rates</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">channels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">channels</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">bitrates</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">ht_cap</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">spec</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">exit_free_channels:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">channels</span><span class="p">);</span>
	<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Allocation ieee80211 modes failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_remove_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_REGISTERED_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">);</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">channels_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2x00lib_probe_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hw_mode_spec</span> <span class="o">*</span><span class="n">spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_REGISTERED_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize HW modes.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">rt2x00lib_probe_hw_modes</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">spec</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize HW fields.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tx_queues</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize extra TX headroom required.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">=</span>
		<span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">IEEE80211_TX_STATUS_HEADROOM</span><span class="p">,</span>
		      <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Take TX headroom required for alignment into account.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">REQUIRE_L2PAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">+=</span> <span class="n">RT2X00_L2PAD_SIZE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">REQUIRE_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">+=</span> <span class="n">RT2X00_ALIGN_SIZE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell mac80211 about the size of our private STA structure.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">sta_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_sta</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate tx status FIFO for driver use.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">REQUIRE_TXSTATUS_FIFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allocate the txstatus fifo. In the worst case the tx</span>
<span class="cm">		 * status fifo has to hold the tx status of all entries</span>
<span class="cm">		 * in all tx queues. Hence, calculate the kfifo size as</span>
<span class="cm">		 * tx_queues * entry_num and round up to the nearest</span>
<span class="cm">		 * power of 2.</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">kfifo_size</span> <span class="o">=</span>
			<span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tx_queues</span> <span class="o">*</span>
					   <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">entry_num</span> <span class="o">*</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">txstatus_fifo</span><span class="p">,</span> <span class="n">kfifo_size</span><span class="p">,</span>
				     <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize tasklets if used by the driver. Tasklets are</span>
<span class="cm">	 * disabled until the interrupts are turned on. The driver</span>
<span class="cm">	 * has to handle that.</span>
<span class="cm">	 */</span>
<span class="cp">#define RT2X00_TASKLET_INIT(taskletname) \</span>
<span class="cp">	if (rt2x00dev-&gt;ops-&gt;lib-&gt;taskletname) { \</span>
<span class="cp">		tasklet_init(&amp;rt2x00dev-&gt;taskletname, \</span>
<span class="cp">			     rt2x00dev-&gt;ops-&gt;lib-&gt;taskletname, \</span>
<span class="cp">			     (unsigned long)rt2x00dev); \</span>
<span class="cp">	}</span>

	<span class="n">RT2X00_TASKLET_INIT</span><span class="p">(</span><span class="n">txstatus_tasklet</span><span class="p">);</span>
	<span class="n">RT2X00_TASKLET_INIT</span><span class="p">(</span><span class="n">pretbtt_tasklet</span><span class="p">);</span>
	<span class="n">RT2X00_TASKLET_INIT</span><span class="p">(</span><span class="n">tbtt_tasklet</span><span class="p">);</span>
	<span class="n">RT2X00_TASKLET_INIT</span><span class="p">(</span><span class="n">rxdone_tasklet</span><span class="p">);</span>
	<span class="n">RT2X00_TASKLET_INIT</span><span class="p">(</span><span class="n">autowake_tasklet</span><span class="p">);</span>

<span class="cp">#undef RT2X00_TASKLET_INIT</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register HW.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_REGISTERED_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialization/uninitialization handlers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_uninitialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Unregister extra components.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00rfkill_unregister</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allow the HW to uninitialize.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">uninitialize</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Free allocated queue entries.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00queue_uninitialize</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2x00lib_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate all queue entries.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">rt2x00queue_initialize</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the device.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">initialize</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00queue_uninitialize</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_INITIALIZED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rt2x00lib_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this is the first interface which is added,</span>
<span class="cm">	 * we should load the firmware now.</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rt2x00lib_load_firmware</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize the device.</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rt2x00lib_initialize</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_ap_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_sta_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Enable the radio */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rt2x00lib_enable_radio</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00lib_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_STARTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Perhaps we can add something smarter here,</span>
<span class="cm">	 * but for now just disabling the radio should do.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00lib_disable_radio</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_ap_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_sta_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * driver allocation handlers.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rt2x00lib_probe_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate the driver data memory, if necessary.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">drv_data_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">drv_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">drv_data_size</span><span class="p">,</span>
			                      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">drv_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">irqmask_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">csr_mutex</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make room for rt2x00_intf inside the per-interface</span>
<span class="cm">	 * structure ieee80211_vif.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vif_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_intf</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine which operating modes are supported, all modes</span>
<span class="cm">	 * which require beaconing, depend on the availability of</span>
<span class="cm">	 * beacon entries.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">bcn</span><span class="o">-&gt;</span><span class="n">entry_num</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">|=</span>
		    <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_WDS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize work.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span>
	    <span class="n">alloc_ordered_workqueue</span><span class="p">(</span><span class="n">wiphy_name</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_work</span><span class="p">,</span> <span class="n">rt2x00lib_intf_scheduled</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">autowakeup_work</span><span class="p">,</span> <span class="n">rt2x00lib_autowakeup</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">sleep_work</span><span class="p">,</span> <span class="n">rt2x00lib_sleep</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Let the driver probe the device to detect the capabilities.</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">probe_hw</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate queue array.</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rt2x00queue_allocate</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize ieee80211 structure.</span>
<span class="cm">	 */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rt2x00lib_probe_hw</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ERROR</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Failed to initialize hw.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register extra components.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00link_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00leds_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00debug_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00rfkill_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="n">rt2x00lib_remove_dev</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_probe_dev</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">rt2x00lib_remove_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable radio.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00lib_disable_radio</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop all work.</span>
<span class="cm">	 */</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">autowakeup_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">sleep_work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00_is_usb</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">txstatus_timer</span><span class="p">);</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">rxdone_work</span><span class="p">);</span>
		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">txdone_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">)</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Free the tx status fifo.</span>
<span class="cm">	 */</span>
	<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">txstatus_fifo</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Kill the tx status tasklet.</span>
<span class="cm">	 */</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">txstatus_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">pretbtt_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">tbtt_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">rxdone_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">autowake_tasklet</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Uninitialize device.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00lib_uninitialize</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Free extra components</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00debug_deregister</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00leds_unregister</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Free ieee80211_hw memory.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00lib_remove_hw</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Free firmware image.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00lib_free_firmware</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Free queue structures.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00queue_free</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Free the driver data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">drv_data</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">drv_data</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_remove_dev</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Device state handlers</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="kt">int</span> <span class="nf">rt2x00lib_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NOTICE</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Going to sleep.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Prevent mac80211 from accessing driver while suspended.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cleanup as much as possible.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00lib_uninitialize</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Suspend/disable extra components.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00leds_suspend</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00debug_deregister</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set device mode to sleep for power management,</span>
<span class="cm">	 * on some hardware this call seems to consistently fail.</span>
<span class="cm">	 * From the specifications it is hard to tell why it fails,</span>
<span class="cm">	 * and if this is a &quot;bad thing&quot;.</span>
<span class="cm">	 * Overall it is safe to just ignore the failure and</span>
<span class="cm">	 * continue suspending. The only downside is that the</span>
<span class="cm">	 * device will not be in optimal power save mode, but with</span>
<span class="cm">	 * the radio and the other components already disabled the</span>
<span class="cm">	 * device is as good as disabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">set_device_state</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">STATE_SLEEP</span><span class="p">))</span>
		<span class="n">WARNING</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Device failed to enter sleep state, &quot;</span>
			<span class="s">&quot;continue suspending.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_suspend</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">rt2x00lib_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NOTICE</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="s">&quot;Waking up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Restore/enable extra components.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00debug_register</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00leds_resume</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are ready again to receive requests from mac80211.</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">rt2x00lib_resume</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * rt2x00lib module information.</span>
<span class="cm"> */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_PROJECT</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;rt2x00 library&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
