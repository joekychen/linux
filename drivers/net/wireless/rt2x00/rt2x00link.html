<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › rt2x00 › rt2x00link.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>rt2x00link.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">	Copyright (C) 2004 - 2009 Ivo van Doorn &lt;IvDoorn@gmail.com&gt;</span>
<span class="cm">	&lt;http://rt2x00.serialmonkey.com&gt;</span>

<span class="cm">	This program is free software; you can redistribute it and/or modify</span>
<span class="cm">	it under the terms of the GNU General Public License as published by</span>
<span class="cm">	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">	(at your option) any later version.</span>

<span class="cm">	This program is distributed in the hope that it will be useful,</span>
<span class="cm">	but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm">	GNU General Public License for more details.</span>

<span class="cm">	You should have received a copy of the GNU General Public License</span>
<span class="cm">	along with this program; if not, write to the</span>
<span class="cm">	Free Software Foundation, Inc.,</span>
<span class="cm">	59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm">	Module: rt2x00lib</span>
<span class="cm">	Abstract: rt2x00 generic link tuning routines.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;rt2x00.h&quot;</span>
<span class="cp">#include &quot;rt2x00lib.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * When we lack RSSI information return something less then -80 to</span>
<span class="cm"> * tell the driver to tune the device to maximum sensitivity.</span>
<span class="cm"> */</span>
<span class="cp">#define DEFAULT_RSSI		-128</span>

<span class="cm">/*</span>
<span class="cm"> * Helper struct and macro to work with moving/walking averages.</span>
<span class="cm"> * When adding a value to the average value the following calculation</span>
<span class="cm"> * is needed:</span>
<span class="cm"> *</span>
<span class="cm"> *        avg_rssi = ((avg_rssi * 7) + rssi) / 8;</span>
<span class="cm"> *</span>
<span class="cm"> * The advantage of this approach is that we only need 1 variable</span>
<span class="cm"> * to store the average in (No need for a count and a total).</span>
<span class="cm"> * But more importantly, normal average values will over time</span>
<span class="cm"> * move less and less towards newly added values this results</span>
<span class="cm"> * that with link tuning, the device can have a very good RSSI</span>
<span class="cm"> * for a few minutes but when the device is moved away from the AP</span>
<span class="cm"> * the average will not decrease fast enough to compensate.</span>
<span class="cm"> * The walking average compensates this and will move towards</span>
<span class="cm"> * the new values correctly allowing a effective link tuning,</span>
<span class="cm"> * the speed of the average moving towards other values depends</span>
<span class="cm"> * on the value for the number of samples. The higher the number</span>
<span class="cm"> * of samples, the slower the average will move.</span>
<span class="cm"> * We use two variables to keep track of the average value to</span>
<span class="cm"> * compensate for the rounding errors. This can be a significant</span>
<span class="cm"> * error (&gt;5dBm) if the factor is too low.</span>
<span class="cm"> */</span>
<span class="cp">#define AVG_SAMPLES	8</span>
<span class="cp">#define AVG_FACTOR	1000</span>
<span class="cp">#define MOVING_AVERAGE(__avg, __val) \</span>
<span class="cp">({ \</span>
<span class="cp">	struct avg_val __new; \</span>
<span class="cp">	__new.avg_weight = \</span>
<span class="cp">	    (__avg).avg_weight  ? \</span>
<span class="cp">		((((__avg).avg_weight * ((AVG_SAMPLES) - 1)) + \</span>
<span class="cp">		  ((__val) * (AVG_FACTOR))) / \</span>
<span class="cp">		 (AVG_SAMPLES)) : \</span>
<span class="cp">		((__val) * (AVG_FACTOR)); \</span>
<span class="cp">	__new.avg = __new.avg_weight / (AVG_FACTOR); \</span>
<span class="cp">	__new; \</span>
<span class="cp">})</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2x00link_antenna_get_link_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link_ant</span> <span class="o">*</span><span class="n">ant</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">rssi_ant</span><span class="p">.</span><span class="n">avg</span> <span class="o">&amp;&amp;</span> <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">rx_success</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ant</span><span class="o">-&gt;</span><span class="n">rssi_ant</span><span class="p">.</span><span class="n">avg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">DEFAULT_RSSI</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rt2x00link_antenna_get_rssi_history</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link_ant</span> <span class="o">*</span><span class="n">ant</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">rssi_history</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ant</span><span class="o">-&gt;</span><span class="n">rssi_history</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">DEFAULT_RSSI</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00link_antenna_update_rssi_history</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
						   <span class="kt">int</span> <span class="n">rssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link_ant</span> <span class="o">*</span><span class="n">ant</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">;</span>
	<span class="n">ant</span><span class="o">-&gt;</span><span class="n">rssi_history</span> <span class="o">=</span> <span class="n">rssi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00link_antenna_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">.</span><span class="n">rssi_ant</span><span class="p">.</span><span class="n">avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">.</span><span class="n">rssi_ant</span><span class="p">.</span><span class="n">avg_weight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_antenna_diversity_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link_ant</span> <span class="o">*</span><span class="n">ant</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">antenna_setup</span> <span class="n">new_ant</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">other_antenna</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">sample_current</span> <span class="o">=</span> <span class="n">rt2x00link_antenna_get_link_rssi</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sample_other</span> <span class="o">=</span> <span class="n">rt2x00link_antenna_get_rssi_history</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ant</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_ant</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are done sampling. Now we should evaluate the results.</span>
<span class="cm">	 */</span>
	<span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ANTENNA_MODE_SAMPLE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * During the last period we have sampled the RSSI</span>
<span class="cm">	 * from both antennas. It now is time to determine</span>
<span class="cm">	 * which antenna demonstrated the best performance.</span>
<span class="cm">	 * When we are already on the antenna with the best</span>
<span class="cm">	 * performance, just create a good starting point</span>
<span class="cm">	 * for the history and we are done.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sample_current</span> <span class="o">&gt;=</span> <span class="n">sample_other</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00link_antenna_update_rssi_history</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span>
			<span class="n">sample_current</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">other_antenna</span> <span class="o">=</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">rx</span> <span class="o">==</span> <span class="n">ANTENNA_A</span><span class="p">)</span> <span class="o">?</span> <span class="n">ANTENNA_B</span> <span class="o">:</span> <span class="n">ANTENNA_A</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANTENNA_RX_DIVERSITY</span><span class="p">)</span>
		<span class="n">new_ant</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">other_antenna</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANTENNA_TX_DIVERSITY</span><span class="p">)</span>
		<span class="n">new_ant</span><span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">other_antenna</span><span class="p">;</span>

	<span class="n">rt2x00lib_config_antenna</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">new_ant</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00lib_antenna_diversity_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link_ant</span> <span class="o">*</span><span class="n">ant</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">antenna_setup</span> <span class="n">new_ant</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rssi_curr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rssi_old</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ant</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">new_ant</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get current RSSI value along with the historical value,</span>
<span class="cm">	 * after that update the history with the current value.</span>
<span class="cm">	 */</span>
	<span class="n">rssi_curr</span> <span class="o">=</span> <span class="n">rt2x00link_antenna_get_link_rssi</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rssi_old</span> <span class="o">=</span> <span class="n">rt2x00link_antenna_get_rssi_history</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
	<span class="n">rt2x00link_antenna_update_rssi_history</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">rssi_curr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Legacy driver indicates that we should swap antenna&#39;s</span>
<span class="cm">	 * when the difference in RSSI is greater that 5. This</span>
<span class="cm">	 * also should be done when the RSSI was actually better</span>
<span class="cm">	 * then the previous sample.</span>
<span class="cm">	 * When the difference exceeds the threshold we should</span>
<span class="cm">	 * sample the rssi from the other antenna to make a valid</span>
<span class="cm">	 * comparison between the 2 antennas.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">rssi_curr</span> <span class="o">-</span> <span class="n">rssi_old</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ANTENNA_MODE_SAMPLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANTENNA_RX_DIVERSITY</span><span class="p">)</span>
		<span class="n">new_ant</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_ant</span><span class="p">.</span><span class="n">rx</span> <span class="o">==</span> <span class="n">ANTENNA_A</span><span class="p">)</span> <span class="o">?</span> <span class="n">ANTENNA_B</span> <span class="o">:</span> <span class="n">ANTENNA_A</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANTENNA_TX_DIVERSITY</span><span class="p">)</span>
		<span class="n">new_ant</span><span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_ant</span><span class="p">.</span><span class="n">tx</span> <span class="o">==</span> <span class="n">ANTENNA_A</span><span class="p">)</span> <span class="o">?</span> <span class="n">ANTENNA_B</span> <span class="o">:</span> <span class="n">ANTENNA_A</span><span class="p">;</span>

	<span class="n">rt2x00lib_config_antenna</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">new_ant</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rt2x00lib_antenna_diversity</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link_ant</span> <span class="o">*</span><span class="n">ant</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Determine if software diversity is enabled for</span>
<span class="cm">	 * either the TX or RX antenna (or both).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANTENNA_RX_DIVERSITY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANTENNA_TX_DIVERSITY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we have only sampled the data over the last period</span>
<span class="cm">	 * we should now harvest the data. Otherwise just evaluate</span>
<span class="cm">	 * the data. The latter should only be performed once</span>
<span class="cm">	 * every 2 seconds.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ANTENNA_MODE_SAMPLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00lib_antenna_diversity_sample</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rt2x00lib_antenna_diversity_eval</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00link_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">rxdone_entry_desc</span> <span class="o">*</span><span class="n">rxdesc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_qual</span> <span class="o">*</span><span class="n">qual</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">qual</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_ant</span> <span class="o">*</span><span class="n">ant</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">ant</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No need to update the stats for !=STA interfaces</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_sta_count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Frame was received successfully since non-succesfull</span>
<span class="cm">	 * frames would have been dropped by the hardware.</span>
<span class="cm">	 */</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">rx_success</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are only interested in quality statistics from</span>
<span class="cm">	 * beacons which came from the BSS which we are</span>
<span class="cm">	 * associated with.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">RXDONE_MY_BSS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update global RSSI</span>
<span class="cm">	 */</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">avg_rssi</span> <span class="o">=</span> <span class="n">MOVING_AVERAGE</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">avg_rssi</span><span class="p">,</span> <span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update antenna RSSI</span>
<span class="cm">	 */</span>
	<span class="n">ant</span><span class="o">-&gt;</span><span class="n">rssi_ant</span> <span class="o">=</span> <span class="n">MOVING_AVERAGE</span><span class="p">(</span><span class="n">ant</span><span class="o">-&gt;</span><span class="n">rssi_ant</span><span class="p">,</span> <span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00link_start_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Link tuning should only be performed when</span>
<span class="cm">	 * an active sta interface exists. AP interfaces</span>
<span class="cm">	 * don&#39;t need link tuning and monitor mode interfaces</span>
<span class="cm">	 * should never have to work with link tuners.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">intf_sta_count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * While scanning, link tuning is disabled. By default</span>
<span class="cm">	 * the most sensitive settings will be used to make sure</span>
<span class="cm">	 * that all beacons and probe responses will be received</span>
<span class="cm">	 * during the scan.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rt2x00link_reset_tuner</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">LINK_TUNE_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00link_stop_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00link_reset_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">antenna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link_qual</span> <span class="o">*</span><span class="n">qual</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">qual</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vgc_level</span> <span class="o">=</span> <span class="n">qual</span><span class="o">-&gt;</span><span class="n">vgc_level_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset link information.</span>
<span class="cm">	 * Both the currently active vgc level as well as</span>
<span class="cm">	 * the link tuner counter should be reset. Resetting</span>
<span class="cm">	 * the counter is important for devices where the</span>
<span class="cm">	 * device should only perform link tuning during the</span>
<span class="cm">	 * first minute after being enabled.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">qual</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qual</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Restore the VGC level as stored in the registers,</span>
<span class="cm">	 * the driver can use this to determine if the register</span>
<span class="cm">	 * must be updated during reset or not.</span>
<span class="cm">	 */</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">vgc_level_reg</span> <span class="o">=</span> <span class="n">vgc_level</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the link tuner.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">reset_tuner</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">qual</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">antenna</span><span class="p">)</span>
		<span class="n">rt2x00link_antenna_reset</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00link_reset_qual</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link_qual</span> <span class="o">*</span><span class="n">qual</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">qual</span><span class="p">;</span>

	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">rx_success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">rx_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">tx_success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">qual</span><span class="o">-&gt;</span><span class="n">tx_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00link_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt2x00_dev</span><span class="p">,</span> <span class="n">link</span><span class="p">.</span><span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">link_qual</span> <span class="o">*</span><span class="n">qual</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">qual</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * When the radio is shutting down we should</span>
<span class="cm">	 * immediately cease all link tuning.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update statistics.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">link_stats</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">qual</span><span class="p">);</span>
	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">low_level_stats</span><span class="p">.</span><span class="n">dot11FCSErrorCount</span> <span class="o">+=</span> <span class="n">qual</span><span class="o">-&gt;</span><span class="n">rx_failed</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update quality RSSI for link tuning,</span>
<span class="cm">	 * when we have received some frames and we managed to</span>
<span class="cm">	 * collect the RSSI data we could use this. Otherwise we</span>
<span class="cm">	 * must fallback to the default RSSI value.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">avg_rssi</span><span class="p">.</span><span class="n">avg</span> <span class="o">||</span> <span class="o">!</span><span class="n">qual</span><span class="o">-&gt;</span><span class="n">rx_success</span><span class="p">)</span>
		<span class="n">qual</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">DEFAULT_RSSI</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qual</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">avg_rssi</span><span class="p">.</span><span class="n">avg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if link tuning is supported by the hardware, some hardware</span>
<span class="cm">	 * do not support link tuning at all, while other devices can disable</span>
<span class="cm">	 * the feature from the EEPROM.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_LINK_TUNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">link_tuner</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">qual</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send a signal to the led to update the led signal strength.</span>
<span class="cm">	 */</span>
	<span class="n">rt2x00leds_led_quality</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">,</span> <span class="n">qual</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Evaluate antenna setup, make this the last step when</span>
<span class="cm">	 * rt2x00lib_antenna_diversity made changes the quality</span>
<span class="cm">	 * statistics will be reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rt2x00lib_antenna_diversity</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">))</span>
		<span class="n">rt2x00link_reset_qual</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Increase tuner counter, and reschedule the next link tuner run.</span>
<span class="cm">	 */</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">LINK_TUNE_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00link_start_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">)</span>
		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">watchdog_work</span><span class="p">,</span>
					     <span class="n">WATCHDOG_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00link_stop_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">watchdog_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00link_watchdog</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt2x00_dev</span><span class="p">,</span> <span class="n">link</span><span class="p">.</span><span class="n">watchdog_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * When the radio is shutting down we should</span>
<span class="cm">	 * immediately cease the watchdog monitoring.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">watchdog_work</span><span class="p">,</span>
					     <span class="n">WATCHDOG_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00link_start_agc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">gain_calibration</span><span class="p">)</span>
		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">agc_work</span><span class="p">,</span>
					     <span class="n">AGC_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00link_start_vcocal</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">vco_calibration</span><span class="p">)</span>
		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">vco_work</span><span class="p">,</span>
					     <span class="n">VCO_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00link_stop_agc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">agc_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00link_stop_vcocal</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">vco_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00link_agc</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt2x00_dev</span><span class="p">,</span> <span class="n">link</span><span class="p">.</span><span class="n">agc_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * When the radio is shutting down we should</span>
<span class="cm">	 * immediately cease the watchdog monitoring.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">gain_calibration</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">agc_work</span><span class="p">,</span>
					     <span class="n">AGC_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rt2x00link_vcocal</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rt2x00_dev</span><span class="p">,</span> <span class="n">link</span><span class="p">.</span><span class="n">vco_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">link</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * When the radio is shutting down we should</span>
<span class="cm">	 * immediately cease the VCO calibration.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_ENABLED_RADIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">vco_calibration</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">DEVICE_STATE_PRESENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">vco_work</span><span class="p">,</span>
					     <span class="n">VCO_INTERVAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rt2x00link_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rt2x00_dev</span> <span class="o">*</span><span class="n">rt2x00dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">agc_work</span><span class="p">,</span> <span class="n">rt2x00link_agc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CAPABILITY_VCO_RECALIBRATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">cap_flags</span><span class="p">))</span>
		<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">vco_work</span><span class="p">,</span> <span class="n">rt2x00link_vcocal</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">watchdog_work</span><span class="p">,</span> <span class="n">rt2x00link_watchdog</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rt2x00dev</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="n">rt2x00link_tuner</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
