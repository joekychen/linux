<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › iwlwifi › iwl-agn-rxon.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>iwl-agn-rxon.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2003 - 2012 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> * Intel Linux Wireless &lt;ilw@linux.intel.com&gt;</span>
<span class="cm"> * Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &quot;iwl-dev.h&quot;</span>
<span class="cp">#include &quot;iwl-agn.h&quot;</span>
<span class="cp">#include &quot;iwl-agn-calib.h&quot;</span>
<span class="cp">#include &quot;iwl-trans.h&quot;</span>
<span class="cp">#include &quot;iwl-modparams.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * initialize rxon structure with default values from eeprom</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iwl_connection_init_rx_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iwl_channel_info</span> <span class="o">*</span><span class="n">ch_info</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">unused_devtype</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ap_devtype</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">station_devtype</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="n">RXON_FILTER_ACCEPT_GRP_MSK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ibss_devtype</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RXON_FLG_SHORT_PREAMBLE_MSK</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="n">RXON_FILTER_BCON_AWARE_MSK</span> <span class="o">|</span>
						  <span class="n">RXON_FILTER_ACCEPT_GRP_MSK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">RXON_DEV_TYPE_SNIFFER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Unsupported interface type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* TODO:  Figure out when short_preamble would be set and cache from</span>
<span class="c">	 * that */</span>
<span class="c">	if (!hw_to_local(priv-&gt;hw)-&gt;short_preamble)</span>
<span class="c">		ctx-&gt;staging.flags &amp;= ~RXON_FLG_SHORT_PREAMBLE_MSK;</span>
<span class="c">	else</span>
<span class="c">		ctx-&gt;staging.flags |= RXON_FLG_SHORT_PREAMBLE_MSK;</span>
<span class="cp">#endif</span>

	<span class="n">ch_info</span> <span class="o">=</span> <span class="n">iwl_get_channel_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span>
				       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">channel</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ch_info</span><span class="p">)</span>
		<span class="n">ch_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ch_info</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">ch_info</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>

	<span class="n">iwl_set_flags_for_band</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>

	<span class="cm">/* clear both MIX and PURE40 mode flag */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RXON_FLG_CHANNEL_MODE_MIXED</span> <span class="o">|</span>
					<span class="n">RXON_FLG_CHANNEL_MODE_PURE_40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">node_addr</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">ofdm_ht_single_stream_basic_rates</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">ofdm_ht_dual_stream_basic_rates</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">ofdm_ht_triple_stream_basic_rates</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwlagn_disable_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">send</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">old_filter</span> <span class="o">=</span> <span class="n">send</span><span class="o">-&gt;</span><span class="n">filter_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">send</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rxon_cmd</span><span class="p">,</span>
				<span class="n">CMD_SYNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">send</span><span class="p">),</span> <span class="n">send</span><span class="p">);</span>

	<span class="n">send</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="n">old_filter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IWL_DEBUG_QUIET_RFKILL</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="s">&quot;Error clearing ASSOC_MSK on BSS (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwlagn_disable_pan</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">send</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_notification_wait</span> <span class="n">disable_wait</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">old_filter</span> <span class="o">=</span> <span class="n">send</span><span class="o">-&gt;</span><span class="n">filter_flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">old_dev_type</span> <span class="o">=</span> <span class="n">send</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">deactivate_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">REPLY_WIPAN_DEACTIVATION_COMPLETE</span>
	<span class="p">};</span>

	<span class="n">iwl_init_notification_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">notif_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disable_wait</span><span class="p">,</span>
				   <span class="n">deactivate_cmd</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">deactivate_cmd</span><span class="p">),</span>
				   <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">send</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
	<span class="n">send</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">RXON_DEV_TYPE_P2P</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rxon_cmd</span><span class="p">,</span>
				<span class="n">CMD_SYNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">send</span><span class="p">),</span> <span class="n">send</span><span class="p">);</span>

	<span class="n">send</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="n">old_filter</span><span class="p">;</span>
	<span class="n">send</span><span class="o">-&gt;</span><span class="n">dev_type</span> <span class="o">=</span> <span class="n">old_dev_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Error disabling PAN (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">iwl_remove_notification</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">notif_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">disable_wait</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_wait_notification</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">notif_wait</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">disable_wait</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Timed out waiting for PAN disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwlagn_disconn_pan</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">send</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">old_filter</span> <span class="o">=</span> <span class="n">send</span><span class="o">-&gt;</span><span class="n">filter_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">send</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rxon_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">send</span><span class="p">),</span> <span class="n">send</span><span class="p">);</span>

	<span class="n">send</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="n">old_filter</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_update_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">is_active</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm</span><span class="p">.</span><span class="n">qos_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_active</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm</span><span class="p">.</span><span class="n">qos_flags</span> <span class="o">|=</span>
			<span class="n">QOS_PARAM_FLG_UPDATE_EDCA_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm</span><span class="p">.</span><span class="n">qos_flags</span> <span class="o">|=</span> <span class="n">QOS_PARAM_FLG_TGN_MSK</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;send QoS cmd with Qos active=%d FLAGS=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_active</span><span class="p">,</span>
		      <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm</span><span class="p">.</span><span class="n">qos_flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">qos_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_qosparam_cmd</span><span class="p">),</span>
			       <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">def_qos_parm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IWL_DEBUG_QUIET_RFKILL</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed to update QoS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_update_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_skb</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">iwlagn_send_beacon_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwlagn_send_rxon_assoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_assoc_cmd</span> <span class="n">rxon_assoc</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">rxon1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">rxon2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rxon1</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">rxon2</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxon1</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">==</span> <span class="n">rxon2</span><span class="o">-&gt;</span><span class="n">filter_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxon1</span><span class="o">-&gt;</span><span class="n">cck_basic_rates</span> <span class="o">==</span> <span class="n">rxon2</span><span class="o">-&gt;</span><span class="n">cck_basic_rates</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxon1</span><span class="o">-&gt;</span><span class="n">ofdm_ht_single_stream_basic_rates</span> <span class="o">==</span>
	     <span class="n">rxon2</span><span class="o">-&gt;</span><span class="n">ofdm_ht_single_stream_basic_rates</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxon1</span><span class="o">-&gt;</span><span class="n">ofdm_ht_dual_stream_basic_rates</span> <span class="o">==</span>
	     <span class="n">rxon2</span><span class="o">-&gt;</span><span class="n">ofdm_ht_dual_stream_basic_rates</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxon1</span><span class="o">-&gt;</span><span class="n">ofdm_ht_triple_stream_basic_rates</span> <span class="o">==</span>
	     <span class="n">rxon2</span><span class="o">-&gt;</span><span class="n">ofdm_ht_triple_stream_basic_rates</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxon1</span><span class="o">-&gt;</span><span class="n">acquisition_data</span> <span class="o">==</span> <span class="n">rxon2</span><span class="o">-&gt;</span><span class="n">acquisition_data</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxon1</span><span class="o">-&gt;</span><span class="n">rx_chain</span> <span class="o">==</span> <span class="n">rxon2</span><span class="o">-&gt;</span><span class="n">rx_chain</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxon1</span><span class="o">-&gt;</span><span class="n">ofdm_basic_rates</span> <span class="o">==</span> <span class="n">rxon2</span><span class="o">-&gt;</span><span class="n">ofdm_basic_rates</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Using current RXON_ASSOC.  Not resending.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span><span class="p">;</span>
	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">ofdm_basic_rates</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">ofdm_basic_rates</span><span class="p">;</span>
	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">cck_basic_rates</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">cck_basic_rates</span><span class="p">;</span>
	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">reserved1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">reserved2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">reserved3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">ofdm_ht_single_stream_basic_rates</span> <span class="o">=</span>
	    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">ofdm_ht_single_stream_basic_rates</span><span class="p">;</span>
	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">ofdm_ht_dual_stream_basic_rates</span> <span class="o">=</span>
	    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">ofdm_ht_dual_stream_basic_rates</span><span class="p">;</span>
	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">rx_chain_select_flags</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">rx_chain</span><span class="p">;</span>
	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">ofdm_ht_triple_stream_basic_rates</span> <span class="o">=</span>
		 <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">ofdm_ht_triple_stream_basic_rates</span><span class="p">;</span>
	<span class="n">rxon_assoc</span><span class="p">.</span><span class="n">acquisition_data</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">acquisition_data</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rxon_assoc_cmd</span><span class="p">,</span>
				<span class="n">CMD_ASYNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxon_assoc</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rxon_assoc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">iwl_adjust_beacon_interval</span><span class="p">(</span><span class="n">u16</span> <span class="n">beacon_val</span><span class="p">,</span> <span class="n">u16</span> <span class="n">max_beacon_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">new_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">beacon_factor</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If mac80211 hasn&#39;t given us a beacon interval, program</span>
<span class="cm">	 * the default into the device (not checking this here</span>
<span class="cm">	 * would cause the adjustment below to return the maximum</span>
<span class="cm">	 * value, which may break PAN.)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beacon_val</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">DEFAULT_BEACON_INTERVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the beacon interval we obtained from the peer</span>
<span class="cm">	 * is too large, we&#39;ll have to wake up more often</span>
<span class="cm">	 * (and in IBSS case, we&#39;ll beacon too much)</span>
<span class="cm">	 *</span>
<span class="cm">	 * For example, if max_beacon_val is 4096, and the</span>
<span class="cm">	 * requested beacon interval is 7000, we&#39;ll have to</span>
<span class="cm">	 * use 3500 to be able to wake up on the beacons.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This could badly influence beacon detection stats.</span>
<span class="cm">	 */</span>

	<span class="n">beacon_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">beacon_val</span> <span class="o">+</span> <span class="n">max_beacon_val</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_beacon_val</span><span class="p">;</span>
	<span class="n">new_val</span> <span class="o">=</span> <span class="n">beacon_val</span> <span class="o">/</span> <span class="n">beacon_factor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_val</span><span class="p">)</span>
		<span class="n">new_val</span> <span class="o">=</span> <span class="n">max_beacon_val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">new_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_send_rxon_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tsf</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">interval_tm</span><span class="p">,</span> <span class="n">rem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">beacon_int</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">;</span>

	<span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_rxon_time_cmd</span><span class="p">));</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">);</span>

	<span class="n">beacon_int</span> <span class="o">=</span> <span class="n">vif</span> <span class="o">?</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: For IBSS we need to get atim_window from mac80211,</span>
<span class="cm">	 *	 for now just always use 0</span>
<span class="cm">	 */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">atim_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxid</span> <span class="o">==</span> <span class="n">IWL_RXON_CTX_PAN</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">||</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">iwl_is_associated</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IWL_RXON_CTX_BSS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">].</span><span class="n">vif</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">].</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">].</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">;</span>
		<span class="n">beacon_int</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxid</span> <span class="o">==</span> <span class="n">IWL_RXON_CTX_BSS</span> <span class="o">&amp;&amp;</span>
		   <span class="n">iwl_is_associated</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IWL_RXON_CTX_PAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_PAN</span><span class="p">].</span><span class="n">vif</span> <span class="o">&amp;&amp;</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_PAN</span><span class="p">].</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="o">!</span><span class="n">iwl_is_associated_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_PAN</span><span class="p">].</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">;</span>
		<span class="n">beacon_int</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">beacon_int</span> <span class="o">=</span> <span class="n">iwl_adjust_beacon_interval</span><span class="p">(</span><span class="n">beacon_int</span><span class="p">,</span>
			<span class="n">IWL_MAX_UCODE_BEACON_INTERVAL</span> <span class="o">*</span> <span class="n">TIME_UNIT</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">beacon_int</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">beacon_int</span> <span class="o">=</span> <span class="n">beacon_int</span><span class="p">;</span>

	<span class="n">tsf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">;</span> <span class="cm">/* tsf is modifed by do_div: copy it */</span>
	<span class="n">interval_tm</span> <span class="o">=</span> <span class="n">beacon_int</span> <span class="o">*</span> <span class="n">TIME_UNIT</span><span class="p">;</span>
	<span class="n">rem</span> <span class="o">=</span> <span class="n">do_div</span><span class="p">(</span><span class="n">tsf</span><span class="p">,</span> <span class="n">interval_tm</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_init_val</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">interval_tm</span> <span class="o">-</span> <span class="n">rem</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">vif</span> <span class="o">?</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">dtim_period</span> <span class="o">?:</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_ASSOC</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="s">&quot;beacon interval %d beacon timer %d beacon tim %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_init_val</span><span class="p">),</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">atim_window</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rxon_timing_cmd</span><span class="p">,</span>
				<span class="n">CMD_SYNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwlagn_rxon_disconn</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxid</span> <span class="o">==</span> <span class="n">IWL_RXON_CTX_BSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_disable_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_disable_pan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_send_rxon_timing</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed to send timing (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_disconn_pan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Un-assoc RXON clears the station table and WEP</span>
<span class="cm">	 * keys, so we have to restore those afterwards.</span>
<span class="cm">	 */</span>
	<span class="n">iwl_clear_ucode_stations</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="cm">/* update -- might need P2P now */</span>
	<span class="n">iwl_update_bcast_station</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="n">iwl_restore_stations</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_restore_default_wep_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed to restore WEP keys (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">active</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_set_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">s8</span> <span class="n">tx_power</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">prev_tx_power</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">defer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">calib_disabled</span> <span class="o">&amp;</span> <span class="n">IWL_TX_POWER_CALIB_DISABLED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_user_lmt</span> <span class="o">==</span> <span class="n">tx_power</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_power</span> <span class="o">&lt;</span> <span class="n">IWLAGN_TX_POWER_TARGET_POWER_MIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			 <span class="s">&quot;Requested user TXPOWER %d below lower limit %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tx_power</span><span class="p">,</span>
			 <span class="n">IWLAGN_TX_POWER_TARGET_POWER_MIN</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_power</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_device_lmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="s">&quot;Requested user TXPOWER %d above upper limit %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tx_power</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_device_lmt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwl_is_ready_rf</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* scan complete and commit_rxon use tx_power_next value,</span>
<span class="cm">	 * it always need to be updated for newest request */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_next</span> <span class="o">=</span> <span class="n">tx_power</span><span class="p">;</span>

	<span class="cm">/* do not set tx power when scanning or channel changing */</span>
	<span class="n">defer</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">defer</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Deferring tx power set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prev_tx_power</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_user_lmt</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_user_lmt</span> <span class="o">=</span> <span class="n">tx_power</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_send_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* if fail to set tx_power, restore the orig. tx power */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_user_lmt</span> <span class="o">=</span> <span class="n">prev_tx_power</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_next</span> <span class="o">=</span> <span class="n">prev_tx_power</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwlagn_rxon_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>

	<span class="cm">/* RXON timing must be before associated RXON */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxid</span> <span class="o">==</span> <span class="n">IWL_RXON_CTX_BSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_send_rxon_timing</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Failed to send timing (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* QoS info may be cleared by previous un-assoc RXON */</span>
	<span class="n">iwlagn_update_qos</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;ll run into this code path when beaconing is</span>
<span class="cm">	 * enabled, but then we also need to send the beacon</span>
<span class="cm">	 * to the device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_update_beacon</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				<span class="s">&quot;Error sending required beacon (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_calib</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Apply the new configuration.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Associated RXON doesn&#39;t clear the station table in uCode,</span>
<span class="cm">	 * so we don&#39;t need to restore stations etc. after this.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rxon_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">,</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_rxon_cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Error setting new RXON (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">active</span><span class="p">));</span>

	<span class="cm">/* IBSS beacon needs to be sent after setting assoc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iwlagn_update_beacon</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Error sending IBSS beacon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">iwl_init_sensitivity</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we issue a new RXON command which required a tune then</span>
<span class="cm">	 * we must send a new TXPOWER command or we won&#39;t be able to</span>
<span class="cm">	 * Tx any frames.</span>
<span class="cm">	 *</span>
<span class="cm">	 * It&#39;s expected we set power here if channel is changing.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_set_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_next</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Error sending TX power (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ht_params</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ht_params</span><span class="o">-&gt;</span><span class="n">smps_mode</span><span class="p">)</span>
		<span class="n">ieee80211_request_smps</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span>
				       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ht_params</span><span class="o">-&gt;</span><span class="n">smps_mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_set_pan_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_wipan_params_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx_bss</span><span class="p">,</span> <span class="o">*</span><span class="n">ctx_pan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot0</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="n">slot1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">valid_contexts</span> <span class="o">==</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">NUM_IWL_RXON_CTX</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ctx_bss</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">];</span>
	<span class="n">ctx_pan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_PAN</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the PAN context is inactive, then we don&#39;t need</span>
<span class="cm">	 * to update the PAN parameters, the last thing we&#39;ll</span>
<span class="cm">	 * have done before it goes inactive is making the PAN</span>
<span class="cm">	 * parameters be WLAN-only.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx_pan</span><span class="o">-&gt;</span><span class="n">is_active</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="cm">/* only 2 slots are currently allowed */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">num_slots</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* BSS */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">slots</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* PAN */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_setup</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* both contexts must be used for this to happen */</span>
		<span class="n">slot1</span> <span class="o">=</span> <span class="n">IWL_MIN_SLOT_TIME</span><span class="p">;</span>
		<span class="n">slot0</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx_bss</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="n">ctx_pan</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bcnint</span> <span class="o">=</span> <span class="n">ctx_pan</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">dtim</span> <span class="o">=</span> <span class="n">ctx_pan</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">dtim_period</span> <span class="o">?:</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* should be set, but seems unused?? */</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IWL_WIPAN_PARAMS_FLG_SLOTTED_MODE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctx_pan</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
		    <span class="n">bcnint</span> <span class="o">&amp;&amp;</span>
		    <span class="n">bcnint</span> <span class="o">!=</span> <span class="n">ctx_bss</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				<span class="s">&quot;beacon intervals don&#39;t match (%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ctx_bss</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">,</span> <span class="n">ctx_pan</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bcnint</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">bcnint</span><span class="p">,</span>
				       <span class="n">ctx_bss</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bcnint</span><span class="p">)</span>
			<span class="n">bcnint</span> <span class="o">=</span> <span class="n">DEFAULT_BEACON_INTERVAL</span><span class="p">;</span>
		<span class="n">slot0</span> <span class="o">=</span> <span class="n">bcnint</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">slot1</span> <span class="o">=</span> <span class="n">bcnint</span> <span class="o">-</span> <span class="n">slot0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">ctx_bss</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">idle</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">ctx_bss</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">assoc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">slot0</span> <span class="o">=</span> <span class="n">dtim</span> <span class="o">*</span> <span class="n">bcnint</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">IWL_MIN_SLOT_TIME</span><span class="p">;</span>
			<span class="n">slot1</span> <span class="o">=</span> <span class="n">IWL_MIN_SLOT_TIME</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx_pan</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">idle</span> <span class="o">&amp;&amp;</span>
			   <span class="o">!</span><span class="n">ctx_pan</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">slot1</span> <span class="o">=</span> <span class="n">dtim</span> <span class="o">*</span> <span class="n">bcnint</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">IWL_MIN_SLOT_TIME</span><span class="p">;</span>
			<span class="n">slot0</span> <span class="o">=</span> <span class="n">IWL_MIN_SLOT_TIME</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx_pan</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slot0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">slot1</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ctx_pan</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">dtim_period</span><span class="p">)</span> <span class="o">*</span>
					<span class="n">ctx_pan</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">;</span>
		<span class="n">slot1</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">DEFAULT_BEACON_INTERVAL</span><span class="p">,</span> <span class="n">slot1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">slot0</span> <span class="o">=</span> <span class="n">slot1</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">IWL_MIN_SLOT_TIME</span><span class="p">;</span>
			<span class="n">slot1</span> <span class="o">=</span> <span class="n">IWL_MIN_SLOT_TIME</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">slots</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">width</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">slot0</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">slots</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">width</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">slot1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">REPLY_WIPAN_PARAMS</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Error setting PAN parameters (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_iwl_set_rxon_ht</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iwl_ht_config</span> <span class="o">*</span><span class="n">ht_conf</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">rxon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RXON_FLG_CHANNEL_MODE_MSK</span> <span class="o">|</span>
			<span class="n">RXON_FLG_CTRL_CHANNEL_LOC_HI_MSK</span> <span class="o">|</span>
			<span class="n">RXON_FLG_HT40_PROT_MSK</span> <span class="o">|</span>
			<span class="n">RXON_FLG_HT_PROT_MSK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: if the definition of ht.protection changed, the &quot;translation&quot;</span>
<span class="cm">	 * will be needed for rxon-&gt;flags</span>
<span class="cm">	 */</span>
	<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">protection</span> <span class="o">&lt;&lt;</span>
				   <span class="n">RXON_FLG_HT_OPERATING_MODE_POS</span><span class="p">);</span>

	<span class="cm">/* Set up channel bandwidth:</span>
<span class="cm">	 * 20 MHz only, 20/40 mixed or pure 40 if ht40 ok */</span>
	<span class="cm">/* clear the HT channel mode before set the mode */</span>
	<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RXON_FLG_CHANNEL_MODE_MSK</span> <span class="o">|</span>
			 <span class="n">RXON_FLG_CTRL_CHANNEL_LOC_HI_MSK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iwl_is_ht40_tx_allowed</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* pure ht40 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">protection</span> <span class="o">==</span>
		    <span class="n">IEEE80211_HT_OP_MODE_PROTECTION_20MHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_CHANNEL_MODE_PURE_40</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Note: control channel is opposite of extension</span>
<span class="cm">			 * channel</span>
<span class="cm">			 */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">extension_chan_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_ABOVE</span>:
				<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="n">RXON_FLG_CTRL_CHANNEL_LOC_HI_MSK</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_BELOW</span>:
				<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
					<span class="n">RXON_FLG_CTRL_CHANNEL_LOC_HI_MSK</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Note: control channel is opposite of extension</span>
<span class="cm">			 * channel</span>
<span class="cm">			 */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">extension_chan_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_ABOVE</span>:
				<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>
					<span class="o">~</span><span class="p">(</span><span class="n">RXON_FLG_CTRL_CHANNEL_LOC_HI_MSK</span><span class="p">);</span>
				<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_CHANNEL_MODE_MIXED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_BELOW</span>:
				<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_CTRL_CHANNEL_LOC_HI_MSK</span><span class="p">;</span>
				<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_CHANNEL_MODE_MIXED</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">IEEE80211_HT_PARAM_CHA_SEC_NONE</span>:
			<span class="nl">default:</span>
				<span class="cm">/*</span>
<span class="cm">				 * channel location only valid if in Mixed</span>
<span class="cm">				 * mode</span>
<span class="cm">				 */</span>
				<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					<span class="s">&quot;invalid extension channel offset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_CHANNEL_MODE_LEGACY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iwlagn_set_rxon_chain</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_ASSOC</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;rxon flags 0x%X operation mode :0x%X &quot;</span>
			<span class="s">&quot;extension channel offset 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">protection</span><span class="p">,</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">extension_chan_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwl_set_rxon_ht</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwl_ht_config</span> <span class="o">*</span><span class="n">ht_conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

	<span class="n">for_each_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
		<span class="n">_iwl_set_rxon_ht</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ht_conf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iwl_set_rxon_channel - Set the band and channel values in staging RXON</span>
<span class="cm"> * @ch: requested channel as a pointer to struct ieee80211_channel</span>

<span class="cm"> * NOTE:  Does not commit to the hardware; it sets appropriate bit fields</span>
<span class="cm"> * in the staging RXON flag structure based on the ch-&gt;band</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iwl_set_rxon_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="n">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">band</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FLG_BAND_24G_MSK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_BAND_24G_MSK</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Staging channel set to %d [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwl_set_flags_for_band</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span>
		    <span class="o">~</span><span class="p">(</span><span class="n">RXON_FLG_BAND_24G_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_AUTO_DETECT_MSK</span>
		      <span class="o">|</span> <span class="n">RXON_FLG_CCK_MSK</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Copied from iwl_post_associate() */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_slot</span><span class="p">)</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">;</span>

		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_BAND_24G_MSK</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_AUTO_DETECT_MSK</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FLG_CCK_MSK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwl_set_rxon_hwcrypto</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hw_decrypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">rxon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw_decrypt</span><span class="p">)</span>
		<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FILTER_DIS_DECRYPT_MSK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="n">RXON_FILTER_DIS_DECRYPT_MSK</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/* validate RXON structure is valid */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_check_rxon_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">rxon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_BAND_24G_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_TGJ_NARROW_BAND_MSK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;check 2.4G: wrong narrow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">errors</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_RADAR_DETECT_MSK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;check 2.4G: wrong radar</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">errors</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;check 5.2G: not short slot!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">errors</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_CCK_MSK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;check 5.2G: CCK!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">errors</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">node_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="n">rxon</span><span class="o">-&gt;</span><span class="n">bssid_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;mac/bssid mcast!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">errors</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* make sure basic rates 6Mbps and 1Mbps are supported */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">ofdm_basic_rates</span> <span class="o">&amp;</span> <span class="n">IWL_RATE_6M_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">cck_basic_rates</span> <span class="o">&amp;</span> <span class="n">IWL_RATE_1M_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;neither 1 nor 6 are basic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">errors</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2007</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;aid &gt; 2007</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">errors</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXON_FLG_CCK_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">))</span>
			<span class="o">==</span> <span class="p">(</span><span class="n">RXON_FLG_CCK_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;CCK and short slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">errors</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXON_FLG_CCK_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_AUTO_DETECT_MSK</span><span class="p">))</span>
			<span class="o">==</span> <span class="p">(</span><span class="n">RXON_FLG_CCK_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_AUTO_DETECT_MSK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;CCK and auto detect&quot;</span><span class="p">);</span>
		<span class="n">errors</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RXON_FLG_AUTO_DETECT_MSK</span> <span class="o">|</span>
			    <span class="n">RXON_FLG_TGG_PROTECT_MSK</span><span class="p">))</span> <span class="o">==</span>
			    <span class="n">RXON_FLG_TGG_PROTECT_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;TGg but no auto-detect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">errors</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;zero channel is invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">errors</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">WARN</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="s">&quot;Invalid RXON (%#x), channel %d&quot;</span><span class="p">,</span>
	     <span class="n">errors</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">errors</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iwl_full_rxon_required - check if full RXON (vs RXON_ASSOC) cmd is needed</span>
<span class="cm"> * @priv: staging_rxon is compared to active_rxon</span>
<span class="cm"> *</span>
<span class="cm"> * If the RXON structure is changing enough to require a new tune,</span>
<span class="cm"> * or is clearing the RXON_FILTER_ASSOC_MSK, then return 1 to indicate that</span>
<span class="cm"> * a new tune (full RXON command, rather than RXON_ASSOC cmd) is required.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwl_full_rxon_required</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">staging</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">active</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>

<span class="cp">#define CHK(cond)							\</span>
<span class="cp">	if ((cond)) {							\</span>
<span class="cp">		IWL_DEBUG_INFO(priv, &quot;need full RXON - &quot; #cond &quot;\n&quot;);	\</span>
<span class="cp">		return 1;						\</span>
<span class="cp">	}</span>

<span class="cp">#define CHK_NEQ(c1, c2)						\</span>
<span class="cp">	if ((c1) != (c2)) {					\</span>
<span class="cp">		IWL_DEBUG_INFO(priv, &quot;need full RXON - &quot;	\</span>
<span class="cp">			       #c1 &quot; != &quot; #c2 &quot; - %d != %d\n&quot;,	\</span>
<span class="cp">			       (c1), (c2));			\</span>
<span class="cp">		return 1;					\</span>
<span class="cp">	}</span>

	<span class="cm">/* These items are only settable from the full RXON command */</span>
	<span class="n">CHK</span><span class="p">(</span><span class="o">!</span><span class="n">iwl_is_associated_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">));</span>
	<span class="n">CHK</span><span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">bssid_addr</span><span class="p">,</span> <span class="n">active</span><span class="o">-&gt;</span><span class="n">bssid_addr</span><span class="p">));</span>
	<span class="n">CHK</span><span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">node_addr</span><span class="p">,</span> <span class="n">active</span><span class="o">-&gt;</span><span class="n">node_addr</span><span class="p">));</span>
	<span class="n">CHK</span><span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">wlap_bssid_addr</span><span class="p">,</span>
			      <span class="n">active</span><span class="o">-&gt;</span><span class="n">wlap_bssid_addr</span><span class="p">));</span>
	<span class="n">CHK_NEQ</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">,</span> <span class="n">active</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">);</span>
	<span class="n">CHK_NEQ</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">active</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">CHK_NEQ</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">air_propagation</span><span class="p">,</span> <span class="n">active</span><span class="o">-&gt;</span><span class="n">air_propagation</span><span class="p">);</span>
	<span class="n">CHK_NEQ</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">ofdm_ht_single_stream_basic_rates</span><span class="p">,</span>
		<span class="n">active</span><span class="o">-&gt;</span><span class="n">ofdm_ht_single_stream_basic_rates</span><span class="p">);</span>
	<span class="n">CHK_NEQ</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">ofdm_ht_dual_stream_basic_rates</span><span class="p">,</span>
		<span class="n">active</span><span class="o">-&gt;</span><span class="n">ofdm_ht_dual_stream_basic_rates</span><span class="p">);</span>
	<span class="n">CHK_NEQ</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">ofdm_ht_triple_stream_basic_rates</span><span class="p">,</span>
		<span class="n">active</span><span class="o">-&gt;</span><span class="n">ofdm_ht_triple_stream_basic_rates</span><span class="p">);</span>
	<span class="n">CHK_NEQ</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="p">,</span> <span class="n">active</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="p">);</span>

	<span class="cm">/* flags, filter_flags, ofdm_basic_rates, and cck_basic_rates can</span>
<span class="cm">	 * be updated with the RXON_ASSOC command -- however only some</span>
<span class="cm">	 * flag transitions are allowed using RXON_ASSOC */</span>

	<span class="cm">/* Check if we are not switching bands */</span>
	<span class="n">CHK_NEQ</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_BAND_24G_MSK</span><span class="p">,</span>
		<span class="n">active</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_BAND_24G_MSK</span><span class="p">);</span>

	<span class="cm">/* Check if we are switching association toggle */</span>
	<span class="n">CHK_NEQ</span><span class="p">(</span><span class="n">staging</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">,</span>
		<span class="n">active</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">);</span>

<span class="cp">#undef CHK</span>
<span class="cp">#undef CHK_NEQ</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IWLWIFI_DEBUG</span>
<span class="kt">void</span> <span class="nf">iwl_print_rx_config_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">iwl_rxon_context_id</span> <span class="n">ctxid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">ctxid</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">rxon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_RADIO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;RX CONFIG:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">iwl_print_hex_dump</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IWL_DL_RADIO</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">rxon</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rxon</span><span class="p">));</span>
	<span class="n">IWL_DEBUG_RADIO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;u16 channel: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">));</span>
	<span class="n">IWL_DEBUG_RADIO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;u32 flags: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">IWL_DEBUG_RADIO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;u32 filter_flags: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">filter_flags</span><span class="p">));</span>
	<span class="n">IWL_DEBUG_RADIO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;u8 dev_type: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxon</span><span class="o">-&gt;</span><span class="n">dev_type</span><span class="p">);</span>
	<span class="n">IWL_DEBUG_RADIO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;u8 ofdm_basic_rates: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">ofdm_basic_rates</span><span class="p">);</span>
	<span class="n">IWL_DEBUG_RADIO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;u8 cck_basic_rates: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rxon</span><span class="o">-&gt;</span><span class="n">cck_basic_rates</span><span class="p">);</span>
	<span class="n">IWL_DEBUG_RADIO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;u8[6] node_addr: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxon</span><span class="o">-&gt;</span><span class="n">node_addr</span><span class="p">);</span>
	<span class="n">IWL_DEBUG_RADIO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;u8[6] bssid_addr: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxon</span><span class="o">-&gt;</span><span class="n">bssid_addr</span><span class="p">);</span>
	<span class="n">IWL_DEBUG_RADIO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;u16 assoc_id: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxon</span><span class="o">-&gt;</span><span class="n">assoc_id</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwl_calc_basic_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lowest_present_ofdm</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lowest_present_cck</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ofdm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">basic</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">basic_rates</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">sband</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

		<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">basic</span><span class="p">,</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">hw</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw</span> <span class="o">&gt;=</span> <span class="n">IWL_FIRST_OFDM_RATE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ofdm</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">hw</span> <span class="o">-</span> <span class="n">IWL_FIRST_OFDM_RATE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lowest_present_ofdm</span> <span class="o">&gt;</span> <span class="n">hw</span><span class="p">)</span>
					<span class="n">lowest_present_ofdm</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">IWL_FIRST_CCK_RATE</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

				<span class="n">cck</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lowest_present_cck</span> <span class="o">&gt;</span> <span class="n">hw</span><span class="p">)</span>
					<span class="n">lowest_present_cck</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we&#39;ve got the basic rates as bitmaps in the ofdm and cck</span>
<span class="cm">	 * variables. This isn&#39;t sufficient though, as there might not</span>
<span class="cm">	 * be all the right rates in the bitmap. E.g. if the only basic</span>
<span class="cm">	 * rates are 5.5 Mbps and 11 Mbps, we still need to add 1 Mbps</span>
<span class="cm">	 * and 6 Mbps because the 802.11-2007 standard says in 9.6:</span>
<span class="cm">	 *</span>
<span class="cm">	 *    [...] a STA responding to a received frame shall transmit</span>
<span class="cm">	 *    its Control Response frame [...] at the highest rate in the</span>
<span class="cm">	 *    BSSBasicRateSet parameter that is less than or equal to the</span>
<span class="cm">	 *    rate of the immediately previous frame in the frame exchange</span>
<span class="cm">	 *    sequence ([...]) and that is of the same modulation class</span>
<span class="cm">	 *    ([...]) as the received frame. If no rate contained in the</span>
<span class="cm">	 *    BSSBasicRateSet parameter meets these conditions, then the</span>
<span class="cm">	 *    control frame sent in response to a received frame shall be</span>
<span class="cm">	 *    transmitted at the highest mandatory rate of the PHY that is</span>
<span class="cm">	 *    less than or equal to the rate of the received frame, and</span>
<span class="cm">	 *    that is of the same modulation class as the received frame.</span>
<span class="cm">	 *</span>
<span class="cm">	 * As a consequence, we need to add all mandatory rates that are</span>
<span class="cm">	 * lower than all of the basic rates to these bitmaps.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IWL_RATE_24M_INDEX</span> <span class="o">&lt;</span> <span class="n">lowest_present_ofdm</span><span class="p">)</span>
		<span class="n">ofdm</span> <span class="o">|=</span> <span class="n">IWL_RATE_24M_MASK</span> <span class="o">&gt;&gt;</span> <span class="n">IWL_FIRST_OFDM_RATE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IWL_RATE_12M_INDEX</span> <span class="o">&lt;</span> <span class="n">lowest_present_ofdm</span><span class="p">)</span>
		<span class="n">ofdm</span> <span class="o">|=</span> <span class="n">IWL_RATE_12M_MASK</span> <span class="o">&gt;&gt;</span> <span class="n">IWL_FIRST_OFDM_RATE</span><span class="p">;</span>
	<span class="cm">/* 6M already there or needed so always add */</span>
	<span class="n">ofdm</span> <span class="o">|=</span> <span class="n">IWL_RATE_6M_MASK</span> <span class="o">&gt;&gt;</span> <span class="n">IWL_FIRST_OFDM_RATE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * CCK is a bit more complex with DSSS vs. HR/DSSS vs. ERP.</span>
<span class="cm">	 * Note, however:</span>
<span class="cm">	 *  - if no CCK rates are basic, it must be ERP since there must</span>
<span class="cm">	 *    be some basic rates at all, so they&#39;re OFDM =&gt; ERP PHY</span>
<span class="cm">	 *    (or we&#39;re in 5 GHz, and the cck bitmap will never be used)</span>
<span class="cm">	 *  - if 11M is a basic rate, it must be ERP as well, so add 5.5M</span>
<span class="cm">	 *  - if 5.5M is basic, 1M and 2M are mandatory</span>
<span class="cm">	 *  - if 2M is basic, 1M is mandatory</span>
<span class="cm">	 *  - if 1M is basic, that&#39;s the only valid ACK rate.</span>
<span class="cm">	 * As a consequence, it&#39;s not as complicated as it sounds, just add</span>
<span class="cm">	 * any lower rates to the ACK rate bitmap.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IWL_RATE_11M_INDEX</span> <span class="o">&lt;</span> <span class="n">lowest_present_ofdm</span><span class="p">)</span>
		<span class="n">ofdm</span> <span class="o">|=</span> <span class="n">IWL_RATE_11M_MASK</span> <span class="o">&gt;&gt;</span> <span class="n">IWL_FIRST_CCK_RATE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IWL_RATE_5M_INDEX</span> <span class="o">&lt;</span> <span class="n">lowest_present_ofdm</span><span class="p">)</span>
		<span class="n">ofdm</span> <span class="o">|=</span> <span class="n">IWL_RATE_5M_MASK</span> <span class="o">&gt;&gt;</span> <span class="n">IWL_FIRST_CCK_RATE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IWL_RATE_2M_INDEX</span> <span class="o">&lt;</span> <span class="n">lowest_present_ofdm</span><span class="p">)</span>
		<span class="n">ofdm</span> <span class="o">|=</span> <span class="n">IWL_RATE_2M_MASK</span> <span class="o">&gt;&gt;</span> <span class="n">IWL_FIRST_CCK_RATE</span><span class="p">;</span>
	<span class="cm">/* 1M already there or needed so always add */</span>
	<span class="n">cck</span> <span class="o">|=</span> <span class="n">IWL_RATE_1M_MASK</span> <span class="o">&gt;&gt;</span> <span class="n">IWL_FIRST_CCK_RATE</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_RATE</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Set basic rates cck:0x%.2x ofdm:0x%.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cck</span><span class="p">,</span> <span class="n">ofdm</span><span class="p">);</span>

	<span class="cm">/* &quot;basic_rates&quot; is a misnomer here -- should be called ACK rates */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">cck_basic_rates</span> <span class="o">=</span> <span class="n">cck</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">ofdm_basic_rates</span> <span class="o">=</span> <span class="n">ofdm</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iwlagn_commit_rxon - commit staging_rxon to hardware</span>
<span class="cm"> *</span>
<span class="cm"> * The RXON command in staging_rxon is committed to the hardware and</span>
<span class="cm"> * the active_rxon structure is updated with the new data.  This</span>
<span class="cm"> * function correctly transitions out of the RXON_ASSOC_MSK state if</span>
<span class="cm"> * a HW tune is required based on the RXON structure changes.</span>
<span class="cm"> *</span>
<span class="cm"> * The connect/disconnect flow should be as the following:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. make sure send RXON command with association bit unset if not connect</span>
<span class="cm"> *	this should include the channel and the band for the candidate</span>
<span class="cm"> *	to be connected to</span>
<span class="cm"> * 2. Add Station before RXON association with the AP</span>
<span class="cm"> * 3. RXON_timing has to send before RXON for connection</span>
<span class="cm"> * 4. full RXON command - associated bit set</span>
<span class="cm"> * 5. use RXON_ASSOC command to update any flags changes</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwlagn_commit_rxon</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* cast away the const for active_rxon in this function */</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="o">*</span><span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">new_assoc</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwl_is_alive</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* This function hardcodes a bunch of dual-mode assumptions */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">NUM_IWL_RXON_CTX</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">is_active</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* always get timestamp with Rx frame */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_TSF2HOST_MSK</span><span class="p">;</span>

	<span class="cm">/* recalculate basic rates */</span>
	<span class="n">iwl_calc_basic_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * force CTS-to-self frames protection if RTS-CTS is not preferred</span>
<span class="cm">	 * one aggregation protection method</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">use_rts_for_aggregation</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_SELF_CTS_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_slot</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_BAND_24G_MSK</span><span class="p">))</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">;</span>

	<span class="n">iwl_print_rx_config_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxid</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_check_rxon_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Invalid RXON configuration. Not committing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * receive commit_rxon request</span>
<span class="cm">	 * abort any previous channel switch if still in process</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_CHANNEL_SWITCH_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">switch_channel</span> <span class="o">!=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_11H</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;abort channel switch on %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">switch_channel</span><span class="p">));</span>
		<span class="n">iwl_chswitch_done</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t need to send a full RXON, we can use</span>
<span class="cm">	 * iwl_rxon_assoc_cmd which is used to reconfigure filter</span>
<span class="cm">	 * and other flags for the current radio configuration.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwl_full_rxon_required</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_send_rxon_assoc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Error setting RXON_ASSOC (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">active</span><span class="p">));</span>
		<span class="cm">/*</span>
<span class="cm">		 * We do not commit tx power settings while channel changing,</span>
<span class="cm">		 * do it now if after settings changed.</span>
<span class="cm">		 */</span>
		<span class="n">iwl_set_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_next</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* make sure we are in the right PS state */</span>
		<span class="n">iwl_power_update_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iwl_set_rxon_hwcrypto</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="o">!</span><span class="n">iwlwifi_mod_params</span><span class="p">.</span><span class="n">sw_crypto</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
		       <span class="s">&quot;Going to commit RXON</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;  * with%s RXON_FILTER_ASSOC_MSK</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;  * channel = %d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;  * bssid = %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">new_assoc</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;out&quot;</span><span class="p">),</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">channel</span><span class="p">),</span>
		       <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">bssid_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Always clear associated first, but with the correct config.</span>
<span class="cm">	 * This is required as for example station addition for the</span>
<span class="cm">	 * AP station must be done after the BSSID is set to correctly</span>
<span class="cm">	 * set up filters in the device.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_rxon_disconn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_set_pan_params</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_assoc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">iwlagn_rxon_connect</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_config_ht40</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht40_minus</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">extension_chan_offset</span> <span class="o">=</span>
			<span class="n">IEEE80211_HT_PARAM_CHA_SEC_BELOW</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht40_plus</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">extension_chan_offset</span> <span class="o">=</span>
			<span class="n">IEEE80211_HT_PARAM_CHA_SEC_ABOVE</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">extension_chan_offset</span> <span class="o">=</span>
			<span class="n">IEEE80211_HT_PARAM_CHA_SEC_NONE</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_mac_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">IWL_MAC80211_GET_DVM</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iwl_channel_info</span> <span class="o">*</span><span class="n">ch_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_MAC80211</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;enter: changed %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_MAC80211</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;leave - scanning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwl_is_ready</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_MAC80211</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;leave - not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_CONF_CHANGE_SMPS</span> <span class="o">|</span>
		       <span class="n">IEEE80211_CONF_CHANGE_CHANNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* mac80211 uses static for non-HT which is what we want */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">smps</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">smps_mode</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Recalculate chain counts.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If monitor mode is enabled then mac80211 will</span>
<span class="cm">		 * set up the SM PS mode to OFF if an HT channel is</span>
<span class="cm">		 * configured.</span>
<span class="cm">		 */</span>
		<span class="n">for_each_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
			<span class="n">iwlagn_set_rxon_chain</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch_info</span> <span class="o">=</span> <span class="n">iwl_get_channel_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span>
					       <span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_channel_valid</span><span class="p">(</span><span class="n">ch_info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IWL_DEBUG_MAC80211</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;leave - invalid channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">for_each_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Configure HT40 channels */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">enabled</span> <span class="o">!=</span> <span class="n">conf_is_ht</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">conf_is_ht</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* if HT40 is used, it should not change</span>
<span class="cm">				 * after associated except channel switch */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">||</span>
						<span class="o">!</span><span class="n">iwl_is_associated_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
					<span class="n">iwlagn_config_ht40</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Default to no protection. Protection mode will</span>
<span class="cm">			 * later be set from BSS config in iwl_ht_conf</span>
<span class="cm">			 */</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">protection</span> <span class="o">=</span> <span class="n">IEEE80211_HT_OP_MODE_PROTECTION_NONE</span><span class="p">;</span>

			<span class="cm">/* if we are switching from ht to 2.4 clear flags</span>
<span class="cm">			 * from any ht related info since 2.4 does not</span>
<span class="cm">			 * support ht */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">channel</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">)</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">iwl_set_rxon_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
			<span class="n">iwl_set_rxon_ht</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">);</span>

			<span class="n">iwl_set_flags_for_band</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span>
					       <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">iwl_update_bcast_stations</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_CONF_CHANGE_PS</span> <span class="o">|</span>
			<span class="n">IEEE80211_CONF_CHANGE_IDLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_power_update_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">IWL_DEBUG_MAC80211</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Error setting sleep level</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_MAC80211</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;TX Power old=%d new=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_user_lmt</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">);</span>

		<span class="n">iwl_set_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">for_each_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">iwlagn_commit_rxon</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">IWL_DEBUG_MAC80211</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_check_needed_chains</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_ht_config</span> <span class="o">*</span><span class="n">ht_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_cap</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">need_multiple</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">ieee80211_find_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If at all, this can only happen through a race</span>
<span class="cm">			 * when the AP disconnects us while we&#39;re still</span>
<span class="cm">			 * setting up the connection, in that case mac80211</span>
<span class="cm">			 * will soon tell us about that.</span>
<span class="cm">			 */</span>
			<span class="n">need_multiple</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ht_cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">;</span>

		<span class="n">need_multiple</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the peer advertises no support for receiving 2 and 3</span>
<span class="cm">		 * stream MCS rates, it can&#39;t be transmitting them either.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">need_multiple</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">&amp;</span>
						<span class="n">IEEE80211_HT_MCS_TX_DEFINED</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* If it can&#39;t TX MCS at all ... */</span>
			<span class="n">need_multiple</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">&amp;</span>
						<span class="n">IEEE80211_HT_MCS_TX_RX_DIFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">maxstreams</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * But if it can receive them, it might still not</span>
<span class="cm">			 * be able to transmit them, which is what we need</span>
<span class="cm">			 * to check here -- so check the number of streams</span>
<span class="cm">			 * it advertises for TX (if different from RX).</span>
<span class="cm">			 */</span>

			<span class="n">maxstreams</span> <span class="o">=</span> <span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">&amp;</span>
				 <span class="n">IEEE80211_HT_MCS_TX_MAX_STREAMS_MASK</span><span class="p">);</span>
			<span class="n">maxstreams</span> <span class="o">&gt;&gt;=</span>
				<span class="n">IEEE80211_HT_MCS_TX_MAX_STREAMS_SHIFT</span><span class="p">;</span>
			<span class="n">maxstreams</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">maxstreams</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">need_multiple</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="cm">/* currently */</span>
		<span class="n">need_multiple</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* only AP really */</span>
		<span class="n">need_multiple</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht_need_multiple_chains</span> <span class="o">=</span> <span class="n">need_multiple</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">need_multiple</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check all contexts */</span>
		<span class="n">for_each_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">ht_need_multiple_chains</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">need_multiple</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ht_conf</span><span class="o">-&gt;</span><span class="n">single_chain_sufficient</span> <span class="o">=</span> <span class="o">!</span><span class="n">need_multiple</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_chain_noise_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_chain_noise_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chain_noise_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">calib_disabled</span> <span class="o">&amp;</span> <span class="n">IWL_CHAIN_NOISE_CALIB_DISABLED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">IWL_CHAIN_NOISE_ALIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">iwl_is_any_associated</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iwl_calib_chain_noise_reset_cmd</span> <span class="n">cmd</span><span class="p">;</span>

		<span class="cm">/* clear data for chain noise calibration algorithm */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">chain_noise_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">chain_noise_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">chain_noise_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">chain_signal_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">chain_signal_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">chain_signal_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">beacon_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">iwl_set_calib_hdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_calib_chain_noise_reset_cmd</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					<span class="n">REPLY_PHY_CALIBRATION_CMD</span><span class="p">,</span>
					<span class="n">CMD_SYNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				<span class="s">&quot;Could not send REPLY_PHY_CALIBRATION_CMD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWL_CHAIN_NOISE_ACCUMULATE</span><span class="p">;</span>
		<span class="n">IWL_DEBUG_CALIB</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Run chain_noise_calibrate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">changes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">IWL_MAC80211_GET_DVM</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">iwl_rxon_ctx_from_vif</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">force</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">iwl_is_ready</span><span class="p">(</span><span class="n">priv</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_MAC80211</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;leave - not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_MAC80211</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;leave - vif is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">)</span>
		<span class="n">force</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_QOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">qos_data</span><span class="p">.</span><span class="n">qos_active</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">;</span>
		<span class="n">iwlagn_update_qos</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">assoc_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">aid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_SHORT_PREAMBLE_MSK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FLG_SHORT_PREAMBLE_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">last_tsf</span><span class="p">;</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If we disassociate while there are pending</span>
<span class="cm">			 * frames, just wake up the queues and let the</span>
<span class="cm">			 * frames &quot;escape&quot; ... This shouldn&#39;t really</span>
<span class="cm">			 * be happening to start with, but we should</span>
<span class="cm">			 * not get stuck in this case either since it</span>
<span class="cm">			 * can happen if userspace gets confused.</span>
<span class="cm">			 */</span>
			<span class="n">iwlagn_lift_passive_no_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxid</span> <span class="o">==</span> <span class="n">IWL_RXON_CTX_BSS</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">have_rekey_data</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">iwlagn_bt_coex_rssi_monitor</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">protection</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ht_operation_mode</span> <span class="o">&amp;</span>
					<span class="n">IEEE80211_HT_OP_MODE_PROTECTION</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">non_gf_sta_present</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ht_operation_mode</span> <span class="o">&amp;</span>
					<span class="n">IEEE80211_HT_OP_MODE_NON_GF_STA_PRSNT</span><span class="p">);</span>
		<span class="n">iwlagn_check_needed_chains</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">bss_conf</span><span class="p">);</span>
		<span class="n">iwl_set_rxon_ht</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iwlagn_set_rxon_chain</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_cts_prot</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">!=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">))</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_TGG_PROTECT_MSK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FLG_TGG_PROTECT_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_cts_prot</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_SELF_CTS_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FLG_SELF_CTS_EN</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">bssid_addr</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">enable_beacon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the ucode decides to do beacon filtering before</span>
<span class="cm">	 * association, it will lose beacons that are needed</span>
<span class="cm">	 * before sending frames out on passive channels. This</span>
<span class="cm">	 * causes association failures on those channels. Enable</span>
<span class="cm">	 * receiving beacons in such cases.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="n">RXON_FILTER_BCON_AWARE_MSK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">&amp;=</span>
						    <span class="o">~</span><span class="n">RXON_FILTER_BCON_AWARE_MSK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">)))</span>
		<span class="n">iwlagn_commit_rxon</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span> <span class="o">&amp;&amp;</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The chain noise calibration will enable PM upon</span>
<span class="cm">		 * completion. If calibration has already been run</span>
<span class="cm">		 * then we need to enable power management here.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chain_noise_data</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">IWL_CHAIN_NOISE_DONE</span><span class="p">)</span>
			<span class="n">iwl_power_update_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* Enable RX differential gain and sensitivity calibrations */</span>
		<span class="n">iwlagn_chain_noise_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_calib</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_IBSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_manage_ibss_station</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span>
						 <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ibss_joined</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;failed to %s IBSS station %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ibss_joined</span> <span class="o">?</span> <span class="s">&quot;add&quot;</span> <span class="o">:</span> <span class="s">&quot;remove&quot;</span><span class="p">,</span>
				<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span> <span class="o">&amp;&amp;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iwlagn_update_beacon</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">))</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Error sending IBSS beacon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_post_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We do not commit power settings while scan is pending,</span>
<span class="cm">	 * do it now if the settings changed.</span>
<span class="cm">	 */</span>
	<span class="n">iwl_power_set_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_data</span><span class="p">.</span><span class="n">sleep_cmd_next</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">iwl_set_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_next</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since setting the RXON may have been deferred while</span>
<span class="cm">	 * performing the scan, fire one off if needed</span>
<span class="cm">	 */</span>
	<span class="n">for_each_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">)))</span>
			<span class="n">iwlagn_commit_rxon</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>

	<span class="n">iwlagn_set_pan_params</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
