<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › iwlwifi › iwl-agn-tx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>iwl-agn-tx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * GPL LICENSE SUMMARY</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2008 - 2012 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110,</span>
<span class="cm"> * USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution</span>
<span class="cm"> * in the file called LICENSE.GPL.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> *  Intel Linux Wireless &lt;ilw@linux.intel.com&gt;</span>
<span class="cm"> * Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>

<span class="cp">#include &quot;iwl-dev.h&quot;</span>
<span class="cp">#include &quot;iwl-io.h&quot;</span>
<span class="cp">#include &quot;iwl-agn-hw.h&quot;</span>
<span class="cp">#include &quot;iwl-agn.h&quot;</span>
<span class="cp">#include &quot;iwl-trans.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">tid_to_ac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IEEE80211_AC_BE</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_BK</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_BK</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_BE</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_VI</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_VI</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_VO</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_VO</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_tx_cmd_protection</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="n">__le16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">tx_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span> <span class="o">||</span>
	    <span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span>
		<span class="o">*</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_PROT_REQUIRE_MSK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle build REPLY_TX command notification.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_tx_cmd_build_basic</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">iwl_tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tx_flags</span> <span class="o">=</span> <span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">;</span>

	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">stop_time</span><span class="p">.</span><span class="n">life_time</span> <span class="o">=</span> <span class="n">TX_CMD_LIFE_TIME_INFINITE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">))</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_ACK_MSK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_CMD_FLG_ACK_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_TSF_MSK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_back_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_ACK_MSK</span> <span class="o">|</span> <span class="n">TX_CMD_FLG_IMM_BA_RSP_MASK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">&amp;&amp;</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span> <span class="o">&amp;&amp;</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">advanced_bt_coexist</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">ieee80211_is_auth</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">||</span> <span class="n">ieee80211_is_assoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">ieee80211_is_reassoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">||</span>
		 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_PAE</span><span class="p">)))</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_IGNORE_BT</span><span class="p">;</span>


	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_MORE_FRAG_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tid_tspec</span> <span class="o">=</span> <span class="n">qc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tid_tspec</span> <span class="o">=</span> <span class="n">IWL_TID_NON_QOS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_ASSIGN_SEQ</span><span class="p">)</span>
			<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iwlagn_tx_cmd_protection</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_flags</span><span class="p">);</span>

	<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TX_CMD_FLG_ANT_SEL_MSK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_assoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">||</span> <span class="n">ieee80211_is_reassoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">pm_frame_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">pm_frame_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">pm_frame_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">driver_txop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="n">tx_flags</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">next_frame_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_tx_cmd_build_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iwl_tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="n">__le16</span> <span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rate_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rts_retry_limit</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data_retry_limit</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate_plcp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wowlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rts_retry_limit</span> <span class="o">=</span> <span class="n">IWLAGN_LOW_RETRY_LIMIT</span><span class="p">;</span>
		<span class="n">data_retry_limit</span> <span class="o">=</span> <span class="n">IWLAGN_LOW_RETRY_LIMIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set retry limit on RTS packets */</span>
		<span class="n">rts_retry_limit</span> <span class="o">=</span> <span class="n">IWLAGN_RTS_DFAULT_RETRY_LIMIT</span><span class="p">;</span>

		<span class="cm">/* Set retry limit on DATA packets and Probe Responses*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">data_retry_limit</span> <span class="o">=</span> <span class="n">IWLAGN_MGMT_DFAULT_RETRY_LIMIT</span><span class="p">;</span>
			<span class="n">rts_retry_limit</span> <span class="o">=</span>
				<span class="n">min</span><span class="p">(</span><span class="n">data_retry_limit</span><span class="p">,</span> <span class="n">rts_retry_limit</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_back_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="n">data_retry_limit</span> <span class="o">=</span> <span class="n">IWLAGN_BAR_DFAULT_RETRY_LIMIT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data_retry_limit</span> <span class="o">=</span> <span class="n">IWLAGN_DEFAULT_TX_RETRY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">data_retry_limit</span> <span class="o">=</span> <span class="n">data_retry_limit</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">rts_retry_limit</span> <span class="o">=</span> <span class="n">rts_retry_limit</span><span class="p">;</span>

	<span class="cm">/* DATA packets will use the uCode station table for rate/antenna</span>
<span class="cm">	 * selection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">initial_rate_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_STA_RATE_MSK</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IWLWIFI_DEVICE_TESTMODE</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tm_fixed_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * rate overwrite by testmode</span>
<span class="cm">			 * we not only send lq command to change rate</span>
<span class="cm">			 * we also re-enforce per data pkt base.</span>
<span class="cm">			 */</span>
			<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_CMD_FLG_STA_RATE_MSK</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tm_fixed_rate</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span><span class="p">));</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_back_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_STA_RATE_MSK</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * If the current TX rate stored in mac80211 has the MCS bit set, it&#39;s</span>
<span class="cm">	 * not really a TX rate.  Thus, we use the lowest supported rate for</span>
<span class="cm">	 * this band.  Also use the lowest supported rate if the stored rate</span>
<span class="cm">	 * index is invalid.</span>
<span class="cm">	 */</span>
	<span class="n">rate_idx</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">rate_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rate_idx</span> <span class="o">&gt;</span> <span class="n">IWL_RATE_COUNT_LEGACY</span><span class="p">))</span>
		<span class="n">rate_idx</span> <span class="o">=</span> <span class="n">rate_lowest_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">],</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">);</span>
	<span class="cm">/* For 5 GHZ band, remap mac80211 rate indices into driver indices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">rate_idx</span> <span class="o">+=</span> <span class="n">IWL_FIRST_OFDM_RATE</span><span class="p">;</span>
	<span class="cm">/* Get PLCP rate for tx_cmd-&gt;rate_n_flags */</span>
	<span class="n">rate_plcp</span> <span class="o">=</span> <span class="n">iwl_rates</span><span class="p">[</span><span class="n">rate_idx</span><span class="p">].</span><span class="n">plcp</span><span class="p">;</span>
	<span class="cm">/* Zero out flags for this packet */</span>
	<span class="n">rate_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set CCK flag as needed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rate_idx</span> <span class="o">&gt;=</span> <span class="n">IWL_FIRST_CCK_RATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate_idx</span> <span class="o">&lt;=</span> <span class="n">IWL_LAST_CCK_RATE</span><span class="p">))</span>
		<span class="n">rate_flags</span> <span class="o">|=</span> <span class="n">RATE_MCS_CCK_MSK</span><span class="p">;</span>

	<span class="cm">/* Set up antennas */</span>
	 <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span> <span class="o">&amp;&amp;</span>
	     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">advanced_bt_coexist</span> <span class="o">&amp;&amp;</span>
	     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_full_concurrent</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* operated as 1x1 in full concurrency mode */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mgmt_tx_ant</span> <span class="o">=</span> <span class="n">iwl_toggle_tx_ant</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mgmt_tx_ant</span><span class="p">,</span>
				<span class="n">first_antenna</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mgmt_tx_ant</span> <span class="o">=</span> <span class="n">iwl_toggle_tx_ant</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mgmt_tx_ant</span><span class="p">,</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">);</span>
	<span class="n">rate_flags</span> <span class="o">|=</span> <span class="n">iwl_ant_idx_to_flags</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mgmt_tx_ant</span><span class="p">);</span>

	<span class="cm">/* Set the rate in the TX cmd */</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">iwl_hw_set_rate_n_flags</span><span class="p">(</span><span class="n">rate_plcp</span><span class="p">,</span> <span class="n">rate_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_tx_cmd_build_hwcrypto</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">iwl_tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_frag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">=</span> <span class="n">TX_CMD_SEC_CCM</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span>
			<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_AGG_CCMP_MSK</span><span class="p">;</span>
		<span class="n">IWL_DEBUG_TX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;tx_cmd with AES hwcrypto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">=</span> <span class="n">TX_CMD_SEC_TKIP</span><span class="p">;</span>
		<span class="n">ieee80211_get_tkip_p2k</span><span class="p">(</span><span class="n">keyconf</span><span class="p">,</span> <span class="n">skb_frag</span><span class="p">,</span> <span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
		<span class="n">IWL_DEBUG_TX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;tx_cmd with tkip hwcrypto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">|=</span> <span class="n">TX_CMD_SEC_KEY128</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">TX_CMD_SEC_WEP</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span> <span class="o">&amp;</span> <span class="n">TX_CMD_SEC_MSK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">TX_CMD_SEC_SHIFT</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

		<span class="n">IWL_DEBUG_TX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Configuring packet for WEP encryption &quot;</span>
			     <span class="s">&quot;with key %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Unknown encode cipher %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iwl_sta_id_or_broadcast - return sta_id or broadcast sta</span>
<span class="cm"> * @context: the current context</span>
<span class="cm"> * @sta: mac80211 station</span>
<span class="cm"> *</span>
<span class="cm"> * In certain circumstances mac80211 passes a station pointer</span>
<span class="cm"> * that may be %NULL, for example during TX or key setup. In</span>
<span class="cm"> * that case, we need to use the broadcast station, so this</span>
<span class="cm"> * inline wraps that pattern.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_sta_id_or_broadcast</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sta_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">bcast_sta_id</span><span class="p">;</span>

	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">iwl_sta_id</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * mac80211 should not be passing a partially</span>
<span class="cm">	 * initialised station!</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IWL_INVALID_STATION</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sta_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * start REPLY_TX command process</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwlagn_tx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwl_station_priv</span> <span class="o">*</span><span class="n">sta_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">iwl_device_cmd</span> <span class="o">*</span><span class="n">dev_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">seq_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">IWL_MAX_TID_COUNT</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_agg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txq_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">)</span>
		<span class="n">ctx</span> <span class="o">=</span> <span class="n">iwl_rxon_ctx_from_vif</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iwl_is_rfkill</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_DROP</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Dropping - RF KILL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_unlock_priv</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IWLWIFI_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_auth</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">IWL_DEBUG_TX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Sending AUTH frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_assoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">IWL_DEBUG_TX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Sending ASSOC frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_reassoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">IWL_DEBUG_TX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Sending REASSOC frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">fc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iwl_wipan_noa_data</span> <span class="o">*</span><span class="n">noa_data</span> <span class="o">=</span>
			<span class="n">rcu_dereference</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">noa_data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">noa_data</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">noa_data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
				     <span class="n">GFP_ATOMIC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">noa_data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">),</span>
			       <span class="n">noa_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">noa_data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

	<span class="cm">/* For management frames use broadcast id to do not break aggregation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">sta_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bcast_sta_id</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Find index into station table for destination station */</span>
		<span class="n">sta_id</span> <span class="o">=</span> <span class="n">iwl_sta_id_or_broadcast</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IWL_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_DEBUG_DROP</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Dropping - INVALID STATION: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop_unlock_priv</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">IWL_DEBUG_TX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;station Id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">sta_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_priv</span> <span class="o">&amp;&amp;</span> <span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">asleep</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_PS_BUFFER</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This sends an asynchronous command to the device,</span>
<span class="cm">		 * but we can rely on it being processed before the</span>
<span class="cm">		 * next frame is processed -- and the next frame to</span>
<span class="cm">		 * this station is the one that will consume this</span>
<span class="cm">		 * counter.</span>
<span class="cm">		 * For now set the counter to just 1 since we do not</span>
<span class="cm">		 * support uAPSD yet.</span>
<span class="cm">		 *</span>
<span class="cm">		 * FIXME: If we get two non-bufferable frames one</span>
<span class="cm">		 * after the other, we might only send out one of</span>
<span class="cm">		 * them because this is racy.</span>
<span class="cm">		 */</span>
		<span class="n">iwl_sta_modify_sleep_tx_count</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span>
		<span class="n">is_agg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">dev_cmd</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">iwl_tx_cmd_pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dev_cmd</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop_unlock_priv</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dev_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev_cmd</span><span class="p">));</span>
	<span class="n">tx_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iwl_tx_cmd</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_cmd</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">;</span>

	<span class="cm">/* Total # bytes to be transmitted */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">)</span>
		<span class="n">iwlagn_tx_cmd_build_hwcrypto</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">tx_cmd</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* TODO need this for burst mode later on */</span>
	<span class="n">iwlagn_tx_cmd_build_basic</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tx_cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

	<span class="n">iwlagn_tx_cmd_build_rate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx_cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">fc</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_cmd</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ieee80211_is_qos_nullfunc</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">iwl_tid_data</span> <span class="o">*</span><span class="n">tid_data</span><span class="p">;</span>
		<span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">qc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">IWL_MAX_TID_COUNT</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop_unlock_sta</span><span class="p">;</span>
		<span class="n">tid_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">];</span>

		<span class="cm">/* aggregation is on for this &lt;sta,tid&gt; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IWL_AGG_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;TX_CTL_AMPDU while not in AGG:&quot;</span>
				<span class="s">&quot; Tx flags = 0x%08x, agg.state = %d&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;sta_id = %d, tid = %d seq_num = %d&quot;</span><span class="p">,</span>
				<span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">SEQ_TO_SN</span><span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">seq_number</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">drop_unlock_sta</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* We can receive packets from the stack in IWL_AGG_{ON,OFF}</span>
<span class="cm">		 * only. Check this here.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ONCE</span><span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IWL_AGG_ON</span> <span class="o">&amp;&amp;</span>
		    <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IWL_AGG_OFF</span><span class="p">,</span>
		    <span class="s">&quot;Tx while agg.state = %d&quot;</span><span class="p">,</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop_unlock_sta</span><span class="p">;</span>

		<span class="n">seq_number</span> <span class="o">=</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">seq_number</span><span class="p">;</span>
		<span class="n">seq_number</span> <span class="o">&amp;=</span> <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_SCTL_FRAG</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">seq_number</span><span class="p">);</span>
		<span class="n">seq_number</span> <span class="o">+=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy MAC header from skb into command buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_agg</span><span class="p">)</span>
		<span class="n">txq_id</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_SEND_AFTER_DTIM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Send this frame after DTIM -- there&#39;s a special queue</span>
<span class="cm">		 * reserved for this for contexts that support AP mode.</span>
<span class="cm">		 */</span>
		<span class="n">txq_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mcast_queue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The microcode will clear the more data</span>
<span class="cm">		 * bit in the last frame it transmits.</span>
<span class="cm">		 */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">|=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_MOREDATA</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_TX_OFFCHAN</span><span class="p">)</span>
		<span class="n">txq_id</span> <span class="o">=</span> <span class="n">IWL_AUX_QUEUE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">txq_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ac_to_queue</span><span class="p">[</span><span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">)];</span>

	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">is_agg</span> <span class="o">&amp;&amp;</span> <span class="n">txq_id</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hw_queue</span><span class="p">);</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">is_agg</span> <span class="o">&amp;&amp;</span>
		     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">queue_to_mac80211</span><span class="p">[</span><span class="n">txq_id</span><span class="p">]</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">hw_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iwl_trans_tx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev_cmd</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop_unlock_sta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ieee80211_is_qos_nullfunc</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">seq_number</span> <span class="o">=</span> <span class="n">seq_number</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Avoid atomic ops if it isn&#39;t an associated client.</span>
<span class="cm">	 * Also, if this is a packet for aggregation, don&#39;t</span>
<span class="cm">	 * increase the counter because the ucode will stop</span>
<span class="cm">	 * aggregation queues when their respective station</span>
<span class="cm">	 * goes to sleep.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_priv</span> <span class="o">&amp;&amp;</span> <span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_agg</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">pending_frames</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop_unlock_sta:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_cmd</span><span class="p">)</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">iwl_tx_cmd_pool</span><span class="p">,</span> <span class="n">dev_cmd</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
<span class="nl">drop_unlock_priv:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwlagn_alloc_agg_txq</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">q</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">IWLAGN_FIRST_AMPDU_QUEUE</span><span class="p">;</span>
	     <span class="n">q</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">base_params</span><span class="o">-&gt;</span><span class="n">num_of_queues</span><span class="p">;</span> <span class="n">q</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">agg_q_alloc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">queue_to_mac80211</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">mq</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">q</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_dealloc_agg_txq</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">agg_q_alloc</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">queue_to_mac80211</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">IWL_INVALID_MAC80211_QUEUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_tx_agg_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_tid_data</span> <span class="o">*</span><span class="n">tid_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">iwl_agg_state</span> <span class="n">agg_state</span><span class="p">;</span>

	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">iwl_sta_id</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IWL_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Invalid station for AGG tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="n">tid_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">];</span>
	<span class="n">txq_id</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IWL_EMPTYING_HW_QUEUE_ADDBA</span>:
		<span class="cm">/*</span>
<span class="cm">		* This can happen if the peer stops aggregation</span>
<span class="cm">		* again before we&#39;ve had a chance to drain the</span>
<span class="cm">		* queue we selected previously, i.e. before the</span>
<span class="cm">		* session was really started completely.</span>
<span class="cm">		*/</span>
		<span class="n">IWL_DEBUG_HT</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;AGG stop before setup done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">turn_off</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWL_AGG_STARTING</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This can happen when the session is stopped before</span>
<span class="cm">		 * we receive ADDBA response</span>
<span class="cm">		 */</span>
		<span class="n">IWL_DEBUG_HT</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;AGG stop before AGG became operational</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">turn_off</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWL_AGG_ON</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Stopping AGG while state not ON &quot;</span>
			 <span class="s">&quot;or starting for %d on %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">ssn</span> <span class="o">=</span> <span class="n">SEQ_TO_SN</span><span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">seq_number</span><span class="p">);</span>

	<span class="cm">/* There are still packets for this RA / TID in the HW */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">txq_id</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">agg_q_alloc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_TX_QUEUES</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="s">&quot;stopping AGG on STA/TID %d/%d but hwq %d not used</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">ssn</span> <span class="o">!=</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">next_reclaimed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_TX_QUEUES</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Can&#39;t proceed: ssn %d, &quot;</span>
				    <span class="s">&quot;next_recl = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">ssn</span><span class="p">,</span>
				    <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">next_reclaimed</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span>
			<span class="n">IWL_EMPTYING_HW_QUEUE_DELBA</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IWL_DEBUG_TX_QUEUES</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Can proceed: ssn = next_recl = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">ssn</span><span class="p">);</span>
<span class="nl">turn_off:</span>
	<span class="n">agg_state</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWL_AGG_OFF</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">txq_id</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">agg_q_alloc</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the transport didn&#39;t know that we wanted to start</span>
<span class="cm">		 * agreggation, don&#39;t tell it that we want to stop them.</span>
<span class="cm">		 * This can happen when we don&#39;t get the addBA response on</span>
<span class="cm">		 * time, or we hadn&#39;t time to drain the AC queues.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">agg_state</span> <span class="o">==</span> <span class="n">IWL_AGG_ON</span><span class="p">)</span>
			<span class="n">iwl_trans_tx_agg_disable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">IWL_DEBUG_TX_QUEUES</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Don&#39;t disable tx agg: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">agg_state</span><span class="p">);</span>
		<span class="n">iwlagn_dealloc_agg_txq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ieee80211_stop_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_tx_agg_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ssn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">iwl_rxon_ctx_from_vif</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwl_tid_data</span> <span class="o">*</span><span class="n">tid_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_HT</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;TX AGG request on ra = %pM tid = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">iwl_sta_id</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IWL_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Start AGG on invalid station</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">IWL_MAX_TID_COUNT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IWL_AGG_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Start AGG when state is not IWL_AGG_OFF !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txq_id</span> <span class="o">=</span> <span class="n">iwlagn_alloc_agg_txq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ac_to_queue</span><span class="p">[</span><span class="n">tid_to_ac</span><span class="p">[</span><span class="n">tid</span><span class="p">]]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_TX_QUEUES</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="s">&quot;No free aggregation queue for %pM/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">txq_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_sta_tx_modify_enable_tid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
	<span class="n">tid_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">];</span>
	<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">ssn</span> <span class="o">=</span> <span class="n">SEQ_TO_SN</span><span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">seq_number</span><span class="p">);</span>
	<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span> <span class="o">=</span> <span class="n">txq_id</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ssn</span> <span class="o">=</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">ssn</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ssn</span> <span class="o">==</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">next_reclaimed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_TX_QUEUES</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Can proceed: ssn = next_recl = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">ssn</span><span class="p">);</span>
		<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWL_AGG_STARTING</span><span class="p">;</span>
		<span class="n">ieee80211_start_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_TX_QUEUES</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Can&#39;t proceed: ssn %d, &quot;</span>
				    <span class="s">&quot;next_reclaimed = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">ssn</span><span class="p">,</span>
				    <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">next_reclaimed</span><span class="p">);</span>
		<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWL_EMPTYING_HW_QUEUE_ADDBA</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_tx_agg_oper</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_station_priv</span> <span class="o">*</span><span class="n">sta_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">iwl_rxon_ctx_from_vif</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">q</span><span class="p">,</span> <span class="n">fifo</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ssn</span><span class="p">;</span>

	<span class="n">buf_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">LINK_QUAL_AGG_FRAME_LIMIT_DEF</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
	<span class="n">ssn</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">ssn</span><span class="p">;</span>
	<span class="n">q</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWL_AGG_ON</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="n">fifo</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ac_to_fifo</span><span class="p">[</span><span class="n">tid_to_ac</span><span class="p">[</span><span class="n">tid</span><span class="p">]];</span>

	<span class="n">iwl_trans_tx_agg_setup</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">fifo</span><span class="p">,</span>
			       <span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
			       <span class="n">buf_size</span><span class="p">,</span> <span class="n">ssn</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the limit is 0, then it wasn&#39;t initialised yet,</span>
<span class="cm">	 * use the default. We can do that since we take the</span>
<span class="cm">	 * minimum below, and we don&#39;t want to go above our</span>
<span class="cm">	 * default due to hardware restrictions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">max_agg_bufsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">max_agg_bufsize</span> <span class="o">=</span>
			<span class="n">LINK_QUAL_AGG_FRAME_LIMIT_DEF</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Even though in theory the peer could have different</span>
<span class="cm">	 * aggregation reorder buffer sizes for different sessions,</span>
<span class="cm">	 * our ucode doesn&#39;t allow for that and has a global limit</span>
<span class="cm">	 * for each station. Therefore, use the minimum of all the</span>
<span class="cm">	 * aggregation sessions and our default value.</span>
<span class="cm">	 */</span>
	<span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">max_agg_bufsize</span> <span class="o">=</span>
		<span class="n">min</span><span class="p">(</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">max_agg_bufsize</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">use_rts_for_aggregation</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * switch to RTS/CTS if it is the prefer protection</span>
<span class="cm">		 * method for HT traffic</span>
<span class="cm">		 */</span>

		<span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">lq_sta</span><span class="p">.</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
			<span class="n">LINK_QUAL_FLAGS_SET_STA_TLC_RTS_MSK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">agg_tids_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">IWL_DEBUG_HT</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;priv-&gt;agg_tids_count = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">agg_tids_count</span><span class="p">);</span>

	<span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">lq_sta</span><span class="p">.</span><span class="n">lq</span><span class="p">.</span><span class="n">agg_params</span><span class="p">.</span><span class="n">agg_frame_cnt_limit</span> <span class="o">=</span>
		<span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">max_agg_bufsize</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_HT</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Tx aggregation enabled on ra = %pM tid = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">iwl_send_lq_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">lq_sta</span><span class="p">.</span><span class="n">lq</span><span class="p">,</span> <span class="n">CMD_ASYNC</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_check_ratid_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_tid_data</span> <span class="o">*</span><span class="n">tid_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">iwl_rxon_context_id</span> <span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">ctx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">ctxid</span><span class="p">;</span>
	<span class="n">vif</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">ctx</span><span class="p">].</span><span class="n">vif</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IWL_EMPTYING_HW_QUEUE_DELBA</span>:
		<span class="cm">/* There are no packets for this RA / TID in the HW any more */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">ssn</span> <span class="o">==</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">next_reclaimed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_DEBUG_TX_QUEUES</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				<span class="s">&quot;Can continue DELBA flow ssn = next_recl =&quot;</span>
				<span class="s">&quot; %d&quot;</span><span class="p">,</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">next_reclaimed</span><span class="p">);</span>
			<span class="n">iwl_trans_tx_agg_disable</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">,</span>
						 <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span><span class="p">);</span>
			<span class="n">iwlagn_dealloc_agg_txq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span><span class="p">);</span>
			<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWL_AGG_OFF</span><span class="p">;</span>
			<span class="n">ieee80211_stop_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWL_EMPTYING_HW_QUEUE_ADDBA</span>:
		<span class="cm">/* There are no packets for this RA / TID in the HW any more */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">ssn</span> <span class="o">==</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">next_reclaimed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_DEBUG_TX_QUEUES</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				<span class="s">&quot;Can continue ADDBA flow ssn = next_recl =&quot;</span>
				<span class="s">&quot; %d&quot;</span><span class="p">,</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">next_reclaimed</span><span class="p">);</span>
			<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IWL_AGG_STARTING</span><span class="p">;</span>
			<span class="n">ieee80211_start_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_non_agg_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_station_priv</span> <span class="o">*</span><span class="n">sta_priv</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ieee80211_find_sta</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">addr1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
		<span class="cm">/* avoid atomic ops if this isn&#39;t a client */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">&amp;&amp;</span>
		    <span class="n">atomic_dec_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">pending_frames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ieee80211_sta_block_awake</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * translate ucode response to mac80211 tx status control values</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_hwrate_to_tx_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate_n_flags</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">antenna</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_ANT_ABC_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">RATE_MCS_ANT_POS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT_MSK</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_GF_MSK</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_GREEN_FIELD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT40_MSK</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_DUP_MSK</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_DUP_DATA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_SGI_MSK</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">iwlagn_hwrate_to_mac80211_idx</span><span class="p">(</span><span class="n">rate_n_flags</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IWLWIFI_DEBUG</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">iwl_get_tx_fail_reason</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define TX_STATUS_FAIL(x) case TX_STATUS_FAIL_ ## x: return #x</span>
<span class="cp">#define TX_STATUS_POSTPONE(x) case TX_STATUS_POSTPONE_ ## x: return #x</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_MSK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TX_STATUS_SUCCESS</span>:
		<span class="k">return</span> <span class="s">&quot;SUCCESS&quot;</span><span class="p">;</span>
	<span class="n">TX_STATUS_POSTPONE</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
	<span class="n">TX_STATUS_POSTPONE</span><span class="p">(</span><span class="n">FEW_BYTES</span><span class="p">);</span>
	<span class="n">TX_STATUS_POSTPONE</span><span class="p">(</span><span class="n">BT_PRIO</span><span class="p">);</span>
	<span class="n">TX_STATUS_POSTPONE</span><span class="p">(</span><span class="n">QUIET_PERIOD</span><span class="p">);</span>
	<span class="n">TX_STATUS_POSTPONE</span><span class="p">(</span><span class="n">CALC_TTAK</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">INTERNAL_CROSSED_RETRY</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">SHORT_LIMIT</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">LONG_LIMIT</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">FIFO_UNDERRUN</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">DRAIN_FLOW</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">RFKILL_FLUSH</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">LIFE_EXPIRE</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">DEST_PS</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">HOST_ABORTED</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">BT_RETRY</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">STA_INVALID</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">FRAG_DROPPED</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">TID_DISABLE</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">FIFO_FLUSHED</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">INSUFFICIENT_CF_POLL</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">PASSIVE_NO_RX</span><span class="p">);</span>
	<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">NO_BEACON_ON_RADAR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>

<span class="cp">#undef TX_STATUS_FAIL</span>
<span class="cp">#undef TX_STATUS_POSTPONE</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IWLWIFI_DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_count_agg_tx_err_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">AGG_TX_STATUS_MSK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_UNDERRUN_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">underrun</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_BT_PRIO_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">bt_prio</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_FEW_BYTES_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">few_bytes</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_ABORT_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">abort</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_LAST_SENT_TTL_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">last_sent_ttl</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_LAST_SENT_TRY_CNT_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">last_sent_try</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_LAST_SENT_BT_KILL_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">last_sent_bt_kill</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_SCD_QUERY_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">scd_query</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_TEST_BAD_CRC32_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">bad_crc32</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_RESPONSE_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">response</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_DUMP_TX_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">dump_tx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_DELAY_TX_MSK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">delay_tx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_agg_tx_stats</span><span class="p">.</span><span class="n">unknown</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwl_rx_reply_tx_agg</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iwlagn_tx_resp</span> <span class="o">*</span><span class="n">tx_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">agg_tx_status</span> <span class="o">*</span><span class="n">frame_status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tid</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">ra_tid</span> <span class="o">&amp;</span> <span class="n">IWLAGN_TX_RES_TID_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">IWLAGN_TX_RES_TID_POS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sta_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">ra_tid</span> <span class="o">&amp;</span> <span class="n">IWLAGN_TX_RES_RA_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">IWLAGN_TX_RES_RA_POS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_ht_agg</span> <span class="o">*</span><span class="n">agg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">tid</span> <span class="o">==</span> <span class="n">IWL_TID_NON_QOS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">wait_for_ba</span><span class="p">)</span>
		<span class="n">IWL_DEBUG_TX_REPLY</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="s">&quot;got tx response w/o block-ack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">agg</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span><span class="p">);</span>
	<span class="n">agg</span><span class="o">-&gt;</span><span class="n">wait_for_ba</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the BT kill count is non-zero, we&#39;ll get this</span>
<span class="cm">	 * notification again.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">bt_kill_count</span> <span class="o">&amp;&amp;</span> <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">advanced_bt_coexist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;receive reply tx w/ bt_kill</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Construct bit-map of pending frames within Tx window */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">fstatus</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">frame_status</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AGG_TX_STATUS_MSK</span><span class="p">)</span>
			<span class="n">iwlagn_count_agg_tx_err_status</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fstatus</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AGG_TX_STATE_FEW_BYTES_MSK</span> <span class="o">|</span>
			      <span class="n">AGG_TX_STATE_ABORT_MSK</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">IWL_DEBUG_TX_REPLY</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;status %s (0x%08x), &quot;</span>
				   <span class="s">&quot;try-count (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">iwl_get_agg_tx_fail_reason</span><span class="p">(</span><span class="n">fstatus</span><span class="p">),</span>
				   <span class="n">fstatus</span> <span class="o">&amp;</span> <span class="n">AGG_TX_STATUS_MSK</span><span class="p">,</span>
				   <span class="n">fstatus</span> <span class="o">&amp;</span> <span class="n">AGG_TX_TRY_MSK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IWLWIFI_DEBUG</span>
<span class="cp">#define AGG_TX_STATE_FAIL(x) case AGG_TX_STATE_ ## x: return #x</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">iwl_get_agg_tx_fail_reason</span><span class="p">(</span><span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">AGG_TX_STATUS_MSK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AGG_TX_STATE_TRANSMITTED</span>:
		<span class="k">return</span> <span class="s">&quot;SUCCESS&quot;</span><span class="p">;</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">UNDERRUN_MSK</span><span class="p">);</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">BT_PRIO_MSK</span><span class="p">);</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">FEW_BYTES_MSK</span><span class="p">);</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">ABORT_MSK</span><span class="p">);</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">LAST_SENT_TTL_MSK</span><span class="p">);</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">LAST_SENT_TRY_CNT_MSK</span><span class="p">);</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">LAST_SENT_BT_KILL_MSK</span><span class="p">);</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">SCD_QUERY_MSK</span><span class="p">);</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">TEST_BAD_CRC32_MSK</span><span class="p">);</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">RESPONSE_MSK</span><span class="p">);</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">DUMP_TX_MSK</span><span class="p">);</span>
		<span class="n">AGG_TX_STATE_FAIL</span><span class="p">(</span><span class="n">DELAY_TX_MSK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IWLWIFI_DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">iwlagn_get_scd_ssn</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwlagn_tx_resp</span> <span class="o">*</span><span class="n">tx_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le32_to_cpup</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">+</span>
			    <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_SN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_count_tx_err_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">TX_STATUS_MSK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TX_STATUS_POSTPONE_DELAY</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">pp_delay</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_POSTPONE_FEW_BYTES</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">pp_few_bytes</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_POSTPONE_BT_PRIO</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">pp_bt_prio</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_POSTPONE_QUIET_PERIOD</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">pp_quiet_period</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_POSTPONE_CALC_TTAK</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">pp_calc_ttak</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_INTERNAL_CROSSED_RETRY</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">int_crossed_retry</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_SHORT_LIMIT</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">short_limit</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_LONG_LIMIT</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">long_limit</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_FIFO_UNDERRUN</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">fifo_underrun</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_DRAIN_FLOW</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">drain_flow</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_RFKILL_FLUSH</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">rfkill_flush</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_LIFE_EXPIRE</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">life_expire</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_DEST_PS</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">dest_ps</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_HOST_ABORTED</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">host_abort</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_BT_RETRY</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">bt_retry</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_STA_INVALID</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">sta_invalid</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_FRAG_DROPPED</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">frag_drop</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_TID_DISABLE</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">tid_disable</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_FIFO_FLUSHED</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">fifo_flush</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_INSUFFICIENT_CF_POLL</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">insuff_cf_poll</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_PASSIVE_NO_RX</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">fail_hw_drop</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_NO_BEACON_ON_RADAR</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">sta_color_mismatch</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reply_tx_stats</span><span class="p">.</span><span class="n">unknown</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_set_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iwlagn_tx_resp</span> <span class="o">*</span><span class="n">tx_resp</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="n">is_agg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span>  <span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">failure_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_agg</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">iwl_tx_status_to_mac80211</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
	<span class="n">iwlagn_hwrate_to_tx_control</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span><span class="p">),</span>
				    <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwl_is_tx_success</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">iwlagn_count_tx_err_status</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwl_check_abort_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="n">frame_count</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">==</span> <span class="n">TX_STATUS_FAIL_RFKILL_FLUSH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Tx flush command to flush out all frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_flush</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sta_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">txq_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ssn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">skbs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">txq_id</span> <span class="o">&gt;=</span> <span class="n">IWLAGN_FIRST_AMPDU_QUEUE</span> <span class="o">&amp;&amp;</span>
		     <span class="n">tid</span> <span class="o">!=</span> <span class="n">IWL_TID_NON_QOS</span> <span class="o">&amp;&amp;</span>
		     <span class="n">txq_id</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: this is a uCode bug which need to be addressed,</span>
<span class="cm">		 * log the information and return for now.</span>
<span class="cm">		 * Since it is can possibly happen very often and in order</span>
<span class="cm">		 * not to fill the syslog, don&#39;t use IWL_ERR or IWL_WARN</span>
<span class="cm">		 */</span>
		<span class="n">IWL_DEBUG_TX_QUEUES</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="s">&quot;Bad queue mapping txq_id=%d, agg_txq[sta:%d,tid:%d]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">txq_id</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iwl_trans_reclaim</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">ssn</span><span class="p">,</span> <span class="n">skbs</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_rx_reply_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwl_rx_cmd_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iwl_device_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rx_packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">sequence</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">sequence</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">txq_id</span> <span class="o">=</span> <span class="n">SEQ_TO_QUEUE</span><span class="p">(</span><span class="n">sequence</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">cmd_index</span> <span class="n">__maybe_unused</span> <span class="o">=</span> <span class="n">SEQ_TO_INDEX</span><span class="p">(</span><span class="n">sequence</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwlagn_tx_resp</span> <span class="o">*</span><span class="n">tx_resp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">ssn</span> <span class="o">=</span> <span class="n">iwlagn_get_scd_ssn</span><span class="p">(</span><span class="n">tx_resp</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">skbs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_agg</span> <span class="o">=</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">&gt;=</span> <span class="n">IWLAGN_FIRST_AMPDU_QUEUE</span><span class="p">);</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">ra_tid</span> <span class="o">&amp;</span> <span class="n">IWLAGN_TX_RES_TID_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">IWLAGN_TX_RES_TID_POS</span><span class="p">;</span>
	<span class="n">sta_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">ra_tid</span> <span class="o">&amp;</span> <span class="n">IWLAGN_TX_RES_RA_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">IWLAGN_TX_RES_RA_POS</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_agg</span><span class="p">)</span>
		<span class="n">iwl_rx_reply_tx_agg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx_resp</span><span class="p">);</span>

	<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skbs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">next_reclaimed</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>
		<span class="n">next_reclaimed</span> <span class="o">=</span> <span class="n">SEQ_TO_SN</span><span class="p">(</span><span class="n">next_reclaimed</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_agg</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If this is an aggregation queue, we can rely on the</span>
<span class="cm">			 * ssn since the wifi sequence number corresponds to</span>
<span class="cm">			 * the index in the TFD ring (%256).</span>
<span class="cm">			 * The seq_ctl is the sequence control of the packet</span>
<span class="cm">			 * to which this Tx response relates. But if there is a</span>
<span class="cm">			 * hole in the bitmap of the BA we received, this Tx</span>
<span class="cm">			 * response may allow to reclaim the hole and all the</span>
<span class="cm">			 * subsequent packets that were already acked.</span>
<span class="cm">			 * In that case, seq_ctl != ssn, and the next packet</span>
<span class="cm">			 * to be reclaimed will be ssn and not seq_ctl.</span>
<span class="cm">			 */</span>
			<span class="n">next_reclaimed</span> <span class="o">=</span> <span class="n">ssn</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">!=</span> <span class="n">IWL_TID_NON_QOS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">next_reclaimed</span> <span class="o">=</span>
				<span class="n">next_reclaimed</span><span class="p">;</span>
			<span class="n">IWL_DEBUG_TX_REPLY</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Next reclaimed packet:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">next_reclaimed</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*we can free until ssn % q.n_bd not inclusive */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">iwl_reclaim</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">ssn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skbs</span><span class="p">));</span>
		<span class="n">iwlagn_check_ratid_empty</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">freed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* process frames */</span>
		<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_seq_ctl</span> <span class="o">=</span> <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">;</span>

			<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">ctx</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">iwl_tx_cmd_pool</span><span class="p">,</span>
					<span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TX_STATUS_FAIL_PASSIVE_NO_RX</span> <span class="o">&amp;&amp;</span>
			    <span class="n">iwl_is_associated_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* block and stop all queues */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">passive_no_rx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">IWL_DEBUG_TX_QUEUES</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;stop all queues: &quot;</span>
						    <span class="s">&quot;passive channel&quot;</span><span class="p">);</span>
				<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

				<span class="n">IWL_DEBUG_TX_REPLY</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					   <span class="s">&quot;TXQ %d status %s (0x%08x) &quot;</span>
					   <span class="s">&quot;rate_n_flags 0x%x retries %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">txq_id</span><span class="p">,</span>
					   <span class="n">iwl_get_tx_fail_reason</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
					   <span class="n">status</span><span class="p">,</span>
					   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span><span class="p">),</span>
					   <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">failure_frame</span><span class="p">);</span>

				<span class="n">IWL_DEBUG_TX_REPLY</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					   <span class="s">&quot;FrameCnt = %d, idx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">,</span> <span class="n">cmd_index</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* check if BAR is needed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_agg</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">iwl_is_tx_success</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_AMPDU_NO_BACK</span><span class="p">;</span>
			<span class="n">iwlagn_set_tx_status</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				     <span class="n">tx_resp</span><span class="p">,</span> <span class="n">is_agg</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_agg</span><span class="p">)</span>
				<span class="n">iwlagn_non_agg_tx_status</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>

			<span class="n">freed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">is_agg</span> <span class="o">&amp;&amp;</span> <span class="n">freed</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iwl_check_abort_status</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skbs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skbs</span><span class="p">);</span>
		<span class="n">ieee80211_tx_status</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iwlagn_rx_reply_compressed_ba - Handler for REPLY_COMPRESSED_BA</span>
<span class="cm"> *</span>
<span class="cm"> * Handles block-acknowledge notification from device, which reports success</span>
<span class="cm"> * of frames sent via aggregation.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwlagn_rx_reply_compressed_ba</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iwl_rx_cmd_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">iwl_device_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rx_packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwl_compressed_ba_resp</span> <span class="o">*</span><span class="n">ba_resp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_ht_agg</span> <span class="o">*</span><span class="n">agg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">reclaimed_skbs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freed</span><span class="p">;</span>

	<span class="cm">/* &quot;flow&quot; corresponds to Tx queue */</span>
	<span class="n">u16</span> <span class="n">scd_flow</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">scd_flow</span><span class="p">);</span>

	<span class="cm">/* &quot;ssn&quot; is start of block-ack Tx window, corresponds to index</span>
<span class="cm">	 * (in Tx queue&#39;s circular buffer) of first TFD/frame in window */</span>
	<span class="n">u16</span> <span class="n">ba_resp_scd_ssn</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">scd_ssn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scd_flow</span> <span class="o">&gt;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">base_params</span><span class="o">-&gt;</span><span class="n">num_of_queues</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="s">&quot;BUG_ON scd_flow is bigger than number of queues</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">sta_id</span><span class="p">;</span>
	<span class="n">tid</span> <span class="o">=</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">;</span>
	<span class="n">agg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">wait_for_ba</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">))</span>
			<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Received BA when not expected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reclaimed_skbs</span><span class="p">);</span>

	<span class="cm">/* Release all TFDs before the SSN, i.e. all TFDs in front of</span>
<span class="cm">	 * block-ack window (we assume that they&#39;ve been successfully</span>
<span class="cm">	 * transmitted ... if not, it&#39;s too late anyway). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iwl_reclaim</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">scd_flow</span><span class="p">,</span>
			<span class="n">ba_resp_scd_ssn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reclaimed_skbs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IWL_DEBUG_TX_REPLY</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;REPLY_COMPRESSED_BA [%d] Received from %pM, &quot;</span>
			   <span class="s">&quot;sta_id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">agg</span><span class="o">-&gt;</span><span class="n">wait_for_ba</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">sta_addr_lo32</span><span class="p">,</span>
			   <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">sta_id</span><span class="p">);</span>
	<span class="n">IWL_DEBUG_TX_REPLY</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;TID = %d, SeqCtl = %d, bitmap = 0x%llx, &quot;</span>
			   <span class="s">&quot;scd_flow = %d, scd_ssn = %d sent:%d, acked:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">),</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">),</span>
			   <span class="n">scd_flow</span><span class="p">,</span> <span class="n">ba_resp_scd_ssn</span><span class="p">,</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">txed</span><span class="p">,</span>
			   <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">txed_2_done</span><span class="p">);</span>

	<span class="cm">/* Mark that the expected block-ack response arrived */</span>
	<span class="n">agg</span><span class="o">-&gt;</span><span class="n">wait_for_ba</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Sanity check values reported by uCode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">txed_2_done</span> <span class="o">&gt;</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">txed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_TX_REPLY</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="s">&quot;bogus sent(%d) and ack(%d) count</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">txed</span><span class="p">,</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">txed_2_done</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * set txed_2_done = txed,</span>
<span class="cm">		 * so it won&#39;t impact rate scale</span>
<span class="cm">		 */</span>
		<span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">txed</span> <span class="o">=</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">txed_2_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">sta_id</span><span class="p">][</span><span class="n">tid</span><span class="p">].</span><span class="n">next_reclaimed</span> <span class="o">=</span> <span class="n">ba_resp_scd_ssn</span><span class="p">;</span>

	<span class="n">iwlagn_check_ratid_empty</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">freed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reclaimed_skbs</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
			<span class="n">freed</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">kmem_cache_free</span><span class="p">(</span><span class="n">iwl_tx_cmd_pool</span><span class="p">,</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">freed</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* this is the first skb we deliver in this batch */</span>
			<span class="cm">/* put the rate scaling data there */</span>
			<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_AMPDU</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span> <span class="o">=</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">txed_2_done</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span> <span class="o">=</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">txed</span><span class="p">;</span>
			<span class="n">iwlagn_hwrate_to_tx_control</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span><span class="p">,</span>
						    <span class="n">info</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reclaimed_skbs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reclaimed_skbs</span><span class="p">);</span>
		<span class="n">ieee80211_tx_status</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
