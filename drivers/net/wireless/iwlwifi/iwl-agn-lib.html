<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › iwlwifi › iwl-agn-lib.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>iwl-agn-lib.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * GPL LICENSE SUMMARY</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2008 - 2012 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110,</span>
<span class="cm"> * USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution</span>
<span class="cm"> * in the file called LICENSE.GPL.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> *  Intel Linux Wireless &lt;ilw@linux.intel.com&gt;</span>
<span class="cm"> * Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>

<span class="cp">#include &quot;iwl-dev.h&quot;</span>
<span class="cp">#include &quot;iwl-io.h&quot;</span>
<span class="cp">#include &quot;iwl-agn-hw.h&quot;</span>
<span class="cp">#include &quot;iwl-agn.h&quot;</span>
<span class="cp">#include &quot;iwl-trans.h&quot;</span>
<span class="cp">#include &quot;iwl-modparams.h&quot;</span>

<span class="kt">int</span> <span class="nf">iwlagn_hw_valid_rtc_data_addr</span><span class="p">(</span><span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">IWLAGN_RTC_DATA_LOWER_BOUND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">IWLAGN_RTC_DATA_UPPER_BOUND</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_send_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwlagn_tx_power_dbm_cmd</span> <span class="n">tx_power_cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_ant_cfg_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ONCE</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span>
		      <span class="s">&quot;TX Power requested while scanning!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/* half dBm need to multiply */</span>
	<span class="n">tx_power_cmd</span><span class="p">.</span><span class="n">global_lmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_user_lmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_lmt_in_half_dbm</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_lmt_in_half_dbm</span> <span class="o">&lt;</span> <span class="n">tx_power_cmd</span><span class="p">.</span><span class="n">global_lmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For the newer devices which using enhanced/extend tx power</span>
<span class="cm">		 * table in EEPROM, the format is in half dBm. driver need to</span>
<span class="cm">		 * convert to dBm format before report to mac80211.</span>
<span class="cm">		 * By doing so, there is a possibility of 1/2 dBm resolution</span>
<span class="cm">		 * lost. driver will perform &quot;round-up&quot; operation before</span>
<span class="cm">		 * reporting, but it will cause 1/2 dBm tx power over the</span>
<span class="cm">		 * regulatory limit. Perform the checking here, if the</span>
<span class="cm">		 * &quot;tx_power_user_lmt&quot; is higher than EEPROM value (in</span>
<span class="cm">		 * half-dBm format), lower the tx power based on EEPROM</span>
<span class="cm">		 */</span>
		<span class="n">tx_power_cmd</span><span class="p">.</span><span class="n">global_lmt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_lmt_in_half_dbm</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tx_power_cmd</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IWLAGN_TX_POWER_NO_CLOSED</span><span class="p">;</span>
	<span class="n">tx_power_cmd</span><span class="p">.</span><span class="n">srv_chan_lmt</span> <span class="o">=</span> <span class="n">IWLAGN_TX_POWER_AUTO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IWL_UCODE_API</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tx_ant_cfg_cmd</span> <span class="o">=</span> <span class="n">REPLY_TX_POWER_DBM_CMD_V1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tx_ant_cfg_cmd</span> <span class="o">=</span> <span class="n">REPLY_TX_POWER_DBM_CMD</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx_ant_cfg_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">tx_power_cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tx_power_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_temperature</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* store temperature from correct statistics (in Celsius) */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">temperature</span><span class="p">);</span>
	<span class="n">iwl_tt_handler</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_hwrate_to_mac80211_idx</span><span class="p">(</span><span class="n">u32</span> <span class="n">rate_n_flags</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">band_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* HT rate format: mac80211 wants an MCS number, which is just LSB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
	<span class="cm">/* Legacy rate format, search for match in table */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">band_offset</span> <span class="o">=</span> <span class="n">IWL_FIRST_OFDM_RATE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">band_offset</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">IWL_RATE_COUNT_LEGACY</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iwl_rates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">plcp</span> <span class="o">==</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">band_offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_manage_ibss_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">bool</span> <span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_vif_priv</span> <span class="o">*</span><span class="n">vif_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">iwlagn_add_bssid_station</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif_priv</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span>
						<span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">vif_priv</span><span class="o">-&gt;</span><span class="n">ibss_bssid_sta_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">iwl_remove_station</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif_priv</span><span class="o">-&gt;</span><span class="n">ibss_bssid_sta_id</span><span class="p">,</span>
				  <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iwlagn_txfifo_flush: send REPLY_TXFIFO_FLUSH command to uCode</span>
<span class="cm"> *</span>
<span class="cm"> * pre-requirements:</span>
<span class="cm"> *  1. acquire mutex before calling</span>
<span class="cm"> *  2. make sure rf is on and not in exit state</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwlagn_txfifo_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flush_control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_txfifo_flush_cmd</span> <span class="n">flush_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_host_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">REPLY_TXFIFO_FLUSH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_txfifo_flush_cmd</span><span class="p">),</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CMD_SYNC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">flush_cmd</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flush_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">flush_cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flush_control</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">))</span>
		<span class="n">flush_cmd</span><span class="p">.</span><span class="n">fifo_control</span> <span class="o">=</span> <span class="n">IWL_SCD_VO_MSK</span> <span class="o">|</span> <span class="n">IWL_SCD_VI_MSK</span> <span class="o">|</span>
				 <span class="n">IWL_SCD_BE_MSK</span> <span class="o">|</span> <span class="n">IWL_SCD_BK_MSK</span> <span class="o">|</span>
				 <span class="n">IWL_SCD_MGMT_MSK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flush_control</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IWL_RXON_CTX_PAN</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">valid_contexts</span> <span class="o">!=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">)))</span>
		<span class="n">flush_cmd</span><span class="p">.</span><span class="n">fifo_control</span> <span class="o">|=</span> <span class="n">IWL_PAN_SCD_VO_MSK</span> <span class="o">|</span>
				<span class="n">IWL_PAN_SCD_VI_MSK</span> <span class="o">|</span> <span class="n">IWL_PAN_SCD_BE_MSK</span> <span class="o">|</span>
				<span class="n">IWL_PAN_SCD_BK_MSK</span> <span class="o">|</span> <span class="n">IWL_PAN_SCD_MGMT_MSK</span> <span class="o">|</span>
				<span class="n">IWL_PAN_SCD_MULTICAST_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">sku</span> <span class="o">&amp;</span> <span class="n">EEPROM_SKU_CAP_11N_ENABLE</span><span class="p">)</span>
		<span class="n">flush_cmd</span><span class="p">.</span><span class="n">fifo_control</span> <span class="o">|=</span> <span class="n">IWL_AGG_TX_QUEUE_MSK</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;fifo queue control: 0X%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">flush_cmd</span><span class="p">.</span><span class="n">fifo_control</span><span class="p">);</span>
	<span class="n">flush_cmd</span><span class="p">.</span><span class="n">flush_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">flush_control</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">iwl_dvm_send_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_dev_txfifo_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">flush_control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iwlagn_txfifo_flush</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IWL_DROP_ALL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;flush request fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IWL_DEBUG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;wait transmit/flush all frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">iwl_trans_wait_tx_queue_empty</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * BT coex</span>
<span class="cm"> */</span>
<span class="cm">/* Notmal TDM */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">__le32</span> <span class="n">iwlagn_def_3w_lookup</span><span class="p">[</span><span class="n">IWLAGN_BT_DECISION_LUT_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaeaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xcc00ff28</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x0000aaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xcc00aaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x0000aaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xc0004000</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00004000</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xf0005000</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xf0005000</span><span class="p">),</span>
<span class="p">};</span>


<span class="cm">/* Loose Coex */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">__le32</span> <span class="n">iwlagn_loose_lookup</span><span class="p">[</span><span class="n">IWLAGN_BT_DECISION_LUT_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaeaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xcc00ff28</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x0000aaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xcc00aaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x0000aaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xf0005000</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xf0005000</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Full concurrency */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">__le32</span> <span class="n">iwlagn_concurrent_lookup</span><span class="p">[</span><span class="n">IWLAGN_BT_DECISION_LUT_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xaaaaaaaa</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">),</span>
	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">),</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">iwlagn_send_advance_bt_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_basic_bt_cmd</span> <span class="n">basic</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">max_kill</span> <span class="o">=</span> <span class="n">IWLAGN_BT_MAX_KILL_DEFAULT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bt3_timer_t7_value</span> <span class="o">=</span> <span class="n">IWLAGN_BT3_T7_DEFAULT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bt3_prio_sample_time</span> <span class="o">=</span> <span class="n">IWLAGN_BT3_PRIO_SAMPLE_DEFAULT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bt3_timer_t2_value</span> <span class="o">=</span> <span class="n">IWLAGN_BT3_T2_DEFAULT</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">iwl_bt_cmd_v1</span> <span class="n">bt_cmd_v1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_bt_cmd_v2</span> <span class="n">bt_cmd_v2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">iwlagn_def_3w_lookup</span><span class="p">)</span> <span class="o">!=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">basic</span><span class="p">.</span><span class="n">bt3_lookup_table</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * newer generation of devices (2000 series and newer)</span>
<span class="cm">		 * use the version 2 of the bt command</span>
<span class="cm">		 * we need to make sure sending the host command</span>
<span class="cm">		 * with correct data structure to avoid uCode assert</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">bt_session_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bt_cmd_v2</span><span class="p">.</span><span class="n">prio_boost</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">bt_prio_boost</span><span class="p">);</span>
			<span class="n">bt_cmd_v2</span><span class="p">.</span><span class="n">tx_prio_boost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bt_cmd_v2</span><span class="p">.</span><span class="n">rx_prio_boost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bt_cmd_v1</span><span class="p">.</span><span class="n">prio_boost</span> <span class="o">=</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">bt_prio_boost</span><span class="p">;</span>
			<span class="n">bt_cmd_v1</span><span class="p">.</span><span class="n">tx_prio_boost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bt_cmd_v1</span><span class="p">.</span><span class="n">rx_prio_boost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;failed to construct BT Coex Config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Possible situations when BT needs to take over for receive,</span>
<span class="cm">	 * at the same time where STA needs to response to AP&#39;s frame(s),</span>
<span class="cm">	 * reduce the tx power of the required response frames, by that,</span>
<span class="cm">	 * allow the concurrent BT receive &amp; WiFi transmit</span>
<span class="cm">	 * (BT - ANT A, WiFi -ANT B), without interference to one another</span>
<span class="cm">	 *</span>
<span class="cm">	 * Reduced tx power apply to control frames only (ACK/Back/CTS)</span>
<span class="cm">	 * when indicated by the BT config command</span>
<span class="cm">	 */</span>
	<span class="n">basic</span><span class="p">.</span><span class="n">kill_ack_mask</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">kill_ack_mask</span><span class="p">;</span>
	<span class="n">basic</span><span class="p">.</span><span class="n">kill_cts_mask</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">kill_cts_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reduced_txpower</span><span class="p">)</span>
		<span class="n">basic</span><span class="p">.</span><span class="n">reduce_txpower</span> <span class="o">=</span> <span class="n">IWLAGN_BT_REDUCED_TX_PWR</span><span class="p">;</span>
	<span class="n">basic</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_valid</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure BT coex mode to &quot;no coexistence&quot; when the</span>
<span class="cm">	 * user disabled BT coexistence, we have no interface</span>
<span class="cm">	 * (might be in monitor mode), or the interface is in</span>
<span class="cm">	 * IBSS mode (no proper uCode support for coex then).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwlwifi_mod_params</span><span class="p">.</span><span class="n">bt_coex_active</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">basic</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IWLAGN_BT_FLAG_COEX_MODE_DISABLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">basic</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IWLAGN_BT_FLAG_COEX_MODE_3W</span> <span class="o">&lt;&lt;</span>
					<span class="n">IWLAGN_BT_FLAG_COEX_MODE_SHIFT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_enable_pspoll</span><span class="p">)</span>
			<span class="n">basic</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IWLAGN_BT_FLAG_SYNC_2_BT_DISABLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">basic</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IWLAGN_BT_FLAG_SYNC_2_BT_DISABLE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_ch_announce</span><span class="p">)</span>
			<span class="n">basic</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IWLAGN_BT_FLAG_CHANNEL_INHIBITION</span><span class="p">;</span>
		<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;BT coex flag: 0X%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">basic</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_enable_flag</span> <span class="o">=</span> <span class="n">basic</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_full_concurrent</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">basic</span><span class="p">.</span><span class="n">bt3_lookup_table</span><span class="p">,</span> <span class="n">iwlagn_concurrent_lookup</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">iwlagn_concurrent_lookup</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">basic</span><span class="p">.</span><span class="n">bt3_lookup_table</span><span class="p">,</span> <span class="n">iwlagn_def_3w_lookup</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">iwlagn_def_3w_lookup</span><span class="p">));</span>

	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;BT coex %s in %s mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">basic</span><span class="p">.</span><span class="n">flags</span> <span class="o">?</span> <span class="s">&quot;active&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_full_concurrent</span> <span class="o">?</span>
		       <span class="s">&quot;full concurrency&quot;</span> <span class="o">:</span> <span class="s">&quot;3-wire&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">bt_session_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_cmd_v2</span><span class="p">.</span><span class="n">basic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">basic</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">basic</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">REPLY_BT_CONFIG</span><span class="p">,</span>
			<span class="n">CMD_SYNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bt_cmd_v2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bt_cmd_v2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bt_cmd_v1</span><span class="p">.</span><span class="n">basic</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">basic</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">basic</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">REPLY_BT_CONFIG</span><span class="p">,</span>
			<span class="n">CMD_SYNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bt_cmd_v1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">bt_cmd_v1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;failed to send BT Coex Config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_bt_adjust_rssi_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">rssi_ena</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="o">*</span><span class="n">found_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found_ap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Check whether AP or GO mode is active. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rssi_ena</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">for_each_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
			    <span class="n">iwl_is_associated_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">found_ap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If disable was received or If GO/AP mode, disable RSSI</span>
<span class="cm">	 * measurements.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rssi_ena</span> <span class="o">||</span> <span class="n">found_ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_rssi_ctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_rssi_ctx</span><span class="p">;</span>
			<span class="n">ieee80211_disable_rssi_reports</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_rssi_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If rssi measurements need to be enabled, consider all cases now.</span>
<span class="cm">	 * Figure out how many contexts are active.</span>
<span class="cm">	 */</span>
	<span class="n">for_each_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
		    <span class="n">iwl_is_associated_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">found_ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * rssi monitor already enabled for the correct interface...nothing</span>
<span class="cm">	 * to do.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found_ctx</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_rssi_ctx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Figure out if rssi monitor is currently enabled, and needs</span>
<span class="cm">	 * to be changed. If rssi monitor is already enabled, disable</span>
<span class="cm">	 * it first else just enable rssi measurements on the</span>
<span class="cm">	 * interface found above.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_rssi_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_rssi_ctx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span>
			<span class="n">ieee80211_disable_rssi_reports</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_rssi_ctx</span> <span class="o">=</span> <span class="n">found_ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found_ctx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ieee80211_enable_rssi_reports</span><span class="p">(</span><span class="n">found_ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span>
			<span class="n">IWLAGN_BT_PSP_MIN_RSSI_THRESHOLD</span><span class="p">,</span>
			<span class="n">IWLAGN_BT_PSP_MAX_RSSI_THRESHOLD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">iwlagn_bt_traffic_is_sco</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_bt_uart_msg</span> <span class="o">*</span><span class="n">uart_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">BT_UART_MSG_FRAME3SCOESCO_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME3SCOESCO_POS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_bt_traffic_change_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwl_priv</span><span class="p">,</span> <span class="n">bt_traffic_change_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">smps_request</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_enable_flag</span> <span class="o">==</span> <span class="n">IWLAGN_BT_FLAG_COEX_MODE_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* bt coex disabled */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: bt_traffic_load can be overridden by scan complete and</span>
<span class="cm">	 * coex profile notifications. Ignore that since only bad consequence</span>
<span class="cm">	 * can be not matching debug print with actual state.</span>
<span class="cm">	 */</span>
	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;BT traffic load changes: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IWL_BT_COEX_TRAFFIC_LOAD_NONE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_status</span><span class="p">)</span>
			<span class="n">smps_request</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_DYNAMIC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">smps_request</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_AUTOMATIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWL_BT_COEX_TRAFFIC_LOAD_LOW</span>:
		<span class="n">smps_request</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_DYNAMIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWL_BT_COEX_TRAFFIC_LOAD_HIGH</span>:
	<span class="k">case</span> <span class="n">IWL_BT_COEX_TRAFFIC_LOAD_CONTINUOUS</span>:
		<span class="n">smps_request</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_STATIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Invalid BT traffic load: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can not send command to firmware while scanning. When the scan</span>
<span class="cm">	 * complete we will schedule this work again. We do check with mutex</span>
<span class="cm">	 * locked to prevent new scan request to arrive. We do not check</span>
<span class="cm">	 * STATUS_SCANNING to avoid race when queue_work two times from</span>
<span class="cm">	 * different notifications, but quit and not perform any work at all.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">iwl_update_chain_flags</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smps_request</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">smps</span> <span class="o">=</span> <span class="n">smps_request</span><span class="p">;</span>
		<span class="n">for_each_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
				<span class="n">ieee80211_request_smps</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">smps_request</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Dynamic PS poll related functionality. Adjust RSSI measurements if</span>
<span class="cm">	 * necessary.</span>
<span class="cm">	 */</span>
	<span class="n">iwlagn_bt_coex_rssi_monitor</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If BT sco traffic, and RSSI monitor is enabled, move measurements to the</span>
<span class="cm"> * correct interface or disable it if this is the last interface to be</span>
<span class="cm"> * removed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iwlagn_bt_coex_rssi_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_is_sco</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span> <span class="o">==</span> <span class="n">IWL_BT_COEX_TRAFFIC_LOAD_CONTINUOUS</span><span class="p">)</span>
		<span class="n">iwlagn_bt_adjust_rssi_monitor</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">iwlagn_bt_adjust_rssi_monitor</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_print_uartmsg</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iwl_bt_uart_msg</span> <span class="o">*</span><span class="n">uart_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Message Type = 0x%X, SSN = 0x%X, &quot;</span>
			<span class="s">&quot;Update Req = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME1MSGTYPE_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame1</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME1MSGTYPE_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME1SSN_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame1</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME1SSN_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME1UPDATEREQ_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame1</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME1UPDATEREQ_POS</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Open connections = 0x%X, Traffic load = 0x%X, &quot;</span>
			<span class="s">&quot;Chl_SeqN = 0x%X, In band = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME2OPENCONNECTIONS_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame2</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME2OPENCONNECTIONS_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME2TRAFFICLOAD_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame2</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME2TRAFFICLOAD_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME2CHLSEQN_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame2</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME2CHLSEQN_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME2INBAND_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame2</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME2INBAND_POS</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;SCO/eSCO = 0x%X, Sniff = 0x%X, A2DP = 0x%X, &quot;</span>
			<span class="s">&quot;ACL = 0x%X, Master = 0x%X, OBEX = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME3SCOESCO_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME3SCOESCO_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME3SNIFF_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME3SNIFF_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME3A2DP_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME3A2DP_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME3ACL_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME3ACL_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME3MASTER_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME3MASTER_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME3OBEX_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME3OBEX_POS</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Idle duration = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME4IDLEDURATION_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame4</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME4IDLEDURATION_POS</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Tx Activity = 0x%X, Rx Activity = 0x%X, &quot;</span>
			<span class="s">&quot;eSCO Retransmissions = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME5TXACTIVITY_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame5</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME5TXACTIVITY_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME5RXACTIVITY_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame5</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME5RXACTIVITY_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME5ESCORETRANSMIT_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame5</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME5ESCORETRANSMIT_POS</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Sniff Interval = 0x%X, Discoverable = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME6SNIFFINTERVAL_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame6</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME6SNIFFINTERVAL_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME6DISCOVERABLE_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame6</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME6DISCOVERABLE_POS</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Sniff Activity = 0x%X, Page = &quot;</span>
			<span class="s">&quot;0x%X, Inquiry = 0x%X, Connectable = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME7SNIFFACTIVITY_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame7</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME7SNIFFACTIVITY_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME7PAGE_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame7</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME7PAGE_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME7INQUIRY_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame7</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME7INQUIRY_POS</span><span class="p">,</span>
		<span class="p">(</span><span class="n">BT_UART_MSG_FRAME7CONNECTABLE_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame7</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">BT_UART_MSG_FRAME7CONNECTABLE_POS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">iwlagn_set_kill_msk</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iwl_bt_uart_msg</span> <span class="o">*</span><span class="n">uart_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">need_update</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">kill_msk</span> <span class="o">=</span> <span class="n">IWL_BT_KILL_REDUCE</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">__le32</span> <span class="n">bt_kill_ack_msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">IWLAGN_BT_KILL_ACK_MASK_DEFAULT</span><span class="p">,</span>
		<span class="n">IWLAGN_BT_KILL_ACK_CTS_MASK_SCO</span><span class="p">,</span>
		<span class="n">IWLAGN_BT_KILL_ACK_CTS_MASK_REDUCE</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">__le32</span> <span class="n">bt_kill_cts_msg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">IWLAGN_BT_KILL_CTS_MASK_DEFAULT</span><span class="p">,</span>
		<span class="n">IWLAGN_BT_KILL_ACK_CTS_MASK_SCO</span><span class="p">,</span>
		<span class="n">IWLAGN_BT_KILL_ACK_CTS_MASK_REDUCE</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reduced_txpower</span><span class="p">)</span>
		<span class="n">kill_msk</span> <span class="o">=</span> <span class="p">(</span><span class="n">BT_UART_MSG_FRAME3SCOESCO_MSK</span> <span class="o">&amp;</span> <span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">IWL_BT_KILL_OVERRIDE</span> <span class="o">:</span> <span class="n">IWL_BT_KILL_DEFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">kill_ack_mask</span> <span class="o">!=</span> <span class="n">bt_kill_ack_msg</span><span class="p">[</span><span class="n">kill_msk</span><span class="p">]</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">kill_cts_mask</span> <span class="o">!=</span> <span class="n">bt_kill_cts_msg</span><span class="p">[</span><span class="n">kill_msk</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_valid</span> <span class="o">|=</span> <span class="n">IWLAGN_BT_VALID_KILL_ACK_MASK</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">kill_ack_mask</span> <span class="o">=</span> <span class="n">bt_kill_ack_msg</span><span class="p">[</span><span class="n">kill_msk</span><span class="p">];</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_valid</span> <span class="o">|=</span> <span class="n">IWLAGN_BT_VALID_KILL_CTS_MASK</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">kill_cts_mask</span> <span class="o">=</span> <span class="n">bt_kill_cts_msg</span><span class="p">[</span><span class="n">kill_msk</span><span class="p">];</span>
		<span class="n">need_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">need_update</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Upon RSSI changes, sends a bt config command with following changes</span>
<span class="cm"> *  1. enable/disable &quot;reduced control frames tx power</span>
<span class="cm"> *  2. update the &quot;kill)ack_mask&quot; and &quot;kill_cts_mask&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * If &quot;reduced tx power&quot; is enabled, uCode shall</span>
<span class="cm"> *  1. ACK/Back/CTS rate shall reduced to 6Mbps</span>
<span class="cm"> *  2. not use duplciate 20/40MHz mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">iwlagn_fill_txpower_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iwl_bt_uart_msg</span> <span class="o">*</span><span class="n">uart_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">need_update</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ave_rssi</span><span class="p">;</span>

	<span class="n">ave_rssi</span> <span class="o">=</span> <span class="n">ieee80211_ave_rssi</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ave_rssi</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no rssi data, no changes to reduce tx power */</span>
		<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;no rssi data available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">need_update</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reduced_txpower</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">iwl_is_associated</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IWL_RXON_CTX_PAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ave_rssi</span> <span class="o">&gt;</span> <span class="n">BT_ENABLE_REDUCED_TXPOWER_THRESHOLD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BT_UART_MSG_FRAME3ACL_MSK</span> <span class="o">|</span>
	    <span class="n">BT_UART_MSG_FRAME3OBEX_MSK</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BT_UART_MSG_FRAME3SCOESCO_MSK</span> <span class="o">|</span>
	    <span class="n">BT_UART_MSG_FRAME3SNIFF_MSK</span> <span class="o">|</span> <span class="n">BT_UART_MSG_FRAME3A2DP_MSK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* enabling reduced tx power */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reduced_txpower</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_valid</span> <span class="o">|=</span> <span class="n">IWLAGN_BT_VALID_REDUCED_TX_PWR</span><span class="p">;</span>
		<span class="n">need_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reduced_txpower</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">iwl_is_associated</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IWL_RXON_CTX_PAN</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">ave_rssi</span> <span class="o">&lt;</span> <span class="n">BT_DISABLE_REDUCED_TXPOWER_THRESHOLD</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BT_UART_MSG_FRAME3SCOESCO_MSK</span> <span class="o">|</span>
		   <span class="n">BT_UART_MSG_FRAME3SNIFF_MSK</span> <span class="o">|</span> <span class="n">BT_UART_MSG_FRAME3A2DP_MSK</span><span class="p">))</span> <span class="o">||</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">uart_msg</span><span class="o">-&gt;</span><span class="n">frame3</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BT_UART_MSG_FRAME3ACL_MSK</span> <span class="o">|</span>
		   <span class="n">BT_UART_MSG_FRAME3OBEX_MSK</span><span class="p">))))</span> <span class="p">{</span>
		<span class="cm">/* disable reduced tx power */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reduced_txpower</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_valid</span> <span class="o">|=</span> <span class="n">IWLAGN_BT_VALID_REDUCED_TX_PWR</span><span class="p">;</span>
		<span class="n">need_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">need_update</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_bt_coex_profile_notif</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iwl_rx_cmd_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iwl_device_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rx_packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwl_bt_coex_profile_notif</span> <span class="o">*</span><span class="n">coex</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_bt_uart_msg</span> <span class="o">*</span><span class="n">uart_msg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">coex</span><span class="o">-&gt;</span><span class="n">last_bt_uart_msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_enable_flag</span> <span class="o">==</span> <span class="n">IWLAGN_BT_FLAG_COEX_MODE_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* bt coex disabled */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;BT Coex notification:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;    status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">coex</span><span class="o">-&gt;</span><span class="n">bt_status</span><span class="p">);</span>
	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;    traffic load: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">coex</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span><span class="p">);</span>
	<span class="n">IWL_DEBUG_COEX</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;    CI compliance: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">coex</span><span class="o">-&gt;</span><span class="n">bt_ci_compliance</span><span class="p">);</span>
	<span class="n">iwlagn_print_uartmsg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">uart_msg</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_bt_traffic_load</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_is_sco</span> <span class="o">=</span> <span class="n">iwlagn_bt_traffic_is_sco</span><span class="p">(</span><span class="n">uart_msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_status</span> <span class="o">!=</span> <span class="n">coex</span><span class="o">-&gt;</span><span class="n">bt_status</span> <span class="o">||</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_bt_traffic_load</span> <span class="o">!=</span> <span class="n">coex</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">coex</span><span class="o">-&gt;</span><span class="n">bt_status</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* BT on */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_ch_announce</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span> <span class="o">=</span>
						<span class="n">IWL_BT_COEX_TRAFFIC_LOAD_HIGH</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span> <span class="o">=</span>
						<span class="n">coex</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* BT off */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span> <span class="o">=</span>
					<span class="n">IWL_BT_COEX_TRAFFIC_LOAD_NONE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_status</span> <span class="o">=</span> <span class="n">coex</span><span class="o">-&gt;</span><span class="n">bt_status</span><span class="p">;</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_change_work</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* schedule to send runtime bt_config */</span>
	<span class="cm">/* check reduce power before change ack/cts kill mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iwlagn_fill_txpower_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">uart_msg</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">iwlagn_set_kill_msk</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">uart_msg</span><span class="p">))</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_runtime_config</span><span class="p">);</span>


	<span class="cm">/* FIXME: based on notification, adjust the prio_boost */</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_ci_compliance</span> <span class="o">=</span> <span class="n">coex</span><span class="o">-&gt;</span><span class="n">bt_ci_compliance</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_bt_rx_handler_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_handlers</span><span class="p">[</span><span class="n">REPLY_BT_COEX_PROFILE_NOTIF</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">iwlagn_bt_coex_profile_notif</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_bt_setup_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_change_work</span><span class="p">,</span>
		  <span class="n">iwlagn_bt_traffic_change_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwlagn_bt_cancel_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_change_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_single_rx_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">smps</span> <span class="o">==</span> <span class="n">IEEE80211_SMPS_STATIC</span> <span class="o">||</span>
	       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">single_chain_sufficient</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IWL_NUM_RX_CHAINS_MULTIPLE	3</span>
<span class="cp">#define IWL_NUM_RX_CHAINS_SINGLE	2</span>
<span class="cp">#define IWL_NUM_IDLE_CHAINS_DUAL	2</span>
<span class="cp">#define IWL_NUM_IDLE_CHAINS_SINGLE	1</span>

<span class="cm">/*</span>
<span class="cm"> * Determine how many receiver/antenna chains to use.</span>
<span class="cm"> *</span>
<span class="cm"> * More provides better reception via diversity.  Fewer saves power</span>
<span class="cm"> * at the expense of throughput, but only when not in powersave to</span>
<span class="cm"> * start with.</span>
<span class="cm"> *</span>
<span class="cm"> * MIMO (dual stream) requires at least 2, but works better with 3.</span>
<span class="cm"> * This does not determine *which* chains to use, just how many.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_get_active_rx_chain_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">advanced_bt_coexist</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_full_concurrent</span> <span class="o">||</span>
	     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span> <span class="o">&gt;=</span> <span class="n">IWL_BT_COEX_TRAFFIC_LOAD_HIGH</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * only use chain &#39;A&#39; in bt high traffic load or</span>
<span class="cm">		 * full concurrency mode</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">IWL_NUM_RX_CHAINS_SINGLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* # of Rx chains to use when expecting MIMO. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_single_rx_stream</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IWL_NUM_RX_CHAINS_SINGLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">IWL_NUM_RX_CHAINS_MULTIPLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When we are in power saving mode, unless device support spatial</span>
<span class="cm"> * multiplexing power save, use the active count for rx chain count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_get_idle_rx_chain_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">active_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* # Rx chains when idling, depending on SMPS mode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">smps</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_STATIC</span>:
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_DYNAMIC</span>:
		<span class="k">return</span> <span class="n">IWL_NUM_IDLE_CHAINS_SINGLE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_AUTOMATIC</span>:
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_OFF</span>:
		<span class="k">return</span> <span class="n">active_cnt</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;invalid SMPS mode %d&quot;</span><span class="p">,</span>
		     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">smps</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">active_cnt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* up to 4 chains */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">iwl_count_chain_bitmap</span><span class="p">(</span><span class="n">u32</span> <span class="n">chain_bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">chain_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">chain_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">chain_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iwlagn_set_rxon_chain - Set up Rx chain usage in &quot;staging&quot; RXON image</span>
<span class="cm"> *</span>
<span class="cm"> * Selects how many and which Rx receivers/antennas/chains to use.</span>
<span class="cm"> * This should not be used for scan command ... it puts data in wrong place.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iwlagn_set_rxon_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_single</span> <span class="o">=</span> <span class="n">is_single_rx_stream</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">is_cam</span> <span class="o">=</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_POWER_PMI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">idle_rx_cnt</span><span class="p">,</span> <span class="n">active_rx_cnt</span><span class="p">,</span> <span class="n">valid_rx_cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">active_chains</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_chain</span><span class="p">;</span>

	<span class="cm">/* Tell uCode which antennas are actually connected.</span>
<span class="cm">	 * Before first association, we assume all antennas are connected.</span>
<span class="cm">	 * Just after first association, iwl_chain_noise_calibration()</span>
<span class="cm">	 *    checks which antennas actually *are* connected. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chain_noise_data</span><span class="p">.</span><span class="n">active_chains</span><span class="p">)</span>
		<span class="n">active_chains</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">chain_noise_data</span><span class="p">.</span><span class="n">active_chains</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">active_chains</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_rx_ant</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">advanced_bt_coexist</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_full_concurrent</span> <span class="o">||</span>
	     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span> <span class="o">&gt;=</span> <span class="n">IWL_BT_COEX_TRAFFIC_LOAD_HIGH</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * only use chain &#39;A&#39; in bt high traffic load or</span>
<span class="cm">		 * full concurrency mode</span>
<span class="cm">		 */</span>
		<span class="n">active_chains</span> <span class="o">=</span> <span class="n">first_antenna</span><span class="p">(</span><span class="n">active_chains</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rx_chain</span> <span class="o">=</span> <span class="n">active_chains</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_VALID_POS</span><span class="p">;</span>

	<span class="cm">/* How many receivers should we use? */</span>
	<span class="n">active_rx_cnt</span> <span class="o">=</span> <span class="n">iwl_get_active_rx_chain_count</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">idle_rx_cnt</span> <span class="o">=</span> <span class="n">iwl_get_idle_rx_chain_count</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">active_rx_cnt</span><span class="p">);</span>


	<span class="cm">/* correct rx chain count according hw settings</span>
<span class="cm">	 * and chain noise calibration</span>
<span class="cm">	 */</span>
	<span class="n">valid_rx_cnt</span> <span class="o">=</span> <span class="n">iwl_count_chain_bitmap</span><span class="p">(</span><span class="n">active_chains</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">valid_rx_cnt</span> <span class="o">&lt;</span> <span class="n">active_rx_cnt</span><span class="p">)</span>
		<span class="n">active_rx_cnt</span> <span class="o">=</span> <span class="n">valid_rx_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">valid_rx_cnt</span> <span class="o">&lt;</span> <span class="n">idle_rx_cnt</span><span class="p">)</span>
		<span class="n">idle_rx_cnt</span> <span class="o">=</span> <span class="n">valid_rx_cnt</span><span class="p">;</span>

	<span class="n">rx_chain</span> <span class="o">|=</span> <span class="n">active_rx_cnt</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_MIMO_CNT_POS</span><span class="p">;</span>
	<span class="n">rx_chain</span> <span class="o">|=</span> <span class="n">idle_rx_cnt</span>  <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_CNT_POS</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">rx_chain</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rx_chain</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_single</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">active_rx_cnt</span> <span class="o">&gt;=</span> <span class="n">IWL_NUM_RX_CHAINS_SINGLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">is_cam</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">rx_chain</span> <span class="o">|=</span> <span class="n">RXON_RX_CHAIN_MIMO_FORCE_MSK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">rx_chain</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_RX_CHAIN_MIMO_FORCE_MSK</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_ASSOC</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;rx_chain=0x%X active=%d idle=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">rx_chain</span><span class="p">,</span>
			<span class="n">active_rx_cnt</span><span class="p">,</span> <span class="n">idle_rx_cnt</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">active_rx_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idle_rx_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">active_rx_cnt</span> <span class="o">&lt;</span> <span class="n">idle_rx_cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">iwl_toggle_tx_ant</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ant</span><span class="p">,</span> <span class="n">u8</span> <span class="n">valid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ind</span> <span class="o">=</span> <span class="n">ant</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span> <span class="o">&gt;=</span> <span class="n">IWL_BT_COEX_TRAFFIC_LOAD_HIGH</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_ANT_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RATE_ANT_NUM</span> <span class="o">?</span>  <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ind</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ant</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM_SLEEP</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_convert_p1k</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">p1k</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IWLAGN_P1K_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">p1k</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">wowlan_key_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwlagn_wowlan_rsc_tsc_params_cmd</span> <span class="o">*</span><span class="n">rsc_tsc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwlagn_wowlan_tkip_params_cmd</span> <span class="o">*</span><span class="n">tkip</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">error</span><span class="p">,</span> <span class="n">use_rsc_tsc</span><span class="p">,</span> <span class="n">use_tkip</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwlagn_wowlan_program_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">IWL_MAC80211_GET_DVM</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wowlan_key_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">aes_sc</span> <span class="o">*</span><span class="n">aes_sc</span><span class="p">,</span> <span class="o">*</span><span class="n">aes_tx_sc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tkip_sc</span> <span class="o">*</span><span class="n">tkip_sc</span><span class="p">,</span> <span class="o">*</span><span class="n">tkip_tx_sc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwlagn_p1k_cache</span> <span class="o">*</span><span class="n">rx_p1ks</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rx_mic_key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_key_seq</span> <span class="n">seq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_rx_iv32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">p1k</span><span class="p">[</span><span class="n">IWLAGN_P1K_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span> <span class="o">||</span>
	     <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key_mapping_keys</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_set_default_wep_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_set_dynamic_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Error setting key during suspend!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tkip_sc</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rsc_tsc</span><span class="o">-&gt;</span><span class="n">all_tsc_rsc</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">unicast_rsc</span><span class="p">;</span>
			<span class="n">tkip_tx_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rsc_tsc</span><span class="o">-&gt;</span><span class="n">all_tsc_rsc</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">tsc</span><span class="p">;</span>

			<span class="n">rx_p1ks</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">rx_uni</span><span class="p">;</span>

			<span class="n">ieee80211_get_key_tx_seq</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">);</span>
			<span class="n">tkip_tx_sc</span><span class="o">-&gt;</span><span class="n">iv16</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">seq</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">iv16</span><span class="p">);</span>
			<span class="n">tkip_tx_sc</span><span class="o">-&gt;</span><span class="n">iv32</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">seq</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">iv32</span><span class="p">);</span>

			<span class="n">ieee80211_get_tkip_p1k_iv</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">seq</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">iv32</span><span class="p">,</span> <span class="n">p1k</span><span class="p">);</span>
			<span class="n">iwlagn_convert_p1k</span><span class="p">(</span><span class="n">p1k</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">p1k</span><span class="p">);</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">mic_keys</span><span class="p">.</span><span class="n">tx</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">NL80211_TKIP_DATA_OFFSET_TX_MIC_KEY</span><span class="p">],</span>
			       <span class="n">IWLAGN_MIC_KEY_SIZE</span><span class="p">);</span>

			<span class="n">rx_mic_key</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">mic_keys</span><span class="p">.</span><span class="n">rx_unicast</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tkip_sc</span> <span class="o">=</span>
				<span class="n">data</span><span class="o">-&gt;</span><span class="n">rsc_tsc</span><span class="o">-&gt;</span><span class="n">all_tsc_rsc</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">multicast_rsc</span><span class="p">;</span>
			<span class="n">rx_p1ks</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">rx_multi</span><span class="p">;</span>
			<span class="n">rx_mic_key</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">tkip</span><span class="o">-&gt;</span><span class="n">mic_keys</span><span class="p">.</span><span class="n">rx_mcast</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * For non-QoS this relies on the fact that both the uCode and</span>
<span class="cm">		 * mac80211 use TID 0 (as they need to to avoid replay attacks)</span>
<span class="cm">		 * for checking the IV in the frames.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IWLAGN_NUM_RSC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee80211_get_key_rx_seq</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">);</span>
			<span class="n">tkip_sc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iv16</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">seq</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">iv16</span><span class="p">);</span>
			<span class="n">tkip_sc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iv32</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">seq</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">iv32</span><span class="p">);</span>
			<span class="cm">/* wrapping isn&#39;t allowed, AP must rekey */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">seq</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">iv32</span> <span class="o">&gt;</span> <span class="n">cur_rx_iv32</span><span class="p">)</span>
				<span class="n">cur_rx_iv32</span> <span class="o">=</span> <span class="n">seq</span><span class="p">.</span><span class="n">tkip</span><span class="p">.</span><span class="n">iv32</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ieee80211_get_tkip_rx_p1k</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">cur_rx_iv32</span><span class="p">,</span> <span class="n">p1k</span><span class="p">);</span>
		<span class="n">iwlagn_convert_p1k</span><span class="p">(</span><span class="n">p1k</span><span class="p">,</span> <span class="n">rx_p1ks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">p1k</span><span class="p">);</span>
		<span class="n">ieee80211_get_tkip_rx_p1k</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
					  <span class="n">cur_rx_iv32</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">p1k</span><span class="p">);</span>
		<span class="n">iwlagn_convert_p1k</span><span class="p">(</span><span class="n">p1k</span><span class="p">,</span> <span class="n">rx_p1ks</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">p1k</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">rx_mic_key</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY</span><span class="p">],</span>
		       <span class="n">IWLAGN_MIC_KEY_SIZE</span><span class="p">);</span>

		<span class="n">data</span><span class="o">-&gt;</span><span class="n">use_tkip</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">use_rsc_tsc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">pn</span> <span class="o">=</span> <span class="n">seq</span><span class="p">.</span><span class="n">ccmp</span><span class="p">.</span><span class="n">pn</span><span class="p">;</span>

			<span class="n">aes_sc</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rsc_tsc</span><span class="o">-&gt;</span><span class="n">all_tsc_rsc</span><span class="p">.</span><span class="n">aes</span><span class="p">.</span><span class="n">unicast_rsc</span><span class="p">;</span>
			<span class="n">aes_tx_sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rsc_tsc</span><span class="o">-&gt;</span><span class="n">all_tsc_rsc</span><span class="p">.</span><span class="n">aes</span><span class="p">.</span><span class="n">tsc</span><span class="p">;</span>

			<span class="n">ieee80211_get_key_tx_seq</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">);</span>
			<span class="n">aes_tx_sc</span><span class="o">-&gt;</span><span class="n">pn</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span>
					<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">aes_sc</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rsc_tsc</span><span class="o">-&gt;</span><span class="n">all_tsc_rsc</span><span class="p">.</span><span class="n">aes</span><span class="p">.</span><span class="n">multicast_rsc</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * For non-QoS this relies on the fact that both the uCode and</span>
<span class="cm">		 * mac80211 use TID 0 for checking the IV in the frames.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IWLAGN_NUM_RSC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">pn</span> <span class="o">=</span> <span class="n">seq</span><span class="p">.</span><span class="n">ccmp</span><span class="p">.</span><span class="n">pn</span><span class="p">;</span>

			<span class="n">ieee80211_get_key_rx_seq</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seq</span><span class="p">);</span>
			<span class="n">aes_sc</span><span class="o">-&gt;</span><span class="n">pn</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span>
					<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">pn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">40</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">use_rsc_tsc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_send_patterns</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wowlan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwlagn_wowlan_patterns_cmd</span> <span class="o">*</span><span class="n">pattern_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_host_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">REPLY_WOWLAN_PATTERNS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dataflags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IWL_HCMD_DFL_NOCOPY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CMD_SYNC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">n_patterns</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pattern_cmd</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">n_patterns</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwlagn_wowlan_pattern</span><span class="p">);</span>

	<span class="n">pattern_cmd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">len</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pattern_cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pattern_cmd</span><span class="o">-&gt;</span><span class="n">n_patterns</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">n_patterns</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">n_patterns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mask_len</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern_len</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pattern_cmd</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">,</span>
			<span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pattern_cmd</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern</span><span class="p">,</span>
			<span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern</span><span class="p">,</span>
			<span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern_len</span><span class="p">);</span>
		<span class="n">pattern_cmd</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask_size</span> <span class="o">=</span> <span class="n">mask_len</span><span class="p">;</span>
		<span class="n">pattern_cmd</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern_size</span> <span class="o">=</span>
			<span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">patterns</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pattern_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pattern_cmd</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pattern_cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwlagn_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfg80211_wowlan</span> <span class="o">*</span><span class="n">wowlan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwlagn_wowlan_wakeup_filter_cmd</span> <span class="n">wakeup_filter_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_cmd</span> <span class="n">rxon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">iwlagn_wowlan_kek_kck_material_cmd</span> <span class="n">kek_kck_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwlagn_wowlan_tkip_params_cmd</span> <span class="n">tkip_cmd</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">iwlagn_d3_config_cmd</span> <span class="n">d3_cfg_cmd</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">wowlan_key_data</span> <span class="n">key_data</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bssid</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">bssid_addr</span><span class="p">,</span>
		<span class="p">.</span><span class="n">use_rsc_tsc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tkip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tkip_cmd</span><span class="p">,</span>
		<span class="p">.</span><span class="n">use_tkip</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq</span><span class="p">;</span>

	<span class="n">key_data</span><span class="p">.</span><span class="n">rsc_tsc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">key_data</span><span class="p">.</span><span class="n">rsc_tsc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key_data</span><span class="p">.</span><span class="n">rsc_tsc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wakeup_filter_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wakeup_filter_cmd</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * We know the last used seqno, and the uCode expects to know that</span>
<span class="cm">	 * one, it will increment before TX.</span>
<span class="cm">	 */</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_seq_ctl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">;</span>
	<span class="n">wakeup_filter_cmd</span><span class="p">.</span><span class="n">non_qos_seq</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For QoS counters, we store the one to use next, so subtract 0x10</span>
<span class="cm">	 * since the uCode will add 0x10 before using the value.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IWL_MAX_TID_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tid_data</span><span class="p">[</span><span class="n">IWL_AP_ID</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">seq_number</span><span class="p">;</span>
		<span class="n">seq</span> <span class="o">-=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">wakeup_filter_cmd</span><span class="p">.</span><span class="n">qos_seq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">disconnect</span><span class="p">)</span>
		<span class="n">wakeup_filter_cmd</span><span class="p">.</span><span class="n">enabled</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IWLAGN_WOWLAN_WAKEUP_BEACON_MISS</span> <span class="o">|</span>
				    <span class="n">IWLAGN_WOWLAN_WAKEUP_LINK_CHANGE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">magic_pkt</span><span class="p">)</span>
		<span class="n">wakeup_filter_cmd</span><span class="p">.</span><span class="n">enabled</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IWLAGN_WOWLAN_WAKEUP_MAGIC_PACKET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">gtk_rekey_failure</span><span class="p">)</span>
		<span class="n">wakeup_filter_cmd</span><span class="p">.</span><span class="n">enabled</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IWLAGN_WOWLAN_WAKEUP_GTK_REKEY_FAIL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">eap_identity_req</span><span class="p">)</span>
		<span class="n">wakeup_filter_cmd</span><span class="p">.</span><span class="n">enabled</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IWLAGN_WOWLAN_WAKEUP_EAP_IDENT_REQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">four_way_handshake</span><span class="p">)</span>
		<span class="n">wakeup_filter_cmd</span><span class="p">.</span><span class="n">enabled</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IWLAGN_WOWLAN_WAKEUP_4WAY_HANDSHAKE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">n_patterns</span><span class="p">)</span>
		<span class="n">wakeup_filter_cmd</span><span class="p">.</span><span class="n">enabled</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IWLAGN_WOWLAN_WAKEUP_PATTERN_MATCH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wowlan</span><span class="o">-&gt;</span><span class="n">rfkill_release</span><span class="p">)</span>
		<span class="n">d3_cfg_cmd</span><span class="p">.</span><span class="n">wakeup_flags</span> <span class="o">|=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">IWLAGN_D3_WAKEUP_RFKILL</span><span class="p">);</span>

	<span class="n">iwl_scan_cancel_timeout</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxon</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxon</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ucode_loaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">iwl_trans_stop_device</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wowlan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_load_ucode_wait_alive</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IWL_UCODE_WOWLAN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* now configure WoWLAN ucode */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_alive_start</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxon</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxon</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_commit_rxon</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_power_update_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwlwifi_mod_params</span><span class="p">.</span><span class="n">sw_crypto</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mark all keys clear */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ucode_key_table</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">key_mapping_keys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * This needs to be unlocked due to lock ordering</span>
<span class="cm">		 * constraints. Since we&#39;re in the suspend path</span>
<span class="cm">		 * that isn&#39;t really a problem though.</span>
<span class="cm">		 */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">ieee80211_iter_keys</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span>
				    <span class="n">iwlagn_wowlan_program_keys</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">key_data</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key_data</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key_data</span><span class="p">.</span><span class="n">use_rsc_tsc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">iwl_host_cmd</span> <span class="n">rsc_tsc_cmd</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">REPLY_WOWLAN_TSC_RSC_PARAMS</span><span class="p">,</span>
				<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CMD_SYNC</span><span class="p">,</span>
				<span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">key_data</span><span class="p">.</span><span class="n">rsc_tsc</span><span class="p">,</span>
				<span class="p">.</span><span class="n">dataflags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IWL_HCMD_DFL_NOCOPY</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">key_data</span><span class="p">.</span><span class="n">rsc_tsc</span><span class="p">),</span>
			<span class="p">};</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsc_tsc_cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key_data</span><span class="p">.</span><span class="n">use_tkip</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
						 <span class="n">REPLY_WOWLAN_TKIP_PARAMS</span><span class="p">,</span>
						 <span class="n">CMD_SYNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tkip_cmd</span><span class="p">),</span>
						 <span class="o">&amp;</span><span class="n">tkip_cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">have_rekey_data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kek_kck_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kek_kck_cmd</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">kek_kck_cmd</span><span class="p">.</span><span class="n">kck</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">kck</span><span class="p">,</span> <span class="n">NL80211_KCK_LEN</span><span class="p">);</span>
			<span class="n">kek_kck_cmd</span><span class="p">.</span><span class="n">kck_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">NL80211_KCK_LEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">kek_kck_cmd</span><span class="p">.</span><span class="n">kek</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">kek</span><span class="p">,</span> <span class="n">NL80211_KEK_LEN</span><span class="p">);</span>
			<span class="n">kek_kck_cmd</span><span class="p">.</span><span class="n">kek_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">NL80211_KEK_LEN</span><span class="p">);</span>
			<span class="n">kek_kck_cmd</span><span class="p">.</span><span class="n">replay_ctr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">replay_ctr</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
						 <span class="n">REPLY_WOWLAN_KEK_KCK_MATERIAL</span><span class="p">,</span>
						 <span class="n">CMD_SYNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kek_kck_cmd</span><span class="p">),</span>
						 <span class="o">&amp;</span><span class="n">kek_kck_cmd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">REPLY_D3_CONFIG</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">d3_cfg_cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">d3_cfg_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">REPLY_WOWLAN_WAKEUP_FILTER</span><span class="p">,</span>
				 <span class="n">CMD_SYNC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wakeup_filter_cmd</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">wakeup_filter_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_send_patterns</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">wowlan</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key_data</span><span class="p">.</span><span class="n">rsc_tsc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">iwl_dvm_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwl_host_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iwl_is_rfkill</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">||</span> <span class="n">iwl_is_ctkill</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Not sending command - %s KILL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">iwl_is_rfkill</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RF&quot;</span> <span class="o">:</span> <span class="s">&quot;CT&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_FW_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Command %s failed: FW Error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">iwl_dvm_get_cmd_string</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Synchronous commands from this op-mode must hold</span>
<span class="cm">	 * the mutex, this ensures we don&#39;t try to send two</span>
<span class="cm">	 * (or more) synchronous commands at a time.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_SYNC</span><span class="p">)</span>
		<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ucode_owner</span> <span class="o">==</span> <span class="n">IWL_OWNERSHIP_TM</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_ON_DEMAND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_HC</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;tm own the uCode, no regular hcmd send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">iwl_trans_send_cmd</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">trans</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwl_dvm_send_cmd_pdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_host_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="p">{</span> <span class="n">len</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span> <span class="n">data</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">iwl_dvm_send_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
