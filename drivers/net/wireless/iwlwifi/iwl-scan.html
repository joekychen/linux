<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › iwlwifi › iwl-scan.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>iwl-scan.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * GPL LICENSE SUMMARY</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2008 - 2012 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110,</span>
<span class="cm"> * USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution</span>
<span class="cm"> * in the file called LICENSE.GPL.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> *  Intel Linux Wireless &lt;ilw@linux.intel.com&gt;</span>
<span class="cm"> * Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>
<span class="cm"> *****************************************************************************/</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>

<span class="cp">#include &quot;iwl-eeprom.h&quot;</span>
<span class="cp">#include &quot;iwl-dev.h&quot;</span>
<span class="cp">#include &quot;iwl-io.h&quot;</span>
<span class="cp">#include &quot;iwl-agn.h&quot;</span>
<span class="cp">#include &quot;iwl-trans.h&quot;</span>

<span class="cm">/* For active scan, listen ACTIVE_DWELL_TIME (msec) on each channel after</span>
<span class="cm"> * sending probe req.  This should be set long enough to hear probe responses</span>
<span class="cm"> * from more than one AP.  */</span>
<span class="cp">#define IWL_ACTIVE_DWELL_TIME_24    (30)       </span><span class="cm">/* all times in msec */</span><span class="cp"></span>
<span class="cp">#define IWL_ACTIVE_DWELL_TIME_52    (20)</span>

<span class="cp">#define IWL_ACTIVE_DWELL_FACTOR_24GHZ (3)</span>
<span class="cp">#define IWL_ACTIVE_DWELL_FACTOR_52GHZ (2)</span>

<span class="cm">/* For passive scan, listen PASSIVE_DWELL_TIME (msec) on each channel.</span>
<span class="cm"> * Must be set longer than active dwell time.</span>
<span class="cm"> * For the most reliable scan, set &gt; AP beacon interval (typically 100msec). */</span>
<span class="cp">#define IWL_PASSIVE_DWELL_TIME_24   (20)       </span><span class="cm">/* all times in msec */</span><span class="cp"></span>
<span class="cp">#define IWL_PASSIVE_DWELL_TIME_52   (10)</span>
<span class="cp">#define IWL_PASSIVE_DWELL_BASE      (100)</span>
<span class="cp">#define IWL_CHANNEL_TUNE_TIME       5</span>
<span class="cp">#define MAX_SCAN_CHANNEL	    50</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_send_scan_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_host_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">REPLY_SCAN_ABORT_CMD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CMD_SYNC</span> <span class="o">|</span> <span class="n">CMD_WANT_SKB</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Exit instantly with error when device is not ready</span>
<span class="cm">	 * to receive scan abort command or it does not perform</span>
<span class="cm">	 * hardware scan currently */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_GEO_CONFIGURED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_FW_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">.</span><span class="n">resp_pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CAN_ABORT_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The scan abort will return 1 for success or</span>
<span class="cm">		 * 2 for &quot;failure&quot;.  A failure condition can be</span>
<span class="cm">		 * due to simply not being in an active scan which</span>
<span class="cm">		 * can occur if we send the scan abort before we</span>
<span class="cm">		 * the microcode has notified us that a scan is</span>
<span class="cm">		 * completed. */</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;SCAN_ABORT ret %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">status</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iwl_free_resp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwl_complete_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">aborted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check if scan was requested from mac80211 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Complete scan in mac80211</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ieee80211_scan_completed</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">aborted</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">==</span> <span class="n">IWL_SCAN_ROC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_remain_on_channel_expired</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_channel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_disable_work</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">=</span> <span class="n">IWL_SCAN_NORMAL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwl_process_scan_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">aborted</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_COMPLETE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Completed scan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_check</span><span class="p">);</span>

	<span class="n">aborted</span> <span class="o">=</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aborted</span><span class="p">)</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Aborted scan completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scan already completed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_settings</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">==</span> <span class="n">IWL_SCAN_ROC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_remain_on_channel_expired</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_channel</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_disable_work</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">!=</span> <span class="n">IWL_SCAN_NORMAL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">aborted</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="cm">/* Check if mac80211 requested scan during our internal scan */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_complete</span><span class="p">;</span>

		<span class="cm">/* If so request a new scan */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">iwl_scan_initiate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_vif</span><span class="p">,</span> <span class="n">IWL_SCAN_NORMAL</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				<span class="s">&quot;failed to initiate pending scan: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
			<span class="n">aborted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_complete</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_complete:</span>
	<span class="n">iwl_complete_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">aborted</span><span class="p">);</span>

<span class="nl">out_settings:</span>
	<span class="cm">/* Can we still talk to firmware ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwl_is_ready_rf</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">iwlagn_post_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwl_force_scan_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Forcing scan end while not scanning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Forcing scan end</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_COMPLETE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">iwl_complete_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwl_do_scan_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Not performing scan to abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scan abort in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_send_scan_abort</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Send scan abort failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">iwl_force_scan_end</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Successfully send scan abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iwl_scan_cancel - Cancel any currently executing HW scan</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">iwl_scan_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Queuing abort scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">abort_scan</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iwl_scan_cancel_timeout - Cancel any currently executing HW scan</span>
<span class="cm"> * @ms: amount of time to wait (in milliseconds) for scan to abort</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iwl_scan_cancel_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scan cancel timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">iwl_do_scan_abort</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">time_before_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">finished</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

 <span class="nl">finished:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now STATUS_SCAN_HW is clear. This means that the</span>
<span class="cm">	 * device finished, but the background work is going</span>
<span class="cm">	 * to execute at best as soon as we release the mutex.</span>
<span class="cm">	 * Since we need to be able to issue a new scan right</span>
<span class="cm">	 * after this function returns, run the complete here.</span>
<span class="cm">	 * The STATUS_SCAN_COMPLETE bit will then be cleared</span>
<span class="cm">	 * and prevent the background work from &quot;completing&quot;</span>
<span class="cm">	 * a possible new scan.</span>
<span class="cm">	 */</span>
	<span class="n">iwl_process_scan_complete</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Service response to REPLY_SCAN_CMD (0x80) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_rx_reply_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iwl_rx_cmd_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iwl_device_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IWLWIFI_DEBUG</span>
	<span class="k">struct</span> <span class="n">iwl_rx_packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwl_scanreq_notification</span> <span class="o">*</span><span class="n">notif</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scan request status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">notif</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Service SCAN_START_NOTIFICATION (0x82) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_rx_scan_start_notif</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iwl_rx_cmd_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iwl_device_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rx_packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwl_scanstart_notification</span> <span class="o">*</span><span class="n">notif</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_start_tsf</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">tsf_low</span><span class="p">);</span>
	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scan start: &quot;</span>
		       <span class="s">&quot;%d [802.11%s] &quot;</span>
		       <span class="s">&quot;(TSF: 0x%08X:%08X) - %d (beacon timer %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">notif</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
		       <span class="n">notif</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">?</span> <span class="s">&quot;bg&quot;</span> <span class="o">:</span> <span class="s">&quot;a&quot;</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">tsf_high</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">tsf_low</span><span class="p">),</span>
		       <span class="n">notif</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">notif</span><span class="o">-&gt;</span><span class="n">beacon_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">==</span> <span class="n">IWL_SCAN_ROC</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_start_notified</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_ready_on_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_start_notified</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Service SCAN_RESULTS_NOTIFICATION (0x83) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_rx_scan_results_notif</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">iwl_rx_cmd_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">iwl_device_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IWLWIFI_DEBUG</span>
	<span class="k">struct</span> <span class="n">iwl_rx_packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwl_scanresults_notification</span> <span class="o">*</span><span class="n">notif</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scan ch.res: &quot;</span>
		       <span class="s">&quot;%d [802.11%s] &quot;</span>
		       <span class="s">&quot;probe status: %u:%u &quot;</span>
		       <span class="s">&quot;(TSF: 0x%08X:%08X) - %d &quot;</span>
		       <span class="s">&quot;elapsed=%lu usec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">notif</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
		       <span class="n">notif</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">?</span> <span class="s">&quot;bg&quot;</span> <span class="o">:</span> <span class="s">&quot;a&quot;</span><span class="p">,</span>
		       <span class="n">notif</span><span class="o">-&gt;</span><span class="n">probe_status</span><span class="p">,</span> <span class="n">notif</span><span class="o">-&gt;</span><span class="n">num_probe_not_sent</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">tsf_high</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">tsf_low</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">statistics</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">notif</span><span class="o">-&gt;</span><span class="n">tsf_low</span><span class="p">)</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_start_tsf</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Service SCAN_COMPLETE_NOTIFICATION (0x84) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_rx_scan_complete_notif</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">iwl_rx_cmd_buffer</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">iwl_device_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rx_packet</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iwl_scancomplete_notification</span> <span class="o">*</span><span class="n">scan_notif</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scan complete: %d channels (TSF 0x%08X:%08X) - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">scan_notif</span><span class="o">-&gt;</span><span class="n">scanned_channels</span><span class="p">,</span>
		       <span class="n">scan_notif</span><span class="o">-&gt;</span><span class="n">tsf_low</span><span class="p">,</span>
		       <span class="n">scan_notif</span><span class="o">-&gt;</span><span class="n">tsf_high</span><span class="p">,</span> <span class="n">scan_notif</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scan on %sGHz took %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;2.4&quot;</span> <span class="o">:</span> <span class="s">&quot;5.2&quot;</span><span class="p">,</span>
		       <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_start</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * When aborting, we run the scan completed background work inline</span>
<span class="cm">	 * and the background work must then do nothing. The SCAN_COMPLETE</span>
<span class="cm">	 * bit helps implement that logic and thus needs to be set before</span>
<span class="cm">	 * queueing the work. Also, since the scan abort waits for SCAN_HW</span>
<span class="cm">	 * to clear, we need to set SCAN_COMPLETE before clearing SCAN_HW</span>
<span class="cm">	 * to avoid a race there.</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_COMPLETE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_completed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">iwl_advanced_bt_coexist</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_status</span> <span class="o">!=</span> <span class="n">scan_notif</span><span class="o">-&gt;</span><span class="n">bt_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scan_notif</span><span class="o">-&gt;</span><span class="n">bt_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* BT on */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_ch_announce</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span> <span class="o">=</span>
					<span class="n">IWL_BT_COEX_TRAFFIC_LOAD_HIGH</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * otherwise, no traffic load information provided</span>
<span class="cm">			 * no changes made</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* BT off */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_load</span> <span class="o">=</span>
				<span class="n">IWL_BT_COEX_TRAFFIC_LOAD_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_status</span> <span class="o">=</span> <span class="n">scan_notif</span><span class="o">-&gt;</span><span class="n">bt_status</span><span class="p">;</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_traffic_change_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwl_setup_rx_scan_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* scan handlers */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_handlers</span><span class="p">[</span><span class="n">REPLY_SCAN_CMD</span><span class="p">]</span> <span class="o">=</span> <span class="n">iwl_rx_reply_scan</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_handlers</span><span class="p">[</span><span class="n">SCAN_START_NOTIFICATION</span><span class="p">]</span> <span class="o">=</span> <span class="n">iwl_rx_scan_start_notif</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_handlers</span><span class="p">[</span><span class="n">SCAN_RESULTS_NOTIFICATION</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">iwl_rx_scan_results_notif</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_handlers</span><span class="p">[</span><span class="n">SCAN_COMPLETE_NOTIFICATION</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">iwl_rx_scan_complete_notif</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">iwl_get_active_dwell_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span> <span class="n">u8</span> <span class="n">n_probes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IWL_ACTIVE_DWELL_TIME_52</span> <span class="o">+</span>
			<span class="n">IWL_ACTIVE_DWELL_FACTOR_52GHZ</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_probes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">IWL_ACTIVE_DWELL_TIME_24</span> <span class="o">+</span>
			<span class="n">IWL_ACTIVE_DWELL_FACTOR_24GHZ</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_probes</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">iwl_limit_dwell</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dwell_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re associated, we clamp the dwell time 98%</span>
<span class="cm">	 * of the smallest beacon interval (minus 2 * channel</span>
<span class="cm">	 * tune time)</span>
<span class="cm">	 */</span>
	<span class="n">for_each_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">dev_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">RXON_DEV_TYPE_P2P</span>:
			<span class="cm">/* no timing constraints */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RXON_DEV_TYPE_ESS</span>:
		<span class="nl">default:</span>
			<span class="cm">/* timing constraints if associated */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwl_is_associated_ctx</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">RXON_DEV_TYPE_CP</span>:
		<span class="k">case</span> <span class="n">RXON_DEV_TYPE_2STA</span>:
			<span class="cm">/*</span>
<span class="cm">			 * These seem to always have timers for TBTT</span>
<span class="cm">			 * active in uCode even when not associated yet.</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">IWL_PASSIVE_DWELL_BASE</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">98</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">IWL_CHANNEL_TUNE_TIME</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">dwell_time</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dwell_time</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dwell_time</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">iwl_get_passive_dwell_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">passive</span> <span class="o">=</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">IWL_PASSIVE_DWELL_BASE</span> <span class="o">+</span> <span class="n">IWL_PASSIVE_DWELL_TIME_24</span> <span class="o">:</span>
	    <span class="n">IWL_PASSIVE_DWELL_BASE</span> <span class="o">+</span> <span class="n">IWL_PASSIVE_DWELL_TIME_52</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">iwl_limit_dwell</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">passive</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return valid, unused, channel for a passive scan to reset the RF */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">iwl_get_single_channel_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iwl_channel_info</span> <span class="o">*</span><span class="n">ch_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">min</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_count</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">max</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">for_each_context</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">busy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">==</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">busy</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">busy</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">ch_info</span> <span class="o">=</span> <span class="n">iwl_get_channel_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_channel_valid</span><span class="p">(</span><span class="n">ch_info</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">channel</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_get_single_channel_for_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
					   <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">iwl_scan_channel</span> <span class="o">*</span><span class="n">scan_ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">passive_dwell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">active_dwell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">added</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">iwl_get_hw_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;invalid band</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">added</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">active_dwell</span> <span class="o">=</span> <span class="n">iwl_get_active_dwell_time</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">iwl_get_passive_dwell_time</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">passive_dwell</span> <span class="o">&lt;=</span> <span class="n">active_dwell</span><span class="p">)</span>
		<span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">active_dwell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">iwl_get_single_channel_number</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SCAN_CHANNEL_TYPE_PASSIVE</span><span class="p">;</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">active_dwell</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">active_dwell</span><span class="p">);</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">passive_dwell</span><span class="p">);</span>
		<span class="cm">/* Set txpower levels to defaults */</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">dsp_atten</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">tx_gain</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">tx_gain</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
		<span class="n">added</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">IWL_ERR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;no valid channel found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">added</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwl_get_channels_for_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span>
				     <span class="n">u8</span> <span class="n">is_active</span><span class="p">,</span> <span class="n">u8</span> <span class="n">n_probes</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iwl_scan_channel</span> <span class="o">*</span><span class="n">scan_ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">iwl_channel_info</span> <span class="o">*</span><span class="n">ch_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">passive_dwell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">active_dwell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">added</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">iwl_get_hw_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">active_dwell</span> <span class="o">=</span> <span class="n">iwl_get_active_dwell_time</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">n_probes</span><span class="p">);</span>
	<span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">iwl_get_passive_dwell_time</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">passive_dwell</span> <span class="o">&lt;=</span> <span class="n">active_dwell</span><span class="p">)</span>
		<span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">active_dwell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">added</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">!=</span> <span class="n">band</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">channel</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

		<span class="n">ch_info</span> <span class="o">=</span> <span class="n">iwl_get_channel_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_channel_valid</span><span class="p">(</span><span class="n">ch_info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				       <span class="s">&quot;Channel %d is INVALID for this band.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">channel</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_active</span> <span class="o">||</span> <span class="n">is_channel_passive</span><span class="p">(</span><span class="n">ch_info</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span><span class="p">))</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SCAN_CHANNEL_TYPE_PASSIVE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SCAN_CHANNEL_TYPE_ACTIVE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n_probes</span><span class="p">)</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span> <span class="n">IWL_SCAN_PROBE_MASK</span><span class="p">(</span><span class="n">n_probes</span><span class="p">);</span>

		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">active_dwell</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">active_dwell</span><span class="p">);</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">passive_dwell</span><span class="p">);</span>

		<span class="cm">/* Set txpower levels to defaults */</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">dsp_atten</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>

		<span class="cm">/* NOTE: if we were doing 6Mb OFDM for scans we&#39;d use</span>
<span class="cm">		 * power level:</span>
<span class="cm">		 * scan_ch-&gt;tx_gain = ((1 &lt;&lt; 5) | (2 &lt;&lt; 3)) | 3;</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">tx_gain</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">tx_gain</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>

		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scanning ch=%d prob=0x%X [%s %d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">channel</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">),</span>
			       <span class="p">(</span><span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCAN_CHANNEL_TYPE_ACTIVE</span><span class="p">)</span> <span class="o">?</span>
				<span class="s">&quot;ACTIVE&quot;</span> <span class="o">:</span> <span class="s">&quot;PASSIVE&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCAN_CHANNEL_TYPE_ACTIVE</span><span class="p">)</span> <span class="o">?</span>
			       <span class="n">active_dwell</span> <span class="o">:</span> <span class="n">passive_dwell</span><span class="p">);</span>

		<span class="n">scan_ch</span><span class="o">++</span><span class="p">;</span>
		<span class="n">added</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;total channels to scan %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">added</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">added</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iwl_fill_probe_req - fill in all required fields and IE for probe request</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">iwl_fill_probe_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ta</span><span class="p">,</span>
			      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ies</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ie_len</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">ssid_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">left</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Make sure there is enough space for the probe request,</span>
<span class="cm">	 * two mandatory IEs and the data */</span>
	<span class="n">left</span> <span class="o">-=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_PROBE_REQ</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">iwl_bcast_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">iwl_bcast_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="mi">24</span><span class="p">;</span>

	<span class="cm">/* ...next IE... */</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">probe_req</span><span class="p">.</span><span class="n">variable</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* fill in our SSID IE */</span>
	<span class="n">left</span> <span class="o">-=</span> <span class="n">ssid_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span><span class="o">++</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssid</span> <span class="o">&amp;&amp;</span> <span class="n">ssid_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">ssid_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">ie_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ies</span> <span class="o">&amp;&amp;</span> <span class="n">ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ies</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">ie_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwlagn_request_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_host_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">REPLY_SCAN_CMD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_scan_cmd</span><span class="p">),</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CMD_SYNC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">iwl_scan_cmd</span> <span class="o">*</span><span class="n">scan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwl_rxon_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">rate_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmd_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_chain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">n_probes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rx_ant</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_rx_ant</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">chan_mod</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">active_chains</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scan_tx_antennas</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scan_cmd_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_scan_cmd</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">MAX_SCAN_CHANNEL</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_scan_channel</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">ucode_capa</span><span class="p">.</span><span class="n">max_probe_length</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">&amp;&amp;</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">&gt;</span> <span class="n">MAX_SCAN_CHANNEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="p">)</span>
		<span class="n">ctx</span> <span class="o">=</span> <span class="n">iwl_rxon_ctx_from_vif</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_cmd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">scan_cmd_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				       <span class="s">&quot;fail to allocate memory for scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">scan</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">scan_cmd_size</span><span class="p">);</span>

	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">quiet_plcp_th</span> <span class="o">=</span> <span class="n">IWL_PLCP_QUIET_THRESH</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">quiet_time</span> <span class="o">=</span> <span class="n">IWL_ACTIVE_QUIET_TIME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">!=</span> <span class="n">IWL_SCAN_ROC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">iwl_is_any_associated</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">extra</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">suspend_time</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">scan_suspend_time</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

		<span class="n">IWL_DEBUG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scanning while associated...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IWL_SCAN_ROC</span>:
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IWL_SCAN_RADIO_RESET</span>:
			<span class="n">interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IWL_SCAN_NORMAL</span>:
			<span class="n">interval</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">suspend_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">max_out_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">200</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interval</span><span class="p">)</span>
			<span class="n">interval</span> <span class="o">=</span> <span class="n">suspend_time</span><span class="p">;</span>

		<span class="n">extra</span> <span class="o">=</span> <span class="p">(</span><span class="n">suspend_time</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">;</span>
		<span class="n">scan_suspend_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">extra</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">suspend_time</span> <span class="o">%</span> <span class="n">interval</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">));</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">suspend_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scan_suspend_time</span><span class="p">);</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;suspend_time 0x%X beacon interval %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">scan_suspend_time</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">==</span> <span class="n">IWL_SCAN_ROC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">suspend_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">max_out_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">quiet_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">quiet_plcp_th</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IWL_SCAN_RADIO_RESET</span>:
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Start internal passive scan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWL_SCAN_NORMAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Kicking off active scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * The highest priority SSID is inserted to the</span>
<span class="cm">			 * probe request template.</span>
<span class="cm">			 */</span>
			<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">;</span>
			<span class="n">ssid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Invert the order of ssids, the firmware will invert</span>
<span class="cm">			 * it back.</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">n_ssids</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scan</span><span class="o">-&gt;</span><span class="n">direct_scan</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
				<span class="n">scan</span><span class="o">-&gt;</span><span class="n">direct_scan</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">direct_scan</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span>
				       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span>
				       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">);</span>
				<span class="n">n_probes</span><span class="o">++</span><span class="p">;</span>
				<span class="n">p</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">is_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Start passive scan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWL_SCAN_ROC</span>:
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Start ROC scan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bcast_sta_id</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">stop_time</span><span class="p">.</span><span class="n">life_time</span> <span class="o">=</span> <span class="n">TX_CMD_LIFE_TIME_INFINITE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>:
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RXON_FLG_BAND_24G_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_AUTO_DETECT_MSK</span><span class="p">;</span>
		<span class="n">chan_mod</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">IWL_RXON_CTX_BSS</span><span class="p">].</span><span class="n">active</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span>
						<span class="n">RXON_FLG_CHANNEL_MODE_MSK</span><span class="p">)</span>
				       <span class="o">&gt;&gt;</span> <span class="n">RXON_FLG_CHANNEL_MODE_POS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">no_cck</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">chan_mod</span> <span class="o">==</span> <span class="n">CHANNEL_MODE_PURE_40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">IWL_RATE_6M_PLCP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">IWL_RATE_1M_PLCP</span><span class="p">;</span>
			<span class="n">rate_flags</span> <span class="o">=</span> <span class="n">RATE_MCS_CCK_MSK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Internal scans are passive, so we can indiscriminately set</span>
<span class="cm">		 * the BT ignore flag on 2.4 GHz since it applies to TX only.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span> <span class="o">&amp;&amp;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">advanced_bt_coexist</span><span class="p">)</span>
			<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_IGNORE_BT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_5GHZ</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="n">IWL_RATE_6M_PLCP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Invalid scan band</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If active scanning is requested but a certain channel is</span>
<span class="cm">	 * marked passive, we can do active scanning if we detect</span>
<span class="cm">	 * transmissions.</span>
<span class="cm">	 *</span>
<span class="cm">	 * There is an issue with some firmware versions that triggers</span>
<span class="cm">	 * a sysassert on a &quot;good CRC threshold&quot; of zero (== disabled),</span>
<span class="cm">	 * on a radar channel even though this means that we should NOT</span>
<span class="cm">	 * send probes.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The &quot;good CRC threshold&quot; is the number of frames that we</span>
<span class="cm">	 * need to receive during our dwell time on a channel before</span>
<span class="cm">	 * sending out probes -- setting this to a huge value will</span>
<span class="cm">	 * mean we never reach it, but at the same time work around</span>
<span class="cm">	 * the aforementioned issue. Thus use IWL_GOOD_CRC_TH_NEVER</span>
<span class="cm">	 * here instead of IWL_GOOD_CRC_TH_DISABLED.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This was fixed in later versions along with some other</span>
<span class="cm">	 * scan changes, and the threshold behaves as a flag in those</span>
<span class="cm">	 * versions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_scan_threshold_behaviour</span><span class="p">)</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">good_CRC_th</span> <span class="o">=</span> <span class="n">is_active</span> <span class="o">?</span> <span class="n">IWL_GOOD_CRC_TH_DEFAULT</span> <span class="o">:</span>
						<span class="n">IWL_GOOD_CRC_TH_DISABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">good_CRC_th</span> <span class="o">=</span> <span class="n">is_active</span> <span class="o">?</span> <span class="n">IWL_GOOD_CRC_TH_DEFAULT</span> <span class="o">:</span>
						<span class="n">IWL_GOOD_CRC_TH_NEVER</span><span class="p">;</span>

	<span class="n">band</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_band</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">advanced_bt_coexist</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* transmit 2.4 GHz probes only on first antenna */</span>
		<span class="n">scan_tx_antennas</span> <span class="o">=</span> <span class="n">first_antenna</span><span class="p">(</span><span class="n">scan_tx_antennas</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_tx_ant</span><span class="p">[</span><span class="n">band</span><span class="p">]</span> <span class="o">=</span> <span class="n">iwl_toggle_tx_ant</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
						    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_tx_ant</span><span class="p">[</span><span class="n">band</span><span class="p">],</span>
						    <span class="n">scan_tx_antennas</span><span class="p">);</span>
	<span class="n">rate_flags</span> <span class="o">|=</span> <span class="n">iwl_ant_idx_to_flags</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_tx_ant</span><span class="p">[</span><span class="n">band</span><span class="p">]);</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">iwl_hw_set_rate_n_flags</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">rate_flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * In power save mode while associated use one chain,</span>
<span class="cm">	 * otherwise use all chains</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_POWER_PMI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_IDLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* rx_ant has been set to all valid chains previously */</span>
		<span class="n">active_chains</span> <span class="o">=</span> <span class="n">rx_ant</span> <span class="o">&amp;</span>
				<span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">chain_noise_data</span><span class="p">.</span><span class="n">active_chains</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">active_chains</span><span class="p">)</span>
			<span class="n">active_chains</span> <span class="o">=</span> <span class="n">rx_ant</span><span class="p">;</span>

		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;chain_noise_data.active_chains: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">chain_noise_data</span><span class="p">.</span><span class="n">active_chains</span><span class="p">);</span>

		<span class="n">rx_ant</span> <span class="o">=</span> <span class="n">first_antenna</span><span class="p">(</span><span class="n">active_chains</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">bt_params</span><span class="o">-&gt;</span><span class="n">advanced_bt_coexist</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bt_full_concurrent</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* operated as 1x1 in full concurrency mode */</span>
		<span class="n">rx_ant</span> <span class="o">=</span> <span class="n">first_antenna</span><span class="p">(</span><span class="n">rx_ant</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* MIMO is not used here, but value is required */</span>
	<span class="n">rx_chain</span> <span class="o">|=</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_rx_ant</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_VALID_POS</span><span class="p">;</span>
	<span class="n">rx_chain</span> <span class="o">|=</span> <span class="n">rx_ant</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_FORCE_MIMO_SEL_POS</span><span class="p">;</span>
	<span class="n">rx_chain</span> <span class="o">|=</span> <span class="n">rx_ant</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_FORCE_SEL_POS</span><span class="p">;</span>
	<span class="n">rx_chain</span> <span class="o">|=</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_DRIVER_FORCE_POS</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">rx_chain</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rx_chain</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IWL_SCAN_NORMAL</span>:
		<span class="n">cmd_len</span> <span class="o">=</span> <span class="n">iwl_fill_probe_req</span><span class="p">(</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">,</span>
					<span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">,</span>
					<span class="n">scan_cmd_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scan</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWL_SCAN_RADIO_RESET</span>:
	<span class="k">case</span> <span class="n">IWL_SCAN_ROC</span>:
		<span class="cm">/* use bcast addr, will not be transmitted but must be valid */</span>
		<span class="n">cmd_len</span> <span class="o">=</span> <span class="n">iwl_fill_probe_req</span><span class="p">(</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					<span class="n">iwl_bcast_addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">scan_cmd_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scan</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_len</span><span class="p">);</span>

	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">RXON_FILTER_ACCEPT_GRP_MSK</span> <span class="o">|</span>
			       <span class="n">RXON_FILTER_BCON_AWARE_MSK</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IWL_SCAN_RADIO_RESET</span>:
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span> <span class="o">=</span>
			<span class="n">iwl_get_single_channel_for_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cmd_len</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWL_SCAN_NORMAL</span>:
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span> <span class="o">=</span>
			<span class="n">iwl_get_channels_for_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span>
				<span class="n">is_active</span><span class="p">,</span> <span class="n">n_probes</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cmd_len</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IWL_SCAN_ROC</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iwl_scan_channel</span> <span class="o">*</span><span class="n">scan_ch</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">n_chan</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">dwell</span><span class="p">;</span>

		<span class="n">dwell</span> <span class="o">=</span> <span class="n">iwl_limit_dwell</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_duration</span><span class="p">);</span>
		<span class="n">n_chan</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_duration</span><span class="p">,</span> <span class="n">dwell</span><span class="p">);</span>

		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span> <span class="o">=</span> <span class="n">n_chan</span><span class="p">;</span>

		<span class="n">scan_ch</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cmd_len</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_chan</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SCAN_CHANNEL_TYPE_PASSIVE</span><span class="p">;</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">n_chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">dwell</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_duration</span> <span class="o">-</span> <span class="n">i</span> <span class="o">*</span> <span class="n">dwell</span><span class="p">;</span>

			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">active_dwell</span> <span class="o">=</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dwell</span><span class="p">);</span>

			<span class="cm">/* Set txpower levels to defaults */</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">dsp_atten</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>

			<span class="cm">/* NOTE: if we were doing 6Mb OFDM for scans we&#39;d use</span>
<span class="cm">			 * power level:</span>
<span class="cm">			 * scan_ch-&gt;tx_gain = ((1 &lt;&lt; 5) | (2 &lt;&lt; 3)) | 3;</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_roc_channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
				<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">tx_gain</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">tx_gain</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>

			<span class="n">scan_ch</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;channel count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_scan_channel</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">dataflags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IWL_HCMD_DFL_NOCOPY</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">len</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* set scan bit here for PAN params */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_set_pan_params</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwl_dvm_send_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">iwlagn_set_pan_params</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwl_init_scan_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ant_idx</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_tx_ant</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">])</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_tx_ant</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">ant_idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_tx_ant</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">])</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_tx_ant</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">ant_idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__must_check</span> <span class="nf">iwl_scan_initiate</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">iwl_scan_type</span> <span class="n">scan_type</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_check</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iwl_is_ready_rf</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_WARN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Request scan called when driver not ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="s">&quot;Multiple concurrent scan requests in parallel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCAN_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scan request while abort pending.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Starting %sscan...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">scan_type</span> <span class="o">==</span> <span class="n">IWL_SCAN_NORMAL</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span>
			<span class="n">scan_type</span> <span class="o">==</span> <span class="n">IWL_SCAN_ROC</span> <span class="o">?</span> <span class="s">&quot;remain-on-channel &quot;</span> <span class="o">:</span>
			<span class="s">&quot;internal short &quot;</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">=</span> <span class="n">scan_type</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwlagn_request_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">=</span> <span class="n">IWL_SCAN_NORMAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_check</span><span class="p">,</span>
			   <span class="n">IWL_SCAN_CHECK_WATCHDOG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * internal short scan, this function should only been called while associated.</span>
<span class="cm"> * It will reset and tune the radio to prevent possible RF related problem</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">iwl_internal_short_hw_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_internal_scan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwl_bg_start_internal_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwl_priv</span><span class="p">,</span> <span class="n">start_internal_scan</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Start internal scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_type</span> <span class="o">==</span> <span class="n">IWL_SCAN_RADIO_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Internal scan already in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATUS_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scan already in progress.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iwl_scan_initiate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">IWL_SCAN_RADIO_RESET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">))</span>
		<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;failed to start internal short scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
 <span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwl_bg_scan_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwl_priv</span><span class="p">,</span> <span class="n">scan_check</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Scan check work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Since we are here firmware does not finish scan and</span>
<span class="cm">	 * most likely is in bad shape, so we don&#39;t bother to</span>
<span class="cm">	 * send abort command, just force scan complete to mac80211 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">iwl_force_scan_end</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwl_bg_abort_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwl_priv</span><span class="p">,</span> <span class="n">abort_scan</span><span class="p">);</span>

	<span class="n">IWL_DEBUG_SCAN</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Abort scan work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* We keep scan_check work queued in case when firmware will not</span>
<span class="cm">	 * report back scan completed notification */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">iwl_scan_cancel_timeout</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwl_bg_scan_completed</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwl_priv</span><span class="p">,</span> <span class="n">scan_completed</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">iwl_process_scan_complete</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwl_setup_scan_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_completed</span><span class="p">,</span> <span class="n">iwl_bg_scan_completed</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">abort_scan</span><span class="p">,</span> <span class="n">iwl_bg_abort_scan</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_internal_scan</span><span class="p">,</span> <span class="n">iwl_bg_start_internal_scan</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_check</span><span class="p">,</span> <span class="n">iwl_bg_scan_check</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">iwl_cancel_scan_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwl_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">start_internal_scan</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">abort_scan</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_completed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_check</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">iwl_force_scan_end</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
