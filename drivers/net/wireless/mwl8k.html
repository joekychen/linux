<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › mwl8k.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>mwl8k.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/net/wireless/mwl8k.c</span>
<span class="cm"> * Driver for Marvell TOPDOG 802.11 Wireless cards</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008, 2009, 2010 Marvell Semiconductor Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2.  This program is licensed &quot;as is&quot; without any</span>
<span class="cm"> * warranty of any kind, whether express or implied.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#define MWL8K_DESC	&quot;Marvell TOPDOG(R) 802.11 Wireless Network Driver&quot;</span>
<span class="cp">#define MWL8K_NAME	KBUILD_MODNAME</span>
<span class="cp">#define MWL8K_VERSION	&quot;0.13&quot;</span>

<span class="cm">/* Module parameters */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">ap_mode_default</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ap_mode_default</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ap_mode_default</span><span class="p">,</span>
		 <span class="s">&quot;Set to 1 to make ap mode the default instead of sta mode&quot;</span><span class="p">);</span>

<span class="cm">/* Register definitions */</span>
<span class="cp">#define MWL8K_HIU_GEN_PTR			0x00000c10</span>
<span class="cp">#define  MWL8K_MODE_STA				 0x0000005a</span>
<span class="cp">#define  MWL8K_MODE_AP				 0x000000a5</span>
<span class="cp">#define MWL8K_HIU_INT_CODE			0x00000c14</span>
<span class="cp">#define  MWL8K_FWSTA_READY			 0xf0f1f2f4</span>
<span class="cp">#define  MWL8K_FWAP_READY			 0xf1f2f4a5</span>
<span class="cp">#define  MWL8K_INT_CODE_CMD_FINISHED		 0x00000005</span>
<span class="cp">#define MWL8K_HIU_SCRATCH			0x00000c40</span>

<span class="cm">/* Host-&gt;device communications */</span>
<span class="cp">#define MWL8K_HIU_H2A_INTERRUPT_EVENTS		0x00000c18</span>
<span class="cp">#define MWL8K_HIU_H2A_INTERRUPT_STATUS		0x00000c1c</span>
<span class="cp">#define MWL8K_HIU_H2A_INTERRUPT_MASK		0x00000c20</span>
<span class="cp">#define MWL8K_HIU_H2A_INTERRUPT_CLEAR_SEL	0x00000c24</span>
<span class="cp">#define MWL8K_HIU_H2A_INTERRUPT_STATUS_MASK	0x00000c28</span>
<span class="cp">#define  MWL8K_H2A_INT_DUMMY			 (1 &lt;&lt; 20)</span>
<span class="cp">#define  MWL8K_H2A_INT_RESET			 (1 &lt;&lt; 15)</span>
<span class="cp">#define  MWL8K_H2A_INT_DOORBELL			 (1 &lt;&lt; 1)</span>
<span class="cp">#define  MWL8K_H2A_INT_PPA_READY		 (1 &lt;&lt; 0)</span>

<span class="cm">/* Device-&gt;host communications */</span>
<span class="cp">#define MWL8K_HIU_A2H_INTERRUPT_EVENTS		0x00000c2c</span>
<span class="cp">#define MWL8K_HIU_A2H_INTERRUPT_STATUS		0x00000c30</span>
<span class="cp">#define MWL8K_HIU_A2H_INTERRUPT_MASK		0x00000c34</span>
<span class="cp">#define MWL8K_HIU_A2H_INTERRUPT_CLEAR_SEL	0x00000c38</span>
<span class="cp">#define MWL8K_HIU_A2H_INTERRUPT_STATUS_MASK	0x00000c3c</span>
<span class="cp">#define  MWL8K_A2H_INT_DUMMY			 (1 &lt;&lt; 20)</span>
<span class="cp">#define  MWL8K_A2H_INT_BA_WATCHDOG		 (1 &lt;&lt; 14)</span>
<span class="cp">#define  MWL8K_A2H_INT_CHNL_SWITCHED		 (1 &lt;&lt; 11)</span>
<span class="cp">#define  MWL8K_A2H_INT_QUEUE_EMPTY		 (1 &lt;&lt; 10)</span>
<span class="cp">#define  MWL8K_A2H_INT_RADAR_DETECT		 (1 &lt;&lt; 7)</span>
<span class="cp">#define  MWL8K_A2H_INT_RADIO_ON			 (1 &lt;&lt; 6)</span>
<span class="cp">#define  MWL8K_A2H_INT_RADIO_OFF		 (1 &lt;&lt; 5)</span>
<span class="cp">#define  MWL8K_A2H_INT_MAC_EVENT		 (1 &lt;&lt; 3)</span>
<span class="cp">#define  MWL8K_A2H_INT_OPC_DONE			 (1 &lt;&lt; 2)</span>
<span class="cp">#define  MWL8K_A2H_INT_RX_READY			 (1 &lt;&lt; 1)</span>
<span class="cp">#define  MWL8K_A2H_INT_TX_DONE			 (1 &lt;&lt; 0)</span>

<span class="cm">/* HW micro second timer register</span>
<span class="cm"> * located at offset 0xA600. This</span>
<span class="cm"> * will be used to timestamp tx</span>
<span class="cm"> * packets.</span>
<span class="cm"> */</span>

<span class="cp">#define	MWL8K_HW_TIMER_REGISTER			0x0000a600</span>

<span class="cp">#define MWL8K_A2H_EVENTS	(MWL8K_A2H_INT_DUMMY | \</span>
<span class="cp">				 MWL8K_A2H_INT_CHNL_SWITCHED | \</span>
<span class="cp">				 MWL8K_A2H_INT_QUEUE_EMPTY | \</span>
<span class="cp">				 MWL8K_A2H_INT_RADAR_DETECT | \</span>
<span class="cp">				 MWL8K_A2H_INT_RADIO_ON | \</span>
<span class="cp">				 MWL8K_A2H_INT_RADIO_OFF | \</span>
<span class="cp">				 MWL8K_A2H_INT_MAC_EVENT | \</span>
<span class="cp">				 MWL8K_A2H_INT_OPC_DONE | \</span>
<span class="cp">				 MWL8K_A2H_INT_RX_READY | \</span>
<span class="cp">				 MWL8K_A2H_INT_TX_DONE | \</span>
<span class="cp">				 MWL8K_A2H_INT_BA_WATCHDOG)</span>

<span class="cp">#define MWL8K_RX_QUEUES		1</span>
<span class="cp">#define MWL8K_TX_WMM_QUEUES	4</span>
<span class="cp">#define MWL8K_MAX_AMPDU_QUEUES	8</span>
<span class="cp">#define MWL8K_MAX_TX_QUEUES	(MWL8K_TX_WMM_QUEUES + MWL8K_MAX_AMPDU_QUEUES)</span>
<span class="cp">#define mwl8k_tx_queues(priv)	(MWL8K_TX_WMM_QUEUES + (priv)-&gt;num_ampdu_queues)</span>

<span class="k">struct</span> <span class="n">rxd_ops</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">rxd_size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rxd_init</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rxd</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">next_dma_addr</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">rxd_refill</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rxd</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">rxd_process</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">rxd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span>
			   <span class="n">__le16</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">noise</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mwl8k_device_info</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">part_name</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">helper_image</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fw_image_sta</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fw_image_ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxd_ops</span> <span class="o">*</span><span class="n">ap_rxd_ops</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fw_api_ap</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mwl8k_rx_queue</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">rxd_count</span><span class="p">;</span>

	<span class="cm">/* hw receives here */</span>
	<span class="kt">int</span> <span class="n">head</span><span class="p">;</span>

	<span class="cm">/* refill descs here */</span>
	<span class="kt">int</span> <span class="n">tail</span><span class="p">;</span>

	<span class="kt">void</span> <span class="o">*</span><span class="n">rxd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">rxd_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">DEFINE_DMA_UNMAP_ADDR</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mwl8k_tx_queue</span> <span class="p">{</span>
	<span class="cm">/* hw transmits here */</span>
	<span class="kt">int</span> <span class="n">head</span><span class="p">;</span>

	<span class="cm">/* sw appends here */</span>
	<span class="kt">int</span> <span class="n">tail</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_tx_desc</span> <span class="o">*</span><span class="n">txd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">txd_dma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skb</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">AMPDU_NO_STREAM</span><span class="p">,</span>
	<span class="n">AMPDU_STREAM_NEW</span><span class="p">,</span>
	<span class="n">AMPDU_STREAM_IN_PROGRESS</span><span class="p">,</span>
	<span class="n">AMPDU_STREAM_ACTIVE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">txq_idx</span><span class="p">;</span> <span class="cm">/* index of this stream in priv-&gt;txq */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mwl8k_device_info</span> <span class="o">*</span><span class="n">device_info</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sram</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="cm">/* firmware */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_helper</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_ucode</span><span class="p">;</span>

	<span class="cm">/* hardware/firmware parameters */</span>
	<span class="n">bool</span> <span class="n">ap_fw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxd_ops</span> <span class="o">*</span><span class="n">rxd_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">band_24</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">channels_24</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">rates_24</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">band_50</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">channels_50</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">rates_50</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">ap_macids_supported</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sta_macids_supported</span><span class="p">;</span>

	<span class="cm">/* Ampdu stream information */</span>
	<span class="n">u8</span> <span class="n">num_ampdu_queues</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">stream_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="n">ampdu</span><span class="p">[</span><span class="n">MWL8K_MAX_AMPDU_QUEUES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">watchdog_ba_handle</span><span class="p">;</span>

	<span class="cm">/* firmware access */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">fw_mutex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">fw_mutex_owner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">hw_restart_owner</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fw_mutex_depth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">hostcmd_wait</span><span class="p">;</span>

	<span class="cm">/* lock held over TX and TX reap */</span>
	<span class="n">spinlock_t</span> <span class="n">tx_lock</span><span class="p">;</span>

	<span class="cm">/* TX quiesce completion, protected by fw_mutex and tx_lock */</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">tx_wait</span><span class="p">;</span>

	<span class="cm">/* List of interfaces.  */</span>
	<span class="n">u32</span> <span class="n">macids_used</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">vif_list</span><span class="p">;</span>

	<span class="cm">/* power management status cookie from firmware */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">cookie</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">cookie_dma</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">num_mcaddrs</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hw_rev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fw_rev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Running count of TX packets in flight, to avoid</span>
<span class="cm">	 * iterating over the transmit rings each time.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">pending_tx_pkts</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mwl8k_rx_queue</span> <span class="n">rxq</span><span class="p">[</span><span class="n">MWL8K_RX_QUEUES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mwl8k_tx_queue</span> <span class="n">txq</span><span class="p">[</span><span class="n">MWL8K_MAX_TX_QUEUES</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">txq_offset</span><span class="p">[</span><span class="n">MWL8K_MAX_TX_QUEUES</span><span class="p">];</span>

	<span class="n">bool</span> <span class="n">radio_on</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">radio_short_preamble</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sniffer_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">wmm_enabled</span><span class="p">;</span>

	<span class="cm">/* XXX need to convert this to handle multiple interfaces */</span>
	<span class="n">bool</span> <span class="n">capture_beacon</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">capture_bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon_skb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This FJ worker has to be global as it is scheduled from the</span>
<span class="cm">	 * RX handler.  At this point we don&#39;t know which interface it</span>
<span class="cm">	 * belongs to until the list of bssids waiting to complete join</span>
<span class="cm">	 * is checked.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">finalize_join_worker</span><span class="p">;</span>

	<span class="cm">/* Tasklet to perform TX reclaim.  */</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">poll_tx_task</span><span class="p">;</span>

	<span class="cm">/* Tasklet to perform RX.  */</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">poll_rx_task</span><span class="p">;</span>

	<span class="cm">/* Most recently reported noise in dBm */</span>
	<span class="n">s8</span> <span class="n">noise</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * preserve the queue configurations so they can be restored if/when</span>
<span class="cm">	 * the firmware image is swapped.</span>
<span class="cm">	 */</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="n">wmm_params</span><span class="p">[</span><span class="n">MWL8K_TX_WMM_QUEUES</span><span class="p">];</span>

	<span class="cm">/* To perform the task of reloading the firmware */</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">fw_reload</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hw_restart_in_progress</span><span class="p">;</span>

	<span class="cm">/* async firmware loading state */</span>
	<span class="kt">unsigned</span> <span class="n">fw_state</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fw_pref</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fw_alt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">firmware_loading_complete</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define MAX_WEP_KEY_LEN         13</span>
<span class="cp">#define NUM_WEP_KEYS            4</span>

<span class="cm">/* Per interface specific private data */</span>
<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>

	<span class="cm">/* Firmware macid for this vif.  */</span>
	<span class="kt">int</span> <span class="n">macid</span><span class="p">;</span>

	<span class="cm">/* Non AMPDU sequence number assigned by driver.  */</span>
	<span class="n">u16</span> <span class="n">seqno</span><span class="p">;</span>

	<span class="cm">/* Saved WEP keys */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">enabled</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_key_conf</span><span class="p">)</span> <span class="o">+</span> <span class="n">MAX_WEP_KEY_LEN</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">wep_key_conf</span><span class="p">[</span><span class="n">NUM_WEP_KEYS</span><span class="p">];</span>

	<span class="cm">/* BSSID */</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="cm">/* A flag to indicate is HW crypto is enabled for this bssid */</span>
	<span class="n">bool</span> <span class="n">is_hw_crypto_enabled</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#define MWL8K_VIF(_vif) ((struct mwl8k_vif *)&amp;((_vif)-&gt;drv_priv))</span>
<span class="cp">#define IEEE80211_KEY_CONF(_u8) ((struct ieee80211_key_conf *)(_u8))</span>

<span class="k">struct</span> <span class="n">tx_traffic_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">start_time</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pkts</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define MWL8K_MAX_TID 8</span>
<span class="k">struct</span> <span class="n">mwl8k_sta</span> <span class="p">{</span>
	<span class="cm">/* Index into station database. Returned by UPDATE_STADB.  */</span>
	<span class="n">u8</span> <span class="n">peer_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">is_ampdu_allowed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_traffic_info</span> <span class="n">tx_stats</span><span class="p">[</span><span class="n">MWL8K_MAX_TID</span><span class="p">];</span>
<span class="p">};</span>
<span class="cp">#define MWL8K_STA(_sta) ((struct mwl8k_sta *)&amp;((_sta)-&gt;drv_priv))</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">mwl8k_channels_24</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2412</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2417</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2422</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2427</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2432</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2437</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2442</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2447</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2452</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2457</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2462</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2467</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2472</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2484</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">mwl8k_rates_24</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">22</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">220</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">44</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">72</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">108</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">720</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">144</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">mwl8k_channels_50</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5180</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5200</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5220</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">44</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">5240</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">mwl8k_rates_50</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">72</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">96</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">108</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">720</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">144</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Set or get info from Firmware */</span>
<span class="cp">#define MWL8K_CMD_GET			0x0000</span>
<span class="cp">#define MWL8K_CMD_SET			0x0001</span>
<span class="cp">#define MWL8K_CMD_SET_LIST		0x0002</span>

<span class="cm">/* Firmware command codes */</span>
<span class="cp">#define MWL8K_CMD_CODE_DNLD		0x0001</span>
<span class="cp">#define MWL8K_CMD_GET_HW_SPEC		0x0003</span>
<span class="cp">#define MWL8K_CMD_SET_HW_SPEC		0x0004</span>
<span class="cp">#define MWL8K_CMD_MAC_MULTICAST_ADR	0x0010</span>
<span class="cp">#define MWL8K_CMD_GET_STAT		0x0014</span>
<span class="cp">#define MWL8K_CMD_RADIO_CONTROL		0x001c</span>
<span class="cp">#define MWL8K_CMD_RF_TX_POWER		0x001e</span>
<span class="cp">#define MWL8K_CMD_TX_POWER		0x001f</span>
<span class="cp">#define MWL8K_CMD_RF_ANTENNA		0x0020</span>
<span class="cp">#define MWL8K_CMD_SET_BEACON		0x0100		</span><span class="cm">/* per-vif */</span><span class="cp"></span>
<span class="cp">#define MWL8K_CMD_SET_PRE_SCAN		0x0107</span>
<span class="cp">#define MWL8K_CMD_SET_POST_SCAN		0x0108</span>
<span class="cp">#define MWL8K_CMD_SET_RF_CHANNEL	0x010a</span>
<span class="cp">#define MWL8K_CMD_SET_AID		0x010d</span>
<span class="cp">#define MWL8K_CMD_SET_RATE		0x0110</span>
<span class="cp">#define MWL8K_CMD_SET_FINALIZE_JOIN	0x0111</span>
<span class="cp">#define MWL8K_CMD_RTS_THRESHOLD		0x0113</span>
<span class="cp">#define MWL8K_CMD_SET_SLOT		0x0114</span>
<span class="cp">#define MWL8K_CMD_SET_EDCA_PARAMS	0x0115</span>
<span class="cp">#define MWL8K_CMD_SET_WMM_MODE		0x0123</span>
<span class="cp">#define MWL8K_CMD_MIMO_CONFIG		0x0125</span>
<span class="cp">#define MWL8K_CMD_USE_FIXED_RATE	0x0126</span>
<span class="cp">#define MWL8K_CMD_ENABLE_SNIFFER	0x0150</span>
<span class="cp">#define MWL8K_CMD_SET_MAC_ADDR		0x0202		</span><span class="cm">/* per-vif */</span><span class="cp"></span>
<span class="cp">#define MWL8K_CMD_SET_RATEADAPT_MODE	0x0203</span>
<span class="cp">#define MWL8K_CMD_GET_WATCHDOG_BITMAP	0x0205</span>
<span class="cp">#define MWL8K_CMD_DEL_MAC_ADDR		0x0206		</span><span class="cm">/* per-vif */</span><span class="cp"></span>
<span class="cp">#define MWL8K_CMD_BSS_START		0x1100		</span><span class="cm">/* per-vif */</span><span class="cp"></span>
<span class="cp">#define MWL8K_CMD_SET_NEW_STN		0x1111		</span><span class="cm">/* per-vif */</span><span class="cp"></span>
<span class="cp">#define MWL8K_CMD_UPDATE_ENCRYPTION	0x1122		</span><span class="cm">/* per-vif */</span><span class="cp"></span>
<span class="cp">#define MWL8K_CMD_UPDATE_STADB		0x1123</span>
<span class="cp">#define MWL8K_CMD_BASTREAM		0x1125</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">mwl8k_cmd_name</span><span class="p">(</span><span class="n">__le16</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">command</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="cp">#define MWL8K_CMDNAME(x)	case MWL8K_CMD_##x: do {\</span>
<span class="cp">					snprintf(buf, bufsize, &quot;%s&quot;, #x);\</span>
<span class="cp">					return buf;\</span>
<span class="cp">					} while (0)</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">CODE_DNLD</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">GET_HW_SPEC</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_HW_SPEC</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">MAC_MULTICAST_ADR</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">GET_STAT</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">RADIO_CONTROL</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">RF_TX_POWER</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">TX_POWER</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">RF_ANTENNA</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_BEACON</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_PRE_SCAN</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_POST_SCAN</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_RF_CHANNEL</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_AID</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_RATE</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_FINALIZE_JOIN</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">RTS_THRESHOLD</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_SLOT</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_EDCA_PARAMS</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_WMM_MODE</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">MIMO_CONFIG</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">USE_FIXED_RATE</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">ENABLE_SNIFFER</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_MAC_ADDR</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_RATEADAPT_MODE</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">BSS_START</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">SET_NEW_STN</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">UPDATE_ENCRYPTION</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">UPDATE_STADB</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">BASTREAM</span><span class="p">);</span>
		<span class="n">MWL8K_CMDNAME</span><span class="p">(</span><span class="n">GET_WATCHDOG_BITMAP</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span> <span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#undef MWL8K_CMDNAME</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Hardware and firmware reset */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_H2A_INT_RESET</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_H2A_INTERRUPT_EVENTS</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_H2A_INT_RESET</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_H2A_INTERRUPT_EVENTS</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Release fw image */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_release_fw</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">);</span>
	<span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_release_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mwl8k_release_fw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ucode</span><span class="p">);</span>
	<span class="n">mwl8k_release_fw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_helper</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* states for asynchronous f/w loading */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mwl8k_fw_state_machine</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">FW_STATE_INIT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">FW_STATE_LOADING_PREF</span><span class="p">,</span>
	<span class="n">FW_STATE_LOADING_ALT</span><span class="p">,</span>
	<span class="n">FW_STATE_ERROR</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Request fw image */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_request_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="n">nowait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* release current image */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fw</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">mwl8k_release_fw</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nowait</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">request_firmware_nowait</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
					       <span class="n">priv</span><span class="p">,</span> <span class="n">mwl8k_fw_state_machine</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_image</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">nowait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_device_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">helper_image</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nowait</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_request_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">helper_image</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_helper</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_request_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">helper_image</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_helper</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error requesting helper fw %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">helper_image</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">||</span> <span class="n">nowait</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nowait</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * if we get here, no helper image is needed.  Skip the</span>
<span class="cm">		 * FW_STATE_INIT state.</span>
<span class="cm">		 */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_state</span> <span class="o">=</span> <span class="n">FW_STATE_LOADING_PREF</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_request_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fw_image</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ucode</span><span class="p">,</span>
				      <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_request_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fw_image</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ucode</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error requesting firmware file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">fw_image</span><span class="p">);</span>
		<span class="n">mwl8k_release_fw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_helper</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="p">{</span>
	<span class="n">__le16</span>	<span class="n">code</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">length</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">seq_num</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">macid</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">result</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Firmware loading.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_send_fw_load_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loops</span><span class="p">;</span>

	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_GEN_PTR</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_INT_CODE</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_H2A_INT_DOORBELL</span><span class="p">,</span>
		<span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_H2A_INTERRUPT_EVENTS</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_H2A_INT_DUMMY</span><span class="p">,</span>
		<span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_H2A_INTERRUPT_EVENTS</span><span class="p">);</span>

	<span class="n">loops</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">int_code</span><span class="p">;</span>

		<span class="n">int_code</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_INT_CODE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">int_code</span> <span class="o">==</span> <span class="n">MWL8K_INT_CODE_CMD_FINISHED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_INT_CODE</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">loops</span><span class="p">);</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">loops</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_load_fw_image</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="mi">256</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_CODE_DNLD</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">macid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mi">256</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="n">length</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">done</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">block_size</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_send_fw_load_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">block_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">done</span> <span class="o">+=</span> <span class="n">block_size</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">-=</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_send_fw_load_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_feed_fw_image</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">may_continue</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">done</span><span class="p">,</span> <span class="n">prev_block_size</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prev_block_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">may_continue</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">may_continue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">block_size</span><span class="p">;</span>

		<span class="n">block_size</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_SCRATCH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">block_size</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">may_continue</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">done</span> <span class="o">+=</span> <span class="n">prev_block_size</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">-=</span> <span class="n">prev_block_size</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">||</span> <span class="n">block_size</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
			<span class="n">may_continue</span><span class="o">--</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">prev_block_size</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">done</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_send_fw_load_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ucode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x01\x00\x00\x00</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">helper</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_helper</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">helper</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: helper image needed but none &quot;</span>
			       <span class="s">&quot;given</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_load_fw_image</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">helper</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">helper</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to load firmware &quot;</span>
			       <span class="s">&quot;helper image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_feed_fw_image</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_load_fw_image</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: unable to load firmware image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_MODE_STA</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_GEN_PTR</span><span class="p">);</span>

	<span class="n">loops</span> <span class="o">=</span> <span class="mi">500000</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ready_code</span><span class="p">;</span>

		<span class="n">ready_code</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_INT_CODE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ready_code</span> <span class="o">==</span> <span class="n">MWL8K_FWAP_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ready_code</span> <span class="o">==</span> <span class="n">MWL8K_FWSTA_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cond_resched</span><span class="p">();</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">loops</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">loops</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* DMA header used by firmware and hardware.  */</span>
<span class="k">struct</span> <span class="n">mwl8k_dma_data</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">fwlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="n">wh</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Routines to add/remove DMA header from skb.  */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mwl8k_remove_dma_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_dma_data</span> <span class="o">*</span><span class="n">tr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="n">tr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_dma_data</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">.</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">.</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">,</span> <span class="n">hdrlen</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
			<span class="o">*</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">=</span> <span class="n">qos</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tr</span><span class="p">))</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tr</span><span class="p">)</span> <span class="o">-</span> <span class="n">hdrlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define REDUCED_TX_HEADROOM	8</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwl8k_add_dma_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">head_pad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tail_pad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">wh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reqd_hdrlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_dma_data</span> <span class="o">*</span><span class="n">tr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add a firmware DMA header; the firmware requires that we</span>
<span class="cm">	 * present a 2-byte payload length followed by a 4-address</span>
<span class="cm">	 * header (without QoS field), followed (optionally) by any</span>
<span class="cm">	 * WEP/ExtIV header (but only filled in for CCMP).</span>
<span class="cm">	 */</span>
	<span class="n">wh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if skb_resize is required because of</span>
<span class="cm">	 * tx_headroom adjustment.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_cts</span><span class="p">)</span>
						<span class="o">+</span> <span class="n">REDUCED_TX_HEADROOM</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">REDUCED_TX_HEADROOM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
					<span class="s">&quot;Failed to reallocate TX buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">+=</span> <span class="n">REDUCED_TX_HEADROOM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reqd_hdrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tr</span><span class="p">)</span> <span class="o">+</span> <span class="n">head_pad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">!=</span> <span class="n">reqd_hdrlen</span><span class="p">)</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">reqd_hdrlen</span> <span class="o">-</span> <span class="n">hdrlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">hdrlen</span> <span class="o">-=</span> <span class="n">IEEE80211_QOS_CTL_LEN</span><span class="p">;</span>

	<span class="n">tr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_dma_data</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wh</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">,</span> <span class="n">wh</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">))</span>
		<span class="n">memset</span><span class="p">(((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">)</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">)</span> <span class="o">-</span> <span class="n">hdrlen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Firmware length is the length of the fully formed &quot;802.11</span>
<span class="cm">	 * payload&quot;.  That is, everything except for the 802.11 header.</span>
<span class="cm">	 * This includes all crypto material including the MIC.</span>
<span class="cm">	 */</span>
	<span class="n">tr</span><span class="o">-&gt;</span><span class="n">fwlen</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tr</span><span class="p">)</span> <span class="o">+</span> <span class="n">tail_pad</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_encapsulate_tx_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">wh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_pad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">head_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">key_conf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">key_conf</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure the packet header is in the DMA header format (4-address</span>
<span class="cm">	 * without QoS), and add head &amp; tail padding when HW crypto is enabled.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We have the following trailer padding requirements:</span>
<span class="cm">	 * - WEP: 4 trailer bytes (ICV)</span>
<span class="cm">	 * - TKIP: 12 trailer bytes (8 MIC + 4 ICV)</span>
<span class="cm">	 * - CCMP: 8 trailer bytes (MIC)</span>
<span class="cm">	 */</span>
	<span class="n">data_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_conf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head_pad</span> <span class="o">=</span> <span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">iv_len</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">key_conf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
			<span class="n">data_pad</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
			<span class="n">data_pad</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
			<span class="n">data_pad</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mwl8k_add_dma_header</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">head_pad</span><span class="p">,</span> <span class="n">data_pad</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Packet reception for 88w8366 AP firmware.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_rxd_8366_ap</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">pkt_len</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">sq2</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">pkt_phys_addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">next_rxd_phys_addr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">qos_control</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">htsig2</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">hw_rssi_info</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">hw_noise_floor_info</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">noise_floor</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">pad0</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">rx_status</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">rx_ctrl</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define MWL8K_8366_AP_RATE_INFO_MCS_FORMAT	0x80</span>
<span class="cp">#define MWL8K_8366_AP_RATE_INFO_40MHZ		0x40</span>
<span class="cp">#define MWL8K_8366_AP_RATE_INFO_RATEID(x)	((x) &amp; 0x3f)</span>

<span class="cp">#define MWL8K_8366_AP_RX_CTRL_OWNED_BY_HOST	0x80</span>

<span class="cm">/* 8366 AP rx_status bits */</span>
<span class="cp">#define MWL8K_8366_AP_RXSTAT_DECRYPT_ERR_MASK		0x80</span>
<span class="cp">#define MWL8K_8366_AP_RXSTAT_GENERAL_DECRYPT_ERR	0xFF</span>
<span class="cp">#define MWL8K_8366_AP_RXSTAT_TKIP_DECRYPT_MIC_ERR	0x02</span>
<span class="cp">#define MWL8K_8366_AP_RXSTAT_WEP_DECRYPT_ICV_ERR	0x04</span>
<span class="cp">#define MWL8K_8366_AP_RXSTAT_TKIP_DECRYPT_ICV_ERR	0x08</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_rxd_8366_ap_init</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_rxd</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">next_dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_rxd_8366_ap</span> <span class="o">*</span><span class="n">rxd</span> <span class="o">=</span> <span class="n">_rxd</span><span class="p">;</span>

	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">next_rxd_phys_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">next_dma_addr</span><span class="p">);</span>
	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">=</span> <span class="n">MWL8K_8366_AP_RX_CTRL_OWNED_BY_HOST</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_rxd_8366_ap_refill</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_rxd</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_rxd_8366_ap</span> <span class="o">*</span><span class="n">rxd</span> <span class="o">=</span> <span class="n">_rxd</span><span class="p">;</span>

	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">pkt_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">pkt_phys_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_rxd_8366_ap_process</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_rxd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span>
			  <span class="n">__le16</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">noise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_rxd_8366_ap</span> <span class="o">*</span><span class="n">rxd</span> <span class="o">=</span> <span class="n">_rxd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">&amp;</span> <span class="n">MWL8K_8366_AP_RX_CTRL_OWNED_BY_HOST</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rmb</span><span class="p">();</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">status</span><span class="p">));</span>

	<span class="n">status</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="o">-</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
	<span class="o">*</span><span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">noise_floor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="n">MWL8K_8366_AP_RATE_INFO_MCS_FORMAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_HT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="n">MWL8K_8366_AP_RATE_INFO_40MHZ</span><span class="p">)</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_40MHZ</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">MWL8K_8366_AP_RATE_INFO_RATEID</span><span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mwl8k_rates_24</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_rates_24</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span> <span class="o">==</span> <span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_HT</span><span class="p">))</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">ieee80211_channel_to_frequency</span><span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
						      <span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>

	<span class="o">*</span><span class="n">qos</span> <span class="o">=</span> <span class="n">rxd</span><span class="o">-&gt;</span><span class="n">qos_control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_status</span> <span class="o">!=</span> <span class="n">MWL8K_8366_AP_RXSTAT_GENERAL_DECRYPT_ERR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">MWL8K_8366_AP_RXSTAT_DECRYPT_ERR_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_status</span> <span class="o">&amp;</span> <span class="n">MWL8K_8366_AP_RXSTAT_TKIP_DECRYPT_MIC_ERR</span><span class="p">))</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MMIC_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">pkt_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rxd_ops</span> <span class="n">rxd_8366_ap_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rxd_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_rxd_8366_ap</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rxd_init</span>	<span class="o">=</span> <span class="n">mwl8k_rxd_8366_ap_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rxd_refill</span>	<span class="o">=</span> <span class="n">mwl8k_rxd_8366_ap_refill</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rxd_process</span>	<span class="o">=</span> <span class="n">mwl8k_rxd_8366_ap_process</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Packet reception for STA firmware.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_rxd_sta</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">pkt_len</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">link_quality</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">noise_level</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">pkt_phys_addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">next_rxd_phys_addr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">qos_control</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">rate_info</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">pad0</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">pad1</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">rx_ctrl</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">rx_status</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">pad2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define MWL8K_STA_RATE_INFO_SHORTPRE		0x8000</span>
<span class="cp">#define MWL8K_STA_RATE_INFO_ANTSELECT(x)	(((x) &gt;&gt; 11) &amp; 0x3)</span>
<span class="cp">#define MWL8K_STA_RATE_INFO_RATEID(x)		(((x) &gt;&gt; 3) &amp; 0x3f)</span>
<span class="cp">#define MWL8K_STA_RATE_INFO_40MHZ		0x0004</span>
<span class="cp">#define MWL8K_STA_RATE_INFO_SHORTGI		0x0002</span>
<span class="cp">#define MWL8K_STA_RATE_INFO_MCS_FORMAT		0x0001</span>

<span class="cp">#define MWL8K_STA_RX_CTRL_OWNED_BY_HOST		0x02</span>
<span class="cp">#define MWL8K_STA_RX_CTRL_DECRYPT_ERROR		0x04</span>
<span class="cm">/* ICV=0 or MIC=1 */</span>
<span class="cp">#define MWL8K_STA_RX_CTRL_DEC_ERR_TYPE		0x08</span>
<span class="cm">/* Key is uploaded only in failure case */</span>
<span class="cp">#define MWL8K_STA_RX_CTRL_KEY_INDEX			0x30</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_rxd_sta_init</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_rxd</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">next_dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_rxd_sta</span> <span class="o">*</span><span class="n">rxd</span> <span class="o">=</span> <span class="n">_rxd</span><span class="p">;</span>

	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">next_rxd_phys_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">next_dma_addr</span><span class="p">);</span>
	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">=</span> <span class="n">MWL8K_STA_RX_CTRL_OWNED_BY_HOST</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_rxd_sta_refill</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_rxd</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_rxd_sta</span> <span class="o">*</span><span class="n">rxd</span> <span class="o">=</span> <span class="n">_rxd</span><span class="p">;</span>

	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">pkt_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">pkt_phys_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_rxd_sta_process</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">_rxd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span>
		       <span class="n">__le16</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span> <span class="n">s8</span> <span class="o">*</span><span class="n">noise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_rxd_sta</span> <span class="o">*</span><span class="n">rxd</span> <span class="o">=</span> <span class="n">_rxd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rate_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">&amp;</span> <span class="n">MWL8K_STA_RX_CTRL_OWNED_BY_HOST</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rmb</span><span class="p">();</span>

	<span class="n">rate_info</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rate_info</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">status</span><span class="p">));</span>

	<span class="n">status</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="o">-</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
	<span class="o">*</span><span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">noise_level</span><span class="p">;</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">antenna</span> <span class="o">=</span> <span class="n">MWL8K_STA_RATE_INFO_ANTSELECT</span><span class="p">(</span><span class="n">rate_info</span><span class="p">);</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">MWL8K_STA_RATE_INFO_RATEID</span><span class="p">(</span><span class="n">rate_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_info</span> <span class="o">&amp;</span> <span class="n">MWL8K_STA_RATE_INFO_SHORTPRE</span><span class="p">)</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORTPRE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_info</span> <span class="o">&amp;</span> <span class="n">MWL8K_STA_RATE_INFO_40MHZ</span><span class="p">)</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_40MHZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_info</span> <span class="o">&amp;</span> <span class="n">MWL8K_STA_RATE_INFO_SHORTGI</span><span class="p">)</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORT_GI</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_info</span> <span class="o">&amp;</span> <span class="n">MWL8K_STA_RATE_INFO_MCS_FORMAT</span><span class="p">)</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_HT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_HT</span><span class="p">))</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">ieee80211_channel_to_frequency</span><span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
						      <span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>

	<span class="o">*</span><span class="n">qos</span> <span class="o">=</span> <span class="n">rxd</span><span class="o">-&gt;</span><span class="n">qos_control</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">&amp;</span> <span class="n">MWL8K_STA_RX_CTRL_DECRYPT_ERROR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rx_ctrl</span> <span class="o">&amp;</span> <span class="n">MWL8K_STA_RX_CTRL_DEC_ERR_TYPE</span><span class="p">))</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MMIC_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxd</span><span class="o">-&gt;</span><span class="n">pkt_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rxd_ops</span> <span class="n">rxd_sta_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">rxd_size</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_rxd_sta</span><span class="p">),</span>
	<span class="p">.</span><span class="n">rxd_init</span>	<span class="o">=</span> <span class="n">mwl8k_rxd_sta_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rxd_refill</span>	<span class="o">=</span> <span class="n">mwl8k_rxd_sta_refill</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rxd_process</span>	<span class="o">=</span> <span class="n">mwl8k_rxd_sta_process</span><span class="p">,</span>
<span class="p">};</span>


<span class="cp">#define MWL8K_RX_DESCS		256</span>
<span class="cp">#define MWL8K_RX_MAXSZ		3800</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_rxq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">MWL8K_RX_DESCS</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span><span class="o">-&gt;</span><span class="n">rxd_size</span><span class="p">;</span>

	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;failed to alloc RX descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">MWL8K_RX_DESCS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;failed to alloc RX skbuff list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd_dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MWL8K_RX_DESCS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">desc_size</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">rxd</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">nexti</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">next_dma_addr</span><span class="p">;</span>

		<span class="n">desc_size</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span><span class="o">-&gt;</span><span class="n">rxd_size</span><span class="p">;</span>
		<span class="n">rxd</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span><span class="o">-&gt;</span><span class="n">rxd_size</span><span class="p">);</span>

		<span class="n">nexti</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nexti</span> <span class="o">==</span> <span class="n">MWL8K_RX_DESCS</span><span class="p">)</span>
			<span class="n">nexti</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">next_dma_addr</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd_dma</span> <span class="o">+</span> <span class="p">(</span><span class="n">nexti</span> <span class="o">*</span> <span class="n">desc_size</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span><span class="o">-&gt;</span><span class="n">rxd_init</span><span class="p">(</span><span class="n">rxd</span><span class="p">,</span> <span class="n">next_dma_addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rxq_refill</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">refilled</span><span class="p">;</span>

	<span class="n">refilled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd_count</span> <span class="o">&lt;</span> <span class="n">MWL8K_RX_DESCS</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rx</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">rxd</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">MWL8K_RX_MAXSZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				      <span class="n">MWL8K_RX_MAXSZ</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rx</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">MWL8K_RX_DESCS</span><span class="p">)</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">rx</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">rx</span><span class="p">],</span> <span class="n">dma</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

		<span class="n">rxd</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd</span> <span class="o">+</span> <span class="p">(</span><span class="n">rx</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span><span class="o">-&gt;</span><span class="n">rxd_size</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span><span class="o">-&gt;</span><span class="n">rxd_refill</span><span class="p">(</span><span class="n">rxd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">MWL8K_RX_MAXSZ</span><span class="p">);</span>

		<span class="n">refilled</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">refilled</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Must be called only when the card&#39;s reception is completely halted */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_rxq_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MWL8K_RX_DESCS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dma</span><span class="p">),</span>
					 <span class="n">MWL8K_RX_MAXSZ</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			    <span class="n">MWL8K_RX_DESCS</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span><span class="o">-&gt;</span><span class="n">rxd_size</span><span class="p">,</span>
			    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd_dma</span><span class="p">);</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Scan a list of BSSIDs to process for finalize join.</span>
<span class="cm"> * Allows for extension to process multiple BSSIDs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">mwl8k_capture_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">wh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">capture_beacon</span> <span class="o">&amp;&amp;</span>
		<span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">capture_bssid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mwl8k_save_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capture_beacon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capture_bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use GFP_ATOMIC as rxq_process is called from</span>
<span class="cm">	 * the primary interrupt handler, memory allocation call</span>
<span class="cm">	 * must not sleep.</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_skb</span> <span class="o">=</span> <span class="n">skb_copy</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">finalize_join_worker</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="nf">mwl8k_find_vif_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">vif_list</span><span class="p">,</span>
						   <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">mwl8k_vif</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mwl8k_vif</span><span class="p">,</span>
			    <span class="n">vif_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
			   <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">mwl8k_vif</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rxq_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">mwl8k_vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">processed</span><span class="p">;</span>

	<span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd_count</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">rxd</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">wh</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">qos</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rxd</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd</span> <span class="o">+</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span><span class="o">-&gt;</span><span class="n">rxd_size</span><span class="p">);</span>

		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span><span class="o">-&gt;</span><span class="n">rxd_process</span><span class="p">(</span><span class="n">rxd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qos</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">],</span> <span class="n">dma</span><span class="p">),</span>
				 <span class="n">MWL8K_RX_MAXSZ</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">],</span> <span class="n">dma</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">MWL8K_RX_DESCS</span><span class="p">)</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rxd_count</span><span class="o">--</span><span class="p">;</span>

		<span class="n">wh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">mwl8k_dma_data</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check for a pending join operation.  Save a</span>
<span class="cm">		 * copy of the beacon and schedule a tasklet to</span>
<span class="cm">		 * send a FINALIZE_JOIN command to the firmware.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_capture_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
			<span class="n">mwl8k_save_beacon</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* Check if hw crypto has been enabled for</span>
<span class="cm">			 * this bss. If yes, set the status flags</span>
<span class="cm">			 * accordingly</span>
<span class="cm">			 */</span>
			<span class="n">mwl8k_vif</span> <span class="o">=</span> <span class="n">mwl8k_find_vif_bss</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">,</span>
								<span class="n">wh</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_vif</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
			    <span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">is_hw_crypto_enabled</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * When MMIC ERROR is encountered</span>
<span class="cm">				 * by the firmware, payload is</span>
<span class="cm">				 * dropped and only 32 bytes of</span>
<span class="cm">				 * mwl8k Firmware header is sent</span>
<span class="cm">				 * to the host.</span>
<span class="cm">				 *</span>
<span class="cm">				 * We need to add four bytes of</span>
<span class="cm">				 * key information.  In it</span>
<span class="cm">				 * MAC80211 expects keyidx set to</span>
<span class="cm">				 * 0 for triggering Counter</span>
<span class="cm">				 * Measure of MMIC failure.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_MMIC_ERROR</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">mwl8k_dma_data</span> <span class="o">*</span><span class="n">tr</span><span class="p">;</span>
					<span class="n">tr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_dma_data</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
					<span class="n">memset</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
					<span class="n">pkt_len</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_auth</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
					<span class="n">status</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_IV_STRIPPED</span> <span class="o">|</span>
						       <span class="n">RX_FLAG_DECRYPTED</span> <span class="o">|</span>
						       <span class="n">RX_FLAG_MMIC_STRIPPED</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="n">mwl8k_remove_dma_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">qos</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="n">ieee80211_rx_irqsafe</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">processed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Packet transmission.</span>
<span class="cm"> */</span>

<span class="cp">#define MWL8K_TXD_STATUS_OK			0x00000001</span>
<span class="cp">#define MWL8K_TXD_STATUS_OK_RETRY		0x00000002</span>
<span class="cp">#define MWL8K_TXD_STATUS_OK_MORE_RETRY		0x00000004</span>
<span class="cp">#define MWL8K_TXD_STATUS_MULTICAST_TX		0x00000008</span>
<span class="cp">#define MWL8K_TXD_STATUS_FW_OWNED		0x80000000</span>

<span class="cp">#define MWL8K_QOS_QLEN_UNSPEC			0xff00</span>
<span class="cp">#define MWL8K_QOS_ACK_POLICY_MASK		0x0060</span>
<span class="cp">#define MWL8K_QOS_ACK_POLICY_NORMAL		0x0000</span>
<span class="cp">#define MWL8K_QOS_ACK_POLICY_BLOCKACK		0x0060</span>
<span class="cp">#define MWL8K_QOS_EOSP				0x0010</span>

<span class="k">struct</span> <span class="n">mwl8k_tx_desc</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">data_rate</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">tx_priority</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">qos_control</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">pkt_phys_addr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">pkt_len</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">dest_MAC_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le32</span> <span class="n">next_txd_phys_addr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">rate_info</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">peer_id</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">tx_frag_cnt</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define MWL8K_TX_DESCS		128</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_txq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">MWL8K_TX_DESCS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_tx_desc</span><span class="p">);</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;failed to alloc TX descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">MWL8K_TX_DESCS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;failed to alloc TX skbuff list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd_dma</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MWL8K_TX_DESCS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mwl8k_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">nexti</span><span class="p">;</span>

		<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">nexti</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MWL8K_TX_DESCS</span><span class="p">;</span>

		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">next_txd_phys_addr</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd_dma</span> <span class="o">+</span> <span class="n">nexti</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_desc</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mwl8k_tx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_H2A_INT_PPA_READY</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_H2A_INTERRUPT_EVENTS</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_H2A_INT_DUMMY</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_H2A_INTERRUPT_EVENTS</span><span class="p">);</span>
	<span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_INT_CODE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_dump_tx_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mwl8k_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">fw_owned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">drv_owned</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">unused</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">desc</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">desc</span> <span class="o">&lt;</span> <span class="n">MWL8K_TX_DESCS</span><span class="p">;</span> <span class="n">desc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mwl8k_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">+</span> <span class="n">desc</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MWL8K_TXD_STATUS_FW_OWNED</span><span class="p">)</span>
				<span class="n">fw_owned</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">drv_owned</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">pkt_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">unused</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;txq[%d] len=%d head=%d tail=%d &quot;</span>
			  <span class="s">&quot;fw_owned=%d drv_owned=%d unused=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">i</span><span class="p">,</span>
			  <span class="n">txq</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span>
			  <span class="n">fw_owned</span><span class="p">,</span> <span class="n">drv_owned</span><span class="p">,</span> <span class="n">unused</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Must be called with priv-&gt;fw_mutex held and tx queues stopped.</span>
<span class="cm"> */</span>
<span class="cp">#define MWL8K_TX_WAIT_TIMEOUT_MS	5000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_tx_wait_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">tx_wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="cm">/* Since fw restart is in progress, allow only the firmware</span>
<span class="cm">	 * commands from the restart code and block the other</span>
<span class="cm">	 * commands since they are going to fail in any case since</span>
<span class="cm">	 * the firmware has crashed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_owner</span> <span class="o">==</span> <span class="n">current</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The TX queues are stopped at this point, so this test</span>
<span class="cm">	 * doesn&#39;t need to take -&gt;tx_lock.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pending_tx_pkts</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wait</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_wait</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">oldcount</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

		<span class="n">oldcount</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pending_tx_pkts</span><span class="p">;</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_wait</span><span class="p">,</span>
			    <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MWL8K_TX_WAIT_TIMEOUT_MS</span><span class="p">));</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pending_tx_pkts</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retry</span><span class="p">)</span>
				<span class="n">wiphy_notice</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;tx rings drained</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pending_tx_pkts</span> <span class="o">&lt;</span> <span class="n">oldcount</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_notice</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				     <span class="s">&quot;waiting for tx rings to drain (%d -&gt; %d pkts)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">oldcount</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pending_tx_pkts</span><span class="p">);</span>
			<span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wait</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;tx rings stuck for %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">MWL8K_TX_WAIT_TIMEOUT_MS</span><span class="p">);</span>
		<span class="n">mwl8k_dump_tx_rings</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_in_progress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_reload</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MWL8K_TXD_SUCCESS(status)				\</span>
<span class="cp">	((status) &amp; (MWL8K_TXD_STATUS_OK |			\</span>
<span class="cp">		     MWL8K_TXD_STATUS_OK_RETRY |		\</span>
<span class="cp">		     MWL8K_TXD_STATUS_OK_MORE_RETRY))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_tid_queue_mapping</span><span class="p">(</span><span class="n">u8</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tid</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">IEEE80211_AC_BE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">IEEE80211_AC_BK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">return</span> <span class="n">IEEE80211_AC_VI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">return</span> <span class="n">IEEE80211_AC_VO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* The firmware will fill in the rate information</span>
<span class="cm"> * for each packet that gets queued in the hardware</span>
<span class="cm"> * and these macros will interpret that info.</span>
<span class="cm"> */</span>

<span class="cp">#define RI_FORMAT(a)		  (a &amp; 0x0001)</span>
<span class="cp">#define RI_RATE_ID_MCS(a)	 ((a &amp; 0x01f8) &gt;&gt; 3)</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_txq_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">,</span> <span class="kt">int</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">processed</span><span class="p">;</span>

	<span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">limit</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tx</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mwl8k_tx_desc</span> <span class="o">*</span><span class="n">tx_desc</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mwl8k_sta</span> <span class="o">*</span><span class="n">sta_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rate_info</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">wh</span><span class="p">;</span>

		<span class="n">tx</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="n">tx_desc</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">+</span> <span class="n">tx</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MWL8K_TXD_STATUS_FW_OWNED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_TXD_STATUS_FW_OWNED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">MWL8K_TX_DESCS</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pending_tx_pkts</span><span class="o">--</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">pkt_phys_addr</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">pkt_len</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">tx</span><span class="p">];</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">tx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="n">mwl8k_remove_dma_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">qos_control</span><span class="p">);</span>

		<span class="n">wh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="cm">/* Mark descriptor as unused */</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">pkt_phys_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">pkt_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sta</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sta_info</span> <span class="o">=</span> <span class="n">MWL8K_STA</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sta_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="n">rate_info</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tx_desc</span><span class="o">-&gt;</span><span class="n">rate_info</span><span class="p">);</span>
				<span class="cm">/* If rate is &lt; 6.5 Mpbs for an ht station</span>
<span class="cm">				 * do not form an ampdu. If the station is a</span>
<span class="cm">				 * legacy station (format = 0), do not form an</span>
<span class="cm">				 * ampdu</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">RI_RATE_ID_MCS</span><span class="p">(</span><span class="n">rate_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span>
				    <span class="n">RI_FORMAT</span><span class="p">(</span><span class="n">rate_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">is_ampdu_allowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">is_ampdu_allowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ieee80211_tx_info_clear_status</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

		<span class="cm">/* Rate control is happening in the firmware.</span>
<span class="cm">		 * Ensure no tx rate is being reported.</span>
<span class="cm">		 */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">MWL8K_TXD_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>

		<span class="n">ieee80211_tx_status_irqsafe</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">processed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* must be called only when the card&#39;s transmit is completely halted */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_txq_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mwl8k_txq_reclaim</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
			    <span class="n">MWL8K_TX_DESCS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_tx_desc</span><span class="p">),</span>
			    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd_dma</span><span class="p">);</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* caller must hold priv-&gt;stream_lock when calling the stream functions */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span>
<span class="nf">mwl8k_add_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ampdu_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ampdu</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">AMPDU_NO_STREAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stream</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">=</span> <span class="n">sta</span><span class="p">;</span>
			<span class="n">stream</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">AMPDU_STREAM_NEW</span><span class="p">;</span>
			<span class="n">stream</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
			<span class="n">stream</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">stream</span><span class="o">-&gt;</span><span class="n">txq_idx</span> <span class="o">=</span> <span class="n">MWL8K_TX_WMM_QUEUES</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Added a new stream for %pM %d&quot;</span><span class="p">,</span>
				    <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">stream</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_start_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* if the stream has already been started, don&#39;t start it again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">AMPDU_STREAM_NEW</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_start_tx_ba_session</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Failed to start stream for %pM %d: &quot;</span>
			    <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Started stream for %pM %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">stream</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwl8k_remove_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Remove stream for %pM %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
		    <span class="n">stream</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stream</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span>
<span class="nf">mwl8k_lookup_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ampdu_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
		<span class="n">stream</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ampdu</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">AMPDU_NO_STREAM</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">stream</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">==</span> <span class="n">tid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">stream</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MWL8K_AMPDU_PACKET_THRESHOLD 64</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">mwl8k_ampdu_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_sta</span> <span class="o">*</span><span class="n">sta_info</span> <span class="o">=</span> <span class="n">MWL8K_STA</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tx_traffic_info</span> <span class="o">*</span><span class="n">tx_stats</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">MWL8K_MAX_TID</span><span class="p">);</span>
	<span class="n">tx_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">is_ampdu_allowed</span> <span class="o">&amp;&amp;</span>
		<span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">pkts</span> <span class="o">&gt;</span> <span class="n">MWL8K_AMPDU_PACKET_THRESHOLD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">mwl8k_tx_count_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_sta</span> <span class="o">*</span><span class="n">sta_info</span> <span class="o">=</span> <span class="n">MWL8K_STA</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">tx_traffic_info</span> <span class="o">*</span><span class="n">tx_stats</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">MWL8K_MAX_TID</span><span class="p">);</span>
	<span class="n">tx_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* reset the packet count after each second elapses.  If the number of</span>
<span class="cm">	 * packets ever exceeds the ampdu_min_traffic threshold, we will allow</span>
<span class="cm">	 * an ampdu stream to be started.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">&gt;</span> <span class="n">HZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">pkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tx_stats</span><span class="o">-&gt;</span><span class="n">pkts</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwl8k_txq_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">mwl8k_vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">wh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_tx_desc</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txstatus</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">txdatarate</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txpriority</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">start_ba_session</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mgmtframe</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">wh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">qos</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">wh</span><span class="p">)));</span>
	<span class="k">else</span>
		<span class="n">qos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">mgmtframe</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span>
		<span class="n">mwl8k_encapsulate_tx_frame</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mwl8k_add_dma_header</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">wh</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">mwl8k_dma_data</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">wh</span><span class="p">;</span>

	<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">;</span>
	<span class="n">mwl8k_vif</span> <span class="o">=</span> <span class="n">MWL8K_VIF</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_ASSIGN_SEQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wh</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_SCTL_FRAG</span><span class="p">);</span>
		<span class="n">wh</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">);</span>
		<span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">seqno</span> <span class="o">+=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup firmware control bit fields for each frame type.  */</span>
	<span class="n">txstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">txdatarate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ieee80211_is_ctl</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txdatarate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qos</span> <span class="o">|=</span> <span class="n">MWL8K_QOS_QLEN_UNSPEC</span> <span class="o">|</span> <span class="n">MWL8K_QOS_EOSP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txdatarate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">))</span>
			<span class="n">txstatus</span> <span class="o">|=</span> <span class="n">MWL8K_TXD_STATUS_MULTICAST_TX</span><span class="p">;</span>

		<span class="n">qos</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MWL8K_QOS_ACK_POLICY_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span>
			<span class="n">qos</span> <span class="o">|=</span> <span class="n">MWL8K_QOS_ACK_POLICY_BLOCKACK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">qos</span> <span class="o">|=</span> <span class="n">MWL8K_QOS_ACK_POLICY_NORMAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Queue ADDBA request in the respective data queue.  While setting up</span>
<span class="cm">	 * the ampdu stream, mac80211 queues further packets for that</span>
<span class="cm">	 * particular ra/tid pair.  However, packets piled up in the hardware</span>
<span class="cm">	 * for that ra/tid pair will still go out. ADDBA request and the</span>
<span class="cm">	 * related data packets going out from different queues asynchronously</span>
<span class="cm">	 * will cause a shift in the receiver window which might result in</span>
<span class="cm">	 * ampdu packets getting dropped at the receiver after the stream has</span>
<span class="cm">	 * been setup.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_is_action</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">category</span> <span class="o">==</span> <span class="n">WLAN_CATEGORY_BACK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">addba_req</span><span class="p">.</span><span class="n">action_code</span> <span class="o">==</span> <span class="n">WLAN_ACTION_ADDBA_REQ</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">capab</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">action</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">addba_req</span><span class="p">.</span><span class="n">capab</span><span class="p">);</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="p">(</span><span class="n">capab</span> <span class="o">&amp;</span> <span class="n">IEEE80211_ADDBA_PARAM_TID_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">mwl8k_tid_queue_mapping</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">txpriority</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span>
			<span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_PAE</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">wh</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">qos</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">mwl8k_tx_count_packet</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
		<span class="n">stream</span> <span class="o">=</span> <span class="n">mwl8k_lookup_stream</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">AMPDU_STREAM_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">txpriority</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">;</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">txq_idx</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">AMPDU_STREAM_NEW</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* We get here if the driver sends us packets</span>
<span class="cm">				 * after we&#39;ve initiated a stream, but before</span>
<span class="cm">				 * our ampdu_action routine has been called</span>
<span class="cm">				 * with IEEE80211_AMPDU_TX_START to get the SSN</span>
<span class="cm">				 * for the ADDBA request.  So this packet can</span>
<span class="cm">				 * go out with no risk of sequence number</span>
<span class="cm">				 * mismatch.  No special handling is required.</span>
<span class="cm">				 */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Drop packets that would go out after the</span>
<span class="cm">				 * ADDBA request was sent but before the ADDBA</span>
<span class="cm">				 * response is received.  If we don&#39;t do this,</span>
<span class="cm">				 * the recipient would probably receive it</span>
<span class="cm">				 * after the ADDBA request with SSN 0.  This</span>
<span class="cm">				 * will cause the recipient&#39;s BA receive window</span>
<span class="cm">				 * to shift, which would cause the subsequent</span>
<span class="cm">				 * packets in the BA stream to be discarded.</span>
<span class="cm">				 * mac80211 queues our packets for us in this</span>
<span class="cm">				 * case, so this is really just a safety check.</span>
<span class="cm">				 */</span>
				<span class="n">wiphy_warn</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
					   <span class="s">&quot;Cannot send packet while ADDBA &quot;</span>
					   <span class="s">&quot;dialog is underway.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Defer calling mwl8k_start_stream so that the current</span>
<span class="cm">			 * skb can go out before the ADDBA request.  This</span>
<span class="cm">			 * prevents sequence number mismatch at the recepient</span>
<span class="cm">			 * as described above.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_ampdu_allowed</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">stream</span> <span class="o">=</span> <span class="n">mwl8k_add_stream</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">start_ba_session</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			    <span class="s">&quot;failed to dma map skb, dropping TX frame.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start_ba_session</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
			<span class="n">mwl8k_remove_stream</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">txq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* Mgmt frames that go out frequently are probe</span>
<span class="cm">	 * responses. Other mgmt frames got out relatively</span>
<span class="cm">	 * infrequently. Hence reserve 2 buffers so that</span>
<span class="cm">	 * other mgmt frames do not get dropped due to an</span>
<span class="cm">	 * already queued probe response in one of the</span>
<span class="cm">	 * reserved buffers.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">MWL8K_TX_DESCS</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mgmtframe</span> <span class="o">||</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="n">MWL8K_TX_DESCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">start_ba_session</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
				<span class="n">mwl8k_remove_stream</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">tx</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txd</span> <span class="o">+</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">;</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="n">txdatarate</span><span class="p">;</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_priority</span> <span class="o">=</span> <span class="n">txpriority</span><span class="p">;</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">qos_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">qos</span><span class="p">);</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">pkt_phys_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">pkt_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">rate_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span> <span class="o">&amp;&amp;</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">peer_id</span> <span class="o">=</span> <span class="n">MWL8K_STA</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">peer_id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">peer_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span>
						<span class="n">MWL8K_HW_TIMER_REGISTER</span><span class="p">));</span>

	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_TXD_STATUS_FW_OWNED</span> <span class="o">|</span> <span class="n">txstatus</span><span class="p">);</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pending_tx_pkts</span><span class="o">++</span><span class="p">;</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">MWL8K_TX_DESCS</span><span class="p">)</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mwl8k_tx_start</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="cm">/* Initiate the ampdu session here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">start_ba_session</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_start_stream</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stream</span><span class="p">))</span>
			<span class="n">mwl8k_remove_stream</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Firmware access.</span>
<span class="cm"> *</span>
<span class="cm"> * We have the following requirements for issuing firmware commands:</span>
<span class="cm"> * - Some commands require that the packet transmit path is idle when</span>
<span class="cm"> *   the command is issued.  (For simplicity, we&#39;ll just quiesce the</span>
<span class="cm"> *   transmit path for every command.)</span>
<span class="cm"> * - There are certain sequences of commands that need to be issued to</span>
<span class="cm"> *   the hardware sequentially, with no other intervening commands.</span>
<span class="cm"> *</span>
<span class="cm"> * This leads to an implementation of a &quot;firmware lock&quot; as a mutex that</span>
<span class="cm"> * can be taken recursively, and which is taken by both the low-level</span>
<span class="cm"> * command submission function (mwl8k_post_cmd) as well as any users of</span>
<span class="cm"> * that function that require issuing of an atomic sequence of commands,</span>
<span class="cm"> * and quiesces the transmit path whenever it&#39;s taken.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_fw_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex_owner</span> <span class="o">!=</span> <span class="n">current</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex</span><span class="p">);</span>
		<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_tx_wait_empty</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_in_progress</span><span class="p">)</span>
				<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex_owner</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex_depth</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_fw_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_in_progress</span><span class="p">)</span>
			<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Command processing.</span>
<span class="cm"> */</span>

<span class="cm">/* Timeout firmware commands after 10s */</span>
<span class="cp">#define MWL8K_CMD_TIMEOUT_MS	10000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_post_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">cmd_wait</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">__force</span> <span class="n">__le16</span><span class="p">)</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">dma_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">dma_size</span><span class="p">,</span>
				  <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dma_mapping_error</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_fw_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_size</span><span class="p">,</span>
						<span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hostcmd_wait</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd_wait</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_GEN_PTR</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_H2A_INT_DOORBELL</span><span class="p">,</span>
		<span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_H2A_INTERRUPT_EVENTS</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_H2A_INT_DUMMY</span><span class="p">,</span>
		<span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_H2A_INTERRUPT_EVENTS</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_wait</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">MWL8K_CMD_TIMEOUT_MS</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hostcmd_wait</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mwl8k_fw_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">dma_size</span><span class="p">,</span>
					<span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Command %s timeout after %u ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">mwl8k_cmd_name</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)),</span>
			  <span class="n">MWL8K_CMD_TIMEOUT_MS</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ms</span><span class="p">;</span>

		<span class="n">ms</span> <span class="o">=</span> <span class="n">MWL8K_CMD_TIMEOUT_MS</span> <span class="o">-</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Command %s error 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">mwl8k_cmd_name</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)),</span>
				  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">));</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ms</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">)</span>
			<span class="n">wiphy_notice</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Command %s took %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">mwl8k_cmd_name</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span>
						    <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)),</span>
				     <span class="n">ms</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_post_pervif_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">macid</span> <span class="o">=</span> <span class="n">MWL8K_VIF</span><span class="p">(</span><span class="n">vif</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">macid</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup code shared between STA and AP firmware images.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_setup_2ghz_band</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channels_24</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mwl8k_channels_24</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channels_24</span><span class="p">,</span> <span class="n">mwl8k_channels_24</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mwl8k_channels_24</span><span class="p">));</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_24</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mwl8k_rates_24</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_24</span><span class="p">,</span> <span class="n">mwl8k_rates_24</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mwl8k_rates_24</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_24</span><span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_24</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channels_24</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_24</span><span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mwl8k_channels_24</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_24</span><span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_24</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_24</span><span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mwl8k_rates_24</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_24</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_setup_5ghz_band</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channels_50</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mwl8k_channels_50</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channels_50</span><span class="p">,</span> <span class="n">mwl8k_channels_50</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mwl8k_channels_50</span><span class="p">));</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_50</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mwl8k_rates_50</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_50</span><span class="p">,</span> <span class="n">mwl8k_rates_50</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mwl8k_rates_50</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_50</span><span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_50</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channels_50</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_50</span><span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mwl8k_channels_50</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_50</span><span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates_50</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_50</span><span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mwl8k_rates_50</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_50</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_GET_HW_SPEC (STA version).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_get_hw_spec_sta</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">hw_rev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">host_interface</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">num_mcaddrs</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">perm_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">region_code</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">fw_rev</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">ps_cookie</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">caps</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">mcs_bitmap</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">__le32</span> <span class="n">rx_queue_ptr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_tx_queues</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tx_queue_ptrs</span><span class="p">[</span><span class="n">MWL8K_TX_WMM_QUEUES</span><span class="p">];</span>
	<span class="n">__le32</span> <span class="n">caps2</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_tx_desc_per_queue</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">total_rxd</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define MWL8K_CAP_MAX_AMSDU		0x20000000</span>
<span class="cp">#define MWL8K_CAP_GREENFIELD		0x08000000</span>
<span class="cp">#define MWL8K_CAP_AMPDU			0x04000000</span>
<span class="cp">#define MWL8K_CAP_RX_STBC		0x01000000</span>
<span class="cp">#define MWL8K_CAP_TX_STBC		0x00800000</span>
<span class="cp">#define MWL8K_CAP_SHORTGI_40MHZ		0x00400000</span>
<span class="cp">#define MWL8K_CAP_SHORTGI_20MHZ		0x00200000</span>
<span class="cp">#define MWL8K_CAP_RX_ANTENNA_MASK	0x000e0000</span>
<span class="cp">#define MWL8K_CAP_TX_ANTENNA_MASK	0x0001c000</span>
<span class="cp">#define MWL8K_CAP_DELAY_BA		0x00003000</span>
<span class="cp">#define MWL8K_CAP_MIMO			0x00000200</span>
<span class="cp">#define MWL8K_CAP_40MHZ			0x00000100</span>
<span class="cp">#define MWL8K_CAP_BAND_MASK		0x00000007</span>
<span class="cp">#define MWL8K_CAP_5GHZ			0x00000004</span>
<span class="cp">#define MWL8K_CAP_2GHZ4			0x00000001</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwl8k_set_ht_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">band</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rx_streams</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_streams</span><span class="p">;</span>

	<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_MAX_AMSDU</span><span class="p">)</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_MAX_AMSDU</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_GREENFIELD</span><span class="p">)</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_GRN_FLD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_AMPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_HW_AMPDU_AGGREGATION</span><span class="p">;</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MAX_AMPDU_64K</span><span class="p">;</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_density</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MPDU_DENSITY_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_RX_STBC</span><span class="p">)</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_RX_STBC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_TX_STBC</span><span class="p">)</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_TX_STBC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_SHORTGI_40MHZ</span><span class="p">)</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_SHORTGI_20MHZ</span><span class="p">)</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_DELAY_BA</span><span class="p">)</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_DELAY_BA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_40MHZ</span><span class="p">)</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span><span class="p">;</span>

	<span class="n">rx_streams</span> <span class="o">=</span> <span class="n">hweight32</span><span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_RX_ANTENNA_MASK</span><span class="p">);</span>
	<span class="n">tx_streams</span> <span class="o">=</span> <span class="n">hweight32</span><span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_TX_ANTENNA_MASK</span><span class="p">);</span>

	<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_streams</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_streams</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MCS_TX_DEFINED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_streams</span> <span class="o">!=</span> <span class="n">tx_streams</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_MCS_TX_RX_DIFF</span><span class="p">;</span>
		<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tx_streams</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">IEEE80211_HT_MCS_TX_MAX_STREAMS_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwl8k_set_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">caps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_2GHZ4</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_BAND_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mwl8k_setup_2ghz_band</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_MIMO</span><span class="p">)</span>
			<span class="n">mwl8k_set_ht_caps</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_24</span><span class="p">,</span> <span class="n">caps</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mwl8k_setup_5ghz_band</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">caps</span> <span class="o">&amp;</span> <span class="n">MWL8K_CAP_MIMO</span><span class="p">)</span>
			<span class="n">mwl8k_set_ht_caps</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_50</span><span class="p">,</span> <span class="n">caps</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_get_hw_spec_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_get_hw_spec_sta</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_GET_HW_SPEC</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ps_cookie</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cookie_dma</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rx_queue_ptr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rxd_dma</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tx_queue_ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txd_dma</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_tx_desc_per_queue</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_TX_DESCS</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">total_rxd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_RX_DESCS</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_mcaddrs</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_mcaddrs</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_rev</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fw_rev</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hw_rev</span><span class="p">;</span>
		<span class="n">mwl8k_set_caps</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">));</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_macids_supported</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_macids_supported</span> <span class="o">=</span> <span class="mh">0x00000001</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_GET_HW_SPEC (AP version).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_get_hw_spec_ap</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">hw_rev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">host_interface</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">num_wcb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">num_mcaddrs</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">perm_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">region_code</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">num_antenna</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">fw_rev</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">wcbbase0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rxwrptr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rxrdptr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">ps_cookie</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">wcbbase1</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">wcbbase2</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">wcbbase3</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">fw_api_version</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">caps</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_of_ampdu_queues</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">wcbbase_ampdu</span><span class="p">[</span><span class="n">MWL8K_MAX_AMPDU_QUEUES</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_get_hw_spec_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_get_hw_spec_ap</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">api_version</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_GET_HW_SPEC</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ps_cookie</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cookie_dma</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">off</span><span class="p">;</span>

		<span class="n">api_version</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fw_api_version</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="o">-&gt;</span><span class="n">fw_api_ap</span> <span class="o">!=</span> <span class="n">api_version</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unsupported fw API version for %s.&quot;</span>
			       <span class="s">&quot;  Expected %d got %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MWL8K_NAME</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="o">-&gt;</span><span class="n">part_name</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="o">-&gt;</span><span class="n">fw_api_ap</span><span class="p">,</span>
			       <span class="n">api_version</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_mcaddrs</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_mcaddrs</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_rev</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">fw_rev</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hw_rev</span><span class="p">;</span>
		<span class="n">mwl8k_set_caps</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">));</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_macids_supported</span> <span class="o">=</span> <span class="mh">0x000000ff</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_macids_supported</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ampdu_queues</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_of_ampdu_queues</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ampdu_queues</span> <span class="o">&gt;</span> <span class="n">MWL8K_MAX_AMPDU_QUEUES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_warn</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;fw reported %d ampdu queues&quot;</span>
				   <span class="s">&quot; but we only support %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ampdu_queues</span><span class="p">,</span>
				   <span class="n">MWL8K_MAX_AMPDU_QUEUES</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ampdu_queues</span> <span class="o">=</span> <span class="n">MWL8K_MAX_AMPDU_QUEUES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rxwrptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rxd_dma</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>

		<span class="n">off</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rxrdptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rxd_dma</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">off</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wcbbase0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wcbbase1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_offset</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wcbbase2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_offset</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wcbbase3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ampdu_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_offset</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">MWL8K_TX_WMM_QUEUES</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wcbbase_ampdu</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_HW_SPEC.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_hw_spec</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">hw_rev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">host_interface</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">num_mcaddrs</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">perm_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">region_code</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">fw_rev</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">ps_cookie</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">caps</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rx_queue_ptr</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_tx_queues</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tx_queue_ptrs</span><span class="p">[</span><span class="n">MWL8K_MAX_TX_QUEUES</span><span class="p">];</span>
	<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_tx_desc_per_queue</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">total_rxd</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* If enabled, MWL8K_SET_HW_SPEC_FLAG_ENABLE_LIFE_TIME_EXPIRY will cause</span>
<span class="cm"> * packets to expire 500 ms after the timestamp in the tx descriptor.  That is,</span>
<span class="cm"> * the packets that are queued for more than 500ms, will be dropped in the</span>
<span class="cm"> * hardware. This helps minimizing the issues caused due to head-of-line</span>
<span class="cm"> * blocking where a slow client can hog the bandwidth and affect traffic to a</span>
<span class="cm"> * faster client.</span>
<span class="cm"> */</span>
<span class="cp">#define MWL8K_SET_HW_SPEC_FLAG_ENABLE_LIFE_TIME_EXPIRY	0x00000400</span>
<span class="cp">#define MWL8K_SET_HW_SPEC_FLAG_GENERATE_CCMP_HDR	0x00000200</span>
<span class="cp">#define MWL8K_SET_HW_SPEC_FLAG_HOST_DECR_MGMT		0x00000080</span>
<span class="cp">#define MWL8K_SET_HW_SPEC_FLAG_HOSTFORM_PROBERESP	0x00000020</span>
<span class="cp">#define MWL8K_SET_HW_SPEC_FLAG_HOSTFORM_BEACON		0x00000010</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_set_hw_spec</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_hw_spec</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_HW_SPEC</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ps_cookie</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cookie_dma</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rx_queue_ptr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rxd_dma</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mac80211 stack has Q0 as highest priority and Q3 as lowest in</span>
<span class="cm">	 * that order. Firmware has Q3 as highest priority and Q0 as lowest</span>
<span class="cm">	 * in that order. Map Q3 of mac80211 to Q0 of firmware so that the</span>
<span class="cm">	 * priority is interpreted the right way in firmware.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tx_queue_ptrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">txd_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_SET_HW_SPEC_FLAG_HOST_DECR_MGMT</span> <span class="o">|</span>
				 <span class="n">MWL8K_SET_HW_SPEC_FLAG_HOSTFORM_PROBERESP</span> <span class="o">|</span>
				 <span class="n">MWL8K_SET_HW_SPEC_FLAG_HOSTFORM_BEACON</span> <span class="o">|</span>
				 <span class="n">MWL8K_SET_HW_SPEC_FLAG_ENABLE_LIFE_TIME_EXPIRY</span> <span class="o">|</span>
				 <span class="n">MWL8K_SET_HW_SPEC_FLAG_GENERATE_CCMP_HDR</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">num_tx_desc_per_queue</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_TX_DESCS</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">total_rxd</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_RX_DESCS</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_MAC_MULTICAST_ADR.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_mac_multicast_adr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">numaddr</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ETH_ALEN</span><span class="p">];</span>
<span class="p">};</span>

<span class="cp">#define MWL8K_ENABLE_RX_DIRECTED	0x0001</span>
<span class="cp">#define MWL8K_ENABLE_RX_MULTICAST	0x0002</span>
<span class="cp">#define MWL8K_ENABLE_RX_ALL_MULTICAST	0x0004</span>
<span class="cp">#define MWL8K_ENABLE_RX_BROADCAST	0x0008</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="o">*</span>
<span class="nf">__mwl8k_cmd_mac_multicast_adr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">allmulti</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">netdev_hw_addr_list</span> <span class="o">*</span><span class="n">mc_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_mac_multicast_adr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mc_list</span><span class="p">)</span>
		<span class="n">mc_count</span> <span class="o">=</span> <span class="n">netdev_hw_addr_list_count</span><span class="p">(</span><span class="n">mc_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allmulti</span> <span class="o">||</span> <span class="n">mc_count</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_mcaddrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">allmulti</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">mc_count</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_MAC_MULTICAST_ADR</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_ENABLE_RX_DIRECTED</span> <span class="o">|</span>
				  <span class="n">MWL8K_ENABLE_RX_BROADCAST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allmulti</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_ENABLE_RX_ALL_MULTICAST</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_ENABLE_RX_MULTICAST</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">numaddr</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mc_count</span><span class="p">);</span>
		<span class="n">netdev_hw_addr_list_for_each</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mc_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_GET_STAT.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_get_stat</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">stats</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define MWL8K_STAT_ACK_FAILURE	9</span>
<span class="cp">#define MWL8K_STAT_RTS_FAILURE	12</span>
<span class="cp">#define MWL8K_STAT_FCS_ERROR	24</span>
<span class="cp">#define MWL8K_STAT_RTS_SUCCESS	11</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_get_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_low_level_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_get_stat</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_GET_STAT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11ACKFailureCount</span> <span class="o">=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">MWL8K_STAT_ACK_FAILURE</span><span class="p">]);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11RTSFailureCount</span> <span class="o">=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">MWL8K_STAT_RTS_FAILURE</span><span class="p">]);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11FCSErrorCount</span> <span class="o">=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">MWL8K_STAT_FCS_ERROR</span><span class="p">]);</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11RTSSuccessCount</span> <span class="o">=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">MWL8K_STAT_RTS_SUCCESS</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_RADIO_CONTROL.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_radio_control</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">control</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">radio_on</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_cmd_radio_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_radio_control</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_RADIO_CONTROL</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_short_preamble</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">enable</span> <span class="o">?</span> <span class="mh">0x0001</span> <span class="o">:</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_radio_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mwl8k_cmd_radio_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_radio_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mwl8k_cmd_radio_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_set_radio_preamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">short_preamble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_short_preamble</span> <span class="o">=</span> <span class="n">short_preamble</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mwl8k_cmd_radio_control</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_RF_TX_POWER.</span>
<span class="cm"> */</span>
<span class="cp">#define MWL8K_RF_TX_POWER_LEVEL_TOTAL	8</span>

<span class="k">struct</span> <span class="n">mwl8k_cmd_rf_tx_power</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">support_level</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">current_level</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">power_level_list</span><span class="p">[</span><span class="n">MWL8K_RF_TX_POWER_LEVEL_TOTAL</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_rf_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dBm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_rf_tx_power</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_RF_TX_POWER</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">support_level</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dBm</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_TX_POWER.</span>
<span class="cm"> */</span>
<span class="cp">#define MWL8K_TX_POWER_LEVEL_TOTAL      12</span>

<span class="k">struct</span> <span class="n">mwl8k_cmd_tx_power</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">band</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">bw</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">sub_ch</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">power_level_list</span><span class="p">[</span><span class="n">MWL8K_TX_POWER_LEVEL_TOTAL</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pwr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_tx_power</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_TX_POWER</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_LIST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x4</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_NO_HT</span> <span class="o">||</span>
	    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_HT20</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bw</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_HT40MINUS</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sub_ch</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x3</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_HT40PLUS</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sub_ch</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MWL8K_TX_POWER_LEVEL_TOTAL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">power_level_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pwr</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_RF_ANTENNA.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_rf_antenna</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">antenna</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define MWL8K_RF_ANTENNA_RX		1</span>
<span class="cp">#define MWL8K_RF_ANTENNA_TX		2</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_cmd_rf_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">antenna</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_rf_antenna</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_RF_ANTENNA</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">antenna</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">antenna</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_BEACON.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_beacon</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">beacon_len</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">beacon</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_set_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_beacon</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_BEACON</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">beacon_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">,</span> <span class="n">beacon</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_pervif_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_PRE_SCAN.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_pre_scan</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_set_pre_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_pre_scan</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_PRE_SCAN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_POST_SCAN.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_post_scan</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">isibss</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_cmd_set_post_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_post_scan</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_POST_SCAN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">isibss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_RF_CHANNEL.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_rf_channel</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">current_channel</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">channel_flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_set_rf_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_rf_channel</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_RF_CHANNEL</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">current_channel</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000004</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_NO_HT</span> <span class="o">||</span>
	    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_HT20</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000080</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_HT40MINUS</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x000001900</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_HT40PLUS</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x000000900</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_AID.</span>
<span class="cm"> */</span>
<span class="cp">#define MWL8K_FRAME_PROT_DISABLED			0x00</span>
<span class="cp">#define MWL8K_FRAME_PROT_11G				0x07</span>
<span class="cp">#define MWL8K_FRAME_PROT_11N_HT_40MHZ_ONLY		0x02</span>
<span class="cp">#define MWL8K_FRAME_PROT_11N_HT_ALL			0x06</span>

<span class="k">struct</span> <span class="n">mwl8k_cmd_update_set_aid</span> <span class="p">{</span>
	<span class="k">struct</span>	<span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">aid</span><span class="p">;</span>

	 <span class="cm">/* AP&#39;s MAC address (BSSID) */</span>
	<span class="n">__u8</span>	<span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span>	<span class="n">protection_mode</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">supp_rates</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">legacy_rate_mask_to_array</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">rates</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear nonstandard rates 4 and 13.</span>
<span class="cm">	 */</span>
	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="mh">0x1fef</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">rates</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">mwl8k_rates_24</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_cmd_set_aid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u32</span> <span class="n">legacy_rate_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_update_set_aid</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">prot_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_AID</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">aid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_cts_prot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prot_mode</span> <span class="o">=</span> <span class="n">MWL8K_FRAME_PROT_11G</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">ht_operation_mode</span> <span class="o">&amp;</span>
			<span class="n">IEEE80211_HT_OP_MODE_PROTECTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IEEE80211_HT_OP_MODE_PROTECTION_20MHZ</span>:
			<span class="n">prot_mode</span> <span class="o">=</span> <span class="n">MWL8K_FRAME_PROT_11N_HT_40MHZ_ONLY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEEE80211_HT_OP_MODE_PROTECTION_NONHT_MIXED</span>:
			<span class="n">prot_mode</span> <span class="o">=</span> <span class="n">MWL8K_FRAME_PROT_11N_HT_ALL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">prot_mode</span> <span class="o">=</span> <span class="n">MWL8K_FRAME_PROT_DISABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">protection_mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">prot_mode</span><span class="p">);</span>

	<span class="n">legacy_rate_mask_to_array</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">,</span> <span class="n">legacy_rate_mask</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_RATE.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_rate</span> <span class="p">{</span>
	<span class="k">struct</span>	<span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">legacy_rates</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>

	<span class="cm">/* Bitmap for supported MCS codes.  */</span>
	<span class="n">__u8</span>	<span class="n">mcs_set</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">__u8</span>	<span class="n">reserved</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_cmd_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">legacy_rate_mask</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mcs_rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_rate</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_RATE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">legacy_rate_mask_to_array</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">legacy_rates</span><span class="p">,</span> <span class="n">legacy_rate_mask</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mcs_set</span><span class="p">,</span> <span class="n">mcs_rates</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_FINALIZE_JOIN.</span>
<span class="cm"> */</span>
<span class="cp">#define MWL8K_FJ_BEACON_MAXLEN	128</span>

<span class="k">struct</span> <span class="n">mwl8k_cmd_finalize_join</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">sleep_interval</span><span class="p">;</span>	<span class="cm">/* Number of beacon periods to sleep */</span>
	<span class="n">__u8</span> <span class="n">beacon_data</span><span class="p">[</span><span class="n">MWL8K_FJ_BEACON_MAXLEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_finalize_join</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">framelen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dtim</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_finalize_join</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">payload_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_FINALIZE_JOIN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sleep_interval</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dtim</span> <span class="o">?</span> <span class="n">dtim</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">payload_len</span> <span class="o">=</span> <span class="n">framelen</span> <span class="o">-</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">payload</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">payload_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">payload_len</span> <span class="o">&gt;</span> <span class="n">MWL8K_FJ_BEACON_MAXLEN</span><span class="p">)</span>
		<span class="n">payload_len</span> <span class="o">=</span> <span class="n">MWL8K_FJ_BEACON_MAXLEN</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">beacon_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_RTS_THRESHOLD.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_rts_threshold</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">threshold</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_cmd_set_rts_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rts_thresh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_rts_threshold</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_RTS_THRESHOLD</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rts_thresh</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_SLOT.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_slot</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">short_slot</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_set_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">short_slot_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_slot</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_SLOT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">short_slot</span> <span class="o">=</span> <span class="n">short_slot_time</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_EDCA_PARAMS.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_edca_params</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>

	<span class="cm">/* See MWL8K_SET_EDCA_XXX below */</span>
	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>

	<span class="cm">/* TX opportunity in units of 32 us */</span>
	<span class="n">__le16</span> <span class="n">txop</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="cm">/* Log exponent of max contention period: 0...15 */</span>
			<span class="n">__le32</span> <span class="n">log_cw_max</span><span class="p">;</span>

			<span class="cm">/* Log exponent of min contention period: 0...15 */</span>
			<span class="n">__le32</span> <span class="n">log_cw_min</span><span class="p">;</span>

			<span class="cm">/* Adaptive interframe spacing in units of 32us */</span>
			<span class="n">__u8</span> <span class="n">aifs</span><span class="p">;</span>

			<span class="cm">/* TX queue to configure */</span>
			<span class="n">__u8</span> <span class="n">txq</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">ap</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="cm">/* Log exponent of max contention period: 0...15 */</span>
			<span class="n">__u8</span> <span class="n">log_cw_max</span><span class="p">;</span>

			<span class="cm">/* Log exponent of min contention period: 0...15 */</span>
			<span class="n">__u8</span> <span class="n">log_cw_min</span><span class="p">;</span>

			<span class="cm">/* Adaptive interframe spacing in units of 32us */</span>
			<span class="n">__u8</span> <span class="n">aifs</span><span class="p">;</span>

			<span class="cm">/* TX queue to configure */</span>
			<span class="n">__u8</span> <span class="n">txq</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">sta</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define MWL8K_SET_EDCA_CW	0x01</span>
<span class="cp">#define MWL8K_SET_EDCA_TXOP	0x02</span>
<span class="cp">#define MWL8K_SET_EDCA_AIFS	0x04</span>

<span class="cp">#define MWL8K_SET_EDCA_ALL	(MWL8K_SET_EDCA_CW | \</span>
<span class="cp">				 MWL8K_SET_EDCA_TXOP | \</span>
<span class="cp">				 MWL8K_SET_EDCA_AIFS)</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_cmd_set_edca_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">qnum</span><span class="p">,</span>
			  <span class="n">__u16</span> <span class="n">cw_min</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">cw_max</span><span class="p">,</span>
			  <span class="n">__u8</span> <span class="n">aifs</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">txop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_edca_params</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_EDCA_PARAMS</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_SET_EDCA_ALL</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">txop</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">txop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">log_cw_max</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">cw_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">log_cw_min</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ilog2</span><span class="p">(</span><span class="n">cw_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="n">aifs</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">txq</span> <span class="o">=</span> <span class="n">qnum</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">log_cw_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ilog2</span><span class="p">(</span><span class="n">cw_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">log_cw_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ilog2</span><span class="p">(</span><span class="n">cw_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="n">aifs</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">txq</span> <span class="o">=</span> <span class="n">qnum</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_WMM_MODE.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_wmm_mode</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_set_wmm_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_wmm_mode</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_WMM_MODE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">!!</span><span class="n">enable</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_enabled</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_MIMO_CONFIG.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_mimo_config</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">rx_antenna_map</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">tx_antenna_map</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_mimo_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">rx</span><span class="p">,</span> <span class="n">__u8</span> <span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_mimo_config</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_MIMO_CONFIG</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">MWL8K_CMD_SET</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rx_antenna_map</span> <span class="o">=</span> <span class="n">rx</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tx_antenna_map</span> <span class="o">=</span> <span class="n">tx</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_USE_FIXED_RATE (STA version).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_use_fixed_rate_sta</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">allow_rate_drop</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_rates</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">is_ht_rate</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">enable_retry</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">rate</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">retry_count</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">rate_entry</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__le32</span> <span class="n">rate_type</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">reserved1</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">reserved2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define MWL8K_USE_AUTO_RATE	0x0002</span>
<span class="cp">#define MWL8K_UCAST_RATE	0</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_use_fixed_rate_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_use_fixed_rate_sta</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_USE_FIXED_RATE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_USE_AUTO_RATE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">rate_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_UCAST_RATE</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_USE_FIXED_RATE (AP version).</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_use_fixed_rate_ap</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">allow_rate_drop</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_rates</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_rate_entry_ap</span> <span class="p">{</span>
		<span class="n">__le32</span> <span class="n">is_ht_rate</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">enable_retry</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">rate</span><span class="p">;</span>
		<span class="n">__le32</span> <span class="n">retry_count</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">rate_entry</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">multicast_rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">multicast_rate_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">management_rate</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_cmd_use_fixed_rate_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mcast</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mgmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_use_fixed_rate_ap</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_USE_FIXED_RATE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_USE_AUTO_RATE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">multicast_rate</span> <span class="o">=</span> <span class="n">mcast</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">management_rate</span> <span class="o">=</span> <span class="n">mgmt</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_ENABLE_SNIFFER.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_enable_sniffer</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">action</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_enable_sniffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_enable_sniffer</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_ENABLE_SNIFFER</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">!!</span><span class="n">enable</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">mwl8k_cmd_update_mac_addr</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le16</span> <span class="n">mac_type</span><span class="p">;</span>
			<span class="n">__u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
		<span class="p">}</span> <span class="n">mbss</span><span class="p">;</span>
		<span class="n">__u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define MWL8K_MAC_TYPE_PRIMARY_CLIENT		0</span>
<span class="cp">#define MWL8K_MAC_TYPE_SECONDARY_CLIENT		1</span>
<span class="cp">#define MWL8K_MAC_TYPE_PRIMARY_AP		2</span>
<span class="cp">#define MWL8K_MAC_TYPE_SECONDARY_AP		3</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_update_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">mwl8k_vif</span> <span class="o">=</span> <span class="n">MWL8K_VIF</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_update_mac_addr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mac_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">mac_type</span> <span class="o">=</span> <span class="n">MWL8K_MAC_TYPE_PRIMARY_AP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">macid</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">ffs</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_macids_supported</span><span class="p">))</span>
			<span class="n">mac_type</span> <span class="o">=</span> <span class="n">MWL8K_MAC_TYPE_PRIMARY_CLIENT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mac_type</span> <span class="o">=</span> <span class="n">MWL8K_MAC_TYPE_SECONDARY_CLIENT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vif</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">macid</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">ffs</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_macids_supported</span><span class="p">))</span>
			<span class="n">mac_type</span> <span class="o">=</span> <span class="n">MWL8K_MAC_TYPE_PRIMARY_AP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mac_type</span> <span class="o">=</span> <span class="n">MWL8K_MAC_TYPE_SECONDARY_AP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_MAC_ADDR</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_DEL_MAC_ADDR</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mbss</span><span class="p">.</span><span class="n">mac_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mac_type</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mbss</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_pervif_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MWL8K_CMD_SET_MAC_ADDR.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_set_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mwl8k_cmd_update_mac_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MWL8K_CMD_DEL_MAC_ADDR.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_del_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mwl8k_cmd_update_mac_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_RATEADAPT_MODE.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_rate_adapt_mode</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_set_rateadapt_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">__u16</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_rate_adapt_mode</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_RATEADAPT_MODE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_GET_WATCHDOG_BITMAP.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_get_watchdog_bitmap</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">bitmap</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_get_watchdog_bitmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_get_watchdog_bitmap</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_GET_WATCHDOG_BITMAP</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="o">*</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define INVALID_BA	0xAA</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_watchdog_ba_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bitmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stream_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span><span class="n">streams</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mwl8k_priv</span><span class="p">,</span> <span class="n">watchdog_ba_handle</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_get_watchdog_bitmap</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitmap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span> <span class="o">==</span> <span class="n">INVALID_BA</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* the bitmap is the hw queue number.  Map it to the ampdu queue. */</span>
	<span class="n">stream_index</span> <span class="o">=</span> <span class="n">bitmap</span> <span class="o">-</span> <span class="n">MWL8K_TX_WMM_QUEUES</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">stream_index</span> <span class="o">&gt;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ampdu_queues</span><span class="p">);</span>

	<span class="n">streams</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ampdu</span><span class="p">[</span><span class="n">stream_index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">streams</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">AMPDU_STREAM_ACTIVE</span><span class="p">)</span>
		<span class="n">ieee80211_stop_tx_ba_session</span><span class="p">(</span><span class="n">streams</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">,</span> <span class="n">streams</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * CMD_BSS_START.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_bss_start</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">enable</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_bss_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_bss_start</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_BSS_START</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_pervif_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_BASTREAM.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * UPSTREAM is tx direction</span>
<span class="cm"> */</span>
<span class="cp">#define BASTREAM_FLAG_DIRECTION_UPSTREAM	0x00</span>
<span class="cp">#define BASTREAM_FLAG_IMMEDIATE_TYPE		0x01</span>

<span class="k">enum</span> <span class="n">ba_stream_action_type</span> <span class="p">{</span>
	<span class="n">MWL8K_BA_CREATE</span><span class="p">,</span>
	<span class="n">MWL8K_BA_UPDATE</span><span class="p">,</span>
	<span class="n">MWL8K_BA_DESTROY</span><span class="p">,</span>
	<span class="n">MWL8K_BA_FLUSH</span><span class="p">,</span>
	<span class="n">MWL8K_BA_CHECK</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">mwl8k_create_ba_stream</span> <span class="p">{</span>
	<span class="n">__le32</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">idle_thrs</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">bar_thrs</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">window_size</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">peer_mac_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span>	<span class="n">dialog_token</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">tid</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">queue_id</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">param_info</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">ba_context</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">reset_seq_no_flag</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">curr_seq_no</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">sta_src_mac_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">mwl8k_destroy_ba_stream</span> <span class="p">{</span>
	<span class="n">__le32</span>	<span class="n">flags</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">ba_context</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">mwl8k_cmd_bastream</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span>	<span class="n">header</span><span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">action</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mwl8k_create_ba_stream</span>	<span class="n">create_params</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mwl8k_destroy_ba_stream</span>	<span class="n">destroy_params</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_check_ba</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_bastream</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_BASTREAM</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_BA_CHECK</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">queue_id</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">peer_mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
	       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BASTREAM_FLAG_IMMEDIATE_TYPE</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BASTREAM_FLAG_DIRECTION_UPSTREAM</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_create_ba</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_bastream</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>


	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_BASTREAM</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_BA_CREATE</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">bar_thrs</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">queue_id</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">peer_mac_addr</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">tid</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">curr_seq_no</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">reset_seq_no_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">param_info</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span> <span class="o">&amp;</span>
		 <span class="n">IEEE80211_HT_AMPDU_PARM_FACTOR</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_density</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span>
		 <span class="n">IEEE80211_HT_AMPDU_PARM_DENSITY</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">create_params</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BASTREAM_FLAG_IMMEDIATE_TYPE</span> <span class="o">|</span>
					<span class="n">BASTREAM_FLAG_DIRECTION_UPSTREAM</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>

	<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Created a BA stream for %pM : tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_destroy_ba</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_bastream</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_BASTREAM</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_BA_DESTROY</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">destroy_params</span><span class="p">.</span><span class="n">ba_context</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>
	<span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>

	<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Deleted BA stream index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_SET_NEW_STN.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">mwl8k_cmd_set_new_stn</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">aid</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">stn_id</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">rsvd</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">legacy_rates</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">ht_rates</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">cap_info</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">ht_capabilities_info</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">mac_ht_param_info</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">rev</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">control_channel</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">add_channel</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">op_mode</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">stbc</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">add_qos_info</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">is_qos_sta</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">fw_sta_ptr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define MWL8K_STA_ACTION_ADD		0</span>
<span class="cp">#define MWL8K_STA_ACTION_REMOVE		2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_set_new_stn_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_new_stn</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rates</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_NEW_STN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stn_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_STA_ACTION_ADD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="n">rates</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">rates</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">legacy_rates</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rates</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht_rates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht_rates</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ht_capabilities_info</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mac_ht_param_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_density</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">is_qos_sta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_pervif_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_set_new_stn_add_self</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_new_stn</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_NEW_STN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_pervif_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_set_new_stn_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_new_stn</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_SET_NEW_STN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_STA_ACTION_REMOVE</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_pervif_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_UPDATE_ENCRYPTION.</span>
<span class="cm"> */</span>

<span class="cp">#define MAX_ENCR_KEY_LENGTH	16</span>
<span class="cp">#define MIC_KEY_LENGTH		8</span>

<span class="k">struct</span> <span class="n">mwl8k_cmd_update_encryption</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>

	<span class="n">__le32</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">encr_type</span><span class="p">;</span>

<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">mwl8k_cmd_set_key</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>

	<span class="n">__le32</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">key_type_id</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">key_info</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">key_id</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">key_len</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">key_material</span><span class="p">[</span><span class="n">MAX_ENCR_KEY_LENGTH</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">tkip_tx_mic_key</span><span class="p">[</span><span class="n">MIC_KEY_LENGTH</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">tkip_rx_mic_key</span><span class="p">[</span><span class="n">MIC_KEY_LENGTH</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">tkip_rsc_low</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tkip_rsc_high</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">tkip_tsc_low</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tkip_tsc_high</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">mac_addr</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MWL8K_ENCR_ENABLE</span><span class="p">,</span>
	<span class="n">MWL8K_ENCR_SET_KEY</span><span class="p">,</span>
	<span class="n">MWL8K_ENCR_REMOVE_KEY</span><span class="p">,</span>
	<span class="n">MWL8K_ENCR_SET_GROUP_KEY</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define MWL8K_UPDATE_ENCRYPTION_TYPE_WEP	0</span>
<span class="cp">#define MWL8K_UPDATE_ENCRYPTION_TYPE_DISABLE	1</span>
<span class="cp">#define MWL8K_UPDATE_ENCRYPTION_TYPE_TKIP	4</span>
<span class="cp">#define MWL8K_UPDATE_ENCRYPTION_TYPE_MIXED	7</span>
<span class="cp">#define MWL8K_UPDATE_ENCRYPTION_TYPE_AES	8</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MWL8K_ALG_WEP</span><span class="p">,</span>
	<span class="n">MWL8K_ALG_TKIP</span><span class="p">,</span>
	<span class="n">MWL8K_ALG_CCMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define MWL8K_KEY_FLAG_TXGROUPKEY	0x00000004</span>
<span class="cp">#define MWL8K_KEY_FLAG_PAIRWISE		0x00000008</span>
<span class="cp">#define MWL8K_KEY_FLAG_TSC_VALID	0x00000040</span>
<span class="cp">#define MWL8K_KEY_FLAG_WEP_TXKEY	0x01000000</span>
<span class="cp">#define MWL8K_KEY_FLAG_MICKEY_VALID	0x02000000</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_update_encryption_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
					      <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
					      <span class="n">u8</span> <span class="n">encr_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_update_encryption</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_UPDATE_ENCRYPTION</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_ENCR_ENABLE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">encr_type</span> <span class="o">=</span> <span class="n">encr_type</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_pervif_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_encryption_set_cmd_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_cmd_set_key</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
						<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_UPDATE_ENCRYPTION</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_cmd_set_key</span><span class="p">,</span> <span class="n">length</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_type_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_ALG_WEP</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_info</span> <span class="o">=</span>	<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_KEY_FLAG_WEP_TXKEY</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_type_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_ALG_TKIP</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_info</span> <span class="o">=</span>	<span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_KEY_FLAG_PAIRWISE</span><span class="p">)</span>
			<span class="o">:</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_KEY_FLAG_TXGROUPKEY</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_info</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_KEY_FLAG_MICKEY_VALID</span>
						<span class="o">|</span> <span class="n">MWL8K_KEY_FLAG_TSC_VALID</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_type_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_ALG_CCMP</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_info</span> <span class="o">=</span>	<span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_KEY_FLAG_PAIRWISE</span><span class="p">)</span>
			<span class="o">:</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_KEY_FLAG_TXGROUPKEY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_encryption_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
						<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_key</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keymlen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">action</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">mwl8k_vif</span> <span class="o">=</span> <span class="n">MWL8K_VIF</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_encryption_set_cmd_info</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">)</span>
		<span class="n">action</span> <span class="o">=</span> <span class="n">MWL8K_ENCR_SET_KEY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">action</span> <span class="o">=</span> <span class="n">MWL8K_ENCR_SET_GROUP_KEY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">wep_key_conf</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">wep_key_conf</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
			<span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">wep_key_conf</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">keymlen</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">;</span>
		<span class="n">action</span> <span class="o">=</span> <span class="n">MWL8K_ENCR_SET_KEY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">keymlen</span> <span class="o">=</span> <span class="n">MAX_ENCR_KEY_LENGTH</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">MIC_KEY_LENGTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">keymlen</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_material</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keymlen</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_pervif_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_encryption_remove_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
						<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_set_key</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">mwl8k_vif</span> <span class="o">=</span> <span class="n">MWL8K_VIF</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_encryption_set_cmd_info</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span> <span class="o">||</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">)</span>
		<span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">wep_key_conf</span><span class="p">[</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">].</span><span class="n">enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_ENCR_REMOVE_KEY</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_pervif_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd_param</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">encr_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">mwl8k_vif</span> <span class="o">=</span> <span class="n">MWL8K_VIF</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_param</span> <span class="o">==</span> <span class="n">SET_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_encryption_set_key</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">)</span>
				<span class="o">||</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">))</span>
			<span class="n">encr_type</span> <span class="o">=</span> <span class="n">MWL8K_UPDATE_ENCRYPTION_TYPE_WEP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">encr_type</span> <span class="o">=</span> <span class="n">MWL8K_UPDATE_ENCRYPTION_TYPE_MIXED</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_update_encryption_enable</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
								<span class="n">encr_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">is_hw_crypto_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_encryption_remove_key</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * CMD_UPDATE_STADB.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ewc_ht_info</span> <span class="p">{</span>
	<span class="n">__le16</span>	<span class="n">control1</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">control2</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">control3</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">peer_capability_info</span> <span class="p">{</span>
	<span class="cm">/* Peer type - AP vs. STA.  */</span>
	<span class="n">__u8</span>	<span class="n">peer_type</span><span class="p">;</span>

	<span class="cm">/* Basic 802.11 capabilities from assoc resp.  */</span>
	<span class="n">__le16</span>	<span class="n">basic_caps</span><span class="p">;</span>

	<span class="cm">/* Set if peer supports 802.11n high throughput (HT).  */</span>
	<span class="n">__u8</span>	<span class="n">ht_support</span><span class="p">;</span>

	<span class="cm">/* Valid if HT is supported.  */</span>
	<span class="n">__le16</span>	<span class="n">ht_caps</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">extended_ht_caps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ewc_ht_info</span>	<span class="n">ewc_info</span><span class="p">;</span>

	<span class="cm">/* Legacy rate table. Intersection of our rates and peer rates.  */</span>
	<span class="n">__u8</span>	<span class="n">legacy_rates</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

	<span class="cm">/* HT rate table. Intersection of our rates and peer rates.  */</span>
	<span class="n">__u8</span>	<span class="n">ht_rates</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">__u8</span>	<span class="n">pad</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="cm">/* If set, interoperability mode, no proprietary extensions.  */</span>
	<span class="n">__u8</span>	<span class="n">interop</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">pad2</span><span class="p">;</span>
	<span class="n">__u8</span>	<span class="n">station_id</span><span class="p">;</span>
	<span class="n">__le16</span>	<span class="n">amsdu_enabled</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">mwl8k_cmd_update_stadb</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="n">header</span><span class="p">;</span>

	<span class="cm">/* See STADB_ACTION_TYPE */</span>
	<span class="n">__le32</span>	<span class="n">action</span><span class="p">;</span>

	<span class="cm">/* Peer MAC address */</span>
	<span class="n">__u8</span>	<span class="n">peer_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">__le32</span>	<span class="n">reserved</span><span class="p">;</span>

	<span class="cm">/* Peer info - valid during add/update.  */</span>
	<span class="k">struct</span> <span class="n">peer_capability_info</span>	<span class="n">peer_info</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define MWL8K_STA_DB_MODIFY_ENTRY	1</span>
<span class="cp">#define MWL8K_STA_DB_DEL_ENTRY		2</span>

<span class="cm">/* Peer Entry flags - used to define the type of the peer node */</span>
<span class="cp">#define MWL8K_PEER_TYPE_ACCESSPOINT	2</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_update_stadb_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_update_stadb</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">peer_capability_info</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rates</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_UPDATE_STADB</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_STA_DB_MODIFY_ENTRY</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">peer_info</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">peer_type</span> <span class="o">=</span> <span class="n">MWL8K_PEER_TYPE_ACCESSPOINT</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">basic_caps</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">assoc_capability</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ht_support</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ht_caps</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">extended_ht_caps</span> <span class="o">=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_density</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="n">rates</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">rates</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">legacy_rate_mask_to_array</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">legacy_rates</span><span class="p">,</span> <span class="n">rates</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ht_rates</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">interop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">amsdu_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">station_id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_cmd_update_stadb_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_update_stadb</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MWL8K_CMD_UPDATE_STADB</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWL8K_STA_DB_DEL_ENTRY</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">peer_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Interrupt handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">mwl8k_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MWL8K_A2H_INT_TX_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MWL8K_A2H_INT_TX_DONE</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_tx_task</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MWL8K_A2H_INT_RX_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MWL8K_A2H_INT_RX_READY</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_rx_task</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MWL8K_A2H_INT_BA_WATCHDOG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MWL8K_A2H_INT_BA_WATCHDOG</span><span class="p">;</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watchdog_ba_handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="o">~</span><span class="n">status</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MWL8K_A2H_INT_OPC_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hostcmd_wait</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">complete</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hostcmd_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MWL8K_A2H_INT_QUEUE_EMPTY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pending_tx_pkts</span><span class="p">)</span>
			<span class="n">mwl8k_tx_start</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_tx_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">limit</span> <span class="o">-=</span> <span class="n">mwl8k_txq_reclaim</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pending_tx_pkts</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wait</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wait</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wait</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="n">MWL8K_A2H_INT_TX_DONE</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_tx_task</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_rx_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">limit</span><span class="p">;</span>

	<span class="n">limit</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">limit</span> <span class="o">-=</span> <span class="n">rxq_process</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
	<span class="n">limit</span> <span class="o">-=</span> <span class="n">rxq_refill</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">~</span><span class="n">MWL8K_A2H_INT_RX_READY</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_STATUS</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_rx_task</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Core driver operations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			    <span class="s">&quot;dropped TX frame since radio disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mwl8k_txq_xmit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mwl8k_interrupt</span><span class="p">,</span>
			 <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">MWL8K_NAME</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;failed to register IRQ handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* Enable TX reclaim and RX tasklets.  */</span>
	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_tx_task</span><span class="p">);</span>
	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_rx_task</span><span class="p">);</span>

	<span class="cm">/* Enable interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_A2H_EVENTS</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_MASK</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_A2H_EVENTS</span><span class="p">,</span>
		  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_STATUS_MASK</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_fw_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_radio_enable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_enable_sniffer</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_pre_scan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_post_scan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="s">&quot;</span><span class="se">\x00\x00\x00\x00\x00\x00</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_rateadapt_mode</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_wmm_mode</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">mwl8k_fw_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_MASK</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_tx_task</span><span class="p">);</span>
		<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_rx_task</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_in_progress</span><span class="p">)</span>
		<span class="n">mwl8k_cmd_radio_disable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Stop finalize join worker */</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">finalize_join_worker</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watchdog_ba_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">);</span>

	<span class="cm">/* Stop TX reclaim and RX tasklets.  */</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_tx_task</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_rx_task</span><span class="p">);</span>

	<span class="cm">/* Return all skbs to mac80211 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mwl8k_txq_reclaim</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mwl8k_reload_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_image</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">mwl8k_vif</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macids_supported</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">macid</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_device_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reject interface creation if sniffer mode is active, as</span>
<span class="cm">	 * STA operation is mutually exclusive with hardware sniffer</span>
<span class="cm">	 * mode.  (Sniffer mode is only used on STA firmware.)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sniffer_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_info</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			   <span class="s">&quot;unable to create STA interface because sniffer mode is enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">di</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_ap</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we must load the ap fw to meet this request */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_reload_firmware</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_ap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">macids_supported</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_macids_supported</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we must load the sta fw to meet this request */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_reload_firmware</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_sta</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">macids_supported</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_macids_supported</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">macid</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">macids_supported</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">macids_used</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">macid</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Setup driver private area. */</span>
	<span class="n">mwl8k_vif</span> <span class="o">=</span> <span class="n">MWL8K_VIF</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mwl8k_vif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mwl8k_vif</span><span class="p">));</span>
	<span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>
	<span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">macid</span> <span class="o">=</span> <span class="n">macid</span><span class="p">;</span>
	<span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">seqno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">is_hw_crypto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Set the mac address.  */</span>
	<span class="n">mwl8k_cmd_set_mac_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span>
		<span class="n">mwl8k_cmd_set_new_stn_add_self</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">macids_used</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">macid</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_remove_vif</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Has ieee80211_restart_hw re-added the removed interfaces? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">macids_used</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">macids_used</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">macid</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">mwl8k_vif</span> <span class="o">=</span> <span class="n">MWL8K_VIF</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span>
		<span class="n">mwl8k_cmd_set_new_stn_del</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">mwl8k_cmd_del_mac_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">mwl8k_remove_vif</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mwl8k_vif</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_hw_restart_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mwl8k_priv</span><span class="p">,</span> <span class="n">fw_reload</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_device_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* If some command is waiting for a response, clear it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hostcmd_wait</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hostcmd_wait</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hostcmd_wait</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_owner</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="p">;</span>
	<span class="n">mwl8k_fw_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_reload_firmware</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_ap</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_reload_firmware</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_sta</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This unlock will wake up the queues and</span>
<span class="cm">	 * also opens the command path for other</span>
<span class="cm">	 * commands</span>
<span class="cm">	 */</span>
	<span class="n">mwl8k_fw_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">ieee80211_restart_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Firmware restarted successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">mwl8k_fw_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Firmware restart failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mwl8k_cmd_radio_disable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_fw_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_radio_enable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_rf_channel</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">&gt;</span> <span class="mi">18</span><span class="p">)</span>
		<span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_POWER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_tx_power</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_rf_antenna</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MWL8K_RF_ANTENNA_RX</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">wiphy_warn</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;failed to set # of RX antennas&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_rf_antenna</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">MWL8K_RF_ANTENNA_TX</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">wiphy_warn</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;failed to set # of TX antennas&quot;</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_rf_tx_power</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_mimo_config</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mwl8k_fw_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwl8k_bss_info_changed_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ap_legacy_rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ap_mcs_rates</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_fw_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No need to capture a beacon if we&#39;re no longer associated.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">assoc</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capture_beacon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the AP&#39;s legacy and MCS rates.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>

		<span class="n">rcu_read_lock</span><span class="p">();</span>

		<span class="n">ap</span> <span class="o">=</span> <span class="n">ieee80211_find_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap_legacy_rates</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ap_legacy_rates</span> <span class="o">=</span>
				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ap_mcs_rates</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_rate</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">ap_legacy_rates</span><span class="p">,</span> <span class="n">ap_mcs_rates</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_use_fixed_rate_sta</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_PREAMBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_set_radio_preamble</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
				<span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_slot</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_slot</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">assoc</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BSS_CHANGED_ASSOC</span> <span class="o">|</span> <span class="n">BSS_CHANGED_ERP_CTS_PROT</span> <span class="o">|</span>
			<span class="n">BSS_CHANGED_HT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_aid</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">ap_legacy_rates</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">assoc</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BSS_CHANGED_ASSOC</span> <span class="o">|</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Finalize the join.  Tell rx handler to process</span>
<span class="cm">		 * next beacon from our BSSID.</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">capture_bssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capture_beacon</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mwl8k_fw_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwl8k_bss_info_changed_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_fw_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_PREAMBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_set_radio_preamble</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
				<span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BASIC_RATES</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Use lowest supported basic rate for multicasts</span>
<span class="cm">		 * and management frames (such as probe responses --</span>
<span class="cm">		 * beacons will always go out at 1 Mb/s).</span>
<span class="cm">		 */</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">basic_rates</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span>
			<span class="n">idx</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">mwl8k_rates_24</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">hw_value</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">mwl8k_rates_50</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">hw_value</span><span class="p">;</span>

		<span class="n">mwl8k_cmd_use_fixed_rate_ap</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BSS_CHANGED_BEACON_INT</span> <span class="o">|</span> <span class="n">BSS_CHANGED_BEACON</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mwl8k_cmd_set_beacon</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">)</span>
		<span class="n">mwl8k_cmd_bss_start</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mwl8k_fw_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwl8k_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span>
		<span class="n">mwl8k_bss_info_changed_sta</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mwl8k_bss_info_changed_ap</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">changed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">mwl8k_prepare_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">netdev_hw_addr_list</span> <span class="o">*</span><span class="n">mc_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Synthesize and return a command packet that programs the</span>
<span class="cm">	 * hardware multicast address filter.  At this point we don&#39;t</span>
<span class="cm">	 * know whether FIF_ALLMULTI is being requested, but if it is,</span>
<span class="cm">	 * we&#39;ll end up throwing this packet away and creating a new</span>
<span class="cm">	 * one in mwl8k_configure_filter().</span>
<span class="cm">	 */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">__mwl8k_cmd_mac_multicast_adr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mc_list</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_configure_filter_sniffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hardware sniffer mode is mutually exclusive with STA</span>
<span class="cm">	 * operation, so refuse to enable sniffer mode if a STA</span>
<span class="cm">	 * interface is active.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">wiphy_info</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				   <span class="s">&quot;not enabling sniffer mode because STA interface is active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sniffer_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_cmd_enable_sniffer</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sniffer_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;=</span>	<span class="n">FIF_PROMISC_IN_BSS</span> <span class="o">|</span> <span class="n">FIF_ALLMULTI</span> <span class="o">|</span>
			<span class="n">FIF_BCN_PRBRESP_PROMISC</span> <span class="o">|</span> <span class="n">FIF_CONTROL</span> <span class="o">|</span>
			<span class="n">FIF_OTHER_BSS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="nf">mwl8k_first_vif</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mwl8k_vif</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_cmd_pkt</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">multicast</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * AP firmware doesn&#39;t allow fine-grained control over</span>
<span class="cm">	 * the receive filter.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;=</span> <span class="n">FIF_ALLMULTI</span> <span class="o">|</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable hardware sniffer mode if FIF_CONTROL or</span>
<span class="cm">	 * FIF_OTHER_BSS is requested.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIF_CONTROL</span> <span class="o">|</span> <span class="n">FIF_OTHER_BSS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mwl8k_configure_filter_sniffer</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">changed_flags</span><span class="p">,</span> <span class="n">total_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear unsupported feature flags */</span>
	<span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;=</span> <span class="n">FIF_ALLMULTI</span> <span class="o">|</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_fw_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sniffer_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mwl8k_cmd_enable_sniffer</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sniffer_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Disable the BSS filter.</span>
<span class="cm">			 */</span>
			<span class="n">mwl8k_cmd_set_pre_scan</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">mwl8k_vif</span><span class="p">;</span>
			<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Enable the BSS filter.</span>
<span class="cm">			 *</span>
<span class="cm">			 * If there is an active STA interface, use that</span>
<span class="cm">			 * interface&#39;s BSSID, otherwise use a dummy one</span>
<span class="cm">			 * (where the OUI part needs to be nonzero for</span>
<span class="cm">			 * the BSSID to be accepted by POST_SCAN).</span>
<span class="cm">			 */</span>
			<span class="n">mwl8k_vif</span> <span class="o">=</span> <span class="n">mwl8k_first_vif</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_vif</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">bssid</span> <span class="o">=</span> <span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">bssid</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x01\x00\x00\x00\x00\x00</span><span class="s">&quot;</span><span class="p">;</span>

			<span class="n">mwl8k_cmd_set_post_scan</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If FIF_ALLMULTI is being requested, throw away the command</span>
<span class="cm">	 * packet that -&gt;prepare_multicast() built and replace it with</span>
<span class="cm">	 * a command packet that enables reception of all multicast</span>
<span class="cm">	 * packets.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;</span> <span class="n">FIF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">__mwl8k_cmd_mac_multicast_adr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mwl8k_post_cmd</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mwl8k_fw_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_set_rts_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mwl8k_cmd_set_rts_threshold</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_sta_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mwl8k_cmd_set_new_stn_del</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">mwl8k_cmd_update_stadb_del</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_sta_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">mwl8k_vif</span> <span class="o">=</span> <span class="n">MWL8K_VIF</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwl8k_cmd_update_stadb_add</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">MWL8K_STA</span><span class="p">(</span><span class="n">sta</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">peer_id</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
				<span class="n">MWL8K_STA</span><span class="p">(</span><span class="n">sta</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">is_ampdu_allowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_new_stn_add</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_WEP_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">IEEE80211_KEY_CONF</span><span class="p">(</span><span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">wep_key_conf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mwl8k_vif</span><span class="o">-&gt;</span><span class="n">wep_key_conf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">enabled</span><span class="p">)</span>
			<span class="n">mwl8k_set_key</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">SET_KEY</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">queue</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_fw_lock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">queue</span> <span class="o">&gt;</span> <span class="n">MWL8K_TX_WMM_QUEUES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_params</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span> <span class="n">params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_enabled</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_wmm_mode</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">q</span> <span class="o">=</span> <span class="n">MWL8K_TX_WMM_QUEUES</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">queue</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_edca_params</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span>
						       <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">,</span>
						       <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">,</span>
						       <span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">,</span>
						       <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mwl8k_fw_unlock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ieee80211_low_level_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mwl8k_cmd_get_stat</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stats</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_get_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="n">SURVEY_INFO_NOISE_DBM</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAX_AMPDU_ATTEMPTS 5</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwl8k_ampdu_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		   <span class="k">enum</span> <span class="n">ieee80211_ampdu_mlme_action</span> <span class="n">action</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ssn</span><span class="p">,</span>
		   <span class="n">u8</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_ampdu_stream</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HW_AMPDU_AGGREGATION</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
	<span class="n">stream</span> <span class="o">=</span> <span class="n">mwl8k_lookup_stream</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_START</span>:
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_STOP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_START</span>:
		<span class="cm">/* By the time we get here the hw queues may contain outgoing</span>
<span class="cm">		 * packets for this RA/TID that are not part of this BA</span>
<span class="cm">		 * session.  The hw will assign sequence numbers to these</span>
<span class="cm">		 * packets as they go out.  So if we query the hw for its next</span>
<span class="cm">		 * sequence number and use that for the SSN here, it may end up</span>
<span class="cm">		 * being wrong, which will lead to sequence number mismatch at</span>
<span class="cm">		 * the recipient.  To avoid this, we reset the sequence number</span>
<span class="cm">		 * to O for the first MPDU in this BA stream.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">ssn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This means that somebody outside this driver called</span>
<span class="cm">			 * ieee80211_start_tx_ba_session.  This is unexpected</span>
<span class="cm">			 * because we do our own rate control.  Just warn and</span>
<span class="cm">			 * move on.</span>
<span class="cm">			 */</span>
			<span class="n">wiphy_warn</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Unexpected call to %s.  &quot;</span>
				   <span class="s">&quot;Proceeding anyway.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">stream</span> <span class="o">=</span> <span class="n">mwl8k_add_stream</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;no free AMPDU streams</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">AMPDU_STREAM_IN_PROGRESS</span><span class="p">;</span>

		<span class="cm">/* Release the lock before we do the time consuming stuff */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_AMPDU_ATTEMPTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_check_ba</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

			<span class="cm">/* If HW restart is in progress mwl8k_post_cmd will</span>
<span class="cm">			 * return -EBUSY. Avoid retrying mwl8k_check_ba in</span>
<span class="cm">			 * such cases</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * HW queues take time to be flushed, give them</span>
<span class="cm">			 * sufficient time</span>
<span class="cm">			 */</span>

			<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Stream for tid %d busy after %d&quot;</span>
				<span class="s">&quot; attempts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">MAX_AMPDU_ATTEMPTS</span><span class="p">);</span>
			<span class="n">mwl8k_remove_stream</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ieee80211_start_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_STOP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">AMPDU_STREAM_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
				<span class="n">mwl8k_destroy_ba</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mwl8k_remove_stream</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ieee80211_stop_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_OPERATIONAL</span>:
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">AMPDU_STREAM_IN_PROGRESS</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_create_ba</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">stream</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">AMPDU_STREAM_ACTIVE</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
			<span class="n">mwl8k_destroy_ba</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
			<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				<span class="s">&quot;Failed adding stream for sta %pM tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
			<span class="n">mwl8k_remove_stream</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">mwl8k_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span>			<span class="o">=</span> <span class="n">mwl8k_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>			<span class="o">=</span> <span class="n">mwl8k_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>			<span class="o">=</span> <span class="n">mwl8k_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span>		<span class="o">=</span> <span class="n">mwl8k_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span>	<span class="o">=</span> <span class="n">mwl8k_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span>			<span class="o">=</span> <span class="n">mwl8k_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span>	<span class="o">=</span> <span class="n">mwl8k_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_multicast</span>	<span class="o">=</span> <span class="n">mwl8k_prepare_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span>	<span class="o">=</span> <span class="n">mwl8k_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_key</span>                <span class="o">=</span> <span class="n">mwl8k_set_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rts_threshold</span>	<span class="o">=</span> <span class="n">mwl8k_set_rts_threshold</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_add</span>		<span class="o">=</span> <span class="n">mwl8k_sta_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_remove</span>		<span class="o">=</span> <span class="n">mwl8k_sta_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conf_tx</span>		<span class="o">=</span> <span class="n">mwl8k_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span>		<span class="o">=</span> <span class="n">mwl8k_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_survey</span>		<span class="o">=</span> <span class="n">mwl8k_get_survey</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ampdu_action</span>		<span class="o">=</span> <span class="n">mwl8k_ampdu_action</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_finalize_join_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mwl8k_priv</span><span class="p">,</span> <span class="n">finalize_join_worker</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tim</span> <span class="o">=</span> <span class="n">cfg80211_find_ie</span><span class="p">(</span><span class="n">WLAN_EID_TIM</span><span class="p">,</span>
					 <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dtim_period</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tim</span> <span class="o">&amp;&amp;</span> <span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dtim_period</span> <span class="o">=</span> <span class="n">tim</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="n">mwl8k_cmd_finalize_join</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">dtim_period</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MWL8363</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">MWL8687</span><span class="p">,</span>
	<span class="n">MWL8366</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define MWL8K_8366_AP_FW_API 2</span>
<span class="cp">#define _MWL8K_8366_AP_FW(api) &quot;mwl8k/fmimage_8366_ap-&quot; #api &quot;.fw&quot;</span>
<span class="cp">#define MWL8K_8366_AP_FW(api) _MWL8K_8366_AP_FW(api)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mwl8k_device_info</span> <span class="n">mwl8k_info_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">MWL8363</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">part_name</span>	<span class="o">=</span> <span class="s">&quot;88w8363&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">helper_image</span>	<span class="o">=</span> <span class="s">&quot;mwl8k/helper_8363.fw&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fw_image_sta</span>	<span class="o">=</span> <span class="s">&quot;mwl8k/fmimage_8363.fw&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">MWL8687</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">part_name</span>	<span class="o">=</span> <span class="s">&quot;88w8687&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">helper_image</span>	<span class="o">=</span> <span class="s">&quot;mwl8k/helper_8687.fw&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fw_image_sta</span>	<span class="o">=</span> <span class="s">&quot;mwl8k/fmimage_8687.fw&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">MWL8366</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">part_name</span>	<span class="o">=</span> <span class="s">&quot;88w8366&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">helper_image</span>	<span class="o">=</span> <span class="s">&quot;mwl8k/helper_8366.fw&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fw_image_sta</span>	<span class="o">=</span> <span class="s">&quot;mwl8k/fmimage_8366.fw&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fw_image_ap</span>	<span class="o">=</span> <span class="n">MWL8K_8366_AP_FW</span><span class="p">(</span><span class="n">MWL8K_8366_AP_FW_API</span><span class="p">),</span>
		<span class="p">.</span><span class="n">fw_api_ap</span>	<span class="o">=</span> <span class="n">MWL8K_8366_AP_FW_API</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ap_rxd_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">rxd_8366_ap_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mwl8k/helper_8363.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mwl8k/fmimage_8363.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mwl8k/helper_8687.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mwl8k/fmimage_8687.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mwl8k/helper_8366.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;mwl8k/fmimage_8366.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">MWL8K_8366_AP_FW</span><span class="p">(</span><span class="n">MWL8K_8366_AP_FW_API</span><span class="p">));</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">mwl8k_pci_id_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MARVELL</span><span class="p">,</span> <span class="mh">0x2a0a</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">MWL8363</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MARVELL</span><span class="p">,</span> <span class="mh">0x2a0c</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">MWL8363</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MARVELL</span><span class="p">,</span> <span class="mh">0x2a24</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">MWL8363</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MARVELL</span><span class="p">,</span> <span class="mh">0x2a2b</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">MWL8687</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MARVELL</span><span class="p">,</span> <span class="mh">0x2a30</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">MWL8687</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MARVELL</span><span class="p">,</span> <span class="mh">0x2a40</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">MWL8366</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MARVELL</span><span class="p">,</span> <span class="mh">0x2a43</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">MWL8366</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">mwl8k_pci_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_request_alt_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error requesting preferred fw %s.</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;Trying alternative firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span>
	       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pref</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_alt</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_request_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_alt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ucode</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error requesting alt fw %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_alt</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mwl8k_firmware_load_success</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwl8k_fw_state_machine</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_device_info</span> <span class="o">*</span><span class="n">di</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FW_STATE_INIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error requesting helper fw %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">helper_image</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_helper</span> <span class="o">=</span> <span class="n">fw</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_request_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ucode</span><span class="p">,</span>
				      <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_alt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_request_alt_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_state</span> <span class="o">=</span> <span class="n">FW_STATE_LOADING_ALT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_state</span> <span class="o">=</span> <span class="n">FW_STATE_LOADING_PREF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FW_STATE_LOADING_PREF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_alt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_request_alt_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_state</span> <span class="o">=</span> <span class="n">FW_STATE_LOADING_ALT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ucode</span> <span class="o">=</span> <span class="n">fw</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_firmware_load_success</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_loading_complete</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FW_STATE_LOADING_ALT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error requesting alt fw %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pci_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">),</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">helper_image</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ucode</span> <span class="o">=</span> <span class="n">fw</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_firmware_load_success</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_loading_complete</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unexpected firmware loading state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">MWL8K_NAME</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_state</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_state</span> <span class="o">=</span> <span class="n">FW_STATE_ERROR</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_loading_complete</span><span class="p">);</span>
	<span class="n">device_release_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mwl8k_release_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MAX_RESTART_ATTEMPTS 1</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_init_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_image</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="n">nowait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">MAX_RESTART_ATTEMPTS</span><span class="p">;</span>

<span class="nl">retry:</span>
	<span class="cm">/* Reset firmware and hardware */</span>
	<span class="n">mwl8k_hw_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Ask userland hotplug daemon for the device firmware */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_request_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fw_image</span><span class="p">,</span> <span class="n">nowait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Firmware files not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nowait</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Load firmware into hardware */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_load_firmware</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Cannot start firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Reclaim memory once firmware is successfully loaded */</span>
	<span class="n">mwl8k_release_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FW did not start successfully;</span>
<span class="cm">		 * lets try one more time</span>
<span class="cm">		 */</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Trying to reload the firmware again</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_init_txqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_txq_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span>
			<span class="n">iowrite32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txd_dma</span><span class="p">,</span>
				  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txq_offset</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* initialize hw after successfully loading a firmware image */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_probe_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="o">-&gt;</span><span class="n">ap_rxd_ops</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="s">&quot;Driver does not have AP firmware image support for this hardware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_stop_firmware</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxd_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxd_sta_ops</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sniffer_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pending_tx_pkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_rxq_init</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_stop_firmware</span><span class="p">;</span>
	<span class="n">rxq_refill</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">);</span>

	<span class="cm">/* For the sta firmware, we need to know the dma addresses of tx queues</span>
<span class="cm">	 * before sending MWL8K_CMD_GET_HW_SPEC.  So we must initialize them</span>
<span class="cm">	 * prior to issuing this command.  But for the AP case, we learn the</span>
<span class="cm">	 * total number of queues from the result CMD_GET_HW_SPEC, so for this</span>
<span class="cm">	 * case we must initialize the tx queues after.</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ampdu_queues</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_init_txqs</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_queues</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_STATUS</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_MASK</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_A2H_INT_TX_DONE</span><span class="o">|</span><span class="n">MWL8K_A2H_INT_RX_READY</span><span class="o">|</span>
		  <span class="n">MWL8K_A2H_INT_BA_WATCHDOG</span><span class="p">,</span>
		  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_CLEAR_SEL</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_A2H_INT_OPC_DONE</span><span class="p">,</span>
		  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_STATUS_MASK</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">mwl8k_interrupt</span><span class="p">,</span>
			 <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">MWL8K_NAME</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;failed to register IRQ handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_queues</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * When hw restart is requested,</span>
<span class="cm">	 * mac80211 will take care of clearing</span>
<span class="cm">	 * the ampdu streams, so do not clear</span>
<span class="cm">	 * the ampdu state here</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_in_progress</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ampdu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ampdu</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Temporarily enable interrupts.  Initial firmware host</span>
<span class="cm">	 * commands use interrupts and avoid polling.  Disable</span>
<span class="cm">	 * interrupts when done.</span>
<span class="cm">	 */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">MWL8K_A2H_EVENTS</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_MASK</span><span class="p">);</span>

	<span class="cm">/* Get config data, mac addrs etc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_get_hw_spec_ap</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_init_txqs</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_hw_spec</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_get_hw_spec_sta</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Cannot initialise firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Turn radio off */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_radio_disable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Cannot disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear MAC address */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_cmd_set_mac_addr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x00\x00\x00\x00\x00\x00</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Cannot clear MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable interrupts */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_MASK</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="n">wiphy_info</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s v%d, %pm, %s firmware %u.%u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="o">-&gt;</span><span class="n">part_name</span><span class="p">,</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_rev</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span> <span class="o">?</span> <span class="s">&quot;AP&quot;</span> <span class="o">:</span> <span class="s">&quot;STA&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_rev</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_rev</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_rev</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_rev</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_irq:</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">MWL8K_HIU_A2H_INTERRUPT_MASK</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

<span class="nl">err_free_queues:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mwl8k_txq_deinit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">mwl8k_rxq_deinit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">err_stop_firmware:</span>
	<span class="n">mwl8k_hw_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * invoke mwl8k_reload_firmware to change the firmware image after the device</span>
<span class="cm"> * has already been registered</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_reload_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_image</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_vif</span><span class="p">;</span>

	<span class="n">mwl8k_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">mwl8k_rxq_deinit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * All the existing interfaces are re-added by the ieee80211_reconfig;</span>
<span class="cm">	 * which means driver should remove existing interfaces before calling</span>
<span class="cm">	 * ieee80211_restart_hw</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_in_progress</span><span class="p">)</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">tmp_vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
			<span class="n">mwl8k_remove_vif</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mwl8k_txq_deinit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_init_firmware</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">fw_image</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_probe_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_in_progress</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_start</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_config</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MWL8K_TX_WMM_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_conf_tx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_params</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;mwl8k: Failed to reload firmware image.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwl8k_firmware_load_success</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_load_firmware</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">mwl8k_release_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Cannot start firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Extra headroom is the size of the required DMA header</span>
<span class="cm">	 * minus the size of the smallest 802.11 frame (CTS frame).</span>
<span class="cm">	 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">=</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_dma_data</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_cts</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">-=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span> <span class="o">?</span> <span class="n">REDUCED_TX_HEADROOM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_change_time</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="n">MWL8K_TX_WMM_QUEUES</span><span class="p">;</span>

	<span class="cm">/* Set rssi values to dBm */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span> <span class="o">|</span> <span class="n">IEEE80211_HW_HAS_RATE_CONTROL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ask mac80211 to not to trigger PS mode</span>
<span class="cm">	 * based on PM bit of incoming frames.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_fw</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_HW_AP_LINK_PS</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vif_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_vif</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">sta_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwl8k_sta</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">macids_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">);</span>

	<span class="cm">/* Set default radio state and preamble */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_short_preamble</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Finalize join worker */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">finalize_join_worker</span><span class="p">,</span> <span class="n">mwl8k_finalize_join_worker</span><span class="p">);</span>
	<span class="cm">/* Handle watchdog ba events */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">watchdog_ba_handle</span><span class="p">,</span> <span class="n">mwl8k_watchdog_ba_events</span><span class="p">);</span>
	<span class="cm">/* To reload the firmware if it crashes */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_reload</span><span class="p">,</span> <span class="n">mwl8k_hw_restart_work</span><span class="p">);</span>

	<span class="cm">/* TX reclaim and RX tasklets.  */</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_tx_task</span><span class="p">,</span> <span class="n">mwl8k_tx_poll</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_tx_task</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_rx_task</span><span class="p">,</span> <span class="n">mwl8k_rx_poll</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_rx_task</span><span class="p">);</span>

	<span class="cm">/* Power management cookie */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cookie_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex_owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_mutex_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hostcmd_wait</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stream_lock</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_wait</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_probe_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_cookie</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ap_macids_supported</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="o">-&gt;</span><span class="n">fw_image_ap</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_macids_supported</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="o">-&gt;</span><span class="n">fw_image_sta</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Cannot register device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unprobe_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unprobe_hw:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mwl8k_txq_deinit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">mwl8k_rxq_deinit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">err_free_cookie:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cookie</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cookie_dma</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">mwl8k_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">printed_version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwl8k_device_info</span> <span class="o">*</span><span class="n">di</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">printed_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MWL8K_DESC</span><span class="p">,</span> <span class="n">MWL8K_VERSION</span><span class="p">);</span>
		<span class="n">printed_version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Cannot enable new PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">MWL8K_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MWL8K_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Cannot obtain PCI resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">MWL8K_NAME</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>


	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mwl8k_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ieee80211 alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MWL8K_NAME</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mwl8k_info_tbl</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">];</span>


	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Cannot map device SRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If BAR0 is a 32 bit BAR, the register BAR will be BAR1.</span>
<span class="cm">	 * If BAR0 is a 64 bit BAR, the register BAR will be BAR2.</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Cannot map device registers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_iounmap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Choose the initial fw image depending on user input.  If a second</span>
<span class="cm">	 * image is available, make it the alternative image that will be</span>
<span class="cm">	 * loaded if the first one fails.</span>
<span class="cm">	 */</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_loading_complete</span><span class="p">);</span>
	<span class="n">di</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_mode_default</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pref</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_ap</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_alt</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_sta</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_mode_default</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pref</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_sta</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_alt</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_ap</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ap_mode_default</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_ap</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;AP fw is unavailable.  Using STA fw.&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pref</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_sta</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap_mode_default</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_sta</span> <span class="o">&amp;&amp;</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;STA fw is unavailable.  Using AP fw.&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pref</span> <span class="o">=</span> <span class="n">di</span><span class="o">-&gt;</span><span class="n">fw_image_ap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">mwl8k_init_firmware</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_pref</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_stop_firmware</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_restart_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">err_stop_firmware:</span>
	<span class="n">mwl8k_hw_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

<span class="nl">err_iounmap:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

<span class="nl">err_free_reg:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

<span class="nl">err_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">mwl8k_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;===&gt;%s(%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">mwl8k_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">mwl8k_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_loading_complete</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_state</span> <span class="o">==</span> <span class="n">FW_STATE_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mwl8k_hw_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Remove TX reclaim and RX tasklets.  */</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_tx_task</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">poll_rx_task</span><span class="p">);</span>

	<span class="cm">/* Stop hardware */</span>
	<span class="n">mwl8k_hw_reset</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Return all skbs to mac80211 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mwl8k_txq_reclaim</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mwl8k_tx_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mwl8k_txq_deinit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">mwl8k_rxq_deinit</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cookie_dma</span><span class="p">);</span>

<span class="nl">unmap:</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sram</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">mwl8k_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">MWL8K_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">mwl8k_pci_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">mwl8k_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mwl8k_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">shutdown</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">mwl8k_shutdown</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">mwl8k_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">MWL8K_DESC</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">MWL8K_VERSION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Lennert Buytenhek &lt;buytenh@marvell.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
