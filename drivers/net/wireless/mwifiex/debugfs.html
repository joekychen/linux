<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › mwifiex › debugfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>debugfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Marvell Wireless LAN device driver: debugfs</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011, Marvell International Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This software file (the &quot;File&quot;) is distributed by Marvell International</span>
<span class="cm"> * Ltd. under the terms of the GNU General Public License Version 2, June 1991</span>
<span class="cm"> * (the &quot;License&quot;).  You may use, redistribute and/or modify this File in</span>
<span class="cm"> * accordance with the terms and conditions of the License, a copy of which</span>
<span class="cm"> * is available by writing to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA or on the</span>
<span class="cm"> * worldwide web at http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.</span>
<span class="cm"> *</span>
<span class="cm"> * THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE EXPRESSLY DISCLAIMED.  The License provides additional details about</span>
<span class="cm"> * this warranty disclaimer.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/debugfs.h&gt;</span>

<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;11n.h&quot;</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">mwifiex_dfs_dir</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bss_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Unknown&quot;</span><span class="p">,</span>
	<span class="s">&quot;Ad-hoc&quot;</span><span class="p">,</span>
	<span class="s">&quot;Managed&quot;</span><span class="p">,</span>
	<span class="s">&quot;Auto&quot;</span>
<span class="p">};</span>

<span class="cm">/* size/addr for mwifiex_debug_info */</span>
<span class="cp">#define item_size(n)		(FIELD_SIZEOF(struct mwifiex_debug_info, n))</span>
<span class="cp">#define item_addr(n)		(offsetof(struct mwifiex_debug_info, n))</span>

<span class="cm">/* size/addr for struct mwifiex_adapter */</span>
<span class="cp">#define adapter_item_size(n)	(FIELD_SIZEOF(struct mwifiex_adapter, n))</span>
<span class="cp">#define adapter_item_addr(n)	(offsetof(struct mwifiex_adapter, n))</span>

<span class="k">struct</span> <span class="n">mwifiex_debug_data</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>		<span class="cm">/* variable/array name */</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>		<span class="cm">/* size of the variable/array */</span>
	<span class="kt">size_t</span> <span class="n">addr</span><span class="p">;</span>		<span class="cm">/* address of the variable/array */</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>		<span class="cm">/* number of variables in an array */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mwifiex_debug_data</span> <span class="n">items</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;int_counter&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">int_counter</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">int_counter</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;wmm_ac_vo&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">packets_out</span><span class="p">[</span><span class="n">WMM_AC_VO</span><span class="p">]),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">packets_out</span><span class="p">[</span><span class="n">WMM_AC_VO</span><span class="p">]),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;wmm_ac_vi&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">packets_out</span><span class="p">[</span><span class="n">WMM_AC_VI</span><span class="p">]),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">packets_out</span><span class="p">[</span><span class="n">WMM_AC_VI</span><span class="p">]),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;wmm_ac_be&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">packets_out</span><span class="p">[</span><span class="n">WMM_AC_BE</span><span class="p">]),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">packets_out</span><span class="p">[</span><span class="n">WMM_AC_BE</span><span class="p">]),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;wmm_ac_bk&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">packets_out</span><span class="p">[</span><span class="n">WMM_AC_BK</span><span class="p">]),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">packets_out</span><span class="p">[</span><span class="n">WMM_AC_BK</span><span class="p">]),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;max_tx_buf_size&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">max_tx_buf_size</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">max_tx_buf_size</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx_buf_size&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">tx_buf_size</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">tx_buf_size</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;curr_tx_buf_size&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">curr_tx_buf_size</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">curr_tx_buf_size</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ps_mode&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">ps_mode</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">ps_mode</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ps_state&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">ps_state</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">ps_state</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;is_deep_sleep&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">is_deep_sleep</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">is_deep_sleep</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;wakeup_dev_req&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">pm_wakeup_card_req</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">pm_wakeup_card_req</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;wakeup_tries&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">pm_wakeup_fw_try</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">pm_wakeup_fw_try</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;hs_configured&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">is_hs_configured</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">is_hs_configured</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;hs_activated&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">hs_activated</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">hs_activated</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;num_tx_timeout&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">num_tx_timeout</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">num_tx_timeout</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;num_cmd_timeout&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">num_cmd_timeout</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">num_cmd_timeout</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;timeout_cmd_id&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">timeout_cmd_id</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">timeout_cmd_id</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;timeout_cmd_act&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">timeout_cmd_act</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">timeout_cmd_act</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;last_cmd_id&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">last_cmd_id</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">last_cmd_id</span><span class="p">),</span> <span class="n">DBG_CMD_NUM</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;last_cmd_act&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">last_cmd_act</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">last_cmd_act</span><span class="p">),</span> <span class="n">DBG_CMD_NUM</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;last_cmd_index&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">last_cmd_index</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">last_cmd_index</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;last_cmd_resp_id&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">last_cmd_resp_id</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">last_cmd_resp_id</span><span class="p">),</span> <span class="n">DBG_CMD_NUM</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;last_cmd_resp_index&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">last_cmd_resp_index</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">last_cmd_resp_index</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;last_event&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">last_event</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">last_event</span><span class="p">),</span> <span class="n">DBG_CMD_NUM</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;last_event_index&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">last_event_index</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">last_event_index</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;num_cmd_h2c_fail&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">num_cmd_host_to_card_failure</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">num_cmd_host_to_card_failure</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;num_cmd_sleep_cfm_fail&quot;</span><span class="p">,</span>
	 <span class="n">item_size</span><span class="p">(</span><span class="n">num_cmd_sleep_cfm_host_to_card_failure</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">num_cmd_sleep_cfm_host_to_card_failure</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;num_tx_h2c_fail&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">num_tx_host_to_card_failure</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">num_tx_host_to_card_failure</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;num_evt_deauth&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">num_event_deauth</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">num_event_deauth</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;num_evt_disassoc&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">num_event_disassoc</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">num_event_disassoc</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;num_evt_link_lost&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">num_event_link_lost</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">num_event_link_lost</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;num_cmd_deauth&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">num_cmd_deauth</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">num_cmd_deauth</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;num_cmd_assoc_ok&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">num_cmd_assoc_success</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">num_cmd_assoc_success</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;num_cmd_assoc_fail&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">num_cmd_assoc_failure</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">num_cmd_assoc_failure</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;cmd_sent&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">cmd_sent</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">cmd_sent</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;data_sent&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">data_sent</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">data_sent</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;cmd_resp_received&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">cmd_resp_received</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">cmd_resp_received</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;event_received&quot;</span><span class="p">,</span> <span class="n">item_size</span><span class="p">(</span><span class="n">event_received</span><span class="p">),</span>
	 <span class="n">item_addr</span><span class="p">(</span><span class="n">event_received</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>

	<span class="cm">/* variables defined in struct mwifiex_adapter */</span>
	<span class="p">{</span><span class="s">&quot;cmd_pending&quot;</span><span class="p">,</span> <span class="n">adapter_item_size</span><span class="p">(</span><span class="n">cmd_pending</span><span class="p">),</span>
	 <span class="n">adapter_item_addr</span><span class="p">(</span><span class="n">cmd_pending</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;tx_pending&quot;</span><span class="p">,</span> <span class="n">adapter_item_size</span><span class="p">(</span><span class="n">tx_pending</span><span class="p">),</span>
	 <span class="n">adapter_item_addr</span><span class="p">(</span><span class="n">tx_pending</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;rx_pending&quot;</span><span class="p">,</span> <span class="n">adapter_item_size</span><span class="p">(</span><span class="n">rx_pending</span><span class="p">),</span>
	 <span class="n">adapter_item_addr</span><span class="p">(</span><span class="n">rx_pending</span><span class="p">),</span> <span class="mi">1</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">num_of_items</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">items</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Proc info file read handler.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called when the &#39;info&#39; file is opened for reading.</span>
<span class="cm"> * It prints the following driver related information -</span>
<span class="cm"> *      - Driver name</span>
<span class="cm"> *      - Driver version</span>
<span class="cm"> *      - Driver extended version</span>
<span class="cm"> *      - Interface name</span>
<span class="cm"> *      - BSS mode</span>
<span class="cm"> *      - Media state (connected or disconnected)</span>
<span class="cm"> *      - MAC address</span>
<span class="cm"> *      - Total number of Tx bytes</span>
<span class="cm"> *      - Total number of Rx bytes</span>
<span class="cm"> *      - Total number of Tx packets</span>
<span class="cm"> *      - Total number of Rx packets</span>
<span class="cm"> *      - Total number of dropped Tx packets</span>
<span class="cm"> *      - Total number of dropped Rx packets</span>
<span class="cm"> *      - Total number of corrupted Tx packets</span>
<span class="cm"> *      - Total number of corrupted Rx packets</span>
<span class="cm"> *      - Carrier status (on or off)</span>
<span class="cm"> *      - Tx queue status (started or stopped)</span>
<span class="cm"> *</span>
<span class="cm"> * For STA mode drivers, it also prints the following extra -</span>
<span class="cm"> *      - ESSID</span>
<span class="cm"> *      - BSSID</span>
<span class="cm"> *      - Channel</span>
<span class="cm"> *      - Region code</span>
<span class="cm"> *      - Multicast count</span>
<span class="cm"> *      - Multicast addresses</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mwifiex_info_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="p">,</span> <span class="n">fmt</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mwifiex_bss_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_get_bss_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_and_exit</span><span class="p">;</span>

	<span class="n">mwifiex_drv_get_driver_version</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">version_str</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">mwifiex_get_ver_ext</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;driver_name = &quot;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">mwifiex</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;driver_version = %s&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">verext = %s&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">version_str</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">interface_name=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;bss_mode=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bss_modes</span><span class="p">[</span><span class="n">info</span><span class="p">.</span><span class="n">bss_mode</span><span class="p">]);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;media_state=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">media_connected</span> <span class="o">?</span> <span class="s">&quot;Disconnected&quot;</span> <span class="o">:</span> <span class="s">&quot;Connected&quot;</span><span class="p">));</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;mac_address=</span><span class="se">\&quot;</span><span class="s">%pM</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">GET_BSS_ROLE</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">==</span> <span class="n">MWIFIEX_BSS_ROLE_STA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;multicast_count=</span><span class="se">\&quot;</span><span class="s">%d</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">netdev</span><span class="p">));</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;essid=</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;bssid=</span><span class="se">\&quot;</span><span class="s">%pM</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;channel=</span><span class="se">\&quot;</span><span class="s">%d</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">info</span><span class="p">.</span><span class="n">bss_chan</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;country_code = </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">country_code</span><span class="p">);</span>

		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">netdev</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;multicast_address[%d]=</span><span class="se">\&quot;</span><span class="s">%pM</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;num_tx_bytes = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;num_rx_bytes = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;num_tx_pkts = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;num_rx_pkts = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;num_tx_pkts_dropped = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;num_rx_pkts_dropped = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;num_tx_pkts_err = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;num_rx_pkts_err = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;carrier %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
					 <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">));</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;tx queue %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
					  <span class="o">?</span> <span class="s">&quot;stopped&quot;</span> <span class="o">:</span> <span class="s">&quot;started&quot;</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="p">,</span>
				      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">);</span>

<span class="nl">free_and_exit:</span>
	<span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Proc getlog file read handler.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called when the &#39;getlog&#39; file is opened for reading</span>
<span class="cm"> * It prints the following log information -</span>
<span class="cm"> *      - Number of multicast Tx frames</span>
<span class="cm"> *      - Number of failed packets</span>
<span class="cm"> *      - Number of Tx retries</span>
<span class="cm"> *      - Number of multicast Tx retries</span>
<span class="cm"> *      - Number of duplicate frames</span>
<span class="cm"> *      - Number of RTS successes</span>
<span class="cm"> *      - Number of RTS failures</span>
<span class="cm"> *      - Number of ACK failures</span>
<span class="cm"> *      - Number of fragmented Rx frames</span>
<span class="cm"> *      - Number of multicast Rx frames</span>
<span class="cm"> *      - Number of FCS errors</span>
<span class="cm"> *      - Number of Tx frames</span>
<span class="cm"> *      - WEP ICV error counts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mwifiex_getlog_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ds_get_stats</span> <span class="n">stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_get_stats_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_and_exit</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;mcasttxframe     %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;failed           %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;retry            %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;multiretry       %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;framedup         %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;rtssuccess       %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;rtsfailure       %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;ackfailure       %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;rxfrag           %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;mcastrxframe     %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;fcserror         %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;txframe          %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;wepicverrcnt-1   %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;wepicverrcnt-2   %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;wepicverrcnt-3   %u</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;wepicverrcnt-4   %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">mcast_tx_frame</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">failed</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">retry</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">multi_retry</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">frame_dup</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">rts_success</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">rts_failure</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">ack_failure</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">rx_frag</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">mcast_rx_frame</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">fcs_error</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">tx_frame</span><span class="p">,</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">wep_icv_error</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">wep_icv_error</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">wep_icv_error</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		     <span class="n">stats</span><span class="p">.</span><span class="n">wep_icv_error</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="p">,</span>
				      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">);</span>

<span class="nl">free_and_exit:</span>
	<span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mwifiex_debug_info</span> <span class="n">info</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Proc debug file read handler.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called when the &#39;debug&#39; file is opened for reading</span>
<span class="cm"> * It prints the following log information -</span>
<span class="cm"> *      - Interrupt count</span>
<span class="cm"> *      - WMM AC VO packets count</span>
<span class="cm"> *      - WMM AC VI packets count</span>
<span class="cm"> *      - WMM AC BE packets count</span>
<span class="cm"> *      - WMM AC BK packets count</span>
<span class="cm"> *      - Maximum Tx buffer size</span>
<span class="cm"> *      - Tx buffer size</span>
<span class="cm"> *      - Current Tx buffer size</span>
<span class="cm"> *      - Power Save mode</span>
<span class="cm"> *      - Power Save state</span>
<span class="cm"> *      - Deep Sleep status</span>
<span class="cm"> *      - Device wakeup required status</span>
<span class="cm"> *      - Number of wakeup tries</span>
<span class="cm"> *      - Host Sleep configured status</span>
<span class="cm"> *      - Host Sleep activated status</span>
<span class="cm"> *      - Number of Tx timeouts</span>
<span class="cm"> *      - Number of command timeouts</span>
<span class="cm"> *      - Last timed out command ID</span>
<span class="cm"> *      - Last timed out command action</span>
<span class="cm"> *      - Last command ID</span>
<span class="cm"> *      - Last command action</span>
<span class="cm"> *      - Last command index</span>
<span class="cm"> *      - Last command response ID</span>
<span class="cm"> *      - Last command response index</span>
<span class="cm"> *      - Last event</span>
<span class="cm"> *      - Last event index</span>
<span class="cm"> *      - Number of host to card command failures</span>
<span class="cm"> *      - Number of sleep confirm command failures</span>
<span class="cm"> *      - Number of host to card data failure</span>
<span class="cm"> *      - Number of deauthentication events</span>
<span class="cm"> *      - Number of disassociation events</span>
<span class="cm"> *      - Number of link lost events</span>
<span class="cm"> *      - Number of deauthentication commands</span>
<span class="cm"> *      - Number of association success commands</span>
<span class="cm"> *      - Number of association failure commands</span>
<span class="cm"> *      - Number of commands sent</span>
<span class="cm"> *      - Number of data packets sent</span>
<span class="cm"> *      - Number of command responses received</span>
<span class="cm"> *      - Number of events received</span>
<span class="cm"> *      - Tx BA stream table (TID, RA)</span>
<span class="cm"> *      - Rx reorder table (TID, TA, Start window, Window size, Buffer)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mwifiex_debug_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		   <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_debug_data</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">items</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">page</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_get_debug_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_and_exit</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_of_items</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%s=&quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">/</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">num_of_items</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">;</span>
		<span class="k">else</span> <span class="cm">/* The last 3 items are struct mwifiex_adapter variables */</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">addr</span> <span class="o">+</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%#lx &quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">addr</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">tx_tbl_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Tx BA stream table:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="p">.</span><span class="n">tx_tbl_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;tid = %d, ra = %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">info</span><span class="p">.</span><span class="n">tx_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tid</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">tx_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ra</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">rx_tbl_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Rx reorder table:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info</span><span class="p">.</span><span class="n">rx_tbl_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;tid = %d, ta = %pM, &quot;</span>
				     <span class="s">&quot;start_win = %d, &quot;</span>
				     <span class="s">&quot;win_size = %d, buffer: &quot;</span><span class="p">,</span>
				     <span class="n">info</span><span class="p">.</span><span class="n">rx_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tid</span><span class="p">,</span>
				     <span class="n">info</span><span class="p">.</span><span class="n">rx_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ta</span><span class="p">,</span>
				     <span class="n">info</span><span class="p">.</span><span class="n">rx_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start_win</span><span class="p">,</span>
				     <span class="n">info</span><span class="p">.</span><span class="n">rx_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">win_size</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">info</span><span class="p">.</span><span class="n">rx_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">win_size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%c &quot;</span><span class="p">,</span>
					     <span class="n">info</span><span class="p">.</span><span class="n">rx_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buffer</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">?</span>
					     <span class="sc">&#39;1&#39;</span> <span class="o">:</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>

			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">page</span><span class="p">,</span>
				      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">);</span>

<span class="nl">free_and_exit:</span>
	<span class="n">free_page</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">saved_reg_type</span><span class="p">,</span> <span class="n">saved_reg_offset</span><span class="p">,</span> <span class="n">saved_reg_value</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Proc regrdwr file write handler.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called when the &#39;regrdwr&#39; file is opened for writing</span>
<span class="cm"> *</span>
<span class="cm"> * This function can be used to write to a register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mwifiex_regrdwr_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buf_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg_value</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u %x %x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">reg_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">saved_reg_type</span> <span class="o">=</span> <span class="n">reg_type</span><span class="p">;</span>
		<span class="n">saved_reg_offset</span> <span class="o">=</span> <span class="n">reg_offset</span><span class="p">;</span>
		<span class="n">saved_reg_value</span> <span class="o">=</span> <span class="n">reg_value</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">free_page</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Proc regrdwr file read handler.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called when the &#39;regrdwr&#39; file is opened for reading</span>
<span class="cm"> *</span>
<span class="cm"> * This function can be used to read from a register.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mwifiex_regrdwr_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		     <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">saved_reg_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No command has been given */</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Set command has been given */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saved_reg_value</span> <span class="o">!=</span> <span class="n">UINT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_reg_write</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">saved_reg_type</span><span class="p">,</span> <span class="n">saved_reg_offset</span><span class="p">,</span>
					<span class="n">saved_reg_value</span><span class="p">);</span>

		<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">saved_reg_type</span><span class="p">,</span> <span class="n">saved_reg_offset</span><span class="p">,</span>
				<span class="n">saved_reg_value</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Get command has been given */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_reg_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">saved_reg_type</span><span class="p">,</span>
			       <span class="n">saved_reg_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">saved_reg_type</span><span class="p">,</span>
			<span class="n">saved_reg_offset</span><span class="p">,</span> <span class="n">reg_value</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">free_page</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">saved_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">saved_bytes</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Proc rdeeprom file write handler.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called when the &#39;rdeeprom&#39; file is opened for writing</span>
<span class="cm"> *</span>
<span class="cm"> * This function can be used to write to a RDEEPROM location.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mwifiex_rdeeprom_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buf_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">bytes</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ubuf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">bytes</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">saved_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">saved_bytes</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">free_page</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Proc rdeeprom read write handler.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called when the &#39;rdeeprom&#39; file is opened for reading</span>
<span class="cm"> *</span>
<span class="cm"> * This function can be used to read from a RDEEPROM location.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">mwifiex_rdeeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ubuf</span><span class="p">,</span>
		      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">[</span><span class="n">MAX_EEPROM_DATA</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saved_offset</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No command has been given */</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get command has been given */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_eeprom_read</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">saved_offset</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">saved_bytes</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d %d &quot;</span><span class="p">,</span> <span class="n">saved_offset</span><span class="p">,</span> <span class="n">saved_bytes</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">saved_bytes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">ubuf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">free_page</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define MWIFIEX_DFS_ADD_FILE(name) do {                                 \</span>
<span class="cp">	if (!debugfs_create_file(#name, 0644, priv-&gt;dfs_dev_dir,        \</span>
<span class="cp">			priv, &amp;mwifiex_dfs_##name##_fops))              \</span>
<span class="cp">		return;                                                 \</span>
<span class="cp">} while (0);</span>

<span class="cp">#define MWIFIEX_DFS_FILE_OPS(name)                                      \</span>
<span class="cp">static const struct file_operations mwifiex_dfs_##name##_fops = {       \</span>
<span class="cp">	.read = mwifiex_##name##_read,                                  \</span>
<span class="cp">	.write = mwifiex_##name##_write,                                \</span>
<span class="cp">	.open = simple_open,                                            \</span>
<span class="cp">};</span>

<span class="cp">#define MWIFIEX_DFS_FILE_READ_OPS(name)                                 \</span>
<span class="cp">static const struct file_operations mwifiex_dfs_##name##_fops = {       \</span>
<span class="cp">	.read = mwifiex_##name##_read,                                  \</span>
<span class="cp">	.open = simple_open,                                            \</span>
<span class="cp">};</span>

<span class="cp">#define MWIFIEX_DFS_FILE_WRITE_OPS(name)                                \</span>
<span class="cp">static const struct file_operations mwifiex_dfs_##name##_fops = {       \</span>
<span class="cp">	.write = mwifiex_##name##_write,                                \</span>
<span class="cp">	.open = simple_open,                                            \</span>
<span class="cp">};</span>


<span class="n">MWIFIEX_DFS_FILE_READ_OPS</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
<span class="n">MWIFIEX_DFS_FILE_READ_OPS</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>
<span class="n">MWIFIEX_DFS_FILE_READ_OPS</span><span class="p">(</span><span class="n">getlog</span><span class="p">);</span>
<span class="n">MWIFIEX_DFS_FILE_OPS</span><span class="p">(</span><span class="n">regrdwr</span><span class="p">);</span>
<span class="n">MWIFIEX_DFS_FILE_OPS</span><span class="p">(</span><span class="n">rdeeprom</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This function creates the debug FS directory structure and the files.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_dev_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mwifiex_dfs_dir</span> <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dfs_dev_dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					       <span class="n">mwifiex_dfs_dir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dfs_dev_dir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">MWIFIEX_DFS_ADD_FILE</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="n">MWIFIEX_DFS_ADD_FILE</span><span class="p">(</span><span class="n">debug</span><span class="p">);</span>
	<span class="n">MWIFIEX_DFS_ADD_FILE</span><span class="p">(</span><span class="n">getlog</span><span class="p">);</span>
	<span class="n">MWIFIEX_DFS_ADD_FILE</span><span class="p">(</span><span class="n">regrdwr</span><span class="p">);</span>
	<span class="n">MWIFIEX_DFS_ADD_FILE</span><span class="p">(</span><span class="n">rdeeprom</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function removes the debug FS directory structure and the files.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_dev_debugfs_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dfs_dev_dir</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function creates the top level proc directory.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_debugfs_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mwifiex_dfs_dir</span><span class="p">)</span>
		<span class="n">mwifiex_dfs_dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;mwifiex&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function removes the top level proc directory.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_debugfs_remove</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_dfs_dir</span><span class="p">)</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">mwifiex_dfs_dir</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
