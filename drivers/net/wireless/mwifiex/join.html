<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › mwifiex › join.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>join.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Marvell Wireless LAN device driver: association and ad-hoc start/join</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011, Marvell International Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This software file (the &quot;File&quot;) is distributed by Marvell International</span>
<span class="cm"> * Ltd. under the terms of the GNU General Public License Version 2, June 1991</span>
<span class="cm"> * (the &quot;License&quot;).  You may use, redistribute and/or modify this File in</span>
<span class="cm"> * accordance with the terms and conditions of the License, a copy of which</span>
<span class="cm"> * is available by writing to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA or on the</span>
<span class="cm"> * worldwide web at http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.</span>
<span class="cm"> *</span>
<span class="cm"> * THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE EXPRESSLY DISCLAIMED.  The License provides additional details about</span>
<span class="cm"> * this warranty disclaimer.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;decl.h&quot;</span>
<span class="cp">#include &quot;ioctl.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;fw.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;wmm.h&quot;</span>
<span class="cp">#include &quot;11n.h&quot;</span>

<span class="cp">#define CAPINFO_MASK    (~(BIT(15) | BIT(14) | BIT(12) | BIT(11) | BIT(9)))</span>

<span class="cm">/*</span>
<span class="cm"> * Append a generic IE as a pass through TLV to a TLV buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called from the network join command preparation routine.</span>
<span class="cm"> *</span>
<span class="cm"> * If the IE buffer has been setup by the application, this routine appends</span>
<span class="cm"> * the buffer as a pass through TLV type to the request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_cmd_append_generic_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span> <span class="n">ie_header</span><span class="p">;</span>

	<span class="cm">/* Null Checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is a generic ie buffer setup, append it to the return</span>
<span class="cm">	 *   parameter buffer pointer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gen_ie_buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;info: %s: append generic ie len %d to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">gen_ie_buf_len</span><span class="p">,</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>

		<span class="cm">/* Wrap the generic IE buffer with a pass through TLV type */</span>
		<span class="n">ie_header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_PASSTHROUGH</span><span class="p">);</span>
		<span class="n">ie_header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gen_ie_buf_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ie_header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ie_header</span><span class="p">));</span>

		<span class="cm">/* Increment the return size and the return buffer pointer</span>
<span class="cm">		   param */</span>
		<span class="o">*</span><span class="n">buffer</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ie_header</span><span class="p">);</span>
		<span class="n">ret_len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ie_header</span><span class="p">);</span>

		<span class="cm">/* Copy the generic IE buffer to the output buffer, advance</span>
<span class="cm">		   pointer */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">gen_ie_buf</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">gen_ie_buf_len</span><span class="p">);</span>

		<span class="cm">/* Increment the return size and the return buffer pointer</span>
<span class="cm">		   param */</span>
		<span class="o">*</span><span class="n">buffer</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">gen_ie_buf_len</span><span class="p">;</span>
		<span class="n">ret_len</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">gen_ie_buf_len</span><span class="p">;</span>

		<span class="cm">/* Reset the generic IE buffer */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">gen_ie_buf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* return the length appended to the buffer */</span>
	<span class="k">return</span> <span class="n">ret_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Append TSF tracking info from the scan table for the target AP.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called from the network join command preparation routine.</span>
<span class="cm"> *</span>
<span class="cm"> * The TSF table TSF sent to the firmware contains two TSF values:</span>
<span class="cm"> *      - The TSF of the target AP from its previous beacon/probe response</span>
<span class="cm"> *      - The TSF timestamp of our local MAC at the time we observed the</span>
<span class="cm"> *        beacon/probe response.</span>
<span class="cm"> *</span>
<span class="cm"> * The firmware uses the timestamp values to set an initial TSF value</span>
<span class="cm"> * in the MAC for the new association after a reassociation attempt.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_cmd_append_tsf_tlv</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">buffer</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_tsf_timestamp</span> <span class="n">tsf_tlv</span><span class="p">;</span>
	<span class="n">__le64</span> <span class="n">tsf_val</span><span class="p">;</span>

	<span class="cm">/* Null Checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsf_tlv</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_tsf_timestamp</span><span class="p">));</span>

	<span class="n">tsf_tlv</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_TSFTIMESTAMP</span><span class="p">);</span>
	<span class="n">tsf_tlv</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsf_val</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsf_tlv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsf_tlv</span><span class="p">.</span><span class="n">header</span><span class="p">));</span>
	<span class="o">*</span><span class="n">buffer</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsf_tlv</span><span class="p">.</span><span class="n">header</span><span class="p">);</span>

	<span class="cm">/* TSF at the time when beacon/probe_response was received */</span>
	<span class="n">tsf_val</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">fw_tsf</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsf_val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsf_val</span><span class="p">));</span>
	<span class="o">*</span><span class="n">buffer</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsf_val</span><span class="p">);</span>

	<span class="n">tsf_val</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;info: %s: TSF offset calc: %016llx - %016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">fw_tsf</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsf_val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsf_val</span><span class="p">));</span>
	<span class="o">*</span><span class="n">buffer</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsf_val</span><span class="p">);</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsf_tlv</span><span class="p">.</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsf_val</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function finds out the common rates between rate1 and rate2.</span>
<span class="cm"> *</span>
<span class="cm"> * It will fill common rates in rate1 as output if found.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Setting the MSB of the basic rates needs to be taken</span>
<span class="cm"> * care of, either before or after calling this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_get_common_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rate1</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">rate1_size</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rate2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate2_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">rate1</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">rate1</span><span class="p">,</span> <span class="n">rate1_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to alloc tmp buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rate1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rate1_size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rate2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rate2_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rate1_size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check common rate, excluding the bit for</span>
<span class="cm">			   basic rate */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rate2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">rate1</span><span class="o">++</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: Tx data rate set to %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_data_rate_auto</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">ptr</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;previously set fixed data rate %#x&quot;</span>
			<span class="s">&quot; is not compatible with the network</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function creates the intersection of the rates supported by a</span>
<span class="cm"> * target BSS and our adapter settings for use in an assoc/join command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_setup_rates_from_bssdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="o">*</span><span class="n">out_rates</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">out_rates_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">card_rates</span><span class="p">[</span><span class="n">MWIFIEX_SUPPORTED_RATES</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">card_rates_size</span><span class="p">;</span>

	<span class="cm">/* Copy AP supported rates */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">out_rates</span><span class="p">,</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">,</span> <span class="n">MWIFIEX_SUPPORTED_RATES</span><span class="p">);</span>
	<span class="cm">/* Get the STA supported rates */</span>
	<span class="n">card_rates_size</span> <span class="o">=</span> <span class="n">mwifiex_get_active_data_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">card_rates</span><span class="p">);</span>
	<span class="cm">/* Get the common rates between AP and STA supported rates */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_get_common_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">out_rates</span><span class="p">,</span> <span class="n">MWIFIEX_SUPPORTED_RATES</span><span class="p">,</span>
				     <span class="n">card_rates</span><span class="p">,</span> <span class="n">card_rates_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">out_rates_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cannot get common rates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">out_rates_size</span> <span class="o">=</span>
		<span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">out_rates</span><span class="p">),</span> <span class="n">MWIFIEX_SUPPORTED_RATES</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function appends a WPS IE. It is called from the network join command</span>
<span class="cm"> * preparation routine.</span>
<span class="cm"> *</span>
<span class="cm"> * If the IE buffer has been setup by the application, this routine appends</span>
<span class="cm"> * the buffer as a WPS TLV type to the request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_cmd_append_wps_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span> <span class="n">ie_header</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span> <span class="o">||</span> <span class="o">!*</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is a wps ie buffer setup, append it to the return</span>
<span class="cm">	 * parameter buffer pointer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: append wps ie %d to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie_len</span><span class="p">,</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>

		<span class="cm">/* Wrap the generic IE buffer with a pass through TLV type */</span>
		<span class="n">ie_header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_MGMT_IE</span><span class="p">);</span>
		<span class="n">ie_header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ie_header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ie_header</span><span class="p">));</span>
		<span class="o">*</span><span class="n">buffer</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ie_header</span><span class="p">);</span>
		<span class="n">retLen</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ie_header</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie_len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">buffer</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie_len</span><span class="p">;</span>
		<span class="n">retLen</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie_len</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retLen</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function appends a WAPI IE.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called from the network join command preparation routine.</span>
<span class="cm"> *</span>
<span class="cm"> * If the IE buffer has been setup by the application, this routine appends</span>
<span class="cm"> * the buffer as a WAPI TLV type to the request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_cmd_append_wapi_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retLen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span> <span class="n">ie_header</span><span class="p">;</span>

	<span class="cm">/* Null Checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is a wapi ie buffer setup, append it to the return</span>
<span class="cm">	 *   parameter buffer pointer.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wapi_ie_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: append wapi ie %d to %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wapi_ie_len</span><span class="p">,</span> <span class="o">*</span><span class="n">buffer</span><span class="p">);</span>

		<span class="cm">/* Wrap the generic IE buffer with a pass through TLV type */</span>
		<span class="n">ie_header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_WAPI_IE</span><span class="p">);</span>
		<span class="n">ie_header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wapi_ie_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ie_header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ie_header</span><span class="p">));</span>

		<span class="cm">/* Increment the return size and the return buffer pointer</span>
<span class="cm">		   param */</span>
		<span class="o">*</span><span class="n">buffer</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ie_header</span><span class="p">);</span>
		<span class="n">retLen</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ie_header</span><span class="p">);</span>

		<span class="cm">/* Copy the wapi IE buffer to the output buffer, advance</span>
<span class="cm">		   pointer */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wapi_ie</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wapi_ie_len</span><span class="p">);</span>

		<span class="cm">/* Increment the return size and the return buffer pointer</span>
<span class="cm">		   param */</span>
		<span class="o">*</span><span class="n">buffer</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wapi_ie_len</span><span class="p">;</span>
		<span class="n">retLen</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wapi_ie_len</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="cm">/* return the length appended to the buffer */</span>
	<span class="k">return</span> <span class="n">retLen</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function appends rsn ie tlv for wpa/wpa2 security modes.</span>
<span class="cm"> * It is called from the network join command preparation routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_append_rsn_ie_wpa_wpa2</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="o">**</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_rsn_param_set</span> <span class="o">*</span><span class="n">rsn_ie_tlv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rsn_ie_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rsn_ie_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_rsn_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">rsn_ie_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">rsn_ie_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
				 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsn_ie_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>
	<span class="n">rsn_ie_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">rsn_ie_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsn_ie_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
							 <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsn_ie_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rsn_ie_tlv</span><span class="o">-&gt;</span><span class="n">rsn_ie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsn_ie_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsn_ie_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rsn_ie_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="o">*</span><span class="n">buffer</span> <span class="o">+=</span> <span class="n">rsn_ie_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rsn_ie_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command for association.</span>
<span class="cm"> *</span>
<span class="cm"> * This sets the following parameters -</span>
<span class="cm"> *      - Peer MAC address</span>
<span class="cm"> *      - Listen interval</span>
<span class="cm"> *      - Beacon interval</span>
<span class="cm"> *      - Capability information</span>
<span class="cm"> *</span>
<span class="cm"> * ...and the following TLVs, as required -</span>
<span class="cm"> *      - SSID TLV</span>
<span class="cm"> *      - PHY TLV</span>
<span class="cm"> *      - SS TLV</span>
<span class="cm"> *      - Rates TLV</span>
<span class="cm"> *      - Authentication TLV</span>
<span class="cm"> *      - Channel TLV</span>
<span class="cm"> *      - WPA/WPA2 IE</span>
<span class="cm"> *      - 11n TLV</span>
<span class="cm"> *      - Vendor specific TLV</span>
<span class="cm"> *      - WMM TLV</span>
<span class="cm"> *      - WAPI IE</span>
<span class="cm"> *      - Generic IE</span>
<span class="cm"> *      - TSF TLV</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation also includes -</span>
<span class="cm"> *      - Setting command ID and proper size</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_cmd_802_11_associate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_associate</span> <span class="o">*</span><span class="n">assoc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">associate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_ssid_param_set</span> <span class="o">*</span><span class="n">ssid_tlv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_phy_param_set</span> <span class="o">*</span><span class="n">phy_tlv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_ss_param_set</span> <span class="o">*</span><span class="n">ss_tlv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_rates_param_set</span> <span class="o">*</span><span class="n">rates_tlv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_auth_type</span> <span class="o">*</span><span class="n">auth_tlv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_chan_list_param_set</span> <span class="o">*</span><span class="n">chan_tlv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="n">MWIFIEX_SUPPORTED_RATES</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">rates_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp_cap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">assoc</span><span class="p">;</span>

	<span class="n">mwifiex_cfg_tx_buf</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_ASSOCIATE</span><span class="p">);</span>

	<span class="cm">/* Save so we know which BSS Desc to use in the response handler */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">attempted_bss_desc</span> <span class="o">=</span> <span class="n">bss_desc</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">peer_sta_addr</span><span class="p">,</span>
	       <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">peer_sta_addr</span><span class="p">));</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">peer_sta_addr</span><span class="p">);</span>

	<span class="cm">/* Set the listen interval */</span>
	<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">);</span>
	<span class="cm">/* Set the beacon period */</span>
	<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">cap_info_bitmap</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">assoc</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">);</span>

	<span class="n">ssid_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_ssid_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_EID_SSID</span><span class="p">);</span>
	<span class="n">ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ssid_tlv</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
	       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">));</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">phy_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_phy_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">phy_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_EID_DS_PARAMS</span><span class="p">);</span>
	<span class="n">phy_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">phy_tlv</span><span class="o">-&gt;</span><span class="n">fh_ds</span><span class="p">.</span><span class="n">ds_param_set</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy_tlv</span><span class="o">-&gt;</span><span class="n">fh_ds</span><span class="p">.</span><span class="n">ds_param_set</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">.</span><span class="n">ds_param_set</span><span class="p">.</span><span class="n">current_chan</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">phy_tlv</span><span class="o">-&gt;</span><span class="n">fh_ds</span><span class="p">.</span><span class="n">ds_param_set</span><span class="p">));</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phy_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">phy_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">ss_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_ss_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">ss_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_EID_CF_PARAMS</span><span class="p">);</span>
	<span class="n">ss_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ss_tlv</span><span class="o">-&gt;</span><span class="n">cf_ibss</span><span class="p">.</span><span class="n">cf_param_set</span><span class="p">));</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ss_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ss_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Get the common rates supported between the driver and the BSS Desc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_setup_rates_from_bssdesc</span>
	    <span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates_size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Save the data rates into Current BSS state structure */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">num_of_rates</span> <span class="o">=</span> <span class="n">rates_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">data_rates</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="n">rates_size</span><span class="p">);</span>

	<span class="cm">/* Setup the Rates TLV in the association command */</span>
	<span class="n">rates_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_rates_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">rates_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_EID_SUPP_RATES</span><span class="p">);</span>
	<span class="n">rates_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">rates_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rates_tlv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="n">rates_size</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rates_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">rates_size</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ASSOC_CMD: rates size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rates_size</span><span class="p">);</span>

	<span class="cm">/* Add the Authentication type to be used for Auth frames */</span>
	<span class="n">auth_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_auth_type</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">auth_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_AUTH_TYPE</span><span class="p">);</span>
	<span class="n">auth_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">auth_tlv</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span><span class="p">)</span>
		<span class="n">auth_tlv</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
				<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">authentication_mode</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">auth_tlv</span><span class="o">-&gt;</span><span class="n">auth_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">NL80211_AUTHTYPE_OPEN_SYSTEM</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">auth_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">auth_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_SUPPORT_MULTI_BANDS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ISSUPP_11NENABLED</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_cap_info</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">disable_11n</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">&amp;</span> <span class="n">BAND_GN</span> <span class="o">||</span>
	     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">&amp;</span> <span class="n">BAND_AN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_ht_cap</span><span class="p">)</span>
	    <span class="p">)</span>
		<span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Append a channel TLV for the channel the attempted AP was</span>
<span class="cm">		   found on */</span>
		<span class="n">chan_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_chan_list_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_CHANLIST</span><span class="p">);</span>
		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">));</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">));</span>
		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">chan_number</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">.</span><span class="n">ds_param_set</span><span class="p">.</span><span class="n">current_chan</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: Assoc: TLV Chan = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">chan_number</span><span class="p">);</span>

		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">radio_type</span> <span class="o">=</span>
			<span class="n">mwifiex_band_to_radio_type</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bss_band</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: Assoc: TLV Band = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">radio_type</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps</span><span class="p">.</span><span class="n">session_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span><span class="p">)</span>
			<span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="n">mwifiex_append_rsn_ie_wpa_wpa2</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rsn_ie_len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISSUPP_11NENABLED</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_cap_info</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">disable_11n</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">&amp;</span> <span class="n">BAND_GN</span> <span class="o">||</span>
	     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">&amp;</span> <span class="n">BAND_AN</span><span class="p">))</span>
		<span class="n">mwifiex_cmd_append_11n_tlv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="cm">/* Append vendor specific IE TLV */</span>
	<span class="n">mwifiex_cmd_append_vsie_tlv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MWIFIEX_VSIE_MASK_ASSOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">mwifiex_wmm_process_association_req</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">wmm_ie</span><span class="p">,</span>
					    <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_ht_cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wapi_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wapi_ie_len</span><span class="p">)</span>
		<span class="n">mwifiex_cmd_append_wapi_ie</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps</span><span class="p">.</span><span class="n">session_enable</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie_len</span><span class="p">)</span>
		<span class="n">mwifiex_cmd_append_wps_ie</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">mwifiex_cmd_append_generic_ie</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">mwifiex_cmd_append_tsf_tlv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">assoc</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>

	<span class="cm">/* Set the Capability info at last */</span>
	<span class="n">tmp_cap</span> <span class="o">=</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">cap_info_bitmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">==</span> <span class="n">BAND_B</span><span class="p">)</span>
		<span class="n">tmp_cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">;</span>

	<span class="n">tmp_cap</span> <span class="o">&amp;=</span> <span class="n">CAPINFO_MASK</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ASSOC_CMD: tmp_cap=%4X CAPINFO_MASK=%4lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tmp_cap</span><span class="p">,</span> <span class="n">CAPINFO_MASK</span><span class="p">);</span>
	<span class="n">assoc</span><span class="o">-&gt;</span><span class="n">cap_info_bitmap</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tmp_cap</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Association firmware command response handler</span>
<span class="cm"> *</span>
<span class="cm"> * The response buffer for the association command has the following</span>
<span class="cm"> * memory layout.</span>
<span class="cm"> *</span>
<span class="cm"> * For cases where an association response was not received (indicated</span>
<span class="cm"> * by the CapInfo and AId field):</span>
<span class="cm"> *</span>
<span class="cm"> *     .------------------------------------------------------------.</span>
<span class="cm"> *     |  Header(4 * sizeof(t_u16)):  Standard command response hdr |</span>
<span class="cm"> *     .------------------------------------------------------------.</span>
<span class="cm"> *     |  cap_info/Error Return(t_u16):                             |</span>
<span class="cm"> *     |           0xFFFF(-1): Internal error                       |</span>
<span class="cm"> *     |           0xFFFE(-2): Authentication unhandled message     |</span>
<span class="cm"> *     |           0xFFFD(-3): Authentication refused               |</span>
<span class="cm"> *     |           0xFFFC(-4): Timeout waiting for AP response      |</span>
<span class="cm"> *     .------------------------------------------------------------.</span>
<span class="cm"> *     |  status_code(t_u16):                                       |</span>
<span class="cm"> *     |        If cap_info is -1:                                  |</span>
<span class="cm"> *     |           An internal firmware failure prevented the       |</span>
<span class="cm"> *     |           command from being processed.  The status_code   |</span>
<span class="cm"> *     |           will be set to 1.                                |</span>
<span class="cm"> *     |                                                            |</span>
<span class="cm"> *     |        If cap_info is -2:                                  |</span>
<span class="cm"> *     |           An authentication frame was received but was     |</span>
<span class="cm"> *     |           not handled by the firmware.  IEEE Status        |</span>
<span class="cm"> *     |           code for the failure is returned.                |</span>
<span class="cm"> *     |                                                            |</span>
<span class="cm"> *     |        If cap_info is -3:                                  |</span>
<span class="cm"> *     |           An authentication frame was received and the     |</span>
<span class="cm"> *     |           status_code is the IEEE Status reported in the   |</span>
<span class="cm"> *     |           response.                                        |</span>
<span class="cm"> *     |                                                            |</span>
<span class="cm"> *     |        If cap_info is -4:                                  |</span>
<span class="cm"> *     |           (1) Association response timeout                 |</span>
<span class="cm"> *     |           (2) Authentication response timeout              |</span>
<span class="cm"> *     .------------------------------------------------------------.</span>
<span class="cm"> *     |  a_id(t_u16): 0xFFFF                                       |</span>
<span class="cm"> *     .------------------------------------------------------------.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * For cases where an association response was received, the IEEE</span>
<span class="cm"> * standard association response frame is returned:</span>
<span class="cm"> *</span>
<span class="cm"> *     .------------------------------------------------------------.</span>
<span class="cm"> *     |  Header(4 * sizeof(t_u16)):  Standard command response hdr |</span>
<span class="cm"> *     .------------------------------------------------------------.</span>
<span class="cm"> *     |  cap_info(t_u16): IEEE Capability                          |</span>
<span class="cm"> *     .------------------------------------------------------------.</span>
<span class="cm"> *     |  status_code(t_u16): IEEE Status Code                      |</span>
<span class="cm"> *     .------------------------------------------------------------.</span>
<span class="cm"> *     |  a_id(t_u16): IEEE Association ID                          |</span>
<span class="cm"> *     .------------------------------------------------------------.</span>
<span class="cm"> *     |  IEEE IEs(variable): Any received IEs comprising the       |</span>
<span class="cm"> *     |                      remaining portion of a received       |</span>
<span class="cm"> *     |                      association response frame.           |</span>
<span class="cm"> *     .------------------------------------------------------------.</span>
<span class="cm"> *</span>
<span class="cm"> * For simplistic handling, the status_code field can be used to determine</span>
<span class="cm"> * an association success (0) or failure (non-zero).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_ret_802_11_associate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee_types_assoc_rsp</span> <span class="o">*</span><span class="n">assoc_rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enable_data</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">assoc_rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_assoc_rsp</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_rsp_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">-</span> <span class="n">S_DS_GEN</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_rsp_buf</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_rsp_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_rsp_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="o">-&gt;</span><span class="n">status_code</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">num_cmd_assoc_failure</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;ASSOC_RESP: failed, status code=%d err=%#x a_id=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="o">-&gt;</span><span class="n">status_code</span><span class="p">),</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="o">-&gt;</span><span class="n">cap_info_bitmap</span><span class="p">),</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="o">-&gt;</span><span class="n">a_id</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">assoc_rsp</span><span class="o">-&gt;</span><span class="n">status_code</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send a Media Connected event, according to the Spec */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">media_connected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_state</span> <span class="o">=</span> <span class="n">PS_STATE_AWAKE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pps_uapsd_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_lock_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Set the attempted BSSID Index to current */</span>
	<span class="n">bss_desc</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">attempted_bss_desc</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ASSOC_RESP: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>

	<span class="cm">/* Make a copy of current BSSID descriptor */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">,</span>
	       <span class="n">bss_desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span><span class="p">));</span>

	<span class="cm">/* Update curr_bss_params */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">channel</span>
		<span class="o">=</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">.</span><span class="n">ds_param_set</span><span class="p">.</span><span class="n">current_chan</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bss_band</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">wmm_ie</span><span class="p">.</span><span class="n">vend_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">==</span> <span class="n">WLAN_EID_VENDOR_SPECIFIC</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">wmm_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">wmm_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_required</span> <span class="o">||</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_ht_cap</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">wmm_enabled</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">wmm_uapsd_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_enabled</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">wmm_uapsd_enabled</span>
			<span class="o">=</span> <span class="p">((</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">wmm_ie</span><span class="p">.</span><span class="n">qos_info_bitmap</span> <span class="o">&amp;</span>
				<span class="n">IEEE80211_WMM_IE_AP_QOSINFO_UAPSD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ASSOC_RESP: curr_pkt_filter is %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_pkt_filter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_is_gtk_set</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t re-enable carrier until we get the WMM_GET_STATUS</span>
<span class="cm">		   event */</span>
		<span class="n">enable_data</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Since WMM is not enabled, setup the queues with the</span>
<span class="cm">		   defaults */</span>
		<span class="n">mwifiex_wmm_setup_queue_priorities</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">mwifiex_wmm_setup_ac_downgrade</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_data</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;info: post association, re-enabling data flow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Reset SNR/NF/RSSI values */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_rssi_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_nf_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_rssi_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_nf_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_rssi_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_nf_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_rssi_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_nf_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxpd_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxpd_htinfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mwifiex_save_curr_bcn</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">num_cmd_assoc_success</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ASSOC_RESP: associated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Add the ra_list here for infra mode as there will be only 1 ra</span>
<span class="cm">	   always */</span>
	<span class="n">mwifiex_ralist_add</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">mac_address</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_block</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="cm">/* Need to indicate IOCTL complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command for ad-hoc start.</span>
<span class="cm"> *</span>
<span class="cm"> * Driver will fill up SSID, BSS mode, IBSS parameters, physical</span>
<span class="cm"> * parameters, probe delay, and capability information. Firmware</span>
<span class="cm"> * will fill up beacon period, basic rates and operational rates.</span>
<span class="cm"> *</span>
<span class="cm"> * In addition, the following TLVs are added -</span>
<span class="cm"> *      - Channel TLV</span>
<span class="cm"> *      - Vendor specific IE</span>
<span class="cm"> *      - WPA/WPA2 IE</span>
<span class="cm"> *      - HT Capabilities IE</span>
<span class="cm"> *      - HT Information IE</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation also includes -</span>
<span class="cm"> *      - Setting command ID and proper size</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mwifiex_cmd_802_11_ad_hoc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cfg80211_ssid</span> <span class="o">*</span><span class="n">req_ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ad_hoc_start</span> <span class="o">*</span><span class="n">adhoc_start</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">adhoc_start</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_append_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp_cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_chan_list_param_set</span> <span class="o">*</span><span class="n">chan_tlv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">radio_type</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mwifiex_ie_types_htcap</span> <span class="o">*</span><span class="n">ht_cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_htinfo</span> <span class="o">*</span><span class="n">ht_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">adhoc_start</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ad_hoc_start</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_AD_HOC_START</span><span class="p">);</span>

	<span class="n">bss_desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">attempted_bss_desc</span> <span class="o">=</span> <span class="n">bss_desc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill in the parameters for 2 data structures:</span>
<span class="cm">	 *   1. struct host_cmd_ds_802_11_ad_hoc_start command</span>
<span class="cm">	 *   2. bss_desc</span>
<span class="cm">	 * Driver will fill up SSID, bss_mode,IBSS param, Physical Param,</span>
<span class="cm">	 * probe delay, and Cap info.</span>
<span class="cm">	 * Firmware will fill up beacon period, Basic rates</span>
<span class="cm">	 * and operational rates.</span>
<span class="cm">	 */</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">req_ssid</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">req_ssid</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_S_CMD: SSID = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">req_ssid</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">req_ssid</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>

	<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">req_ssid</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>

	<span class="cm">/* Set the BSS mode */</span>
	<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">=</span> <span class="n">HostCmd_BSS_MODE_IBSS</span><span class="p">;</span>
	<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">;</span>
	<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">);</span>
	<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">;</span>

	<span class="cm">/* Set Physical param set */</span>
<span class="cm">/* Parameter IE Id */</span>
<span class="cp">#define DS_PARA_IE_ID   3</span>
<span class="cm">/* Parameter IE length */</span>
<span class="cp">#define DS_PARA_IE_LEN  1</span>

	<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">.</span><span class="n">ds_param_set</span><span class="p">.</span><span class="n">element_id</span> <span class="o">=</span> <span class="n">DS_PARA_IE_ID</span><span class="p">;</span>
	<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">.</span><span class="n">ds_param_set</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">DS_PARA_IE_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mwifiex_get_cfp</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">mwifiex_chan_freq_power</span> <span class="o">*</span><span class="n">cfp</span><span class="p">;</span>
		<span class="n">cfp</span> <span class="o">=</span> <span class="n">mwifiex_get_cfp</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span><span class="p">,</span>
				      <span class="n">FIRST_VALID_CHANNEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cfp</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">cfp</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ADHOC_S_CMD: adhoc_channel cannot be 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_S_CMD: creating ADHOC on channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span><span class="p">;</span>

	<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span><span class="p">;</span>
	<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">.</span><span class="n">ds_param_set</span><span class="p">.</span><span class="n">current_chan</span> <span class="o">=</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ieee_types_phy_param_set</span><span class="p">));</span>

	<span class="cm">/* Set IBSS param set */</span>
<span class="cm">/* IBSS parameter IE Id */</span>
<span class="cp">#define IBSS_PARA_IE_ID   6</span>
<span class="cm">/* IBSS parameter IE length */</span>
<span class="cp">#define IBSS_PARA_IE_LEN  2</span>

	<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">ss_param_set</span><span class="p">.</span><span class="n">ibss_param_set</span><span class="p">.</span><span class="n">element_id</span> <span class="o">=</span> <span class="n">IBSS_PARA_IE_ID</span><span class="p">;</span>
	<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">ss_param_set</span><span class="p">.</span><span class="n">ibss_param_set</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IBSS_PARA_IE_LEN</span><span class="p">;</span>
	<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">ss_param_set</span><span class="p">.</span><span class="n">ibss_param_set</span><span class="p">.</span><span class="n">atim_window</span>
					<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">atim_window</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ss_param_set</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">ss_param_set</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ieee_types_ss_param_set</span><span class="p">));</span>

	<span class="cm">/* Set Capability info */</span>
	<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">cap_info_bitmap</span> <span class="o">|=</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">;</span>
	<span class="n">tmp_cap</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">cap_info_bitmap</span><span class="p">);</span>
	<span class="n">tmp_cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WLAN_CAPABILITY_ESS</span><span class="p">;</span>
	<span class="n">tmp_cap</span> <span class="o">|=</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">;</span>

	<span class="cm">/* Set up privacy in bss_desc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">encryption_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ad-Hoc capability privacy on */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;info: ADHOC_S_CMD: wep_status set privacy to WEP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">privacy</span> <span class="o">=</span> <span class="n">MWIFIEX_802_11_PRIV_FILTER_8021X_WEP</span><span class="p">;</span>
		<span class="n">tmp_cap</span> <span class="o">|=</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_S_CMD: wep_status NOT set,&quot;</span>
				<span class="s">&quot; setting privacy to ACCEPT ALL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">privacy</span> <span class="o">=</span> <span class="n">MWIFIEX_802_11_PRIV_FILTER_ACCEPT_ALL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">));</span>
	<span class="n">mwifiex_get_active_data_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">&amp;</span> <span class="n">BAND_G</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_pkt_filter</span> <span class="o">&amp;</span> <span class="n">HostCmd_ACT_MAC_ADHOC_G_PROTECTION_ON</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_MAC_CONTROL</span><span class="p">,</span>
					   <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_pkt_filter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;ADHOC_S_CMD: G Protection config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Find the last non zero */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">num_of_rates</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Copy the ad-hoc creating rates into Current BSS rate structure */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">data_rates</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">num_of_rates</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_S_CMD: rates=%02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">data_rate</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_S_CMD: AD-HOC Start command is ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_SUPPORT_MULTI_BANDS</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Append a channel TLV */</span>
		<span class="n">chan_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_chan_list_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_CHANLIST</span><span class="p">);</span>
		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">));</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">));</span>
		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">chan_number</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_S_CMD: TLV Chan = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">chan_number</span><span class="p">);</span>

		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">radio_type</span>
		       <span class="o">=</span> <span class="n">mwifiex_band_to_radio_type</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">band</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">&amp;</span> <span class="n">BAND_GN</span> <span class="o">||</span>
		    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">&amp;</span> <span class="n">BAND_AN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sec_chan_offset</span> <span class="o">==</span>
					    <span class="n">IEEE80211_HT_PARAM_CHA_SEC_ABOVE</span><span class="p">)</span>
				<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">radio_type</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">IEEE80211_HT_PARAM_CHA_SEC_ABOVE</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sec_chan_offset</span> <span class="o">==</span>
					    <span class="n">IEEE80211_HT_PARAM_CHA_SEC_ABOVE</span><span class="p">)</span>
				<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">radio_type</span> <span class="o">|=</span>
					<span class="p">(</span><span class="n">IEEE80211_HT_PARAM_CHA_SEC_BELOW</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_S_CMD: TLV Band = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">radio_type</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">);</span>
		<span class="n">cmd_append_size</span> <span class="o">+=</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Append vendor specific IE TLV */</span>
	<span class="n">cmd_append_size</span> <span class="o">+=</span> <span class="n">mwifiex_cmd_append_vsie_tlv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				<span class="n">MWIFIEX_VSIE_MASK_ADHOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="n">mwifiex_append_rsn_ie_wpa_wpa2</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsn_ie_len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">cmd_append_size</span> <span class="o">+=</span> <span class="n">rsn_ie_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_11n_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fill HT CAPABILITY */</span>
		<span class="n">ht_cap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_htcap</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ht_cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_htcap</span><span class="p">));</span>
		<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_EID_HT_CAPABILITY</span><span class="p">);</span>
		<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		       <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_cap</span><span class="p">));</span>
		<span class="n">radio_type</span> <span class="o">=</span> <span class="n">mwifiex_band_to_radio_type</span><span class="p">(</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span><span class="p">);</span>
		<span class="n">mwifiex_fill_cap_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">radio_type</span><span class="p">,</span> <span class="n">ht_cap</span><span class="p">);</span>

		<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_htcap</span><span class="p">);</span>
		<span class="n">cmd_append_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_htcap</span><span class="p">);</span>

		<span class="cm">/* Fill HT INFORMATION */</span>
		<span class="n">ht_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_htinfo</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ht_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_htinfo</span><span class="p">));</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_EID_HT_OPERATION</span><span class="p">);</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_operation</span><span class="p">));</span>

		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">ht_oper</span><span class="p">.</span><span class="n">primary_chan</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sec_chan_offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">ht_oper</span><span class="p">.</span><span class="n">ht_param</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sec_chan_offset</span><span class="p">;</span>
			<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">ht_oper</span><span class="p">.</span><span class="n">ht_param</span> <span class="o">|=</span>
					<span class="n">IEEE80211_HT_PARAM_CHAN_WIDTH_ANY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">ht_oper</span><span class="p">.</span><span class="n">operation_mode</span> <span class="o">=</span>
		     <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_HT_OP_MODE_NON_GF_STA_PRSNT</span><span class="p">);</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">ht_oper</span><span class="p">.</span><span class="n">basic_set</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_htinfo</span><span class="p">);</span>
		<span class="n">cmd_append_size</span> <span class="o">+=</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_htinfo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ad_hoc_start</span><span class="p">)</span>
				  <span class="o">+</span> <span class="n">S_DS_GEN</span> <span class="o">+</span> <span class="n">cmd_append_size</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">==</span> <span class="n">BAND_B</span><span class="p">)</span>
		<span class="n">tmp_cap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp_cap</span> <span class="o">|=</span> <span class="n">WLAN_CAPABILITY_SHORT_SLOT_TIME</span><span class="p">;</span>

	<span class="n">adhoc_start</span><span class="o">-&gt;</span><span class="n">cap_info_bitmap</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tmp_cap</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command for ad-hoc join.</span>
<span class="cm"> *</span>
<span class="cm"> * Most of the parameters are set up by copying from the target BSS descriptor</span>
<span class="cm"> * from the scan response.</span>
<span class="cm"> *</span>
<span class="cm"> * In addition, the following TLVs are added -</span>
<span class="cm"> *      - Channel TLV</span>
<span class="cm"> *      - Vendor specific IE</span>
<span class="cm"> *      - WPA/WPA2 IE</span>
<span class="cm"> *      - 11n IE</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation also includes -</span>
<span class="cm"> *      - Setting command ID and proper size</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mwifiex_cmd_802_11_ad_hoc_join</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ad_hoc_join</span> <span class="o">*</span><span class="n">adhoc_join</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">adhoc_join</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_chan_list_param_set</span> <span class="o">*</span><span class="n">chan_tlv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd_append_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp_cap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">rates_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">curr_pkt_filter</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">adhoc_join</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ad_hoc_join</span><span class="p">);</span>

<span class="cm">/* Use G protection */</span>
<span class="cp">#define USE_G_PROTECTION        0x02</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">erp_flags</span> <span class="o">&amp;</span> <span class="n">USE_G_PROTECTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">curr_pkt_filter</span> <span class="o">=</span>
			<span class="n">priv</span><span class="o">-&gt;</span>
			<span class="n">curr_pkt_filter</span> <span class="o">|</span> <span class="n">HostCmd_ACT_MAC_ADHOC_G_PROTECTION_ON</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_MAC_CONTROL</span><span class="p">,</span>
					   <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">curr_pkt_filter</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;ADHOC_J_CMD: G Protection config failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">attempted_bss_desc</span> <span class="o">=</span> <span class="n">bss_desc</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_AD_HOC_JOIN</span><span class="p">);</span>

	<span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">bss_mode</span> <span class="o">=</span> <span class="n">HostCmd_BSS_MODE_IBSS</span><span class="p">;</span>

	<span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">beacon_period</span>
		<span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">phy_param_set</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ieee_types_phy_param_set</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">ss_param_set</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ss_param_set</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">ieee_types_ss_param_set</span><span class="p">));</span>

	<span class="n">tmp_cap</span> <span class="o">=</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">cap_info_bitmap</span><span class="p">;</span>

	<span class="n">tmp_cap</span> <span class="o">&amp;=</span> <span class="n">CAPINFO_MASK</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;info: ADHOC_J_CMD: tmp_cap=%4X CAPINFO_MASK=%4lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tmp_cap</span><span class="p">,</span> <span class="n">CAPINFO_MASK</span><span class="p">);</span>

	<span class="cm">/* Information on BSSID descriptor passed to FW */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_J_CMD: BSSID=%pM, SSID=&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
		<span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			<span class="n">i</span> <span class="o">&lt;</span> <span class="n">MWIFIEX_SUPPORTED_RATES</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="p">;</span>
	<span class="n">rates_size</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Copy Data Rates from the Rates recorded in scan response */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">data_rates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">data_rates</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">data_rates</span><span class="p">,</span>
	       <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">,</span> <span class="n">rates_size</span><span class="p">);</span>

	<span class="cm">/* Copy the adhoc join rates into Current BSS state structure */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">num_of_rates</span> <span class="o">=</span> <span class="n">rates_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">data_rates</span><span class="p">,</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">,</span>
	       <span class="n">rates_size</span><span class="p">);</span>

	<span class="cm">/* Copy the channel information */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bss_band</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span><span class="p">)</span>
		<span class="n">tmp_cap</span> <span class="o">|=</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_SUPPORT_MULTI_BANDS</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Append a channel TLV */</span>
		<span class="n">chan_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_chan_list_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_CHANLIST</span><span class="p">);</span>
		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">));</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">));</span>
		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">chan_number</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">.</span><span class="n">ds_param_set</span><span class="p">.</span><span class="n">current_chan</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_J_CMD: TLV Chan=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">chan_number</span><span class="p">);</span>

		<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">radio_type</span> <span class="o">=</span>
			<span class="n">mwifiex_band_to_radio_type</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bss_band</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_J_CMD: TLV Band=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">radio_type</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">);</span>
		<span class="n">cmd_append_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chan_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span><span class="p">)</span>
		<span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="n">mwifiex_append_rsn_ie_wpa_wpa2</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsn_ie_len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd_append_size</span> <span class="o">+=</span> <span class="n">rsn_ie_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISSUPP_11NENABLED</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_cap_info</span><span class="p">))</span>
		<span class="n">cmd_append_size</span> <span class="o">+=</span> <span class="n">mwifiex_cmd_append_11n_tlv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="n">bss_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="cm">/* Append vendor specific IE TLV */</span>
	<span class="n">cmd_append_size</span> <span class="o">+=</span> <span class="n">mwifiex_cmd_append_vsie_tlv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="n">MWIFIEX_VSIE_MASK_ADHOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span>
		<span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ad_hoc_join</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">S_DS_GEN</span> <span class="o">+</span> <span class="n">cmd_append_size</span><span class="p">));</span>

	<span class="n">adhoc_join</span><span class="o">-&gt;</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">cap_info_bitmap</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tmp_cap</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles the command response of ad-hoc start and</span>
<span class="cm"> * ad-hoc join.</span>
<span class="cm"> *</span>
<span class="cm"> * The function generates a device-connected event to notify</span>
<span class="cm"> * the applications, in case of successful ad-hoc start/join, and</span>
<span class="cm"> * saves the beacon buffer.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_ret_802_11_ad_hoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ad_hoc_result</span> <span class="o">*</span><span class="n">adhoc_result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">;</span>

	<span class="n">adhoc_result</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">adhoc_result</span><span class="p">;</span>

	<span class="n">bss_desc</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">attempted_bss_desc</span><span class="p">;</span>

	<span class="cm">/* Join result code 0 --&gt; SUCCESS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ADHOC_RESP: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">media_connected</span><span class="p">)</span>
			<span class="n">mwifiex_reset_connect_state</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">,</span>
		       <span class="mh">0x00</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send a Media Connected event, according to the Spec */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">media_connected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span> <span class="o">==</span> <span class="n">HostCmd_CMD_802_11_AD_HOC_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_S_RESP %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>

		<span class="cm">/* Update the created network descriptor with the new BSSID */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">,</span>
		       <span class="n">adhoc_result</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_state</span> <span class="o">=</span> <span class="n">ADHOC_STARTED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Now the join cmd should be successful.</span>
<span class="cm">		 * If BSSID has changed use SSID to compare instead of BSSID</span>
<span class="cm">		 */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_J_RESP %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Make a copy of current BSSID descriptor, only needed for</span>
<span class="cm">		 * join since the current descriptor is already being used</span>
<span class="cm">		 * for adhoc start</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">,</span>
		       <span class="n">bss_desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span><span class="p">));</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_state</span> <span class="o">=</span> <span class="n">ADHOC_JOINED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_RESP: channel = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_RESP: BSSID = %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">mac_address</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">mwifiex_save_curr_bcn</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="cm">/* Need to indicate IOCTL complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function associates to a specific BSS discovered in a scan.</span>
<span class="cm"> *</span>
<span class="cm"> * It clears any past association response stored for application</span>
<span class="cm"> * retrieval and calls the command preparation routine to send the</span>
<span class="cm"> * command to firmware.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_associate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">current_bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="cm">/* Return error if the adapter or table entry is not marked as infra */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_bssid</span><span class="p">,</span>
	       <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">mac_address</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">current_bssid</span><span class="p">));</span>

	<span class="cm">/* Clear any past association response stored for application</span>
<span class="cm">	   retrieval */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_rsp_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mwifiex_send_cmd_sync</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_802_11_ASSOCIATE</span><span class="p">,</span>
				    <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function starts an ad-hoc network.</span>
<span class="cm"> *</span>
<span class="cm"> * It calls the command preparation routine to send the command to firmware.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mwifiex_adhoc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">cfg80211_ssid</span> <span class="o">*</span><span class="n">adhoc_ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: Adhoc Channel = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: curr_bss_params.channel = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: curr_bss_params.band = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">band</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mwifiex_send_cmd_sync</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_802_11_AD_HOC_START</span><span class="p">,</span>
				    <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">adhoc_ssid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function joins an ad-hoc network found in a previous scan.</span>
<span class="cm"> *</span>
<span class="cm"> * It calls the command preparation routine to send the command to firmware,</span>
<span class="cm"> * if already not connected to the requested SSID.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_adhoc_join</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: adhoc join: curr_bss ssid =%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: adhoc join: curr_bss ssid_len =%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: adhoc join: ssid =%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: adhoc join: ssid_len =%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">);</span>

	<span class="cm">/* Check if the requested SSID is already joined */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">mwifiex_ssid_cmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">ssid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">bss_mode</span> <span class="o">==</span>
							<span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: ADHOC_J_CMD: new ad-hoc SSID&quot;</span>
			<span class="s">&quot; is the same as current; not attempting to re-join</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: curr_bss_params.channel = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: curr_bss_params.band = %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">band</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mwifiex_send_cmd_sync</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_802_11_AD_HOC_JOIN</span><span class="p">,</span>
				    <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function deauthenticates/disconnects from infra network by sending</span>
<span class="cm"> * deauthentication request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_deauthenticate_infra</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mac_address</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">zero_mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">zero_mac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">zero_mac</span><span class="p">)))</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">mac_address</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span>
			       <span class="n">mac_address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">mac_address</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">mac_address</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span>
		       <span class="n">bss_descriptor</span><span class="p">.</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_sync</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_802_11_DEAUTHENTICATE</span><span class="p">,</span>
				    <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_address</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function deauthenticates/disconnects from a BSS.</span>
<span class="cm"> *</span>
<span class="cm"> * In case of infra made, it sends deauthentication request, and</span>
<span class="cm"> * in case of ad-hoc mode, a stop network request is sent to the firmware.</span>
<span class="cm"> * In AP mode, a command to stop bss is sent to firmware.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_deauthenticate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">media_connected</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="k">return</span> <span class="n">mwifiex_deauthenticate_infra</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="k">return</span> <span class="n">mwifiex_send_cmd_sync</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					     <span class="n">HostCmd_CMD_802_11_AD_HOC_STOP</span><span class="p">,</span>
					     <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="k">return</span> <span class="n">mwifiex_send_cmd_sync</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_UAP_BSS_STOP</span><span class="p">,</span>
					     <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mwifiex_deauthenticate</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This function converts band to radio type used in channel TLV.</span>
<span class="cm"> */</span>
<span class="n">u8</span>
<span class="nf">mwifiex_band_to_radio_type</span><span class="p">(</span><span class="n">u8</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BAND_A</span>:
	<span class="k">case</span> <span class="n">BAND_AN</span>:
	<span class="k">case</span> <span class="n">BAND_A</span> <span class="o">|</span> <span class="n">BAND_AN</span>:
		<span class="k">return</span> <span class="n">HostCmd_SCAN_RADIO_TYPE_A</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BAND_B</span>:
	<span class="k">case</span> <span class="n">BAND_G</span>:
	<span class="k">case</span> <span class="n">BAND_B</span> <span class="o">|</span> <span class="n">BAND_G</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">HostCmd_SCAN_RADIO_TYPE_BG</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
