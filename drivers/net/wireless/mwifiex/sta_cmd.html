<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › mwifiex › sta_cmd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>sta_cmd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Marvell Wireless LAN device driver: station command handling</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011, Marvell International Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This software file (the &quot;File&quot;) is distributed by Marvell International</span>
<span class="cm"> * Ltd. under the terms of the GNU General Public License Version 2, June 1991</span>
<span class="cm"> * (the &quot;License&quot;).  You may use, redistribute and/or modify this File in</span>
<span class="cm"> * accordance with the terms and conditions of the License, a copy of which</span>
<span class="cm"> * is available by writing to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA or on the</span>
<span class="cm"> * worldwide web at http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.</span>
<span class="cm"> *</span>
<span class="cm"> * THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE EXPRESSLY DISCLAIMED.  The License provides additional details about</span>
<span class="cm"> * this warranty disclaimer.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;decl.h&quot;</span>
<span class="cp">#include &quot;ioctl.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;fw.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;wmm.h&quot;</span>
<span class="cp">#include &quot;11n.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set/get RSSI information.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting data/beacon average factors</span>
<span class="cm"> *      - Resetting SNR/NF/RSSI values in private structure</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_cmd_802_11_rssi_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_RSSI_INFO</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_rssi_info</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rssi_info</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rssi_info</span><span class="p">.</span><span class="n">ndata</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_avg_factor</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rssi_info</span><span class="p">.</span><span class="n">nbcn</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_avg_factor</span><span class="p">);</span>

	<span class="cm">/* Reset SNR/NF/RSSI values in private structure */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_rssi_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_nf_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_rssi_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_nf_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_rssi_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_nf_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_rssi_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_nf_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set MAC control.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_mac_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_mac_control</span> <span class="o">*</span><span class="n">mac_ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mac_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_action</span> <span class="o">!=</span> <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;mac_control: only support set cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_MAC_CONTROL</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_mac_control</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="n">mac_ctrl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">action</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set/get SNMP MIB.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting SNMP MIB OID number and value</span>
<span class="cm"> *        (as required)</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> *</span>
<span class="cm"> * The following SNMP MIB OIDs are supported -</span>
<span class="cm"> *      - FRAG_THRESH_I     : Fragmentation threshold</span>
<span class="cm"> *      - RTS_THRESH_I      : RTS threshold</span>
<span class="cm"> *      - SHORT_RETRY_LIM_I : Short retry limit</span>
<span class="cm"> *      - DOT11D_I          : 11d support</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_802_11_snmp_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				       <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd_oid</span><span class="p">,</span>
				       <span class="n">u16</span> <span class="o">*</span><span class="n">ul_temp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_snmp_mib</span> <span class="o">*</span><span class="n">snmp_mib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">smib</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: SNMP_CMD: cmd_oid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd_oid</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_SNMP_MIB</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_snmp_mib</span><span class="p">)</span>
				<span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>

	<span class="n">snmp_mib</span><span class="o">-&gt;</span><span class="n">oid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">cmd_oid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_action</span> <span class="o">==</span> <span class="n">HostCmd_ACT_GEN_GET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snmp_mib</span><span class="o">-&gt;</span><span class="n">query_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_ACT_GEN_GET</span><span class="p">);</span>
		<span class="n">snmp_mib</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MAX_SNMP_BUF_SIZE</span><span class="p">);</span>
		<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">MAX_SNMP_BUF_SIZE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_action</span> <span class="o">==</span> <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snmp_mib</span><span class="o">-&gt;</span><span class="n">query_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_ACT_GEN_SET</span><span class="p">);</span>
		<span class="n">snmp_mib</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>
		<span class="o">*</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">snmp_mib</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">))</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">ul_temp</span><span class="p">);</span>
		<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;cmd: SNMP_CMD: Action=0x%x, OID=0x%x, OIDSize=0x%x,&quot;</span>
		<span class="s">&quot; Value=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd_action</span><span class="p">,</span> <span class="n">cmd_oid</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">snmp_mib</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">),</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">snmp_mib</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to get log.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID and proper size</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_cmd_802_11_get_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_GET_LOG</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_get_log</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set/get Tx data rate configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting configuration index, rate scope and rate drop pattern</span>
<span class="cm"> *        parameters (as required)</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_tx_rate_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">pbitmap_rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_tx_rate_cfg</span> <span class="o">*</span><span class="n">rate_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tx_rate_cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_rate_scope</span> <span class="o">*</span><span class="n">rate_scope</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_rate_drop_pattern</span> <span class="o">*</span><span class="n">rate_drop</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_TX_RATE_CFG</span><span class="p">);</span>

	<span class="n">rate_cfg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
	<span class="n">rate_cfg</span><span class="o">-&gt;</span><span class="n">cfg_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rate_scope</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_rate_scope</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">rate_cfg</span> <span class="o">+</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_tx_rate_cfg</span><span class="p">));</span>
	<span class="n">rate_scope</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_RATE_SCOPE</span><span class="p">);</span>
	<span class="n">rate_scope</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rate_scope</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbitmap_rates</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate_scope</span><span class="o">-&gt;</span><span class="n">hr_dsss_rate_bitmap</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pbitmap_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">rate_scope</span><span class="o">-&gt;</span><span class="n">ofdm_rate_bitmap</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pbitmap_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rate_scope</span><span class="o">-&gt;</span><span class="n">ht_mcs_rate_bitmap</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		     <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rate_scope</span><span class="o">-&gt;</span><span class="n">ht_mcs_rate_bitmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">pbitmap_rates</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rate_scope</span><span class="o">-&gt;</span><span class="n">hr_dsss_rate_bitmap</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bitmap_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">rate_scope</span><span class="o">-&gt;</span><span class="n">ofdm_rate_bitmap</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bitmap_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rate_scope</span><span class="o">-&gt;</span><span class="n">ht_mcs_rate_bitmap</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
		     <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rate_scope</span><span class="o">-&gt;</span><span class="n">ht_mcs_rate_bitmap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bitmap_rates</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">rate_drop</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_rate_drop_pattern</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">rate_scope</span> <span class="o">+</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_rate_scope</span><span class="p">));</span>
	<span class="n">rate_drop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_RATE_DROP_CONTROL</span><span class="p">);</span>
	<span class="n">rate_drop</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rate_drop</span><span class="o">-&gt;</span><span class="n">rate_drop_mode</span><span class="p">));</span>
	<span class="n">rate_drop</span><span class="o">-&gt;</span><span class="n">rate_drop_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">S_DS_GEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_tx_rate_cfg</span><span class="p">)</span> <span class="o">+</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_rate_scope</span><span class="p">)</span> <span class="o">+</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_rate_drop_pattern</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set/get Tx power configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting Tx power mode, power group TLV</span>
<span class="cm"> *        (as required)</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_tx_power_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">host_cmd_ds_txpwr_cfg</span> <span class="o">*</span><span class="n">txp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_types_power_group</span> <span class="o">*</span><span class="n">pg_tlv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_txpwr_cfg</span> <span class="o">*</span><span class="n">cmd_txp_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">txp_cfg</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_TXPWR_CFG</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">S_DS_GEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_txpwr_cfg</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HostCmd_ACT_GEN_SET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">txp</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pg_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_types_power_group</span>
				  <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">txp</span> <span class="o">+</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_txpwr_cfg</span><span class="p">));</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">cmd_txp_cfg</span><span class="p">,</span> <span class="n">txp</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_txpwr_cfg</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_types_power_group</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">pg_tlv</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

			<span class="n">pg_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_types_power_group</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span>
				  <span class="n">cmd_txp_cfg</span> <span class="o">+</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_txpwr_cfg</span><span class="p">));</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_types_power_group</span><span class="p">)</span> <span class="o">+</span>
				  <span class="n">pg_tlv</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">cmd_txp_cfg</span><span class="p">,</span> <span class="n">txp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txp</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">cmd_txp_cfg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_ACT_GEN_GET</span>:
		<span class="n">cmd_txp_cfg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set Host Sleep configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID and proper size</span>
<span class="cm"> *      - Setting Host Sleep action, conditions, ARP filters</span>
<span class="cm"> *        (as required)</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_cmd_802_11_hs_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">mwifiex_hs_config_param</span> <span class="o">*</span><span class="n">hscfg_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_hs_cfg_enh</span> <span class="o">*</span><span class="n">hs_cfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">opt_hs_cfg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hs_activate</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hscfg_param</span><span class="p">)</span>
		<span class="cm">/* New Activate command */</span>
		<span class="n">hs_activate</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_HS_CFG_ENH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hs_activate</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hscfg_param</span><span class="o">-&gt;</span><span class="n">conditions</span> <span class="o">!=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">HOST_SLEEP_CFG_CANCEL</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">arp_filter_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">arp_filter_size</span> <span class="o">&lt;=</span> <span class="n">ARP_FILTER_MAX_BUF_SIZE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cmd: Attach %d bytes ArpFilter to HSCfg cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">arp_filter_size</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">hs_cfg</span><span class="p">)</span> <span class="o">+</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_hs_cfg_enh</span><span class="p">),</span>
		       <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">arp_filter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">arp_filter_size</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span>
				<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">arp_filter_size</span> <span class="o">+</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_hs_cfg_enh</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">S_DS_GEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
						<span class="n">host_cmd_ds_802_11_hs_cfg_enh</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hs_activate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hs_cfg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HS_ACTIVATE</span><span class="p">);</span>
		<span class="n">hs_cfg</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hs_activate</span><span class="p">.</span><span class="n">resp_ctrl</span> <span class="o">=</span> <span class="n">RESP_NEEDED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hs_cfg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HS_CONFIGURE</span><span class="p">);</span>
		<span class="n">hs_cfg</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hs_config</span><span class="p">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">hscfg_param</span><span class="o">-&gt;</span><span class="n">conditions</span><span class="p">;</span>
		<span class="n">hs_cfg</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hs_config</span><span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">hscfg_param</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">;</span>
		<span class="n">hs_cfg</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hs_config</span><span class="p">.</span><span class="n">gap</span> <span class="o">=</span> <span class="n">hscfg_param</span><span class="o">-&gt;</span><span class="n">gap</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cmd: HS_CFG_CMD: condition:0x%x gpio:0x%x gap:0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hs_cfg</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hs_config</span><span class="p">.</span><span class="n">conditions</span><span class="p">,</span>
		       <span class="n">hs_cfg</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hs_config</span><span class="p">.</span><span class="n">gpio</span><span class="p">,</span>
		       <span class="n">hs_cfg</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hs_config</span><span class="p">.</span><span class="n">gap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set/get MAC address.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting MAC address (for SET only)</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_802_11_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
					  <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_MAC_ADDRESS</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_mac_address</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_action</span> <span class="o">==</span> <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_addr</span><span class="p">,</span>
		       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set MAC multicast address.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting MAC multicast address</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_cmd_mac_multicast_adr</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">mwifiex_multicast_list</span> <span class="o">*</span><span class="n">mcast_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_mac_multicast_adr</span> <span class="o">*</span><span class="n">mcast_addr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mc_addr</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_mac_multicast_adr</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_MAC_MULTICAST_ADR</span><span class="p">);</span>

	<span class="n">mcast_addr</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
	<span class="n">mcast_addr</span><span class="o">-&gt;</span><span class="n">num_of_adrs</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">mcast_list</span><span class="o">-&gt;</span><span class="n">num_multicast_addr</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mcast_addr</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">,</span> <span class="n">mcast_list</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">,</span>
	       <span class="n">mcast_list</span><span class="o">-&gt;</span><span class="n">num_multicast_addr</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to deauthenticate.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID and proper size</span>
<span class="cm"> *      - Setting AP MAC address and reason code</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_802_11_deauthenticate</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
					     <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_deauthenticate</span> <span class="o">*</span><span class="n">deauth</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">deauth</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_DEAUTHENTICATE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_deauthenticate</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>

	<span class="cm">/* Set AP MAC address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">deauth</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: Deauth: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">deauth</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>

	<span class="n">deauth</span><span class="o">-&gt;</span><span class="n">reason_code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_REASON_DEAUTH_LEAVING</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to stop Ad-Hoc network.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID and proper size</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_802_11_ad_hoc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_AD_HOC_STOP</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function sets WEP key(s) to key parameter TLV(s).</span>
<span class="cm"> *</span>
<span class="cm"> * Multi-key parameter TLVs are supported, so we can send multiple</span>
<span class="cm"> * WEP keys in a single buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_set_keyparamset_wep</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">mwifiex_ie_type_key_param_set</span> <span class="o">*</span><span class="n">key_param_set</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="o">*</span><span class="n">key_param_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cur_key_param_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Multi-key_param_set TLV is supported */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_WEP_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_length</span> <span class="o">==</span> <span class="n">WLAN_KEY_LEN_WEP40</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_length</span> <span class="o">==</span> <span class="n">WLAN_KEY_LEN_WEP104</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">key_param_set</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_KEY_MATERIAL</span><span class="p">);</span>
<span class="cm">/* Key_param_set WEP fixed length */</span>
<span class="cp">#define KEYPARAMSET_WEP_FIXED_LEN 8</span>
			<span class="n">key_param_set</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span>
					<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
					 <span class="n">key_length</span> <span class="o">+</span>
					 <span class="n">KEYPARAMSET_WEP_FIXED_LEN</span><span class="p">));</span>
			<span class="n">key_param_set</span><span class="o">-&gt;</span><span class="n">key_type_id</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_TYPE_ID_WEP</span><span class="p">);</span>
			<span class="n">key_param_set</span><span class="o">-&gt;</span><span class="n">key_info</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_ENABLED</span> <span class="o">|</span> <span class="n">KEY_UNICAST</span> <span class="o">|</span>
					    <span class="n">KEY_MCAST</span><span class="p">);</span>
			<span class="n">key_param_set</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_length</span><span class="p">);</span>
			<span class="cm">/* Set WEP key index */</span>
			<span class="n">key_param_set</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="cm">/* Set default Tx key flag */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span>
			    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span>
			     <span class="n">wep_key_curr_index</span> <span class="o">&amp;</span> <span class="n">HostCmd_WEP_KEY_INDEX_MASK</span><span class="p">))</span>
				<span class="n">key_param_set</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">key_param_set</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_param_set</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_material</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_length</span><span class="p">);</span>

			<span class="n">cur_key_param_len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_length</span> <span class="o">+</span>
				<span class="n">KEYPARAMSET_WEP_FIXED_LEN</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">);</span>
			<span class="o">*</span><span class="n">key_param_len</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">cur_key_param_len</span><span class="p">;</span>
			<span class="n">key_param_set</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_type_key_param_set</span> <span class="o">*</span><span class="p">)</span>
						<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">key_param_set</span> <span class="o">+</span>
						 <span class="n">cur_key_param_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_length</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;key%d Length = %d is incorrect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_length</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set/get/reset network key(s).</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting WEP keys, WAPI keys or WPA keys along with required</span>
<span class="cm"> *        encryption (TKIP, AES) (as required)</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_cmd_802_11_key_material</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd_oid</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mwifiex_ds_encrypt_key</span> <span class="o">*</span><span class="n">enc_key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_key_material</span> <span class="o">*</span><span class="n">key_material</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">key_material</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_tlv_mac_addr</span> <span class="o">*</span><span class="n">tlv_mac</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">key_param_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">bc_mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_KEY_MATERIAL</span><span class="p">);</span>
	<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_action</span> <span class="o">==</span> <span class="n">HostCmd_ACT_GEN_GET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enc_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">NUM_WEP_KEYS</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_type_key_param_set</span><span class="p">)));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_set_keyparamset_wep</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">key_param_len</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">key_param_len</span> <span class="o">+</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_type_key_param_set</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">is_wapi_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: Set WAPI Key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_type_id</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_TYPE_ID_WAPI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_oid</span> <span class="o">==</span> <span class="n">KEY_INFO_ENABLED</span><span class="p">)</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_info</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_ENABLED</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_info</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">!</span><span class="n">KEY_ENABLED</span><span class="p">);</span>

		<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_index</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wapi_key_on</span><span class="p">)</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* set 0 when re-key */</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">bc_mac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bc_mac</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* WAPI pairwise key: unicast */</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_info</span> <span class="o">|=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_UNICAST</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* WAPI group key: multicast */</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_info</span> <span class="o">|=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_MCAST</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wapi_key_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_KEY_MATERIAL</span><span class="p">);</span>
		<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WAPI_KEY_LEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		       <span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_material</span><span class="p">,</span> <span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">],</span>
		       <span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">wapi_rxpn</span><span class="p">,</span> <span class="n">WAPI_RXPN_LEN</span><span class="p">);</span>
		<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WAPI_KEY_LEN</span> <span class="o">+</span> <span class="n">KEYPARAMSET_FIXED_LEN</span><span class="p">);</span>

		<span class="n">key_param_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">WAPI_KEY_LEN</span> <span class="o">+</span> <span class="n">KEYPARAMSET_FIXED_LEN</span><span class="p">)</span> <span class="o">+</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span>
					<span class="o">+</span> <span class="n">S_DS_GEN</span> <span class="o">+</span>  <span class="n">key_param_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">==</span> <span class="n">WLAN_KEY_LEN_CCMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: WPA_AES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_type_id</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_TYPE_ID_AES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_oid</span> <span class="o">==</span> <span class="n">KEY_INFO_ENABLED</span><span class="p">)</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_info</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_ENABLED</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_info</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">!</span><span class="n">KEY_ENABLED</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_index</span> <span class="o">&amp;</span> <span class="n">MWIFIEX_KEY_INDEX_UNICAST</span><span class="p">)</span>
				<span class="cm">/* AES pairwise key: unicast */</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_info</span> <span class="o">|=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_UNICAST</span><span class="p">);</span>
		<span class="k">else</span>		<span class="cm">/* AES group key: multicast */</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_info</span> <span class="o">|=</span>
							<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_MCAST</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">==</span> <span class="n">WLAN_KEY_LEN_TKIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: WPA_TKIP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_type_id</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_TYPE_ID_TKIP</span><span class="p">);</span>
		<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_info</span> <span class="o">=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_ENABLED</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_index</span> <span class="o">&amp;</span> <span class="n">MWIFIEX_KEY_INDEX_UNICAST</span><span class="p">)</span>
				<span class="cm">/* TKIP pairwise key: unicast */</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_info</span> <span class="o">|=</span>
						<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_UNICAST</span><span class="p">);</span>
		<span class="k">else</span>		<span class="cm">/* TKIP group key: multicast */</span>
			<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_info</span> <span class="o">|=</span>
							<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_MCAST</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_type_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_KEY_MATERIAL</span><span class="p">);</span>
		<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_material</span><span class="p">,</span>
		       <span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">+</span>
				    <span class="n">KEYPARAMSET_FIXED_LEN</span><span class="p">);</span>

		<span class="n">key_param_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">+</span> <span class="n">KEYPARAMSET_FIXED_LEN</span><span class="p">)</span>
				<span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">);</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span>
					<span class="o">+</span> <span class="n">key_param_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">MWIFIEX_BSS_TYPE_UAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tlv_mac</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">key_param_set</span> <span class="o">+</span>
					   <span class="n">key_param_len</span><span class="p">);</span>
			<span class="n">tlv_mac</span><span class="o">-&gt;</span><span class="n">tlv</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_STA_MAC_ADDR</span><span class="p">);</span>
			<span class="n">tlv_mac</span><span class="o">-&gt;</span><span class="n">tlv</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tlv_mac</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">enc_key</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">cmd_size</span> <span class="o">=</span> <span class="n">key_param_len</span> <span class="o">+</span> <span class="n">S_DS_GEN</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_tlv_mac_addr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cmd_size</span> <span class="o">=</span> <span class="n">key_param_len</span> <span class="o">+</span> <span class="n">S_DS_GEN</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">key_material</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set/get 11d domain information.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting domain information fields (for SET only)</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_802_11d_domain_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
					   <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11d_domain_info</span> <span class="o">*</span><span class="n">domain_info</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">domain_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ietypes_domain_param_set</span> <span class="o">*</span><span class="n">domain</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">domain_info</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">no_of_triplet</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">domain_reg</span><span class="p">.</span><span class="n">no_of_triplet</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: 11D: no_of_triplet=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">no_of_triplet</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11D_DOMAIN_INFO</span><span class="p">);</span>
	<span class="n">domain_info</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_action</span> <span class="o">==</span> <span class="n">HostCmd_ACT_GEN_GET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">domain_info</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set domain info fields */</span>
	<span class="n">domain</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_EID_COUNTRY</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">country_code</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">domain_reg</span><span class="p">.</span><span class="n">country_code</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">country_code</span><span class="p">));</span>

	<span class="n">domain</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">no_of_triplet</span> <span class="o">*</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_country_ie_triplet</span><span class="p">))</span>
			    <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">country_code</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_of_triplet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">triplet</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">domain_reg</span><span class="p">.</span><span class="n">triplet</span><span class="p">,</span>
		       <span class="n">no_of_triplet</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
					      <span class="n">ieee80211_country_ie_triplet</span><span class="p">));</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">domain_info</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">)</span>
					<span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">domain_info</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set/get RF channel.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting RF type and current RF channel (for SET only)</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_802_11_rf_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
					 <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_rf_channel</span> <span class="o">*</span><span class="n">rf_chan</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rf_channel</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">rf_type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rf_chan</span><span class="o">-&gt;</span><span class="n">rf_type</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_RF_CHANNEL</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_rf_channel</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_action</span> <span class="o">==</span> <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">&amp;</span> <span class="n">BAND_A</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">&amp;</span> <span class="n">BAND_AN</span><span class="p">))</span>
			<span class="n">rf_chan</span><span class="o">-&gt;</span><span class="n">rf_type</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_SCAN_RADIO_TYPE_A</span><span class="p">);</span>

		<span class="n">rf_type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rf_chan</span><span class="o">-&gt;</span><span class="n">rf_type</span><span class="p">);</span>
		<span class="n">SET_SECONDARYCHAN</span><span class="p">(</span><span class="n">rf_type</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sec_chan_offset</span><span class="p">);</span>
		<span class="n">rf_chan</span><span class="o">-&gt;</span><span class="n">current_channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rf_chan</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set/get IBSS coalescing status.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting status to enable or disable (for SET only)</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_ibss_coalescing_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
					      <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ibss_status</span> <span class="o">*</span><span class="n">ibss_coal</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ibss_coalescing</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_IBSS_COALESCING_STATUS</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ibss_status</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ibss_coal</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HostCmd_ACT_GEN_SET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
			<span class="n">ibss_coal</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">*</span><span class="n">enable</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ibss_coal</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* In other case.. Nothing to do */</span>
	<span class="k">case</span> <span class="n">HostCmd_ACT_GEN_GET</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set/get register value.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting register offset (for both GET and SET) and</span>
<span class="cm"> *        register value (for SET only)</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> *</span>
<span class="cm"> * The following type of registers can be accessed with this function -</span>
<span class="cm"> *      - MAC register</span>
<span class="cm"> *      - BBP register</span>
<span class="cm"> *      - RF register</span>
<span class="cm"> *      - PMIC register</span>
<span class="cm"> *      - CAU register</span>
<span class="cm"> *      - EEPROM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_reg_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_ds_reg_rw</span> <span class="o">*</span><span class="n">reg_rw</span> <span class="o">=</span> <span class="n">data_buf</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_MAC_REG_ACCESS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">host_cmd_ds_mac_reg_access</span> <span class="o">*</span><span class="n">mac_reg</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mac_reg</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="n">mac_reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_mac_reg_access</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span>
								<span class="n">params</span><span class="p">.</span><span class="n">mac_reg</span><span class="p">;</span>
		<span class="n">mac_reg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
		<span class="n">mac_reg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reg_rw</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
		<span class="n">mac_reg</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">reg_rw</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_BBP_REG_ACCESS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">host_cmd_ds_bbp_reg_access</span> <span class="o">*</span><span class="n">bbp_reg</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bbp_reg</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="n">bbp_reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_bbp_reg_access</span> <span class="o">*</span><span class="p">)</span>
							<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">bbp_reg</span><span class="p">;</span>
		<span class="n">bbp_reg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
		<span class="n">bbp_reg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reg_rw</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
		<span class="n">bbp_reg</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reg_rw</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_RF_REG_ACCESS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">host_cmd_ds_rf_reg_access</span> <span class="o">*</span><span class="n">rf_reg</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rf_reg</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="n">rf_reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_rf_reg_access</span> <span class="o">*</span><span class="p">)</span>
							<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rf_reg</span><span class="p">;</span>
		<span class="n">rf_reg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
		<span class="n">rf_reg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reg_rw</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
		<span class="n">rf_reg</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reg_rw</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_PMIC_REG_ACCESS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">host_cmd_ds_pmic_reg_access</span> <span class="o">*</span><span class="n">pmic_reg</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmic_reg</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="n">pmic_reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_pmic_reg_access</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span>
				<span class="n">params</span><span class="p">.</span><span class="n">pmic_reg</span><span class="p">;</span>
		<span class="n">pmic_reg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
		<span class="n">pmic_reg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reg_rw</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
		<span class="n">pmic_reg</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reg_rw</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_CAU_REG_ACCESS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">host_cmd_ds_rf_reg_access</span> <span class="o">*</span><span class="n">cau_reg</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cau_reg</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="n">cau_reg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_rf_reg_access</span> <span class="o">*</span><span class="p">)</span>
							<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">rf_reg</span><span class="p">;</span>
		<span class="n">cau_reg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
		<span class="n">cau_reg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reg_rw</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
		<span class="n">cau_reg</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">reg_rw</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_EEPROM_ACCESS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">mwifiex_ds_read_eeprom</span> <span class="o">*</span><span class="n">rd_eeprom</span> <span class="o">=</span> <span class="n">data_buf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_eeprom_access</span> <span class="o">*</span><span class="n">cmd_eeprom</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_eeprom_access</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">eeprom</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd_eeprom</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="n">cmd_eeprom</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_action</span><span class="p">);</span>
		<span class="n">cmd_eeprom</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">rd_eeprom</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
		<span class="n">cmd_eeprom</span><span class="o">-&gt;</span><span class="n">byte_count</span> <span class="o">=</span> <span class="n">rd_eeprom</span><span class="o">-&gt;</span><span class="n">byte_count</span><span class="p">;</span>
		<span class="n">cmd_eeprom</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to set PCI-Express</span>
<span class="cm"> * host buffer configuration</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting host buffer configuration</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_cmd_pcie_host_spec</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_pcie_details</span> <span class="o">*</span><span class="n">host_spec</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">pcie_host_spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcie_service_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">phys_addr_t</span> <span class="o">*</span><span class="n">buf_pa</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_PCIE_DESC_DETAILS</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
					<span class="n">host_cmd_ds_pcie_details</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">host_spec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_pcie_details</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">!=</span> <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Send the ring base addresses and count to firmware */</span>
	<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">txbd_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">txbd_ring_pbase</span><span class="p">);</span>
	<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">txbd_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(((</span><span class="n">u64</span><span class="p">)</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">txbd_ring_pbase</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">txbd_count</span> <span class="o">=</span> <span class="n">MWIFIEX_MAX_TXRX_BD</span><span class="p">;</span>
	<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">rxbd_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rxbd_ring_pbase</span><span class="p">);</span>
	<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">rxbd_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(((</span><span class="n">u64</span><span class="p">)</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rxbd_ring_pbase</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">rxbd_count</span> <span class="o">=</span> <span class="n">MWIFIEX_MAX_TXRX_BD</span><span class="p">;</span>
	<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">evtbd_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">evtbd_ring_pbase</span><span class="p">);</span>
	<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">evtbd_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(((</span><span class="n">u64</span><span class="p">)</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">evtbd_ring_pbase</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">evtbd_count</span> <span class="o">=</span> <span class="n">MWIFIEX_MAX_EVT_BD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sleep_cookie</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf_pa</span> <span class="o">=</span> <span class="n">MWIFIEX_SKB_PACB</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sleep_cookie</span><span class="p">);</span>
		<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">sleep_cookie_addr_lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span><span class="n">buf_pa</span><span class="p">;</span>
		<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">sleep_cookie_addr_hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="o">*</span><span class="n">buf_pa</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sleep_cook_lo phy addr: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">host_spec</span><span class="o">-&gt;</span><span class="n">sleep_cookie_addr_lo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command for event subscription, configuration</span>
<span class="cm"> * and query. Events can be subscribed or unsubscribed. Current subscribed</span>
<span class="cm"> * events can be queried. Also, current subscribed events are reported in</span>
<span class="cm"> * every FW response.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_cmd_802_11_subsc_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mwifiex_ds_misc_subsc_evt</span> <span class="o">*</span><span class="n">subsc_evt_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_subsc_evt</span> <span class="o">*</span><span class="n">subsc_evt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">subsc_evt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_rssi_threshold</span> <span class="o">*</span><span class="n">rssi_tlv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">event_bitmap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_SUBSCRIBE_EVENT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_subsc_evt</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">S_DS_GEN</span><span class="p">);</span>

	<span class="n">subsc_evt</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: action: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>

	<span class="cm">/*For query requests, no configuration TLV structures are to be added.*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">HostCmd_ACT_GEN_GET</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">subsc_evt</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>

	<span class="n">event_bitmap</span> <span class="o">=</span> <span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: event bitmap : %16x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">event_bitmap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">HostCmd_ACT_BITWISE_CLR</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">HostCmd_ACT_BITWISE_SET</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">event_bitmap</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error: No event specified &quot;</span>
			<span class="s">&quot;for bitwise action type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Append TLV structures for each of the specified events for</span>
<span class="cm">	 * subscribing or re-configuring. This is not required for</span>
<span class="cm">	 * bitwise unsubscribing request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">HostCmd_ACT_BITWISE_CLR</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">subsc_evt</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_subsc_evt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_bitmap</span> <span class="o">&amp;</span> <span class="n">BITMASK_BCN_RSSI_LOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rssi_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_rssi_threshold</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>

		<span class="n">rssi_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_RSSI_LOW</span><span class="p">);</span>
		<span class="n">rssi_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_rssi_threshold</span><span class="p">)</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">));</span>
		<span class="n">rssi_tlv</span><span class="o">-&gt;</span><span class="n">abs_value</span> <span class="o">=</span> <span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">bcn_l_rssi_cfg</span><span class="p">.</span><span class="n">abs_value</span><span class="p">;</span>
		<span class="n">rssi_tlv</span><span class="o">-&gt;</span><span class="n">evt_freq</span> <span class="o">=</span> <span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">bcn_l_rssi_cfg</span><span class="p">.</span><span class="n">evt_freq</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cfg Beacon Low Rssi event, &quot;</span>
			<span class="s">&quot;RSSI:-%d dBm, Freq:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">bcn_l_rssi_cfg</span><span class="p">.</span><span class="n">abs_value</span><span class="p">,</span>
			<span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">bcn_l_rssi_cfg</span><span class="p">.</span><span class="n">evt_freq</span><span class="p">);</span>

		<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_rssi_threshold</span><span class="p">);</span>
		<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_rssi_threshold</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_bitmap</span> <span class="o">&amp;</span> <span class="n">BITMASK_BCN_RSSI_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rssi_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_rssi_threshold</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>

		<span class="n">rssi_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_RSSI_HIGH</span><span class="p">);</span>
		<span class="n">rssi_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_rssi_threshold</span><span class="p">)</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">));</span>
		<span class="n">rssi_tlv</span><span class="o">-&gt;</span><span class="n">abs_value</span> <span class="o">=</span> <span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">bcn_h_rssi_cfg</span><span class="p">.</span><span class="n">abs_value</span><span class="p">;</span>
		<span class="n">rssi_tlv</span><span class="o">-&gt;</span><span class="n">evt_freq</span> <span class="o">=</span> <span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">bcn_h_rssi_cfg</span><span class="p">.</span><span class="n">evt_freq</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cfg Beacon High Rssi event, &quot;</span>
			<span class="s">&quot;RSSI:-%d dBm, Freq:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">bcn_h_rssi_cfg</span><span class="p">.</span><span class="n">abs_value</span><span class="p">,</span>
			<span class="n">subsc_evt_cfg</span><span class="o">-&gt;</span><span class="n">bcn_h_rssi_cfg</span><span class="p">.</span><span class="n">evt_freq</span><span class="p">);</span>

		<span class="n">pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_rssi_threshold</span><span class="p">);</span>
		<span class="n">le16_add_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_rssi_threshold</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares the commands before sending them to the firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * This is a generic function which calls specific command preparation</span>
<span class="cm"> * routines based upon the command number.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_sta_prepare_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">cmd_no</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd_oid</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cmd_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd_ptr</span> <span class="o">=</span> <span class="n">cmd_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Prepare command */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_no</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_GET_HW_SPEC</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_get_hw_spec</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_MAC_CONTROL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_mac_control</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
					      <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_MAC_ADDRESS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_mac_address</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span>
						     <span class="n">cmd_action</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_MAC_MULTICAST_ADR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_mac_multicast_adr</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
						    <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_TX_RATE_CFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_tx_rate_cfg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
					      <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_TXPWR_CFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_tx_power_cfg</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
					       <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_PS_MODE_ENH</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_enh_power_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
						 <span class="p">(</span><span class="kt">uint16_t</span><span class="p">)</span><span class="n">cmd_oid</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_HS_CFG_ENH</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_hs_cfg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_hs_config_param</span> <span class="o">*</span><span class="p">)</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_SCAN</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_scan</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_BG_SCAN_QUERY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_bg_scan_query</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_ASSOCIATE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_DEAUTHENTICATE</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_deauthenticate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span>
							<span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_AD_HOC_START</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_ad_hoc_start</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span>
						      <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_GET_LOG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_get_log</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_AD_HOC_JOIN</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_ad_hoc_join</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span>
						     <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_AD_HOC_STOP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_ad_hoc_stop</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_RSSI_INFO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_rssi_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_SNMP_MIB</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_snmp_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
						  <span class="n">cmd_oid</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_TX_RATE_QUERY</span>:
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_TX_RATE_QUERY</span><span class="p">);</span>
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_tx_rate_query</span><span class="p">)</span> <span class="o">+</span>
				    <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_VERSION_EXT</span>:
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_no</span><span class="p">);</span>
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">verext</span><span class="p">.</span><span class="n">version_str_sel</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">data_buf</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_version_ext</span><span class="p">));</span>
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_version_ext</span><span class="p">)</span> <span class="o">+</span>
				    <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_RF_CHANNEL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_rf_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
						    <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_FUNC_INIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">==</span> <span class="n">MWIFIEX_HW_STATUS_RESET</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">=</span> <span class="n">MWIFIEX_HW_STATUS_READY</span><span class="p">;</span>
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_no</span><span class="p">);</span>
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_FUNC_SHUTDOWN</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">=</span> <span class="n">MWIFIEX_HW_STATUS_RESET</span><span class="p">;</span>
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_no</span><span class="p">);</span>
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_11N_ADDBA_REQ</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_11n_addba_req</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_11N_DELBA</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_11n_delba</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_11N_ADDBA_RSP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_11n_addba_rsp_gen</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_KEY_MATERIAL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_key_material</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span>
						      <span class="n">cmd_action</span><span class="p">,</span> <span class="n">cmd_oid</span><span class="p">,</span>
						      <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11D_DOMAIN_INFO</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11d_domain_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span>
						      <span class="n">cmd_action</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_RECONFIGURE_TX_BUFF</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_recfg_tx_buf</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
					       <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_AMSDU_AGGR_CTRL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_amsdu_aggr_ctrl</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
						  <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_11N_CFG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_11n_cfg</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_WMM_GET_STATUS</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cmd: WMM: WMM_GET_STATUS cmd sent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_WMM_GET_STATUS</span><span class="p">);</span>
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_wmm_get_status</span><span class="p">)</span> <span class="o">+</span>
				    <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_IBSS_COALESCING_STATUS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_ibss_coalescing_status</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
							 <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_MAC_REG_ACCESS</span>:
	<span class="k">case</span> <span class="n">HostCmd_CMD_BBP_REG_ACCESS</span>:
	<span class="k">case</span> <span class="n">HostCmd_CMD_RF_REG_ACCESS</span>:
	<span class="k">case</span> <span class="n">HostCmd_CMD_PMIC_REG_ACCESS</span>:
	<span class="k">case</span> <span class="n">HostCmd_CMD_CAU_REG_ACCESS</span>:
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_EEPROM_ACCESS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_reg_access</span><span class="p">(</span><span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_SET_BSS_MODE</span>:
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_no</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
			<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">bss_mode</span><span class="p">.</span><span class="n">con_type</span> <span class="o">=</span>
				<span class="n">CONNECTION_TYPE_ADHOC</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
			<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">bss_mode</span><span class="p">.</span><span class="n">con_type</span> <span class="o">=</span>
				<span class="n">CONNECTION_TYPE_INFRA</span><span class="p">;</span>
		<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
				<span class="n">host_cmd_ds_set_bss_mode</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_PCIE_DESC_DETAILS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_pcie_host_spec</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_CMD_802_11_SUBSCRIBE_EVENT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_802_11_subsc_evt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;PREP_CMD: unknown cmd- %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd_no</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function issues commands to initialize firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called after firmware download to bring the card to</span>
<span class="cm"> * working state.</span>
<span class="cm"> *</span>
<span class="cm"> * The following commands are issued sequentially -</span>
<span class="cm"> *      - Set PCI-Express host buffer configuration (PCIE only)</span>
<span class="cm"> *      - Function init (for first interface only)</span>
<span class="cm"> *      - Read MAC address (for first interface only)</span>
<span class="cm"> *      - Reconfigure Tx buffer size (for first interface only)</span>
<span class="cm"> *      - Enable auto deep sleep (for first interface only)</span>
<span class="cm"> *      - Get Tx rate</span>
<span class="cm"> *      - Get Tx power</span>
<span class="cm"> *      - Set IBSS coalescing status</span>
<span class="cm"> *      - Set AMSDU aggregation control</span>
<span class="cm"> *      - Set 11d control</span>
<span class="cm"> *      - Set MAC control (this must be the last command to initialize firmware)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_sta_init_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">first_sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ds_11n_amsdu_aggr_ctrl</span> <span class="n">amsdu_aggr_ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ds_auto_ds</span> <span class="n">auto_ds</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">state_11d_t</span> <span class="n">state_11d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ds_11n_tx_cfg</span> <span class="n">tx_cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">MWIFIEX_PCIE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
						<span class="n">HostCmd_CMD_PCIE_DESC_DETAILS</span><span class="p">,</span>
						<span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_FUNC_INIT</span><span class="p">,</span>
					     <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Read MAC address from HW */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_GET_HW_SPEC</span><span class="p">,</span>
					     <span class="n">HostCmd_ACT_GEN_GET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Reconfigure tx buf size */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					     <span class="n">HostCmd_CMD_RECONFIGURE_TX_BUFF</span><span class="p">,</span>
					     <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_buf_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">!=</span> <span class="n">MWIFIEX_BSS_TYPE_UAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Enable IEEE PS by default */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_mode</span> <span class="o">=</span> <span class="n">MWIFIEX_802_11_POWER_MODE_PSP</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span>
					<span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_802_11_PS_MODE_ENH</span><span class="p">,</span>
					<span class="n">EN_AUTO_PS</span><span class="p">,</span> <span class="n">BITMAP_STA_PS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* get tx rate */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_TX_RATE_CFG</span><span class="p">,</span>
				     <span class="n">HostCmd_ACT_GEN_GET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get tx power */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_TXPWR_CFG</span><span class="p">,</span>
				     <span class="n">HostCmd_ACT_GEN_GET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">MWIFIEX_BSS_TYPE_STA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set ibss coalescing_status */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span>
				<span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_802_11_IBSS_COALESCING_STATUS</span><span class="p">,</span>
				<span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amsdu_aggr_ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">amsdu_aggr_ctrl</span><span class="p">));</span>
	<span class="n">amsdu_aggr_ctrl</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="cm">/* Send request to firmware */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_AMSDU_AGGR_CTRL</span><span class="p">,</span>
				     <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">amsdu_aggr_ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* MAC Control must be the last command in init_fw */</span>
	<span class="cm">/* set MAC Control */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_MAC_CONTROL</span><span class="p">,</span>
				     <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_pkt_filter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_sta</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">!=</span> <span class="n">MWIFIEX_USB</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">!=</span> <span class="n">MWIFIEX_BSS_TYPE_UAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable auto deep sleep */</span>
		<span class="n">auto_ds</span><span class="p">.</span><span class="n">auto_ds</span> <span class="o">=</span> <span class="n">DEEP_SLEEP_ON</span><span class="p">;</span>
		<span class="n">auto_ds</span><span class="p">.</span><span class="n">idle_time</span> <span class="o">=</span> <span class="n">DEEP_SLEEP_IDLE_TIME</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					     <span class="n">HostCmd_CMD_802_11_PS_MODE_ENH</span><span class="p">,</span>
					     <span class="n">EN_AUTO_PS</span><span class="p">,</span> <span class="n">BITMAP_AUTO_DS</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">auto_ds</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">!=</span> <span class="n">MWIFIEX_BSS_TYPE_UAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Send cmd to FW to enable/disable 11D function */</span>
		<span class="n">state_11d</span> <span class="o">=</span> <span class="n">ENABLE_11D</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_802_11_SNMP_MIB</span><span class="p">,</span>
					     <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="n">DOT11D_I</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">state_11d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;11D: failed to enable 11D</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Send cmd to FW to configure 11n specific configuration</span>
<span class="cm">	 * (Short GI, Channel BW, Green field support etc.) for transmit</span>
<span class="cm">	 */</span>
	<span class="n">tx_cfg</span><span class="p">.</span><span class="n">tx_htcap</span> <span class="o">=</span> <span class="n">MWIFIEX_FW_DEF_HTTXCFG</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_11N_CFG</span><span class="p">,</span>
				     <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_cfg</span><span class="p">);</span>

	<span class="cm">/* set last_init_cmd */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">last_init_cmd</span> <span class="o">=</span> <span class="n">HostCmd_CMD_11N_CFG</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
