<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › mwifiex › cmdevt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cmdevt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Marvell Wireless LAN device driver: commands and events</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011, Marvell International Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This software file (the &quot;File&quot;) is distributed by Marvell International</span>
<span class="cm"> * Ltd. under the terms of the GNU General Public License Version 2, June 1991</span>
<span class="cm"> * (the &quot;License&quot;).  You may use, redistribute and/or modify this File in</span>
<span class="cm"> * accordance with the terms and conditions of the License, a copy of which</span>
<span class="cm"> * is available by writing to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA or on the</span>
<span class="cm"> * worldwide web at http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.</span>
<span class="cm"> *</span>
<span class="cm"> * THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE EXPRESSLY DISCLAIMED.  The License provides additional details about</span>
<span class="cm"> * this warranty disclaimer.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;decl.h&quot;</span>
<span class="cp">#include &quot;ioctl.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;fw.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;wmm.h&quot;</span>
<span class="cp">#include &quot;11n.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * This function initializes a command node.</span>
<span class="cm"> *</span>
<span class="cm"> * The actual allocation of the node is not done by this function. It only</span>
<span class="cm"> * initiates a node by filling it with default parameters. Similarly,</span>
<span class="cm"> * allocation of the different buffers used (IOCTL buffer, data buffer) are</span>
<span class="cm"> * not done by this function either.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwifiex_init_cmd_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">cmd_oid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_oid</span> <span class="o">=</span> <span class="n">cmd_oid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q_required</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q_required</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q_required</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_wait_q_woken</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">condition</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_wait_q_woken</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">data_buf</span> <span class="o">=</span> <span class="n">data_buf</span><span class="p">;</span>
	<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span> <span class="o">=</span> <span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function returns a command node from the free queue depending upon</span>
<span class="cm"> * availability.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span>
<span class="nf">mwifiex_get_cmd_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_free_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_free_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GET_CMD_NODE: cmd node not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_free_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd_node</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_free_q</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cmd_ctrl_node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_free_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd_node</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function cleans up a command node.</span>
<span class="cm"> *</span>
<span class="cm"> * The function resets the fields including the buffer pointers.</span>
<span class="cm"> * This function does not try to free the buffers. They must be</span>
<span class="cm"> * freed before calling this function.</span>
<span class="cm"> *</span>
<span class="cm"> * This function will however call the receive completion callback</span>
<span class="cm"> * in case a response buffer is still available before resetting</span>
<span class="cm"> * the pointer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwifiex_clean_cmd_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_oid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">data_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="p">)</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">resp_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">cmdrsp_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">resp_skb</span><span class="p">);</span>
		<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">resp_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function sends a host command to the firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * The function copies the host command into the driver command</span>
<span class="cm"> * buffer, which will be transferred to the firmware later by the</span>
<span class="cm"> * main thread.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_cmd_host_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mwifiex_ds_misc_cmd</span> <span class="o">*</span><span class="n">pcmd_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Copy the HOST command to command buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">pcmd_ptr</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">pcmd_ptr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: host cmd size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcmd_ptr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function downloads a command to the firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * The function performs sanity tests, sets the command sequence</span>
<span class="cm"> * number and size, converts the header fields to CPU format before</span>
<span class="cm"> * sending. Afterwards, it logs the command ID and action for debugging</span>
<span class="cm"> * and sets up the command timeout timer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_dnld_cmd_to_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">host_cmd</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cmd_code</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cmd_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tstamp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span> <span class="o">||</span> <span class="o">!</span><span class="n">cmd_node</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">host_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Sanity test */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host_cmd</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">host_cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DNLD_CMD: host_cmd is null&quot;</span>
			<span class="s">&quot; or cmd size is 0, not sending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set command sequence number */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="o">++</span><span class="p">;</span>
	<span class="n">host_cmd</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_SET_SEQ_NO_BSS_INFO</span>
					<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">,</span>
					 <span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_num</span><span class="p">,</span>
					 <span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span> <span class="o">=</span> <span class="n">cmd_node</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cmd_code</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">host_cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
	<span class="n">cmd_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">host_cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">skb_trim</span><span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="p">,</span> <span class="n">cmd_size</span><span class="p">);</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tstamp</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: DNLD_CMD: (%lu.%lu): %#x, act %#x, len %d,&quot;</span>
		<span class="s">&quot; seqno %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tstamp</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">tstamp</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="n">cmd_code</span><span class="p">,</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">host_cmd</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">)),</span> <span class="n">cmd_size</span><span class="p">,</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">host_cmd</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">MWIFIEX_USB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWIFIEX_USB_TYPE_CMD</span><span class="p">);</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="p">,</span> <span class="n">MWIFIEX_TYPE_LEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">MWIFIEX_TYPE_LEN</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_sent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">host_to_card</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
						   <span class="n">MWIFIEX_USB_EP_CMD_EVENT</span><span class="p">,</span>
						   <span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="p">,</span> <span class="n">MWIFIEX_TYPE_LEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
			<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="p">,</span> <span class="n">INTF_HEADER_LEN</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">host_to_card</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_TYPE_CMD</span><span class="p">,</span>
						   <span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="p">,</span> <span class="n">INTF_HEADER_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DNLD_CMD: host to card failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">MWIFIEX_USB</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_sent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">num_cmd_host_to_card_failure</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Save the last command id and action to debug log */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_index</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">DBG_CMD_NUM</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_id</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_code</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_act</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_index</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">host_cmd</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">));</span>

	<span class="cm">/* Clear BSS_NO_BITS from HostCmd */</span>
	<span class="n">cmd_code</span> <span class="o">&amp;=</span> <span class="n">HostCmd_CMD_ID_MASK</span><span class="p">;</span>

	<span class="cm">/* Setup the timer after transmit command */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">MWIFIEX_TIMER_10S</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function downloads a sleep confirm command to the firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * The function performs sanity tests, sets the command sequence</span>
<span class="cm"> * number and size, converts the header fields to CPU format before</span>
<span class="cm"> * sending.</span>
<span class="cm"> *</span>
<span class="cm"> * No responses are needed for sleep confirm command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_dnld_sleep_confirm_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_opt_sleep_confirm</span> <span class="o">*</span><span class="n">sleep_cfm_buf</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_opt_sleep_confirm</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sleep_cfm_tmp</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">);</span>

	<span class="n">sleep_cfm_buf</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">HostCmd_SET_SEQ_NO_BSS_INFO</span>
					<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_num</span><span class="p">,</span>
					 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">)));</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">MWIFIEX_USB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sleep_cfm_tmp</span> <span class="o">=</span>
			<span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_opt_sleep_confirm</span><span class="p">)</span>
				      <span class="o">+</span> <span class="n">MWIFIEX_TYPE_LEN</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">sleep_cfm_tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_opt_sleep_confirm</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">MWIFIEX_TYPE_LEN</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MWIFIEX_USB_TYPE_CMD</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sleep_cfm_tmp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">MWIFIEX_TYPE_LEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sleep_cfm_tmp</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">MWIFIEX_TYPE_LEN</span><span class="p">,</span>
		       <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_opt_sleep_confirm</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">host_to_card</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
						   <span class="n">MWIFIEX_USB_EP_CMD_EVENT</span><span class="p">,</span>
						   <span class="n">sleep_cfm_tmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sleep_cfm_tmp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="p">,</span> <span class="n">INTF_HEADER_LEN</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">host_to_card</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_TYPE_CMD</span><span class="p">,</span>
						   <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="p">,</span> <span class="n">INTF_HEADER_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SLEEP_CFM: failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">num_cmd_sleep_cfm_host_to_card_failure</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">GET_BSS_ROLE</span><span class="p">(</span><span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">))</span>
	    <span class="o">==</span> <span class="n">MWIFIEX_BSS_ROLE_STA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sleep_cfm_buf</span><span class="o">-&gt;</span><span class="n">resp_ctrl</span><span class="p">)</span>
			<span class="cm">/* Response is not needed for sleep</span>
<span class="cm">			   confirm command */</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_state</span> <span class="o">=</span> <span class="n">PS_STATE_SLEEP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_state</span> <span class="o">=</span> <span class="n">PS_STATE_SLEEP_CFM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sleep_cfm_buf</span><span class="o">-&gt;</span><span class="n">resp_ctrl</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_hs_configured</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_period</span><span class="p">.</span><span class="n">period</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pm_wakeup_card_req</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">mwifiex_hs_activated_event</span><span class="p">(</span><span class="n">mwifiex_get_priv</span>
					<span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_STA</span><span class="p">),</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function allocates the command buffers and links them to</span>
<span class="cm"> * the command free queue.</span>
<span class="cm"> *</span>
<span class="cm"> * The driver uses a pre allocated number of command buffers, which</span>
<span class="cm"> * are created at driver initializations and freed at driver cleanup.</span>
<span class="cm"> * Every command needs to obtain a command buffer from this pool before</span>
<span class="cm"> * it can be issued. The command free queue lists the command buffers</span>
<span class="cm"> * currently free to use, while the command pending queue lists the</span>
<span class="cm"> * command buffers already in use and awaiting handling. Command buffers</span>
<span class="cm"> * are returned to the free queue after use.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_alloc_cmd_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_array</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Allocate and initialize struct cmd_ctrl_node */</span>
	<span class="n">buf_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_ctrl_node</span><span class="p">)</span> <span class="o">*</span> <span class="n">MWIFIEX_NUM_OF_CMD_BUFFER</span><span class="p">;</span>
	<span class="n">cmd_array</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_array</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to alloc cmd_array</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pool</span> <span class="o">=</span> <span class="n">cmd_array</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">);</span>

	<span class="cm">/* Allocate and initialize command buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MWIFIEX_NUM_OF_CMD_BUFFER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">MWIFIEX_SIZE_OF_CMD_BUFFER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ALLOC_CMD_BUF: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MWIFIEX_NUM_OF_CMD_BUFFER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function frees the command buffers.</span>
<span class="cm"> *</span>
<span class="cm"> * The function calls the completion callback for all the command</span>
<span class="cm"> * buffers that still have response buffers associated with them.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_free_cmd_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_array</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Need to check if cmd pool is allocated or not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: FREE_CMD_BUF: cmd_pool is null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd_array</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">;</span>

	<span class="cm">/* Release shared memory buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MWIFIEX_NUM_OF_CMD_BUFFER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: free cmd buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">cmd_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resp_skb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">MWIFIEX_USB</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">cmdrsp_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
							<span class="n">cmd_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resp_skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">cmd_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">resp_skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Release struct cmd_ctrl_node */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: free cmd pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pool</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pool</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles events generated by firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * Event body of events received from firmware are not used (though they are</span>
<span class="cm"> * saved), only the event ID is used. Some events are re-invoked by</span>
<span class="cm"> * the driver, with a new event body.</span>
<span class="cm"> *</span>
<span class="cm"> * After processing, the function calls the completion callback</span>
<span class="cm"> * for cleanup.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_process_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">event_skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eventcause</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">event_cause</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tstamp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_rxinfo</span> <span class="o">*</span><span class="n">rx_info</span><span class="p">;</span>

	<span class="cm">/* Save the last event to debug log */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_event_index</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_event_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">DBG_CMD_NUM</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_event</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_event_index</span><span class="p">]</span> <span class="o">=</span>
							<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">eventcause</span><span class="p">;</span>

	<span class="cm">/* Get BSS number and corresponding priv */</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">mwifiex_get_priv_by_id</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">EVENT_GET_BSS_NUM</span><span class="p">(</span><span class="n">eventcause</span><span class="p">),</span>
				      <span class="n">EVENT_GET_BSS_TYPE</span><span class="p">(</span><span class="n">eventcause</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">);</span>
	<span class="cm">/* Clear BSS_NO_BITS from event */</span>
	<span class="n">eventcause</span> <span class="o">&amp;=</span> <span class="n">EVENT_ID_MASK</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">event_cause</span> <span class="o">=</span> <span class="n">eventcause</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_info</span> <span class="o">=</span> <span class="n">MWIFIEX_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">rx_info</span><span class="o">-&gt;</span><span class="n">bss_num</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_num</span><span class="p">;</span>
		<span class="n">rx_info</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eventcause</span> <span class="o">!=</span> <span class="n">EVENT_PS_SLEEP</span> <span class="o">&amp;&amp;</span> <span class="n">eventcause</span> <span class="o">!=</span> <span class="n">EVENT_PS_AWAKE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tstamp</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;event: %lu.%lu: cause: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tstamp</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">tstamp</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="n">eventcause</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Handle PS_SLEEP/AWAKE events on STA */</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_STA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
			<span class="n">priv</span> <span class="o">=</span> <span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_process_sta_event</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">event_cause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">event_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">event_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is used to send synchronous command to the firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * it allocates a wait queue for the command and wait for the command</span>
<span class="cm"> * response.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_send_cmd_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">cmd_no</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd_oid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q_required</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_no</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">cmd_oid</span><span class="p">,</span>
				     <span class="n">data_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_wait_queue_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This function prepares a command and asynchronously send it to the firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Sanity tests to make sure the card is still present or the FW</span>
<span class="cm"> *        is not reset</span>
<span class="cm"> *      - Getting a new command node from the command free queue</span>
<span class="cm"> *      - Initializing the command node for default parameters</span>
<span class="cm"> *      - Fill up the non-default parameters and buffer pointers</span>
<span class="cm"> *      - Add the command to pending queue</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_send_cmd_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">cmd_no</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd_oid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;PREP_CMD: adapter is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PREP_CMD: device in suspended state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">surprise_removed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PREP_CMD: card is removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">==</span> <span class="n">MWIFIEX_HW_STATUS_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_no</span> <span class="o">!=</span> <span class="n">HostCmd_CMD_FUNC_INIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PREP_CMD: FW in reset state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Get a new command node */</span>
	<span class="n">cmd_node</span> <span class="o">=</span> <span class="n">mwifiex_get_cmd_node</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PREP_CMD: no free cmd node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the command node */</span>
	<span class="n">mwifiex_init_cmd_node</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">,</span> <span class="n">cmd_oid</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PREP_CMD: no free cmd buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span><span class="p">)),</span>
	       <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span><span class="p">));</span>

	<span class="n">cmd_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_no</span><span class="p">);</span>
	<span class="n">cmd_ptr</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Prepare command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_no</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HostCmd_CMD_UAP_SYS_CONFIG</span>:
		<span class="k">case</span> <span class="n">HostCmd_CMD_UAP_BSS_START</span>:
		<span class="k">case</span> <span class="n">HostCmd_CMD_UAP_BSS_STOP</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_uap_prepare_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_no</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
						      <span class="n">cmd_oid</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">,</span>
						      <span class="n">cmd_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_sta_prepare_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_no</span><span class="p">,</span> <span class="n">cmd_action</span><span class="p">,</span>
						      <span class="n">cmd_oid</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">,</span>
						      <span class="n">cmd_ptr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_cmd_host_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_ptr</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">);</span>
		<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_flag</span> <span class="o">|=</span> <span class="n">CMD_F_HOSTCMD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Return error, since the command preparation failed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PREP_CMD: cmd %#x preparation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd_no</span><span class="p">);</span>
		<span class="n">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_no</span> <span class="o">==</span> <span class="n">HostCmd_CMD_802_11_SCAN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mwifiex_queue_scan_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_queued</span> <span class="o">=</span> <span class="n">cmd_node</span><span class="p">;</span>
		<span class="n">mwifiex_insert_cmd_to_pending_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function returns a command to the command free queue.</span>
<span class="cm"> *</span>
<span class="cm"> * The function also calls the completion callback if required, before</span>
<span class="cm"> * cleaning the command node and re-inserting it into the free queue.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_node</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">)</span>
		<span class="n">mwifiex_complete_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">);</span>
	<span class="cm">/* Clean the node */</span>
	<span class="n">mwifiex_clean_cmd_node</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">);</span>

	<span class="cm">/* Insert node into cmd_free_q */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_free_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_free_q</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_free_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function queues a command to the command pending queue.</span>
<span class="cm"> *</span>
<span class="cm"> * This in effect adds the command to the command list to be executed.</span>
<span class="cm"> * Exit PS command is handled specially, by placing it always to the</span>
<span class="cm"> * front of the command queue.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_insert_cmd_to_pending_q</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">,</span> <span class="n">u32</span> <span class="n">add_tail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">host_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">command</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">host_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">host_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;QUEUE_CMD: host_cmd is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">command</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">host_cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>

	<span class="cm">/* Exit_PS command needs to be queued in the header always. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">==</span> <span class="n">HostCmd_CMD_802_11_PS_MODE_ENH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ps_mode_enh</span> <span class="o">*</span><span class="n">pm</span> <span class="o">=</span>
						<span class="o">&amp;</span><span class="n">host_cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">psmode_enh</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">==</span> <span class="n">DIS_PS</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">==</span> <span class="n">DIS_AUTO_PS</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_state</span> <span class="o">!=</span> <span class="n">PS_STATE_AWAKE</span><span class="p">)</span>
				<span class="n">add_tail</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">add_tail</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: QUEUE_CMD: cmd=%#x is queued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function executes the next command in command pending queue.</span>
<span class="cm"> *</span>
<span class="cm"> * This function will fail if a command is already in processing stage,</span>
<span class="cm"> * otherwise it will dequeue the first command from the command pending</span>
<span class="cm"> * queue and send to the firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * If the device is currently in host sleep mode, any commands, except the</span>
<span class="cm"> * host sleep configuration command will de-activate the host sleep. For PS</span>
<span class="cm"> * mode, the function will put the firmware back to sleep if applicable.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_exec_next_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">host_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd_pending_q_flags</span><span class="p">;</span>

	<span class="cm">/* Check if already in processing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;EXEC_NEXT_CMD: cmd in processing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>
	<span class="cm">/* Check if any command is pending */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span> <span class="n">cmd_pending_q_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span>
				       <span class="n">cmd_pending_q_flags</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd_node</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cmd_ctrl_node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span>
			       <span class="n">cmd_pending_q_flags</span><span class="p">);</span>

	<span class="n">host_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_state</span> <span class="o">!=</span> <span class="n">PS_STATE_AWAKE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cannot send cmd in sleep state,&quot;</span>
				<span class="s">&quot; this should not happen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span> <span class="n">cmd_pending_q_flags</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span>
			       <span class="n">cmd_pending_q_flags</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_dnld_cmd_to_fw</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">);</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">);</span>
	<span class="cm">/* Any command sent to the firmware when host is in sleep</span>
<span class="cm">	 * mode should de-configure host sleep. We should skip the</span>
<span class="cm">	 * host sleep configuration command itself though</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">host_cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">!=</span>
	     <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_HS_CFG_ENH</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hs_activated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_hs_configured</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">mwifiex_hs_activated_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles the command response.</span>
<span class="cm"> *</span>
<span class="cm"> * After processing, the function cleans the command node and puts</span>
<span class="cm"> * it back to the command free queue.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_process_cmdresp</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">orig_cmdresp_no</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cmdresp_no</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cmdresp_result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tstamp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Now we got response from FW, cancel the command timer */</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span> <span class="o">||</span> <span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">resp_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upld_buf</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CMD_RESP: NULL curr_cmd, %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_cmd_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">resp_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_flag</span> <span class="o">&amp;</span> <span class="n">CMD_F_CANCELED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CMD_RESP: %#x been canceled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">));</span>
		<span class="n">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_flag</span> <span class="o">&amp;</span> <span class="n">CMD_F_HOSTCMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Copy original response back to response buffer */</span>
		<span class="k">struct</span> <span class="n">mwifiex_ds_misc_cmd</span> <span class="o">*</span><span class="n">hostcmd</span><span class="p">;</span>
		<span class="kt">uint16_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: host cmd resp size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">MWIFIEX_SIZE_OF_CMD_BUFFER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hostcmd</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">data_buf</span><span class="p">;</span>
			<span class="n">hostcmd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">hostcmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">orig_cmdresp_no</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>

	<span class="cm">/* Get BSS number and corresponding priv */</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">mwifiex_get_priv_by_id</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
			     <span class="n">HostCmd_GET_BSS_NO</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">)),</span>
			     <span class="n">HostCmd_GET_BSS_TYPE</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">);</span>
	<span class="cm">/* Clear RET_BIT from HostCmd */</span>
	<span class="n">resp</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">orig_cmdresp_no</span> <span class="o">&amp;</span> <span class="n">HostCmd_CMD_ID_MASK</span><span class="p">);</span>

	<span class="n">cmdresp_no</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
	<span class="n">cmdresp_result</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>

	<span class="cm">/* Save the last command response to debug log */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_resp_index</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_resp_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">DBG_CMD_NUM</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_resp_id</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_resp_index</span><span class="p">]</span> <span class="o">=</span>
								<span class="n">orig_cmdresp_no</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tstamp</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: CMD_RESP: (%lu.%lu): 0x%x, result %d,&quot;</span>
		<span class="s">&quot; len %d, seqno 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">tstamp</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">tstamp</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span> <span class="n">orig_cmdresp_no</span><span class="p">,</span> <span class="n">cmdresp_result</span><span class="p">,</span>
	       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">orig_cmdresp_no</span> <span class="o">&amp;</span> <span class="n">HostCmd_RET_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CMD_RESP: invalid cmd resp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_flag</span> <span class="o">&amp;</span> <span class="n">CMD_F_HOSTCMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">cmd_flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMD_F_HOSTCMD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmdresp_result</span> <span class="o">==</span> <span class="n">HostCmd_RESULT_OK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cmdresp_no</span> <span class="o">==</span> <span class="n">HostCmd_CMD_802_11_HS_CFG_ENH</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_ret_802_11_hs_cfg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">resp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* handle response */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_process_sta_cmdresp</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmdresp_no</span><span class="p">,</span> <span class="n">resp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Check init command response */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">==</span> <span class="n">MWIFIEX_HW_STATUS_INITIALIZING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cmd %#x failed during &quot;</span>
				<span class="s">&quot;initialization</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">cmdresp_no</span><span class="p">);</span>
			<span class="n">mwifiex_init_fw_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">last_init_cmd</span> <span class="o">==</span> <span class="n">cmdresp_no</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">=</span> <span class="n">MWIFIEX_HW_STATUS_INIT_DONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* Clean up and put current command back to cmd_free_q */</span>
		<span class="n">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles the timeout of command sending.</span>
<span class="cm"> *</span>
<span class="cm"> * It will re-send the same command again.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_cmd_timeout_func</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">function_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="p">)</span> <span class="n">function_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">tstamp</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_cmd_timeout</span><span class="o">++</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">num_cmd_timeout</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: empty curr_cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd_node</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">timeout_cmd_id</span> <span class="o">=</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_id</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_index</span><span class="p">];</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">timeout_cmd_act</span> <span class="o">=</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_act</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_index</span><span class="p">];</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tstamp</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: Timeout cmd id (%lu.%lu) = %#x, act = %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">tstamp</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">,</span> <span class="n">tstamp</span><span class="p">.</span><span class="n">tv_usec</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">timeout_cmd_id</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">timeout_cmd_act</span><span class="p">);</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;num_data_h2c_failure = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">num_tx_host_to_card_failure</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;num_cmd_h2c_failure = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">num_cmd_host_to_card_failure</span><span class="p">);</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;num_cmd_timeout = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">num_cmd_timeout</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;num_tx_timeout = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">num_tx_timeout</span><span class="p">);</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;last_cmd_index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_index</span><span class="p">);</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;last_cmd_id: &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
				     <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_id</span><span class="p">,</span> <span class="n">DBG_CMD_NUM</span><span class="p">);</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;last_cmd_act: &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
				     <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_act</span><span class="p">,</span> <span class="n">DBG_CMD_NUM</span><span class="p">);</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;last_cmd_resp_index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_resp_index</span><span class="p">);</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;last_cmd_resp_id: &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
				     <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_cmd_resp_id</span><span class="p">,</span>
				     <span class="n">DBG_CMD_NUM</span><span class="p">);</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;last_event_index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_event_index</span><span class="p">);</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;last_event: &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
				     <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">last_event</span><span class="p">,</span> <span class="n">DBG_CMD_NUM</span><span class="p">);</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;data_sent=%d cmd_sent=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">data_sent</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_sent</span><span class="p">);</span>

		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ps_mode=%d ps_state=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_mode</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">==</span> <span class="n">MWIFIEX_HW_STATUS_INITIALIZING</span><span class="p">)</span>
		<span class="n">mwifiex_init_fw_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function cancels all the pending commands.</span>
<span class="cm"> *</span>
<span class="cm"> * The current command, all commands in command pending queue and all scan</span>
<span class="cm"> * commands in scan pending queue are cancelled. All the completion callbacks</span>
<span class="cm"> * are called with failure status to ensure cleanup.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_cancel_all_pending_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_node</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Cancel current cmd */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">mwifiex_complete_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Cancel all pending command */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">cmd_node</span><span class="p">,</span> <span class="n">tmp_node</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">mwifiex_complete_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">);</span>
			<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Cancel all pending scan command */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">cmd_node</span><span class="p">,</span> <span class="n">tmp_node</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_processing</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function cancels all pending commands that matches with</span>
<span class="cm"> * the given IOCTL request.</span>
<span class="cm"> *</span>
<span class="cm"> * Both the current command buffer and the pending command queue are</span>
<span class="cm"> * searched for matching IOCTL request. The completion callback of</span>
<span class="cm"> * the matched command is called with failure status to ensure cleanup.</span>
<span class="cm"> * In case of scan commands, all pending commands in scan pending queue</span>
<span class="cm"> * are cancelled.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_cancel_pending_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_node</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">scan_pending_q_flags</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cancel_scan_cmd</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>
		<span class="n">cmd_node</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">;</span>
		<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">cmd_flag</span> <span class="o">|=</span> <span class="n">CMD_F_CANCELED</span><span class="p">;</span>
		<span class="n">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">);</span>
		<span class="n">mwifiex_complete_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Cancel all pending scan command */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span>
			  <span class="n">scan_pending_q_flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">cmd_node</span><span class="p">,</span> <span class="n">tmp_node</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span>
				       <span class="n">scan_pending_q_flags</span><span class="p">);</span>
		<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">mwifiex_insert_cmd_to_free_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span>
				  <span class="n">scan_pending_q_flags</span><span class="p">);</span>
		<span class="n">cancel_scan_cmd</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span>
			       <span class="n">scan_pending_q_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cancel_scan_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_processing</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">cmd_flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function sends the sleep confirm command to firmware, if</span>
<span class="cm"> * possible.</span>
<span class="cm"> *</span>
<span class="cm"> * The sleep confirm command cannot be issued if command response,</span>
<span class="cm"> * data response or event response is awaiting handling, or if we</span>
<span class="cm"> * are in the middle of sending a command, or expecting a command</span>
<span class="cm"> * response.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_check_ps_cond</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_sent</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_CARD_RX_RCVD</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">mwifiex_dnld_sleep_confirm_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cmd: Delay Sleep Confirm (%s%s%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_sent</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;D&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;C&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">IS_CARD_RX_RCVD</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;R&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function sends a Host Sleep activated event to applications.</span>
<span class="cm"> *</span>
<span class="cm"> * This event is generated by the driver, with a blank event body.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_hs_activated_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">activated</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">activated</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_hs_configured</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hs_activated</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;event: hs_activated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hs_activate_wait_q_woken</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hs_activate_wait_q</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;event: HS not configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;event: hs_deactivated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hs_activated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles the command response of a Host Sleep configuration</span>
<span class="cm"> * command.</span>
<span class="cm"> *</span>
<span class="cm"> * Handling includes changing the header fields into CPU format</span>
<span class="cm"> * and setting the current host sleep activation status in driver.</span>
<span class="cm"> *</span>
<span class="cm"> * In case host sleep status change, the function generates an event to</span>
<span class="cm"> * notify the applications.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_ret_802_11_hs_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_hs_cfg_enh</span> <span class="o">*</span><span class="n">phs_cfg</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">opt_hs_cfg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">conditions</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">phs_cfg</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hs_config</span><span class="p">.</span><span class="n">conditions</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phs_cfg</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HS_ACTIVATE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mwifiex_hs_activated_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: CMD_RESP: HS_CFG cmd reply&quot;</span>
			<span class="s">&quot; result=%#x, conditions=0x%x gpio=0x%x gap=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">resp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">conditions</span><span class="p">,</span>
			<span class="n">phs_cfg</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hs_config</span><span class="p">.</span><span class="n">gpio</span><span class="p">,</span>
			<span class="n">phs_cfg</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hs_config</span><span class="p">.</span><span class="n">gap</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conditions</span> <span class="o">!=</span> <span class="n">HOST_SLEEP_CFG_CANCEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_hs_configured</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_hs_configured</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hs_activated</span><span class="p">)</span>
			<span class="n">mwifiex_hs_activated_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function wakes up the adapter and generates a Host Sleep</span>
<span class="cm"> * cancel event on receiving the power up interrupt.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_process_hs_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: %s: auto cancelling host sleep&quot;</span>
		<span class="s">&quot; since there is interrupt from the firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">wakeup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hs_activated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_hs_configured</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">mwifiex_hs_activated_event</span><span class="p">(</span><span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
						    <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">),</span>
				   <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mwifiex_process_hs_config</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles the command response of a sleep confirm command.</span>
<span class="cm"> *</span>
<span class="cm"> * The function sets the card state to SLEEP if the response indicates success.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_process_sleep_confirm_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">upld_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="p">)</span> <span class="n">pbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">command</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">seq_num</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">seq_num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">upld_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cmd size is 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get BSS number and corresponding priv */</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">mwifiex_get_priv_by_id</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">HostCmd_GET_BSS_NO</span><span class="p">(</span><span class="n">seq_num</span><span class="p">),</span>
				      <span class="n">HostCmd_GET_BSS_TYPE</span><span class="p">(</span><span class="n">seq_num</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">mwifiex_get_priv</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">);</span>

	<span class="cm">/* Update sequence number */</span>
	<span class="n">seq_num</span> <span class="o">=</span> <span class="n">HostCmd_GET_SEQ_NO</span><span class="p">(</span><span class="n">seq_num</span><span class="p">);</span>
	<span class="cm">/* Clear RET_BIT from HostCmd */</span>
	<span class="n">command</span> <span class="o">&amp;=</span> <span class="n">HostCmd_CMD_ID_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">!=</span> <span class="n">HostCmd_CMD_802_11_PS_MODE_ENH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: rcvd unexpected resp for cmd %#x, result = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: sleep confirm cmd failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pm_wakeup_card_req</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_state</span> <span class="o">=</span> <span class="n">PS_STATE_AWAKE</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pm_wakeup_card_req</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_hs_configured</span><span class="p">)</span>
		<span class="n">mwifiex_hs_activated_event</span><span class="p">(</span><span class="n">mwifiex_get_priv</span>
						<span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">MWIFIEX_BSS_ROLE_ANY</span><span class="p">),</span>
					   <span class="nb">true</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_state</span> <span class="o">=</span> <span class="n">PS_STATE_SLEEP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">seq_num</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">seq_num</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">mwifiex_process_sleep_confirm_resp</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares an enhanced power mode command.</span>
<span class="cm"> *</span>
<span class="cm"> * This function can be used to disable power save or to configure</span>
<span class="cm"> * power save with auto PS or STA PS or auto deep sleep.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting Power Save bitmap, PS parameters TLV, PS mode TLV,</span>
<span class="cm"> *        auto deep sleep TLV (as required)</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_cmd_enh_power_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">cmd_action</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">ps_bitmap</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">mwifiex_ds_auto_ds</span> <span class="o">*</span><span class="n">auto_ds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ps_mode_enh</span> <span class="o">*</span><span class="n">psmode_enh</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">psmode_enh</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tlv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmd_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_PS_MODE_ENH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_action</span> <span class="o">==</span> <span class="n">DIS_AUTO_PS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">DIS_AUTO_PS</span><span class="p">);</span>
		<span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ps_bitmap</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ps_bitmap</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">S_DS_GEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ps_bitmap</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_action</span> <span class="o">==</span> <span class="n">GET_PS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">GET_PS</span><span class="p">);</span>
		<span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ps_bitmap</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ps_bitmap</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">S_DS_GEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ps_bitmap</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd_action</span> <span class="o">==</span> <span class="n">EN_AUTO_PS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">EN_AUTO_PS</span><span class="p">);</span>
		<span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ps_bitmap</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ps_bitmap</span><span class="p">);</span>
		<span class="n">cmd_size</span> <span class="o">=</span> <span class="n">S_DS_GEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">psmode_enh</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ps_bitmap</span><span class="p">);</span>
		<span class="n">tlv</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span> <span class="o">+</span> <span class="n">cmd_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps_bitmap</span> <span class="o">&amp;</span> <span class="n">BITMAP_STA_PS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">mwifiex_ie_types_ps_param</span> <span class="o">*</span><span class="n">ps_tlv</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_ps_param</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">mwifiex_ps_param</span> <span class="o">*</span><span class="n">ps_mode</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ps_tlv</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
			<span class="n">ps_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_PS_PARAM</span><span class="p">);</span>
			<span class="n">ps_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ps_tlv</span><span class="p">)</span> <span class="o">-</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">));</span>
			<span class="n">cmd_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ps_tlv</span><span class="p">);</span>
			<span class="n">tlv</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ps_tlv</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: PS Command: Enter PS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ps_mode</span><span class="o">-&gt;</span><span class="n">null_pkt_interval</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">null_pkt_interval</span><span class="p">);</span>
			<span class="n">ps_mode</span><span class="o">-&gt;</span><span class="n">multiple_dtims</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">multiple_dtim</span><span class="p">);</span>
			<span class="n">ps_mode</span><span class="o">-&gt;</span><span class="n">bcn_miss_timeout</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bcn_miss_time_out</span><span class="p">);</span>
			<span class="n">ps_mode</span><span class="o">-&gt;</span><span class="n">local_listen_interval</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">local_listen_interval</span><span class="p">);</span>
			<span class="n">ps_mode</span><span class="o">-&gt;</span><span class="n">adhoc_wake_period</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_awake_period</span><span class="p">);</span>
			<span class="n">ps_mode</span><span class="o">-&gt;</span><span class="n">delay_to_ps</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">delay_to_ps</span><span class="p">);</span>
			<span class="n">ps_mode</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">enhanced_ps_mode</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps_bitmap</span> <span class="o">&amp;</span> <span class="n">BITMAP_AUTO_DS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mwifiex_ie_types_auto_ds_param</span> <span class="o">*</span><span class="n">auto_ds_tlv</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_auto_ds_param</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">idletime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">auto_ds_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_AUTO_DS_PARAM</span><span class="p">);</span>
			<span class="n">auto_ds_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">auto_ds_tlv</span><span class="p">)</span> <span class="o">-</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">));</span>
			<span class="n">cmd_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">auto_ds_tlv</span><span class="p">);</span>
			<span class="n">tlv</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">auto_ds_tlv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">auto_ds</span><span class="p">)</span>
				<span class="n">idletime</span> <span class="o">=</span> <span class="n">auto_ds</span><span class="o">-&gt;</span><span class="n">idle_time</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;cmd: PS Command: Enter Auto Deep Sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">auto_ds_tlv</span><span class="o">-&gt;</span><span class="n">deep_sleep_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">idletime</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles the command response of an enhanced power mode</span>
<span class="cm"> * command.</span>
<span class="cm"> *</span>
<span class="cm"> * Handling includes changing the header fields into CPU format</span>
<span class="cm"> * and setting the current enhanced power mode in driver.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_ret_enh_power_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">resp</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">mwifiex_ds_pm_cfg</span> <span class="o">*</span><span class="n">pm_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_ps_mode_enh</span> <span class="o">*</span><span class="n">ps_mode</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">psmode_enh</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">action</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ps_mode</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">ps_bitmap</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ps_mode</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ps_bitmap</span><span class="p">);</span>
	<span class="kt">uint16_t</span> <span class="n">auto_ps_bitmap</span> <span class="o">=</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ps_mode</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ps_bitmap</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;info: %s: PS_MODE cmd reply result=%#x action=%#X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">EN_AUTO_PS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">auto_ps_bitmap</span> <span class="o">&amp;</span> <span class="n">BITMAP_AUTO_DS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: Enabled auto deep sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_deep_sleep</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">auto_ps_bitmap</span> <span class="o">&amp;</span> <span class="n">BITMAP_STA_PS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: Enabled STA power save</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_period</span><span class="p">.</span><span class="n">period</span><span class="p">)</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;cmd: set to uapsd/pps mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">DIS_AUTO_PS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps_bitmap</span> <span class="o">&amp;</span> <span class="n">BITMAP_AUTO_DS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_deep_sleep</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: Disabled auto deep sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps_bitmap</span> <span class="o">&amp;</span> <span class="n">BITMAP_STA_PS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: Disabled STA power save</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_period</span><span class="p">.</span><span class="n">period</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">delay_null_pkt</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_lock_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pps_uapsd_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">GET_PS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ps_bitmap</span> <span class="o">&amp;</span> <span class="n">BITMAP_STA_PS</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_mode</span> <span class="o">=</span> <span class="n">MWIFIEX_802_11_POWER_MODE_PSP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_mode</span> <span class="o">=</span> <span class="n">MWIFIEX_802_11_POWER_MODE_CAM</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: ps_bitmap=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ps_bitmap</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pm_cfg</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This section is for get power save mode */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ps_bitmap</span> <span class="o">&amp;</span> <span class="n">BITMAP_STA_PS</span><span class="p">)</span>
				<span class="n">pm_cfg</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">ps_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">pm_cfg</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">.</span><span class="n">ps_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command to get hardware specifications.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID, action and proper size</span>
<span class="cm"> *      - Setting permanent address parameter</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_cmd_get_hw_spec</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_get_hw_spec</span> <span class="o">*</span><span class="n">hw_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hw_spec</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_GET_HW_SPEC</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_get_hw_spec</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">permanent_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles the command response of get hardware</span>
<span class="cm"> * specifications.</span>
<span class="cm"> *</span>
<span class="cm"> * Handling includes changing the header fields into CPU format</span>
<span class="cm"> * and saving/updating the following parameters in driver -</span>
<span class="cm"> *      - Firmware capability information</span>
<span class="cm"> *      - Firmware band settings</span>
<span class="cm"> *      - Ad-hoc start band and channel</span>
<span class="cm"> *      - Ad-hoc 11n activation status</span>
<span class="cm"> *      - Firmware release number</span>
<span class="cm"> *      - Number of antennas</span>
<span class="cm"> *      - Hardware address</span>
<span class="cm"> *      - Hardware interface version</span>
<span class="cm"> *      - Firmware version</span>
<span class="cm"> *      - Region code</span>
<span class="cm"> *      - 11n capabilities</span>
<span class="cm"> *      - MCS support fields</span>
<span class="cm"> *      - MP end port</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_ret_get_hw_spec</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_get_hw_spec</span> <span class="o">*</span><span class="n">hw_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">hw_spec</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_cap_info</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">fw_cap_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_SUPPORT_MULTI_BANDS</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_bands</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">GET_FW_DEFAULT_BANDS</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_bands</span> <span class="o">=</span> <span class="n">BAND_B</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_bands</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_bands</span> <span class="o">&amp;</span> <span class="n">BAND_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_bands</span> <span class="o">&amp;</span> <span class="n">BAND_GN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">|=</span> <span class="n">BAND_AN</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_bands</span> <span class="o">|=</span> <span class="n">BAND_AN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_bands</span> <span class="o">&amp;</span> <span class="n">BAND_AN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">=</span> <span class="n">BAND_A</span> <span class="o">|</span> <span class="n">BAND_AN</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_11n_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">=</span> <span class="n">BAND_A</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span> <span class="o">=</span> <span class="n">DEFAULT_AD_HOC_CHANNEL_A</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_bands</span> <span class="o">&amp;</span> <span class="n">BAND_GN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">=</span> <span class="n">BAND_G</span> <span class="o">|</span> <span class="n">BAND_B</span> <span class="o">|</span> <span class="n">BAND_GN</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span> <span class="o">=</span> <span class="n">DEFAULT_AD_HOC_CHANNEL</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_11n_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_bands</span> <span class="o">&amp;</span> <span class="n">BAND_G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">=</span> <span class="n">BAND_G</span> <span class="o">|</span> <span class="n">BAND_B</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span> <span class="o">=</span> <span class="n">DEFAULT_AD_HOC_CHANNEL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_bands</span> <span class="o">&amp;</span> <span class="n">BAND_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">=</span> <span class="n">BAND_B</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span> <span class="o">=</span> <span class="n">DEFAULT_AD_HOC_CHANNEL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_release_number</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">fw_release_number</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">number_of_antenna</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">number_of_antenna</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: GET_HW_SPEC: fw_release_number- %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_release_number</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: GET_HW_SPEC: permanent addr: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">permanent_addr</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;info: GET_HW_SPEC: hw_if_version=%#x version=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">hw_if_version</span><span class="p">),</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_addr</span><span class="p">,</span> <span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">permanent_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">region_code</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">region_code</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MWIFIEX_MAX_REGION_CODE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="cm">/* Use the region code to search for the index */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">region_code</span> <span class="o">==</span> <span class="n">region_code_index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* If it&#39;s unidentified region code, use the default (USA) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MWIFIEX_MAX_REGION_CODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">region_code</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cmd: unknown region code, use default (USA)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_dot_11n_dev_cap</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">dot_11n_dev_cap</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_dev_mcs_support</span> <span class="o">=</span> <span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">dev_mcs_support</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">update_mp_end_port</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">update_mp_end_port</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw_spec</span><span class="o">-&gt;</span><span class="n">mp_end_port</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
