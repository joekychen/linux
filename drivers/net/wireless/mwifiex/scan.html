<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › mwifiex › scan.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>scan.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Marvell Wireless LAN device driver: scan ioctl and command handling</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011, Marvell International Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This software file (the &quot;File&quot;) is distributed by Marvell International</span>
<span class="cm"> * Ltd. under the terms of the GNU General Public License Version 2, June 1991</span>
<span class="cm"> * (the &quot;License&quot;).  You may use, redistribute and/or modify this File in</span>
<span class="cm"> * accordance with the terms and conditions of the License, a copy of which</span>
<span class="cm"> * is available by writing to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA or on the</span>
<span class="cm"> * worldwide web at http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.</span>
<span class="cm"> *</span>
<span class="cm"> * THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE EXPRESSLY DISCLAIMED.  The License provides additional details about</span>
<span class="cm"> * this warranty disclaimer.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;decl.h&quot;</span>
<span class="cp">#include &quot;ioctl.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;fw.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;11n.h&quot;</span>
<span class="cp">#include &quot;cfg80211.h&quot;</span>

<span class="cm">/* The maximum number of channels the firmware can scan per command */</span>
<span class="cp">#define MWIFIEX_MAX_CHANNELS_PER_SPECIFIC_SCAN   14</span>

<span class="cp">#define MWIFIEX_CHANNELS_PER_SCAN_CMD            4</span>

<span class="cm">/* Memory needed to store a max sized Channel List TLV for a firmware scan */</span>
<span class="cp">#define CHAN_TLV_MAX_SIZE  (sizeof(struct mwifiex_ie_types_header)         \</span>
<span class="cp">				+ (MWIFIEX_MAX_CHANNELS_PER_SPECIFIC_SCAN     \</span>
<span class="cp">				*sizeof(struct mwifiex_chan_scan_param_set)))</span>

<span class="cm">/* Memory needed to store supported rate */</span>
<span class="cp">#define RATE_TLV_MAX_SIZE   (sizeof(struct mwifiex_ie_types_rates_param_set) \</span>
<span class="cp">				+ HOSTCMD_SUPPORTED_RATES)</span>

<span class="cm">/* Memory needed to store a max number/size WildCard SSID TLV for a firmware</span>
<span class="cm">	scan */</span>
<span class="cp">#define WILDCARD_SSID_TLV_MAX_SIZE  \</span>
<span class="cp">	(MWIFIEX_MAX_SSID_LIST_LENGTH *					\</span>
<span class="cp">		(sizeof(struct mwifiex_ie_types_wildcard_ssid_params)	\</span>
<span class="cp">			+ IEEE80211_MAX_SSID_LEN))</span>

<span class="cm">/* Maximum memory needed for a mwifiex_scan_cmd_config with all TLVs at max */</span>
<span class="cp">#define MAX_SCAN_CFG_ALLOC (sizeof(struct mwifiex_scan_cmd_config)        \</span>
<span class="cp">				+ sizeof(struct mwifiex_ie_types_num_probes)   \</span>
<span class="cp">				+ sizeof(struct mwifiex_ie_types_htcap)       \</span>
<span class="cp">				+ CHAN_TLV_MAX_SIZE                 \</span>
<span class="cp">				+ RATE_TLV_MAX_SIZE                 \</span>
<span class="cp">				+ WILDCARD_SSID_TLV_MAX_SIZE)</span>


<span class="k">union</span> <span class="n">mwifiex_scan_cmd_config_tlv</span> <span class="p">{</span>
	<span class="cm">/* Scan configuration (variable length) */</span>
	<span class="k">struct</span> <span class="n">mwifiex_scan_cmd_config</span> <span class="n">config</span><span class="p">;</span>
	<span class="cm">/* Max allocated block */</span>
	<span class="n">u8</span> <span class="n">config_alloc_buf</span><span class="p">[</span><span class="n">MAX_SCAN_CFG_ALLOC</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">cipher_suite</span> <span class="p">{</span>
	<span class="n">CIPHER_SUITE_TKIP</span><span class="p">,</span>
	<span class="n">CIPHER_SUITE_CCMP</span><span class="p">,</span>
	<span class="n">CIPHER_SUITE_MAX</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">mwifiex_wpa_oui</span><span class="p">[</span><span class="n">CIPHER_SUITE_MAX</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>	<span class="cm">/* TKIP */</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>	<span class="cm">/* AES  */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">mwifiex_rsn_oui</span><span class="p">[</span><span class="n">CIPHER_SUITE_MAX</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">},</span>	<span class="cm">/* TKIP */</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">,</span> <span class="mh">0x04</span> <span class="p">},</span>	<span class="cm">/* AES  */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This function parses a given IE for a given OUI.</span>
<span class="cm"> *</span>
<span class="cm"> * This is used to parse a WPA/RSN IE to find if it has</span>
<span class="cm"> * a given oui in PTK.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">mwifiex_search_oui_in_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">ie_body</span> <span class="o">*</span><span class="n">iebody</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">oui</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">iebody</span><span class="o">-&gt;</span><span class="n">ptk_cnt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* There could be multiple OUIs for PTK hence</span>
<span class="cm">	   1) Take the length.</span>
<span class="cm">	   2) Check all the OUIs for AES.</span>
<span class="cm">	   3) If one of them is AES then pass success. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">iebody</span><span class="o">-&gt;</span><span class="n">ptk_body</span><span class="p">,</span> <span class="n">oui</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iebody</span><span class="o">-&gt;</span><span class="n">ptk_body</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">MWIFIEX_OUI_PRESENT</span><span class="p">;</span>

		<span class="o">--</span><span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
			<span class="n">iebody</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ie_body</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">iebody</span> <span class="o">+</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">iebody</span><span class="o">-&gt;</span><span class="n">ptk_body</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;info: %s: OUI is not found in PTK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">MWIFIEX_OUI_NOT_PRESENT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if a given OUI is present in a RSN IE.</span>
<span class="cm"> *</span>
<span class="cm"> * The function first checks if a RSN IE is present or not in the</span>
<span class="cm"> * BSS descriptor. It tries to locate the OUI only if such an IE is</span>
<span class="cm"> * present.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">mwifiex_is_rsn_oui_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cipher</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">oui</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ie_body</span> <span class="o">*</span><span class="n">iebody</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">MWIFIEX_OUI_NOT_PRESENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)).</span>
					<span class="n">ieee_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">==</span> <span class="n">WLAN_EID_RSN</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">iebody</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ie_body</span> <span class="o">*</span><span class="p">)</span>
			 <span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span>
			  <span class="n">RSN_GTK_OUI_OFFSET</span><span class="p">);</span>
		<span class="n">oui</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mwifiex_rsn_oui</span><span class="p">[</span><span class="n">cipher</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_search_oui_in_ie</span><span class="p">(</span><span class="n">iebody</span><span class="p">,</span> <span class="n">oui</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if a given OUI is present in a WPA IE.</span>
<span class="cm"> *</span>
<span class="cm"> * The function first checks if a WPA IE is present or not in the</span>
<span class="cm"> * BSS descriptor. It tries to locate the OUI only if such an IE is</span>
<span class="cm"> * present.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">mwifiex_is_wpa_oui_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cipher</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">oui</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ie_body</span> <span class="o">*</span><span class="n">iebody</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">MWIFIEX_OUI_NOT_PRESENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)).</span><span class="n">vend_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">==</span>
	      <span class="n">WLAN_EID_WPA</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">iebody</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ie_body</span> <span class="o">*</span><span class="p">)</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">oui</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mwifiex_wpa_oui</span><span class="p">[</span><span class="n">cipher</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_search_oui_in_ie</span><span class="p">(</span><span class="n">iebody</span><span class="p">,</span> <span class="n">oui</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function compares two SSIDs and checks if they match.</span>
<span class="cm"> */</span>
<span class="n">s32</span>
<span class="nf">mwifiex_ssid_cmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_ssid</span> <span class="o">*</span><span class="n">ssid1</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfg80211_ssid</span> <span class="o">*</span><span class="n">ssid2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssid1</span> <span class="o">||</span> <span class="o">!</span><span class="n">ssid2</span> <span class="o">||</span> <span class="p">(</span><span class="n">ssid1</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">!=</span> <span class="n">ssid2</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">ssid1</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid2</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid1</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if wapi is enabled in driver and scanned network is</span>
<span class="cm"> * compatible with it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">mwifiex_is_bss_wapi</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wapi_enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wapi_ie</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wapi_ie</span><span class="p">)).</span><span class="n">ieee_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">==</span>
			<span class="n">WLAN_EID_BSS_AC_ACCESS_DELAY</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if driver is configured with no security mode and</span>
<span class="cm"> * scanned network is compatible with it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">mwifiex_is_bss_no_sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="o">!</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)).</span><span class="n">vend_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">!=</span>
		 <span class="n">WLAN_EID_WPA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="o">!</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)).</span><span class="n">ieee_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">!=</span>
		 <span class="n">WLAN_EID_RSN</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">encryption_mode</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if static WEP is enabled in driver and scanned network</span>
<span class="cm"> * is compatible with it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">mwifiex_is_bss_static_wep</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if wpa is enabled in driver and scanned network is</span>
<span class="cm"> * compatible with it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">mwifiex_is_bss_wpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)).</span><span class="n">vend_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">==</span> <span class="n">WLAN_EID_WPA</span><span class="p">))</span>
	   <span class="cm">/*</span>
<span class="cm">	    * Privacy bit may NOT be set in some APs like</span>
<span class="cm">	    * LinkSys WRT54G &amp;&amp; bss_desc-&gt;privacy</span>
<span class="cm">	    */</span>
	 <span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: %s: WPA:&quot;</span>
			<span class="s">&quot; wpa_ie=%#x wpa2_ie=%#x WEP=%s WPA=%s WPA2=%s &quot;</span>
			<span class="s">&quot;EncMode=%#x privacy=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)).</span>
			<span class="n">vend_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)).</span>
			<span class="n">ieee_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;e&quot;</span> <span class="o">:</span> <span class="s">&quot;d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;e&quot;</span> <span class="o">:</span> <span class="s">&quot;d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;e&quot;</span> <span class="o">:</span> <span class="s">&quot;d&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">encryption_mode</span><span class="p">,</span>
			<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if wpa2 is enabled in driver and scanned network is</span>
<span class="cm"> * compatible with it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">mwifiex_is_bss_wpa2</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)).</span><span class="n">ieee_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">==</span> <span class="n">WLAN_EID_RSN</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Privacy bit may NOT be set in some APs like</span>
<span class="cm">		 * LinkSys WRT54G &amp;&amp; bss_desc-&gt;privacy</span>
<span class="cm">		 */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: %s: WPA2: &quot;</span>
			<span class="s">&quot; wpa_ie=%#x wpa2_ie=%#x WEP=%s WPA=%s WPA2=%s &quot;</span>
			<span class="s">&quot;EncMode=%#x privacy=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)).</span>
			<span class="n">vend_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)).</span>
			<span class="n">ieee_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;e&quot;</span> <span class="o">:</span> <span class="s">&quot;d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;e&quot;</span> <span class="o">:</span> <span class="s">&quot;d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;e&quot;</span> <span class="o">:</span> <span class="s">&quot;d&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">encryption_mode</span><span class="p">,</span>
			<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if adhoc AES is enabled in driver and scanned network is</span>
<span class="cm"> * compatible with it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">mwifiex_is_bss_adhoc_aes</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="o">!</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)).</span><span class="n">vend_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">!=</span> <span class="n">WLAN_EID_WPA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="o">!</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)).</span><span class="n">ieee_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">!=</span> <span class="n">WLAN_EID_RSN</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">encryption_mode</span> <span class="o">&amp;&amp;</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if dynamic WEP is enabled in driver and scanned network</span>
<span class="cm"> * is compatible with it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">mwifiex_is_bss_dynamic_wep</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="o">!</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)).</span><span class="n">vend_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">!=</span> <span class="n">WLAN_EID_WPA</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="o">!</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)).</span><span class="n">ieee_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">!=</span> <span class="n">WLAN_EID_RSN</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">encryption_mode</span> <span class="o">&amp;&amp;</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: %s: dynamic &quot;</span>
			<span class="s">&quot;WEP: wpa_ie=%#x wpa2_ie=%#x &quot;</span>
			<span class="s">&quot;EncMode=%#x privacy=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span>
			<span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)).</span>
			<span class="n">vend_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)).</span>
			<span class="n">ieee_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">encryption_mode</span><span class="p">,</span>
			<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks if a scanned network is compatible with the driver</span>
<span class="cm"> * settings.</span>
<span class="cm"> *</span>
<span class="cm"> *   WEP     WPA    WPA2   ad-hoc encrypt                  Network</span>
<span class="cm"> * enabled enabled enabled  AES    mode   Privacy WPA WPA2 Compatible</span>
<span class="cm"> *    0       0       0      0     NONE      0     0   0   yes No security</span>
<span class="cm"> *    0       1       0      0      x        1x    1   x   yes WPA (disable</span>
<span class="cm"> *                                                         HT if no AES)</span>
<span class="cm"> *    0       0       1      0      x        1x    x   1   yes WPA2 (disable</span>
<span class="cm"> *                                                         HT if no AES)</span>
<span class="cm"> *    0       0       0      1     NONE      1     0   0   yes Ad-hoc AES</span>
<span class="cm"> *    1       0       0      0     NONE      1     0   0   yes Static WEP</span>
<span class="cm"> *                                                         (disable HT)</span>
<span class="cm"> *    0       0       0      0    !=NONE     1     0   0   yes Dynamic WEP</span>
<span class="cm"> *</span>
<span class="cm"> * Compatibility is not matched while roaming, except for mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span>
<span class="nf">mwifiex_is_network_compatible</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>

	<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">disable_11n</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t check for compatibility if roaming */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">media_connected</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps</span><span class="p">.</span><span class="n">session_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;info: return success directly in WPS period</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_is_bss_wapi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: return success for WAPI AP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_is_bss_no_sec</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* No security */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_is_bss_static_wep</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Static WEP enabled */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: Disable 11n in WEP mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">disable_11n</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_is_bss_wpa</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* WPA enabled */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">&amp;</span> <span class="n">BAND_GN</span> <span class="o">||</span>
			      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">&amp;</span> <span class="n">BAND_AN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_ht_cap</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">mwifiex_is_wpa_oui_present</span><span class="p">(</span><span class="n">bss_desc</span><span class="p">,</span>
							 <span class="n">CIPHER_SUITE_CCMP</span><span class="p">))</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_is_wpa_oui_present</span>
						<span class="p">(</span><span class="n">bss_desc</span><span class="p">,</span> <span class="n">CIPHER_SUITE_TKIP</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;info: Disable 11n if AES &quot;</span>
						<span class="s">&quot;is not supported by AP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">disable_11n</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_is_bss_wpa2</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* WPA2 enabled */</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">&amp;</span> <span class="n">BAND_GN</span> <span class="o">||</span>
			      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">&amp;</span> <span class="n">BAND_AN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_ht_cap</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">mwifiex_is_rsn_oui_present</span><span class="p">(</span><span class="n">bss_desc</span><span class="p">,</span>
							<span class="n">CIPHER_SUITE_CCMP</span><span class="p">))</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_is_rsn_oui_present</span>
						<span class="p">(</span><span class="n">bss_desc</span><span class="p">,</span> <span class="n">CIPHER_SUITE_TKIP</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;info: Disable 11n if AES &quot;</span>
						<span class="s">&quot;is not supported by AP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">disable_11n</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_is_bss_adhoc_aes</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Ad-hoc AES enabled */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_is_bss_dynamic_wep</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Dynamic WEP enabled */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Security doesn&#39;t match */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;info: %s: failed: wpa_ie=%#x wpa2_ie=%#x WEP=%s &quot;</span>
			<span class="s">&quot;WPA=%s WPA2=%s EncMode=%#x privacy=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)).</span><span class="n">vend_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)</span> <span class="o">?</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)).</span><span class="n">ieee_hdr</span><span class="p">.</span><span class="n">element_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;e&quot;</span> <span class="o">:</span> <span class="s">&quot;d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa_enabled</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;e&quot;</span> <span class="o">:</span> <span class="s">&quot;d&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wpa2_enabled</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;e&quot;</span> <span class="o">:</span> <span class="s">&quot;d&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">encryption_mode</span><span class="p">,</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mode doesn&#39;t match */</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function creates a channel list for the driver to scan, based</span>
<span class="cm"> * on region/band information.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is used for any scan that is not provided with a</span>
<span class="cm"> * specific channel list to scan.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwifiex_scan_create_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">mwifiex_user_scan_cfg</span>
							<span class="o">*</span><span class="n">user_scan_in</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span>
							<span class="o">*</span><span class="n">scan_chan_list</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">filtered_scan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">)</span> <span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">sband</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">)</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">scan_chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">radio_type</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">user_scan_in</span> <span class="o">&amp;&amp;</span>
			    <span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">scan_time</span><span class="p">)</span>
				<span class="n">scan_chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">max_scan_time</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">user_scan_in</span><span class="o">-&gt;</span>
					<span class="n">chan_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">scan_time</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span><span class="p">)</span>
				<span class="n">scan_chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">max_scan_time</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">passive_scan_time</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">scan_chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">max_scan_time</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_scan_time</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span><span class="p">)</span>
				<span class="n">scan_chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">chan_scan_mode_bitmap</span>
					<span class="o">|=</span> <span class="n">MWIFIEX_PASSIVE_SCAN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">scan_chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">chan_scan_mode_bitmap</span>
					<span class="o">&amp;=</span> <span class="o">~</span><span class="n">MWIFIEX_PASSIVE_SCAN</span><span class="p">;</span>
			<span class="n">scan_chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">chan_number</span> <span class="o">=</span>
							<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">filtered_scan</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scan_chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">max_scan_time</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">specific_scan_time</span><span class="p">);</span>
				<span class="n">scan_chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">chan_scan_mode_bitmap</span>
					<span class="o">|=</span> <span class="n">MWIFIEX_DISABLE_CHAN_FILT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">chan_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function constructs and sends multiple scan config commands to</span>
<span class="cm"> * the firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * Previous routines in the code flow have created a scan command configuration</span>
<span class="cm"> * with any requested TLVs.  This function splits the channel TLV into maximum</span>
<span class="cm"> * channels supported per scan lists and sends the portion of the channel TLV,</span>
<span class="cm"> * along with the other TLVs, to the firmware.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_scan_channel_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			  <span class="n">u32</span> <span class="n">max_chan_per_scan</span><span class="p">,</span> <span class="n">u8</span> <span class="n">filtered_scan</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">mwifiex_scan_cmd_config</span> <span class="o">*</span><span class="n">scan_cfg_out</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">mwifiex_ie_types_chan_list_param_set</span>
			  <span class="o">*</span><span class="n">chan_tlv_out</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span> <span class="o">*</span><span class="n">scan_chan_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span> <span class="o">*</span><span class="n">tmp_chan_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span> <span class="o">*</span><span class="n">start_chan</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">tlv_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">total_scan_time</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">done_early</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scan_cfg_out</span> <span class="o">||</span> <span class="o">!</span><span class="n">chan_tlv_out</span> <span class="o">||</span> <span class="o">!</span><span class="n">scan_chan_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;info: Scan: Null detect: %p, %p, %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">scan_cfg_out</span><span class="p">,</span> <span class="n">chan_tlv_out</span><span class="p">,</span> <span class="n">scan_chan_list</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan_tlv_out</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_CHANLIST</span><span class="p">);</span>

	<span class="cm">/* Set the temp channel struct pointer to the start of the desired</span>
<span class="cm">	   list */</span>
	<span class="n">tmp_chan_list</span> <span class="o">=</span> <span class="n">scan_chan_list</span><span class="p">;</span>

	<span class="cm">/* Loop through the desired channel list, sending a new firmware scan</span>
<span class="cm">	   commands for each max_chan_per_scan channels (or for 1,6,11</span>
<span class="cm">	   individually if configured accordingly) */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">chan_number</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">tlv_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">total_scan_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chan_tlv_out</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">start_chan</span> <span class="o">=</span> <span class="n">tmp_chan_list</span><span class="p">;</span>
		<span class="n">done_early</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Construct the Channel TLV for the scan command.  Continue to</span>
<span class="cm">		 * insert channel TLVs until:</span>
<span class="cm">		 *   - the tlv_idx hits the maximum configured per scan command</span>
<span class="cm">		 *   - the next channel to insert is 0 (end of desired channel</span>
<span class="cm">		 *     list)</span>
<span class="cm">		 *   - done_early is set (controlling individual scanning of</span>
<span class="cm">		 *     1,6,11)</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tlv_idx</span> <span class="o">&lt;</span> <span class="n">max_chan_per_scan</span> <span class="o">&amp;&amp;</span>
		       <span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">chan_number</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">done_early</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;info: Scan: Chan(%3d), Radio(%d),&quot;</span>
				<span class="s">&quot; Mode(%d, %d), Dur(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">chan_number</span><span class="p">,</span>
				<span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">radio_type</span><span class="p">,</span>
				<span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">chan_scan_mode_bitmap</span>
				<span class="o">&amp;</span> <span class="n">MWIFIEX_PASSIVE_SCAN</span><span class="p">,</span>
				<span class="p">(</span><span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">chan_scan_mode_bitmap</span>
				 <span class="o">&amp;</span> <span class="n">MWIFIEX_DISABLE_CHAN_FILT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">max_scan_time</span><span class="p">));</span>

			<span class="cm">/* Copy the current channel TLV to the command being</span>
<span class="cm">			   prepared */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">chan_tlv_out</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span> <span class="o">+</span> <span class="n">tlv_idx</span><span class="p">,</span>
			       <span class="n">tmp_chan_list</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">chan_tlv_out</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">));</span>

			<span class="cm">/* Increment the TLV header length by the size</span>
<span class="cm">			   appended */</span>
			<span class="n">chan_tlv_out</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">chan_tlv_out</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">chan_tlv_out</span><span class="o">-&gt;</span><span class="n">chan_scan_param</span><span class="p">)));</span>

			<span class="cm">/*</span>
<span class="cm">			 * The tlv buffer length is set to the number of bytes</span>
<span class="cm">			 * of the between the channel tlv pointer and the start</span>
<span class="cm">			 * of the tlv buffer.  This compensates for any TLVs</span>
<span class="cm">			 * that were appended before the channel list.</span>
<span class="cm">			 */</span>
			<span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">tlv_buf_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">chan_tlv_out</span> <span class="o">-</span>
							<span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">tlv_buf</span><span class="p">);</span>

			<span class="cm">/* Add the size of the channel tlv header and the data</span>
<span class="cm">			   length */</span>
			<span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">tlv_buf_len</span> <span class="o">+=</span>
				<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">chan_tlv_out</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span>
				 <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">chan_tlv_out</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">));</span>

			<span class="cm">/* Increment the index to the channel tlv we are</span>
<span class="cm">			   constructing */</span>
			<span class="n">tlv_idx</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Count the total scan time per command */</span>
			<span class="n">total_scan_time</span> <span class="o">+=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">max_scan_time</span><span class="p">);</span>

			<span class="n">done_early</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="cm">/* Stop the loop if the *current* channel is in the</span>
<span class="cm">			   1,6,11 set and we are not filtering on a BSSID</span>
<span class="cm">			   or SSID. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filtered_scan</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">chan_number</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span>
			     <span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">chan_number</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">||</span>
			     <span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">chan_number</span> <span class="o">==</span> <span class="mi">11</span><span class="p">))</span>
				<span class="n">done_early</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="cm">/* Increment the tmp pointer to the next channel to</span>
<span class="cm">			   be scanned */</span>
			<span class="n">tmp_chan_list</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Stop the loop if the *next* channel is in the 1,6,11</span>
<span class="cm">			   set.  This will cause it to be the only channel</span>
<span class="cm">			   scanned on the next interation */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filtered_scan</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">chan_number</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span>
			     <span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">chan_number</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">||</span>
			     <span class="n">tmp_chan_list</span><span class="o">-&gt;</span><span class="n">chan_number</span> <span class="o">==</span> <span class="mi">11</span><span class="p">))</span>
				<span class="n">done_early</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* The total scan time should be less than scan command timeout</span>
<span class="cm">		   value */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total_scan_time</span> <span class="o">&gt;</span> <span class="n">MWIFIEX_MAX_TOTAL_SCAN_TIME</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;total scan time %dms&quot;</span>
				<span class="s">&quot; is over limit (%dms), scan skipped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">total_scan_time</span><span class="p">,</span> <span class="n">MWIFIEX_MAX_TOTAL_SCAN_TIME</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_channels</span> <span class="o">=</span> <span class="n">start_chan</span><span class="p">;</span>

		<span class="cm">/* Send the scan command to the firmware with the specified</span>
<span class="cm">		   cfg */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_802_11_SCAN</span><span class="p">,</span>
					     <span class="n">HostCmd_ACT_GEN_SET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="n">scan_cfg_out</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function constructs a scan command configuration structure to use</span>
<span class="cm"> * in scan commands.</span>
<span class="cm"> *</span>
<span class="cm"> * Application layer or other functions can invoke network scanning</span>
<span class="cm"> * with a scan configuration supplied in a user scan configuration structure.</span>
<span class="cm"> * This structure is used as the basis of one or many scan command configuration</span>
<span class="cm"> * commands that are sent to the command processing module and eventually to the</span>
<span class="cm"> * firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * This function creates a scan command configuration structure  based on the</span>
<span class="cm"> * following user supplied parameters (if present):</span>
<span class="cm"> *      - SSID filter</span>
<span class="cm"> *      - BSSID filter</span>
<span class="cm"> *      - Number of Probes to be sent</span>
<span class="cm"> *      - Channel list</span>
<span class="cm"> *</span>
<span class="cm"> * If the SSID or BSSID filter is not present, the filter is disabled/cleared.</span>
<span class="cm"> * If the number of probes is not set, adapter default setting is used.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwifiex_config_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		    <span class="k">const</span> <span class="k">struct</span> <span class="n">mwifiex_user_scan_cfg</span> <span class="o">*</span><span class="n">user_scan_in</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">mwifiex_scan_cmd_config</span> <span class="o">*</span><span class="n">scan_cfg_out</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">mwifiex_ie_types_chan_list_param_set</span> <span class="o">**</span><span class="n">chan_list_out</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span> <span class="o">*</span><span class="n">scan_chan_list</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="o">*</span><span class="n">max_chan_per_scan</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">filtered_scan</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="o">*</span><span class="n">scan_current_only</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_num_probes</span> <span class="o">*</span><span class="n">num_probes_tlv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_wildcard_ssid_params</span> <span class="o">*</span><span class="n">wildcard_ssid_tlv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_rates_param_set</span> <span class="o">*</span><span class="n">rates_tlv</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">zero_mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tlv_pos</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_probes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chan_idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scan_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scan_dur</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">radio_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ssid_filter</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="n">MWIFIEX_SUPPORTED_RATES</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">rates_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_htcap</span> <span class="o">*</span><span class="n">ht_cap</span><span class="p">;</span>

	<span class="cm">/* The tlv_buf_len is calculated for each scan command.  The TLVs added</span>
<span class="cm">	   in this routine will be preserved since the routine that sends the</span>
<span class="cm">	   command will append channelTLVs at *chan_list_out.  The difference</span>
<span class="cm">	   between the *chan_list_out and the tlv_buf start will be used to</span>
<span class="cm">	   calculate the size of anything we add in this routine. */</span>
	<span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">tlv_buf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Running tlv pointer.  Assigned to chan_list_out at end of function</span>
<span class="cm">	   so later routines know where channels can be added to the command</span>
<span class="cm">	   buf */</span>
	<span class="n">tlv_pos</span> <span class="o">=</span> <span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">tlv_buf</span><span class="p">;</span>

	<span class="cm">/* Initialize the scan as un-filtered; the flag is later set to TRUE</span>
<span class="cm">	   below if a SSID or BSSID filter is sent in the command */</span>
	<span class="o">*</span><span class="n">filtered_scan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Initialize the scan as not being only on the current channel.  If</span>
<span class="cm">	   the channel list is customized, only contains one channel, and is</span>
<span class="cm">	   the active channel, this is set true and data flow is not halted. */</span>
	<span class="o">*</span><span class="n">scan_current_only</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_scan_in</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Default the ssid_filter flag to TRUE, set false under</span>
<span class="cm">		   certain wildcard conditions and qualified by the existence</span>
<span class="cm">		   of an SSID list before marking the scan as filtered */</span>
		<span class="n">ssid_filter</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="cm">/* Set the BSS type scan filter, use Adapter setting if</span>
<span class="cm">		   unset */</span>
		<span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">?</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">user_scan_in</span><span class="o">-&gt;</span>
			 <span class="n">bss_mode</span> <span class="o">:</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_mode</span><span class="p">);</span>

		<span class="cm">/* Set the number of probes to send, use Adapter setting</span>
<span class="cm">		   if unset */</span>
		<span class="n">num_probes</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">num_probes</span> <span class="o">?</span> <span class="n">user_scan_in</span><span class="o">-&gt;</span>
			 <span class="n">num_probes</span> <span class="o">:</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_probes</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set the BSSID filter to the incoming configuration,</span>
<span class="cm">		 * if non-zero.  If not set, it will remain disabled</span>
<span class="cm">		 * (all zeros).</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">specific_bssid</span><span class="p">,</span>
		       <span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">specific_bssid</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">specific_bssid</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">num_ssids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">ssid_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">;</span>

			<span class="n">wildcard_ssid_tlv</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_wildcard_ssid_params</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">tlv_pos</span><span class="p">;</span>
			<span class="n">wildcard_ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_WILDCARDSSID</span><span class="p">);</span>
			<span class="n">wildcard_ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
				<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ssid_len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wildcard_ssid_tlv</span><span class="o">-&gt;</span>
							 <span class="n">max_ssid_length</span><span class="p">)));</span>

			<span class="cm">/*</span>
<span class="cm">			 * max_ssid_length = 0 tells firmware to perform</span>
<span class="cm">			 * specific scan for the SSID filled, whereas</span>
<span class="cm">			 * max_ssid_length = IEEE80211_MAX_SSID_LEN is for</span>
<span class="cm">			 * wildcard scan.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssid_len</span><span class="p">)</span>
				<span class="n">wildcard_ssid_tlv</span><span class="o">-&gt;</span><span class="n">max_ssid_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">wildcard_ssid_tlv</span><span class="o">-&gt;</span><span class="n">max_ssid_length</span> <span class="o">=</span>
							<span class="n">IEEE80211_MAX_SSID_LEN</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">wildcard_ssid_tlv</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
			       <span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">ssid_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>

			<span class="n">tlv_pos</span> <span class="o">+=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">wildcard_ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wildcard_ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">));</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: scan: ssid[%d]: %s, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">wildcard_ssid_tlv</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span>
				<span class="n">wildcard_ssid_tlv</span><span class="o">-&gt;</span><span class="n">max_ssid_length</span><span class="p">);</span>

			<span class="cm">/* Empty wildcard ssid with a maxlen will match many or</span>
<span class="cm">			   potentially all SSIDs (maxlen == 32), therefore do</span>
<span class="cm">			   not treat the scan as</span>
<span class="cm">			   filtered. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssid_len</span> <span class="o">&amp;&amp;</span> <span class="n">wildcard_ssid_tlv</span><span class="o">-&gt;</span><span class="n">max_ssid_length</span><span class="p">)</span>
				<span class="n">ssid_filter</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 *  The default number of channels sent in the command is low to</span>
<span class="cm">		 *  ensure the response buffer from the firmware does not</span>
<span class="cm">		 *  truncate scan results.  That is not an issue with an SSID</span>
<span class="cm">		 *  or BSSID filter applied to the scan results in the firmware.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">ssid_filter</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">specific_bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero_mac</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="n">zero_mac</span><span class="p">)))</span>
			<span class="o">*</span><span class="n">filtered_scan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_mode</span><span class="p">;</span>
		<span class="n">num_probes</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_probes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *  If a specific BSSID or SSID is used, the number of channels in the</span>
<span class="cm">	 *  scan command will be increased to the absolute maximum.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">filtered_scan</span><span class="p">)</span>
		<span class="o">*</span><span class="n">max_chan_per_scan</span> <span class="o">=</span> <span class="n">MWIFIEX_MAX_CHANNELS_PER_SPECIFIC_SCAN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">max_chan_per_scan</span> <span class="o">=</span> <span class="n">MWIFIEX_CHANNELS_PER_SCAN_CMD</span><span class="p">;</span>

	<span class="cm">/* If the input config or adapter has the number of Probes set,</span>
<span class="cm">	   add tlv */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_probes</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: scan: num_probes = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">num_probes</span><span class="p">);</span>

		<span class="n">num_probes_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_num_probes</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv_pos</span><span class="p">;</span>
		<span class="n">num_probes_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_NUMPROBES</span><span class="p">);</span>
		<span class="n">num_probes_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">num_probes_tlv</span><span class="o">-&gt;</span><span class="n">num_probes</span><span class="p">));</span>
		<span class="n">num_probes_tlv</span><span class="o">-&gt;</span><span class="n">num_probes</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">num_probes</span><span class="p">);</span>

		<span class="n">tlv_pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">num_probes_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">num_probes_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="cm">/* Append rates tlv */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rates</span><span class="p">));</span>

	<span class="n">rates_size</span> <span class="o">=</span> <span class="n">mwifiex_get_supported_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rates</span><span class="p">);</span>

	<span class="n">rates_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_rates_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv_pos</span><span class="p">;</span>
	<span class="n">rates_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_EID_SUPP_RATES</span><span class="p">);</span>
	<span class="n">rates_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">rates_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">rates_tlv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="n">rates_size</span><span class="p">);</span>
	<span class="n">tlv_pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rates_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">rates_size</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: SCAN_CMD: Rates size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rates_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ISSUPP_11NENABLED</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_cap_info</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">&amp;</span> <span class="n">BAND_GN</span> <span class="o">||</span>
	     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">&amp;</span> <span class="n">BAND_AN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ht_cap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_htcap</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv_pos</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ht_cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_htcap</span><span class="p">));</span>
		<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_EID_HT_CAPABILITY</span><span class="p">);</span>
		<span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_cap</span><span class="p">));</span>
		<span class="n">radio_type</span> <span class="o">=</span>
			<span class="n">mwifiex_band_to_radio_type</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span><span class="p">);</span>
		<span class="n">mwifiex_fill_cap_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">radio_type</span><span class="p">,</span> <span class="n">ht_cap</span><span class="p">);</span>
		<span class="n">tlv_pos</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_htcap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Append vendor specific IE TLV */</span>
	<span class="n">mwifiex_cmd_append_vsie_tlv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MWIFIEX_VSIE_MASK_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tlv_pos</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the output for the channel TLV to the address in the tlv buffer</span>
<span class="cm">	 *   past any TLVs that were added in this function (SSID, num_probes).</span>
<span class="cm">	 *   Channel TLVs will be added past this for each scan command,</span>
<span class="cm">	 *   preserving the TLVs that were previously added.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">chan_list_out</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_chan_list_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv_pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">user_scan_in</span> <span class="o">&amp;&amp;</span> <span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">chan_number</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: Scan: Using supplied channel list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">chan_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">chan_idx</span> <span class="o">&lt;</span> <span class="n">MWIFIEX_USER_SCAN_CHAN_MAX</span> <span class="o">&amp;&amp;</span>
		     <span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">chan_number</span><span class="p">;</span>
		     <span class="n">chan_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">channel</span> <span class="o">=</span> <span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">chan_number</span><span class="p">;</span>
			<span class="p">(</span><span class="n">scan_chan_list</span> <span class="o">+</span> <span class="n">chan_idx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">chan_number</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

			<span class="n">radio_type</span> <span class="o">=</span>
				<span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">radio_type</span><span class="p">;</span>
			<span class="p">(</span><span class="n">scan_chan_list</span> <span class="o">+</span> <span class="n">chan_idx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">radio_type</span> <span class="o">=</span> <span class="n">radio_type</span><span class="p">;</span>

			<span class="n">scan_type</span> <span class="o">=</span> <span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">scan_type</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">scan_type</span> <span class="o">==</span> <span class="n">MWIFIEX_SCAN_TYPE_PASSIVE</span><span class="p">)</span>
				<span class="p">(</span><span class="n">scan_chan_list</span> <span class="o">+</span>
				 <span class="n">chan_idx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">chan_scan_mode_bitmap</span>
					<span class="o">|=</span> <span class="n">MWIFIEX_PASSIVE_SCAN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="p">(</span><span class="n">scan_chan_list</span> <span class="o">+</span>
				 <span class="n">chan_idx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">chan_scan_mode_bitmap</span>
					<span class="o">&amp;=</span> <span class="o">~</span><span class="n">MWIFIEX_PASSIVE_SCAN</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">scan_time</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scan_dur</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">user_scan_in</span><span class="o">-&gt;</span>
					<span class="n">chan_list</span><span class="p">[</span><span class="n">chan_idx</span><span class="p">].</span><span class="n">scan_time</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scan_type</span> <span class="o">==</span> <span class="n">MWIFIEX_SCAN_TYPE_PASSIVE</span><span class="p">)</span>
					<span class="n">scan_dur</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">passive_scan_time</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">filtered_scan</span><span class="p">)</span>
					<span class="n">scan_dur</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">specific_scan_time</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">scan_dur</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_scan_time</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="p">(</span><span class="n">scan_chan_list</span> <span class="o">+</span> <span class="n">chan_idx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">min_scan_time</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scan_dur</span><span class="p">);</span>
			<span class="p">(</span><span class="n">scan_chan_list</span> <span class="o">+</span> <span class="n">chan_idx</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">max_scan_time</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">scan_dur</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Check if we are only scanning the current channel */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chan_idx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">user_scan_in</span><span class="o">-&gt;</span><span class="n">chan_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">chan_number</span> <span class="o">==</span>
		     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">scan_current_only</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;info: Scan: Scanning current channel only</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;info: Scan: Creating full region channel list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mwifiex_scan_create_channel_list</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">user_scan_in</span><span class="p">,</span>
						 <span class="n">scan_chan_list</span><span class="p">,</span>
						 <span class="o">*</span><span class="n">filtered_scan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function inspects the scan response buffer for pointers to</span>
<span class="cm"> * expected TLVs.</span>
<span class="cm"> *</span>
<span class="cm"> * TLVs can be included at the end of the scan response BSS information.</span>
<span class="cm"> *</span>
<span class="cm"> * Data in the buffer is parsed pointers to TLVs that can potentially</span>
<span class="cm"> * be passed back in the response.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwifiex_ret_802_11_scan_get_tlv_ptrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">mwifiex_ie_types_data</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">tlv_buf_size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">req_tlv_type</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">mwifiex_ie_types_data</span> <span class="o">**</span><span class="n">tlv_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_data</span> <span class="o">*</span><span class="n">current_tlv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tlv_buf_left</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tlv_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tlv_len</span><span class="p">;</span>

	<span class="n">current_tlv</span> <span class="o">=</span> <span class="n">tlv</span><span class="p">;</span>
	<span class="n">tlv_buf_left</span> <span class="o">=</span> <span class="n">tlv_buf_size</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tlv_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: SCAN_RESP: tlv_buf_size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tlv_buf_size</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tlv_buf_left</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">tlv_type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">current_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="n">tlv_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">current_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">tlv_len</span> <span class="o">&gt;</span> <span class="n">tlv_buf_left</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SCAN_RESP: TLV buffer corrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">req_tlv_type</span> <span class="o">==</span> <span class="n">tlv_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">tlv_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TLV_TYPE_TSFTIMESTAMP</span>:
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: SCAN_RESP: TSF &quot;</span>
					<span class="s">&quot;timestamp TLV, len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tlv_len</span><span class="p">);</span>
				<span class="o">*</span><span class="n">tlv_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_data</span> <span class="o">*</span><span class="p">)</span>
					<span class="n">current_tlv</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TLV_TYPE_CHANNELBANDLIST</span>:
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: SCAN_RESP: channel&quot;</span>
					<span class="s">&quot; band list TLV, len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tlv_len</span><span class="p">);</span>
				<span class="o">*</span><span class="n">tlv_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_data</span> <span class="o">*</span><span class="p">)</span>
					<span class="n">current_tlv</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;SCAN_RESP: unhandled TLV = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">tlv_type</span><span class="p">);</span>
				<span class="cm">/* Give up, this seems corrupted */</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">tlv_data</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>


		<span class="n">tlv_buf_left</span> <span class="o">-=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">tlv_len</span><span class="p">);</span>
		<span class="n">current_tlv</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_data</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">current_tlv</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
							  <span class="n">tlv_len</span><span class="p">);</span>

	<span class="p">}</span>			<span class="cm">/* while */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function parses provided beacon buffer and updates</span>
<span class="cm"> * respective fields in bss descriptor structure.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_update_bss_desc_with_ie</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">element_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee_types_fh_param_set</span> <span class="o">*</span><span class="n">fh_param_set</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee_types_ds_param_set</span> <span class="o">*</span><span class="n">ds_param_set</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee_types_cf_param_set</span> <span class="o">*</span><span class="n">cf_param_set</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee_types_ibss_param_set</span> <span class="o">*</span><span class="n">ibss_param_set</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">current_ptr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">element_len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">total_ie_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bytes_to_copy</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">found_data_rate_ie</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bytes_left</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee_types_vendor_specific</span> <span class="o">*</span><span class="n">vendor_ie</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">wpa_oui</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x01</span> <span class="p">};</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">wmm_oui</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x02</span> <span class="p">};</span>

	<span class="n">found_data_rate_ie</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rate_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current_ptr</span> <span class="o">=</span> <span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">beacon_buf</span><span class="p">;</span>
	<span class="n">bytes_left</span> <span class="o">=</span> <span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">beacon_buf_size</span><span class="p">;</span>

	<span class="cm">/* Process variable IE */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bytes_left</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">element_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">current_ptr</span><span class="p">;</span>
		<span class="n">element_len</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">total_ie_len</span> <span class="o">=</span> <span class="n">element_len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_left</span> <span class="o">&lt;</span> <span class="n">total_ie_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;err: InterpretIE: in processing&quot;</span>
				<span class="s">&quot; IE, bytes left &lt; IE length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">element_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_EID_SSID</span>:
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">element_len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
			       <span class="n">element_len</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;info: InterpretIE: ssid: %-32s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WLAN_EID_SUPP_RATES</span>:
			<span class="n">memcpy</span><span class="p">(</span><span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">data_rates</span><span class="p">,</span> <span class="n">current_ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="n">element_len</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">,</span> <span class="n">current_ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="n">element_len</span><span class="p">);</span>
			<span class="n">rate_size</span> <span class="o">=</span> <span class="n">element_len</span><span class="p">;</span>
			<span class="n">found_data_rate_ie</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WLAN_EID_FH_PARAMS</span>:
			<span class="n">fh_param_set</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_fh_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">current_ptr</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">.</span><span class="n">fh_param_set</span><span class="p">,</span>
			       <span class="n">fh_param_set</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_fh_param_set</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WLAN_EID_DS_PARAMS</span>:
			<span class="n">ds_param_set</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_ds_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">current_ptr</span><span class="p">;</span>

			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">ds_param_set</span><span class="o">-&gt;</span><span class="n">current_chan</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">phy_param_set</span><span class="p">.</span><span class="n">ds_param_set</span><span class="p">,</span>
			       <span class="n">ds_param_set</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_ds_param_set</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WLAN_EID_CF_PARAMS</span>:
			<span class="n">cf_param_set</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_cf_param_set</span> <span class="o">*</span><span class="p">)</span> <span class="n">current_ptr</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">ss_param_set</span><span class="p">.</span><span class="n">cf_param_set</span><span class="p">,</span>
			       <span class="n">cf_param_set</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_cf_param_set</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WLAN_EID_IBSS_PARAMS</span>:
			<span class="n">ibss_param_set</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_ibss_param_set</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">current_ptr</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">ss_param_set</span><span class="p">.</span><span class="n">ibss_param_set</span><span class="p">,</span>
			       <span class="n">ibss_param_set</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_ibss_param_set</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WLAN_EID_ERP_INFO</span>:
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">erp_flags</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WLAN_EID_EXT_SUPP_RATES</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Only process extended supported rate</span>
<span class="cm">			 * if data rate is already found.</span>
<span class="cm">			 * Data rate IE should come before</span>
<span class="cm">			 * extended supported rate IE</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">found_data_rate_ie</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">element_len</span> <span class="o">+</span> <span class="n">rate_size</span><span class="p">)</span> <span class="o">&gt;</span>
				    <span class="n">MWIFIEX_SUPPORTED_RATES</span><span class="p">)</span>
					<span class="n">bytes_to_copy</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">MWIFIEX_SUPPORTED_RATES</span> <span class="o">-</span>
						 <span class="n">rate_size</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">bytes_to_copy</span> <span class="o">=</span> <span class="n">element_len</span><span class="p">;</span>

				<span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">data_rates</span><span class="p">;</span>
				<span class="n">rate</span> <span class="o">+=</span> <span class="n">rate_size</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">current_ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bytes_to_copy</span><span class="p">);</span>

				<span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">;</span>
				<span class="n">rate</span> <span class="o">+=</span> <span class="n">rate_size</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">current_ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">bytes_to_copy</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">WLAN_EID_VENDOR_SPECIFIC</span>:
			<span class="n">vendor_ie</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_vendor_specific</span> <span class="o">*</span><span class="p">)</span>
					<span class="n">current_ptr</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span>
			    <span class="p">(</span><span class="n">vendor_ie</span><span class="o">-&gt;</span><span class="n">vend_hdr</span><span class="p">.</span><span class="n">oui</span><span class="p">,</span> <span class="n">wpa_oui</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">wpa_oui</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_vendor_specific</span> <span class="o">*</span><span class="p">)</span>
					<span class="n">current_ptr</span><span class="p">;</span>
				<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">wpa_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span>
					<span class="p">(</span><span class="n">current_ptr</span> <span class="o">-</span> <span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">beacon_buf</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">vendor_ie</span><span class="o">-&gt;</span><span class="n">vend_hdr</span><span class="p">.</span><span class="n">oui</span><span class="p">,</span> <span class="n">wmm_oui</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">wmm_oui</span><span class="p">)))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">total_ie_len</span> <span class="o">==</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_wmm_parameter</span><span class="p">)</span> <span class="o">||</span>
				    <span class="n">total_ie_len</span> <span class="o">==</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_wmm_info</span><span class="p">))</span>
					<span class="cm">/*</span>
<span class="cm">					 * Only accept and copy the WMM IE if</span>
<span class="cm">					 * it matches the size expected for the</span>
<span class="cm">					 * WMM Info IE or the WMM Parameter IE.</span>
<span class="cm">					 */</span>
					<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">wmm_ie</span><span class="p">,</span>
					       <span class="n">current_ptr</span><span class="p">,</span> <span class="n">total_ie_len</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_RSN</span>:
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_generic</span> <span class="o">*</span><span class="p">)</span> <span class="n">current_ptr</span><span class="p">;</span>
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">rsn_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">current_ptr</span> <span class="o">-</span>
							<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">beacon_buf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_BSS_AC_ACCESS_DELAY</span>:
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">bcn_wapi_ie</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_generic</span> <span class="o">*</span><span class="p">)</span> <span class="n">current_ptr</span><span class="p">;</span>
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">wapi_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">current_ptr</span> <span class="o">-</span>
							<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">beacon_buf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_HT_CAPABILITY</span>:
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">bcn_ht_cap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_cap</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">));</span>
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">ht_cap_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">)</span> <span class="o">-</span>
					<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">beacon_buf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_HT_OPERATION</span>:
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">bcn_ht_oper</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_operation</span> <span class="o">*</span><span class="p">)(</span><span class="n">current_ptr</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">));</span>
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">ht_info_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">)</span> <span class="o">-</span>
					<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">beacon_buf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_BSS_COEX_2040</span>:
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">bcn_bss_co_2040</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">));</span>
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">bss_co_2040_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">)</span> <span class="o">-</span>
						<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">beacon_buf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_EXT_CAPABILITY</span>:
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">bcn_ext_cap</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">));</span>
			<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">ext_cap_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">)</span> <span class="o">-</span>
					<span class="n">bss_entry</span><span class="o">-&gt;</span><span class="n">beacon_buf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">current_ptr</span> <span class="o">+=</span> <span class="n">element_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* Need to account for IE ID and IE Len */</span>
		<span class="n">bytes_left</span> <span class="o">-=</span> <span class="p">(</span><span class="n">element_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="p">}</span>	<span class="cm">/* while (bytes_left &gt; 2) */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function converts radio type scan parameter to a band configuration</span>
<span class="cm"> * to be used in join command.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">mwifiex_radio_type_to_band</span><span class="p">(</span><span class="n">u8</span> <span class="n">radio_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">radio_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HostCmd_SCAN_RADIO_TYPE_A</span>:
		<span class="k">return</span> <span class="n">BAND_A</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HostCmd_SCAN_RADIO_TYPE_BG</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">BAND_G</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is an internal function used to start a scan based on an input</span>
<span class="cm"> * configuration.</span>
<span class="cm"> *</span>
<span class="cm"> * This uses the input user scan configuration information when provided in</span>
<span class="cm"> * order to send the appropriate scan commands to firmware to populate or</span>
<span class="cm"> * update the internal driver scan table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_scan_networks</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">mwifiex_user_scan_cfg</span> <span class="o">*</span><span class="n">user_scan_in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">mwifiex_scan_cmd_config_tlv</span> <span class="o">*</span><span class="n">scan_cfg_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_chan_list_param_set</span> <span class="o">*</span><span class="n">chan_list_out</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span> <span class="o">*</span><span class="n">scan_chan_list</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">filtered_scan</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scan_current_chan_only</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_chan_per_scan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_processing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: Scan already in process...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_processing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_block</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cmd: Scan is blocked during association...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scan_cfg_out</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">union</span> <span class="n">mwifiex_scan_cmd_config_tlv</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scan_cfg_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to alloc scan_cfg_out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_chan_scan_param_set</span><span class="p">)</span> <span class="o">*</span>
						<span class="n">MWIFIEX_USER_SCAN_CHAN_MAX</span><span class="p">;</span>
	<span class="n">scan_chan_list</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">buf_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scan_chan_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to alloc scan_chan_list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">scan_cfg_out</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mwifiex_config_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">user_scan_in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">chan_list_out</span><span class="p">,</span> <span class="n">scan_chan_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max_chan_per_scan</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">filtered_scan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_current_chan_only</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_scan_channel_list</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">max_chan_per_scan</span><span class="p">,</span> <span class="n">filtered_scan</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">scan_cfg_out</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">chan_list_out</span><span class="p">,</span>
					<span class="n">scan_chan_list</span><span class="p">);</span>

	<span class="cm">/* Get scan command from scan_pending_q and put to cmd_pending_q */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cmd_node</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">cmd_ctrl_node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span>
					       <span class="n">flags</span><span class="p">);</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_queued</span> <span class="o">=</span> <span class="n">cmd_node</span><span class="p">;</span>
			<span class="n">mwifiex_insert_cmd_to_pending_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">,</span>
							<span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span>
					       <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_processing</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">scan_cfg_out</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">scan_chan_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sends IOCTL request to start a scan with user configurations.</span>
<span class="cm"> *</span>
<span class="cm"> * This function allocates the IOCTL request buffer, fills it</span>
<span class="cm"> * with requisite parameters and calls the IOCTL handler.</span>
<span class="cm"> *</span>
<span class="cm"> * Upon completion, it also generates a wireless event to notify</span>
<span class="cm"> * applications.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_set_user_scan_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">mwifiex_user_scan_cfg</span> <span class="o">*</span><span class="n">scan_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">mwifiex_scan_networks</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">scan_req</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">main_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares a scan command to be sent to the firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * This uses the scan command configuration sent to the command processing</span>
<span class="cm"> * module in command preparation stage to configure a scan command structure</span>
<span class="cm"> * to send to firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * The fixed fields specifying the BSS type and BSSID filters as well as a</span>
<span class="cm"> * variable number/length of TLVs are sent in the command to firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation also includes -</span>
<span class="cm"> *      - Setting command ID, and proper size</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_cmd_802_11_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">mwifiex_scan_cmd_config</span> <span class="o">*</span><span class="n">scan_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_scan</span> <span class="o">*</span><span class="n">scan_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">scan</span><span class="p">;</span>

	<span class="cm">/* Set fixed field variables in scan command */</span>
	<span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">=</span> <span class="n">scan_cfg</span><span class="o">-&gt;</span><span class="n">bss_mode</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">scan_cfg</span><span class="o">-&gt;</span><span class="n">specific_bssid</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">tlv_buffer</span><span class="p">,</span> <span class="n">scan_cfg</span><span class="o">-&gt;</span><span class="n">tlv_buf</span><span class="p">,</span> <span class="n">scan_cfg</span><span class="o">-&gt;</span><span class="n">tlv_buf_len</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_SCAN</span><span class="p">);</span>

	<span class="cm">/* Size is equal to the sizeof(fixed portions) + the TLV len + header */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">bss_mode</span><span class="p">)</span>
					  <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)</span>
					  <span class="o">+</span> <span class="n">scan_cfg</span><span class="o">-&gt;</span><span class="n">tlv_buf_len</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function checks compatibility of requested network with current</span>
<span class="cm"> * driver settings.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_check_network_compatibility</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss_desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mwifiex_get_cfp</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">bss_band</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_is_network_compatible</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">,</span>
							    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot find ssid &quot;</span>
					<span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bss_desc</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_update_curr_bss_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">bss_desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Allocate and fill new bss descriptor */</span>
	<span class="n">bss_desc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss_desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot; failed to alloc bss_desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_fill_new_bss_desc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_check_network_compatibility</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Update current bss descriptor parameters */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">bcn_wpa_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">wpa_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">bcn_rsn_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">rsn_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">bcn_wapi_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">wapi_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">bcn_ht_cap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">ht_cap_offset</span> <span class="o">=</span>
		<span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">bcn_ht_oper</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">ht_info_offset</span> <span class="o">=</span>
		<span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">bcn_bss_co_2040</span> <span class="o">=</span>
		<span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span>
		<span class="n">bss_co_2040_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">bcn_ext_cap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">ext_cap_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">beacon_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">.</span><span class="n">beacon_buf_size</span> <span class="o">=</span>
		<span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Make a copy of current BSSID descriptor */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">,</span> <span class="n">bss_desc</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">));</span>
	<span class="n">mwifiex_save_curr_bcn</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bss_desc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles the command response of scan.</span>
<span class="cm"> *</span>
<span class="cm"> * The response buffer for the scan command has the following</span>
<span class="cm"> * memory layout:</span>
<span class="cm"> *</span>
<span class="cm"> *      .-------------------------------------------------------------.</span>
<span class="cm"> *      |  Header (4 * sizeof(t_u16)):  Standard command response hdr |</span>
<span class="cm"> *      .-------------------------------------------------------------.</span>
<span class="cm"> *      |  BufSize (t_u16) : sizeof the BSS Description data          |</span>
<span class="cm"> *      .-------------------------------------------------------------.</span>
<span class="cm"> *      |  NumOfSet (t_u8) : Number of BSS Descs returned             |</span>
<span class="cm"> *      .-------------------------------------------------------------.</span>
<span class="cm"> *      |  BSSDescription data (variable, size given in BufSize)      |</span>
<span class="cm"> *      .-------------------------------------------------------------.</span>
<span class="cm"> *      |  TLV data (variable, size calculated using Header-&gt;Size,    |</span>
<span class="cm"> *      |            BufSize and sizeof the fixed fields above)       |</span>
<span class="cm"> *      .-------------------------------------------------------------.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_ret_802_11_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_scan_rsp</span> <span class="o">*</span><span class="n">scan_rsp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_data</span> <span class="o">*</span><span class="n">tlv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_tsf_timestamp</span> <span class="o">*</span><span class="n">tsf_tlv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bss_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scan_resp_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bytes_left</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tlv_buf_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_chan_freq_power</span> <span class="o">*</span><span class="n">cfp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_chan_band_list_param_set</span> <span class="o">*</span><span class="n">chan_band_tlv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chan_band_param_set</span> <span class="o">*</span><span class="n">chan_band</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">is_bgscan_resp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>

	<span class="n">is_bgscan_resp</span> <span class="o">=</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span>
			  <span class="o">==</span> <span class="n">HostCmd_CMD_802_11_BG_SCAN_QUERY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_bgscan_resp</span><span class="p">)</span>
		<span class="n">scan_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">bg_scan_query_resp</span><span class="p">.</span><span class="n">scan_resp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scan_rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">scan_resp</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">scan_rsp</span><span class="o">-&gt;</span><span class="n">number_of_sets</span> <span class="o">&gt;</span> <span class="n">MWIFIEX_MAX_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SCAN_RESP: too many AP returned (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">scan_rsp</span><span class="o">-&gt;</span><span class="n">number_of_sets</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bytes_left</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan_rsp</span><span class="o">-&gt;</span><span class="n">bss_descript_size</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: SCAN_RESP: bss_descript_size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bytes_left</span><span class="p">);</span>

	<span class="n">scan_resp_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;info: SCAN_RESP: returned %d APs before parsing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">scan_rsp</span><span class="o">-&gt;</span><span class="n">number_of_sets</span><span class="p">);</span>

	<span class="n">bss_info</span> <span class="o">=</span> <span class="n">scan_rsp</span><span class="o">-&gt;</span><span class="n">bss_desc_and_tlv_buffer</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The size of the TLV buffer is equal to the entire command response</span>
<span class="cm">	 *   size (scan_resp_size) minus the fixed fields (sizeof()&#39;s), the</span>
<span class="cm">	 *   BSS Descriptions (bss_descript_size as bytesLef) and the command</span>
<span class="cm">	 *   response header (S_DS_GEN)</span>
<span class="cm">	 */</span>
	<span class="n">tlv_buf_size</span> <span class="o">=</span> <span class="n">scan_resp_size</span> <span class="o">-</span> <span class="p">(</span><span class="n">bytes_left</span>
					 <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_rsp</span><span class="o">-&gt;</span><span class="n">bss_descript_size</span><span class="p">)</span>
					 <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_rsp</span><span class="o">-&gt;</span><span class="n">number_of_sets</span><span class="p">)</span>
					 <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>

	<span class="n">tlv_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_data</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">scan_rsp</span><span class="o">-&gt;</span>
						 <span class="n">bss_desc_and_tlv_buffer</span> <span class="o">+</span>
						 <span class="n">bytes_left</span><span class="p">);</span>

	<span class="cm">/* Search the TLV buffer space in the scan response for any valid</span>
<span class="cm">	   TLVs */</span>
	<span class="n">mwifiex_ret_802_11_scan_get_tlv_ptrs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tlv_data</span><span class="p">,</span> <span class="n">tlv_buf_size</span><span class="p">,</span>
					     <span class="n">TLV_TYPE_TSFTIMESTAMP</span><span class="p">,</span>
					     <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_data</span> <span class="o">**</span><span class="p">)</span>
					     <span class="o">&amp;</span><span class="n">tsf_tlv</span><span class="p">);</span>

	<span class="cm">/* Search the TLV buffer space in the scan response for any valid</span>
<span class="cm">	   TLVs */</span>
	<span class="n">mwifiex_ret_802_11_scan_get_tlv_ptrs</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">tlv_data</span><span class="p">,</span> <span class="n">tlv_buf_size</span><span class="p">,</span>
					     <span class="n">TLV_TYPE_CHANNELBANDLIST</span><span class="p">,</span>
					     <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_data</span> <span class="o">**</span><span class="p">)</span>
					     <span class="o">&amp;</span><span class="n">chan_band_tlv</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">scan_rsp</span><span class="o">-&gt;</span><span class="n">number_of_sets</span> <span class="o">&amp;&amp;</span> <span class="n">bytes_left</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
		<span class="n">s32</span> <span class="n">rssi</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie_buf</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">ie_len</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">fw_tsf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">beacon_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">curr_bcn_bytes</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">beacon_period</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">cap_info_bitmap</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">current_ptr</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">timestamp</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mwifiex_bcn_param</span> <span class="o">*</span><span class="n">bcn_param</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">mwifiex_bss_priv</span> <span class="o">*</span><span class="n">bss_priv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bytes_left</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">beacon_size</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Extract &amp; convert beacon size from command buffer */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">beacon_size</span><span class="p">,</span> <span class="n">bss_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">beacon_size</span><span class="p">));</span>
			<span class="n">bytes_left</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">beacon_size</span><span class="p">);</span>
			<span class="n">bss_info</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">beacon_size</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beacon_size</span> <span class="o">||</span> <span class="n">beacon_size</span> <span class="o">&gt;</span> <span class="n">bytes_left</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bss_info</span> <span class="o">+=</span> <span class="n">bytes_left</span><span class="p">;</span>
			<span class="n">bytes_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Initialize the current working beacon pointer for this BSS</span>
<span class="cm">		 * iteration */</span>
		<span class="n">current_ptr</span> <span class="o">=</span> <span class="n">bss_info</span><span class="p">;</span>

		<span class="cm">/* Advance the return beacon pointer past the current beacon */</span>
		<span class="n">bss_info</span> <span class="o">+=</span> <span class="n">beacon_size</span><span class="p">;</span>
		<span class="n">bytes_left</span> <span class="o">-=</span> <span class="n">beacon_size</span><span class="p">;</span>

		<span class="n">curr_bcn_bytes</span> <span class="o">=</span> <span class="n">beacon_size</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * First 5 fields are bssid, RSSI, time stamp, beacon interval,</span>
<span class="cm">		 *   and capability information</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr_bcn_bytes</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_bcn_param</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;InterpretIE: not enough bytes left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bcn_param</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_bcn_param</span> <span class="o">*</span><span class="p">)</span><span class="n">current_ptr</span><span class="p">;</span>
		<span class="n">current_ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bcn_param</span><span class="p">);</span>
		<span class="n">curr_bcn_bytes</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bcn_param</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bcn_param</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">rssi</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">bcn_param</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">rssi</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>		<span class="cm">/* Convert dBm to mBm */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: InterpretIE: RSSI=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rssi</span><span class="p">);</span>

		<span class="n">timestamp</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">bcn_param</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
		<span class="n">beacon_period</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bcn_param</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">);</span>

		<span class="n">cap_info_bitmap</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bcn_param</span><span class="o">-&gt;</span><span class="n">cap_info_bitmap</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: InterpretIE: capabilities=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cap_info_bitmap</span><span class="p">);</span>

		<span class="cm">/* Rest of the current buffer are IE&#39;s */</span>
		<span class="n">ie_buf</span> <span class="o">=</span> <span class="n">current_ptr</span><span class="p">;</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="n">curr_bcn_bytes</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;info: InterpretIE: IELength for this AP = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">curr_bcn_bytes</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">curr_bcn_bytes</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">element_id</span><span class="p">,</span> <span class="n">element_len</span><span class="p">;</span>

			<span class="n">element_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">current_ptr</span><span class="p">;</span>
			<span class="n">element_len</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curr_bcn_bytes</span> <span class="o">&lt;</span> <span class="n">element_len</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;%s: bytes left &lt; IE length</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">element_id</span> <span class="o">==</span> <span class="n">WLAN_EID_DS_PARAMS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">channel</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">current_ptr</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">current_ptr</span> <span class="o">+=</span> <span class="n">element_len</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">);</span>
			<span class="n">curr_bcn_bytes</span> <span class="o">-=</span> <span class="n">element_len</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_header</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the TSF TLV was appended to the scan results, save this</span>
<span class="cm">		 * entry&#39;s TSF value in the fw_tsf field. It is the firmware&#39;s</span>
<span class="cm">		 * TSF value at the time the beacon or probe response was</span>
<span class="cm">		 * received.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tsf_tlv</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_tsf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsf_tlv</span><span class="o">-&gt;</span><span class="n">tsf_data</span><span class="p">[</span><span class="n">idx</span> <span class="o">*</span> <span class="n">TSF_DATA_SIZE</span><span class="p">],</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_tsf</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">band</span><span class="p">;</span>

			<span class="n">band</span> <span class="o">=</span> <span class="n">BAND_G</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chan_band_tlv</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chan_band</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">chan_band_tlv</span><span class="o">-&gt;</span><span class="n">chan_band_param</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
				<span class="n">band</span> <span class="o">=</span> <span class="n">mwifiex_radio_type_to_band</span><span class="p">(</span>
						<span class="n">chan_band</span><span class="o">-&gt;</span><span class="n">radio_type</span>
						<span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
			<span class="p">}</span>

			<span class="n">cfp</span> <span class="o">=</span> <span class="n">mwifiex_get_cfp</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">freq</span> <span class="o">=</span> <span class="n">cfp</span> <span class="o">?</span> <span class="n">cfp</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_inform_bss</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
					      <span class="n">chan</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">,</span>
					      <span class="n">cap_info_bitmap</span><span class="p">,</span> <span class="n">beacon_period</span><span class="p">,</span>
					      <span class="n">ie_buf</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="n">bss_priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_bss_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
				<span class="n">bss_priv</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>
				<span class="n">bss_priv</span><span class="o">-&gt;</span><span class="n">fw_tsf</span> <span class="o">=</span> <span class="n">fw_tsf</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">media_connected</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span>
					    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span>
					    <span class="p">.</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
					<span class="n">mwifiex_update_curr_bss_params</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
								       <span class="n">bss</span><span class="p">);</span>
				<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;missing BSS channel IE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_processing</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Need to indicate IOCTL complete */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_wait_q</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mwifiex_complete_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_cmd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">report_scan_result</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">report_scan_result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_pending_on_block</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_pending_on_block</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">async_sem</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">user_scan_cfg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;info: %s: sending scan results</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">cfg80211_scan_done</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">user_scan_cfg</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">user_scan_cfg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Get scan command from scan_pending_q and put to</span>
<span class="cm">		   cmd_pending_q */</span>
		<span class="n">cmd_node</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">cmd_ctrl_node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">mwifiex_insert_cmd_to_pending_q</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">cmd_node</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command for background scan query.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID and proper size</span>
<span class="cm"> *      - Setting background scan flush parameter</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_cmd_802_11_bg_scan_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_802_11_bg_scan_query</span> <span class="o">*</span><span class="n">bg_query</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">bg_scan_query</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_BG_SCAN_QUERY</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_802_11_bg_scan_query</span><span class="p">)</span>
				<span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>

	<span class="n">bg_query</span><span class="o">-&gt;</span><span class="n">flush</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function inserts scan command node to the scan pending queue.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_queue_scan_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd_node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">wait_q_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">condition</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_wait_q_woken</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function sends a scan command for all available channels to the</span>
<span class="cm"> * firmware, filtered on a specific SSID.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_scan_specific_ssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">cfg80211_ssid</span> <span class="o">*</span><span class="n">req_ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_user_scan_cfg</span> <span class="o">*</span><span class="n">scan_cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req_ssid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_processing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cmd: Scan already in process...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_block</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cmd: Scan is blocked during association...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scan_cfg</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_user_scan_cfg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scan_cfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to alloc scan_cfg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scan_cfg</span><span class="o">-&gt;</span><span class="n">ssid_list</span> <span class="o">=</span> <span class="n">req_ssid</span><span class="p">;</span>
	<span class="n">scan_cfg</span><span class="o">-&gt;</span><span class="n">num_ssids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_scan_networks</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">scan_cfg</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">scan_cfg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sends IOCTL request to start a scan.</span>
<span class="cm"> *</span>
<span class="cm"> * This function allocates the IOCTL request buffer, fills it</span>
<span class="cm"> * with requisite parameters and calls the IOCTL handler.</span>
<span class="cm"> *</span>
<span class="cm"> * Scan command can be issued for both normal scan and specific SSID</span>
<span class="cm"> * scan, depending upon whether an SSID is provided or not.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_request_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">cfg80211_ssid</span> <span class="o">*</span><span class="n">req_ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">async_sem</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: acquire semaphore</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_pending_on_block</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_wait_q_woken</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req_ssid</span> <span class="o">&amp;&amp;</span> <span class="n">req_ssid</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* Specific SSID scan */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_scan_specific_ssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">req_ssid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* Normal scan */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_scan_networks</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_wait_queue_complete</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_pending_on_block</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">async_sem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function appends the vendor specific IE TLV to a buffer.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mwifiex_cmd_append_vsie_tlv</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">vsie_mask</span><span class="p">,</span> <span class="n">u8</span> <span class="o">**</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">ret_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_ie_types_vendor_param_set</span> <span class="o">*</span><span class="n">vs_param_set</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">buffer</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Traverse through the saved vendor specific IE array and append</span>
<span class="cm">	 * the selected(scan/assoc/adhoc) IE as TLV to the command</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="n">MWIFIEX_MAX_VSIE_NUM</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vs_ie</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">vsie_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vs_param_set</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_vendor_param_set</span> <span class="o">*</span><span class="p">)</span>
				<span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
			<span class="n">vs_param_set</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_PASSTHROUGH</span><span class="p">);</span>
			<span class="n">vs_param_set</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">((((</span><span class="n">u16</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">vs_ie</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
				<span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">vs_param_set</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">vs_ie</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">ie</span><span class="p">,</span>
			       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vs_param_set</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">));</span>
			<span class="o">*</span><span class="n">buffer</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vs_param_set</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">);</span>
			<span class="n">ret_len</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">vs_param_set</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">+</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_ie_types_header</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function saves a beacon buffer of the current BSS descriptor.</span>
<span class="cm"> *</span>
<span class="cm"> * The current beacon buffer is saved so that it can be restored in the</span>
<span class="cm"> * following cases that makes the beacon buffer not to contain the current</span>
<span class="cm"> * ssid&#39;s beacon buffer.</span>
<span class="cm"> *      - The current ssid was not found somehow in the last scan.</span>
<span class="cm"> *      - The current ssid was the last entry of the scan table and overloaded.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_save_curr_bcn</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_bssdescriptor</span> <span class="o">*</span><span class="n">curr_bss</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">.</span><span class="n">bss_descriptor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf_size</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* allocate beacon buffer at 1st time; or if it&#39;s size has changed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_size</span> <span class="o">!=</span> <span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_size</span> <span class="o">=</span> <span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf_size</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf_size</span><span class="p">,</span>
					     <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to alloc curr_bcn_buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf</span><span class="p">,</span> <span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf</span><span class="p">,</span>
	       <span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf_size</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: current beacon saved %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_size</span><span class="p">);</span>

	<span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf</span><span class="p">;</span>

	<span class="cm">/* adjust the pointers in the current BSS descriptor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span><span class="p">)</span>
		<span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_wpa_ie</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_vendor_specific</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf</span> <span class="o">+</span>
			 <span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">wpa_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span><span class="p">)</span>
		<span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_rsn_ie</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee_types_generic</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf</span> <span class="o">+</span>
			 <span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">rsn_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_ht_cap</span><span class="p">)</span>
		<span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_ht_cap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_cap</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf</span> <span class="o">+</span>
			 <span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">ht_cap_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_ht_oper</span><span class="p">)</span>
		<span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_ht_oper</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_ht_operation</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf</span> <span class="o">+</span>
			 <span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">ht_info_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_bss_co_2040</span><span class="p">)</span>
		<span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_bss_co_2040</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf</span> <span class="o">+</span>
					<span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bss_co_2040_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_ext_cap</span><span class="p">)</span>
		<span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">bcn_ext_cap</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">beacon_buf</span> <span class="o">+</span>
				<span class="n">curr_bss</span><span class="o">-&gt;</span><span class="n">ext_cap_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function frees the current BSS descriptor beacon buffer.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_free_curr_bcn</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
