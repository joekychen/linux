<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › mwifiex › init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Marvell Wireless LAN device driver: HW/FW Initialization</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011, Marvell International Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This software file (the &quot;File&quot;) is distributed by Marvell International</span>
<span class="cm"> * Ltd. under the terms of the GNU General Public License Version 2, June 1991</span>
<span class="cm"> * (the &quot;License&quot;).  You may use, redistribute and/or modify this File in</span>
<span class="cm"> * accordance with the terms and conditions of the License, a copy of which</span>
<span class="cm"> * is available by writing to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA or on the</span>
<span class="cm"> * worldwide web at http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.</span>
<span class="cm"> *</span>
<span class="cm"> * THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE EXPRESSLY DISCLAIMED.  The License provides additional details about</span>
<span class="cm"> * this warranty disclaimer.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;decl.h&quot;</span>
<span class="cp">#include &quot;ioctl.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;fw.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;wmm.h&quot;</span>
<span class="cp">#include &quot;11n.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * This function adds a BSS priority table to the table list.</span>
<span class="cm"> *</span>
<span class="cm"> * The function allocates a new BSS priority table node and adds it to</span>
<span class="cm"> * the end of BSS priority table list, kept in driver memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_add_bss_prio_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_bss_prio_node</span> <span class="o">*</span><span class="n">bss_prio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_bss_prio_tbl</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bss_prio_tbl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">bss_prio</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_bss_prio_node</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss_prio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to alloc bss_prio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bss_prio</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss_prio</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_priority</span><span class="p">].</span><span class="n">bss_prio_cur</span><span class="p">)</span>
		<span class="n">tbl</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_priority</span><span class="p">].</span><span class="n">bss_prio_cur</span> <span class="o">=</span> <span class="n">bss_prio</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_priority</span><span class="p">].</span><span class="n">bss_prio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss_prio</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbl</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_priority</span><span class="p">].</span><span class="n">bss_prio_head</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_priority</span><span class="p">].</span><span class="n">bss_prio_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function initializes the private structure and sets default</span>
<span class="cm"> * values to the members.</span>
<span class="cm"> *</span>
<span class="cm"> * Additionally, it also initializes all the locks and sets up all the</span>
<span class="cm"> * lists.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_init_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">media_connected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_addr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pkt_tx_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_mode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Initially indicate the rate as auto */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_data_rate_auto</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_avg_factor</span> <span class="o">=</span> <span class="n">DEFAULT_BCN_AVG_FACTOR</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_avg_factor</span> <span class="o">=</span> <span class="n">DEFAULT_DATA_AVG_FACTOR</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">wep_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">authentication_mode</span> <span class="o">=</span> <span class="n">NL80211_AUTHTYPE_OPEN_SYSTEM</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sec_info</span><span class="p">.</span><span class="n">encryption_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_wep_key</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_curr_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_pkt_filter</span> <span class="o">=</span> <span class="n">HostCmd_ACT_MAC_RX_ON</span> <span class="o">|</span> <span class="n">HostCmd_ACT_MAC_TX_ON</span> <span class="o">|</span>
				<span class="n">HostCmd_ACT_MAC_ETHERNETII_ENABLE</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* beacon interval */</span> <span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">attempted_bss_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bss_params</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">MWIFIEX_DEFAULT_LISTEN_INTERVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prev_ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prev_ssid</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prev_bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">prev_bssid</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_rsp_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_rsp_buf</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_rsp_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_channel</span> <span class="o">=</span> <span class="n">DEFAULT_AD_HOC_CHANNEL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">atim_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">adhoc_state</span> <span class="o">=</span> <span class="n">ADHOC_IDLE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_power_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">max_tx_power_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">min_tx_power_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxpd_htinfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxpd_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rate_bitmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_rssi_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_rssi_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_nf_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_nf_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_rssi_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_rssi_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_nf_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bcn_nf_last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">aes_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">aes_key</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_is_gtk_set</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_tlv_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_tlv_buf</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_tlv_buf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gen_ie_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gen_ie_buf</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">gen_ie_buf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vs_ie</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vs_ie</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_required</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm_qosinfo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wps_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_block</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mwifiex_add_bss_prio_tbl</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function allocates buffers for members of the adapter</span>
<span class="cm"> * structure.</span>
<span class="cm"> *</span>
<span class="cm"> * The memory allocated includes scan table, command buffers, and</span>
<span class="cm"> * sleep confirm command buffer. In addition, the queues are</span>
<span class="cm"> * also initialized.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mwifiex_allocate_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Allocate command buffer */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_alloc_cmd_buffer</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to alloc cmd buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span> <span class="o">=</span>
		<span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_opt_sleep_confirm</span><span class="p">)</span>
			      <span class="o">+</span> <span class="n">INTF_HEADER_LEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to alloc sleep cfm&quot;</span>
			<span class="s">&quot; cmd buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="p">,</span> <span class="n">INTF_HEADER_LEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function initializes the adapter structure and sets default</span>
<span class="cm"> * values to the members of adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * This also initializes the WMM related parameters in the driver private</span>
<span class="cm"> * structures.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwifiex_init_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_opt_sleep_confirm</span> <span class="o">*</span><span class="n">sleep_cfm_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_opt_sleep_confirm</span><span class="p">));</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_sent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">iface_type</span> <span class="o">==</span> <span class="n">MWIFIEX_SDIO</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">data_sent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">data_sent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_resp_received</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">event_received</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">data_received</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">surprise_removed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">=</span> <span class="n">MWIFIEX_HW_STATUS_INITIALIZING</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_mode</span> <span class="o">=</span> <span class="n">MWIFIEX_802_11_POWER_MODE_CAM</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">ps_state</span> <span class="o">=</span> <span class="n">PS_STATE_AWAKE</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">need_to_wakeup</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">=</span> <span class="n">HostCmd_BSS_MODE_ANY</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">specific_scan_time</span> <span class="o">=</span> <span class="n">MWIFIEX_SPECIFIC_SCAN_CHAN_TIME</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">active_scan_time</span> <span class="o">=</span> <span class="n">MWIFIEX_ACTIVE_SCAN_CHAN_TIME</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">passive_scan_time</span> <span class="o">=</span> <span class="n">MWIFIEX_PASSIVE_SCAN_CHAN_TIME</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_probes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">multiple_dtim</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">local_listen_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* default value in firmware</span>
<span class="cm">						   will be used */</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_deep_sleep</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">delay_null_pkt</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">delay_to_ps</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">enhanced_ps_mode</span> <span class="o">=</span> <span class="n">PS_MODE_AUTO</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">gen_null_pkt</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* Disable NULL Pkg generation by</span>
<span class="cm">					   default */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pps_uapsd_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* Disable pps/uapsd mode by</span>
<span class="cm">					   default */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pm_wakeup_card_req</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pm_wakeup_fw_try</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_tx_buf_size</span> <span class="o">=</span> <span class="n">MWIFIEX_TX_DATA_BUF_SIZE_2K</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_buf_size</span> <span class="o">=</span> <span class="n">MWIFIEX_TX_DATA_BUF_SIZE_2K</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curr_tx_buf_size</span> <span class="o">=</span> <span class="n">MWIFIEX_TX_DATA_BUF_SIZE_2K</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">is_hs_configured</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hs_cfg</span><span class="p">.</span><span class="n">conditions</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">HOST_SLEEP_CFG_COND_DEF</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hs_cfg</span><span class="p">.</span><span class="n">gpio</span> <span class="o">=</span> <span class="n">HOST_SLEEP_CFG_GPIO_DEF</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hs_cfg</span><span class="p">.</span><span class="n">gap</span> <span class="o">=</span> <span class="n">HOST_SLEEP_CFG_GAP_DEF</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hs_activated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">event_body</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">event_body</span><span class="p">));</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_dot_11n_dev_cap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_dev_mcs_support</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sec_chan_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_11n_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mwifiex_wmm_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sleep_cfm_buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_opt_sleep_confirm</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">sleep_cfm_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">sleep_cfm_buf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_802_11_PS_MODE_ENH</span><span class="p">);</span>
		<span class="n">sleep_cfm_buf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">sleep_cfm_buf</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sleep_cfm_buf</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SLEEP_CONFIRM</span><span class="p">);</span>
		<span class="n">sleep_cfm_buf</span><span class="o">-&gt;</span><span class="n">resp_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">RESP_NEEDED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_params</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_period</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_period</span><span class="p">));</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">tx_lock_flag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">null_pkt_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_bands</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">config_bands</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_start_band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_channels</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_release_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">fw_cap_info</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upld_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upld_buf</span><span class="p">));</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">event_cause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">region_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bcn_miss_time_out</span> <span class="o">=</span> <span class="n">DEFAULT_BCN_MISS_TIMEOUT</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adhoc_awake_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">arp_filter</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">arp_filter</span><span class="p">));</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">arp_filter_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">=</span> <span class="n">NL80211_CHAN_HT20</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_mgmt_ie_index</span> <span class="o">=</span> <span class="n">MAX_MGMT_IE_INDEX</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function sets trans_start per tx_queue</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mwifiex_set_trans_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_tx_queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">netdev_get_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function wakes up all queues in net_device</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mwifiex_wake_up_net_dev_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dev_queue_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">dev_queue_flags</span><span class="p">);</span>
	<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">dev_queue_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function stops all queues in net_device</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mwifiex_stop_net_dev_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dev_queue_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">dev_queue_flags</span><span class="p">);</span>
	<span class="n">netif_tx_stop_all_queues</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">dev_queue_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  This function releases the lock variables and frees the locks and</span>
<span class="cm"> *  associated locks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwifiex_free_lock_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="cm">/* Free lists */</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_free_q</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bss_prio_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bss_prio_head</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">priv</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_TID</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm</span><span class="p">.</span><span class="n">tid_tbl_ptr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ra_list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ba_stream_tbl_ptr</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_ptr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function frees the adapter structure.</span>
<span class="cm"> *</span>
<span class="cm"> * The freeing operation is done recursively, by canceling all</span>
<span class="cm"> * pending commands, freeing the member buffers previously</span>
<span class="cm"> * allocated (command buffers, scan table buffer, sleep confirm</span>
<span class="cm"> * command buffer), stopping the timers and calling the cleanup</span>
<span class="cm"> * routines for every interface, before the actual adapter</span>
<span class="cm"> * structure is freed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwifiex_free_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: adapter is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mwifiex_cancel_all_pending_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* Free lock variables */</span>
	<span class="n">mwifiex_free_lock_list</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* Free command buffer */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: free cmd buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mwifiex_free_cmd_buffer</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_timer</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: free scan table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">cleanup_if</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">cleanup_if</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">sleep_cfm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  This function intializes the lock variables and</span>
<span class="cm"> *  the list heads.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_init_lock_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">main_proc_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_cmd_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">priv</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pkt_lock</span><span class="p">);</span>
			<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm</span><span class="p">.</span><span class="n">ra_list_spinlock</span><span class="p">);</span>
			<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curr_bcn_buf_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize cmd_free_q */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_free_q</span><span class="p">);</span>
	<span class="cm">/* Initialize cmd_pending_q */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q</span><span class="p">);</span>
	<span class="cm">/* Initialize scan_pending_q */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_free_q_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">scan_pending_q_lock</span><span class="p">);</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">usb_rx_data_q</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bss_prio_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bss_prio_head</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bss_prio_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bss_prio_cur</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bss_prio_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bss_prio_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">priv</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_TID</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm</span><span class="p">.</span><span class="n">tid_tbl_ptr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">ra_list</span><span class="p">);</span>
			<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmm</span><span class="p">.</span><span class="n">tid_tbl_ptr</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">tid_tbl_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ba_stream_tbl_ptr</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_ptr</span><span class="p">);</span>

		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ba_stream_tbl_lock</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function initializes the firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * The following operations are performed sequentially -</span>
<span class="cm"> *      - Allocate adapter structure</span>
<span class="cm"> *      - Initialize the adapter structure</span>
<span class="cm"> *      - Initialize the private structure</span>
<span class="cm"> *      - Add BSS priority tables to the adapter structure</span>
<span class="cm"> *      - For each interface, send the init commands to firmware</span>
<span class="cm"> *      - Send the first command in command pending queue, if available</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_init_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">first_sta</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_cmd_pend_q_empty</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">=</span> <span class="n">MWIFIEX_HW_STATUS_INITIALIZING</span><span class="p">;</span>

	<span class="cm">/* Allocate memory for member of adapter structure */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_allocate_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Initialize adapter structure */</span>
	<span class="n">mwifiex_init_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">priv</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="cm">/* Initialize private structure */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_init_priv</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_sta_init_cmd</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">first_sta</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="n">first_sta</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">is_cmd_pend_q_empty</span> <span class="o">=</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmd_pending_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cmd_pend_q_empty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Send the first command in queue and return */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_main_process</span><span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">=</span> <span class="n">MWIFIEX_HW_STATUS_READY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function deletes the BSS priority tables.</span>
<span class="cm"> *</span>
<span class="cm"> * The function traverses through all the allocated BSS priority nodes</span>
<span class="cm"> * in every BSS priority table and frees them.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mwifiex_delete_bss_prio_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_bss_prio_node</span> <span class="o">*</span><span class="n">bssprio_node</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_node</span><span class="p">,</span> <span class="o">**</span><span class="n">cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="o">*</span><span class="n">lock</span><span class="p">;</span> <span class="cm">/* bss priority lock */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv_num</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bss_prio_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bss_prio_head</span><span class="p">;</span>
		<span class="n">cur</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bss_prio_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bss_prio_cur</span><span class="p">;</span>
		<span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bss_prio_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bss_prio_lock</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: delete BSS priority table,&quot;</span>
				<span class="s">&quot; bss_type = %d, bss_num = %d, i = %d,&quot;</span>
				<span class="s">&quot; head = %p, cur = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_num</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="o">*</span><span class="n">cur</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cur</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bssprio_node</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">head</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">mwifiex_bss_prio_node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">bssprio_node</span><span class="p">,</span> <span class="n">tmp_node</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span>
						 <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bssprio_node</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">==</span> <span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: Delete &quot;</span>
						<span class="s">&quot;node %p, next = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">bssprio_node</span><span class="p">,</span> <span class="n">tmp_node</span><span class="p">);</span>
					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bssprio_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">bssprio_node</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">cur</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_bss_prio_node</span> <span class="o">*</span><span class="p">)</span><span class="n">head</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function is used to shutdown the driver.</span>
<span class="cm"> *</span>
<span class="cm"> * The following operations are performed sequentially -</span>
<span class="cm"> *      - Check if already shut down</span>
<span class="cm"> *      - Make sure the main process has stopped</span>
<span class="cm"> *      - Clean up the Tx and Rx queues</span>
<span class="cm"> *      - Delete BSS priority tables</span>
<span class="cm"> *      - Free the adapter</span>
<span class="cm"> *      - Notify completion</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">mwifiex_shutdown_drv</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* mwifiex already shutdown */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">==</span> <span class="n">MWIFIEX_HW_STATUS_NOT_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">hw_status</span> <span class="o">=</span> <span class="n">MWIFIEX_HW_STATUS_CLOSING</span><span class="p">;</span>
	<span class="cm">/* wait for mwifiex_process to complete */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_processing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;main process is still running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* shut down mwifiex */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: shutdown mwifiex...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Clean up Tx/Rx queues and delete BSS priority table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">priv</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">mwifiex_clean_txrx</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="n">mwifiex_delete_bss_prio_tbl</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">data_complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">usb_rx_data_q</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mwifiex_rxinfo</span> <span class="o">*</span><span class="n">rx_info</span> <span class="o">=</span> <span class="n">MWIFIEX_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">priv</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">[</span><span class="n">rx_info</span><span class="o">-&gt;</span><span class="n">bss_num</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>

			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">data_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Free adapter structure */</span>
	<span class="n">mwifiex_free_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mwifiex_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Notify completion */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mwifiex_shutdown_fw_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function downloads the firmware to the card.</span>
<span class="cm"> *</span>
<span class="cm"> * The actual download is preceded by two sanity checks -</span>
<span class="cm"> *      - Check if firmware is already running</span>
<span class="cm"> *      - Check if the interface is the winner to download the firmware</span>
<span class="cm"> *</span>
<span class="cm"> * ...and followed by another -</span>
<span class="cm"> *      - Check if the firmware is downloaded successfully</span>
<span class="cm"> *</span>
<span class="cm"> * After download is successfully completed, the host interrupts are enabled.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_dnld_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">mwifiex_fw_image</span> <span class="o">*</span><span class="n">pmfw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">poll_num</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">check_fw_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">winner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* check if firmware is already running */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">check_fw_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">poll_num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;WLAN FW already running! Skip FW dnld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">poll_num</span> <span class="o">=</span> <span class="n">MAX_FIRMWARE_POLL_TRIES</span><span class="p">;</span>

		<span class="cm">/* check if we are the winner for downloading FW */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">winner</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_notice</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;FW already running! Skip FW dnld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">poll_num</span> <span class="o">=</span> <span class="n">MAX_MULTI_INTERFACE_POLL_TRIES</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">poll_fw</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pmfw</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Download firmware with helper */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">prog_fw</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pmfw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;prog_fw failed ret=%#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">poll_fw:</span>
	<span class="cm">/* Check if the firmware is downloaded successfully or not */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">check_fw_status</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">poll_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW failed to be active in time</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="cm">/* re-enable host interrupt for mwifiex after fw dnld is successful */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">enable_int</span><span class="p">)</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="p">.</span><span class="n">enable_int</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
