<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › mwifiex › 11n_rxreorder.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>11n_rxreorder.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Marvell Wireless LAN device driver: 802.11n RX Re-ordering</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011, Marvell International Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This software file (the &quot;File&quot;) is distributed by Marvell International</span>
<span class="cm"> * Ltd. under the terms of the GNU General Public License Version 2, June 1991</span>
<span class="cm"> * (the &quot;License&quot;).  You may use, redistribute and/or modify this File in</span>
<span class="cm"> * accordance with the terms and conditions of the License, a copy of which</span>
<span class="cm"> * is available by writing to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA or on the</span>
<span class="cm"> * worldwide web at http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.</span>
<span class="cm"> *</span>
<span class="cm"> * THE FILE IS DISTRIBUTED AS-IS, WITHOUT WARRANTY OF ANY KIND, AND THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE EXPRESSLY DISCLAIMED.  The License provides additional details about</span>
<span class="cm"> * this warranty disclaimer.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;decl.h&quot;</span>
<span class="cp">#include &quot;ioctl.h&quot;</span>
<span class="cp">#include &quot;util.h&quot;</span>
<span class="cp">#include &quot;fw.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;wmm.h&quot;</span>
<span class="cp">#include &quot;11n.h&quot;</span>
<span class="cp">#include &quot;11n_rxreorder.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * This function dispatches all packets in the Rx reorder table until the</span>
<span class="cm"> * start window.</span>
<span class="cm"> *</span>
<span class="cm"> * There could be holes in the buffer, which are skipped by the function.</span>
<span class="cm"> * Since the buffer is linear, the function uses rotation to simulate</span>
<span class="cm"> * circular buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwifiex_11n_dispatch_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start_win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pkt_to_send</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rx_tmp_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pkt_to_send</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_win</span> <span class="o">&gt;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">start_win</span><span class="p">)</span> <span class="o">?</span>
		      <span class="n">min</span><span class="p">((</span><span class="n">start_win</span> <span class="o">-</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">start_win</span><span class="p">),</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win_size</span><span class="p">)</span> <span class="o">:</span>
		      <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pkt_to_send</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pkt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rx_tmp_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">rx_tmp_ptr</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pkt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_tmp_ptr</span><span class="p">)</span>
			<span class="n">mwifiex_process_rx_packet</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rx_tmp_ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pkt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t have a circular buffer, hence use rotation to simulate</span>
<span class="cm">	 * circular buffer</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win_size</span> <span class="o">-</span> <span class="n">pkt_to_send</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">pkt_to_send</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">pkt_to_send</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">start_win</span> <span class="o">=</span> <span class="n">start_win</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pkt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function dispatches all packets in the Rx reorder table until</span>
<span class="cm"> * a hole is found.</span>
<span class="cm"> *</span>
<span class="cm"> * The start window is adjusted automatically when a hole is located.</span>
<span class="cm"> * Since the buffer is linear, the function uses rotation to simulate</span>
<span class="cm"> * circular buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwifiex_11n_scan_and_dispatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">xchg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rx_tmp_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pkt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pkt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rx_tmp_ptr</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pkt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mwifiex_process_rx_packet</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rx_tmp_ptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pkt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t have a circular buffer, hence use rotation to simulate</span>
<span class="cm">	 * circular buffer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xchg</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win_size</span> <span class="o">-</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">xchg</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">start_win</span> <span class="o">=</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">start_win</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAX_TID_VALUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pkt_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function deletes the Rx reorder table and frees the memory.</span>
<span class="cm"> *</span>
<span class="cm"> * The function stops the associated timer and dispatches all the</span>
<span class="cm"> * pending packets in the Rx reorder table before deletion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwifiex_del_rx_reorder_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mwifiex_11n_dispatch_pkt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">start_win</span> <span class="o">+</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win_size</span><span class="p">)</span> <span class="o">&amp;</span>
					    <span class="p">(</span><span class="n">MAX_TID_VALUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">timer_context</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tbl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function returns the pointer to an entry in Rx reordering</span>
<span class="cm"> * table which matches the given TA/TID pair.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span> <span class="o">*</span>
<span class="nf">mwifiex_11n_get_rx_reorder_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_ptr</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">==</span> <span class="n">tid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">,</span>
					       <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">tbl</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function finds the last sequence number used in the packets</span>
<span class="cm"> * buffered in Rx reordering table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mwifiex_11n_find_last_seq_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span> <span class="o">*</span><span class="n">rx_reorder_tbl_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_reorder_tbl_ptr</span><span class="o">-&gt;</span><span class="n">win_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_reorder_tbl_ptr</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function flushes all the packets in Rx reordering table.</span>
<span class="cm"> *</span>
<span class="cm"> * The function checks if any packets are currently buffered in the</span>
<span class="cm"> * table or not. In case there are packets available, it dispatches</span>
<span class="cm"> * them and then dumps the Rx reordering table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwifiex_flush_data</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">reorder_tmr_cnxt</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">reorder_tmr_cnxt</span> <span class="o">*</span><span class="p">)</span> <span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_win</span><span class="p">;</span>

	<span class="n">start_win</span> <span class="o">=</span> <span class="n">mwifiex_11n_find_last_seq_num</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start_win</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;info: flush data %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start_win</span><span class="p">);</span>
	<span class="n">mwifiex_11n_dispatch_pkt</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">start_win</span> <span class="o">+</span> <span class="n">start_win</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
				 <span class="p">(</span><span class="n">MAX_TID_VALUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function creates an entry in Rx reordering table for the</span>
<span class="cm"> * given TA/TID.</span>
<span class="cm"> *</span>
<span class="cm"> * The function also initializes the entry with sequence number, window</span>
<span class="cm"> * size as well as initializes the timer.</span>
<span class="cm"> *</span>
<span class="cm"> * If the received TA/TID pair is already present, all the packets are</span>
<span class="cm"> * dispatched and the window size is moved until the SSN.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mwifiex_11n_create_rx_reorder_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ta</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">win_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">seq_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="o">*</span><span class="n">new_node</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">last_seq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we get a TID, ta pair which is already present dispatch all the</span>
<span class="cm">	 * the packets and move the window size until the ssn</span>
<span class="cm">	 */</span>
	<span class="n">tbl</span> <span class="o">=</span> <span class="n">mwifiex_11n_get_rx_reorder_tbl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">ta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mwifiex_11n_dispatch_pkt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">seq_num</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* if !tbl then create one */</span>
	<span class="n">new_node</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: failed to alloc new_node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">ta</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">start_win</span> <span class="o">=</span> <span class="n">seq_num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mwifiex_queuing_ra_based</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="cm">/* TODO for adhoc */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;info: ADHOC:last_seq=%d start_win=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">last_seq</span><span class="p">,</span> <span class="n">new_node</span><span class="o">-&gt;</span><span class="n">start_win</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">last_seq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_seq</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">last_seq</span> <span class="o">!=</span> <span class="n">MWIFIEX_DEF_11N_RX_SEQ_NUM</span> <span class="o">&amp;&amp;</span>
	    <span class="n">last_seq</span> <span class="o">&gt;=</span> <span class="n">new_node</span><span class="o">-&gt;</span><span class="n">start_win</span><span class="p">)</span>
		<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">start_win</span> <span class="o">=</span> <span class="n">last_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">win_size</span> <span class="o">=</span> <span class="n">win_size</span><span class="p">;</span>

	<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">win_size</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">new_node</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: failed to alloc reorder_ptr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">timer_context</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">new_node</span><span class="p">;</span>
	<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">timer_context</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">timer_context</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">timer_context</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">mwifiex_flush_data</span><span class="p">;</span>
	<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">timer_context</span><span class="p">.</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">timer_context</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">win_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">new_node</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_node</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_ptr</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command for adding a BA request.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID and proper size</span>
<span class="cm"> *      - Setting add BA request buffer</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_cmd_11n_addba_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_11n_addba_req</span> <span class="o">*</span><span class="n">add_ba_req</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_11n_addba_req</span> <span class="o">*</span><span class="p">)</span>
		<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">add_ba_req</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_11N_ADDBA_REQ</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">add_ba_req</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">add_ba_req</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">add_ba_req</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command for adding a BA response.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID and proper size</span>
<span class="cm"> *      - Setting add BA response buffer</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_cmd_11n_addba_rsp_gen</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">host_cmd_ds_11n_addba_req</span>
				  <span class="o">*</span><span class="n">cmd_addba_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_11n_addba_rsp</span> <span class="o">*</span><span class="n">add_ba_rsp</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_11n_addba_rsp</span> <span class="o">*</span><span class="p">)</span>
		<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">add_ba_rsp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">win_size</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">block_ack_param_set</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_11N_ADDBA_RSP</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">add_ba_rsp</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">peer_mac_addr</span><span class="p">,</span> <span class="n">cmd_addba_req</span><span class="o">-&gt;</span><span class="n">peer_mac_addr</span><span class="p">,</span>
	       <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">dialog_token</span> <span class="o">=</span> <span class="n">cmd_addba_req</span><span class="o">-&gt;</span><span class="n">dialog_token</span><span class="p">;</span>
	<span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">block_ack_tmo</span> <span class="o">=</span> <span class="n">cmd_addba_req</span><span class="o">-&gt;</span><span class="n">block_ack_tmo</span><span class="p">;</span>
	<span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">ssn</span> <span class="o">=</span> <span class="n">cmd_addba_req</span><span class="o">-&gt;</span><span class="n">ssn</span><span class="p">;</span>

	<span class="n">block_ack_param_set</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd_addba_req</span><span class="o">-&gt;</span><span class="n">block_ack_param_set</span><span class="p">);</span>
	<span class="n">tid</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_ack_param_set</span> <span class="o">&amp;</span> <span class="n">IEEE80211_ADDBA_PARAM_TID_MASK</span><span class="p">)</span>
		<span class="o">&gt;&gt;</span> <span class="n">BLOCKACKPARAM_TID_POS</span><span class="p">;</span>
	<span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ADDBA_RSP_STATUS_ACCEPT</span><span class="p">);</span>
	<span class="n">block_ack_param_set</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_ADDBA_PARAM_BUF_SIZE_MASK</span><span class="p">;</span>
	<span class="cm">/* We donot support AMSDU inside AMPDU, hence reset the bit */</span>
	<span class="n">block_ack_param_set</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BLOCKACKPARAM_AMSDU_SUPP_MASK</span><span class="p">;</span>
	<span class="n">block_ack_param_set</span> <span class="o">|=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">add_ba_param</span><span class="p">.</span><span class="n">rx_win_size</span> <span class="o">&lt;&lt;</span>
					     <span class="n">BLOCKACKPARAM_WINSIZE_POS</span><span class="p">);</span>
	<span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">block_ack_param_set</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">block_ack_param_set</span><span class="p">);</span>
	<span class="n">win_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">block_ack_param_set</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="n">IEEE80211_ADDBA_PARAM_BUF_SIZE_MASK</span><span class="p">)</span>
					<span class="o">&gt;&gt;</span> <span class="n">BLOCKACKPARAM_WINSIZE_POS</span><span class="p">;</span>
	<span class="n">cmd_addba_req</span><span class="o">-&gt;</span><span class="n">block_ack_param_set</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">block_ack_param_set</span><span class="p">);</span>

	<span class="n">mwifiex_11n_create_rx_reorder_tbl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd_addba_req</span><span class="o">-&gt;</span><span class="n">peer_mac_addr</span><span class="p">,</span>
					  <span class="n">tid</span><span class="p">,</span> <span class="n">win_size</span><span class="p">,</span>
					  <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd_addba_req</span><span class="o">-&gt;</span><span class="n">ssn</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function prepares command for deleting a BA request.</span>
<span class="cm"> *</span>
<span class="cm"> * Preparation includes -</span>
<span class="cm"> *      - Setting command ID and proper size</span>
<span class="cm"> *      - Setting del BA request buffer</span>
<span class="cm"> *      - Ensuring correct endian-ness</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_cmd_11n_delba</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_11n_delba</span> <span class="o">*</span><span class="n">del_ba</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_11n_delba</span> <span class="o">*</span><span class="p">)</span>
		<span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">del_ba</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HostCmd_CMD_11N_DELBA</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">del_ba</span><span class="p">)</span> <span class="o">+</span> <span class="n">S_DS_GEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">del_ba</span><span class="p">,</span> <span class="n">data_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">del_ba</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function identifies if Rx reordering is needed for a received packet.</span>
<span class="cm"> *</span>
<span class="cm"> * In case reordering is required, the function will do the reordering</span>
<span class="cm"> * before sending it to kernel.</span>
<span class="cm"> *</span>
<span class="cm"> * The Rx reorder table is checked first with the received TID/TA pair. If</span>
<span class="cm"> * not found, the received packet is dispatched immediately. But if found,</span>
<span class="cm"> * the packet is reordered and all the packets in the updated Rx reordering</span>
<span class="cm"> * table is dispatched until a hole is found.</span>
<span class="cm"> *</span>
<span class="cm"> * For sequence number less than the starting window, the packet is dropped.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_11n_rx_reorder_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">seq_num</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">ta</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pkt_type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start_win</span><span class="p">,</span> <span class="n">end_win</span><span class="p">,</span> <span class="n">win_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pkt_index</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="n">mwifiex_11n_get_rx_reorder_tbl</span><span class="p">((</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="p">,</span>
					     <span class="n">tid</span><span class="p">,</span> <span class="n">ta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt_type</span> <span class="o">!=</span> <span class="n">PKT_TYPE_BAR</span><span class="p">)</span>
			<span class="n">mwifiex_process_rx_packet</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">start_win</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">start_win</span><span class="p">;</span>
	<span class="n">win_size</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win_size</span><span class="p">;</span>
	<span class="n">end_win</span> <span class="o">=</span> <span class="p">((</span><span class="n">start_win</span> <span class="o">+</span> <span class="n">win_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAX_TID_VALUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">timer_context</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">timer_context</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">MIN_FLUSH_TIMER_MS</span> <span class="o">*</span> <span class="n">win_size</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If seq_num is less then starting win then ignore and drop the</span>
<span class="cm">	 * packet</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">start_win</span> <span class="o">+</span> <span class="n">TWOPOW11</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">MAX_TID_VALUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span><span class="cm">/* Wrap */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seq_num</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">start_win</span> <span class="o">+</span> <span class="n">TWOPOW11</span><span class="p">)</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">MAX_TID_VALUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">seq_num</span> <span class="o">&lt;</span> <span class="n">start_win</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">seq_num</span> <span class="o">&lt;</span> <span class="n">start_win</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">seq_num</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">start_win</span> <span class="o">+</span> <span class="n">TWOPOW11</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this packet is a BAR we adjust seq_num as</span>
<span class="cm">	 * WinStart = seq_num</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_type</span> <span class="o">==</span> <span class="n">PKT_TYPE_BAR</span><span class="p">)</span>
		<span class="n">seq_num</span> <span class="o">=</span> <span class="p">((</span><span class="n">seq_num</span> <span class="o">+</span> <span class="n">win_size</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAX_TID_VALUE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">end_win</span> <span class="o">&lt;</span> <span class="n">start_win</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">seq_num</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">TWOPOW11</span> <span class="o">-</span> <span class="p">(</span><span class="n">MAX_TID_VALUE</span> <span class="o">-</span> <span class="n">start_win</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">seq_num</span> <span class="o">&gt;</span> <span class="n">end_win</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">end_win</span> <span class="o">&gt;</span> <span class="n">start_win</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">seq_num</span> <span class="o">&gt;</span> <span class="n">end_win</span><span class="p">)</span> <span class="o">||</span>
				       <span class="p">(</span><span class="n">seq_num</span> <span class="o">&lt;</span> <span class="n">start_win</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">end_win</span> <span class="o">=</span> <span class="n">seq_num</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">seq_num</span> <span class="o">-</span> <span class="n">win_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">start_win</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_win</span> <span class="o">-</span> <span class="n">win_size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">start_win</span> <span class="o">=</span> <span class="p">(</span><span class="n">MAX_TID_VALUE</span> <span class="o">-</span> <span class="p">(</span><span class="n">win_size</span> <span class="o">-</span> <span class="n">seq_num</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mwifiex_11n_dispatch_pkt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">start_win</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_type</span> <span class="o">!=</span> <span class="n">PKT_TYPE_BAR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seq_num</span> <span class="o">&gt;=</span> <span class="n">start_win</span><span class="p">)</span>
			<span class="n">pkt_index</span> <span class="o">=</span> <span class="n">seq_num</span> <span class="o">-</span> <span class="n">start_win</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pkt_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq_num</span><span class="o">+</span><span class="n">MAX_TID_VALUE</span><span class="p">)</span> <span class="o">-</span> <span class="n">start_win</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">pkt_index</span><span class="p">])</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">rx_reorder_ptr</span><span class="p">[</span><span class="n">pkt_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Dispatch all packets sequentially from start_win until a</span>
<span class="cm">	 * hole is found and adjust the start_win appropriately</span>
<span class="cm">	 */</span>
	<span class="n">mwifiex_11n_scan_and_dispatch</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tbl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function deletes an entry for a given TID/TA pair.</span>
<span class="cm"> *</span>
<span class="cm"> * The TID/TA are taken from del BA event body.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">mwifiex_del_ba_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">peer_mac</span><span class="p">,</span>
		   <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initiator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_tx_ba_stream_tbl</span> <span class="o">*</span><span class="n">ptx_tbl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cleanup_rx_reorder_tbl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TYPE_DELBA_RECEIVE</span><span class="p">)</span>
		<span class="n">cleanup_rx_reorder_tbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">initiator</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cleanup_rx_reorder_tbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">initiator</span><span class="p">)</span> <span class="o">?</span> <span class="nb">false</span> <span class="o">:</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;event: DELBA: %pM tid=%d initiator=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">peer_mac</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">initiator</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cleanup_rx_reorder_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tbl</span> <span class="o">=</span> <span class="n">mwifiex_11n_get_rx_reorder_tbl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
								 <span class="n">peer_mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;event: TID, TA not found in table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mwifiex_del_rx_reorder_entry</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tbl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ptx_tbl</span> <span class="o">=</span> <span class="n">mwifiex_get_ba_tbl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">peer_mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptx_tbl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;event: TID, RA not found in table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ba_stream_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mwifiex_11n_delete_tx_ba_stream_tbl_entry</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ptx_tbl</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_ba_stream_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles the command response of an add BA response.</span>
<span class="cm"> *</span>
<span class="cm"> * Handling includes changing the header fields into CPU format and</span>
<span class="cm"> * creating the stream, provided the add BA is accepted.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mwifiex_ret_11n_addba_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">host_cmd_ds_command</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_11n_addba_rsp</span> <span class="o">*</span><span class="n">add_ba_rsp</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_11n_addba_rsp</span> <span class="o">*</span><span class="p">)</span>
		<span class="o">&amp;</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">add_ba_rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="n">win_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">block_ack_param_set</span><span class="p">;</span>

	<span class="n">block_ack_param_set</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">block_ack_param_set</span><span class="p">);</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_ack_param_set</span> <span class="o">&amp;</span> <span class="n">IEEE80211_ADDBA_PARAM_TID_MASK</span><span class="p">)</span>
		<span class="o">&gt;&gt;</span> <span class="n">BLOCKACKPARAM_TID_POS</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if we had rejected the ADDBA, if yes then do not create</span>
<span class="cm">	 * the stream</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">status_code</span><span class="p">)</span> <span class="o">==</span> <span class="n">BA_RESULT_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">win_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_ack_param_set</span> <span class="o">&amp;</span>
			<span class="n">IEEE80211_ADDBA_PARAM_BUF_SIZE_MASK</span><span class="p">)</span>
			<span class="o">&gt;&gt;</span> <span class="n">BLOCKACKPARAM_WINSIZE_POS</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cmd: ADDBA RSP: %pM tid=%d ssn=%d win_size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">peer_mac_addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
			<span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">ssn</span><span class="p">,</span> <span class="n">win_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ADDBA RSP: failed %pM tid=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">peer_mac_addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

		<span class="n">tbl</span> <span class="o">=</span> <span class="n">mwifiex_11n_get_rx_reorder_tbl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
						     <span class="n">add_ba_rsp</span><span class="o">-&gt;</span><span class="n">peer_mac_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="p">)</span>
			<span class="n">mwifiex_del_rx_reorder_entry</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tbl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function handles BA stream timeout event by preparing and sending</span>
<span class="cm"> * a command to the firmware.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mwifiex_11n_ba_stream_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">host_cmd_ds_11n_batimeout</span> <span class="o">*</span><span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_cmd_ds_11n_delba</span> <span class="n">delba</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">delba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">host_cmd_ds_11n_delba</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">delba</span><span class="p">.</span><span class="n">peer_mac_addr</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">peer_mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">delba</span><span class="p">.</span><span class="n">del_ba_param_set</span> <span class="o">|=</span>
		<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">&lt;&lt;</span> <span class="n">DELBA_TID_POS</span><span class="p">);</span>
	<span class="n">delba</span><span class="p">.</span><span class="n">del_ba_param_set</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
		<span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">origninator</span> <span class="o">&lt;&lt;</span> <span class="n">DELBA_INITIATOR_POS</span><span class="p">);</span>
	<span class="n">delba</span><span class="p">.</span><span class="n">reason_code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_REASON_QSTA_TIMEOUT</span><span class="p">);</span>
	<span class="n">mwifiex_send_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">HostCmd_CMD_11N_DELBA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">delba</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function cleans up the Rx reorder table by deleting all the entries</span>
<span class="cm"> * and re-initializing.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mwifiex_11n_cleanup_reorder_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">mwifiex_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mwifiex_rx_reorder_tbl</span> <span class="o">*</span><span class="n">del_tbl_ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_node</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">del_tbl_ptr</span><span class="p">,</span> <span class="n">tmp_node</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_ptr</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">mwifiex_del_rx_reorder_entry</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">del_tbl_ptr</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_reorder_tbl_ptr</span><span class="p">);</span>
	<span class="n">mwifiex_reset_11n_rx_seq_num</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
