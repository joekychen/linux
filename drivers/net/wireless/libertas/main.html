<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › libertas › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file contains the major functions in WLAN</span>
<span class="cm"> * driver. It includes init, exit, open, close and main</span>
<span class="cm"> * thread etc..</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/kfifo.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>

<span class="cp">#include &quot;host.h&quot;</span>
<span class="cp">#include &quot;decl.h&quot;</span>
<span class="cp">#include &quot;dev.h&quot;</span>
<span class="cp">#include &quot;cfg.h&quot;</span>
<span class="cp">#include &quot;debugfs.h&quot;</span>
<span class="cp">#include &quot;cmd.h&quot;</span>
<span class="cp">#include &quot;mesh.h&quot;</span>

<span class="cp">#define DRIVER_RELEASE_VERSION &quot;323.p0&quot;</span>
<span class="k">const</span> <span class="kt">char</span> <span class="n">lbs_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;COMM-USB8388-&quot;</span> <span class="n">DRIVER_RELEASE_VERSION</span>
<span class="cp">#ifdef  DEBUG</span>
    <span class="s">&quot;-dbg&quot;</span>
<span class="cp">#endif</span>
    <span class="s">&quot;&quot;</span><span class="p">;</span>


<span class="cm">/* Module parameters */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lbs_debug</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbs_debug</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">libertas_debug</span><span class="p">,</span> <span class="n">lbs_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lbs_disablemesh</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbs_disablemesh</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">libertas_disablemesh</span><span class="p">,</span> <span class="n">lbs_disablemesh</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * This global structure is used to send the confirm_sleep command as</span>
<span class="cm"> * fast as possible down to the firmware.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cmd_confirm_sleep</span> <span class="n">confirm_sleep</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * the table to keep region code</span>
<span class="cm"> */</span>
<span class="n">u16</span> <span class="n">lbs_region_code_to_index</span><span class="p">[</span><span class="n">MRVDRV_MAX_REGION_CODE</span><span class="p">]</span> <span class="o">=</span>
    <span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * FW rate table.  FW refers to rates by their index in this table, not by the</span>
<span class="cm"> * rate value itself.  Values of 0x00 are</span>
<span class="cm"> * reserved positions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">fw_data_rates</span><span class="p">[</span><span class="n">MAX_RATES</span><span class="p">]</span> <span class="o">=</span>
    <span class="p">{</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span>
      <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> *  lbs_fw_index_to_data_rate - use index to get the data rate</span>
<span class="cm"> *</span>
<span class="cm"> *  @idx:	The index of data rate</span>
<span class="cm"> *  returns:	data rate or 0</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">lbs_fw_index_to_data_rate</span><span class="p">(</span><span class="n">u8</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_data_rates</span><span class="p">))</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">fw_data_rates</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  lbs_data_rate_to_fw_index - use rate to get the index</span>
<span class="cm"> *</span>
<span class="cm"> *  @rate:	data rate</span>
<span class="cm"> *  returns:	index or 0</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">lbs_data_rate_to_fw_index</span><span class="p">(</span><span class="n">u32</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rate</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fw_data_rates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">fw_data_rates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbs_set_iface_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_monitor_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_monitor_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_snmp_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">SNMP_MIB_OID_BSS_TYPE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_monitor_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_snmp_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">SNMP_MIB_OID_BSS_TYPE</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbs_start_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_mac_address</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_restore</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_ACT_SET</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">macadd</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_MAC_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbs_deb_net</span><span class="p">(</span><span class="s">&quot;set MAC address failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_iface_type</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbs_deb_net</span><span class="p">(</span><span class="s">&quot;set iface type failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lbs_update_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">iface_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_save</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_save</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  lbs_dev_open - open the ethX interface</span>
<span class="cm"> *</span>
<span class="cm"> *  @dev:	A pointer to &amp;net_device structure</span>
<span class="cm"> *  returns:	0 or -EBUSY if monitor mode active</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_dev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_NET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iface_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_start_iface</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending_len</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_NET</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">lbs_command_queue_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdpendingq</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbs_stop_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">iface_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">currenttxskb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">currenttxskb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcast_work</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lockup_timer</span><span class="p">);</span>

	<span class="cm">/* Disable command processing, and wait for all commands to complete */</span>
	<span class="n">lbs_deb_main</span><span class="p">(</span><span class="s">&quot;waiting for commands to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wait_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">,</span> <span class="n">lbs_command_queue_empty</span><span class="p">(</span><span class="n">priv</span><span class="p">));</span>
	<span class="n">lbs_deb_main</span><span class="p">(</span><span class="s">&quot;all commands completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_save</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_save</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  lbs_eth_stop - close the ethX interface</span>
<span class="cm"> *</span>
<span class="cm"> *  @dev:	A pointer to &amp;net_device structure</span>
<span class="cm"> *  returns:	0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_eth_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_NET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_status</span> <span class="o">==</span> <span class="n">LBS_CONNECTED</span><span class="p">)</span>
		<span class="n">lbs_disconnect</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WLAN_REASON_DEAUTH_LEAVING</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="n">lbs_update_mcast</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">)</span>
		<span class="n">lbs_scan_done</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lbs_iface_active</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">lbs_stop_iface</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_NET</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lbs_host_to_card_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_THREAD</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lockup_timer</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span> <span class="o">=</span> <span class="n">DNLD_RES_RECEIVED</span><span class="p">;</span>

	<span class="cm">/* Wake main thread if commands are pending */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wakeup_dev_required</span><span class="p">)</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_THREAD</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbs_host_to_card_done</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">lbs_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">phwaddr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_NET</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Can only set MAC address when all interfaces are down, to be written</span>
<span class="cm">	 * to the hardware when one of them is brought up.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lbs_iface_active</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* In case it was called from the mesh device */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_addr</span><span class="p">,</span> <span class="n">phwaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">phwaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">phwaddr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_NET</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">mac_in_list</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span> <span class="n">list_len</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">list_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">list</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="n">list_len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_add_mcast_addrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_ds_mac_multicast_adr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_addrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">nr_addrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IFF_UP</span><span class="o">|</span><span class="n">IFF_MULTICAST</span><span class="p">))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">IFF_UP</span><span class="o">|</span><span class="n">IFF_MULTICAST</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">nr_addrs</span><span class="p">;</span>

	<span class="n">netif_addr_lock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_in_list</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maclist</span><span class="p">,</span> <span class="n">nr_addrs</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lbs_deb_net</span><span class="p">(</span><span class="s">&quot;mcast address %s:%pM skipped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MRVDRV_MAX_MULTICAST_LIST_SIZE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">maclist</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">i</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">lbs_deb_net</span><span class="p">(</span><span class="s">&quot;mcast address %s:%pM added to filter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">netif_addr_unlock_bh</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lbs_update_mcast</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_mac_multicast_adr</span> <span class="n">mcast_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dev_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr_addrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_mac_control</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_NET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span> <span class="o">&amp;&amp;</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">))</span>
		<span class="n">dev_flags</span> <span class="o">|=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">|=</span> <span class="n">CMD_ACT_MAC_PROMISCUOUS_ENABLE</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CMD_ACT_MAC_ALL_MULTICAST_ENABLE</span> <span class="o">|</span>
				       <span class="n">CMD_ACT_MAC_MULTICAST_ENABLE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_set_mac_control</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev_flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">do_allmulti:</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">|=</span> <span class="n">CMD_ACT_MAC_ALL_MULTICAST_ENABLE</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CMD_ACT_MAC_PROMISCUOUS_ENABLE</span> <span class="o">|</span>
				       <span class="n">CMD_ACT_MAC_MULTICAST_ENABLE</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_set_mac_control</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Once for priv-&gt;dev, again for priv-&gt;mesh_dev if it exists */</span>
	<span class="n">nr_addrs</span> <span class="o">=</span> <span class="n">lbs_add_mcast_addrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcast_cmd</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_addrs</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="n">nr_addrs</span> <span class="o">=</span> <span class="n">lbs_add_mcast_addrs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mcast_cmd</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">,</span> <span class="n">nr_addrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nr_addrs</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_allmulti</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nr_addrs</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_ds_mac_multicast_adr</span><span class="p">,</span>
				    <span class="n">maclist</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="n">nr_addrs</span><span class="p">]);</span>

		<span class="n">mcast_cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_ACT_SET</span><span class="p">);</span>
		<span class="n">mcast_cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
		<span class="n">mcast_cmd</span><span class="p">.</span><span class="n">nr_of_adrs</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">nr_addrs</span><span class="p">);</span>

		<span class="n">lbs_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_MAC_MULTICAST_ADR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcast_cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">|=</span> <span class="n">CMD_ACT_MAC_MULTICAST_ENABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMD_ACT_MAC_MULTICAST_ENABLE</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CMD_ACT_MAC_PROMISCUOUS_ENABLE</span> <span class="o">|</span>
			       <span class="n">CMD_ACT_MAC_ALL_MULTICAST_ENABLE</span><span class="p">);</span>
 <span class="nl">out_set_mac_control:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">!=</span> <span class="n">old_mac_control</span><span class="p">)</span>
		<span class="n">lbs_set_mac_control</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_NET</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbs_set_mcast_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lbs_private</span><span class="p">,</span> <span class="n">mcast_work</span><span class="p">);</span>
	<span class="n">lbs_update_mcast</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lbs_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcast_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  lbs_thread - handles the major jobs in the LBS driver.</span>
<span class="cm"> *  It handles all events generated by firmware, RX data received</span>
<span class="cm"> *  from firmware and TX data sent from kernel.</span>
<span class="cm"> *</span>
<span class="cm"> *  @data:	A pointer to &amp;lbs_thread structure</span>
<span class="cm"> *  returns:	0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">wait_queue_t</span> <span class="n">wait</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_THREAD</span><span class="p">);</span>

	<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">shouldsleep</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">resp_idx</span><span class="p">;</span>

		<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;1: currenttxskb %p, dnld_sent %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">currenttxskb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span><span class="p">);</span>

		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Bye */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">surpriseremoved</span><span class="p">)</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* We need to wait until we&#39;re _told_ to die */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">psstate</span> <span class="o">==</span> <span class="n">PS_STATE_SLEEP</span><span class="p">)</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Sleep mode. Nothing we can do till it wakes */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_timed_out</span><span class="p">)</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Command timed out. Recover */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ready</span><span class="p">)</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Firmware not ready. We&#39;re waiting for it */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span><span class="p">)</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Something is en route to the device already */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* We&#39;ve a packet to send */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">resp_idx</span><span class="p">])</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* We have a command response */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">)</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Can&#39;t send a command; one already running */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdpendingq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wakeup_dev_required</span><span class="p">))</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* We have a command to send */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">event_fifo</span><span class="p">))</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* We have an event to process */</span>
		<span class="k">else</span>
			<span class="n">shouldsleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* No command */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">shouldsleep</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;sleeping, connect_status %d, &quot;</span>
				<span class="s">&quot;psmode %d, psstate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_status</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">psmode</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">psstate</span><span class="p">);</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>

		<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;2: currenttxskb %p, dnld_send %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">currenttxskb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span><span class="p">);</span>

		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
		<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

		<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;3: currenttxskb %p, dnld_sent %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">currenttxskb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;break from main thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">surpriseremoved</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;adapter removed; waiting to die...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;4: currenttxskb %p, dnld_sent %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">currenttxskb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span><span class="p">);</span>

		<span class="cm">/* Process any pending command response */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
		<span class="n">resp_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">resp_idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">[</span><span class="n">resp_idx</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
			<span class="n">lbs_process_command_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">resp_buf</span><span class="p">[</span><span class="n">resp_idx</span><span class="p">],</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">[</span><span class="n">resp_idx</span><span class="p">]);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">[</span><span class="n">resp_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>

		<span class="cm">/* Process hardware events, e.g. card removed, link lost */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">kfifo_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">event_fifo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">event</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">kfifo_out</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">event_fifo</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">))</span> <span class="o">!=</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
			<span class="n">lbs_process_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wakeup_dev_required</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;Waking up device...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Wake up device */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">exit_deep_sleep</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
				<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;Wakeup device failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* command timeout stuff */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_timed_out</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmdnode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">;</span>

			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Timeout submitting command 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">));</span>
			<span class="n">lbs_complete_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmdnode</span><span class="p">,</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_card</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_card</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_timed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ready</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Check if we need to confirm Sleep Request received previously */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">psstate</span> <span class="o">==</span> <span class="n">PS_STATE_PRE_SLEEP</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_status</span> <span class="o">==</span> <span class="n">LBS_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;pre-sleep, currenttxskb %p, &quot;</span>
					<span class="s">&quot;dnld_sent %d, cur_cmd %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">currenttxskb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">);</span>

				<span class="n">lbs_ps_confirm_sleep</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* workaround for firmware sending</span>
<span class="cm">				 * deauth/linkloss event immediately</span>
<span class="cm">				 * after sleep request; remove this</span>
<span class="cm">				 * after firmware fixes it</span>
<span class="cm">				 */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">psstate</span> <span class="o">=</span> <span class="n">PS_STATE_AWAKE</span><span class="p">;</span>
				<span class="n">netdev_alert</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="s">&quot;ignore PS_SleepConfirm in non-connected state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* The PS state is changed during processing of Sleep Request</span>
<span class="cm">		 * event above</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">psstate</span> <span class="o">==</span> <span class="n">PS_STATE_SLEEP</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">psstate</span> <span class="o">==</span> <span class="n">PS_STATE_PRE_SLEEP</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_deep_sleep</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Execute the next command */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">)</span>
			<span class="n">lbs_execute_next_command</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_host_to_card</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MVMS_DAT</span><span class="p">,</span>
							<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending_buf</span><span class="p">,</span>
							<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending_len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lbs_deb_tx</span><span class="p">(</span><span class="s">&quot;host_to_card failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span> <span class="o">=</span> <span class="n">DNLD_RES_RECEIVED</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lockup_timer</span><span class="p">,</span>
					  <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">5</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">currenttxskb</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* We can wake the queues immediately if we aren&#39;t</span>
<span class="cm">				   waiting for TX feedback */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_status</span> <span class="o">==</span> <span class="n">LBS_CONNECTED</span><span class="p">)</span>
					<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span> <span class="o">&amp;&amp;</span>
				    <span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">))</span>
					<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_timer</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lockup_timer</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_deepsleep_timer</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_THREAD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lbs_setup_firmware - gets the HW spec from the firmware and sets</span>
<span class="cm"> *        some basic parameters</span>
<span class="cm"> *</span>
<span class="cm"> *  @priv:	A pointer to &amp;struct lbs_private structure</span>
<span class="cm"> *  returns:	0 or -1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_setup_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">curlevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">minlevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maxlevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_FW</span><span class="p">);</span>

	<span class="cm">/* Read MAC address from firmware */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_addr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_update_hw_spec</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Read power levels if available */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_get_tx_power</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">curlevel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">minlevel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxlevel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpower_cur</span> <span class="o">=</span> <span class="n">curlevel</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpower_min</span> <span class="o">=</span> <span class="n">minlevel</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpower_max</span> <span class="o">=</span> <span class="n">maxlevel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send cmd to FW to enable 11D function */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_snmp_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">SNMP_MIB_OID_11D_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">lbs_set_mac_control</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_FW</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbs_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_FW</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_deep_sleep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_deep_sleep</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;deep sleep cancellation failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">deep_sleep_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_host_sleep</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">);</span>

	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_FW</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbs_suspend</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">lbs_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_FW</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_host_sleep</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">deep_sleep_required</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">deep_sleep_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_deep_sleep</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;deep sleep activation failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">setup_fw_on_resume</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_setup_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_FW</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbs_resume</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * lbs_cmd_timeout_handler - handles the timeout of command sending.</span>
<span class="cm"> * It will re-send the same command again.</span>
<span class="cm"> *</span>
<span class="cm"> * @data: &amp;struct lbs_private pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbs_cmd_timeout_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CMD</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;command 0x%04x timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_timed_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the device didn&#39;t even acknowledge the command, reset the state</span>
<span class="cm">	 * so that we don&#39;t block all future commands due to this one timeout.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span> <span class="o">==</span> <span class="n">DNLD_CMD_SENT</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span> <span class="o">=</span> <span class="n">DNLD_RES_RECEIVED</span><span class="p">;</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lbs_tx_lockup_handler - handles the timeout of the passing of TX frames</span>
<span class="cm"> * to the hardware. This is known to frequently happen with SD8686 when</span>
<span class="cm"> * waking up after a Wake-on-WLAN-triggered resume.</span>
<span class="cm"> *</span>
<span class="cm"> * @data: &amp;struct lbs_private pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbs_tx_lockup_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_TX</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX lockup detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_card</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset_card</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dnld_sent</span> <span class="o">=</span> <span class="n">DNLD_RES_RECEIVED</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_TX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * auto_deepsleep_timer_fn - put the device back to deep sleep mode when</span>
<span class="cm"> * timer expires and no activity (command, event, data etc.) is detected.</span>
<span class="cm"> * @data:	&amp;struct lbs_private pointer</span>
<span class="cm"> * returns:	N/A</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">auto_deepsleep_timer_fn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_activity_detected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_activity_detected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_auto_deep_sleep_enabled</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wakeup_dev_required</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_status</span> <span class="o">!=</span> <span class="n">LBS_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">cmd_header</span> <span class="n">cmd</span><span class="p">;</span>

			<span class="n">lbs_deb_main</span><span class="p">(</span><span class="s">&quot;Entering auto deep sleep mode...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
			<span class="n">lbs_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_DEEP_SLEEP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_deepsleep_timer</span> <span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_deep_sleep_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbs_enter_auto_deep_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_SDIO</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_auto_deep_sleep_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_deep_sleep</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wakeup_dev_required</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_deepsleep_timer</span> <span class="p">,</span>
			<span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_deep_sleep_timeout</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_SDIO</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbs_exit_auto_deep_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_SDIO</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_auto_deep_sleep_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_deep_sleep_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_deepsleep_timer</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_SDIO</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_init_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_addr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_status</span> <span class="o">=</span> <span class="n">LBS_DISCONNECTED</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">DEFAULT_AD_HOC_CHANNEL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">=</span> <span class="n">CMD_ACT_MAC_RX_ON</span> <span class="o">|</span> <span class="n">CMD_ACT_MAC_TX_ON</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">psmode</span> <span class="o">=</span> <span class="n">LBS802_11POWERMODECAM</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">psstate</span> <span class="o">=</span> <span class="n">PS_STATE_FULL_POWER</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_deep_sleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_auto_deep_sleep_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">deep_sleep_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wakeup_dev_required</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ds_awake_q</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_q</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">authtype_auto</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_host_sleep_configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_host_sleep_activated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_sleep_q</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_waitq</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_timer</span><span class="p">,</span> <span class="n">lbs_cmd_timeout_handler</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lockup_timer</span><span class="p">,</span> <span class="n">lbs_tx_lockup_handler</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_deepsleep_timer</span><span class="p">,</span> <span class="n">auto_deepsleep_timer_fn</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdfreeq</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdpendingq</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="cm">/* Allocate the command buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lbs_allocate_cmd_buffer</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Out of memory allocating command buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">resp_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">resp_len</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Create the event FIFO */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">event_fifo</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Out of memory allocating event FIFO buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbs_free_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>

	<span class="n">lbs_free_cmd_buffer</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">event_fifo</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_timer</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_lockup_timer</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_deepsleep_timer</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">lbs_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">lbs_dev_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">lbs_eth_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">lbs_hard_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">lbs_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">lbs_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * lbs_add_card - adds the card. It will probe the</span>
<span class="cm"> * card, allocate the lbs_priv and initialize the device.</span>
<span class="cm"> *</span>
<span class="cm"> * @card:	A pointer to card</span>
<span class="cm"> * @dmdev:	A pointer to &amp;struct device</span>
<span class="cm"> * returns:	A pointer to &amp;struct lbs_private structure</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="nf">lbs_add_card</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>

	<span class="cm">/* Allocate an Ethernet device and register it */</span>
	<span class="n">wdev</span> <span class="o">=</span> <span class="n">lbs_cfg_alloc</span><span class="p">(</span><span class="n">dmdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">wdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cfg80211 init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="n">wdev_priv</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">wdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lbs_init_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to initialize adapter structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_wdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">,</span> <span class="n">ether_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dmdev</span><span class="p">,</span> <span class="s">&quot;no memory for network device instance</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_adapter</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span> <span class="o">=</span> <span class="n">wdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmdev</span><span class="p">);</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

 	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lbs_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lbs_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_BROADCAST</span> <span class="o">|</span> <span class="n">IFF_MULTICAST</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">);</span>

	<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;Starting main thread...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">main_thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">lbs_thread</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;lbs_main&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">main_thread</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lbs_deb_thread</span><span class="p">(</span><span class="s">&quot;Error creating main thread.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_ndev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_thread</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;lbs_worker&quot;</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mcast_work</span><span class="p">,</span> <span class="n">lbs_set_mcast_worker</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wol_criteria</span> <span class="o">=</span> <span class="n">EHS_REMOVE_WAKEUP</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wol_gpio</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wol_gap</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ehs_remove_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

 <span class="nl">err_ndev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

 <span class="nl">err_adapter:</span>
	<span class="n">lbs_free_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

 <span class="nl">err_wdev:</span>
	<span class="n">lbs_cfg_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">,</span> <span class="s">&quot;priv %p&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbs_add_card</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">lbs_remove_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>

	<span class="n">lbs_remove_mesh</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wiphy_registered</span><span class="p">)</span>
		<span class="n">lbs_scan_deinit</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">lbs_wait_for_firmware_load</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* worker thread destruction blocks on the in-flight command which</span>
<span class="cm">	 * should have been cleared already in lbs_stop_card().</span>
<span class="cm">	 */</span>
	<span class="n">lbs_deb_main</span><span class="p">(</span><span class="s">&quot;destroying worker thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_thread</span><span class="p">);</span>
	<span class="n">lbs_deb_main</span><span class="p">(</span><span class="s">&quot;done destroying worker thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">psmode</span> <span class="o">==</span> <span class="n">LBS802_11POWERMODEMAX_PSP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">psmode</span> <span class="o">=</span> <span class="n">LBS802_11POWERMODECAM</span><span class="p">;</span>
		<span class="n">lbs_set_ps_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">PS_MODE_ACTION_EXIT_PS</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_deep_sleep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_deep_sleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ds_awake_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_host_sleep_configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">is_host_sleep_activated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_sleep_q</span><span class="p">);</span>

	<span class="cm">/* Stop the thread servicing the interrupts */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">surpriseremoved</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">main_thread</span><span class="p">);</span>

	<span class="n">lbs_free_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">lbs_cfg_free</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbs_remove_card</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">lbs_rtap_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MRVL_FW_MAJOR_REV</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span><span class="p">)</span> <span class="o">==</span> <span class="n">MRVL_FW_V5</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* newer firmware use a capability mask */</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">MRVL_FW_MAJOR_REV</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MRVL_FW_V10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwcapinfo</span> <span class="o">&amp;</span> <span class="n">MESH_CAPINFO_ENABLE_MASK</span><span class="p">));</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">lbs_start_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>

	<span class="cm">/* poke the firmware */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_setup_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lbs_disablemesh</span><span class="p">)</span>
		<span class="n">lbs_init_mesh</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: mesh disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lbs_cfg_register</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot register device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lbs_mesh_activated</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">lbs_start_mesh</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">lbs_debugfs_init_one</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Marvell WLAN 802.11 adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbs_start_card</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">lbs_stop_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* If the netdev isn&#39;t registered, it means that lbs_start_card() was</span>
<span class="cm">	 * never called so we have nothing to do here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reg_state</span> <span class="o">!=</span> <span class="n">NETREG_REGISTERED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">lbs_debugfs_remove_one</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">lbs_deinit_mesh</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbs_stop_card</span><span class="p">);</span>


<span class="kt">void</span> <span class="nf">lbs_queue_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_THREAD</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">psstate</span> <span class="o">==</span> <span class="n">PS_STATE_SLEEP</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">psstate</span> <span class="o">=</span> <span class="n">PS_STATE_AWAKE</span><span class="p">;</span>

	<span class="n">kfifo_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">event_fifo</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_THREAD</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbs_queue_event</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">lbs_notify_command_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">resp_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_THREAD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">psstate</span> <span class="o">==</span> <span class="n">PS_STATE_SLEEP</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">psstate</span> <span class="o">=</span> <span class="n">PS_STATE_AWAKE</span><span class="p">;</span>

	<span class="cm">/* Swap buffers by flipping the response index */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">resp_idx</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">resp_idx</span> <span class="o">=</span> <span class="n">resp_idx</span><span class="p">;</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_THREAD</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbs_notify_command_response</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">lbs_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">confirm_sleep</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">confirm_sleep</span><span class="p">));</span>
	<span class="n">confirm_sleep</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_802_11_PS_MODE</span><span class="p">);</span>
	<span class="n">confirm_sleep</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">confirm_sleep</span><span class="p">));</span>
	<span class="n">confirm_sleep</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">PS_MODE_ACTION_SLEEP_CONFIRMED</span><span class="p">);</span>
	<span class="n">lbs_debugfs_init</span><span class="p">();</span>
	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">lbs_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>
	<span class="n">lbs_debugfs_remove</span><span class="p">();</span>
	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_MAIN</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">lbs_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">lbs_exit_module</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Libertas WLAN Driver Library&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Marvell International Ltd.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
