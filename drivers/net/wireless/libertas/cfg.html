<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › libertas › cfg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cfg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Implement cfg80211 (&quot;iw&quot;) support.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 M&amp;N Solutions GmbH, 61191 Rosbach, Germany</span>
<span class="cm"> * Holger Schurig &lt;hs4233@mail.mn-solutions.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;decl.h&quot;</span>
<span class="cp">#include &quot;cfg.h&quot;</span>
<span class="cp">#include &quot;cmd.h&quot;</span>
<span class="cp">#include &quot;mesh.h&quot;</span>


<span class="cp">#define CHAN2G(_channel, _freq, _flags) {        \</span>
<span class="cp">	.band             = IEEE80211_BAND_2GHZ, \</span>
<span class="cp">	.center_freq      = (_freq),             \</span>
<span class="cp">	.hw_value         = (_channel),          \</span>
<span class="cp">	.flags            = (_flags),            \</span>
<span class="cp">	.max_antenna_gain = 0,                   \</span>
<span class="cp">	.max_power        = 30,                  \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">lbs_2ghz_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">2412</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>  <span class="mi">2417</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span>  <span class="mi">2422</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span>  <span class="mi">2427</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span>  <span class="mi">2432</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span>  <span class="mi">2437</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span>  <span class="mi">2442</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span>  <span class="mi">2447</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span>  <span class="mi">2452</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2457</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">2462</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2467</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">2472</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">2484</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define RATETAB_ENT(_rate, _hw_value, _flags) { \</span>
<span class="cp">	.bitrate  = (_rate),                    \</span>
<span class="cp">	.hw_value = (_hw_value),                \</span>
<span class="cp">	.flags    = (_flags),                   \</span>
<span class="cp">}</span>


<span class="cm">/* Table 6 in section 3.2.1.1 */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">lbs_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="mi">540</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">lbs_band_2ghz</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">lbs_2ghz_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lbs_2ghz_channels</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">lbs_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lbs_rates</span><span class="p">),</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">cipher_suites</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Time to stay on the channel */</span>
<span class="cp">#define LBS_DWELL_PASSIVE 100</span>
<span class="cp">#define LBS_DWELL_ACTIVE  40</span>


<span class="cm">/***************************************************************************</span>
<span class="cm"> * Misc utility functions</span>
<span class="cm"> *</span>
<span class="cm"> * TLVs are Marvell specific. They are very similar to IEs, they have the</span>
<span class="cm"> * same structure: type, length, data*. The only difference: for IEs, the</span>
<span class="cm"> * type and length are u8, but for TLVs they&#39;re __le16.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Convert NL80211&#39;s auth_type to the one from Libertas, see chapter 5.9.1</span>
<span class="cm"> * in the firmware spec</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_auth_to_authtype</span><span class="p">(</span><span class="k">enum</span> <span class="n">nl80211_auth_type</span> <span class="n">auth_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">auth_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_OPEN_SYSTEM</span>:
	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_SHARED_KEY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">auth_type</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_AUTOMATIC</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">NL80211_AUTHTYPE_OPEN_SYSTEM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_AUTHTYPE_NETWORK_EAP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* silence compiler */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Various firmware commands need the list of supported rates, but with</span>
<span class="cm"> * the hight-bit set for basic rates</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_add_rates</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lbs_rates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">lbs_rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">||</span> <span class="n">rate</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">||</span>
		    <span class="n">rate</span> <span class="o">==</span> <span class="mh">0x0b</span> <span class="o">||</span> <span class="n">rate</span> <span class="o">==</span> <span class="mh">0x16</span><span class="p">)</span>
			<span class="n">rate</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lbs_rates</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/***************************************************************************</span>
<span class="cm"> * TLV utility functions</span>
<span class="cm"> *</span>
<span class="cm"> * TLVs are Marvell specific. They are very similar to IEs, they have the</span>
<span class="cm"> * same structure: type, length, data*. The only difference: for IEs, the</span>
<span class="cm"> * type and length are u8, but for TLVs they&#39;re __le16.</span>
<span class="cm"> */</span>


<span class="cm">/*</span>
<span class="cm"> * Add ssid TLV</span>
<span class="cm"> */</span>
<span class="cp">#define LBS_MAX_SSID_TLV_SIZE			\</span>
<span class="cp">	(sizeof(struct mrvl_ie_header)		\</span>
<span class="cp">	 + IEEE80211_MAX_SSID_LEN)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_add_ssid_tlv</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ssid_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mrvl_ie_ssid_param_set</span> <span class="o">*</span><span class="n">ssid_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tlv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TLV-ID SSID  00 00</span>
<span class="cm">	 * length       06 00</span>
<span class="cm">	 * ssid         4d 4e 54 45 53 54</span>
<span class="cm">	 */</span>
	<span class="n">ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_SSID</span><span class="p">);</span>
	<span class="n">ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ssid_tlv</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">ssid_len</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Add channel list TLV (section 8.4.2)</span>
<span class="cm"> *</span>
<span class="cm"> * Actual channel data comes from priv-&gt;wdev-&gt;wiphy-&gt;channels.</span>
<span class="cm"> */</span>
<span class="cp">#define LBS_MAX_CHANNEL_LIST_TLV_SIZE					\</span>
<span class="cp">	(sizeof(struct mrvl_ie_header)					\</span>
<span class="cp">	 + (LBS_SCAN_BEFORE_NAP * sizeof(struct chanscanparamset)))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_add_channel_list_tlv</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">last_channel</span><span class="p">,</span> <span class="kt">int</span> <span class="n">active_scan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">chanscanparamsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chanscanparamset</span><span class="p">)</span> <span class="o">*</span>
		<span class="p">(</span><span class="n">last_channel</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_channel</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">mrvl_ie_header</span> <span class="o">*</span><span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TLV-ID CHANLIST  01 01</span>
<span class="cm">	 * length           0e 00</span>
<span class="cm">	 * channel          00 01 00 00 00 64 00</span>
<span class="cm">	 *   radio type     00</span>
<span class="cm">	 *   channel           01</span>
<span class="cm">	 *   scan type            00</span>
<span class="cm">	 *   min scan time           00 00</span>
<span class="cm">	 *   max scan time                 64 00</span>
<span class="cm">	 * channel 2        00 02 00 00 00 64 00</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_CHANLIST</span><span class="p">);</span>
	<span class="n">header</span><span class="o">-&gt;</span><span class="n">len</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">chanscanparamsize</span><span class="p">);</span>
	<span class="n">tlv</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mrvl_ie_header</span><span class="p">);</span>

	<span class="cm">/* lbs_deb_scan(&quot;scan: channels %d to %d\n&quot;, priv-&gt;scan_channel,</span>
<span class="cm">		     last_channel); */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chanscanparamsize</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_channel</span> <span class="o">&lt;</span> <span class="n">last_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">chanscanparamset</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv</span><span class="p">;</span>

		<span class="n">param</span><span class="o">-&gt;</span><span class="n">radiotype</span> <span class="o">=</span> <span class="n">CMD_SCAN_RADIO_TYPE_BG</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">channumber</span> <span class="o">=</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_channel</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">active_scan</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">maxscantime</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LBS_DWELL_ACTIVE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">chanscanmode</span><span class="p">.</span><span class="n">passivescan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">maxscantime</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LBS_DWELL_PASSIVE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tlv</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">chanscanparamset</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_channel</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mrvl_ie_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">chanscanparamsize</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Add rates TLV</span>
<span class="cm"> *</span>
<span class="cm"> * The rates are in lbs_bg_rates[], but for the 802.11b</span>
<span class="cm"> * rates the high bit is set. We add this TLV only because</span>
<span class="cm"> * there&#39;s a firmware which otherwise doesn&#39;t report all</span>
<span class="cm"> * APs in range.</span>
<span class="cm"> */</span>
<span class="cp">#define LBS_MAX_RATES_TLV_SIZE			\</span>
<span class="cp">	(sizeof(struct mrvl_ie_header)		\</span>
<span class="cp">	 + (ARRAY_SIZE(lbs_rates)))</span>

<span class="cm">/* Adds a TLV with all rates the hardware supports */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_add_supported_rates_tlv</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">tlv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mrvl_ie_rates_param_set</span> <span class="o">*</span><span class="n">rate_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tlv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TLV-ID RATES  01 00</span>
<span class="cm">	 * length        0e 00</span>
<span class="cm">	 * rates         82 84 8b 96 0c 12 18 24 30 48 60 6c</span>
<span class="cm">	 */</span>
	<span class="n">rate_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_RATES</span><span class="p">);</span>
	<span class="n">tlv</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rate_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">lbs_add_rates</span><span class="p">(</span><span class="n">tlv</span><span class="p">);</span>
	<span class="n">tlv</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">rate_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rate_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add common rates from a TLV and return the new end of the TLV */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span>
<span class="nf">add_ie_rates</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nrates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hw</span><span class="p">,</span> <span class="n">ap</span><span class="p">,</span> <span class="n">ap_max</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">hw_rate</span><span class="p">;</span>

	<span class="cm">/* Advance past IE header */</span>
	<span class="n">ie</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">lbs_deb_hex</span><span class="p">(</span><span class="n">LBS_DEB_ASSOC</span><span class="p">,</span> <span class="s">&quot;AP IE Rates&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ap_max</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">hw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hw</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lbs_rates</span><span class="p">);</span> <span class="n">hw</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw_rate</span> <span class="o">=</span> <span class="n">lbs_rates</span><span class="p">[</span><span class="n">hw</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ap</span> <span class="o">&lt;</span> <span class="n">ap_max</span><span class="p">;</span> <span class="n">ap</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw_rate</span> <span class="o">==</span> <span class="p">(</span><span class="n">ie</span><span class="p">[</span><span class="n">ap</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">tlv</span><span class="o">++</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="n">ap</span><span class="p">];</span>
				<span class="o">*</span><span class="n">nrates</span> <span class="o">=</span> <span class="o">*</span><span class="n">nrates</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tlv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Adds a TLV with all rates the hardware *and* BSS supports.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_add_common_rates_tlv</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mrvl_ie_rates_param_set</span> <span class="o">*</span><span class="n">rate_tlv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tlv</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rates_eid</span><span class="p">,</span> <span class="o">*</span><span class="n">ext_rates_eid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rates_eid</span> <span class="o">=</span> <span class="n">ieee80211_bss_get_ie</span><span class="p">(</span><span class="n">bss</span><span class="p">,</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">);</span>
	<span class="n">ext_rates_eid</span> <span class="o">=</span> <span class="n">ieee80211_bss_get_ie</span><span class="p">(</span><span class="n">bss</span><span class="p">,</span> <span class="n">WLAN_EID_EXT_SUPP_RATES</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * 01 00                   TLV_TYPE_RATES</span>
<span class="cm">	 * 04 00                   len</span>
<span class="cm">	 * 82 84 8b 96             rates</span>
<span class="cm">	 */</span>
	<span class="n">rate_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_RATES</span><span class="p">);</span>
	<span class="n">tlv</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rate_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">);</span>

	<span class="cm">/* Add basic rates */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rates_eid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlv</span> <span class="o">=</span> <span class="n">add_ie_rates</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="n">rates_eid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>

		<span class="cm">/* Add extended rates, if any */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_rates_eid</span><span class="p">)</span>
			<span class="n">tlv</span> <span class="o">=</span> <span class="n">add_ie_rates</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="n">ext_rates_eid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;assoc: bss had no basic rate IE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Fallback: add basic 802.11b rates */</span>
		<span class="o">*</span><span class="n">tlv</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tlv</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tlv</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x8b</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tlv</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x96</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rate_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rate_tlv</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Add auth type TLV.</span>
<span class="cm"> *</span>
<span class="cm"> * This is only needed for newer firmware (V9 and up).</span>
<span class="cm"> */</span>
<span class="cp">#define LBS_MAX_AUTH_TYPE_TLV_SIZE \</span>
<span class="cp">	sizeof(struct mrvl_ie_auth_type)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_add_auth_type_tlv</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">nl80211_auth_type</span> <span class="n">auth_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mrvl_ie_auth_type</span> <span class="o">*</span><span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 1f 01  TLV_TYPE_AUTH_TYPE</span>
<span class="cm">	 * 01 00  len</span>
<span class="cm">	 * 01     auth type</span>
<span class="cm">	 */</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_AUTH_TYPE</span><span class="p">);</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">auth</span><span class="p">)</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">));</span>
	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">auth</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">lbs_auth_to_authtype</span><span class="p">(</span><span class="n">auth_type</span><span class="p">));</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">auth</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Add channel (phy ds) TLV</span>
<span class="cm"> */</span>
<span class="cp">#define LBS_MAX_CHANNEL_TLV_SIZE \</span>
<span class="cp">	sizeof(struct mrvl_ie_header)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_add_channel_tlv</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mrvl_ie_ds_param_set</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 03 00  TLV_TYPE_PHY_DS</span>
<span class="cm">	 * 01 00  len</span>
<span class="cm">	 * 06     channel</span>
<span class="cm">	 */</span>
	<span class="n">ds</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_PHY_DS</span><span class="p">);</span>
	<span class="n">ds</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ds</span><span class="p">)</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">));</span>
	<span class="n">ds</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ds</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Add (empty) CF param TLV of the form:</span>
<span class="cm"> */</span>
<span class="cp">#define LBS_MAX_CF_PARAM_TLV_SIZE		\</span>
<span class="cp">	sizeof(struct mrvl_ie_header)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_add_cf_param_tlv</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">tlv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mrvl_ie_cf_param_set</span> <span class="o">*</span><span class="n">cf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">tlv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 04 00  TLV_TYPE_CF</span>
<span class="cm">	 * 06 00  len</span>
<span class="cm">	 * 00     cfpcnt</span>
<span class="cm">	 * 00     cfpperiod</span>
<span class="cm">	 * 00 00  cfpmaxduration</span>
<span class="cm">	 * 00 00  cfpdurationremaining</span>
<span class="cm">	 */</span>
	<span class="n">cf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_CF</span><span class="p">);</span>
	<span class="n">cf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cf</span><span class="p">)</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">));</span>
	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add WPA TLV</span>
<span class="cm"> */</span>
<span class="cp">#define LBS_MAX_WPA_TLV_SIZE			\</span>
<span class="cp">	(sizeof(struct mrvl_ie_header)		\</span>
<span class="cp">	 + 128 </span><span class="cm">/* TODO: I guessed the size */</span><span class="cp">)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_add_wpa_tlv</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ie_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">tlv_len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need just convert an IE to an TLV. IEs use u8 for the header,</span>
<span class="cm">	 *   u8      type</span>
<span class="cm">	 *   u8      len</span>
<span class="cm">	 *   u8[]    data</span>
<span class="cm">	 * but TLVs use __le16 instead:</span>
<span class="cm">	 *   __le16  type</span>
<span class="cm">	 *   __le16  len</span>
<span class="cm">	 *   u8[]    data</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">tlv</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">ie</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tlv</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tlv_len</span> <span class="o">=</span> <span class="o">*</span><span class="n">tlv</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">ie</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tlv</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tlv_len</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">tlv</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">ie</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* the TLV is two bytes larger than the IE */</span>
	<span class="k">return</span> <span class="n">ie_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set Channel</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_cfg_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="n">lbs_deb_enter_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;iface %s freq %d, type %d&quot;</span><span class="p">,</span>
			   <span class="n">netdev_name</span><span class="p">(</span><span class="n">netdev</span><span class="p">),</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">,</span> <span class="n">channel_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel_type</span> <span class="o">!=</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_mesh_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Scanning</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * When scanning, the firmware doesn&#39;t send a nul packet with the power-safe</span>
<span class="cm"> * bit to the AP. So we cannot stay away from our current channel too long,</span>
<span class="cm"> * otherwise we loose data. So take a &quot;nap&quot; while scanning every other</span>
<span class="cm"> * while.</span>
<span class="cm"> */</span>
<span class="cp">#define LBS_SCAN_BEFORE_NAP 4</span>


<span class="cm">/*</span>
<span class="cm"> * When the firmware reports back a scan-result, it gives us an &quot;u8 rssi&quot;,</span>
<span class="cm"> * which isn&#39;t really an RSSI, as it becomes larger when moving away from</span>
<span class="cm"> * the AP. Anyway, we need to convert that into mBm.</span>
<span class="cm"> */</span>
<span class="cp">#define LBS_SCAN_RSSI_TO_MBM(rssi) \</span>
<span class="cp">	((-(int)rssi + 3)*100)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_ret_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cmd_header</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_scan_rsp</span> <span class="o">*</span><span class="n">scanresp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bsssize</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">tsfdesc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tsfsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">bsssize</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scanresp</span><span class="o">-&gt;</span><span class="n">bssdescriptsize</span><span class="p">);</span>

	<span class="n">lbs_deb_scan</span><span class="p">(</span><span class="s">&quot;scan response: %d BSSs (%d bytes); resp size %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">scanresp</span><span class="o">-&gt;</span><span class="n">nr_sets</span><span class="p">,</span> <span class="n">bsssize</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scanresp</span><span class="o">-&gt;</span><span class="n">nr_sets</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The general layout of the scan response is described in chapter</span>
<span class="cm">	 * 5.7.1. Basically we have a common part, then any number of BSS</span>
<span class="cm">	 * descriptor sections. Finally we have section with the same number</span>
<span class="cm">	 * of TSFs.</span>
<span class="cm">	 *</span>
<span class="cm">	 * cmd_ds_802_11_scan_rsp</span>
<span class="cm">	 *   cmd_header</span>
<span class="cm">	 *   pos_size</span>
<span class="cm">	 *   nr_sets</span>
<span class="cm">	 *   bssdesc 1</span>
<span class="cm">	 *     bssid</span>
<span class="cm">	 *     rssi</span>
<span class="cm">	 *     timestamp</span>
<span class="cm">	 *     intvl</span>
<span class="cm">	 *     capa</span>
<span class="cm">	 *     IEs</span>
<span class="cm">	 *   bssdesc 2</span>
<span class="cm">	 *   bssdesc n</span>
<span class="cm">	 *   MrvlIEtypes_TsfFimestamp_t</span>
<span class="cm">	 *     TSF for BSS 1</span>
<span class="cm">	 *     TSF for BSS 2</span>
<span class="cm">	 *     TSF for BSS n</span>
<span class="cm">	 */</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">scanresp</span><span class="o">-&gt;</span><span class="n">bssdesc_and_tlvbuffer</span><span class="p">;</span>

	<span class="n">lbs_deb_hex</span><span class="p">(</span><span class="n">LBS_DEB_SCAN</span><span class="p">,</span> <span class="s">&quot;SCAN_RSP&quot;</span><span class="p">,</span> <span class="n">scanresp</span><span class="o">-&gt;</span><span class="n">bssdesc_and_tlvbuffer</span><span class="p">,</span>
			<span class="n">scanresp</span><span class="o">-&gt;</span><span class="n">bssdescriptsize</span><span class="p">);</span>

	<span class="n">tsfdesc</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="n">bsssize</span><span class="p">;</span>
	<span class="n">tsfsize</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">scanresp</span><span class="o">-&gt;</span><span class="n">nr_sets</span><span class="p">;</span>
	<span class="n">lbs_deb_hex</span><span class="p">(</span><span class="n">LBS_DEB_SCAN</span><span class="p">,</span> <span class="s">&quot;SCAN_TSF&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tsfdesc</span><span class="p">,</span> <span class="n">tsfsize</span><span class="p">);</span>

	<span class="cm">/* Validity check: we expect a Marvell-Local TLV */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tsfdesc</span><span class="p">);</span>
	<span class="n">tsfdesc</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">TLV_TYPE_TSFTIMESTAMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbs_deb_scan</span><span class="p">(</span><span class="s">&quot;scan response: invalid TSF Timestamp %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validity check: the TLV holds TSF values with 8 bytes each, so</span>
<span class="cm">	 * the size in the TLV must match the nr_sets value</span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">tsfdesc</span><span class="p">);</span>
	<span class="n">tsfdesc</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">!=</span> <span class="n">scanresp</span><span class="o">-&gt;</span><span class="n">nr_sets</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbs_deb_scan</span><span class="p">(</span><span class="s">&quot;scan response: invalid number of TSF timestamp &quot;</span>
			     <span class="s">&quot;sets (expected %d got %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scanresp</span><span class="o">-&gt;</span><span class="n">nr_sets</span><span class="p">,</span>
			     <span class="n">i</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scanresp</span><span class="o">-&gt;</span><span class="n">nr_sets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">left</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ielen</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rssi</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">intvl</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">capa</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">chan_no</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid_buf</span><span class="p">);</span>

		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* BSSID */</span>
		<span class="n">bssid</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
		<span class="cm">/* RSSI */</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* Packet time stamp */</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="cm">/* Beacon interval */</span>
		<span class="n">intvl</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* Capabilities */</span>
		<span class="n">capa</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

		<span class="cm">/* To find out the channel, we must parse the IEs */</span>
		<span class="n">ie</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * 6+1+8+2+2: size of BSSID, RSSI, time stamp, beacon</span>
<span class="cm">		 * interval, capabilities</span>
<span class="cm">		 */</span>
		<span class="n">ielen</span> <span class="o">=</span> <span class="n">left</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">elen</span><span class="p">;</span>
			<span class="n">id</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
			<span class="n">elen</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">elen</span> <span class="o">&gt;</span> <span class="n">left</span> <span class="o">||</span> <span class="n">elen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lbs_deb_scan</span><span class="p">(</span><span class="s">&quot;scan response: invalid IE fmt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">WLAN_EID_DS_PARAMS</span><span class="p">)</span>
				<span class="n">chan_no</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">WLAN_EID_SSID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ssid</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
				<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">left</span> <span class="o">-=</span> <span class="n">elen</span><span class="p">;</span>
			<span class="n">pos</span> <span class="o">+=</span> <span class="n">elen</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* No channel, no luck */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_no</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">ieee80211_channel_to_frequency</span><span class="p">(</span><span class="n">chan_no</span><span class="p">,</span>
							<span class="n">IEEE80211_BAND_2GHZ</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span>
				<span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

			<span class="n">lbs_deb_scan</span><span class="p">(</span><span class="s">&quot;scan: %pM, capa %04x, chan %2d, %s, &quot;</span>
				     <span class="s">&quot;%d dBm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">bssid</span><span class="p">,</span> <span class="n">capa</span><span class="p">,</span> <span class="n">chan_no</span><span class="p">,</span>
				     <span class="n">print_ssid</span><span class="p">(</span><span class="n">ssid_buf</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">),</span>
				     <span class="n">LBS_SCAN_RSSI_TO_MBM</span><span class="p">(</span><span class="n">rssi</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_inform_bss</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
					<span class="n">bssid</span><span class="p">,</span> <span class="n">get_unaligned_le64</span><span class="p">(</span><span class="n">tsfdesc</span><span class="p">),</span>
					<span class="n">capa</span><span class="p">,</span> <span class="n">intvl</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ielen</span><span class="p">,</span>
					<span class="n">LBS_SCAN_RSSI_TO_MBM</span><span class="p">(</span><span class="n">rssi</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">lbs_deb_scan</span><span class="p">(</span><span class="s">&quot;scan response: missing BSS channel IE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">tsfdesc</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">done:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_SCAN</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Our scan command contains a TLV, consting of a SSID TLV, a channel list</span>
<span class="cm"> * TLV and a rates TLV. Determine the maximum size of them:</span>
<span class="cm"> */</span>
<span class="cp">#define LBS_SCAN_MAX_CMD_SIZE			\</span>
<span class="cp">	(sizeof(struct cmd_ds_802_11_scan)	\</span>
<span class="cp">	 + LBS_MAX_SSID_TLV_SIZE		\</span>
<span class="cp">	 + LBS_MAX_CHANNEL_LIST_TLV_SIZE	\</span>
<span class="cp">	 + LBS_MAX_RATES_TLV_SIZE)</span>

<span class="cm">/*</span>
<span class="cm"> * Assumes priv-&gt;scan_req is initialized and valid</span>
<span class="cm"> * Assumes priv-&gt;scan_channel is initialized</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbs_scan_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lbs_private</span><span class="p">,</span> <span class="n">scan_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_scan</span> <span class="o">*</span><span class="n">scan_cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tlv</span><span class="p">;</span> <span class="cm">/* pointer into our current, growing TLV storage area */</span>
	<span class="kt">int</span> <span class="n">last_channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">running</span><span class="p">,</span> <span class="n">carrier</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_SCAN</span><span class="p">);</span>

	<span class="n">scan_cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">LBS_SCAN_MAX_CMD_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scan_cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_no_scan_cmd</span><span class="p">;</span>

	<span class="cm">/* prepare fixed part of scan command */</span>
	<span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">bsstype</span> <span class="o">=</span> <span class="n">CMD_BSS_TYPE_ANY</span><span class="p">;</span>

	<span class="cm">/* stop network while we&#39;re away from our main channel */</span>
	<span class="n">running</span> <span class="o">=</span> <span class="o">!</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">carrier</span> <span class="o">=</span> <span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">running</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* prepare fixed part of scan command */</span>
	<span class="n">tlv</span> <span class="o">=</span> <span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">tlvbuffer</span><span class="p">;</span>

	<span class="cm">/* add SSID TLV */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">n_ssids</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tlv</span> <span class="o">+=</span> <span class="n">lbs_add_ssid_tlv</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">);</span>

	<span class="cm">/* add channel TLVs */</span>
	<span class="n">last_channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_channel</span> <span class="o">+</span> <span class="n">LBS_SCAN_BEFORE_NAP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_channel</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">)</span>
		<span class="n">last_channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span>
	<span class="n">tlv</span> <span class="o">+=</span> <span class="n">lbs_add_channel_list_tlv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tlv</span><span class="p">,</span> <span class="n">last_channel</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">);</span>

	<span class="cm">/* add rates TLV */</span>
	<span class="n">tlv</span> <span class="o">+=</span> <span class="n">lbs_add_supported_rates_tlv</span><span class="p">(</span><span class="n">tlv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_channel</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_thread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">300</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* This is the final data we are about to send */</span>
	<span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tlv</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">scan_cmd</span><span class="p">);</span>
	<span class="n">lbs_deb_hex</span><span class="p">(</span><span class="n">LBS_DEB_SCAN</span><span class="p">,</span> <span class="s">&quot;SCAN_CMD&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">scan_cmd</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scan_cmd</span><span class="p">));</span>
	<span class="n">lbs_deb_hex</span><span class="p">(</span><span class="n">LBS_DEB_SCAN</span><span class="p">,</span> <span class="s">&quot;SCAN_TLV&quot;</span><span class="p">,</span> <span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">tlvbuffer</span><span class="p">,</span>
		    <span class="n">tlv</span> <span class="o">-</span> <span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">tlvbuffer</span><span class="p">);</span>

	<span class="n">__lbs_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span><span class="p">),</span>
		<span class="n">lbs_ret_scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_channel</span> <span class="o">&gt;=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mark scan done */</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
		<span class="n">lbs_scan_done</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Restart network */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">carrier</span><span class="p">)</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">running</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending_len</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">scan_cmd</span><span class="p">);</span>

	<span class="cm">/* Wake up anything waiting on scan completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbs_deb_scan</span><span class="p">(</span><span class="s">&quot;scan: waking up waiters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_q</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out_no_scan_cmd:</span>
	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_SCAN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">_internal_start_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">internal</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">lbs_deb_scan</span><span class="p">(</span><span class="s">&quot;scan: ssids %d, channels %d, ie_len %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">request</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">internal_scan</span> <span class="o">=</span> <span class="n">internal</span><span class="p">;</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_thread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">,</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">));</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clean up priv-&gt;scan_req.  Should be used to handle the allocation details.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">lbs_scan_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">internal_scan</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cfg80211_scan_done</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_cfg_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">||</span> <span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* old scan request not yet processed */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_internal_start_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">request</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">surpriseremoved</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>




<span class="cm">/*</span>
<span class="cm"> * Events</span>
<span class="cm"> */</span>

<span class="kt">void</span> <span class="nf">lbs_send_disconnect_notification</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">cfg80211_disconnected</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lbs_send_mic_failureevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">cfg80211_michael_mic_failure</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_bss</span><span class="p">,</span>
		<span class="n">event</span> <span class="o">==</span> <span class="n">MACREG_INT_CODE_MIC_ERR_MULTICAST</span> <span class="o">?</span>
			<span class="n">NL80211_KEYTYPE_GROUP</span> <span class="o">:</span>
			<span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">,</span>
		<span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
<span class="p">}</span>




<span class="cm">/*</span>
<span class="cm"> * Connect/disconnect</span>
<span class="cm"> */</span>


<span class="cm">/*</span>
<span class="cm"> * This removes all WEP keys</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_remove_wep_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_set_wep</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">keyindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_tx_key</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_ACT_REMOVE</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_SET_WEP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set WEP keys</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_set_wep_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_set_wep</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * command         13 00</span>
<span class="cm">	 * size            50 00</span>
<span class="cm">	 * sequence        xx xx</span>
<span class="cm">	 * result          00 00</span>
<span class="cm">	 * action          02 00     ACT_ADD</span>
<span class="cm">	 * transmit key    00 00</span>
<span class="cm">	 * type for key 1  01        WEP40</span>
<span class="cm">	 * type for key 2  00</span>
<span class="cm">	 * type for key 3  00</span>
<span class="cm">	 * type for key 4  00</span>
<span class="cm">	 * key 1           39 39 39 39 39 00 00 00</span>
<span class="cm">	 *                 00 00 00 00 00 00 00 00</span>
<span class="cm">	 * key 2           00 00 00 00 00 00 00 00</span>
<span class="cm">	 *                 00 00 00 00 00 00 00 00</span>
<span class="cm">	 * key 3           00 00 00 00 00 00 00 00</span>
<span class="cm">	 *                 00 00 00 00 00 00 00 00</span>
<span class="cm">	 * key 4           00 00 00 00 00 00 00 00</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* Only set wep keys if we have at least one of them */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">keyindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_tx_key</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_ACT_ADD</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">WLAN_KEY_LEN_WEP40</span>:
				<span class="n">cmd</span><span class="p">.</span><span class="n">keytype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_TYPE_WEP_40_BIT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">WLAN_KEY_LEN_WEP104</span>:
				<span class="n">cmd</span><span class="p">.</span><span class="n">keytype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">CMD_TYPE_WEP_104_BIT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">cmd</span><span class="p">.</span><span class="n">keytype</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">keymaterial</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_SET_WEP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Otherwise remove all wep keys */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_remove_wep_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Enable/Disable RSN status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_enable_rsn</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_enable_rsn</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lbs_deb_enter_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * cmd       2f 00</span>
<span class="cm">	 * size      0c 00</span>
<span class="cm">	 * sequence  xx xx</span>
<span class="cm">	 * result    00 00</span>
<span class="cm">	 * action    01 00    ACT_SET</span>
<span class="cm">	 * enable    01 00</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_ACT_SET</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">enable</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_ENABLE_RSN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Set WPA/WPA key material</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * like &quot;struct cmd_ds_802_11_key_material&quot;, but with cmd_header. Once we</span>
<span class="cm"> * get rid of WEXT, this should go into host.h</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">cmd_key_material</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_header</span> <span class="n">hdr</span><span class="p">;</span>

	<span class="n">__le16</span> <span class="n">action</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">MrvlIEtype_keyParamSet</span> <span class="n">param</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_set_key_material</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">key_type</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">key_info</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u16</span> <span class="n">key_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_key_material</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Example for WPA (TKIP):</span>
<span class="cm">	 *</span>
<span class="cm">	 * cmd       5e 00</span>
<span class="cm">	 * size      34 00</span>
<span class="cm">	 * sequence  xx xx</span>
<span class="cm">	 * result    00 00</span>
<span class="cm">	 * action    01 00</span>
<span class="cm">	 * TLV type  00 01    key param</span>
<span class="cm">	 * length    00 26</span>
<span class="cm">	 * key type  01 00    TKIP</span>
<span class="cm">	 * key info  06 00    UNICAST | ENABLED</span>
<span class="cm">	 * key len   20 00</span>
<span class="cm">	 * key       32 bytes</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_ACT_SET</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TLV_TYPE_KEY_MATERIAL</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">keytypeid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">key_type</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">keyinfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">key_info</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">keylen</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">key_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="n">key_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_KEY_MATERIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Sets the auth type (open, shared, etc) in the firmware. That</span>
<span class="cm"> * we use CMD_802_11_AUTHENTICATE is misleading, this firmware</span>
<span class="cm"> * command doesn&#39;t send an authentication frame at all, it just</span>
<span class="cm"> * stores the auth_type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_set_authtype</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_authenticate</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lbs_deb_enter_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * cmd        11 00</span>
<span class="cm">	 * size       19 00</span>
<span class="cm">	 * sequence   xx xx</span>
<span class="cm">	 * result     00 00</span>
<span class="cm">	 * BSS id     00 13 19 80 da 30</span>
<span class="cm">	 * auth type  00</span>
<span class="cm">	 * reserved   00 00 00 00 00 00 00 00 00 00</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="cm">/* convert auth_type */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_auth_to_authtype</span><span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">authtype</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_AUTHENTICATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

 <span class="nl">done:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Create association request</span>
<span class="cm"> */</span>
<span class="cp">#define LBS_ASSOC_MAX_CMD_SIZE                     \</span>
<span class="cp">	(sizeof(struct cmd_ds_802_11_associate)    \</span>
<span class="cp">	 - 512 </span><span class="cm">/* cmd_ds_802_11_associate.iebuf */</span><span class="cp"> \</span>
<span class="cp">	 + LBS_MAX_SSID_TLV_SIZE                   \</span>
<span class="cp">	 + LBS_MAX_CHANNEL_TLV_SIZE                \</span>
<span class="cp">	 + LBS_MAX_CF_PARAM_TLV_SIZE               \</span>
<span class="cp">	 + LBS_MAX_AUTH_TYPE_TLV_SIZE              \</span>
<span class="cp">	 + LBS_MAX_WPA_TLV_SIZE)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_associate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_associate_response</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_associate</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">LBS_ASSOC_MAX_CMD_SIZE</span><span class="p">,</span>
						      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ssid_eid</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">resp_ie_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">iebuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * cmd              50 00</span>
<span class="cm">	 * length           34 00</span>
<span class="cm">	 * sequence         xx xx</span>
<span class="cm">	 * result           00 00</span>
<span class="cm">	 * BSS id           00 13 19 80 da 30</span>
<span class="cm">	 * capabilities     11 00</span>
<span class="cm">	 * listen interval  0a 00</span>
<span class="cm">	 * beacon interval  00 00</span>
<span class="cm">	 * DTIM period      00</span>
<span class="cm">	 * TLVs             xx   (up to 512 bytes)</span>
<span class="cm">	 */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_802_11_ASSOCIATE</span><span class="p">);</span>

	<span class="cm">/* Fill in static fields */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">listeninterval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MRVDRV_DEFAULT_LISTEN_INTERVAL</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>

	<span class="cm">/* add SSID TLV */</span>
	<span class="n">ssid_eid</span> <span class="o">=</span> <span class="n">ieee80211_bss_get_ie</span><span class="p">(</span><span class="n">bss</span><span class="p">,</span> <span class="n">WLAN_EID_SSID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssid_eid</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">lbs_add_ssid_tlv</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">ssid_eid</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ssid_eid</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;no SSID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* add DS param TLV */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">lbs_add_channel_tlv</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;no channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* add (empty) CF param TLV */</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">lbs_add_cf_param_tlv</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>

	<span class="cm">/* add rates TLV */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* skip Marvell IE header */</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="n">lbs_add_common_rates_tlv</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">bss</span><span class="p">);</span>
	<span class="n">lbs_deb_hex</span><span class="p">(</span><span class="n">LBS_DEB_ASSOC</span><span class="p">,</span> <span class="s">&quot;Common Rates&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="cm">/* add auth type TLV */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MRVL_FW_MAJOR_REV</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">lbs_add_auth_type_tlv</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">);</span>

	<span class="cm">/* add WPA/WPA2 TLV */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">&amp;&amp;</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">lbs_add_wpa_tlv</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">iebuf</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">pos</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">iebuf</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="n">lbs_deb_hex</span><span class="p">(</span><span class="n">LBS_DEB_ASSOC</span><span class="p">,</span> <span class="s">&quot;ASSOC_CMD&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span><span class="p">));</span>

	<span class="cm">/* store for later use */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_bss</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_ASSOCIATE</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* generate connect message to cfg80211 */</span>

	<span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">;</span> <span class="cm">/* recast for easier field access */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">statuscode</span><span class="p">);</span>

	<span class="cm">/* Older FW versions map the IEEE 802.11 Status Code in the association</span>
<span class="cm">	 * response to the following values returned in resp-&gt;statuscode:</span>
<span class="cm">	 *</span>
<span class="cm">	 *    IEEE Status Code                Marvell Status Code</span>
<span class="cm">	 *    0                       -&gt;      0x0000 ASSOC_RESULT_SUCCESS</span>
<span class="cm">	 *    13                      -&gt;      0x0004 ASSOC_RESULT_AUTH_REFUSED</span>
<span class="cm">	 *    14                      -&gt;      0x0004 ASSOC_RESULT_AUTH_REFUSED</span>
<span class="cm">	 *    15                      -&gt;      0x0004 ASSOC_RESULT_AUTH_REFUSED</span>
<span class="cm">	 *    16                      -&gt;      0x0004 ASSOC_RESULT_AUTH_REFUSED</span>
<span class="cm">	 *    others                  -&gt;      0x0003 ASSOC_RESULT_REFUSED</span>
<span class="cm">	 *</span>
<span class="cm">	 * Other response codes:</span>
<span class="cm">	 *    0x0001 -&gt; ASSOC_RESULT_INVALID_PARAMETERS (unused)</span>
<span class="cm">	 *    0x0002 -&gt; ASSOC_RESULT_TIMEOUT (internal timer expired waiting for</span>
<span class="cm">	 *                                    association response from the AP)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MRVL_FW_MAJOR_REV</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;invalid association parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">WLAN_STATUS_CAPS_UNSUPPORTED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;timer expired while waiting for AP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">WLAN_STATUS_AUTH_TIMEOUT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;association refused by AP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">WLAN_STATUS_ASSOC_DENIED_UNSPEC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;authentication refused by AP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">WLAN_STATUS_UNKNOWN_AUTH_TRANSACTION</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;association failure %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="cm">/* v5 OLPC firmware does return the AP status code if</span>
<span class="cm">			 * it&#39;s not one of the values above.  Let that through.</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;status %d, statuscode 0x%04x, capability 0x%04x, &quot;</span>
		      <span class="s">&quot;aid 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">statuscode</span><span class="p">),</span>
		      <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">));</span>

	<span class="n">resp_ie_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">)</span>
		<span class="o">-</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">cfg80211_connect_result</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_bss</span><span class="p">,</span>
				<span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">,</span>
				<span class="n">resp</span><span class="o">-&gt;</span><span class="n">iebuf</span><span class="p">,</span> <span class="n">resp_ie_len</span><span class="p">,</span>
				<span class="n">status</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: get rid of priv-&gt;connect_status */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_status</span> <span class="o">=</span> <span class="n">LBS_CONNECTED</span><span class="p">;</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending_len</span><span class="p">)</span>
			<span class="n">netif_tx_wake_all_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span>
<span class="nf">_new_connect_scan_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">creq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n_channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>
			<span class="n">n_channels</span> <span class="o">+=</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">creq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">creq</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cfg80211_ssid</span><span class="p">)</span> <span class="o">+</span>
		       <span class="n">n_channels</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
		       <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">creq</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* SSIDs come after channels */</span>
	<span class="n">creq</span><span class="o">-&gt;</span><span class="n">ssids</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">n_channels</span><span class="p">];</span>
	<span class="n">creq</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">n_channels</span><span class="p">;</span>
	<span class="n">creq</span><span class="o">-&gt;</span><span class="n">n_ssids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Scan all available channels */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">band</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">band</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">;</span> <span class="n">band</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* ignore disabled channels */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span>
						<span class="n">IEEE80211_CHAN_DISABLED</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">creq</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set real number of channels specified in creq-&gt;channels[] */</span>
		<span class="n">creq</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Scan for the SSID we&#39;re going to connect to */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">creq</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">creq</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No channels found... */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">creq</span><span class="p">);</span>
		<span class="n">creq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">creq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_cfg_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">preamble</span> <span class="o">=</span> <span class="n">RADIO_PREAMBLE_SHORT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">creq</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Scan for the requested network after waiting for existing</span>
<span class="cm">		 * scans to finish.</span>
<span class="cm">		 */</span>
		<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;assoc: waiting for existing scans</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_q</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">),</span>
						 <span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>

		<span class="n">creq</span> <span class="o">=</span> <span class="n">_new_connect_scan_req</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">sme</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">creq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;assoc: scanning for compatible AP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">_internal_start_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">creq</span><span class="p">);</span>

		<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;assoc: waiting for scan to complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_q</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">),</span>
						 <span class="p">(</span><span class="mi">15</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
		<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;assoc: scanning competed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Find the BSS we want using available scan results */</span>
	<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_get_bss</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
		<span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span>
		<span class="n">WLAN_CAPABILITY_ESS</span><span class="p">,</span> <span class="n">WLAN_CAPABILITY_ESS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;assoc: bss %pM not in scan results</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;trying %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
	<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;cipher 0x%x, key index %d, key len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">,</span>
		      <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>

	<span class="cm">/* As this is a new connection, clear locally stored WEP keys */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_tx_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">));</span>

	<span class="cm">/* set/remove WEP keys */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="cm">/* Store provided WEP keys in priv-&gt; */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_tx_key</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">],</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="cm">/* Set WEP keys and WEP mode */</span>
		<span class="n">lbs_set_wep_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">|=</span> <span class="n">CMD_ACT_MAC_WEP_ENABLE</span><span class="p">;</span>
		<span class="n">lbs_set_mac_control</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="cm">/* No RSN mode for WEP */</span>
		<span class="n">lbs_enable_rsn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* there&#39;s no WLAN_CIPHER_SUITE_NONE definition */</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we don&#39;t have no WEP, no WPA and no WPA2,</span>
<span class="cm">		 * we remove all keys like in the WPA/WPA2 setup,</span>
<span class="cm">		 * we just don&#39;t set RSN.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Therefore: fall-through</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="cm">/* Remove WEP keys and WEP mode */</span>
		<span class="n">lbs_remove_wep_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMD_ACT_MAC_WEP_ENABLE</span><span class="p">;</span>
		<span class="n">lbs_set_mac_control</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="cm">/* clear the WPA/WPA2 keys */</span>
		<span class="n">lbs_set_key_material</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="n">KEY_TYPE_ID_WEP</span><span class="p">,</span> <span class="cm">/* doesn&#39;t matter */</span>
			<span class="n">KEY_INFO_WPA_UNICAST</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">lbs_set_key_material</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			<span class="n">KEY_TYPE_ID_WEP</span><span class="p">,</span> <span class="cm">/* doesn&#39;t matter */</span>
			<span class="n">KEY_INFO_WPA_MCAST</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* RSN mode for WPA/WPA2 */</span>
		<span class="n">lbs_enable_rsn</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;unsupported cipher group 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_authtype</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sme</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;unsupported authtype 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lbs_set_radio</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">preamble</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Do the actual association */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_associate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss</span><span class="p">,</span> <span class="n">sme</span><span class="p">);</span>

 <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="p">)</span>
		<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbs_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_deauthenticate</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="cm">/* Mildly ugly to use a locally store my own BSSID ... */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">assoc_bss</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reasoncode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">reason</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_DEAUTHENTICATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cfg80211_disconnected</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">reason</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_status</span> <span class="o">=</span> <span class="n">LBS_DISCONNECTED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_cfg_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="n">u16</span> <span class="n">reason_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">lbs_deb_enter_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;reason_code %d&quot;</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">);</span>

	<span class="cm">/* store for lbs_cfg_ret_disconnect() */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">disassoc_reason</span> <span class="o">=</span> <span class="n">reason_code</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">lbs_disconnect</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_cfg_set_default_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">unicast</span><span class="p">,</span>
				   <span class="n">bool</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_tx_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;set_default_key: to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_tx_key</span> <span class="o">=</span> <span class="n">key_index</span><span class="p">;</span>
		<span class="n">lbs_set_wep_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_cfg_add_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">idx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">key_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">key_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">key_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netdev</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;add_key: cipher 0x%x, mac_addr %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
	<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;add_key: key index %d, key len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">idx</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">)</span>
		<span class="n">lbs_deb_hex</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;KEY&quot;</span><span class="p">,</span>
			    <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>

	<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;add_key: seq len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">)</span>
		<span class="n">lbs_deb_hex</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;SEQ&quot;</span><span class="p">,</span>
			    <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="cm">/* actually compare if something has changed ... */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">memcmp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
			       <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
			       <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
			<span class="n">lbs_set_wep_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">key_info</span> <span class="o">=</span> <span class="n">KEY_INFO_WPA_ENABLED</span> <span class="o">|</span> <span class="p">((</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						   <span class="o">?</span> <span class="n">KEY_INFO_WPA_UNICAST</span>
						   <span class="o">:</span> <span class="n">KEY_INFO_WPA_MCAST</span><span class="p">);</span>
		<span class="n">key_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">KEY_TYPE_ID_TKIP</span>
			<span class="o">:</span> <span class="n">KEY_TYPE_ID_AES</span><span class="p">;</span>
		<span class="n">lbs_set_key_material</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				     <span class="n">key_type</span><span class="p">,</span>
				     <span class="n">key_info</span><span class="p">,</span>
				     <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;unhandled cipher 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_cfg_del_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">lbs_deb_assoc</span><span class="p">(</span><span class="s">&quot;del_key: key_idx %d, mac_addr %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">key_index</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>

<span class="cp">#ifdef TODO</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * I think can keep this a NO-OP, because:</span>

<span class="cm">	 * - we clear all keys whenever we do lbs_cfg_connect() anyway</span>
<span class="cm">	 * - neither &quot;iw&quot; nor &quot;wpa_supplicant&quot; won&#39;t call this during</span>
<span class="cm">	 *   an ongoing connection</span>
<span class="cm">	 * - TODO: but I have to check if this is still true when</span>
<span class="cm">	 *   I set the AP to periodic re-keying</span>
<span class="cm">	 * - we&#39;ve not kzallec() something when we&#39;ve added a key at</span>
<span class="cm">	 *   lbs_cfg_connect() or lbs_cfg_add_key().</span>
<span class="cm">	 *</span>
<span class="cm">	 * This causes lbs_cfg_del_key() only called at disconnect time,</span>
<span class="cm">	 * where we&#39;d just waste time deleting a key that is not going</span>
<span class="cm">	 * to be used anyway.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">key_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">key_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lbs_set_wep_keys</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Get station</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_cfg_get_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">s8</span> <span class="n">signal</span><span class="p">,</span> <span class="n">noise</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_TX_BYTES</span> <span class="o">|</span>
			 <span class="n">STATION_INFO_TX_PACKETS</span> <span class="o">|</span>
			 <span class="n">STATION_INFO_RX_BYTES</span> <span class="o">|</span>
			 <span class="n">STATION_INFO_RX_PACKETS</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">;</span>

	<span class="cm">/* Get current RSSI */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_get_rssi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">signal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">noise</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_SIGNAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Convert priv-&gt;cur_rate from hw_value to NL80211 value */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lbs_rates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_rate</span> <span class="o">==</span> <span class="n">lbs_rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="n">lbs_rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span><span class="p">;</span>
			<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_TX_BITRATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>




<span class="cm">/*</span>
<span class="cm"> * Change interface</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_change_intf</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">vif_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iface_running</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_iface_type</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">iftype</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * IBSS (Ad-Hoc)</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The firmware needs the following bits masked out of the beacon-derived</span>
<span class="cm"> * capability field when associating/joining to a BSS:</span>
<span class="cm"> *  9 (QoS), 11 (APSD), 12 (unused), 14 (unused), 15 (unused)</span>
<span class="cm"> */</span>
<span class="cp">#define CAPINFO_MASK (~(0xda00))</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbs_join_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cfg80211_ibss_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">capability</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">fake_ie</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">IEEE80211_MAX_SSID_LEN</span> <span class="o">+</span> <span class="cm">/* ssid */</span>
		   <span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span>                      <span class="cm">/* basic rates */</span>
		   <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span>                      <span class="cm">/* DS parameter */</span>
		   <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span>                      <span class="cm">/* atim */</span>
		   <span class="mi">2</span> <span class="o">+</span> <span class="mi">8</span><span class="p">];</span>                      <span class="cm">/* extended rates */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fake</span> <span class="o">=</span> <span class="n">fake_ie</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For cfg80211_inform_bss, we&#39;ll need a fake IE, as we can&#39;t get</span>
<span class="cm">	 * the real IE from the firmware. So we fabricate a fake IE based on</span>
<span class="cm">	 * what the firmware actually sends (sniffed with wireshark).</span>
<span class="cm">	 */</span>
	<span class="cm">/* Fake SSID IE */</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">fake</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">fake</span> <span class="o">+=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="cm">/* Fake supported basic rates IE */</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x8b</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x96</span><span class="p">;</span>
	<span class="cm">/* Fake DS channel IE */</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_DS_PARAMS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="cm">/* Fake IBSS params IE */</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_IBSS_PARAMS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* ATIM=0 */</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Fake extended rates IE, TODO: don&#39;t add this for 802.11b only,</span>
<span class="cm">	 * but I don&#39;t know how this could be checked */</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_EXT_SUPP_RATES</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x24</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fake</span><span class="o">++</span> <span class="o">=</span> <span class="mh">0x6c</span><span class="p">;</span>
	<span class="n">lbs_deb_hex</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;IE&quot;</span><span class="p">,</span> <span class="n">fake_ie</span><span class="p">,</span> <span class="n">fake</span> <span class="o">-</span> <span class="n">fake_ie</span><span class="p">);</span>

	<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_inform_bss</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				  <span class="n">bssid</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">,</span>
				  <span class="n">capability</span><span class="p">,</span>
				  <span class="n">params</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">,</span>
				  <span class="n">fake_ie</span><span class="p">,</span> <span class="n">fake</span> <span class="o">-</span> <span class="n">fake_ie</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>

	<span class="n">cfg80211_ibss_joined</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="cm">/* TODO: consider doing this at MACREG_INT_CODE_LINK_SENSED time */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_status</span> <span class="o">=</span> <span class="n">LBS_CONNECTED</span><span class="p">;</span>
	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending_len</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_ibss_join_existing</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cfg80211_ibss_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rates_eid</span> <span class="o">=</span> <span class="n">ieee80211_bss_get_ie</span><span class="p">(</span><span class="n">bss</span><span class="p">,</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_ad_hoc_join</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">preamble</span> <span class="o">=</span> <span class="n">RADIO_PREAMBLE_SHORT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="cm">/* TODO: set preamble based on scan result */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_radio</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">preamble</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Example CMD_802_11_AD_HOC_JOIN command:</span>
<span class="cm">	 *</span>
<span class="cm">	 * command         2c 00         CMD_802_11_AD_HOC_JOIN</span>
<span class="cm">	 * size            65 00</span>
<span class="cm">	 * sequence        xx xx</span>
<span class="cm">	 * result          00 00</span>
<span class="cm">	 * bssid           02 27 27 97 2f 96</span>
<span class="cm">	 * ssid            49 42 53 53 00 00 00 00</span>
<span class="cm">	 *                 00 00 00 00 00 00 00 00</span>
<span class="cm">	 *                 00 00 00 00 00 00 00 00</span>
<span class="cm">	 *                 00 00 00 00 00 00 00 00</span>
<span class="cm">	 * type            02            CMD_BSS_TYPE_IBSS</span>
<span class="cm">	 * beacon period   64 00</span>
<span class="cm">	 * dtim period     00</span>
<span class="cm">	 * timestamp       00 00 00 00 00 00 00 00</span>
<span class="cm">	 * localtime       00 00 00 00 00 00 00 00</span>
<span class="cm">	 * IE DS           03</span>
<span class="cm">	 * IE DS len       01</span>
<span class="cm">	 * IE DS channel   01</span>
<span class="cm">	 * reserveed       00 00 00 00</span>
<span class="cm">	 * IE IBSS         06</span>
<span class="cm">	 * IE IBSS len     02</span>
<span class="cm">	 * IE IBSS atim    00 00</span>
<span class="cm">	 * reserved        00 00 00 00</span>
<span class="cm">	 * capability      02 00</span>
<span class="cm">	 * rates           82 84 8b 96 0c 12 18 24 30 48 60 6c 00</span>
<span class="cm">	 * fail timeout    ff 00</span>
<span class="cm">	 * probe delay     00 00</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">CMD_BSS_TYPE_IBSS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">beaconperiod</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">ds</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">WLAN_EID_DS_PARAMS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">ds</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">ds</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">ibss</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">WLAN_EID_IBSS_PARAMS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">ibss</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">ibss</span><span class="p">.</span><span class="n">atimwindow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">CAPINFO_MASK</span><span class="p">);</span>

	<span class="cm">/* set rates to the intersection of our rates and the rates in the</span>
<span class="cm">	   bss */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rates_eid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbs_add_rates</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">rates</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">rates_max</span> <span class="o">=</span> <span class="n">rates_eid</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">rates</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">bss</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">hw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">hw</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lbs_rates</span><span class="p">);</span> <span class="n">hw</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">hw_rate</span> <span class="o">=</span> <span class="n">lbs_rates</span><span class="p">[</span><span class="n">hw</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rates_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hw_rate</span> <span class="o">==</span> <span class="p">(</span><span class="n">rates_eid</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">u8</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">rates_eid</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">];</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mh">0x02</span> <span class="o">||</span> <span class="n">rate</span> <span class="o">==</span> <span class="mh">0x04</span> <span class="o">||</span>
					    <span class="n">rate</span> <span class="o">==</span> <span class="mh">0x0b</span> <span class="o">||</span> <span class="n">rate</span> <span class="o">==</span> <span class="mh">0x16</span><span class="p">)</span>
						<span class="n">rate</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
					<span class="o">*</span><span class="n">rates</span><span class="o">++</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Only v8 and below support setting this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MRVL_FW_MAJOR_REV</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">failtimeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MRVDRV_ASSOCIATION_TIME_OUT</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">probedelay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_SCAN_PROBE_DELAY_TIME</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_AD_HOC_JOIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is a sample response to CMD_802_11_AD_HOC_JOIN:</span>
<span class="cm">	 *</span>
<span class="cm">	 * response        2c 80</span>
<span class="cm">	 * size            09 00</span>
<span class="cm">	 * sequence        xx xx</span>
<span class="cm">	 * result          00 00</span>
<span class="cm">	 * reserved        00</span>
<span class="cm">	 */</span>
	<span class="n">lbs_join_post</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_ibss_start_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cfg80211_ibss_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_ad_hoc_start</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_ad_hoc_result</span> <span class="o">*</span><span class="n">resp</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">cmd_ds_802_11_ad_hoc_result</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">preamble</span> <span class="o">=</span> <span class="n">RADIO_PREAMBLE_SHORT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">capability</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_radio</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">preamble</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Example CMD_802_11_AD_HOC_START command:</span>
<span class="cm">	 *</span>
<span class="cm">	 * command         2b 00         CMD_802_11_AD_HOC_START</span>
<span class="cm">	 * size            b1 00</span>
<span class="cm">	 * sequence        xx xx</span>
<span class="cm">	 * result          00 00</span>
<span class="cm">	 * ssid            54 45 53 54 00 00 00 00</span>
<span class="cm">	 *                 00 00 00 00 00 00 00 00</span>
<span class="cm">	 *                 00 00 00 00 00 00 00 00</span>
<span class="cm">	 *                 00 00 00 00 00 00 00 00</span>
<span class="cm">	 * bss type        02</span>
<span class="cm">	 * beacon period   64 00</span>
<span class="cm">	 * dtim period     00</span>
<span class="cm">	 * IE IBSS         06</span>
<span class="cm">	 * IE IBSS len     02</span>
<span class="cm">	 * IE IBSS atim    00 00</span>
<span class="cm">	 * reserved        00 00 00 00</span>
<span class="cm">	 * IE DS           03</span>
<span class="cm">	 * IE DS len       01</span>
<span class="cm">	 * IE DS channel   01</span>
<span class="cm">	 * reserved        00 00 00 00</span>
<span class="cm">	 * probe delay     00 00</span>
<span class="cm">	 * capability      02 00</span>
<span class="cm">	 * rates           82 84 8b 96   (basic rates with have bit 7 set)</span>
<span class="cm">	 *                 0c 12 18 24 30 48 60 6c</span>
<span class="cm">	 * padding         100 bytes</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">bsstype</span> <span class="o">=</span> <span class="n">CMD_BSS_TYPE_IBSS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">beaconperiod</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">ibss</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">WLAN_EID_IBSS_PARAMS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">ibss</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">ibss</span><span class="p">.</span><span class="n">atimwindow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">ds</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">WLAN_EID_DS_PARAMS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">ds</span><span class="p">.</span><span class="n">header</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">ds</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="cm">/* Only v8 and below support setting probe delay */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">MRVL_FW_MAJOR_REV</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">probedelay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_SCAN_PROBE_DELAY_TIME</span><span class="p">);</span>
	<span class="cm">/* TODO: mix in WLAN_CAPABILITY_PRIVACY */</span>
	<span class="n">capability</span> <span class="o">=</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">capability</span><span class="p">);</span>
	<span class="n">lbs_add_rates</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">rates</span><span class="p">);</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_AD_HOC_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is a sample response to CMD_802_11_AD_HOC_JOIN:</span>
<span class="cm">	 *</span>
<span class="cm">	 * response        2b 80</span>
<span class="cm">	 * size            14 00</span>
<span class="cm">	 * sequence        xx xx</span>
<span class="cm">	 * result          00 00</span>
<span class="cm">	 * reserved        00</span>
<span class="cm">	 * bssid           02 2b 7b 0f 86 0e</span>
<span class="cm">	 */</span>
	<span class="n">lbs_join_post</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">resp</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">capability</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_join_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">cfg80211_ibss_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
	<span class="n">DECLARE_SSID_BUF</span><span class="p">(</span><span class="n">ssid_buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Search if someone is beaconing. This assumes that the</span>
<span class="cm">	 * bss list is populated already */</span>
	<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_get_bss</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">,</span>
		<span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">,</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_ibss_join_existing</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">bss</span><span class="p">);</span>
		<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_ibss_start_new</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">params</span><span class="p">);</span>


 <span class="nl">out:</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbs_leave_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_ad_hoc_stop</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mesh_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_AD_HOC_STOP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* TODO: consider doing this at MACREG_INT_CODE_ADHOC_BCN_LOST time */</span>
	<span class="n">lbs_mac_event_disconnected</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>




<span class="cm">/*</span>
<span class="cm"> * Initialization</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cfg80211_ops</span> <span class="n">lbs_cfg80211_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_channel</span> <span class="o">=</span> <span class="n">lbs_cfg_set_channel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">lbs_cfg_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span> <span class="o">=</span> <span class="n">lbs_cfg_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">lbs_cfg_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_key</span> <span class="o">=</span> <span class="n">lbs_cfg_add_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_key</span> <span class="o">=</span> <span class="n">lbs_cfg_del_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_default_key</span> <span class="o">=</span> <span class="n">lbs_cfg_set_default_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_station</span> <span class="o">=</span> <span class="n">lbs_cfg_get_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_virtual_intf</span> <span class="o">=</span> <span class="n">lbs_change_intf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">join_ibss</span> <span class="o">=</span> <span class="n">lbs_join_ibss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">leave_ibss</span> <span class="o">=</span> <span class="n">lbs_leave_ibss</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * At this time lbs_private *priv doesn&#39;t even exist, so we just allocate</span>
<span class="cm"> * memory and don&#39;t initialize the wiphy further. This is postponed until we</span>
<span class="cm"> * can talk to the firmware and happens at registration time in</span>
<span class="cm"> * lbs_cfg_wiphy_register().</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="nf">lbs_cfg_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">wdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wireless_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot allocate wireless device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wiphy_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lbs_cfg80211_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot allocate wiphy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_wiphy_new</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wdev</span><span class="p">;</span>

 <span class="nl">err_wiphy_new:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbs_cfg_set_regulatory_hint</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">region_code_mapping</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cn</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">code</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="cm">/* Section 5.17.2 */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">region_code_mapping</span> <span class="n">regmap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span><span class="s">&quot;US &quot;</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">},</span> <span class="cm">/* US FCC */</span>
		<span class="p">{</span><span class="s">&quot;CA &quot;</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">},</span> <span class="cm">/* Canada */</span>
		<span class="p">{</span><span class="s">&quot;EU &quot;</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">},</span> <span class="cm">/* ETSI   */</span>
		<span class="p">{</span><span class="s">&quot;ES &quot;</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">},</span> <span class="cm">/* Spain  */</span>
		<span class="p">{</span><span class="s">&quot;FR &quot;</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">},</span> <span class="cm">/* France */</span>
		<span class="p">{</span><span class="s">&quot;JP &quot;</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">},</span> <span class="cm">/* Japan  */</span>
	<span class="p">};</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">regmap</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regmap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regioncode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">regulatory_hint</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">regmap</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cn</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This function get&#39;s called after lbs_setup_firmware() determined the</span>
<span class="cm"> * firmware capabities. So we can setup the wiphy according to our</span>
<span class="cm"> * hardware/firmware.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">lbs_cfg_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ssids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">signal_type</span> <span class="o">=</span> <span class="n">CFG80211_SIGNAL_TYPE_MBM</span><span class="p">;</span>

	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span>
			<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lbs_rtap_supported</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lbs_mesh_activated</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">);</span>

	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lbs_band_2ghz</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We could check priv-&gt;fwcapinfo &amp;&amp; FW_CAPINFO_WPA, but I have</span>
<span class="cm">	 * never seen a firmware without WPA</span>
<span class="cm">	 */</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">cipher_suites</span> <span class="o">=</span> <span class="n">cipher_suites</span><span class="p">;</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_cipher_suites</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cipher_suites</span><span class="p">);</span>
	<span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">reg_notifier</span> <span class="o">=</span> <span class="n">lbs_reg_notifier</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wiphy_register</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot register wiphy device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wiphy_registered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot register network device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">,</span> <span class="n">lbs_scan_worker</span><span class="p">);</span>

	<span class="n">lbs_cfg_set_regulatory_hint</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">lbs_deb_leave_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbs_reg_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">regulatory_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lbs_deb_enter_args</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">,</span> <span class="s">&quot;cfg80211 regulatory domain &quot;</span>
			<span class="s">&quot;callback for domain %c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbs_set_11d_domain_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">);</span>

	<span class="n">lbs_deb_leave</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lbs_scan_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">lbs_cfg_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbs_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="o">*</span><span class="n">wdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">;</span>

	<span class="n">lbs_deb_enter</span><span class="p">(</span><span class="n">LBS_DEB_CFG80211</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wiphy_registered</span><span class="p">)</span>
		<span class="n">wiphy_unregister</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span>
		<span class="n">wiphy_free</span><span class="p">(</span><span class="n">wdev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wdev</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
