<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › carl9170 › tx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>tx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Atheros CARL9170 driver</span>
<span class="cm"> *</span>
<span class="cm"> * 802.11 xmit &amp; status routines</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2008, Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> * Copyright 2009, 2010, Christian Lamparter &lt;chunkeey@googlemail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; see the file COPYING.  If not, see</span>
<span class="cm"> * http://www.gnu.org/licenses/.</span>
<span class="cm"> *</span>
<span class="cm"> * This file incorporates work covered by the following copyright and</span>
<span class="cm"> * permission notice:</span>
<span class="cm"> *    Copyright (c) 2007-2008 Atheros Communications, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *    Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> *    purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> *    copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> *    THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> *    WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> *    MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> *    ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> *    WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> *    ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> *    OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &quot;carl9170.h&quot;</span>
<span class="cp">#include &quot;hw.h&quot;</span>
<span class="cp">#include &quot;cmd.h&quot;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">__carl9170_get_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">modparam_noht</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">queue</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is just another workaround, until</span>
<span class="cm">		 * someone figures out how to get QoS and</span>
<span class="cm">		 * AMPDU to play nicely together.</span>
<span class="cm">		 */</span>

		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* AC_BE */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">carl9170_get_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__carl9170_get_queue</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_mem_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">IEEE80211_MAX_FRAME_LEN</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">mem_block_size</span><span class="p">)</span> <span class="o">&gt;</span>
		<span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_free_blocks</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_tx_accounting</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">queue</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mem_full</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_total_queued</span><span class="p">);</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_stats_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The driver has to accept the frame, regardless if the queue is</span>
<span class="cm">	 * full to the brim, or not. We have to do the queuing internally,</span>
<span class="cm">	 * since mac80211 assumes that a driver which can operate with</span>
<span class="cm">	 * aggregated frames does not reject frames for this reason.</span>
<span class="cm">	 */</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">mem_full</span> <span class="o">=</span> <span class="n">is_mem_full</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem_full</span> <span class="o">||</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee80211_stop_queue</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">queue_stop_timeout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_stats_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* needs rcu_read_lock */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="nf">__carl9170_get_tx_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
						   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">super</span><span class="o">-&gt;</span><span class="n">frame_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vif_id</span><span class="p">;</span>

	<span class="n">vif_id</span> <span class="o">=</span> <span class="p">(</span><span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">CARL9170_TX_SUPER_MISC_VIF_ID</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		 <span class="n">CARL9170_TX_SUPER_MISC_VIF_ID_S</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">vif_id</span> <span class="o">&gt;=</span> <span class="n">AR9170_MAX_VIRTUAL_MAC</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_priv</span><span class="p">[</span><span class="n">vif_id</span><span class="p">].</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Normally we should use wrappers like ieee80211_get_DA to get</span>
<span class="cm">	 * the correct peer ieee80211_sta.</span>
<span class="cm">	 *</span>
<span class="cm">	 * But there is a problem with indirect traffic (broadcasts, or</span>
<span class="cm">	 * data which is designated for other stations) in station mode.</span>
<span class="cm">	 * The frame will be directed to the AP for distribution and not</span>
<span class="cm">	 * to the actual destination.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">ieee80211_find_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_tx_ps_unblock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_sta_info</span> <span class="o">*</span><span class="n">sta_info</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">__carl9170_get_tx_sta</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_rcu</span><span class="p">;</span>

	<span class="n">sta_info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">carl9170_sta_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">pending_frames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ieee80211_sta_block_awake</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

<span class="nl">out_rcu:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_tx_accounting_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">queue</span><span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_stats_lock</span><span class="p">);</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_mem_full</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">CARL9170_NUM_TX_LIMIT_SOFT</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_queue_stopped</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>

				<span class="n">tmp</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">queue_stop_timeout</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">max_queue_stop_timeout</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="n">ar</span><span class="o">-&gt;</span><span class="n">max_queue_stop_timeout</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ieee80211_wake_queue</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_stats_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_total_queued</span><span class="p">))</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_flush</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_alloc_dev_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cookie</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_allocs</span><span class="p">);</span>

	<span class="n">chunks</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">mem_block_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_sub_return</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_free_blocks</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_free_blocks</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_lock</span><span class="p">);</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">bitmap_find_free_region</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_bitmap</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">mem_blocks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cookie</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_add</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_free_blocks</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cookie #0 serves two special purposes:</span>
<span class="cm">	 *  1. The firmware might use it generate BlockACK frames</span>
<span class="cm">	 *     in responds of an incoming BlockAckReqs.</span>
<span class="cm">	 *</span>
<span class="cm">	 *  2. Prevent double-free bugs.</span>
<span class="cm">	 */</span>
	<span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">cookie</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_release_dev_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cookie</span><span class="p">;</span>

	<span class="cm">/* make a local copy of the cookie */</span>
	<span class="n">cookie</span> <span class="o">=</span> <span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">cookie</span><span class="p">;</span>
	<span class="cm">/* invalidate cookie */</span>
	<span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do a out-of-bounds check on the cookie:</span>
<span class="cm">	 *</span>
<span class="cm">	 *  * cookie &quot;0&quot; is reserved and won&#39;t be assigned to any</span>
<span class="cm">	 *    out-going frame. Internally however, it is used to</span>
<span class="cm">	 *    mark no longer/un-accounted frames and serves as a</span>
<span class="cm">	 *    cheap way of preventing frames from being freed</span>
<span class="cm">	 *    twice by _accident_. NB: There is a tiny race...</span>
<span class="cm">	 *</span>
<span class="cm">	 *  * obviously, cookie number is limited by the amount</span>
<span class="cm">	 *    of available memory blocks, so the number can</span>
<span class="cm">	 *    never execeed the mem_blocks count.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">cookie</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">cookie</span> <span class="o">&gt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">mem_blocks</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">atomic_add</span><span class="p">(</span><span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">mem_block_size</span><span class="p">),</span>
		   <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_free_blocks</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_lock</span><span class="p">);</span>
	<span class="n">bitmap_release_region</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_bitmap</span><span class="p">,</span> <span class="n">cookie</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mem_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called from any context */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_tx_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_tx_info</span> <span class="o">*</span><span class="n">arinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">arinfo</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">carl9170_tx_info</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
	<span class="n">txinfo</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">arinfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_tx_info</span><span class="p">,</span>
			      <span class="n">rate_driver_data</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">txinfo</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>

	<span class="n">ar</span> <span class="o">=</span> <span class="n">arinfo</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span>
	    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_info</span><span class="p">,</span> <span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">23</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_info</span><span class="p">)</span> <span class="o">-</span>
	       <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_info</span><span class="p">,</span> <span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_total_queued</span><span class="p">))</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_schedule</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_upload</span><span class="p">))</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_schedule</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_AMPDU</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">super</span><span class="p">;</span>

			<span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span> <span class="o">=</span> <span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rix</span><span class="p">;</span>
			<span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span> <span class="o">=</span> <span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">cnt</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_REQ_TX_STATUS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * drop redundant tx_status reports:</span>
<span class="cm">			 *</span>
<span class="cm">			 * 1. ampdu_ack_len of the final tx_status does</span>
<span class="cm">			 *    include the feedback of this particular frame.</span>
<span class="cm">			 *</span>
<span class="cm">			 * 2. tx_status_irqsafe only queues up to 128</span>
<span class="cm">			 *    tx feedback reports and discards the rest.</span>
<span class="cm">			 *</span>
<span class="cm">			 * 3. minstrel_ht is picky, it only accepts</span>
<span class="cm">			 *    reports of frames with the TX_STATUS_AMPDU flag.</span>
<span class="cm">			 *</span>
<span class="cm">			 * 4. mac80211 is not particularly interested in</span>
<span class="cm">			 *    feedback either [CTL_REQ_TX_STATUS not set]</span>
<span class="cm">			 */</span>

			<span class="n">ieee80211_free_txskb</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Either the frame transmission has failed or</span>
<span class="cm">			 * mac80211 requested tx status.</span>
<span class="cm">			 */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span><span class="p">));</span>
	<span class="n">ieee80211_tx_status_irqsafe</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_tx_get_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carl9170_tx_info</span> <span class="o">*</span><span class="n">arinfo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arinfo</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">carl9170_tx_put_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carl9170_tx_info</span> <span class="o">*</span><span class="n">arinfo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arinfo</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">carl9170_tx_release</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Caller must hold the tid_info-&gt;lock &amp; rcu_read_lock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_tx_shift_bm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">carl9170_sta_tid</span> <span class="o">*</span><span class="n">tid_info</span><span class="p">,</span> <span class="n">u16</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">off</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">=</span> <span class="n">SEQ_DIFF</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">bsn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">CARL9170_BAW_BITS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity check. For each MPDU we set the bit in bitmap and</span>
<span class="cm">	 * clear it once we received the tx_status.</span>
<span class="cm">	 * But if the bit is already cleared then we&#39;ve been bitten</span>
<span class="cm">	 * by a bug.</span>
<span class="cm">	 */</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">));</span>

	<span class="n">off</span> <span class="o">=</span> <span class="n">SEQ_DIFF</span><span class="p">(</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">snx</span><span class="p">,</span> <span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">bsn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">off</span> <span class="o">&gt;=</span> <span class="n">CARL9170_BAW_BITS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitmap_empty</span><span class="p">(</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">off</span><span class="p">))</span>
		<span class="n">off</span> <span class="o">=</span> <span class="n">find_first_bit</span><span class="p">(</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>

	<span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">bsn</span> <span class="o">+=</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">bsn</span> <span class="o">&amp;=</span> <span class="mh">0x0fff</span><span class="p">;</span>

	<span class="n">bitmap_shift_right</span><span class="p">(</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">,</span>
			   <span class="n">off</span><span class="p">,</span> <span class="n">CARL9170_BAW_BITS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_tx_status_process_ampdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">super</span><span class="o">-&gt;</span><span class="n">frame_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_sta_info</span> <span class="o">*</span><span class="n">sta_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_sta_tid</span> <span class="o">*</span><span class="n">tid_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_INJECTED</span> <span class="o">||</span>
	   <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">super</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">mac_control</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_MAC_AGGR</span><span class="p">))))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">__carl9170_get_tx_sta</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_rcu</span><span class="p">;</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">get_tid_h</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>

	<span class="n">sta_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">tid_info</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tid_info</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rcu</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;=</span> <span class="n">CARL9170_TID_STATE_IDLE</span><span class="p">))</span>
		<span class="n">carl9170_tx_shift_bm</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">tid_info</span><span class="p">,</span> <span class="n">get_seq_h</span><span class="p">(</span><span class="n">hdr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">clear</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">clear</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">req</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">ampdu_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">ampdu_ack_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">ampdu_len</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">ampdu_ack_len</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">))</span>
		<span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">req</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">super</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">mac_control</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_MAC_IMM_BA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rix</span> <span class="o">=</span> <span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">ampdu_len</span><span class="p">;</span>
		<span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">cnt</span> <span class="o">=</span> <span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">ampdu_ack_len</span><span class="p">;</span>
		<span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_AMPDU</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">req</span><span class="p">)</span>
			<span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_AMPDU_NO_BACK</span><span class="p">;</span>

		<span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">clear</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">out_rcu:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">bool</span> <span class="n">success</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txinfo</span><span class="p">;</span>

	<span class="n">carl9170_tx_accounting_free</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">txinfo</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
		<span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ack_failures</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span>
		<span class="n">carl9170_tx_status_process_ampdu</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">txinfo</span><span class="p">);</span>

	<span class="n">carl9170_tx_ps_unblock</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">carl9170_tx_put_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function may be called form any context */</span>
<span class="kt">void</span> <span class="nf">carl9170_tx_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txinfo</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_total_pending</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_upload</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">carl9170_tx_put_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span>
		<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">usb_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">carl9170_get_queued_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cookie</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">txc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">cookie</span> <span class="o">!=</span> <span class="n">cookie</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">carl9170_release_dev_space</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_tx_fill_rateinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rix</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tries</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_TX_MAX_RATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">rix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">tries</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IEEE80211_TX_MAX_RATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_check_queue_stop_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_tx_info</span> <span class="o">*</span><span class="n">arinfo</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">restart</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_status</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_status</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

		<span class="n">txinfo</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">arinfo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_is_before_jiffies</span><span class="p">(</span><span class="n">arinfo</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">+</span>
		    <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CARL9170_QUEUE_STUCK_TIMEOUT</span><span class="p">))</span> <span class="o">==</span> <span class="nb">true</span><span class="p">)</span>
			<span class="n">restart</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">next:</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_status</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * At least one queue has been stuck for long enough.</span>
<span class="cm">		 * Give the device a kick and hope it gets back to</span>
<span class="cm">		 * work.</span>
<span class="cm">		 *</span>
<span class="cm">		 * possible reasons may include:</span>
<span class="cm">		 *  - frames got lost/corrupted (bad connection to the device)</span>
<span class="cm">		 *  - stalled rx processing/usb controller hiccups</span>
<span class="cm">		 *  - firmware errors/bugs</span>
<span class="cm">		 *  - every bug you can think of.</span>
<span class="cm">		 *  - all bugs you can&#39;t...</span>
<span class="cm">		 *  - ...</span>
<span class="cm">		 */</span>
		<span class="n">carl9170_restart</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">CARL9170_RR_STUCK_TX</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_tx_ampdu_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carl9170_sta_tid</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_tx_info</span> <span class="o">*</span><span class="n">arinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">list_for_each_entry_rcu</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">CARL9170_TID_STATE_IDLE</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">txinfo</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">arinfo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_is_after_jiffies</span><span class="p">(</span><span class="n">arinfo</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">+</span>
		    <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CARL9170_QUEUE_TIMEOUT</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">sta</span> <span class="o">=</span> <span class="n">__carl9170_get_tx_sta</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

		<span class="n">ieee80211_stop_tx_ba_session</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
<span class="nl">unlock:</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_tx_janitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ar9170</span><span class="p">,</span>
					 <span class="n">tx_janitor</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_STARTED</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_janitor_last_run</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">carl9170_check_queue_stop_timeout</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="n">carl9170_tx_ampdu_timeout</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_total_queued</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_janitor</span><span class="p">,</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CARL9170_TX_TIMEOUT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__carl9170_tx_process_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txinfo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">ar9170_qmap</span><span class="p">[</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">CARL9170_TX_STATUS_QUEUE</span><span class="p">];</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">carl9170_get_queued_skb</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_status</span><span class="p">[</span><span class="n">q</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We have lost the race to another thread.</span>
<span class="cm">		 */</span>

		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txinfo</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">CARL9170_TX_STATUS_SUCCESS</span><span class="p">))</span>
		<span class="n">success</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">CARL9170_TX_STATUS_RIX</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CARL9170_TX_STATUS_RIX_S</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">info</span> <span class="o">&amp;</span> <span class="n">CARL9170_TX_STATUS_TRIES</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">CARL9170_TX_STATUS_TRIES_S</span><span class="p">;</span>

	<span class="n">carl9170_tx_fill_rateinfo</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">txinfo</span><span class="p">);</span>
	<span class="n">carl9170_tx_status</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">success</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_tx_process_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">carl9170_rsp</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ext</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;UU:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span>
					     <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">__carl9170_tx_process_status</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">_tx_status</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cookie</span><span class="p">,</span>
					     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">_tx_status</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_tx_rate_tpc_chains</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">txrate</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">phyrate</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">tpc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">chains</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">txpower</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">txrate</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tpc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">phyrate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* +1 dBm for HT40 */</span>
			<span class="o">*</span><span class="n">tpc</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
				<span class="n">txpower</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">power_2G_ht40</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">txpower</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">power_5G_ht40</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
				<span class="n">txpower</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">power_2G_ht20</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">txpower</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">power_5G_ht20</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">phyrate</span> <span class="o">=</span> <span class="n">txrate</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tpc</span> <span class="o">+=</span> <span class="n">txpower</span><span class="p">[</span><span class="n">idx</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">txpower</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">power_2G_cck</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">txpower</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">power_2G_ofdm</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">txpower</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">power_5G_leg</span><span class="p">;</span>
			<span class="n">idx</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__carl9170_ratetable</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="o">*</span><span class="n">tpc</span> <span class="o">+=</span> <span class="n">txpower</span><span class="p">[(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
		<span class="o">*</span><span class="n">phyrate</span> <span class="o">=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">tx_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">chains</span> <span class="o">=</span> <span class="n">AR9170_TX_PHY_TXCHAIN_1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">rate</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">&gt;=</span> <span class="mi">360</span><span class="p">)</span>
			<span class="o">*</span><span class="n">chains</span> <span class="o">=</span> <span class="n">AR9170_TX_PHY_TXCHAIN_1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="o">*</span><span class="n">chains</span> <span class="o">=</span> <span class="n">AR9170_TX_PHY_TXCHAIN_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">tpc</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="o">*</span><span class="n">tpc</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">power_level</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__le32</span> <span class="nf">carl9170_tx_physet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">txrate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chains</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phyrate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">AR9170_TX_PHY_BW_40MHZ</span> <span class="o">&lt;&lt;</span>
			<span class="n">AR9170_TX_PHY_BW_S</span><span class="p">);</span>
	<span class="cm">/* this works because 40 MHz is 2 and dup is 3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_DUP_DATA</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">AR9170_TX_PHY_BW_40MHZ_DUP</span> <span class="o">&lt;&lt;</span>
			<span class="n">AR9170_TX_PHY_BW_S</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">AR9170_TX_PHY_SHORT_GI</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SET_VAL</span><span class="p">(</span><span class="n">AR9170_TX_PHY_MCS</span><span class="p">,</span> <span class="n">phyrate</span><span class="p">,</span> <span class="n">txrate</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">);</span>

		<span class="cm">/* heavy clip control */</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">AR9170_TX_PHY_TX_HEAVY_CLIP_S</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">AR9170_TX_PHY_MOD_HT</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * green field preamble does not work.</span>
<span class="cm">		 *</span>
<span class="cm">		 * if (txrate-&gt;flags &amp; IEEE80211_TX_RC_GREEN_FIELD)</span>
<span class="cm">		 * tmp |= cpu_to_le32(AR9170_TX_PHY_GREENFIELD);</span>
<span class="cm">		 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">AR9170_TX_PHY_RATE_CCK_11M</span><span class="p">)</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">AR9170_TX_PHY_MOD_CCK</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">AR9170_TX_PHY_MOD_OFDM</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">AR9170_TX_PHY_MOD_OFDM</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * short preamble seems to be broken too.</span>
<span class="cm">		 *</span>
<span class="cm">		 * if (txrate-&gt;flags &amp; IEEE80211_TX_RC_USE_SHORT_PREAMBLE)</span>
<span class="cm">		 *	tmp |= cpu_to_le32(AR9170_TX_PHY_SHORT_PREAMBLE);</span>
<span class="cm">		 */</span>
	<span class="p">}</span>
	<span class="n">carl9170_tx_rate_tpc_chains</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">txrate</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">phyrate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">power</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chains</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SET_CONSTVAL</span><span class="p">(</span><span class="n">AR9170_TX_PHY_MCS</span><span class="p">,</span> <span class="n">phyrate</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SET_CONSTVAL</span><span class="p">(</span><span class="n">AR9170_TX_PHY_TX_PWR</span><span class="p">,</span> <span class="n">power</span><span class="p">));</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SET_CONSTVAL</span><span class="p">(</span><span class="n">AR9170_TX_PHY_TXCHAIN</span><span class="p">,</span> <span class="n">chains</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">carl9170_tx_rts_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">ampdu</span><span class="p">,</span> <span class="n">bool</span> <span class="n">multi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">erp_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CARL9170_ERP_AUTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ampdu</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CARL9170_ERP_MAC80211</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CARL9170_ERP_RTS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">multi</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">carl9170_tx_cts_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">erp_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CARL9170_ERP_AUTO</span>:
	<span class="k">case</span> <span class="n">CARL9170_ERP_MAC80211</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CARL9170_ERP_CTS</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_tx_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">txc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_vif_info</span> <span class="o">*</span><span class="n">cvif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">txrate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_tx_info</span> <span class="o">*</span><span class="n">arinfo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hw_queue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">mac_tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ampdu</span><span class="p">,</span> <span class="n">no_ack</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arinfo</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">));</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_carl9170_tx_superdesc</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">CARL9170_TX_SUPERDESC_LEN</span><span class="p">);</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_ar9170_tx_hwdesc</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">AR9170_TX_HWDESC_LEN</span><span class="p">);</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">IEEE80211_TX_MAX_RATES</span> <span class="o">&lt;</span> <span class="n">CARL9170_TX_MAX_RATES</span><span class="p">);</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">AR9170_MAX_VIRTUAL_MAC</span> <span class="o">&gt;</span>
		<span class="p">((</span><span class="n">CARL9170_TX_SUPER_MISC_VIF_ID</span> <span class="o">&gt;&gt;</span>
		 <span class="n">CARL9170_TX_SUPER_MISC_VIF_ID_S</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">hw_queue</span> <span class="o">=</span> <span class="n">ar9170_qmap</span><span class="p">[</span><span class="n">carl9170_get_queue</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">)];</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: If the frame was sent through a monitor interface,</span>
<span class="cm">	 * the ieee80211_vif pointer can be NULL.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">))</span>
		<span class="n">cvif</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cvif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">txc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txc</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">txc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txc</span><span class="p">));</span>

	<span class="n">SET_VAL</span><span class="p">(</span><span class="n">CARL9170_TX_SUPER_MISC_QUEUE</span><span class="p">,</span> <span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">misc</span><span class="p">,</span> <span class="n">hw_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">cvif</span><span class="p">))</span>
		<span class="n">SET_VAL</span><span class="p">(</span><span class="n">CARL9170_TX_SUPER_MISC_VIF_ID</span><span class="p">,</span> <span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">misc</span><span class="p">,</span> <span class="n">cvif</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_SEND_AFTER_DTIM</span><span class="p">))</span>
		<span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">misc</span> <span class="o">|=</span> <span class="n">CARL9170_TX_SUPER_MISC_CAB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_ASSIGN_SEQ</span><span class="p">))</span>
		<span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">misc</span> <span class="o">|=</span> <span class="n">CARL9170_TX_SUPER_MISC_ASSIGN_SEQ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span>
		<span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">misc</span> <span class="o">|=</span> <span class="n">CARL9170_TX_SUPER_MISC_FILL_IN_TSF</span><span class="p">;</span>

	<span class="n">mac_tmp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_MAC_HW_DURATION</span> <span class="o">|</span>
			      <span class="n">AR9170_TX_MAC_BACKOFF</span><span class="p">);</span>
	<span class="n">mac_tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">hw_queue</span> <span class="o">&lt;&lt;</span> <span class="n">AR9170_TX_MAC_QOS_S</span><span class="p">)</span> <span class="o">&amp;</span>
			       <span class="n">AR9170_TX_MAC_QOS</span><span class="p">);</span>

	<span class="n">no_ack</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">no_ack</span><span class="p">))</span>
		<span class="n">mac_tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_MAC_NO_ACK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
			<span class="n">mac_tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_MAC_ENCR_RC4</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
			<span class="n">mac_tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_MAC_ENCR_AES</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ampdu</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ampdu</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">density</span><span class="p">,</span> <span class="n">factor</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">sta</span> <span class="o">||</span> <span class="o">!</span><span class="n">cvif</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="n">factor</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">1u</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span><span class="p">);</span>
		<span class="n">density</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_density</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">density</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Watch out!</span>
<span class="cm">			 *</span>
<span class="cm">			 * Otus uses slightly different density values than</span>
<span class="cm">			 * those from the 802.11n spec.</span>
<span class="cm">			 */</span>

			<span class="n">density</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">density</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7u</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">SET_VAL</span><span class="p">(</span><span class="n">CARL9170_TX_SUPER_AMPDU_DENSITY</span><span class="p">,</span>
			<span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ampdu_settings</span><span class="p">,</span> <span class="n">density</span><span class="p">);</span>

		<span class="n">SET_VAL</span><span class="p">(</span><span class="n">CARL9170_TX_SUPER_AMPDU_FACTOR</span><span class="p">,</span>
			<span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ampdu_settings</span><span class="p">,</span> <span class="n">factor</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CARL9170_TX_MAX_RATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txrate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">CARL9170_TX_SUPER_RI_AMPDU</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span>
					      <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)))</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * Not sure if it&#39;s even possible</span>
<span class="cm">					 * to aggregate non-ht rates with</span>
<span class="cm">					 * this HW.</span>
<span class="cm">					 */</span>
					<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">txrate</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">txrate</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rate_tries</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mac_tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_MAC_AGGR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE: For the first rate, the ERP &amp; AMPDU flags are directly</span>
<span class="cm">	 * taken from mac_control. For all fallback rate, the firmware</span>
<span class="cm">	 * updates the mac_control flags from the rate info field.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CARL9170_TX_MAX_RATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txrate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txrate</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">SET_VAL</span><span class="p">(</span><span class="n">CARL9170_TX_SUPER_RI_TRIES</span><span class="p">,</span> <span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">txrate</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">carl9170_tx_rts_check</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">txrate</span><span class="p">,</span> <span class="n">ampdu</span><span class="p">,</span> <span class="n">no_ack</span><span class="p">))</span>
			<span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AR9170_TX_MAC_PROT_RTS</span> <span class="o">&lt;&lt;</span>
				<span class="n">CARL9170_TX_SUPER_RI_ERP_PROT_S</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">carl9170_tx_cts_check</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">txrate</span><span class="p">))</span>
			<span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ri</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AR9170_TX_MAC_PROT_CTS</span> <span class="o">&lt;&lt;</span>
				<span class="n">CARL9170_TX_SUPER_RI_ERP_PROT_S</span><span class="p">);</span>

		<span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">rr</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">carl9170_tx_physet</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">txrate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">txrate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">SET_VAL</span><span class="p">(</span><span class="n">CARL9170_TX_SUPER_RI_TRIES</span><span class="p">,</span> <span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ri</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">txrate</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">carl9170_tx_rts_check</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">txrate</span><span class="p">,</span> <span class="n">ampdu</span><span class="p">,</span> <span class="n">no_ack</span><span class="p">))</span>
		<span class="n">mac_tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_MAC_PROT_RTS</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">carl9170_tx_cts_check</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">txrate</span><span class="p">))</span>
		<span class="n">mac_tmp</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_MAC_PROT_CTS</span><span class="p">);</span>

	<span class="n">txc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">txc</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">);</span>
	<span class="n">txc</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">mac_control</span> <span class="o">=</span> <span class="n">mac_tmp</span><span class="p">;</span>
	<span class="n">txc</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">phy_control</span> <span class="o">=</span> <span class="n">carl9170_tx_physet</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">txrate</span><span class="p">);</span>

	<span class="n">arinfo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>
	<span class="n">arinfo</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">arinfo</span><span class="o">-&gt;</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span><span class="p">;</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">arinfo</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txc</span><span class="p">));</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_set_immba</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">super</span><span class="p">;</span>

	<span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">super</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">mac_control</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_MAC_IMM_BA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_set_ampdu_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">super</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ampdu_settings</span> <span class="o">&amp;</span> <span class="n">CARL9170_TX_SUPER_AMPDU_DENSITY</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">CARL9170_TX_SUPER_AMPDU_DENSITY_S</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If you haven&#39;t noticed carl9170_tx_prepare has already filled</span>
<span class="cm">	 * in all ampdu spacing &amp; factor parameters.</span>
<span class="cm">	 * Now it&#39;s the time to check whenever the settings have to be</span>
<span class="cm">	 * updated by the firmware, or if everything is still the same.</span>
<span class="cm">	 *</span>
<span class="cm">	 * There&#39;s no sane way to handle different density values with</span>
<span class="cm">	 * this hardware, so we may as well just do the compare in the</span>
<span class="cm">	 * driver.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">current_density</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">current_density</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ampdu_settings</span> <span class="o">|=</span>
			<span class="n">CARL9170_TX_SUPER_AMPDU_COMMIT_DENSITY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ampdu_settings</span> <span class="o">&amp;</span> <span class="n">CARL9170_TX_SUPER_AMPDU_FACTOR</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		<span class="n">CARL9170_TX_SUPER_AMPDU_FACTOR_S</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">current_factor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">current_factor</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">ampdu_settings</span> <span class="o">|=</span>
			<span class="n">CARL9170_TX_SUPER_AMPDU_COMMIT_FACTOR</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">carl9170_tx_rate_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">_dest</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">_src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

	<span class="n">dest</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">_dest</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">_src</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The mac80211 rate control algorithm expects that all MPDUs in</span>
<span class="cm">	 * an AMPDU share the same tx vectors.</span>
<span class="cm">	 * This is not really obvious right now, because the hardware</span>
<span class="cm">	 * does the AMPDU setup according to its own rulebook.</span>
<span class="cm">	 * Our nicely assembled, strictly monotonic increasing mpdu</span>
<span class="cm">	 * chains will be broken up, mashed back together...</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">dest</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">phy_control</span> <span class="o">==</span> <span class="n">src</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">phy_control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_tx_ampdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">agg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_sta_tid</span> <span class="o">*</span><span class="n">tid_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done_ampdus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">tmpssn</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_scheduler</span><span class="p">);</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_schedule</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_upload</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_list_len</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">tid_info</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_iter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">tid_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">retry:</span>
	<span class="n">list_for_each_entry_continue_rcu</span><span class="p">(</span><span class="n">tid_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">CARL9170_TID_STATE_PROGRESS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">queue</span> <span class="o">=</span> <span class="n">TID_TO_WME_AC</span><span class="p">(</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARL9170_TID_STATE_XMIT</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">processed</span><span class="p">;</span>

		<span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>
		<span class="n">first</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">tmpssn</span> <span class="o">=</span> <span class="n">carl9170_get_seq</span><span class="p">(</span><span class="n">first</span><span class="p">);</span>
		<span class="n">seq</span> <span class="o">=</span> <span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">snx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tmpssn</span> <span class="o">!=</span> <span class="n">seq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARL9170_TID_STATE_IDLE</span><span class="p">;</span>

			<span class="k">goto</span> <span class="n">processed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* strict 0, 1, ..., n - 1, n frame sequence order */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">carl9170_get_seq</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">seq</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* don&#39;t upload more than AMPDU FACTOR allows. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">SEQ_DIFF</span><span class="p">(</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">snx</span><span class="p">,</span> <span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">bsn</span><span class="p">)</span> <span class="o">&gt;=</span>
			    <span class="p">(</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">carl9170_tx_rate_check</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">first</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_upload</span><span class="p">);</span>
			<span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">snx</span> <span class="o">=</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">SEQ_NEXT</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
			<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

			<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">CARL9170_NUM_TX_AGG_MAX</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">carl9170_get_seq</span><span class="p">(</span><span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="o">!=</span>
		    <span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">snx</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * stop TID, if A-MPDU frames are still missing,</span>
<span class="cm">			 * or whenever the queue is empty.</span>
<span class="cm">			 */</span>

			<span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARL9170_TID_STATE_IDLE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">done_ampdus</span><span class="o">++</span><span class="p">;</span>

<span class="nl">processed:</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid_info</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* apply ampdu spacing &amp; factor settings */</span>
		<span class="n">carl9170_set_ampdu_params</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="p">));</span>

		<span class="cm">/* set aggregation push bit */</span>
		<span class="n">carl9170_set_immba</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb_peek_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="p">));</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">skb_queue_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">queue</span><span class="p">]);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_schedule</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">done_ampdus</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_iter</span><span class="p">,</span> <span class="n">tid_info</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">carl9170_tx_pick_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_tx_info</span> <span class="o">*</span><span class="n">arinfo</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">arinfo</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">));</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">carl9170_alloc_dev_space</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">arinfo</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>

	<span class="n">arinfo</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>

<span class="nl">err_unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_tx_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">super</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">q</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>

	<span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">SET_VAL</span><span class="p">(</span><span class="n">CARL9170_TX_SUPER_MISC_QUEUE</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span>
		<span class="n">ar9170_qmap</span><span class="p">[</span><span class="n">carl9170_get_queue</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">)]);</span>
	<span class="n">__carl9170_tx_process_status</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">super</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">carl9170_tx_ps_drop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_sta_info</span> <span class="o">*</span><span class="n">sta_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">__carl9170_get_tx_sta</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_rcu</span><span class="p">;</span>

	<span class="n">sta_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">sleeping</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_TX_CTL_NO_PS_BUFFER</span> <span class="o">|</span>
				<span class="n">IEEE80211_TX_CTL_CLEAR_PS_FILT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_upload</span><span class="p">);</span>

		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_TX_FILTERED</span><span class="p">;</span>
		<span class="n">carl9170_release_dev_space</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">carl9170_tx_status</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_rcu:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">schedule_garbagecollector</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_schedule</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">IS_STARTED</span><span class="p">(</span><span class="n">ar</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">carl9170_usb_handle_tx_err</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">carl9170_tx_pick_skb</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">carl9170_tx_ps_drop</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">)))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_total_pending</span><span class="p">);</span>

			<span class="n">q</span> <span class="o">=</span> <span class="n">__carl9170_get_queue</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * NB: tx_status[i] vs. tx_status[q],</span>
<span class="cm">			 * TODO: Move into pick_skb or alloc_dev_space.</span>
<span class="cm">			 */</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_status</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * increase ref count to &quot;2&quot;.</span>
<span class="cm">			 * Ref counting is the easiest way to solve the</span>
<span class="cm">			 * race between the urb&#39;s completion routine:</span>
<span class="cm">			 *	carl9170_tx_callback</span>
<span class="cm">			 * and wlan tx status functions:</span>
<span class="cm">			 *	carl9170_tx_status/janitor.</span>
<span class="cm">			 */</span>
			<span class="n">carl9170_tx_get_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">carl9170_usb_tx</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">schedule_garbagecollector</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schedule_garbagecollector</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_janitor</span><span class="p">,</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CARL9170_TX_TIMEOUT</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">carl9170_tx_ampdu_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_carl9170_tx_superframe</span> <span class="o">*</span><span class="n">super</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_sta_info</span> <span class="o">*</span><span class="n">sta_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_sta_tid</span> <span class="o">*</span><span class="n">agg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">qseq</span><span class="p">,</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">run</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">carl9170_get_tid</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="n">carl9170_get_seq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">sta_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">agg</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sta_info</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">agg</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlock_rcu</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">CARL9170_TID_STATE_IDLE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="cm">/* check if sequence is within the BA window */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">BAW_WITHIN</span><span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">bsn</span><span class="p">,</span> <span class="n">CARL9170_BAW_BITS</span><span class="p">,</span> <span class="n">seq</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">BAW_WITHIN</span><span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">snx</span><span class="p">,</span> <span class="n">CARL9170_BAW_BITS</span><span class="p">,</span> <span class="n">seq</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">=</span> <span class="n">SEQ_DIFF</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">bsn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">BAW_WITHIN</span><span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">hsn</span><span class="p">,</span> <span class="n">CARL9170_BAW_BITS</span><span class="p">,</span> <span class="n">seq</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">agg</span><span class="o">-&gt;</span><span class="n">hsn</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">queued</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_queue_reverse_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qseq</span> <span class="o">=</span> <span class="n">carl9170_get_seq</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">BAW_WITHIN</span><span class="p">(</span><span class="n">qseq</span><span class="p">,</span> <span class="n">CARL9170_BAW_BITS</span><span class="p">,</span> <span class="n">seq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__skb_queue_after</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">iter</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">queued</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">__skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="nl">queued:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARL9170_TID_STATE_XMIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">snx</span> <span class="o">==</span> <span class="n">carl9170_get_seq</span><span class="p">(</span><span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">agg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARL9170_TID_STATE_XMIT</span><span class="p">;</span>
			<span class="n">run</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">run</span><span class="p">;</span>

<span class="nl">err_unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

<span class="nl">err_unlock_rcu:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">super</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">.</span><span class="n">mac_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_MAC_AGGR</span><span class="p">);</span>
	<span class="n">carl9170_tx_status</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_op_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">run</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">IS_STARTED</span><span class="p">(</span><span class="n">ar</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">carl9170_tx_prepare</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="n">carl9170_tx_accounting</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * from now on, one has to use carl9170_tx_status to free</span>
<span class="cm">	 * all ressouces which are associated with the frame.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">carl9170_sta_info</span> <span class="o">*</span><span class="n">stai</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stai</span><span class="o">-&gt;</span><span class="n">pending_frames</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">run</span> <span class="o">=</span> <span class="n">carl9170_tx_ampdu_queue</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">run</span><span class="p">)</span>
			<span class="n">carl9170_tx_ampdu</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">carl9170_tx</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_free:</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ieee80211_free_txskb</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_tx_scheduler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_ampdu_schedule</span><span class="p">)</span>
		<span class="n">carl9170_tx_ampdu</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_schedule</span><span class="p">)</span>
		<span class="n">carl9170_tx</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">carl9170_update_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">const</span> <span class="n">bool</span> <span class="n">submit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">carl9170_vif_info</span> <span class="o">*</span><span class="n">cvif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plcp</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">chains</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">word</span><span class="p">,</span> <span class="n">ht1</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">cvif</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">beacon_iter</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vifs</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">cvif</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">list_for_each_entry_continue_rcu</span><span class="p">(</span><span class="n">cvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cvif</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">&amp;&amp;</span> <span class="n">cvif</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">beacon_enabled</span> <span class="o">||</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

<span class="nl">found:</span>
	<span class="n">rcu_assign_pointer</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">beacon_iter</span><span class="p">,</span> <span class="n">cvif</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get_tim</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">carl9170_get_vif</span><span class="p">(</span><span class="n">cvif</span><span class="p">),</span>
		<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txinfo</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cvif</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">)</span>
		<span class="n">old</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">cvif</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">off</span> <span class="o">=</span> <span class="n">cvif</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">*</span> <span class="n">AR9170_MAC_BCN_LENGTH_MAX</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">beacon_addr</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">off</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">beacon_max_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;beacon does not &quot;</span>
				  <span class="s">&quot;fit into device memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">AR9170_MAC_BCN_LENGTH_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;no support for beacons &quot;</span>
				<span class="s">&quot;bigger than %d (yours:%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">AR9170_MAC_BCN_LENGTH_MAX</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ht1</span> <span class="o">=</span> <span class="n">AR9170_MAC_BCN_HT1_TX_ANT0</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">carl9170_tx_rate_tpc_chains</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">txinfo</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">plcp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">power</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chains</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plcp</span> <span class="o">&lt;=</span> <span class="n">AR9170_TX_PHY_RATE_CCK_11M</span><span class="p">)</span>
			<span class="n">plcp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">16</span><span class="p">))</span> <span class="o">+</span> <span class="mh">0x0400</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">plcp</span> <span class="o">|=</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x0010</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ht1</span> <span class="o">|=</span> <span class="n">AR9170_MAC_BCN_HT1_HT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">)</span>
			<span class="n">plcp</span> <span class="o">|=</span> <span class="n">AR9170_MAC_BCN_HT2_SGI</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ht1</span> <span class="o">|=</span> <span class="n">AR9170_MAC_BCN_HT1_BWC_40M_SHARED</span><span class="p">;</span>
			<span class="n">plcp</span> <span class="o">|=</span> <span class="n">AR9170_MAC_BCN_HT2_BW40</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_DUP_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ht1</span> <span class="o">|=</span> <span class="n">AR9170_MAC_BCN_HT1_BWC_40M_DUP</span><span class="p">;</span>
			<span class="n">plcp</span> <span class="o">|=</span> <span class="n">AR9170_MAC_BCN_HT2_BW40</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">SET_VAL</span><span class="p">(</span><span class="n">AR9170_MAC_BCN_HT2_LEN</span><span class="p">,</span> <span class="n">plcp</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SET_VAL</span><span class="p">(</span><span class="n">AR9170_MAC_BCN_HT1_PWR_CTRL</span><span class="p">,</span> <span class="n">ht1</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">SET_VAL</span><span class="p">(</span><span class="n">AR9170_MAC_BCN_HT1_TPC</span><span class="p">,</span> <span class="n">ht1</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>
	<span class="n">SET_VAL</span><span class="p">(</span><span class="n">AR9170_MAC_BCN_HT1_CHAIN_MASK</span><span class="p">,</span> <span class="n">ht1</span><span class="p">,</span> <span class="n">chains</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chains</span> <span class="o">==</span> <span class="n">AR9170_TX_PHY_TXCHAIN_2</span><span class="p">)</span>
		<span class="n">ht1</span> <span class="o">|=</span> <span class="n">AR9170_MAC_BCN_HT1_TX_ANT1</span><span class="p">;</span>

	<span class="n">carl9170_async_regwrite_begin</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="n">carl9170_async_regwrite</span><span class="p">(</span><span class="n">AR9170_MAC_REG_BCN_HT1</span><span class="p">,</span> <span class="n">ht1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">))</span>
		<span class="n">carl9170_async_regwrite</span><span class="p">(</span><span class="n">AR9170_MAC_REG_BCN_PLCP</span><span class="p">,</span> <span class="n">plcp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">carl9170_async_regwrite</span><span class="p">(</span><span class="n">AR9170_MAC_REG_BCN_HT2</span><span class="p">,</span> <span class="n">plcp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX: This accesses beyond skb data for up</span>
<span class="cm">		 *	to the last 3 bytes!!</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">old</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">word</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">carl9170_async_regwrite</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">word</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">carl9170_async_regwrite_finish</span><span class="p">();</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">cvif</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">);</span>
	<span class="n">cvif</span><span class="o">-&gt;</span><span class="n">beacon</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_async_regwrite_result</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">cvif</span><span class="o">-&gt;</span><span class="n">beacon</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">submit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_bcn_ctrl</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">cvif</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					<span class="n">CARL9170_BCN_CTRL_CAB_TRIGGER</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out_unlock:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unlock:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">);</span>

<span class="nl">err_free:</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
