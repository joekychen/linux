<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › carl9170 › usb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>usb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Atheros CARL9170 driver</span>
<span class="cm"> *</span>
<span class="cm"> * USB - frontend</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2008, Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> * Copyright 2009, 2010, Christian Lamparter &lt;chunkeey@googlemail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; see the file COPYING.  If not, see</span>
<span class="cm"> * http://www.gnu.org/licenses/.</span>
<span class="cm"> *</span>
<span class="cm"> * This file incorporates work covered by the following copyright and</span>
<span class="cm"> * permission notice:</span>
<span class="cm"> *    Copyright (c) 2007-2008 Atheros Communications, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *    Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> *    purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> *    copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> *    THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> *    WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> *    MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> *    ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> *    WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> *    ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> *    OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &quot;carl9170.h&quot;</span>
<span class="cp">#include &quot;cmd.h&quot;</span>
<span class="cp">#include &quot;hw.h&quot;</span>
<span class="cp">#include &quot;fwcmd.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Johannes Berg &lt;johannes@sipsolutions.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Christian Lamparter &lt;chunkeey@googlemail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Atheros AR9170 802.11n USB wireless&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">CARL9170FW_NAME</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ar9170usb&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;arusb_lnx&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Note:</span>
<span class="cm"> *</span>
<span class="cm"> * Always update our wiki&#39;s device list (located at:</span>
<span class="cm"> * http://wireless.kernel.org/en/users/Drivers/ar9170/devices ),</span>
<span class="cm"> * whenever you add a new device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">carl9170_usb_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Atheros 9170 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cf3</span><span class="p">,</span> <span class="mh">0x9170</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Atheros TG121N */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cf3</span><span class="p">,</span> <span class="mh">0x1001</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* TP-Link TL-WN821N v2 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cf3</span><span class="p">,</span> <span class="mh">0x1002</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">CARL9170_WPS_BUTTON</span> <span class="o">|</span>
		 <span class="n">CARL9170_ONE_LED</span> <span class="p">},</span>
	<span class="cm">/* 3Com Dual Band 802.11n USB Adapter */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cf3</span><span class="p">,</span> <span class="mh">0x1010</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* H3C Dual Band 802.11n USB Adapter */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cf3</span><span class="p">,</span> <span class="mh">0x1011</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Cace Airpcap NX */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0xcace</span><span class="p">,</span> <span class="mh">0x0300</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* D-Link DWA 160 A1 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x07d1</span><span class="p">,</span> <span class="mh">0x3c10</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* D-Link DWA 160 A2 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x07d1</span><span class="p">,</span> <span class="mh">0x3a09</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* D-Link DWA 130 D */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x07d1</span><span class="p">,</span> <span class="mh">0x3a0f</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Netgear WNA1000 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0846</span><span class="p">,</span> <span class="mh">0x9040</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Netgear WNDA3100 (v1) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0846</span><span class="p">,</span> <span class="mh">0x9010</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Netgear WN111 v2 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0846</span><span class="p">,</span> <span class="mh">0x9001</span><span class="p">),</span> <span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="n">CARL9170_ONE_LED</span> <span class="p">},</span>
	<span class="cm">/* Zydas ZD1221 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0ace</span><span class="p">,</span> <span class="mh">0x1221</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Proxim ORiNOCO 802.11n USB */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1435</span><span class="p">,</span> <span class="mh">0x0804</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* WNC Generic 11n USB Dongle */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1435</span><span class="p">,</span> <span class="mh">0x0326</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* ZyXEL NWD271N */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0586</span><span class="p">,</span> <span class="mh">0x3417</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Z-Com UB81 BG */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cde</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Z-Com UB82 ABG */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cde</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Sphairon Homelink 1202 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cde</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Arcadyan WN7512 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x083a</span><span class="p">,</span> <span class="mh">0xf522</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Planex GWUS300 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x2019</span><span class="p">,</span> <span class="mh">0x5304</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* IO-Data WNGDNUS2 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x04bb</span><span class="p">,</span> <span class="mh">0x093f</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* NEC WL300NU-G */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0409</span><span class="p">,</span> <span class="mh">0x0249</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* NEC WL300NU-AG */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0409</span><span class="p">,</span> <span class="mh">0x02b4</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* AVM FRITZ!WLAN USB Stick N */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x057c</span><span class="p">,</span> <span class="mh">0x8401</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* AVM FRITZ!WLAN USB Stick N 2.4 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x057c</span><span class="p">,</span> <span class="mh">0x8402</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Qwest/Actiontec 802AIN Wireless N USB Network Adapter */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1668</span><span class="p">,</span> <span class="mh">0x1200</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Airlive X.USB a/b/g/n */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1b75</span><span class="p">,</span> <span class="mh">0x9170</span><span class="p">)</span> <span class="p">},</span>

	<span class="cm">/* terminate */</span>
	<span class="p">{}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">carl9170_usb_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_submit_data_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch_urbs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">AR9170_NUM_TX_URBS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_acc</span><span class="p">;</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_get_from_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_acc</span><span class="p">;</span>

	<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx submit failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">usb_unanchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="nl">err_acc:</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch_urbs</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_tx_data_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch_urbs</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* everything is fine */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">carl9170_tx_callback</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* disconnect */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Defer the frame clean-up to the tasklet worker.</span>
<span class="cm">		 * This is necessary, because carl9170_tx_drop</span>
<span class="cm">		 * does not work in an irqsave context.</span>
<span class="cm">		 */</span>
		<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* a random transmission error has occurred? */</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;tx failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">IS_STARTED</span><span class="p">(</span><span class="n">ar</span><span class="p">)))</span>
		<span class="n">carl9170_usb_submit_data_urb</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_usb_submit_cmd_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_cmd_urbs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_cmd_urbs</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_get_from_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_cmd_urbs</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usb_unanchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_cmd_urbs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_cmd_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_cmd_urbs</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* everything is fine */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* disconnect */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_INITIALIZED</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;submit cmd cb failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_submit_cmd_urb</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;submit cmd failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_rx_irq_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* everything is fine */</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* disconnect */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">resubmit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">carl9170_handle_command_response</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
					 <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>

<span class="nl">resubmit:</span>
	<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span>
		<span class="n">usb_unanchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_usb_submit_rx_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">runs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch_urbs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">AR9170_NUM_RX_URBS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">runs</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">AR9170_NUM_RX_URBS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_get_from_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">usb_unanchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
				<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool_urbs</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch_urbs</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_rx_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR9170_NUM_RX_URBS_POOL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_get_from_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_work</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_work_urbs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_INITIALIZED</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">carl9170_rx</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
				    <span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool_urbs</span><span class="p">);</span>

		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

		<span class="n">carl9170_usb_submit_rx_urb</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_usb_handle_tx_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">urb</span> <span class="o">=</span> <span class="n">usb_get_from_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

		<span class="n">carl9170_tx_drop</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">carl9170_tx_callback</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_INITIALIZED</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">carl9170_usb_rx_work</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Strictly speaking: The tx scheduler is not part of the USB system.</span>
<span class="cm">	 * But the rx worker returns frames back to the mac80211-stack and</span>
<span class="cm">	 * this is the _perfect_ place to generate the next transmissions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_STARTED</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span>
		<span class="n">carl9170_tx_scheduler</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_rx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch_urbs</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* rx path */</span>
		<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_work</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_work_urbs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ENODEV</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ESHUTDOWN</span>:
		<span class="cm">/* handle disconnect events*/</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* handle all other errors */</span>
		<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool_urbs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_submit_rx_urb</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * usb_submit_rx_urb reported a problem.</span>
<span class="cm">		 * In case this is due to a rx buffer shortage,</span>
<span class="cm">		 * elevate the tasklet worker priority to</span>
<span class="cm">		 * the highest available level.</span>
<span class="cm">		 */</span>
		<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">usb_tasklet</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch_urbs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The system is too slow to cope with</span>
<span class="cm">			 * the enormous workload. We have simply</span>
<span class="cm">			 * run out of active rx urbs and this</span>
<span class="cm">			 * unfortunately leads to an unpredictable</span>
<span class="cm">			 * device.</span>
<span class="cm">			 */</span>

			<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ping_work</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Using anything less than _high_ priority absolutely</span>
<span class="cm">		 * kills the rx performance my UP-System...</span>
<span class="cm">		 */</span>
		<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">usb_tasklet</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="nf">carl9170_usb_alloc_rx_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">rx_size</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			  <span class="n">AR9170_USB_EP_RX</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">rx_size</span><span class="p">,</span>
			  <span class="n">carl9170_usb_rx_complete</span><span class="p">,</span> <span class="n">ar</span><span class="p">);</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_FREE_BUFFER</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">urb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_usb_send_rx_irq_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ibuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ibuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">AR9170_USB_EP_CTRL_MAX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibuf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvintpipe</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			 <span class="n">AR9170_USB_EP_IRQ</span><span class="p">),</span> <span class="n">ibuf</span><span class="p">,</span> <span class="n">AR9170_USB_EP_CTRL_MAX</span><span class="p">,</span>
			 <span class="n">carl9170_usb_rx_irq_complete</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_FREE_BUFFER</span><span class="p">;</span>

	<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">usb_unanchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_usb_init_rx_bulk_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The driver actively maintains a second shadow</span>
<span class="cm">	 * pool for inactive, but fully-prepared rx urbs.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The pool should help the driver to master huge</span>
<span class="cm">	 * workload spikes without running the risk of</span>
<span class="cm">	 * undersupplying the hardware or wasting time by</span>
<span class="cm">	 * processing rx data (streams) inside the urb</span>
<span class="cm">	 * completion (hardirq context).</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR9170_NUM_RX_URBS_POOL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">carl9170_usb_alloc_rx_urb</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool_urbs</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_submit_rx_urb</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="cm">/* the device now waiting for the firmware. */</span>
	<span class="n">carl9170_set_state_when</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">CARL9170_STOPPED</span><span class="p">,</span> <span class="n">CARL9170_IDLE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>

	<span class="n">usb_scuttle_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">);</span>
	<span class="n">usb_scuttle_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_work</span><span class="p">);</span>
	<span class="n">usb_kill_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_usb_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">urb</span> <span class="o">=</span> <span class="n">usb_get_from_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_wait</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
		<span class="n">carl9170_tx_drop</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">carl9170_tx_callback</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_wait_anchor_empty_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="cm">/* lets wait a while until the tx - queues are dried out */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_wait_anchor_empty_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">usb_kill_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch</span><span class="p">);</span>
	<span class="n">carl9170_usb_handle_tx_err</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_cancel_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">carl9170_set_state</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">CARL9170_UNKNOWN_STATE</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_flush</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;stuck tx urbs!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">usb_poison_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch</span><span class="p">);</span>
	<span class="n">carl9170_usb_handle_tx_err</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="n">usb_poison_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">usb_tasklet</span><span class="p">);</span>

	<span class="n">usb_scuttle_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_work</span><span class="p">);</span>
	<span class="n">usb_scuttle_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">);</span>
	<span class="n">usb_scuttle_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__carl9170_exec_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">carl9170_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">bool</span> <span class="n">free_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_INITIALIZED</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">CARL9170_MAX_CMD_LEN</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_fill_int_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndintpipe</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
		<span class="n">AR9170_USB_EP_CMD</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
		<span class="n">carl9170_usb_cmd_complete</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free_buf</span><span class="p">)</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_FREE_BUFFER</span><span class="p">;</span>

	<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">);</span>
	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">carl9170_usb_submit_cmd_urb</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

<span class="nl">err_free:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free_buf</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">carl9170_exec_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">const</span> <span class="k">enum</span> <span class="n">carl9170_cmd_oids</span> <span class="n">cmd</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">plen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">outlen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ACCEPTING_CMD</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">CARL9170_CMD_ASYNC_FLAG</span><span class="p">))</span>
		<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">plen</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="cm">/* writing multiple regs fills this buffer already */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&amp;&amp;</span> <span class="n">payload</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">plen</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">readbuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">out</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">=</span> <span class="n">outlen</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">__carl9170_exec_cmd</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">CARL9170_CMD_ASYNC_FLAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_unbuf</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">!=</span> <span class="n">outlen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EMSGSIZE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_unbuf</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unbuf:</span>
	<span class="cm">/* Maybe the device was removed in the moment we were waiting? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_STARTED</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no command feedback &quot;</span>
			<span class="s">&quot;received (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

		<span class="cm">/* provide some maybe useful debug information */</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;carl9170 cmd: &quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">plen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">carl9170_restart</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">CARL9170_RR_COMMAND_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* invalidate to avoid completing the next command prematurely */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">readbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_usb_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ar9170_stream</span> <span class="o">*</span><span class="n">tx_stream</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_STARTED</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_drop</span><span class="p">;</span>

	<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">urb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">tx_stream</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_stream</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_stream</span><span class="p">));</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_stream</span><span class="p">);</span>
		<span class="n">tx_stream</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">tx_stream</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_TX_STREAM_TAG</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">tx_stream</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
		<span class="n">AR9170_USB_EP_TX</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		<span class="n">carl9170_usb_tx_data_complete</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">|=</span> <span class="n">URB_ZERO_PACKET</span><span class="p">;</span>

	<span class="n">usb_anchor_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_wait</span><span class="p">);</span>

	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">);</span>

	<span class="n">carl9170_usb_submit_data_urb</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_drop:</span>
	<span class="n">carl9170_tx_drop</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">carl9170_tx_callback</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_release_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_usb_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">carl9170_set_state_when</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">CARL9170_IDLE</span><span class="p">,</span> <span class="n">CARL9170_STOPPED</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">carl9170_usb_flush</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;kill pending tx urbs.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">usb_poison_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch</span><span class="p">);</span>
	<span class="n">carl9170_usb_handle_tx_err</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="cm">/* kill any pending command */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>
	<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">);</span>

	<span class="cm">/* This is required to prevent an early completion on _start */</span>
	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note:</span>
<span class="cm">	 * So far we freed all tx urbs, but we won&#39;t dare to touch any rx urbs.</span>
<span class="cm">	 * Else we would end up with a unresponsive device...</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">carl9170_usb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_unpoison_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch</span><span class="p">);</span>

	<span class="n">carl9170_set_state_when</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">CARL9170_STOPPED</span><span class="p">,</span> <span class="n">CARL9170_IDLE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_usb_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">transfer</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">address</span><span class="p">;</span>

	<span class="cm">/* this removes the miniboot image */</span>
	<span class="n">data</span> <span class="o">+=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">transfer</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">4096u</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">transfer</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				      <span class="mh">0x30</span> <span class="cm">/* FW DL */</span><span class="p">,</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span>
				      <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">transfer</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">-=</span> <span class="n">transfer</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">transfer</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">transfer</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="mh">0x31</span> <span class="cm">/* FW DL COMPLETE */</span><span class="p">,</span>
			      <span class="mh">0x40</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_boot_wait</span><span class="p">,</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_echo_test</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="mh">0x4a110123</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="cm">/* now, start the command response counter */</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_seq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;firmware upload failed (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">carl9170_usb_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">condition</span> <span class="o">!=</span> <span class="n">USB_INTERFACE_BOUND</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable the command response sequence counter check.</span>
<span class="cm">	 * We already know that the device/firmware is in a bad state.</span>
<span class="cm">	 * So, no extra points are awarded to anyone who reminds the</span>
<span class="cm">	 * driver about that.</span>
<span class="cm">	 */</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_seq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_reboot</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">carl9170_usb_stop</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">usb_tasklet</span><span class="p">);</span>

	<span class="cm">/* The reboot procedure can take quite a while to complete. */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1100</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_open</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_load_firmware</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">carl9170_usb_cancel_urbs</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_usb_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is the last resort to get the device going again</span>
<span class="cm">	 * without any *user replugging action*.</span>
<span class="cm">	 *</span>
<span class="cm">	 * But there is a catch: usb_reset really is like a physical</span>
<span class="cm">	 * *reconnect*. The mac80211 state will be lost in the process.</span>
<span class="cm">	 * Therefore a userspace application, which is monitoring</span>
<span class="cm">	 * the link must step in.</span>
<span class="cm">	 */</span>
	<span class="n">carl9170_usb_cancel_urbs</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">carl9170_usb_stop</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">usb_queue_reset_device</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_usb_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The carl9170 firmware let&#39;s the driver know when it&#39;s</span>
<span class="cm">	 * ready for action. But we have to be prepared to gracefully</span>
<span class="cm">	 * handle all spurious [flushed] messages after each (re-)boot.</span>
<span class="cm">	 * Thus the command response counter remains disabled until it</span>
<span class="cm">	 * can be safely synchronized.</span>
<span class="cm">	 */</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_seq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_send_rx_irq_urb</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_init_rx_bulk_urbs</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unrx</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_open</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unrx</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_load_firmware</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_stop</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_stop:</span>
	<span class="n">carl9170_usb_stop</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

<span class="nl">err_unrx:</span>
	<span class="n">carl9170_usb_cancel_urbs</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_firmware_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Store a copy of the usb_device pointer locally.</span>
<span class="cm">	 * This is because device_release_driver initiates</span>
<span class="cm">	 * carl9170_usb_disconnect, which in turn frees our</span>
<span class="cm">	 * driver context (ar).</span>
<span class="cm">	 */</span>
	<span class="n">udev</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_load_wait</span><span class="p">);</span>

	<span class="cm">/* unbind anything failed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">device_lock</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">device_release_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">device_unlock</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_firmware_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_parse_firmware</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_freefw</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_init_device</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_freefw</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_register</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">carl9170_usb_stop</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unrx</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_load_wait</span><span class="p">);</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_unrx:</span>
	<span class="n">carl9170_usb_cancel_urbs</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

<span class="nl">err_freefw:</span>
	<span class="n">carl9170_release_firmware</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="n">carl9170_usb_firmware_failed</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_firmware_step2</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">,</span>
					<span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw</span> <span class="o">=</span> <span class="n">fw</span><span class="p">;</span>
		<span class="n">carl9170_usb_firmware_finish</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;firmware not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">carl9170_usb_firmware_failed</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_usb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_reset_device</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ar</span> <span class="o">=</span> <span class="n">carl9170_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ar</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">ar</span><span class="p">);</span>
	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">init_usb_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch</span><span class="p">);</span>
	<span class="n">init_usb_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool</span><span class="p">);</span>
	<span class="n">init_usb_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_work</span><span class="p">);</span>
	<span class="n">init_usb_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_wait</span><span class="p">);</span>
	<span class="n">init_usb_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch</span><span class="p">);</span>
	<span class="n">init_usb_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">);</span>
	<span class="n">init_usb_anchor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_boot_wait</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_load_wait</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">usb_tasklet</span><span class="p">,</span> <span class="n">carl9170_usb_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_cmd_urbs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_anch_urbs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_work_urbs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch_urbs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_pool_urbs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>

	<span class="n">carl9170_set_state</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">CARL9170_STOPPED</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">request_firmware_nowait</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CARL9170FW_NAME</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">ar</span><span class="p">,</span> <span class="n">carl9170_usb_firmware_step2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_usb_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">udev</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_load_wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_INITIALIZED</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">carl9170_reboot</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
		<span class="n">carl9170_usb_stop</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">carl9170_usb_cancel_urbs</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="n">carl9170_unregister</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">carl9170_release_firmware</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="n">carl9170_free</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_usb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
				<span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">carl9170_usb_cancel_urbs</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_usb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">usb_unpoison_anchored_urbs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_anch</span><span class="p">);</span>
	<span class="n">carl9170_set_state</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">CARL9170_STOPPED</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The USB documentation demands that [for suspend] all traffic</span>
<span class="cm">	 * to and from the device has to stop. This would be fine, but</span>
<span class="cm">	 * there&#39;s a catch: the device[usb phy] does not come back.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Upon resume the firmware will &quot;kill&quot; itself and the</span>
<span class="cm">	 * boot-code sorts out the magic voodoo.</span>
<span class="cm">	 * Not very nice, but there&#39;s not much what could go wrong.</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1100</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">carl9170_usb_init_device</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unrx</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unrx:</span>
	<span class="n">carl9170_usb_cancel_urbs</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">carl9170_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">carl9170_usb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">carl9170_usb_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">carl9170_usb_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">soft_unbind</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">carl9170_usb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">carl9170_usb_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span> <span class="n">carl9170_usb_resume</span><span class="p">,</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
	<span class="p">.</span><span class="n">disable_hub_initiated_lpm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">carl9170_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
