<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › carl9170 › rx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>rx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Atheros CARL9170 driver</span>
<span class="cm"> *</span>
<span class="cm"> * 802.11 &amp; command trap routines</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2008, Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> * Copyright 2009, 2010, Christian Lamparter &lt;chunkeey@googlemail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; see the file COPYING.  If not, see</span>
<span class="cm"> * http://www.gnu.org/licenses/.</span>
<span class="cm"> *</span>
<span class="cm"> * This file incorporates work covered by the following copyright and</span>
<span class="cm"> * permission notice:</span>
<span class="cm"> *    Copyright (c) 2007-2008 Atheros Communications, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> *    Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> *    purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> *    copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> *    THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> *    WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> *    MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> *    ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> *    WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> *    ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> *    OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &quot;carl9170.h&quot;</span>
<span class="cp">#include &quot;hw.h&quot;</span>
<span class="cp">#include &quot;cmd.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_dbg_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">restart</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">carl9170_restart_reasons</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">CARL9170_RR_NO_REASON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">CARL9170_ERR_MAGIC</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">err_counter</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">err_counter</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">restart</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="n">reason</span> <span class="o">=</span> <span class="n">CARL9170_RR_TOO_MANY_FIRMWARE_ERRORS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">CARL9170_BUG_MAGIC</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">bug_counter</span><span class="o">++</span><span class="p">;</span>
			<span class="n">restart</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">reason</span> <span class="o">=</span> <span class="n">CARL9170_RR_FATAL_FIRMWARE_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wiphy_info</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FW: %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span>
		<span class="n">carl9170_restart</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_handle_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">carl9170_rsp</span> <span class="o">*</span><span class="n">rsp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ps</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">new_ps</span><span class="p">;</span>

	<span class="n">ps</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">psm</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>

	<span class="n">new_ps</span> <span class="o">=</span> <span class="p">(</span><span class="n">ps</span> <span class="o">&amp;</span> <span class="n">CARL9170_PSM_COUNTER</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CARL9170_PSM_WAKE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">new_ps</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_ps</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">sleep_ms</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span>
				<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">last_action</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">last_action</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">new_ps</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_check_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_seq</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize Counter</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_seq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The sequence is strictly monotonic increasing and it never skips!</span>
<span class="cm">	 *</span>
<span class="cm">	 * Therefore we can safely assume that whenever we received an</span>
<span class="cm">	 * unexpected sequence we have lost some valuable data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">seq</span> <span class="o">!=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_seq</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq</span> <span class="o">-</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_seq</span><span class="p">)</span> <span class="o">%</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">cmd_bufs</span><span class="p">;</span>

		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;lost %d command responses/traps! &quot;</span>
			  <span class="s">&quot;w:%d g:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_seq</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>

		<span class="n">carl9170_restart</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">CARL9170_RR_LOST_RSP</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">cmd_bufs</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_cmd_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Some commands may have a variable response length</span>
<span class="cm">	 * and we cannot predict the correct length in advance.</span>
<span class="cm">	 * So we only check if we provided enough space for the data.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">!=</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;received invalid command response:&quot;</span>
			 <span class="s">&quot;got %d, instead of %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">readlen</span><span class="p">);</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;carl9170 cmd:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">,</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;carl9170 rsp:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
			<span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Do not complete. The command times out,</span>
<span class="cm">		 * and we get a stack trace from there.</span>
<span class="cm">		 */</span>
		<span class="n">carl9170_restart</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">CARL9170_RR_INVALID_RSP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">readbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">readbuf</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">readbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_wait</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_handle_command_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carl9170_rsp</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">carl9170_check_sequence</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">seq</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">CARL9170_RSP_FLAG</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CARL9170_RSP_FLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">CARL9170_CMD_ASYNC_FLAG</span><span class="p">))</span>
			<span class="n">carl9170_cmd_callback</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">!=</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FW: received over-/under&quot;</span>
				<span class="s">&quot;sized event %x (%d, but should be %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;dump:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span>
					     <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* hardware event handlers */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CARL9170_RSP_PRETBTT</span>:
		<span class="cm">/* pre-TBTT event */</span>
		<span class="n">rcu_read_lock</span><span class="p">();</span>
		<span class="n">vif</span> <span class="o">=</span> <span class="n">carl9170_get_main_vif</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcu_read_unlock</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
			<span class="n">carl9170_handle_ps</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
			<span class="n">carl9170_update_beacon</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>

		<span class="k">break</span><span class="p">;</span>


	<span class="k">case</span> <span class="n">CARL9170_RSP_TXCOMP</span>:
		<span class="cm">/* TX status notification */</span>
		<span class="n">carl9170_tx_process_status</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CARL9170_RSP_BEACON_CONFIG</span>:
		<span class="cm">/*</span>
<span class="cm">		 * (IBSS) beacon send notification</span>
<span class="cm">		 * bytes: 04 c2 XX YY B4 B3 B2 B1</span>
<span class="cm">		 *</span>
<span class="cm">		 * XX always 80</span>
<span class="cm">		 * YY always 00</span>
<span class="cm">		 * B1-B4 &quot;should&quot; be the number of send out beacons.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CARL9170_RSP_ATIM</span>:
		<span class="cm">/* End of Atim Window */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CARL9170_RSP_WATCHDOG</span>:
		<span class="cm">/* Watchdog Interrupt */</span>
		<span class="n">carl9170_restart</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">CARL9170_RR_WATCHDOG</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CARL9170_RSP_TEXT</span>:
		<span class="cm">/* firmware debug */</span>
		<span class="n">carl9170_dbg_message</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CARL9170_RSP_HEXDUMP</span>:
		<span class="n">wiphy_dbg</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FW: HD %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;FW:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CARL9170_RSP_RADAR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">wiphy_info</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FW: RADAR! Please report this &quot;</span>
		       <span class="s">&quot;incident to linux-wireless@vger.kernel.org !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CARL9170_RSP_GPIO</span>:
<span class="cp">#ifdef CONFIG_CARL9170_WPC</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wps</span><span class="p">.</span><span class="n">pbc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bool</span> <span class="n">state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">.</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span>
				<span class="n">AR9170_GPIO_PORT_WPS_BUTTON_PRESSED</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">wps</span><span class="p">.</span><span class="n">pbc_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wps</span><span class="p">.</span><span class="n">pbc_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wps</span><span class="p">.</span><span class="n">pbc</span><span class="p">,</span> <span class="n">KEY_WPS_BUTTON</span><span class="p">,</span>
						 <span class="n">state</span><span class="p">);</span>
				<span class="n">input_sync</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wps</span><span class="p">.</span><span class="n">pbc</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_CARL9170_WPC */</span><span class="cp"></span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CARL9170_RSP_BOOT</span>:
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw_boot_wait</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FW: received unhandled event %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;dump:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_NONE</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">carl9170_rx_mac_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ar9170_rx_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ar9170_rx_macstatus</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">error</span><span class="p">,</span> <span class="n">decrypt</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_head</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_macstatus</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;</span> <span class="n">AR9170_RX_ERROR_WRONG_RA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sniffer_enabled</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;</span> <span class="n">AR9170_RX_ERROR_PLCP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">filter_state</span> <span class="o">&amp;</span> <span class="n">FIF_PLCPFAIL</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_FAILED_PLCP_CRC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;</span> <span class="n">AR9170_RX_ERROR_FCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_fcs_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">filter_state</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_FAILED_FCS_CRC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">decrypt</span> <span class="o">=</span> <span class="n">ar9170_get_decrypt_type</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">decrypt</span> <span class="o">&amp;</span> <span class="n">AR9170_RX_ENC_SOFTWARE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">decrypt</span> <span class="o">!=</span> <span class="n">AR9170_ENC_ALG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">decrypt</span> <span class="o">==</span> <span class="n">AR9170_ENC_ALG_TKIP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">error</span> <span class="o">&amp;</span> <span class="n">AR9170_RX_ERROR_MMIC</span><span class="p">))</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MMIC_ERROR</span><span class="p">;</span>

		<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&amp;</span> <span class="n">AR9170_RX_ERROR_DECRYPT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sniffer_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AR9170_RX_ERROR_MMIC</span> <span class="o">|</span>
		   <span class="n">AR9170_RX_ERROR_FCS</span> <span class="o">|</span>
		   <span class="n">AR9170_RX_ERROR_WRONG_RA</span> <span class="o">|</span>
		   <span class="n">AR9170_RX_ERROR_DECRYPT</span> <span class="o">|</span>
		   <span class="n">AR9170_RX_ERROR_PLCP</span><span class="p">);</span>

	<span class="cm">/* drop any other error frames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* TODO: update netdevice&#39;s RX dropped/errors statistics */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="n">wiphy_dbg</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;received frame with &quot;</span>
			       <span class="s">&quot;suspicious error code (%#x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AR9170_RX_STATUS_MODULATION</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR9170_RX_STATUS_MODULATION_CCK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AR9170_RX_STATUS_SHORT_PREAMBLE</span><span class="p">)</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORTPRE</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">plcp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AR9170_RX_PHY_RATE_CCK_1M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR9170_RX_PHY_RATE_CCK_2M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR9170_RX_PHY_RATE_CCK_5M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR9170_RX_PHY_RATE_CCK_11M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;invalid plcp cck &quot;</span>
				       <span class="s">&quot;rate (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">plcp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AR9170_RX_STATUS_MODULATION_DUPOFDM</span>:
	<span class="k">case</span> <span class="n">AR9170_RX_STATUS_MODULATION_OFDM</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">plcp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AR9170_TXRX_PHY_RATE_OFDM_6M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR9170_TXRX_PHY_RATE_OFDM_9M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR9170_TXRX_PHY_RATE_OFDM_12M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR9170_TXRX_PHY_RATE_OFDM_18M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR9170_TXRX_PHY_RATE_OFDM_24M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR9170_TXRX_PHY_RATE_OFDM_36M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR9170_TXRX_PHY_RATE_OFDM_48M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR9170_TXRX_PHY_RATE_OFDM_54M</span>:
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;invalid plcp ofdm &quot;</span>
					<span class="s">&quot;rate (%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">plcp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AR9170_RX_STATUS_MODULATION_HT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">plcp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_40MHZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">plcp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORT_GI</span><span class="p">;</span>

		<span class="n">status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">plcp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="n">status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_HT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_rx_phy_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">ar9170_rx_phystatus</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_phystatus</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">20</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">status</span><span class="o">-&gt;</span><span class="n">antenna</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="cm">/* post-process RSSI */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

	<span class="cm">/* TODO: we could do something with phy_errors */</span>
	<span class="n">status</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rssi_combined</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">carl9170_rx_copy_data</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">reserved</span> <span class="o">+=</span> <span class="n">NET_IP_ALIGN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">qc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_A_MSDU_PRESENT</span><span class="p">)</span>
			<span class="n">reserved</span> <span class="o">+=</span> <span class="n">NET_IP_ALIGN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">reserved</span> <span class="o">+=</span> <span class="n">NET_IP_ALIGN</span><span class="p">;</span>

	<span class="n">reserved</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">+</span> <span class="p">(</span><span class="n">reserved</span> <span class="o">&amp;</span> <span class="n">NET_IP_ALIGN</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">reserved</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">reserved</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">carl9170_find_ie</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ie</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>

		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE:</span>
<span class="cm"> *</span>
<span class="cm"> * The firmware is in charge of waking up the device just before</span>
<span class="cm"> * the AP is expected to transmit the next beacon.</span>
<span class="cm"> *</span>
<span class="cm"> * This leaves the driver with the important task of deciding when</span>
<span class="cm"> * to set the PHY back to bed again.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_ps_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tim_ie</span> <span class="o">*</span><span class="n">tim_ie</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tim</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tim_len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cam</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* check if this really is a beacon */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* min. beacon length + FCS_LEN */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">40</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* and only beacons from the associated BSSID, please */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">curbssid</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">curaid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">last_beacon</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">tim</span> <span class="o">=</span> <span class="n">carl9170_find_ie</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">FCS_LEN</span><span class="p">,</span> <span class="n">WLAN_EID_TIM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tim</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tim_ie</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tim_len</span> <span class="o">=</span> <span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">tim_ie</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tim_ie</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tim</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">ps_dtim_period</span><span class="p">))</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">dtim_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">tim_ie</span><span class="o">-&gt;</span><span class="n">dtim_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">ps_dtim_period</span><span class="p">;</span>

	<span class="cm">/* Check whenever the PHY can be turned off again. */</span>

	<span class="cm">/* 1. What about buffered unicast traffic for our AID? */</span>
	<span class="n">cam</span> <span class="o">=</span> <span class="n">ieee80211_check_tim</span><span class="p">(</span><span class="n">tim_ie</span><span class="p">,</span> <span class="n">tim_len</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">curaid</span><span class="p">);</span>

	<span class="cm">/* 2. Maybe the AP wants to send multicast/broadcast data? */</span>
	<span class="n">cam</span> <span class="o">|=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tim_ie</span><span class="o">-&gt;</span><span class="n">bitmap_ctrl</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cam</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* back to low-power land. */</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">off_override</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PS_OFF_BCN</span><span class="p">;</span>
		<span class="n">carl9170_ps_check</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* force CAM */</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ps</span><span class="p">.</span><span class="n">off_override</span> <span class="o">|=</span> <span class="n">PS_OFF_BCN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">carl9170_ampdu_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ms</span> <span class="o">&amp;</span> <span class="n">AR9170_RX_STATUS_MPDU</span><span class="p">)</span> <span class="o">==</span> <span class="n">AR9170_RX_STATUS_MPDU_SINGLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This frame is not part of an aMPDU.</span>
<span class="cm">		 * Therefore it is not subjected to any</span>
<span class="cm">		 * of the following content restrictions.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * &quot;802.11n - 7.4a.3 A-MPDU contents&quot; describes in which contexts</span>
<span class="cm">	 * certain frame types can be part of an aMPDU.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In order to keep the processing cost down, I opted for a</span>
<span class="cm">	 * stateless filter solely based on the frame control field.</span>
<span class="cm">	 */</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ieee80211_is_data_present</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_ack</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">||</span> <span class="n">ieee80211_is_back</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ieee80211_is_back_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_action</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * If the frame alignment is right (or the kernel has</span>
<span class="cm"> * CONFIG_HAVE_EFFICIENT_UNALIGNED_ACCESS), and there</span>
<span class="cm"> * is only a single MPDU in the USB frame, then we could</span>
<span class="cm"> * submit to mac80211 the SKB directly. However, since</span>
<span class="cm"> * there may be multiple packets in one SKB in stream</span>
<span class="cm"> * mode, and we need to observe the proper ordering,</span>
<span class="cm"> * this is non-trivial.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_handle_mpdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar9170_rx_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ar9170_rx_macstatus</span> <span class="o">*</span><span class="n">mac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ar9170_rx_phystatus</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mpdu_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_STARTED</span><span class="p">(</span><span class="n">ar</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mac</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">mpdu_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mac</span><span class="p">);</span>

	<span class="n">mac</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">mpdu_len</span><span class="p">);</span>
	<span class="n">mac_status</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mac_status</span> <span class="o">&amp;</span> <span class="n">AR9170_RX_STATUS_MPDU</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR9170_RX_STATUS_MPDU_FIRST</span>:
		<span class="cm">/* Aggregated MPDUs start with an PLCP header */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">mpdu_len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_head</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * The PLCP header needs to be cached for the</span>
<span class="cm">			 * following MIDDLE + LAST A-MPDU packets.</span>
<span class="cm">			 *</span>
<span class="cm">			 * So, if you are wondering why all frames seem</span>
<span class="cm">			 * to share a common RX status information,</span>
<span class="cm">			 * then you have the answer right here...</span>
<span class="cm">			 */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_plcp</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_head</span><span class="p">));</span>

			<span class="n">mpdu_len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_head</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_head</span><span class="p">);</span>

			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_has_plcp</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;plcp info &quot;</span>
					<span class="s">&quot;is clipped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AR9170_RX_STATUS_MPDU_LAST</span>:
		<span class="cm">/*</span>
<span class="cm">		 * The last frame of an A-MPDU has an extra tail</span>
<span class="cm">		 * which does contain the phy status of the whole</span>
<span class="cm">		 * aggregate.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">mpdu_len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_phystatus</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">mpdu_len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_phystatus</span><span class="p">);</span>
			<span class="n">phy</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">mpdu_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;frame tail &quot;</span>
					<span class="s">&quot;is clipped.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">AR9170_RX_STATUS_MPDU_MIDDLE</span>:
		<span class="cm">/*  These are just data + mac status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_has_plcp</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="k">return</span><span class="p">;</span>

			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;rx stream does not start &quot;</span>
					<span class="s">&quot;with a first_mpdu frame tag.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_plcp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AR9170_RX_STATUS_MPDU_SINGLE</span>:
		<span class="cm">/* single mpdu has both: plcp (head) and phy status (tail) */</span>
		<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>

		<span class="n">mpdu_len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_head</span><span class="p">);</span>
		<span class="n">mpdu_len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_phystatus</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170_rx_head</span><span class="p">);</span>
		<span class="n">phy</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">mpdu_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FC + DU + RA + FCS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">mpdu_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ETH_ALEN</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">carl9170_rx_mac_status</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">carl9170_ampdu_check</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">mac_status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="p">)</span>
		<span class="n">carl9170_rx_phy_status</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">carl9170_ps_beacon</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">mpdu_len</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">carl9170_rx_copy_data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">mpdu_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="n">ieee80211_rx</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">drop:</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_rx_untie_cmds</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">respbuf</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resplen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">carl9170_rsp</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">resplen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">respbuf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">i</span> <span class="o">+=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">resplen</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">carl9170_handle_command_response</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">resplen</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">net_ratelimit</span><span class="p">())</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;malformed firmware trap:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;rxcmd:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
				     <span class="n">respbuf</span><span class="p">,</span> <span class="n">resplen</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__carl9170_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* weird thing, but this is the same in the original driver */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* found the 6 * 0xffff marker? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">carl9170_rx_untie_cmds</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">carl9170_handle_mpdu</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">carl9170_rx_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tlen</span><span class="p">,</span> <span class="n">wlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">clen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ar9170_stream</span> <span class="o">*</span><span class="n">rx_stream</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tbuf</span><span class="p">;</span>

	<span class="n">tbuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">tlen</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tlen</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_stream</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tbuf</span><span class="p">;</span>
		<span class="n">clen</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rx_stream</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">wlen</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">clen</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

		<span class="cm">/* check if this is stream has a valid tag.*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_stream</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">AR9170_RX_STREAM_TAG</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * TODO: handle the highly unlikely event that the</span>
<span class="cm">			 * corrupted stream has the TAG at the right position.</span>
<span class="cm">			 */</span>

			<span class="cm">/* check if the frame can be repaired. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover_missing</span><span class="p">)</span> <span class="p">{</span>

				<span class="cm">/* this is not &quot;short read&quot;. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
					<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
						<span class="s">&quot;missing tag!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">__carl9170_rx</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">,</span> <span class="n">tlen</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover_missing</span> <span class="o">&gt;</span> <span class="n">tlen</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
					<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
						<span class="s">&quot;possible multi &quot;</span>
						<span class="s">&quot;stream corruption!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">err_telluser</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">goto</span> <span class="n">err_silent</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover</span><span class="p">,</span> <span class="n">tlen</span><span class="p">),</span> <span class="n">tbuf</span><span class="p">,</span> <span class="n">tlen</span><span class="p">);</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover_missing</span> <span class="o">-=</span> <span class="n">tlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover_missing</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * nested carl9170_rx_stream call!</span>
<span class="cm">				 *</span>
<span class="cm">				 * termination is guaranteed, even when the</span>
<span class="cm">				 * combined frame also have an element with</span>
<span class="cm">				 * a bad tag.</span>
<span class="cm">				 */</span>

				<span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover_missing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">carl9170_rx_stream</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						   <span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

				<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover</span><span class="p">);</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* check if stream is clipped */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlen</span> <span class="o">&gt;</span> <span class="n">tlen</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover_missing</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* TODO: handle double stream corruption. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
					<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;double rx &quot;</span>
						<span class="s">&quot;stream corruption!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">err_telluser</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">goto</span> <span class="n">err_silent</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * save incomplete data set.</span>
<span class="cm">			 * the firmware will resend the missing bits when</span>
<span class="cm">			 * the rx - descriptor comes round again.</span>
<span class="cm">			 */</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover</span><span class="p">,</span> <span class="n">tlen</span><span class="p">),</span> <span class="n">tbuf</span><span class="p">,</span> <span class="n">tlen</span><span class="p">);</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover_missing</span> <span class="o">=</span> <span class="n">clen</span> <span class="o">-</span> <span class="n">tlen</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">__carl9170_rx</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">rx_stream</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">,</span> <span class="n">clen</span><span class="p">);</span>

		<span class="n">tbuf</span> <span class="o">+=</span> <span class="n">wlen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">tlen</span> <span class="o">-=</span> <span class="n">wlen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%d bytes of unprocessed &quot;</span>
				<span class="s">&quot;data left in rx stream!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tlen</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">err_telluser</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_telluser:</span>
	<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;damaged RX stream data [want:%d, &quot;</span>
		<span class="s">&quot;data:%d, rx:%d, pending:%d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">clen</span><span class="p">,</span> <span class="n">wlen</span><span class="p">,</span> <span class="n">tlen</span><span class="p">,</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover_missing</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover_missing</span><span class="p">)</span>
		<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;rxbuf:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
				     <span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				     <span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">print_hex_dump_bytes</span><span class="p">(</span><span class="s">&quot;stream:&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
			     <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">wiphy_err</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;please check your hardware and cables, if &quot;</span>
		<span class="s">&quot;you see this message frequently.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">err_silent:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover_missing</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover</span><span class="p">);</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_failover_missing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">carl9170_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9170</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">rx_stream</span><span class="p">)</span>
		<span class="n">carl9170_rx_stream</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">__carl9170_rx</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
