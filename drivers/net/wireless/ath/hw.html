<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2009 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;ath.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>

<span class="cp">#define REG_READ	(common-&gt;ops-&gt;read)</span>
<span class="cp">#define REG_WRITE	(common-&gt;ops-&gt;write)</span>

<span class="cm">/**</span>
<span class="cm"> * ath_hw_set_bssid_mask - filter out bssids we listen</span>
<span class="cm"> *</span>
<span class="cm"> * @common: the ath_common struct for the device.</span>
<span class="cm"> *</span>
<span class="cm"> * BSSID masking is a method used by AR5212 and newer hardware to inform PCU</span>
<span class="cm"> * which bits of the interface&#39;s MAC address should be looked at when trying</span>
<span class="cm"> * to decide which packets to ACK. In station mode and AP mode with a single</span>
<span class="cm"> * BSS every bit matters since we lock to only one BSS. In AP mode with</span>
<span class="cm"> * multiple BSSes (virtual interfaces) not every bit matters because hw must</span>
<span class="cm"> * accept frames for all BSSes and so we tweak some bits of our mac address</span>
<span class="cm"> * in order to have multiple BSSes.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: This is a simple filter and does *not* filter out all</span>
<span class="cm"> * relevant frames. Some frames that are not for us might get ACKed from us</span>
<span class="cm"> * by PCU because they just match the mask.</span>
<span class="cm"> *</span>
<span class="cm"> * When handling multiple BSSes you can get the BSSID mask by computing the</span>
<span class="cm"> * set of  ~ ( MAC XOR BSSID ) for all bssids we handle.</span>
<span class="cm"> *</span>
<span class="cm"> * When you do this you are essentially computing the common bits of all your</span>
<span class="cm"> * BSSes. Later it is assumed the hardware will &quot;and&quot; (&amp;) the BSSID mask with</span>
<span class="cm"> * the MAC address to obtain the relevant bits and compare the result with</span>
<span class="cm"> * (frame&#39;s BSSID &amp; mask) to see if they match.</span>
<span class="cm"> *</span>
<span class="cm"> * Simple example: on your card you have have two BSSes you have created with</span>
<span class="cm"> * BSSID-01 and BSSID-02. Lets assume BSSID-01 will not use the MAC address.</span>
<span class="cm"> * There is another BSSID-03 but you are not part of it. For simplicity&#39;s sake,</span>
<span class="cm"> * assuming only 4 bits for a mac address and for BSSIDs you can then have:</span>
<span class="cm"> *</span>
<span class="cm"> *                  \</span>
<span class="cm"> * MAC:        0001 |</span>
<span class="cm"> * BSSID-01:   0100 | --&gt; Belongs to us</span>
<span class="cm"> * BSSID-02:   1001 |</span>
<span class="cm"> *                  /</span>
<span class="cm"> * -------------------</span>
<span class="cm"> * BSSID-03:   0110  | --&gt; External</span>
<span class="cm"> * -------------------</span>
<span class="cm"> *</span>
<span class="cm"> * Our bssid_mask would then be:</span>
<span class="cm"> *</span>
<span class="cm"> *             On loop iteration for BSSID-01:</span>
<span class="cm"> *             ~(0001 ^ 0100)  -&gt; ~(0101)</span>
<span class="cm"> *                             -&gt;   1010</span>
<span class="cm"> *             bssid_mask      =    1010</span>
<span class="cm"> *</span>
<span class="cm"> *             On loop iteration for BSSID-02:</span>
<span class="cm"> *             bssid_mask &amp;= ~(0001   ^   1001)</span>
<span class="cm"> *             bssid_mask =   (1010)  &amp; ~(0001 ^ 1001)</span>
<span class="cm"> *             bssid_mask =   (1010)  &amp; ~(1000)</span>
<span class="cm"> *             bssid_mask =   (1010)  &amp;  (0111)</span>
<span class="cm"> *             bssid_mask =   0010</span>
<span class="cm"> *</span>
<span class="cm"> * A bssid_mask of 0010 means &quot;only pay attention to the second least</span>
<span class="cm"> * significant bit&quot;. This is because its the only bit common</span>
<span class="cm"> * amongst the MAC and all BSSIDs we support. To findout what the real</span>
<span class="cm"> * common bit is we can simply &quot;&amp;&quot; the bssid_mask now with any BSSID we have</span>
<span class="cm"> * or our MAC address (we assume the hardware uses the MAC address).</span>
<span class="cm"> *</span>
<span class="cm"> * Now, suppose there&#39;s an incoming frame for BSSID-03:</span>
<span class="cm"> *</span>
<span class="cm"> * IFRAME-01:  0110</span>
<span class="cm"> *</span>
<span class="cm"> * An easy eye-inspeciton of this already should tell you that this frame</span>
<span class="cm"> * will not pass our check. This is because the bssid_mask tells the</span>
<span class="cm"> * hardware to only look at the second least significant bit and the</span>
<span class="cm"> * common bit amongst the MAC and BSSIDs is 0, this frame has the 2nd LSB</span>
<span class="cm"> * as 1, which does not match 0.</span>
<span class="cm"> *</span>
<span class="cm"> * So with IFRAME-01 we *assume* the hardware will do:</span>
<span class="cm"> *</span>
<span class="cm"> *     allow = (IFRAME-01 &amp; bssid_mask) == (bssid_mask &amp; MAC) ? 1 : 0;</span>
<span class="cm"> *  --&gt; allow = (0110 &amp; 0010) == (0010 &amp; 0001) ? 1 : 0;</span>
<span class="cm"> *  --&gt; allow = (0010) == 0000 ? 1 : 0;</span>
<span class="cm"> *  --&gt; allow = 0</span>
<span class="cm"> *</span>
<span class="cm"> *  Lets now test a frame that should work:</span>
<span class="cm"> *</span>
<span class="cm"> * IFRAME-02:  0001 (we should allow)</span>
<span class="cm"> *</span>
<span class="cm"> *     allow = (IFRAME-02 &amp; bssid_mask) == (bssid_mask &amp; MAC) ? 1 : 0;</span>
<span class="cm"> *  --&gt; allow = (0001 &amp; 0010) ==  (0010 &amp; 0001) ? 1 :0;</span>
<span class="cm"> *  --&gt; allow = (0000) == (0000)</span>
<span class="cm"> *  --&gt; allow = 1</span>
<span class="cm"> *</span>
<span class="cm"> * Other examples:</span>
<span class="cm"> *</span>
<span class="cm"> * IFRAME-03:  0100 --&gt; allowed</span>
<span class="cm"> * IFRAME-04:  1001 --&gt; allowed</span>
<span class="cm"> * IFRAME-05:  1101 --&gt; allowed but its not for us!!!</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ath_hw_setbssidmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bssidmask</span><span class="p">),</span> <span class="n">AR_BSSMSKL</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bssidmask</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span> <span class="n">AR_BSSMSKU</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath_hw_setbssidmask</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * ath_hw_cycle_counters_update - common function to update cycle counters</span>
<span class="cm"> *</span>
<span class="cm"> * @common: the ath_common struct for the device.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is used to update all cycle counters in one place.</span>
<span class="cm"> * It has to be called while holding common-&gt;cc_lock!</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ath_hw_cycle_counters_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cycles</span><span class="p">,</span> <span class="n">busy</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">tx</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>

	<span class="cm">/* freeze */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MIBC_FMC</span><span class="p">,</span> <span class="n">AR_MIBC</span><span class="p">);</span>

	<span class="cm">/* read */</span>
	<span class="n">cycles</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CCCNT</span><span class="p">);</span>
	<span class="n">busy</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RCCNT</span><span class="p">);</span>
	<span class="n">rx</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RFCNT</span><span class="p">);</span>
	<span class="n">tx</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TFCNT</span><span class="p">);</span>

	<span class="cm">/* clear */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR_CCCNT</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR_RFCNT</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR_RCCNT</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR_TFCNT</span><span class="p">);</span>

	<span class="cm">/* unfreeze */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR_MIBC</span><span class="p">);</span>

	<span class="cm">/* update all cycle counters here */</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_ani</span><span class="p">.</span><span class="n">cycles</span> <span class="o">+=</span> <span class="n">cycles</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_ani</span><span class="p">.</span><span class="n">rx_busy</span> <span class="o">+=</span> <span class="n">busy</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_ani</span><span class="p">.</span><span class="n">rx_frame</span> <span class="o">+=</span> <span class="n">rx</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_ani</span><span class="p">.</span><span class="n">tx_frame</span> <span class="o">+=</span> <span class="n">tx</span><span class="p">;</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_survey</span><span class="p">.</span><span class="n">cycles</span> <span class="o">+=</span> <span class="n">cycles</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_survey</span><span class="p">.</span><span class="n">rx_busy</span> <span class="o">+=</span> <span class="n">busy</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_survey</span><span class="p">.</span><span class="n">rx_frame</span> <span class="o">+=</span> <span class="n">rx</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_survey</span><span class="p">.</span><span class="n">tx_frame</span> <span class="o">+=</span> <span class="n">tx</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath_hw_cycle_counters_update</span><span class="p">);</span>

<span class="kt">int32_t</span> <span class="nf">ath_hw_get_listen_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_cycle_counters</span> <span class="o">*</span><span class="n">cc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_ani</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">listen_time</span><span class="p">;</span>

	<span class="n">listen_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cycles</span> <span class="o">-</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">rx_frame</span> <span class="o">-</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">tx_frame</span><span class="p">)</span> <span class="o">/</span>
		      <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">clockrate</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cc</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">listen_time</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath_hw_get_listen_time</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
