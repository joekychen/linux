<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath5k › qcu.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>qcu.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004-2008 Reyk Floeter &lt;reyk@openbsd.org&gt;</span>
<span class="cm"> * Copyright (c) 2006-2008 Nick Kossifidis &lt;mickflemm@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/********************************************\</span>
<span class="cm">Queue Control Unit, DCF Control Unit Functions</span>
<span class="cm">\********************************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &quot;ath5k.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>

<span class="cm">/**</span>
<span class="cm"> * DOC: Queue Control Unit (QCU)/DCF Control Unit (DCU) functions</span>
<span class="cm"> *</span>
<span class="cm"> * Here we setup parameters for the 12 available TX queues. Note that</span>
<span class="cm"> * on the various registers we can usually only map the first 10 of them so</span>
<span class="cm"> * basically we have 10 queues to play with. Each queue has a matching</span>
<span class="cm"> * QCU that controls when the queue will get triggered and multiple QCUs</span>
<span class="cm"> * can be mapped to a single DCU that controls the various DFS parameters</span>
<span class="cm"> * for the various queues. In our setup we have a 1:1 mapping between QCUs</span>
<span class="cm"> * and DCUs allowing us to have different DFS settings for each queue.</span>
<span class="cm"> *</span>
<span class="cm"> * When a frame goes into a TX queue, QCU decides when it&#39;ll trigger a</span>
<span class="cm"> * transmission based on various criteria (such as how many data we have inside</span>
<span class="cm"> * it&#39;s buffer or -if it&#39;s a beacon queue- if it&#39;s time to fire up the queue</span>
<span class="cm"> * based on TSF etc), DCU adds backoff, IFSes etc and then a scheduler</span>
<span class="cm"> * (arbitrator) decides the priority of each QCU based on it&#39;s configuration</span>
<span class="cm"> * (e.g. beacons are always transmitted when they leave DCU bypassing all other</span>
<span class="cm"> * frames from other queues waiting to be transmitted). After a frame leaves</span>
<span class="cm"> * the DCU it goes to PCU for further processing and then to PHY for</span>
<span class="cm"> * the actual transmission.</span>
<span class="cm"> */</span>


<span class="cm">/******************\</span>
<span class="cm">* Helper functions *</span>
<span class="cm">\******************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_num_tx_pending() - Get number of pending frames for a  given queue</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @queue: One of enum ath5k_tx_queue_id</span>
<span class="cm"> */</span>
<span class="n">u32</span>
<span class="nf">ath5k_hw_num_tx_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pending</span><span class="p">;</span>
	<span class="n">AR5K_ASSERT_ENTRY</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_queues</span><span class="p">.</span><span class="n">q_tx_num</span><span class="p">);</span>

	<span class="cm">/* Return if queue is declared inactive */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">tqi_type</span> <span class="o">==</span> <span class="n">AR5K_TX_QUEUE_INACTIVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* XXX: How about AR5K_CFG_TXCNT ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">pending</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_STATUS</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">pending</span> <span class="o">&amp;=</span> <span class="n">AR5K_QCU_STS_FRMPENDCNT</span><span class="p">;</span>

	<span class="cm">/* It&#39;s possible to have no frames pending even if TXE</span>
<span class="cm">	 * is set. To indicate that q has not stopped return</span>
<span class="cm">	 * true */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pending</span> <span class="o">&amp;&amp;</span> <span class="n">AR5K_REG_READ_Q</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QCU_TXE</span><span class="p">,</span> <span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pending</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_release_tx_queue() - Set a transmit queue inactive</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @queue: One of enum ath5k_tx_queue_id</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_hw_release_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_queues</span><span class="p">.</span><span class="n">q_tx_num</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* This queue will be skipped in further operations */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">tqi_type</span> <span class="o">=</span> <span class="n">AR5K_TX_QUEUE_INACTIVE</span><span class="p">;</span>
	<span class="cm">/*For SIMR setup*/</span>
	<span class="n">AR5K_Q_DISABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_status</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_cw_validate() - Make sure the given cw is valid</span>
<span class="cm"> * @cw_req: The contention window value to check</span>
<span class="cm"> *</span>
<span class="cm"> * Make sure cw is a power of 2 minus 1 and smaller than 1024</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span>
<span class="nf">ath5k_cw_validate</span><span class="p">(</span><span class="n">u16</span> <span class="n">cw_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cw_req</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cw_req</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="mi">1023</span><span class="p">);</span>

	<span class="cm">/* Check if cw_req + 1 a power of 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">cw_req</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cw_req</span><span class="p">;</span>

	<span class="cm">/* Check if cw_req is a power of 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_power_of_2</span><span class="p">(</span><span class="n">cw_req</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">cw_req</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* If none of the above is correct</span>
<span class="cm">	 * find the closest power of 2 */</span>
	<span class="n">cw_req</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">roundup_pow_of_two</span><span class="p">(</span><span class="n">cw_req</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cw_req</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_get_tx_queueprops() - Get properties for a transmit queue</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @queue: One of enum ath5k_tx_queue_id</span>
<span class="cm"> * @queue_info: The &amp;struct ath5k_txq_info to fill</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_get_tx_queueprops</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ath5k_txq_info</span> <span class="o">*</span><span class="n">queue_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">queue_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_txq_info</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_set_tx_queueprops() - Set properties for a transmit queue</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @queue: One of enum ath5k_tx_queue_id</span>
<span class="cm"> * @qinfo: The &amp;struct ath5k_txq_info to use</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or -EIO if queue is inactive</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_set_tx_queueprops</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">ath5k_txq_info</span> <span class="o">*</span><span class="n">qinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_txq_info</span> <span class="o">*</span><span class="n">qi</span><span class="p">;</span>

	<span class="n">AR5K_ASSERT_ENTRY</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_queues</span><span class="p">.</span><span class="n">q_tx_num</span><span class="p">);</span>

	<span class="n">qi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq</span><span class="p">[</span><span class="n">queue</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_type</span> <span class="o">==</span> <span class="n">AR5K_TX_QUEUE_INACTIVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* copy and validate values */</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_type</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_type</span><span class="p">;</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_subtype</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_subtype</span><span class="p">;</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_flags</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * According to the docs: Although the AIFS field is 8 bit wide,</span>
<span class="cm">	 * the maximum supported value is 0xFC. Setting it higher than that</span>
<span class="cm">	 * will cause the DCU to hang.</span>
<span class="cm">	 */</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_aifs</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_aifs</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="mh">0xFC</span><span class="p">);</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_cw_min</span> <span class="o">=</span> <span class="n">ath5k_cw_validate</span><span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_cw_min</span><span class="p">);</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_cw_max</span> <span class="o">=</span> <span class="n">ath5k_cw_validate</span><span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_cw_max</span><span class="p">);</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_cbr_period</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_cbr_period</span><span class="p">;</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_cbr_overflow_limit</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_cbr_overflow_limit</span><span class="p">;</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_burst_time</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_burst_time</span><span class="p">;</span>
	<span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_ready_time</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_ready_time</span><span class="p">;</span>

	<span class="cm">/*XXX: Is this supported on 5210 ?*/</span>
	<span class="cm">/*XXX: Is this correct for AR5K_WME_AC_VI,VO ???*/</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_type</span> <span class="o">==</span> <span class="n">AR5K_TX_QUEUE_DATA</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_subtype</span> <span class="o">==</span> <span class="n">AR5K_WME_AC_VI</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_subtype</span> <span class="o">==</span> <span class="n">AR5K_WME_AC_VO</span><span class="p">)))</span> <span class="o">||</span>
	     <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_type</span> <span class="o">==</span> <span class="n">AR5K_TX_QUEUE_UAPSD</span><span class="p">)</span>
		<span class="n">qi</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">|=</span> <span class="n">AR5K_TXQ_FLAG_POST_FR_BKOFF_DIS</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_setup_tx_queue() - Initialize a transmit queue</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @queue_type: One of enum ath5k_tx_queue</span>
<span class="cm"> * @queue_info: The &amp;struct ath5k_txq_info to use</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, -EINVAL on invalid arguments</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_setup_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ath5k_tx_queue</span> <span class="n">queue_type</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ath5k_txq_info</span> <span class="o">*</span><span class="n">queue_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get queue by type</span>
<span class="cm">	 */</span>
	<span class="cm">/* 5210 only has 2 queues */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_queues</span><span class="p">.</span><span class="n">q_tx_num</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">queue_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AR5K_TX_QUEUE_DATA</span>:
			<span class="n">queue</span> <span class="o">=</span> <span class="n">AR5K_TX_QUEUE_ID_NOQCU_DATA</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR5K_TX_QUEUE_BEACON</span>:
		<span class="k">case</span> <span class="n">AR5K_TX_QUEUE_CAB</span>:
			<span class="n">queue</span> <span class="o">=</span> <span class="n">AR5K_TX_QUEUE_ID_NOQCU_BEACON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">queue_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AR5K_TX_QUEUE_DATA</span>:
			<span class="k">for</span> <span class="p">(</span><span class="n">queue</span> <span class="o">=</span> <span class="n">AR5K_TX_QUEUE_ID_DATA_MIN</span><span class="p">;</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">tqi_type</span> <span class="o">!=</span>
				<span class="n">AR5K_TX_QUEUE_INACTIVE</span><span class="p">;</span> <span class="n">queue</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;</span> <span class="n">AR5K_TX_QUEUE_ID_DATA_MAX</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR5K_TX_QUEUE_UAPSD</span>:
			<span class="n">queue</span> <span class="o">=</span> <span class="n">AR5K_TX_QUEUE_ID_UAPSD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR5K_TX_QUEUE_BEACON</span>:
			<span class="n">queue</span> <span class="o">=</span> <span class="n">AR5K_TX_QUEUE_ID_BEACON</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR5K_TX_QUEUE_CAB</span>:
			<span class="n">queue</span> <span class="o">=</span> <span class="n">AR5K_TX_QUEUE_ID_CAB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup internal queue structure</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq</span><span class="p">[</span><span class="n">queue</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_txq_info</span><span class="p">));</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">tqi_type</span> <span class="o">=</span> <span class="n">queue_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue_info</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue_info</span><span class="o">-&gt;</span><span class="n">tqi_type</span> <span class="o">=</span> <span class="n">queue_type</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_set_tx_queueprops</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">queue_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We use ah_txq_status to hold a temp value for</span>
<span class="cm">	 * the Secondary interrupt mask registers on 5211+</span>
<span class="cm">	 * check out ath5k_hw_reset_tx_queue</span>
<span class="cm">	 */</span>
	<span class="n">AR5K_Q_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_status</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">queue</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*******************************\</span>
<span class="cm">* Single QCU/DCU initialization *</span>
<span class="cm">\*******************************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_set_tx_retry_limits() - Set tx retry limits on DCU</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @queue: One of enum ath5k_tx_queue_id</span>
<span class="cm"> *</span>
<span class="cm"> * This function is used when initializing a queue, to set</span>
<span class="cm"> * retry limits based on ah-&gt;ah_retry_* and the chipset used.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_hw_set_tx_retry_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Single data queue on AR5210 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ath5k_txq_info</span> <span class="o">*</span><span class="n">tq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq</span><span class="p">[</span><span class="n">queue</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_cw_min</span> <span class="o">&lt;&lt;</span> <span class="n">AR5K_NODCU_RETRY_LMT_CW_MIN_S</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_retry_long</span><span class="p">,</span>
				      <span class="n">AR5K_NODCU_RETRY_LMT_SLG_RETRY</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_retry_short</span><span class="p">,</span>
				      <span class="n">AR5K_NODCU_RETRY_LMT_SSH_RETRY</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_retry_long</span><span class="p">,</span>
				      <span class="n">AR5K_NODCU_RETRY_LMT_LG_RETRY</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_retry_short</span><span class="p">,</span>
				      <span class="n">AR5K_NODCU_RETRY_LMT_SH_RETRY</span><span class="p">),</span>
			<span class="n">AR5K_NODCU_RETRY_LMT</span><span class="p">);</span>
	<span class="cm">/* DCU on AR5211+ */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_retry_long</span><span class="p">,</span>
				    <span class="n">AR5K_DCU_RETRY_LMT_RTS</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_retry_long</span><span class="p">,</span>
				      <span class="n">AR5K_DCU_RETRY_LMT_STA_RTS</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_retry_long</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_retry_short</span><span class="p">),</span>
				      <span class="n">AR5K_DCU_RETRY_LMT_STA_DATA</span><span class="p">),</span>
			<span class="n">AR5K_QUEUE_DFS_RETRY_LIMIT</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_reset_tx_queue() - Initialize a single hw queue</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @queue: One of enum ath5k_tx_queue_id</span>
<span class="cm"> *</span>
<span class="cm"> * Set DCF properties for the given transmit queue on DCU</span>
<span class="cm"> * and configures all queue-specific parameters.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_reset_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_txq_info</span> <span class="o">*</span><span class="n">tq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq</span><span class="p">[</span><span class="n">queue</span><span class="p">];</span>

	<span class="n">AR5K_ASSERT_ENTRY</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_queues</span><span class="p">.</span><span class="n">q_tx_num</span><span class="p">);</span>

	<span class="n">tq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq</span><span class="p">[</span><span class="n">queue</span><span class="p">];</span>

	<span class="cm">/* Skip if queue inactive or if we are on AR5210</span>
<span class="cm">	 * that doesn&#39;t have QCU/DCU */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="o">||</span>
	<span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_type</span> <span class="o">==</span> <span class="n">AR5K_TX_QUEUE_INACTIVE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set contention window (cw_min/cw_max)</span>
<span class="cm">	 * and arbitrated interframe space (aifs)...</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
		<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_cw_min</span><span class="p">,</span> <span class="n">AR5K_DCU_LCL_IFS_CW_MIN</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_cw_max</span><span class="p">,</span> <span class="n">AR5K_DCU_LCL_IFS_CW_MAX</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_aifs</span><span class="p">,</span> <span class="n">AR5K_DCU_LCL_IFS_AIFS</span><span class="p">),</span>
		<span class="n">AR5K_QUEUE_DFS_LOCAL_IFS</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set tx retry limits for this queue</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_hw_set_tx_retry_limits</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * Set misc registers</span>
<span class="cm">	 */</span>

	<span class="cm">/* Enable DCU to wait for next fragment from QCU */</span>
	<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_DFS_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
				<span class="n">AR5K_DCU_MISC_FRAG_WAIT</span><span class="p">);</span>

	<span class="cm">/* On Maui and Spirit use the global seqnum on DCU */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_version</span> <span class="o">&lt;</span> <span class="n">AR5K_SREV_AR5211</span><span class="p">)</span>
		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_DFS_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
					<span class="n">AR5K_DCU_MISC_SEQNUM_CTL</span><span class="p">);</span>

	<span class="cm">/* Constant bit rate period */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_cbr_period</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_cbr_period</span><span class="p">,</span>
					<span class="n">AR5K_QCU_CBRCFG_INTVAL</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_cbr_overflow_limit</span><span class="p">,</span>
					<span class="n">AR5K_QCU_CBRCFG_ORN_THRES</span><span class="p">),</span>
					<span class="n">AR5K_QUEUE_CBRCFG</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>

		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
					<span class="n">AR5K_QCU_MISC_FRSHED_CBR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_cbr_overflow_limit</span><span class="p">)</span>
			<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
					<span class="n">AR5K_QCU_MISC_CBR_THRES_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Ready time interval */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_ready_time</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_type</span> <span class="o">!=</span> <span class="n">AR5K_TX_QUEUE_CAB</span><span class="p">))</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_ready_time</span><span class="p">,</span>
					<span class="n">AR5K_QCU_RDYTIMECFG_INTVAL</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">AR5K_QCU_RDYTIMECFG_ENABLE</span><span class="p">,</span>
					<span class="n">AR5K_QUEUE_RDYTIMECFG</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_burst_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_burst_time</span><span class="p">,</span>
					<span class="n">AR5K_DCU_CHAN_TIME_DUR</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">AR5K_DCU_CHAN_TIME_ENABLE</span><span class="p">,</span>
					<span class="n">AR5K_QUEUE_DFS_CHANNEL_TIME</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_RDYTIME_EXP_POLICY_ENABLE</span><span class="p">)</span>
			<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
					<span class="n">AR5K_QCU_MISC_RDY_VEOL_POLICY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable/disable Post frame backoff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_BACKOFF_DISABLE</span><span class="p">)</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_DCU_MISC_POST_FR_BKOFF_DIS</span><span class="p">,</span>
					<span class="n">AR5K_QUEUE_DFS_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>

	<span class="cm">/* Enable/disable fragmentation burst backoff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_FRAG_BURST_BACKOFF_ENABLE</span><span class="p">)</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_DCU_MISC_BACKOFF_FRAG</span><span class="p">,</span>
					<span class="n">AR5K_QUEUE_DFS_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set registers by queue type</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_TX_QUEUE_BEACON</span>:
		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
				<span class="n">AR5K_QCU_MISC_FRSHED_DBA_GT</span> <span class="o">|</span>
				<span class="n">AR5K_QCU_MISC_CBREXP_BCN_DIS</span> <span class="o">|</span>
				<span class="n">AR5K_QCU_MISC_BCN_ENABLE</span><span class="p">);</span>

		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_DFS_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
				<span class="p">(</span><span class="n">AR5K_DCU_MISC_ARBLOCK_CTL_GLOBAL</span> <span class="o">&lt;&lt;</span>
				<span class="n">AR5K_DCU_MISC_ARBLOCK_CTL_S</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">AR5K_DCU_MISC_ARBLOCK_IGNORE</span> <span class="o">|</span>
				<span class="n">AR5K_DCU_MISC_POST_FR_BKOFF_DIS</span> <span class="o">|</span>
				<span class="n">AR5K_DCU_MISC_BCN_ENABLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AR5K_TX_QUEUE_CAB</span>:
		<span class="cm">/* XXX: use BCN_SENT_GT, if we can figure out how */</span>
		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
					<span class="n">AR5K_QCU_MISC_FRSHED_DBA_GT</span> <span class="o">|</span>
					<span class="n">AR5K_QCU_MISC_CBREXP_DIS</span> <span class="o">|</span>
					<span class="n">AR5K_QCU_MISC_CBREXP_BCN_DIS</span><span class="p">);</span>

		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="p">((</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_ready_time</span> <span class="o">-</span>
					<span class="p">(</span><span class="n">AR5K_TUNE_SW_BEACON_RESP</span> <span class="o">-</span>
					<span class="n">AR5K_TUNE_DMA_BEACON_RESP</span><span class="p">)</span> <span class="o">-</span>
				<span class="n">AR5K_TUNE_ADDITIONAL_SWBA_BACKOFF</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">AR5K_QCU_RDYTIMECFG_ENABLE</span><span class="p">,</span>
					<span class="n">AR5K_QUEUE_RDYTIMECFG</span><span class="p">(</span><span class="n">queue</span><span class="p">));</span>

		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_DFS_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
					<span class="p">(</span><span class="n">AR5K_DCU_MISC_ARBLOCK_CTL_GLOBAL</span> <span class="o">&lt;&lt;</span>
					<span class="n">AR5K_DCU_MISC_ARBLOCK_CTL_S</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AR5K_TX_QUEUE_UAPSD</span>:
		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_MISC</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
					<span class="n">AR5K_QCU_MISC_CBREXP_DIS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AR5K_TX_QUEUE_DATA</span>:
	<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: Handle frame compression */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable interrupts for this tx queue</span>
<span class="cm">	 * in the secondary interrupt mask registers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_TXOKINT_ENABLE</span><span class="p">)</span>
		<span class="n">AR5K_Q_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txok</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_TXERRINT_ENABLE</span><span class="p">)</span>
		<span class="n">AR5K_Q_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txerr</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_TXURNINT_ENABLE</span><span class="p">)</span>
		<span class="n">AR5K_Q_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txurn</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_TXDESCINT_ENABLE</span><span class="p">)</span>
		<span class="n">AR5K_Q_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txdesc</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_TXEOLINT_ENABLE</span><span class="p">)</span>
		<span class="n">AR5K_Q_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txeol</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_CBRORNINT_ENABLE</span><span class="p">)</span>
		<span class="n">AR5K_Q_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_cbrorn</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_CBRURNINT_ENABLE</span><span class="p">)</span>
		<span class="n">AR5K_Q_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_cbrurn</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_QTRIGINT_ENABLE</span><span class="p">)</span>
		<span class="n">AR5K_Q_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_qtrig</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tq</span><span class="o">-&gt;</span><span class="n">tqi_flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXQ_FLAG_TXNOFRMINT_ENABLE</span><span class="p">)</span>
		<span class="n">AR5K_Q_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_nofrm</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="cm">/* Update secondary interrupt mask registers */</span>

	<span class="cm">/* Filter out inactive queues */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txok</span> <span class="o">&amp;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_status</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txerr</span> <span class="o">&amp;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_status</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txurn</span> <span class="o">&amp;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_status</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txdesc</span> <span class="o">&amp;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_status</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txeol</span> <span class="o">&amp;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_status</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_cbrorn</span> <span class="o">&amp;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_status</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_cbrurn</span> <span class="o">&amp;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_status</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_qtrig</span> <span class="o">&amp;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_status</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_nofrm</span> <span class="o">&amp;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_status</span><span class="p">;</span>

	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txok</span><span class="p">,</span>
					<span class="n">AR5K_SIMR0_QCU_TXOK</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txdesc</span><span class="p">,</span>
					<span class="n">AR5K_SIMR0_QCU_TXDESC</span><span class="p">),</span>
					<span class="n">AR5K_SIMR0</span><span class="p">);</span>

	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txerr</span><span class="p">,</span>
					<span class="n">AR5K_SIMR1_QCU_TXERR</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txeol</span><span class="p">,</span>
					<span class="n">AR5K_SIMR1_QCU_TXEOL</span><span class="p">),</span>
					<span class="n">AR5K_SIMR1</span><span class="p">);</span>

	<span class="cm">/* Update SIMR2 but don&#39;t overwrite rest simr2 settings */</span>
	<span class="n">AR5K_REG_DISABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_SIMR2</span><span class="p">,</span> <span class="n">AR5K_SIMR2_QCU_TXURN</span><span class="p">);</span>
	<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_SIMR2</span><span class="p">,</span>
				<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_txurn</span><span class="p">,</span>
				<span class="n">AR5K_SIMR2_QCU_TXURN</span><span class="p">));</span>

	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_cbrorn</span><span class="p">,</span>
				<span class="n">AR5K_SIMR3_QCBRORN</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_cbrurn</span><span class="p">,</span>
				<span class="n">AR5K_SIMR3_QCBRURN</span><span class="p">),</span>
				<span class="n">AR5K_SIMR3</span><span class="p">);</span>

	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_qtrig</span><span class="p">,</span>
				<span class="n">AR5K_SIMR4_QTRIG</span><span class="p">),</span> <span class="n">AR5K_SIMR4</span><span class="p">);</span>

	<span class="cm">/* Set TXNOFRM_QCU for the queues with TXNOFRM enabled */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_nofrm</span><span class="p">,</span>
				<span class="n">AR5K_TXNOFRM_QCU</span><span class="p">),</span> <span class="n">AR5K_TXNOFRM</span><span class="p">);</span>

	<span class="cm">/* No queue has TXNOFRM enabled, disable the interrupt</span>
<span class="cm">	 * by setting AR5K_TXNOFRM to zero */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_imr_nofrm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_TXNOFRM</span><span class="p">);</span>

	<span class="cm">/* Set QCU mask for this DCU to save power */</span>
	<span class="n">AR5K_REG_WRITE_Q</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_QUEUE_QCUMASK</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************\</span>
<span class="cm">* Global QCU/DCU functions *</span>
<span class="cm">\**************************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_set_ifs_intervals()  - Set global inter-frame spaces on DCU</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @slot_time: Slot time in us</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the global IFS intervals on DCU (also works on AR5210) for</span>
<span class="cm"> * the given slot time and the current bwmode.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ath5k_hw_set_ifs_intervals</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_current_channel</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ack_tx_time</span><span class="p">,</span> <span class="n">eifs</span><span class="p">,</span> <span class="n">eifs_clock</span><span class="p">,</span> <span class="n">sifs</span><span class="p">,</span> <span class="n">sifs_clock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">slot_time_clock</span> <span class="o">=</span> <span class="n">ath5k_hw_htoclock</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">slot_time</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slot_time</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">slot_time_clock</span> <span class="o">&gt;</span> <span class="n">AR5K_SLOT_TIME_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sifs</span> <span class="o">=</span> <span class="n">ath5k_hw_get_default_sifs</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">sifs_clock</span> <span class="o">=</span> <span class="n">ath5k_hw_htoclock</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sifs</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* EIFS</span>
<span class="cm">	 * Txtime of ack at lowest rate + SIFS + DIFS</span>
<span class="cm">	 * (DIFS = SIFS + 2 * Slot time)</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: HAL has some predefined values for EIFS</span>
<span class="cm">	 * Turbo:   (37 + 2 * 6)</span>
<span class="cm">	 * Default: (74 + 2 * 9)</span>
<span class="cm">	 * Half:    (149 + 2 * 13)</span>
<span class="cm">	 * Quarter: (298 + 2 * 21)</span>
<span class="cm">	 *</span>
<span class="cm">	 * (74 + 2 * 6) for AR5210 default and turbo !</span>
<span class="cm">	 *</span>
<span class="cm">	 * According to the formula we have</span>
<span class="cm">	 * ack_tx_time = 25 for turbo and</span>
<span class="cm">	 * ack_tx_time = 42.5 * clock multiplier</span>
<span class="cm">	 * for default/half/quarter.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This can&#39;t be right, 42 is what we would get</span>
<span class="cm">	 * from ath5k_hw_get_frame_dur_for_bwmode or</span>
<span class="cm">	 * ieee80211_generic_frame_duration for zero frame</span>
<span class="cm">	 * length and without SIFS !</span>
<span class="cm">	 *</span>
<span class="cm">	 * Also we have different lowest rate for 802.11a</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">band</span><span class="p">].</span><span class="n">bitrates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ack_tx_time</span> <span class="o">=</span> <span class="n">ath5k_hw_get_frame_duration</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* ack_tx_time includes an SIFS already */</span>
	<span class="n">eifs</span> <span class="o">=</span> <span class="n">ack_tx_time</span> <span class="o">+</span> <span class="n">sifs</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">slot_time</span><span class="p">;</span>
	<span class="n">eifs_clock</span> <span class="o">=</span> <span class="n">ath5k_hw_htoclock</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">eifs</span><span class="p">);</span>

	<span class="cm">/* Set IFS settings on AR5210 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">pifs</span><span class="p">,</span> <span class="n">pifs_clock</span><span class="p">,</span> <span class="n">difs</span><span class="p">,</span> <span class="n">difs_clock</span><span class="p">;</span>

		<span class="cm">/* Set slot time */</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">slot_time_clock</span><span class="p">,</span> <span class="n">AR5K_SLOT_TIME</span><span class="p">);</span>

		<span class="cm">/* Set EIFS */</span>
		<span class="n">eifs_clock</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">eifs_clock</span><span class="p">,</span> <span class="n">AR5K_IFS1_EIFS</span><span class="p">);</span>

		<span class="cm">/* PIFS = Slot time + SIFS */</span>
		<span class="n">pifs</span> <span class="o">=</span> <span class="n">slot_time</span> <span class="o">+</span> <span class="n">sifs</span><span class="p">;</span>
		<span class="n">pifs_clock</span> <span class="o">=</span> <span class="n">ath5k_hw_htoclock</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">pifs</span><span class="p">);</span>
		<span class="n">pifs_clock</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">pifs_clock</span><span class="p">,</span> <span class="n">AR5K_IFS1_PIFS</span><span class="p">);</span>

		<span class="cm">/* DIFS = SIFS + 2 * Slot time */</span>
		<span class="n">difs</span> <span class="o">=</span> <span class="n">sifs</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">slot_time</span><span class="p">;</span>
		<span class="n">difs_clock</span> <span class="o">=</span> <span class="n">ath5k_hw_htoclock</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">difs</span><span class="p">);</span>

		<span class="cm">/* Set SIFS/DIFS */</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="p">(</span><span class="n">difs_clock</span> <span class="o">&lt;&lt;</span>
				<span class="n">AR5K_IFS0_DIFS_S</span><span class="p">)</span> <span class="o">|</span> <span class="n">sifs_clock</span><span class="p">,</span>
				<span class="n">AR5K_IFS0</span><span class="p">);</span>

		<span class="cm">/* Set PIFS/EIFS and preserve AR5K_INIT_CARR_SENSE_EN */</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">pifs_clock</span> <span class="o">|</span> <span class="n">eifs_clock</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">AR5K_INIT_CARR_SENSE_EN</span> <span class="o">&lt;&lt;</span> <span class="n">AR5K_IFS1_CS_EN_S</span><span class="p">),</span>
				<span class="n">AR5K_IFS1</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set IFS slot time */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">slot_time_clock</span><span class="p">,</span> <span class="n">AR5K_DCU_GBL_IFS_SLOT</span><span class="p">);</span>

	<span class="cm">/* Set EIFS interval */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">eifs_clock</span><span class="p">,</span> <span class="n">AR5K_DCU_GBL_IFS_EIFS</span><span class="p">);</span>

	<span class="cm">/* Set SIFS interval in usecs */</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_DCU_GBL_IFS_MISC</span><span class="p">,</span>
				<span class="n">AR5K_DCU_GBL_IFS_MISC_SIFS_DUR_USEC</span><span class="p">,</span>
				<span class="n">sifs</span><span class="p">);</span>

	<span class="cm">/* Set SIFS interval in clock cycles */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sifs_clock</span><span class="p">,</span> <span class="n">AR5K_DCU_GBL_IFS_SIFS</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_init_queues() - Initialize tx queues</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes all tx queues based on information on</span>
<span class="cm"> * ah-&gt;ah_txq* set by the driver</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_init_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* TODO: HW Compression support for data queues */</span>
	<span class="cm">/* TODO: Burst prefetch for data queues */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset queues and start beacon timers at the end of the reset routine</span>
<span class="cm">	 * This also sets QCU mask on each DCU for 1:1 qcu to dcu mapping</span>
<span class="cm">	 * Note: If we want we can assign multiple qcus on one dcu.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">!=</span> <span class="n">AR5K_AR5210</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_queues</span><span class="p">.</span><span class="n">q_tx_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_reset_tx_queue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					<span class="s">&quot;failed to reset TX queue #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="k">else</span>
		<span class="cm">/* No QCU/DCU on AR5210, just set tx</span>
<span class="cm">		 * retry limits. We set IFS parameters</span>
<span class="cm">		 * on ath5k_hw_set_ifs_intervals */</span>
		<span class="n">ath5k_hw_set_tx_retry_limits</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set the turbo flag when operating on 40MHz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_bwmode</span> <span class="o">==</span> <span class="n">AR5K_BWMODE_40MHZ</span><span class="p">)</span>
		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_DCU_GBL_IFS_MISC</span><span class="p">,</span>
				<span class="n">AR5K_DCU_GBL_IFS_MISC_TURBO_MODE</span><span class="p">);</span>

	<span class="cm">/* If we didn&#39;t set IFS timings through</span>
<span class="cm">	 * ath5k_hw_set_coverage_class make sure</span>
<span class="cm">	 * we set them here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_coverage_class</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slot_time</span> <span class="o">=</span> <span class="n">ath5k_hw_get_default_slottime</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">ath5k_hw_set_ifs_intervals</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">slot_time</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
