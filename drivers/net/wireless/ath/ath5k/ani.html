<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath5k › ani.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ani.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2010 Bruno Randolf &lt;br1@einfach.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &quot;ath5k.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;ani.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * DOC: Basic ANI Operation</span>
<span class="cm"> *</span>
<span class="cm"> * Adaptive Noise Immunity (ANI) controls five noise immunity parameters</span>
<span class="cm"> * depending on the amount of interference in the environment, increasing</span>
<span class="cm"> * or reducing sensitivity as necessary.</span>
<span class="cm"> *</span>
<span class="cm"> * The parameters are:</span>
<span class="cm"> *</span>
<span class="cm"> *   - &quot;noise immunity&quot;</span>
<span class="cm"> *</span>
<span class="cm"> *   - &quot;spur immunity&quot;</span>
<span class="cm"> *</span>
<span class="cm"> *   - &quot;firstep level&quot;</span>
<span class="cm"> *</span>
<span class="cm"> *   - &quot;OFDM weak signal detection&quot;</span>
<span class="cm"> *</span>
<span class="cm"> *   - &quot;CCK weak signal detection&quot;</span>
<span class="cm"> *</span>
<span class="cm"> * Basically we look at the amount of ODFM and CCK timing errors we get and then</span>
<span class="cm"> * raise or lower immunity accordingly by setting one or more of these</span>
<span class="cm"> * parameters.</span>
<span class="cm"> *</span>
<span class="cm"> * Newer chipsets have PHY error counters in hardware which will generate a MIB</span>
<span class="cm"> * interrupt when they overflow. Older hardware has too enable PHY error frames</span>
<span class="cm"> * by setting a RX flag and then count every single PHY error. When a specified</span>
<span class="cm"> * threshold of errors has been reached we will raise immunity.</span>
<span class="cm"> * Also we regularly check the amount of errors and lower or raise immunity as</span>
<span class="cm"> * necessary.</span>
<span class="cm"> */</span>


<span class="cm">/***********************\</span>
<span class="cm">* ANI parameter control *</span>
<span class="cm">\***********************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_set_noise_immunity_level() - Set noise immunity level</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @level: level between 0 and @ATH5K_ANI_MAX_NOISE_IMM_LVL</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_ani_set_noise_immunity_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* TODO:</span>
<span class="cm">	 * ANI documents suggest the following five levels to use, but the HAL</span>
<span class="cm">	 * and ath9k use only the last two levels, making this</span>
<span class="cm">	 * essentially an on/off option. There *may* be a reason for this (???),</span>
<span class="cm">	 * so i stick with the HAL version for now...</span>
<span class="cm">	 */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	static const s8 lo[] = { -52, -56, -60, -64, -70 };</span>
<span class="c">	static const s8 hi[] = { -18, -18, -16, -14, -12 };</span>
<span class="c">	static const s8 sz[] = { -34, -41, -48, -55, -62 };</span>
<span class="c">	static const s8 fr[] = { -70, -72, -75, -78, -80 };</span>
<span class="cp">#else</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">s8</span> <span class="n">lo</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">64</span><span class="p">,</span> <span class="o">-</span><span class="mi">70</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">s8</span> <span class="n">hi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">14</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">s8</span> <span class="n">sz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span> <span class="o">-</span><span class="mi">62</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">s8</span> <span class="n">fr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">78</span><span class="p">,</span> <span class="o">-</span><span class="mi">80</span> <span class="p">};</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sz</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;noise immunity level %d out of range&quot;</span><span class="p">,</span>
			  <span class="n">level</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_DESIRED_SIZE</span><span class="p">,</span>
				<span class="n">AR5K_PHY_DESIRED_SIZE_TOT</span><span class="p">,</span> <span class="n">sz</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_AGCCOARSE</span><span class="p">,</span>
				<span class="n">AR5K_PHY_AGCCOARSE_LO</span><span class="p">,</span> <span class="n">lo</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_AGCCOARSE</span><span class="p">,</span>
				<span class="n">AR5K_PHY_AGCCOARSE_HI</span><span class="p">,</span> <span class="n">hi</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SIG</span><span class="p">,</span>
				<span class="n">AR5K_PHY_SIG_FIRPWR</span><span class="p">,</span> <span class="n">fr</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">noise_imm_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span> <span class="s">&quot;new level %d&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_set_spur_immunity_level() - Set spur immunity level</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @level: level between 0 and @max_spur_level (the maximum level is dependent</span>
<span class="cm"> * on the chip revision).</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_ani_set_spur_immunity_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">val</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">level</span> <span class="o">&gt;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">max_spur_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;spur immunity level %d out of range&quot;</span><span class="p">,</span>
			  <span class="n">level</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_OFDM_SELFCORR</span><span class="p">,</span>
		<span class="n">AR5K_PHY_OFDM_SELFCORR_CYPWR_THR1</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">spur_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span> <span class="s">&quot;new level %d&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_set_firstep_level() - Set &quot;firstep&quot; level</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @level: level between 0 and @ATH5K_ANI_MAX_FIRSTEP_LVL</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_ani_set_firstep_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">val</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">val</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;firstep level %d out of range&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SIG</span><span class="p">,</span>
				<span class="n">AR5K_PHY_SIG_FIRSTEP</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">firstep_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span> <span class="s">&quot;new level %d&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_set_ofdm_weak_signal_detection() - Set OFDM weak signal detection</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @on: turn on or off</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_ani_set_ofdm_weak_signal_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m1l</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">50</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2l</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">40</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">127</span><span class="p">,</span> <span class="mh">0x4d</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">127</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2cnt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2lcnt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">48</span> <span class="p">};</span>

	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_WEAK_OFDM_LOW_THR</span><span class="p">,</span>
				<span class="n">AR5K_PHY_WEAK_OFDM_LOW_THR_M1</span><span class="p">,</span> <span class="n">m1l</span><span class="p">[</span><span class="n">on</span><span class="p">]);</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_WEAK_OFDM_LOW_THR</span><span class="p">,</span>
				<span class="n">AR5K_PHY_WEAK_OFDM_LOW_THR_M2</span><span class="p">,</span> <span class="n">m2l</span><span class="p">[</span><span class="n">on</span><span class="p">]);</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_WEAK_OFDM_HIGH_THR</span><span class="p">,</span>
				<span class="n">AR5K_PHY_WEAK_OFDM_HIGH_THR_M1</span><span class="p">,</span> <span class="n">m1</span><span class="p">[</span><span class="n">on</span><span class="p">]);</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_WEAK_OFDM_HIGH_THR</span><span class="p">,</span>
				<span class="n">AR5K_PHY_WEAK_OFDM_HIGH_THR_M2</span><span class="p">,</span> <span class="n">m2</span><span class="p">[</span><span class="n">on</span><span class="p">]);</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_WEAK_OFDM_HIGH_THR</span><span class="p">,</span>
			<span class="n">AR5K_PHY_WEAK_OFDM_HIGH_THR_M2_COUNT</span><span class="p">,</span> <span class="n">m2cnt</span><span class="p">[</span><span class="n">on</span><span class="p">]);</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_WEAK_OFDM_LOW_THR</span><span class="p">,</span>
			<span class="n">AR5K_PHY_WEAK_OFDM_LOW_THR_M2_COUNT</span><span class="p">,</span> <span class="n">m2lcnt</span><span class="p">[</span><span class="n">on</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_WEAK_OFDM_LOW_THR</span><span class="p">,</span>
				<span class="n">AR5K_PHY_WEAK_OFDM_LOW_THR_SELFCOR_EN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">AR5K_REG_DISABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_WEAK_OFDM_LOW_THR</span><span class="p">,</span>
				<span class="n">AR5K_PHY_WEAK_OFDM_LOW_THR_SELFCOR_EN</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">ofdm_weak_sig</span> <span class="o">=</span> <span class="n">on</span><span class="p">;</span>
	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span> <span class="s">&quot;turned %s&quot;</span><span class="p">,</span>
			  <span class="n">on</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_set_cck_weak_signal_detection() - Set CCK weak signal detection</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @on: turn on or off</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_ani_set_cck_weak_signal_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">val</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span> <span class="p">};</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_CCK_CROSSCORR</span><span class="p">,</span>
				<span class="n">AR5K_PHY_CCK_CROSSCORR_WEAK_SIG_THR</span><span class="p">,</span> <span class="n">val</span><span class="p">[</span><span class="n">on</span><span class="p">]);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">cck_weak_sig</span> <span class="o">=</span> <span class="n">on</span><span class="p">;</span>
	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span> <span class="s">&quot;turned %s&quot;</span><span class="p">,</span>
			  <span class="n">on</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/***************\</span>
<span class="cm">* ANI algorithm *</span>
<span class="cm">\***************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_raise_immunity() - Increase noise immunity</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @as: The &amp;struct ath5k_ani_state</span>
<span class="cm"> * @ofdm_trigger: If this is true we are called because of too many OFDM errors,</span>
<span class="cm"> * the algorithm will tune more parameters then.</span>
<span class="cm"> *</span>
<span class="cm"> * Try to raise noise immunity (=decrease sensitivity) in several steps</span>
<span class="cm"> * depending on the average RSSI of the beacons we received.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_ani_raise_immunity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_ani_state</span> <span class="o">*</span><span class="n">as</span><span class="p">,</span>
			 <span class="n">bool</span> <span class="n">ofdm_trigger</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rssi</span> <span class="o">=</span> <span class="n">ewma_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_beacon_rssi_avg</span><span class="p">);</span>

	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span> <span class="s">&quot;raise immunity (%s)&quot;</span><span class="p">,</span>
		<span class="n">ofdm_trigger</span> <span class="o">?</span> <span class="s">&quot;ODFM&quot;</span> <span class="o">:</span> <span class="s">&quot;CCK&quot;</span><span class="p">);</span>

	<span class="cm">/* first: raise noise immunity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">noise_imm_level</span> <span class="o">&lt;</span> <span class="n">ATH5K_ANI_MAX_NOISE_IMM_LVL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath5k_ani_set_noise_immunity_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">noise_imm_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* only OFDM: raise spur immunity level */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_trigger</span> <span class="o">&amp;&amp;</span>
	    <span class="n">as</span><span class="o">-&gt;</span><span class="n">spur_level</span> <span class="o">&lt;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">max_spur_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath5k_ani_set_spur_immunity_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">spur_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* AP mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">&lt;</span> <span class="n">ATH5K_ANI_MAX_FIRSTEP_LVL</span><span class="p">)</span>
			<span class="n">ath5k_ani_set_firstep_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* STA and IBSS mode */</span>

	<span class="cm">/* TODO: for IBSS mode it would be better to keep a beacon RSSI average</span>
<span class="cm">	 * per each neighbour node and use the minimum of these, to make sure we</span>
<span class="cm">	 * don&#39;t shut out a remote node by raising immunity too high. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">ATH5K_ANI_RSSI_THR_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span>
				  <span class="s">&quot;beacon RSSI high&quot;</span><span class="p">);</span>
		<span class="cm">/* only OFDM: beacon RSSI is high, we can disable ODFM weak</span>
<span class="cm">		 * signal detection */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_trigger</span> <span class="o">&amp;&amp;</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_weak_sig</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath5k_ani_set_ofdm_weak_signal_detection</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">ath5k_ani_set_spur_immunity_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* as a last resort or CCK: raise firstep level */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">&lt;</span> <span class="n">ATH5K_ANI_MAX_FIRSTEP_LVL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath5k_ani_set_firstep_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">ATH5K_ANI_RSSI_THR_LOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* beacon RSSI in mid range, we need OFDM weak signal detect,</span>
<span class="cm">		 * but can raise firstep level */</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span>
				  <span class="s">&quot;beacon RSSI mid&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_trigger</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_weak_sig</span><span class="p">)</span>
			<span class="n">ath5k_ani_set_ofdm_weak_signal_detection</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">&lt;</span> <span class="n">ATH5K_ANI_MAX_FIRSTEP_LVL</span><span class="p">)</span>
			<span class="n">ath5k_ani_set_firstep_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_current_channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* beacon RSSI is low. in B/G mode turn of OFDM weak signal</span>
<span class="cm">		 * detect and zero firstep level to maximize CCK sensitivity */</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span>
				  <span class="s">&quot;beacon RSSI low, 2GHz&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_trigger</span> <span class="o">&amp;&amp;</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_weak_sig</span><span class="p">)</span>
			<span class="n">ath5k_ani_set_ofdm_weak_signal_detection</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ath5k_ani_set_firstep_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: why not?:</span>
<span class="cm">	if (as-&gt;cck_weak_sig == true) {</span>
<span class="cm">		ath5k_ani_set_cck_weak_signal_detection(ah, false);</span>
<span class="cm">	}</span>
<span class="cm">	*/</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_lower_immunity() - Decrease noise immunity</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @as: The &amp;struct ath5k_ani_state</span>
<span class="cm"> *</span>
<span class="cm"> * Try to lower noise immunity (=increase sensitivity) in several steps</span>
<span class="cm"> * depending on the average RSSI of the beacons we received.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_ani_lower_immunity</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_ani_state</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rssi</span> <span class="o">=</span> <span class="n">ewma_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_beacon_rssi_avg</span><span class="p">);</span>

	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span> <span class="s">&quot;lower immunity&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* AP mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath5k_ani_set_firstep_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* STA and IBSS mode (see TODO above) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">ATH5K_ANI_RSSI_THR_HIGH</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* beacon signal is high, leave OFDM weak signal</span>
<span class="cm">			 * detection off or it may oscillate</span>
<span class="cm">			 * TODO: who said it&#39;s off??? */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">ATH5K_ANI_RSSI_THR_LOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* beacon RSSI is mid-range: turn on ODFM weak signal</span>
<span class="cm">			 * detection and next, lower firstep level */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_weak_sig</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath5k_ani_set_ofdm_weak_signal_detection</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
									 <span class="nb">true</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath5k_ani_set_firstep_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
							<span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* beacon signal is low: only reduce firstep level */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath5k_ani_set_firstep_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
							<span class="n">as</span><span class="o">-&gt;</span><span class="n">firstep_level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* all modes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">spur_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath5k_ani_set_spur_immunity_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">spur_level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* finally, reduce noise immunity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">noise_imm_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath5k_ani_set_noise_immunity_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">noise_imm_level</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_ani_get_listen_time() - Update counters and return listening time</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @as: The &amp;struct ath5k_ani_state</span>
<span class="cm"> *</span>
<span class="cm"> * Return an approximation of the time spent &quot;listening&quot; in milliseconds (ms)</span>
<span class="cm"> * since the last call of this function.</span>
<span class="cm"> * Save a snapshot of the counter values for debugging/statistics.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_ani_get_listen_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_ani_state</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">listen</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

	<span class="n">ath_hw_cycle_counters_update</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">last_cc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_ani</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">last_cc</span><span class="p">));</span>

	<span class="cm">/* clears common-&gt;cc_ani */</span>
	<span class="n">listen</span> <span class="o">=</span> <span class="n">ath_hw_get_listen_time</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">listen</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_save_and_clear_phy_errors() - Clear and save PHY error counters</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @as: The &amp;struct ath5k_ani_state</span>
<span class="cm"> *</span>
<span class="cm"> * Clear the PHY error counters as soon as possible, since this might be called</span>
<span class="cm"> * from a MIB interrupt and we want to make sure we don&#39;t get interrupted again.</span>
<span class="cm"> * Add the count of CCK and OFDM errors to our internal state, so it can be used</span>
<span class="cm"> * by the algorithm later.</span>
<span class="cm"> *</span>
<span class="cm"> * Will be called from interrupt and tasklet context.</span>
<span class="cm"> * Returns 0 if both counters are zero.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_ani_save_and_clear_phy_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ath5k_ani_state</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ofdm_err</span><span class="p">,</span> <span class="n">cck_err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_has_phyerr_counters</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ofdm_err</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHYERR_CNT1</span><span class="p">);</span>
	<span class="n">cck_err</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHYERR_CNT2</span><span class="p">);</span>

	<span class="cm">/* reset counters first, we might be in a hurry (interrupt) */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_PHYERR_CNT_MAX</span> <span class="o">-</span> <span class="n">ATH5K_ANI_OFDM_TRIG_HIGH</span><span class="p">,</span>
			   <span class="n">AR5K_PHYERR_CNT1</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_PHYERR_CNT_MAX</span> <span class="o">-</span> <span class="n">ATH5K_ANI_CCK_TRIG_HIGH</span><span class="p">,</span>
			   <span class="n">AR5K_PHYERR_CNT2</span><span class="p">);</span>

	<span class="n">ofdm_err</span> <span class="o">=</span> <span class="n">ATH5K_ANI_OFDM_TRIG_HIGH</span> <span class="o">-</span> <span class="p">(</span><span class="n">ATH5K_PHYERR_CNT_MAX</span> <span class="o">-</span> <span class="n">ofdm_err</span><span class="p">);</span>
	<span class="n">cck_err</span> <span class="o">=</span> <span class="n">ATH5K_ANI_CCK_TRIG_HIGH</span> <span class="o">-</span> <span class="p">(</span><span class="n">ATH5K_PHYERR_CNT_MAX</span> <span class="o">-</span> <span class="n">cck_err</span><span class="p">);</span>

	<span class="cm">/* sometimes both can be zero, especially when there is a superfluous</span>
<span class="cm">	 * second interrupt. detect that here and return an error. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_err</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cck_err</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* avoid negative values should one of the registers overflow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ofdm_err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_errors</span> <span class="o">+=</span> <span class="n">ofdm_err</span><span class="p">;</span>
		<span class="n">as</span><span class="o">-&gt;</span><span class="n">sum_ofdm_errors</span> <span class="o">+=</span> <span class="n">ofdm_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cck_err</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">as</span><span class="o">-&gt;</span><span class="n">cck_errors</span> <span class="o">+=</span> <span class="n">cck_err</span><span class="p">;</span>
		<span class="n">as</span><span class="o">-&gt;</span><span class="n">sum_cck_errors</span> <span class="o">+=</span> <span class="n">cck_err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_period_restart() - Restart ANI period</span>
<span class="cm"> * @as: The &amp;struct ath5k_ani_state</span>
<span class="cm"> *</span>
<span class="cm"> * Just reset counters, so they are clear for the next &quot;ani period&quot;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_ani_period_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_ani_state</span> <span class="o">*</span><span class="n">as</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* keep last values for debugging */</span>
	<span class="n">as</span><span class="o">-&gt;</span><span class="n">last_ofdm_errors</span> <span class="o">=</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_errors</span><span class="p">;</span>
	<span class="n">as</span><span class="o">-&gt;</span><span class="n">last_cck_errors</span> <span class="o">=</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">cck_errors</span><span class="p">;</span>
	<span class="n">as</span><span class="o">-&gt;</span><span class="n">last_listen</span> <span class="o">=</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">listen_time</span><span class="p">;</span>

	<span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">as</span><span class="o">-&gt;</span><span class="n">cck_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">as</span><span class="o">-&gt;</span><span class="n">listen_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_calibration() - The main ANI calibration function</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> *</span>
<span class="cm"> * We count OFDM and CCK errors relative to the time where we did not send or</span>
<span class="cm"> * receive (&quot;listen&quot; time) and raise or lower immunity accordingly.</span>
<span class="cm"> * This is called regularly (every second) from the calibration timer, but also</span>
<span class="cm"> * when an error threshold has been reached.</span>
<span class="cm"> *</span>
<span class="cm"> * In order to synchronize access from different contexts, this should be</span>
<span class="cm"> * called only indirectly by scheduling the ANI tasklet!</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_ani_calibration</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_ani_state</span> <span class="o">*</span><span class="n">as</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">listen</span><span class="p">,</span> <span class="n">ofdm_high</span><span class="p">,</span> <span class="n">ofdm_low</span><span class="p">,</span> <span class="n">cck_high</span><span class="p">,</span> <span class="n">cck_low</span><span class="p">;</span>

	<span class="cm">/* get listen time since last call and add it to the counter because we</span>
<span class="cm">	 * might not have restarted the &quot;ani period&quot; last time.</span>
<span class="cm">	 * always do this to calculate the busy time also in manual mode */</span>
	<span class="n">listen</span> <span class="o">=</span> <span class="n">ath5k_hw_ani_get_listen_time</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>
	<span class="n">as</span><span class="o">-&gt;</span><span class="n">listen_time</span> <span class="o">+=</span> <span class="n">listen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">ani_mode</span> <span class="o">!=</span> <span class="n">ATH5K_ANI_MODE_AUTO</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ath5k_ani_save_and_clear_phy_errors</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>

	<span class="n">ofdm_high</span> <span class="o">=</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">listen_time</span> <span class="o">*</span> <span class="n">ATH5K_ANI_OFDM_TRIG_HIGH</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">cck_high</span> <span class="o">=</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">listen_time</span> <span class="o">*</span> <span class="n">ATH5K_ANI_CCK_TRIG_HIGH</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">ofdm_low</span> <span class="o">=</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">listen_time</span> <span class="o">*</span> <span class="n">ATH5K_ANI_OFDM_TRIG_LOW</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">cck_low</span> <span class="o">=</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">listen_time</span> <span class="o">*</span> <span class="n">ATH5K_ANI_CCK_TRIG_LOW</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span>
		<span class="s">&quot;listen %d (now %d)&quot;</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">listen_time</span><span class="p">,</span> <span class="n">listen</span><span class="p">);</span>
	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span>
		<span class="s">&quot;check high ofdm %d/%d cck %d/%d&quot;</span><span class="p">,</span>
		<span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_errors</span><span class="p">,</span> <span class="n">ofdm_high</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">cck_errors</span><span class="p">,</span> <span class="n">cck_high</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_errors</span> <span class="o">&gt;</span> <span class="n">ofdm_high</span> <span class="o">||</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">cck_errors</span> <span class="o">&gt;</span> <span class="n">cck_high</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* too many PHY errors - we have to raise immunity */</span>
		<span class="n">bool</span> <span class="n">ofdm_flag</span> <span class="o">=</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_errors</span> <span class="o">&gt;</span> <span class="n">ofdm_high</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ath5k_ani_raise_immunity</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="p">,</span> <span class="n">ofdm_flag</span><span class="p">);</span>
		<span class="n">ath5k_ani_period_restart</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">listen_time</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">ATH5K_ANI_LISTEN_PERIOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If more than 5 (TODO: why 5?) periods have passed and we got</span>
<span class="cm">		 * relatively little errors we can try to lower immunity */</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span>
			<span class="s">&quot;check low ofdm %d/%d cck %d/%d&quot;</span><span class="p">,</span>
			<span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_errors</span><span class="p">,</span> <span class="n">ofdm_low</span><span class="p">,</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">cck_errors</span><span class="p">,</span> <span class="n">cck_low</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_errors</span> <span class="o">&lt;=</span> <span class="n">ofdm_low</span> <span class="o">&amp;&amp;</span> <span class="n">as</span><span class="o">-&gt;</span><span class="n">cck_errors</span> <span class="o">&lt;=</span> <span class="n">cck_low</span><span class="p">)</span>
			<span class="n">ath5k_ani_lower_immunity</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="p">);</span>

		<span class="n">ath5k_ani_period_restart</span><span class="p">(</span><span class="n">as</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*******************\</span>
<span class="cm">* Interrupt handler *</span>
<span class="cm">\*******************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_mib_intr() - Interrupt handler for ANI MIB counters</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> *</span>
<span class="cm"> * Just read &amp; reset the registers quickly, so they don&#39;t generate more</span>
<span class="cm"> * interrupts, save the counters and schedule the tasklet to decide whether</span>
<span class="cm"> * to raise immunity or not.</span>
<span class="cm"> *</span>
<span class="cm"> * We just need to handle PHY error counters, ath5k_hw_update_mib_counters()</span>
<span class="cm"> * should take care of all &quot;normal&quot; MIB interrupts.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_ani_mib_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_ani_state</span> <span class="o">*</span><span class="n">as</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">;</span>

	<span class="cm">/* nothing to do here if HW does not have PHY error counters - they</span>
<span class="cm">	 * can&#39;t be the reason for the MIB interrupt then */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_has_phyerr_counters</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* not in use but clear anyways */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_OFDM_FIL_CNT</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_CCK_FIL_CNT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">ani_mode</span> <span class="o">!=</span> <span class="n">ATH5K_ANI_MODE_AUTO</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* If one of the errors triggered, we can get a superfluous second</span>
<span class="cm">	 * interrupt, even though we have already reset the register. The</span>
<span class="cm">	 * function detects that so we can return early. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_ani_save_and_clear_phy_errors</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">as</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_errors</span> <span class="o">&gt;</span> <span class="n">ATH5K_ANI_OFDM_TRIG_HIGH</span> <span class="o">||</span>
	    <span class="n">as</span><span class="o">-&gt;</span><span class="n">cck_errors</span> <span class="o">&gt;</span> <span class="n">ATH5K_ANI_CCK_TRIG_HIGH</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_phy_error_report - Used by older HW to report PHY errors</span>
<span class="cm"> *</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @phyerr: One of enum ath5k_phy_error_code</span>
<span class="cm"> *</span>
<span class="cm"> * This is used by hardware without PHY error counters to report PHY errors</span>
<span class="cm"> * on a frame-by-frame basis, instead of the interrupt.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_ani_phy_error_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">ath5k_phy_error_code</span> <span class="n">phyerr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_ani_state</span> <span class="o">*</span><span class="n">as</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phyerr</span> <span class="o">==</span> <span class="n">AR5K_RX_PHY_ERROR_OFDM_TIMING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">ofdm_errors</span> <span class="o">&gt;</span> <span class="n">ATH5K_ANI_OFDM_TRIG_HIGH</span><span class="p">)</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_tasklet</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phyerr</span> <span class="o">==</span> <span class="n">AR5K_RX_PHY_ERROR_CCK_TIMING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">as</span><span class="o">-&gt;</span><span class="n">cck_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">as</span><span class="o">-&gt;</span><span class="n">cck_errors</span> <span class="o">&gt;</span> <span class="n">ATH5K_ANI_CCK_TRIG_HIGH</span><span class="p">)</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_tasklet</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/****************\</span>
<span class="cm">* Initialization *</span>
<span class="cm">\****************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_enable_phy_err_counters() - Enable PHY error counters</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> *</span>
<span class="cm"> * Enable PHY error counters for OFDM and CCK timing errors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_enable_phy_err_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_PHYERR_CNT_MAX</span> <span class="o">-</span> <span class="n">ATH5K_ANI_OFDM_TRIG_HIGH</span><span class="p">,</span>
			   <span class="n">AR5K_PHYERR_CNT1</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_PHYERR_CNT_MAX</span> <span class="o">-</span> <span class="n">ATH5K_ANI_CCK_TRIG_HIGH</span><span class="p">,</span>
			   <span class="n">AR5K_PHYERR_CNT2</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_ERR_FIL_OFDM</span><span class="p">,</span> <span class="n">AR5K_PHYERR_CNT1_MASK</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_ERR_FIL_CCK</span><span class="p">,</span> <span class="n">AR5K_PHYERR_CNT2_MASK</span><span class="p">);</span>

	<span class="cm">/* not in use */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_OFDM_FIL_CNT</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_CCK_FIL_CNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_disable_phy_err_counters() - Disable PHY error counters</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> *</span>
<span class="cm"> * Disable PHY error counters for OFDM and CCK timing errors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_disable_phy_err_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_PHYERR_CNT1</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_PHYERR_CNT2</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_PHYERR_CNT1_MASK</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_PHYERR_CNT2_MASK</span><span class="p">);</span>

	<span class="cm">/* not in use */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_OFDM_FIL_CNT</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_CCK_FIL_CNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_init() - Initialize ANI</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @mode: One of enum ath5k_ani_mode</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize ANI according to mode.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_ani_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ath5k_ani_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ANI is only possible on 5212 and newer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">&lt;</span> <span class="n">AR5K_AR5212</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="n">ATH5K_ANI_MODE_OFF</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">&gt;</span> <span class="n">ATH5K_ANI_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;ANI mode %d out of range&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* clear old state information */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">));</span>

	<span class="cm">/* older hardware has more spur levels than newer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_srev</span> <span class="o">&lt;</span> <span class="n">AR5K_SREV_AR2414</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">max_spur_level</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">max_spur_level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* initial values for our ani parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ATH5K_ANI_MODE_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span> <span class="s">&quot;ANI off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ATH5K_ANI_MODE_MANUAL_LOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span>
			<span class="s">&quot;ANI manual low -&gt; high sensitivity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_noise_immunity_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_spur_immunity_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_firstep_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_ofdm_weak_signal_detection</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_cck_weak_signal_detection</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ATH5K_ANI_MODE_MANUAL_HIGH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span>
			<span class="s">&quot;ANI manual high -&gt; low sensitivity</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_noise_immunity_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					<span class="n">ATH5K_ANI_MAX_NOISE_IMM_LVL</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_spur_immunity_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">max_spur_level</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_firstep_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_ANI_MAX_FIRSTEP_LVL</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_ofdm_weak_signal_detection</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_cck_weak_signal_detection</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ATH5K_ANI_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANI</span><span class="p">,</span> <span class="s">&quot;ANI auto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_noise_immunity_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_spur_immunity_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_firstep_level</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_ofdm_weak_signal_detection</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ath5k_ani_set_cck_weak_signal_detection</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* newer hardware has PHY error counter registers which we can use to</span>
<span class="cm">	 * get OFDM and CCK error counts. older hardware has to set rxfilter and</span>
<span class="cm">	 * report every single PHY error by calling ath5k_ani_phy_error_report()</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">ATH5K_ANI_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_has_phyerr_counters</span><span class="p">)</span>
			<span class="n">ath5k_enable_phy_err_counters</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ath5k_hw_set_rx_filter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ath5k_hw_get_rx_filter</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">|</span>
						   <span class="n">AR5K_RX_FILTER_PHYERR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_has_phyerr_counters</span><span class="p">)</span>
			<span class="n">ath5k_disable_phy_err_counters</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ath5k_hw_set_rx_filter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ath5k_hw_get_rx_filter</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;</span>
						   <span class="o">~</span><span class="n">AR5K_RX_FILTER_PHYERR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">ani_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************\</span>
<span class="cm">* Debug output *</span>
<span class="cm">\**************/</span>

<span class="cp">#ifdef CONFIG_ATH5K_DEBUG</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_ani_print_counters() - Print ANI counters</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> *</span>
<span class="cm"> * Used for debugging ANI</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_ani_print_counters</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* clears too */</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;ACK fail</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_ACK_FAIL</span><span class="p">));</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;RTS fail</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_RTS_FAIL</span><span class="p">));</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;RTS success</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_RTS_OK</span><span class="p">));</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;FCS error</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_FCS_FAIL</span><span class="p">));</span>

	<span class="cm">/* no clear */</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;tx</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PROFCNT_TX</span><span class="p">));</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;rx</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PROFCNT_RX</span><span class="p">));</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;busy</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PROFCNT_RXCLR</span><span class="p">));</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;cycles</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PROFCNT_CYCLE</span><span class="p">));</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;AR5K_PHYERR_CNT1</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHYERR_CNT1</span><span class="p">));</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;AR5K_PHYERR_CNT2</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHYERR_CNT2</span><span class="p">));</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;AR5K_OFDM_FIL_CNT</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_OFDM_FIL_CNT</span><span class="p">));</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;AR5K_CCK_FIL_CNT</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_CCK_FIL_CNT</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
