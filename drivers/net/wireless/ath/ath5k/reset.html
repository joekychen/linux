<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath5k › reset.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>reset.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004-2008 Reyk Floeter &lt;reyk@openbsd.org&gt;</span>
<span class="cm"> * Copyright (c) 2006-2008 Nick Kossifidis &lt;mickflemm@gmail.com&gt;</span>
<span class="cm"> * Copyright (c) 2007-2008 Luis Rodriguez &lt;mcgrof@winlab.rutgers.edu&gt;</span>
<span class="cm"> * Copyright (c) 2007-2008 Pavel Roskin &lt;proski@gnu.org&gt;</span>
<span class="cm"> * Copyright (c) 2007-2008 Jiri Slaby &lt;jirislaby@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/****************************\</span>
<span class="cm">  Reset function and helpers</span>
<span class="cm">\****************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;linux/pci.h&gt;		</span><span class="cm">/* To determine if a card is pci-e */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/log2.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &quot;ath5k.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>


<span class="cm">/**</span>
<span class="cm"> * DOC: Reset function and helpers</span>
<span class="cm"> *</span>
<span class="cm"> * Here we implement the main reset routine, used to bring the card</span>
<span class="cm"> * to a working state and ready to receive. We also handle routines</span>
<span class="cm"> * that don&#39;t fit on other places such as clock, sleep and power control</span>
<span class="cm"> */</span>


<span class="cm">/******************\</span>
<span class="cm">* Helper functions *</span>
<span class="cm">\******************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_register_timeout() - Poll a register for a flag/field change</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @reg: The register to read</span>
<span class="cm"> * @flag: The flag/field to check on the register</span>
<span class="cm"> * @val: The field value we expect (if we check a field)</span>
<span class="cm"> * @is_set: Instead of checking if the flag got cleared, check if it got set</span>
<span class="cm"> *</span>
<span class="cm"> * Some registers contain flags that indicate that an operation is</span>
<span class="cm"> * running. We use this function to poll these registers and check</span>
<span class="cm"> * if these flags get cleared. We also use it to poll a register</span>
<span class="cm"> * field (containing multiple flags) until it gets a specific value.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns -EAGAIN if we exceeded AR5K_TUNE_REGISTER_TIMEOUT * 15us or 0</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_register_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flag</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">is_set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">AR5K_TUNE_REGISTER_TIMEOUT</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_set</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*************************\</span>
<span class="cm">* Clock related functions *</span>
<span class="cm">\*************************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_htoclock() - Translate usec to hw clock units</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @usec: value in microseconds</span>
<span class="cm"> *</span>
<span class="cm"> * Translate usecs to hw clock units based on the current</span>
<span class="cm"> * hw clock rate.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns number of clock units</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_htoclock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">usec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">usec</span> <span class="o">*</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">clockrate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_clocktoh() - Translate hw clock units to usec</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @clock: value in hw clock units</span>
<span class="cm"> *</span>
<span class="cm"> * Translate hw clock units to usecs based on the current</span>
<span class="cm"> * hw clock rate.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns number of usecs</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_clocktoh</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">clock</span> <span class="o">/</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">clockrate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_init_core_clock() - Initialize core clock</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize core clock parameters (usec, usec32, latencies etc),</span>
<span class="cm"> * based on current bwmode and chipset properties.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_hw_init_core_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_current_channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">usec_reg</span><span class="p">,</span> <span class="n">txlat</span><span class="p">,</span> <span class="n">rxlat</span><span class="p">,</span> <span class="n">usec</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">sclock</span><span class="p">,</span> <span class="n">txf2txs</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set core clock frequency</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_MODE_11A</span>:
		<span class="n">clock</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_MODE_11B</span>:
		<span class="n">clock</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_MODE_11G</span>:
	<span class="nl">default:</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="mi">44</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use clock multiplier for non-default</span>
<span class="cm">	 * bwmode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_bwmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_BWMODE_40MHZ</span>:
		<span class="n">clock</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_BWMODE_10MHZ</span>:
		<span class="n">clock</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_BWMODE_5MHZ</span>:
		<span class="n">clock</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">clockrate</span> <span class="o">=</span> <span class="n">clock</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set USEC parameters</span>
<span class="cm">	 */</span>
	<span class="cm">/* Set USEC counter on PCU*/</span>
	<span class="n">usec</span> <span class="o">=</span> <span class="n">clock</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">usec</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">usec</span><span class="p">,</span> <span class="n">AR5K_USEC_1</span><span class="p">);</span>

	<span class="cm">/* Set usec duration on DCU */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">!=</span> <span class="n">AR5K_AR5210</span><span class="p">)</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_DCU_GBL_IFS_MISC</span><span class="p">,</span>
					<span class="n">AR5K_DCU_GBL_IFS_MISC_USEC_DUR</span><span class="p">,</span>
					<span class="n">clock</span><span class="p">);</span>

	<span class="cm">/* Set 32MHz USEC counter */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5112</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF2413</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5413</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF2316</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF2317</span><span class="p">))</span>
		<span class="cm">/* Remain on 40MHz clock ? */</span>
		<span class="n">sclock</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sclock</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sclock</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">sclock</span><span class="p">,</span> <span class="n">AR5K_USEC_32</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set tx/rx latencies</span>
<span class="cm">	 */</span>
	<span class="n">usec_reg</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_USEC_5211</span><span class="p">);</span>
	<span class="n">txlat</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">usec_reg</span><span class="p">,</span> <span class="n">AR5K_USEC_TX_LATENCY_5211</span><span class="p">);</span>
	<span class="n">rxlat</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">usec_reg</span><span class="p">,</span> <span class="n">AR5K_USEC_RX_LATENCY_5211</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set default Tx frame to Tx data start delay</span>
<span class="cm">	 */</span>
	<span class="n">txf2txs</span> <span class="o">=</span> <span class="n">AR5K_INIT_TXF2TXD_START_DEFAULT</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 5210 initvals don&#39;t include usec settings</span>
<span class="cm">	 * so we need to use magic values here for</span>
<span class="cm">	 * tx/rx latencies</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* same for turbo */</span>
		<span class="n">txlat</span> <span class="o">=</span> <span class="n">AR5K_INIT_TX_LATENCY_5210</span><span class="p">;</span>
		<span class="n">rxlat</span> <span class="o">=</span> <span class="n">AR5K_INIT_RX_LATENCY_5210</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_srev</span> <span class="o">&lt;</span> <span class="n">AR5K_SREV_AR5211</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 5311 has different tx/rx latency masks</span>
<span class="cm">		 * from 5211, since we deal 5311 the same</span>
<span class="cm">		 * as 5211 when setting initvals, shift</span>
<span class="cm">		 * values here to their proper locations</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note: Initvals indicate tx/rx/ latencies</span>
<span class="cm">		 * are the same for turbo mode */</span>
		<span class="n">txlat</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">txlat</span><span class="p">,</span> <span class="n">AR5K_USEC_TX_LATENCY_5210</span><span class="p">);</span>
		<span class="n">rxlat</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">rxlat</span><span class="p">,</span> <span class="n">AR5K_USEC_RX_LATENCY_5210</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_bwmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_BWMODE_10MHZ</span>:
		<span class="n">txlat</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">txlat</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">AR5K_USEC_TX_LATENCY_5211</span><span class="p">);</span>
		<span class="n">rxlat</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">AR5K_INIT_RX_LAT_MAX</span><span class="p">,</span>
				<span class="n">AR5K_USEC_RX_LATENCY_5211</span><span class="p">);</span>
		<span class="n">txf2txs</span> <span class="o">=</span> <span class="n">AR5K_INIT_TXF2TXD_START_DELAY_10MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_BWMODE_5MHZ</span>:
		<span class="n">txlat</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">txlat</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">AR5K_USEC_TX_LATENCY_5211</span><span class="p">);</span>
		<span class="n">rxlat</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">AR5K_INIT_RX_LAT_MAX</span><span class="p">,</span>
				<span class="n">AR5K_USEC_RX_LATENCY_5211</span><span class="p">);</span>
		<span class="n">txf2txs</span> <span class="o">=</span> <span class="n">AR5K_INIT_TXF2TXD_START_DELAY_5MHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_BWMODE_40MHZ</span>:
		<span class="n">txlat</span> <span class="o">=</span> <span class="n">AR5K_INIT_TX_LAT_MIN</span><span class="p">;</span>
		<span class="n">rxlat</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">rxlat</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">AR5K_USEC_RX_LATENCY_5211</span><span class="p">);</span>
		<span class="n">txf2txs</span> <span class="o">=</span> <span class="n">AR5K_INIT_TXF2TXD_START_DEFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usec_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">usec</span> <span class="o">|</span> <span class="n">sclock</span> <span class="o">|</span> <span class="n">txlat</span> <span class="o">|</span> <span class="n">rxlat</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">usec_reg</span><span class="p">,</span> <span class="n">AR5K_USEC</span><span class="p">);</span>

	<span class="cm">/* On 5112 set tx frame to tx data start delay */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5112</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_RF_CTL2</span><span class="p">,</span>
					<span class="n">AR5K_PHY_RF_CTL2_TXF2TXD_START</span><span class="p">,</span>
					<span class="n">txf2txs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_set_sleep_clock() - Setup sleep clock operation</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @enable: Enable sleep clock operation (false to disable)</span>
<span class="cm"> *</span>
<span class="cm"> * If there is an external 32KHz crystal available, use it</span>
<span class="cm"> * as ref. clock instead of 32/40MHz clock and baseband clocks</span>
<span class="cm"> * to save power during sleep or restore normal 32/40MHz</span>
<span class="cm"> * operation.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: When operating on 32KHz certain PHY registers (27 - 31,</span>
<span class="cm"> * 123 - 127) require delay on access.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_hw_set_sleep_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scal</span><span class="p">,</span> <span class="n">spending</span><span class="p">,</span> <span class="n">sclock</span><span class="p">;</span>

	<span class="cm">/* Only set 32KHz settings if we have an external</span>
<span class="cm">	 * 32KHz crystal present */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">AR5K_EEPROM_HAS32KHZCRYSTAL</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_misc1</span><span class="p">)</span> <span class="o">||</span>
	<span class="n">AR5K_EEPROM_HAS32KHZCRYSTAL_OLD</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_misc1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	<span class="n">enable</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* 1 usec/cycle */</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_USEC_5211</span><span class="p">,</span> <span class="n">AR5K_USEC_32</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Set up tsf increment on each cycle */</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TSF_PARM</span><span class="p">,</span> <span class="n">AR5K_TSF_PARM_INC</span><span class="p">,</span> <span class="mi">61</span><span class="p">);</span>

		<span class="cm">/* Set baseband sleep control registers</span>
<span class="cm">		 * and sleep control rate */</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">AR5K_PHY_SCR</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5112</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5413</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF2316</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_version</span> <span class="o">==</span> <span class="p">(</span><span class="n">AR5K_SREV_AR2417</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)))</span>
			<span class="n">spending</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">spending</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">spending</span><span class="p">,</span> <span class="n">AR5K_PHY_SPENDING</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5112</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5413</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_version</span> <span class="o">==</span> <span class="p">(</span><span class="n">AR5K_SREV_AR2417</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="n">AR5K_PHY_SLMT</span><span class="p">);</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="n">AR5K_PHY_SCAL</span><span class="p">);</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">AR5K_PHY_SCLOCK</span><span class="p">);</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">AR5K_PHY_SDELAY</span><span class="p">);</span>
			<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PCICFG</span><span class="p">,</span>
				<span class="n">AR5K_PCICFG_SLEEP_CLOCK_RATE</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="n">AR5K_PHY_SLMT</span><span class="p">);</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="n">AR5K_PHY_SCAL</span><span class="p">);</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">AR5K_PHY_SCLOCK</span><span class="p">);</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">AR5K_PHY_SDELAY</span><span class="p">);</span>
			<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PCICFG</span><span class="p">,</span>
				<span class="n">AR5K_PCICFG_SLEEP_CLOCK_RATE</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Enable sleep clock operation */</span>
		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PCICFG</span><span class="p">,</span>
				<span class="n">AR5K_PCICFG_SLEEP_CLOCK_EN</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* Disable sleep clock operation and</span>
<span class="cm">		 * restore default parameters */</span>
		<span class="n">AR5K_REG_DISABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PCICFG</span><span class="p">,</span>
				<span class="n">AR5K_PCICFG_SLEEP_CLOCK_EN</span><span class="p">);</span>

		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PCICFG</span><span class="p">,</span>
				<span class="n">AR5K_PCICFG_SLEEP_CLOCK_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Set DAC/ADC delays */</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="n">AR5K_PHY_SCR</span><span class="p">);</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SLMT_32MHZ</span><span class="p">,</span> <span class="n">AR5K_PHY_SLMT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_version</span> <span class="o">==</span> <span class="p">(</span><span class="n">AR5K_SREV_AR2417</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">scal</span> <span class="o">=</span> <span class="n">AR5K_PHY_SCAL_32MHZ_2417</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_is_hb63</span><span class="p">)</span>
			<span class="n">scal</span> <span class="o">=</span> <span class="n">AR5K_PHY_SCAL_32MHZ_HB63</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">scal</span> <span class="o">=</span> <span class="n">AR5K_PHY_SCAL_32MHZ</span><span class="p">;</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">scal</span><span class="p">,</span> <span class="n">AR5K_PHY_SCAL</span><span class="p">);</span>

		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SCLOCK_32MHZ</span><span class="p">,</span> <span class="n">AR5K_PHY_SCLOCK</span><span class="p">);</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SDELAY_32MHZ</span><span class="p">,</span> <span class="n">AR5K_PHY_SDELAY</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5112</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5413</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF2316</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_version</span> <span class="o">==</span> <span class="p">(</span><span class="n">AR5K_SREV_AR2417</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)))</span>
			<span class="n">spending</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">spending</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">spending</span><span class="p">,</span> <span class="n">AR5K_PHY_SPENDING</span><span class="p">);</span>

		<span class="cm">/* Set up tsf increment on each cycle */</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TSF_PARM</span><span class="p">,</span> <span class="n">AR5K_TSF_PARM_INC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5112</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5413</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF2316</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF2317</span><span class="p">))</span>
			<span class="n">sclock</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sclock</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_USEC_5211</span><span class="p">,</span> <span class="n">AR5K_USEC_32</span><span class="p">,</span> <span class="n">sclock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*********************\</span>
<span class="cm">* Reset/Sleep control *</span>
<span class="cm">\*********************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_nic_reset() - Reset the various chipset units</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @val: Mask to indicate what units to reset</span>
<span class="cm"> *</span>
<span class="cm"> * To reset the various chipset units we need to write</span>
<span class="cm"> * the mask to AR5K_RESET_CTL and poll the register until</span>
<span class="cm"> * all flags are cleared.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if we are O.K. or -EAGAIN (from athk5_hw_register_timeout)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_nic_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="n">val</span> <span class="o">:</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>

	<span class="cm">/* Read-and-clear RX Descriptor Pointer*/</span>
	<span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_RXDP</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the device and wait until success</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">AR5K_RESET_CTL</span><span class="p">);</span>

	<span class="cm">/* Wait at least 128 PCI clocks */</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">AR5K_RESET_CTL_PCU</span> <span class="o">|</span> <span class="n">AR5K_RESET_CTL_DMA</span>
			<span class="o">|</span> <span class="n">AR5K_RESET_CTL_MAC</span> <span class="o">|</span> <span class="n">AR5K_RESET_CTL_PHY</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">AR5K_RESET_CTL_PCU</span> <span class="o">|</span> <span class="n">AR5K_RESET_CTL_DMA</span>
			<span class="o">|</span> <span class="n">AR5K_RESET_CTL_MAC</span> <span class="o">|</span> <span class="n">AR5K_RESET_CTL_PHY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">AR5K_RESET_CTL_PCU</span> <span class="o">|</span> <span class="n">AR5K_RESET_CTL_BASEBAND</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">AR5K_RESET_CTL_PCU</span> <span class="o">|</span> <span class="n">AR5K_RESET_CTL_BASEBAND</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_register_timeout</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_RESET_CTL</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset configuration register (for hw byte-swap). Note that this</span>
<span class="cm">	 * is only set for big endian. We do the necessary magic in</span>
<span class="cm">	 * AR5K_INIT_CFG.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AR5K_RESET_CTL_PCU</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_INIT_CFG</span><span class="p">,</span> <span class="n">AR5K_CFG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_wisoc_reset() -  Reset AHB chipset</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @flags: Mask to indicate what units to reset</span>
<span class="cm"> *</span>
<span class="cm"> * Same as ath5k_hw_nic_reset but for AHB based devices</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if we are O.K. or -EAGAIN (from athk5_hw_register_timeout)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_wisoc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">?</span> <span class="n">flags</span> <span class="o">:</span> <span class="o">~</span><span class="mi">0U</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* ah-&gt;ah_mac_srev is not available at this point yet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">&gt;=</span> <span class="n">AR5K_SREV_AR2315_R6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">AR5K_AR2315_RESET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AR5K_RESET_CTL_PCU</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">AR5K_AR2315_RESET_WMAC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AR5K_RESET_CTL_BASEBAND</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">AR5K_AR2315_RESET_BB_WARM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">AR5K_AR5312_RESET</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">to_platform_device</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AR5K_RESET_CTL_PCU</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">AR5K_AR5312_RESET_WMAC0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AR5K_RESET_CTL_BASEBAND</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">AR5K_AR5312_RESET_BB0_COLD</span> <span class="o">|</span>
				       <span class="n">AR5K_AR5312_RESET_BB0_WARM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AR5K_RESET_CTL_PCU</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">AR5K_AR5312_RESET_WMAC1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AR5K_RESET_CTL_BASEBAND</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">AR5K_AR5312_RESET_BB1_COLD</span> <span class="o">|</span>
				       <span class="n">AR5K_AR5312_RESET_BB1_WARM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Put BB/MAC into reset */</span>
	<span class="n">regval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">regval</span> <span class="o">|</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">);</span>

	<span class="cm">/* Bring BB/MAC out of reset */</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset configuration register (for hw byte-swap). Note that this</span>
<span class="cm">	 * is only set for big endian. We do the necessary magic in</span>
<span class="cm">	 * AR5K_INIT_CFG.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AR5K_RESET_CTL_PCU</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_INIT_CFG</span><span class="p">,</span> <span class="n">AR5K_CFG</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_set_power_mode() - Set power mode</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @mode: One of enum ath5k_power_mode</span>
<span class="cm"> * @set_chip: Set to true to write sleep control register</span>
<span class="cm"> * @sleep_duration: How much time the device is allowed to sleep</span>
<span class="cm"> * when sleep logic is enabled (in 128 microsecond increments).</span>
<span class="cm"> *</span>
<span class="cm"> * This function is used to configure sleep policy and allowed</span>
<span class="cm"> * sleep modes. For more information check out the sleep control</span>
<span class="cm"> * register on reg.h and STA_ID1.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, -EIO if chip didn&#39;t wake up or -EINVAL if an invalid</span>
<span class="cm"> * mode is requested.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_set_power_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ath5k_power_mode</span> <span class="n">mode</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">set_chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sleep_duration</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">staid</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">staid</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_STA_ID1</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_PM_AUTO</span>:
		<span class="n">staid</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR5K_STA_ID1_DEFAULT_ANTENNA</span><span class="p">;</span>
		<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">AR5K_PM_NETWORK_SLEEP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">set_chip</span><span class="p">)</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
				<span class="n">AR5K_SLEEP_CTL_SLE_ALLOW</span> <span class="o">|</span>
				<span class="n">sleep_duration</span><span class="p">,</span>
				<span class="n">AR5K_SLEEP_CTL</span><span class="p">);</span>

		<span class="n">staid</span> <span class="o">|=</span> <span class="n">AR5K_STA_ID1_PWR_SV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AR5K_PM_FULL_SLEEP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">set_chip</span><span class="p">)</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_SLEEP_CTL_SLE_SLP</span><span class="p">,</span>
				<span class="n">AR5K_SLEEP_CTL</span><span class="p">);</span>

		<span class="n">staid</span> <span class="o">|=</span> <span class="n">AR5K_STA_ID1_PWR_SV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AR5K_PM_AWAKE</span>:

		<span class="n">staid</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR5K_STA_ID1_PWR_SV</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">set_chip</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">commit</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_SLEEP_CTL</span><span class="p">);</span>

		<span class="cm">/* If card is down we &#39;ll get 0xffff... so we</span>
<span class="cm">		 * need to clean this up before we write the register</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xffc00000</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="cm">/* Preserve sleep duration etc */</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AR5K_SLEEP_CTL_SLE</span><span class="p">;</span>

		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">AR5K_SLEEP_CTL_SLE_WAKE</span><span class="p">,</span>
							<span class="n">AR5K_SLEEP_CTL</span><span class="p">);</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check if the chip did wake up */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PCICFG</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">AR5K_PCICFG_SPWR_DN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Wait a bit and retry */</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">);</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">data</span> <span class="o">|</span> <span class="n">AR5K_SLEEP_CTL_SLE_WAKE</span><span class="p">,</span>
							<span class="n">AR5K_SLEEP_CTL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Fail if the chip didn&#39;t wake up */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">commit:</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">staid</span><span class="p">,</span> <span class="n">AR5K_STA_ID1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_on_hold() - Put device on hold</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> *</span>
<span class="cm"> * Put MAC and Baseband on warm reset and keep that state</span>
<span class="cm"> * (don&#39;t clean sleep control register). After this MAC</span>
<span class="cm"> * and Baseband are disabled and a full reset is needed</span>
<span class="cm"> * to come back. This way we save as much power as possible</span>
<span class="cm"> * without putting the card on full sleep.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or -EIO on error</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_on_hold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bus_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_get_bus_type</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">==</span> <span class="n">ATH_AHB</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Make sure device is awake */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_set_power_mode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PM_AWAKE</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;failed to wakeup the MAC Chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Put chipset on warm reset...</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: putting PCI core on warm reset on PCI-E cards</span>
<span class="cm">	 * results card to hang and always return 0xffff... so</span>
<span class="cm">	 * we ignore that flag for PCI-E cards. On PCI cards</span>
<span class="cm">	 * this flag gets cleared after 64 PCI clocks.</span>
<span class="cm">	 */</span>
	<span class="n">bus_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">&amp;&amp;</span> <span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">AR5K_RESET_CTL_PCI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_nic_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_RESET_CTL_PCU</span> <span class="o">|</span>
			<span class="n">AR5K_RESET_CTL_MAC</span> <span class="o">|</span> <span class="n">AR5K_RESET_CTL_DMA</span> <span class="o">|</span>
			<span class="n">AR5K_RESET_CTL_PHY</span> <span class="o">|</span> <span class="n">AR5K_RESET_CTL_PCI</span><span class="p">);</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2500</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_nic_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_RESET_CTL_PCU</span> <span class="o">|</span>
			<span class="n">AR5K_RESET_CTL_BASEBAND</span> <span class="o">|</span> <span class="n">bus_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;failed to put device on warm reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ...wakeup again!*/</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_set_power_mode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PM_AWAKE</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;failed to put device on hold</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_nic_wakeup() - Force card out of sleep</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @channel: The &amp;struct ieee80211_channel</span>
<span class="cm"> *</span>
<span class="cm"> * Bring up MAC + PHY Chips and program PLL</span>
<span class="cm"> * NOTE: Channel is NULL for the initial wakeup.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, -EIO on hw failure or -EINVAL for false channel infos</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_nic_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">turbo</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">bus_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">turbo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ath5k_get_bus_type</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ATH_AHB</span><span class="p">)</span> <span class="o">||</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wakeup the device */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_set_power_mode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PM_AWAKE</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;failed to wakeup the MAC Chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Put chipset on warm reset...</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: putting PCI core on warm reset on PCI-E cards</span>
<span class="cm">	 * results card to hang and always return 0xffff... so</span>
<span class="cm">	 * we ignore that flag for PCI-E cards. On PCI cards</span>
<span class="cm">	 * this flag gets cleared after 64 PCI clocks.</span>
<span class="cm">	 */</span>
	<span class="n">bus_flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">&amp;&amp;</span> <span class="n">pci_is_pcie</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">AR5K_RESET_CTL_PCI</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_nic_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_RESET_CTL_PCU</span> <span class="o">|</span>
			<span class="n">AR5K_RESET_CTL_MAC</span> <span class="o">|</span> <span class="n">AR5K_RESET_CTL_DMA</span> <span class="o">|</span>
			<span class="n">AR5K_RESET_CTL_PHY</span> <span class="o">|</span> <span class="n">AR5K_RESET_CTL_PCI</span><span class="p">);</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2500</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_get_bus_type</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">==</span> <span class="n">ATH_AHB</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_wisoc_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_RESET_CTL_PCU</span> <span class="o">|</span>
				<span class="n">AR5K_RESET_CTL_BASEBAND</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_nic_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_RESET_CTL_PCU</span> <span class="o">|</span>
				<span class="n">AR5K_RESET_CTL_BASEBAND</span> <span class="o">|</span> <span class="n">bus_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;failed to reset the MAC Chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ...wakeup again!...*/</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_set_power_mode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PM_AWAKE</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;failed to resume the MAC Chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ...reset configuration register on Wisoc ...</span>
<span class="cm">	 * ...clear reset control register and pull device out of</span>
<span class="cm">	 * warm reset on others */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_get_bus_type</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">==</span> <span class="n">ATH_AHB</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_wisoc_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_nic_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;failed to warm reset the MAC Chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* On initialization skip PLL programming since we don&#39;t have</span>
<span class="cm">	 * a channel / mode set yet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">!=</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Get channel mode flags</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">&gt;=</span> <span class="n">AR5K_RF5112</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">AR5K_PHY_MODE_RAD_RF5112</span><span class="p">;</span>
			<span class="n">clock</span> <span class="o">=</span> <span class="n">AR5K_PHY_PLL_RF5112</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">AR5K_PHY_MODE_RAD_RF5111</span><span class="p">;</span>	<span class="cm">/*Zero*/</span>
			<span class="n">clock</span> <span class="o">=</span> <span class="n">AR5K_PHY_PLL_RF5111</span><span class="p">;</span>		<span class="cm">/*Zero*/</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">AR5K_PHY_MODE_FREQ_2GHZ</span><span class="p">;</span>
			<span class="n">clock</span> <span class="o">|=</span> <span class="n">AR5K_PHY_PLL_44MHZ</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span> <span class="o">==</span> <span class="n">AR5K_MODE_11B</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mode</span> <span class="o">|=</span> <span class="n">AR5K_PHY_MODE_MOD_CCK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* XXX Dynamic OFDM/CCK is not supported by the</span>
<span class="cm">				 * AR5211 so we set MOD_OFDM for plain g (no</span>
<span class="cm">				 * CCK headers) operation. We need to test</span>
<span class="cm">				 * this, 5211 might support ofdm-only g after</span>
<span class="cm">				 * all, there are also initial register values</span>
<span class="cm">				 * in the code for g mode (see initvals.c).</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5211</span><span class="p">)</span>
					<span class="n">mode</span> <span class="o">|=</span> <span class="n">AR5K_PHY_MODE_MOD_OFDM</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">mode</span> <span class="o">|=</span> <span class="n">AR5K_PHY_MODE_MOD_DYN</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AR5K_PHY_MODE_FREQ_5GHZ</span> <span class="o">|</span>
				 <span class="n">AR5K_PHY_MODE_MOD_OFDM</span><span class="p">);</span>

			<span class="cm">/* Different PLL setting for 5413 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5413</span><span class="p">)</span>
				<span class="n">clock</span> <span class="o">=</span> <span class="n">AR5K_PHY_PLL_40MHZ_5413</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">clock</span> <span class="o">|=</span> <span class="n">AR5K_PHY_PLL_40MHZ</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;invalid radio frequency mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*XXX: Can bwmode be used with dynamic mode ?</span>
<span class="cm">		 * (I don&#39;t think it supports 44MHz) */</span>
		<span class="cm">/* On 2425 initvals TURBO_SHORT is not present */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_bwmode</span> <span class="o">==</span> <span class="n">AR5K_BWMODE_40MHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">turbo</span> <span class="o">=</span> <span class="n">AR5K_PHY_TURBO_MODE</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF2425</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
				<span class="n">AR5K_PHY_TURBO_SHORT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_bwmode</span> <span class="o">!=</span> <span class="n">AR5K_BWMODE_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5413</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_bwmode</span> <span class="o">==</span> <span class="n">AR5K_BWMODE_10MHZ</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">AR5K_PHY_MODE_HALF_RATE</span> <span class="o">:</span>
					<span class="n">AR5K_PHY_MODE_QUARTER_RATE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5212</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">clock</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_bwmode</span> <span class="o">==</span> <span class="n">AR5K_BWMODE_10MHZ</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">AR5K_PHY_PLL_HALF_RATE</span> <span class="o">:</span>
					<span class="n">AR5K_PHY_PLL_QUARTER_RATE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Reset the device */</span>

		<span class="cm">/* ...enable Atheros turbo mode if requested */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_bwmode</span> <span class="o">==</span> <span class="n">AR5K_BWMODE_40MHZ</span><span class="p">)</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_TURBO_MODE</span><span class="p">,</span>
					<span class="n">AR5K_PHY_TURBO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">!=</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* ...update PLL if needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_PLL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">clock</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">clock</span><span class="p">,</span> <span class="n">AR5K_PHY_PLL</span><span class="p">);</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">350</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* ...set the PHY operating mode */</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">AR5K_PHY_MODE</span><span class="p">);</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">turbo</span><span class="p">,</span> <span class="n">AR5K_PHY_TURBO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************************************\</span>
<span class="cm">* Post-initvals register modifications *</span>
<span class="cm">\**************************************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_tweak_initval_settings() - Tweak initial settings</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @channel: The &amp;struct ieee80211_channel</span>
<span class="cm"> *</span>
<span class="cm"> * Some settings are not handled on initvals, e.g. bwmode</span>
<span class="cm"> * settings, some phy settings, workarounds etc that in general</span>
<span class="cm"> * don&#39;t fit anywhere else or are too small to introduce a separate</span>
<span class="cm"> * function for each one. So we have this function to handle</span>
<span class="cm"> * them all during reset and complete card&#39;s initialization.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_hw_tweak_initval_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5212</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_phy_revision</span> <span class="o">&gt;=</span> <span class="n">AR5K_SREV_PHY_5212A</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Setup ADC control */</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
				<span class="p">(</span><span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				<span class="n">AR5K_PHY_ADC_CTL_INBUFGAIN_OFF</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span>
				<span class="n">AR5K_PHY_ADC_CTL_INBUFGAIN_ON</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">AR5K_PHY_ADC_CTL_PWD_DAC_OFF</span> <span class="o">|</span>
				<span class="n">AR5K_PHY_ADC_CTL_PWD_ADC_OFF</span><span class="p">),</span>
				<span class="n">AR5K_PHY_ADC_CTL</span><span class="p">);</span>



		<span class="cm">/* Disable barker RSSI threshold */</span>
		<span class="n">AR5K_REG_DISABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_DAG_CCK_CTL</span><span class="p">,</span>
				<span class="n">AR5K_PHY_DAG_CCK_CTL_EN_RSSI_THR</span><span class="p">);</span>

		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_DAG_CCK_CTL</span><span class="p">,</span>
			<span class="n">AR5K_PHY_DAG_CCK_CTL_RSSI_THR</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="cm">/* Set the mute mask */</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x0000000f</span><span class="p">,</span> <span class="n">AR5K_SEQ_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Clear PHY_BLUETOOTH to allow RX_CLEAR line debug */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_phy_revision</span> <span class="o">&gt;=</span> <span class="n">AR5K_SREV_PHY_5212B</span><span class="p">)</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_PHY_BLUETOOTH</span><span class="p">);</span>

	<span class="cm">/* Enable DCU double buffering */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_phy_revision</span> <span class="o">&gt;</span> <span class="n">AR5K_SREV_PHY_5212B</span><span class="p">)</span>
		<span class="n">AR5K_REG_DISABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TXCFG</span><span class="p">,</span>
				<span class="n">AR5K_TXCFG_DCU_DBL_BUF_DIS</span><span class="p">);</span>

	<span class="cm">/* Set fast ADC */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5413</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF2317</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_version</span> <span class="o">==</span> <span class="p">(</span><span class="n">AR5K_SREV_AR2417</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">fast_adc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span> <span class="o">==</span> <span class="mi">2462</span> <span class="o">||</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span> <span class="o">==</span> <span class="mi">2467</span><span class="p">)</span>
			<span class="n">fast_adc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Only update if needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_FAST_ADC</span><span class="p">)</span> <span class="o">!=</span> <span class="n">fast_adc</span><span class="p">)</span>
				<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">fast_adc</span><span class="p">,</span>
						<span class="n">AR5K_PHY_FAST_ADC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Fix for first revision of the RF5112 RF chipset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">==</span> <span class="n">AR5K_RF5112</span> <span class="o">&amp;&amp;</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_5ghz_revision</span> <span class="o">&lt;</span>
			<span class="n">AR5K_SREV_RAD_5112A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_CCKTXCTL_WORLD</span><span class="p">,</span>
				<span class="n">AR5K_PHY_CCKTXCTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">=</span> <span class="mh">0xffb81020</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">=</span> <span class="mh">0xffb80d20</span><span class="p">;</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">AR5K_PHY_FRAME_CTL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_srev</span> <span class="o">&lt;</span> <span class="n">AR5K_SREV_AR5211</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clear QCU/DCU clock gating register */</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_QCUDCU_CLKGT</span><span class="p">);</span>
		<span class="cm">/* Set DAC/ADC delays */</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SCAL_32MHZ_5311</span><span class="p">,</span>
						<span class="n">AR5K_PHY_SCAL</span><span class="p">);</span>
		<span class="cm">/* Enable PCU FIFO corruption ECO */</span>
		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_DIAG_SW_5211</span><span class="p">,</span>
					<span class="n">AR5K_DIAG_SW_ECO_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_bwmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Increase PHY switch and AGC settling time</span>
<span class="cm">		 * on turbo mode (ath5k_hw_commit_eeprom_settings</span>
<span class="cm">		 * will override settling time if available) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_bwmode</span> <span class="o">==</span> <span class="n">AR5K_BWMODE_40MHZ</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SETTLING</span><span class="p">,</span>
						<span class="n">AR5K_PHY_SETTLING_AGC</span><span class="p">,</span>
						<span class="n">AR5K_AGC_SETTLING_TURBO</span><span class="p">);</span>

			<span class="cm">/* XXX: Initvals indicate we only increase</span>
<span class="cm">			 * switch time on AR5212, 5211 and 5210</span>
<span class="cm">			 * only change agc time (bug?) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5212</span><span class="p">)</span>
				<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SETTLING</span><span class="p">,</span>
						<span class="n">AR5K_PHY_SETTLING_SWITCH</span><span class="p">,</span>
						<span class="n">AR5K_SWITCH_SETTLING_TURBO</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Set Frame Control Register */</span>
				<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					<span class="p">(</span><span class="n">AR5K_PHY_FRAME_CTL_INI</span> <span class="o">|</span>
					<span class="n">AR5K_PHY_TURBO_MODE</span> <span class="o">|</span>
					<span class="n">AR5K_PHY_TURBO_SHORT</span> <span class="o">|</span> <span class="mh">0x2020</span><span class="p">),</span>
					<span class="n">AR5K_PHY_FRAME_CTL_5210</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="cm">/* On 5413 PHY force window length for half/quarter rate*/</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_srev</span> <span class="o">&gt;=</span> <span class="n">AR5K_SREV_AR5424</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_srev</span> <span class="o">&lt;=</span> <span class="n">AR5K_SREV_AR5414</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_FRAME_CTL_5211</span><span class="p">,</span>
						<span class="n">AR5K_PHY_FRAME_CTL_WIN_LEN</span><span class="p">,</span>
						<span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set Frame Control Register for normal operation */</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="p">(</span><span class="n">AR5K_PHY_FRAME_CTL_INI</span> <span class="o">|</span> <span class="mh">0x1020</span><span class="p">),</span>
						<span class="n">AR5K_PHY_FRAME_CTL_5210</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_commit_eeprom_settings() - Commit settings from EEPROM</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @channel: The &amp;struct ieee80211_channel</span>
<span class="cm"> *</span>
<span class="cm"> * Use settings stored on EEPROM to properly initialize the card</span>
<span class="cm"> * based on various infos and per-mode calibration data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_hw_commit_eeprom_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">cck_ofdm_pwr_delta</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ee_mode</span><span class="p">;</span>

	<span class="cm">/* TODO: Add support for AR5210 EEPROM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ee_mode</span> <span class="o">=</span> <span class="n">ath5k_eeprom_mode_from_channel</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* Adjust power delta for channel 14 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span> <span class="o">==</span> <span class="mi">2484</span><span class="p">)</span>
		<span class="n">cck_ofdm_pwr_delta</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_cck_ofdm_power_delta</span> <span class="o">-</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_scaled_cck_delta</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cck_ofdm_pwr_delta</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_cck_ofdm_power_delta</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="cm">/* Set CCK to OFDM power delta on tx power</span>
<span class="cm">	 * adjustment register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_phy_revision</span> <span class="o">&gt;=</span> <span class="n">AR5K_SREV_PHY_5212A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span> <span class="o">==</span> <span class="n">AR5K_MODE_11G</span><span class="p">)</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			<span class="n">AR5K_REG_SM</span><span class="p">((</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_cck_ofdm_gain_delta</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
				<span class="n">AR5K_PHY_TX_PWR_ADJ_CCK_GAIN_DELTA</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">AR5K_REG_SM</span><span class="p">((</span><span class="n">cck_ofdm_pwr_delta</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
				<span class="n">AR5K_PHY_TX_PWR_ADJ_CCK_PCDAC_INDEX</span><span class="p">),</span>
				<span class="n">AR5K_PHY_TX_PWR_ADJ</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_PHY_TX_PWR_ADJ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* For older revs we scale power on sw during tx power</span>
<span class="cm">		 * setup */</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txpower</span><span class="p">.</span><span class="n">txp_cck_ofdm_pwr_delta</span> <span class="o">=</span> <span class="n">cck_ofdm_pwr_delta</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txpower</span><span class="p">.</span><span class="n">txp_cck_ofdm_gainf_delta</span> <span class="o">=</span>
						<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_cck_ofdm_gain_delta</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* XXX: necessary here? is called from ath5k_hw_set_antenna_mode()</span>
<span class="cm">	 * too */</span>
	<span class="n">ath5k_hw_set_antenna_switch</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ee_mode</span><span class="p">);</span>

	<span class="cm">/* Noise floor threshold */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
		<span class="n">AR5K_PHY_NF_SVAL</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_noise_floor_thr</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]),</span>
		<span class="n">AR5K_PHY_NFTHRES</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_bwmode</span> <span class="o">==</span> <span class="n">AR5K_BWMODE_40MHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_5_0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Switch settling time (Turbo) */</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SETTLING</span><span class="p">,</span>
				<span class="n">AR5K_PHY_SETTLING_SWITCH</span><span class="p">,</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_switch_settling_turbo</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>

		<span class="cm">/* Tx/Rx attenuation (Turbo) */</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_GAIN</span><span class="p">,</span>
				<span class="n">AR5K_PHY_GAIN_TXRX_ATTEN</span><span class="p">,</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_atn_tx_rx_turbo</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>

		<span class="cm">/* ADC/PGA desired size (Turbo) */</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_DESIRED_SIZE</span><span class="p">,</span>
				<span class="n">AR5K_PHY_DESIRED_SIZE_ADC</span><span class="p">,</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_adc_desired_size_turbo</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>

		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_DESIRED_SIZE</span><span class="p">,</span>
				<span class="n">AR5K_PHY_DESIRED_SIZE_PGA</span><span class="p">,</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pga_desired_size_turbo</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>

		<span class="cm">/* Tx/Rx margin (Turbo) */</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_GAIN_2GHZ</span><span class="p">,</span>
				<span class="n">AR5K_PHY_GAIN_2GHZ_MARGIN_TXRX</span><span class="p">,</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_margin_tx_rx_turbo</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Switch settling time */</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SETTLING</span><span class="p">,</span>
				<span class="n">AR5K_PHY_SETTLING_SWITCH</span><span class="p">,</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_switch_settling</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>

		<span class="cm">/* Tx/Rx attenuation */</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_GAIN</span><span class="p">,</span>
				<span class="n">AR5K_PHY_GAIN_TXRX_ATTEN</span><span class="p">,</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_atn_tx_rx</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>

		<span class="cm">/* ADC/PGA desired size */</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_DESIRED_SIZE</span><span class="p">,</span>
				<span class="n">AR5K_PHY_DESIRED_SIZE_ADC</span><span class="p">,</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_adc_desired_size</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>

		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_DESIRED_SIZE</span><span class="p">,</span>
				<span class="n">AR5K_PHY_DESIRED_SIZE_PGA</span><span class="p">,</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pga_desired_size</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>

		<span class="cm">/* Tx/Rx margin */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_1</span><span class="p">)</span>
			<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_GAIN_2GHZ</span><span class="p">,</span>
				<span class="n">AR5K_PHY_GAIN_2GHZ_MARGIN_TXRX</span><span class="p">,</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_margin_tx_rx</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* XPA delays */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
		<span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_tx_end2xpa_disable</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_tx_end2xpa_disable</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_tx_frm2xpa_enable</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_tx_frm2xpa_enable</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]),</span> <span class="n">AR5K_PHY_RF_CTL4</span><span class="p">);</span>

	<span class="cm">/* XLNA delay */</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_RF_CTL3</span><span class="p">,</span>
			<span class="n">AR5K_PHY_RF_CTL3_TXE2XLNA_ON</span><span class="p">,</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_tx_end2xlna_enable</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>

	<span class="cm">/* Thresh64 (ANI) */</span>
	<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_NF</span><span class="p">,</span>
			<span class="n">AR5K_PHY_NF_THRESH62</span><span class="p">,</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_thr_62</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>

	<span class="cm">/* False detect backoff for channels</span>
<span class="cm">	 * that have spur noise. Write the new</span>
<span class="cm">	 * cyclic power RSSI threshold. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_hw_chan_has_spur_noise</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_OFDM_SELFCORR</span><span class="p">,</span>
				<span class="n">AR5K_PHY_OFDM_SELFCORR_CYPWR_THR1</span><span class="p">,</span>
				<span class="n">AR5K_INIT_CYCRSSI_THR1</span> <span class="o">+</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_false_detect</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_OFDM_SELFCORR</span><span class="p">,</span>
				<span class="n">AR5K_PHY_OFDM_SELFCORR_CYPWR_THR1</span><span class="p">,</span>
				<span class="n">AR5K_INIT_CYCRSSI_THR1</span><span class="p">);</span>

	<span class="cm">/* I/Q correction (set enable bit last to match HAL sources) */</span>
	<span class="cm">/* TODO: Per channel i/q infos ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_IQ</span><span class="p">,</span> <span class="n">AR5K_PHY_IQ_CORR_Q_I_COFF</span><span class="p">,</span>
			    <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_i_cal</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>
		<span class="n">AR5K_REG_WRITE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_IQ</span><span class="p">,</span> <span class="n">AR5K_PHY_IQ_CORR_Q_Q_COFF</span><span class="p">,</span>
			    <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_q_cal</span><span class="p">[</span><span class="n">ee_mode</span><span class="p">]);</span>
		<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_IQ</span><span class="p">,</span> <span class="n">AR5K_PHY_IQ_CORR_ENABLE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Heavy clipping -disable for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_5_1</span><span class="p">)</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AR5K_PHY_HEAVY_CLIP_ENABLE</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*********************\</span>
<span class="cm">* Main reset function *</span>
<span class="cm">\*********************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_reset() - The main reset function</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @op_mode: One of enum nl80211_iftype</span>
<span class="cm"> * @channel: The &amp;struct ieee80211_channel</span>
<span class="cm"> * @fast: Enable fast channel switching</span>
<span class="cm"> * @skip_pcu: Skip pcu initialization</span>
<span class="cm"> *</span>
<span class="cm"> * This is the function we call each time we want to (re)initialize the</span>
<span class="cm"> * card and pass new settings to hw. We also call it when hw runs into</span>
<span class="cm"> * trouble to make it come back to a working state.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success, -EINVAL on false op_mode or channel infos, or -EIO</span>
<span class="cm"> * on failure.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">op_mode</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span> <span class="n">bool</span> <span class="n">fast</span><span class="p">,</span> <span class="n">bool</span> <span class="n">skip_pcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">s_seq</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">s_led</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">tsf_up</span><span class="p">,</span> <span class="n">tsf_lo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">tsf_up</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tsf_lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity check for fast flag</span>
<span class="cm">	 * Fast channel change only available</span>
<span class="cm">	 * on AR2413/AR5413.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fast</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">!=</span> <span class="n">AR5K_RF2413</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">!=</span> <span class="n">AR5K_RF5413</span><span class="p">))</span>
		<span class="n">fast</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Disable sleep clock operation</span>
<span class="cm">	 * to avoid register access delay on certain</span>
<span class="cm">	 * PHY registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5212</span><span class="p">)</span>
		<span class="n">ath5k_hw_set_sleep_clock</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop PCU</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_hw_stop_rx_pcu</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop DMA</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: If DMA didn&#39;t stop continue</span>
<span class="cm">	 * since only a reset will fix it.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_dma_stop</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/* RF Bus grant won&#39;t work if we have pending</span>
<span class="cm">	 * frames */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">fast</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span>
			<span class="s">&quot;DMA didn&#39;t stop, falling back to normal reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">fast</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="cm">/* Non fatal, just continue with</span>
<span class="cm">		 * normal reset */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_MODE_11A</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_MODE_11G</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">&lt;=</span> <span class="n">AR5K_AR5211</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
				<span class="s">&quot;G mode not available on 5210/5211&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_MODE_11B</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">&lt;</span> <span class="n">AR5K_AR5211</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
				<span class="s">&quot;B mode not available on 5210&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			<span class="s">&quot;invalid channel: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If driver requested fast channel change and DMA has stopped</span>
<span class="cm">	 * go on. If it fails continue with a normal reset.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fast</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_phy_init</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span>
				<span class="s">&quot;fast chan change failed, falling back to normal reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Non fatal, can happen eg.</span>
<span class="cm">			 * on mode change */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span>
				<span class="s">&quot;fast chan change successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Save some registers before a reset</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">!=</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Save frame sequence count</span>
<span class="cm">		 * For revs. after Oahu, only save</span>
<span class="cm">		 * seq num for DCU 0 (Global seq num)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_srev</span> <span class="o">&lt;</span> <span class="n">AR5K_SREV_AR5211</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">s_seq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					<span class="n">AR5K_QUEUE_DCU_SEQNUM</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">s_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					<span class="n">AR5K_QUEUE_DCU_SEQNUM</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* TSF accelerates on AR5211 during reset</span>
<span class="cm">		 * As a workaround save it here and restore</span>
<span class="cm">		 * it later so that it&#39;s back in time after</span>
<span class="cm">		 * reset. This way it&#39;ll get re-synced on the</span>
<span class="cm">		 * next beacon without breaking ad-hoc.</span>
<span class="cm">		 *</span>
<span class="cm">		 * On AR5212 TSF is almost preserved across a</span>
<span class="cm">		 * reset so it stays back in time anyway and</span>
<span class="cm">		 * we don&#39;t have to save/restore it.</span>
<span class="cm">		 *</span>
<span class="cm">		 * XXX: Since this breaks power saving we have</span>
<span class="cm">		 * to disable power saving until we receive the</span>
<span class="cm">		 * next beacon, so we can resync beacon timers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5211</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tsf_up</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TSF_U32</span><span class="p">);</span>
			<span class="n">tsf_lo</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TSF_L32</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="cm">/*GPIOs*/</span>
	<span class="n">s_led</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PCICFG</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="n">AR5K_PCICFG_LEDSTATE</span><span class="p">;</span>
	<span class="n">s_led</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_GPIOCR</span><span class="p">);</span>
	<span class="n">s_led</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_GPIODO</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * Since we are going to write rf buffer</span>
<span class="cm">	 * check if we have any pending gain_F</span>
<span class="cm">	 * optimization settings</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5212</span> <span class="o">&amp;&amp;</span>
	<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio</span> <span class="o">&lt;=</span> <span class="n">AR5K_RF5112</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fast</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_rf_banks</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">ath5k_hw_gainf_calibrate</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Wakeup the device */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_nic_wakeup</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* PHY access enable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_srev</span> <span class="o">&gt;=</span> <span class="n">AR5K_SREV_AR5211</span><span class="p">)</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SHIFT_5GHZ</span><span class="p">,</span> <span class="n">AR5K_PHY</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PHY_SHIFT_5GHZ</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">,</span>
							<span class="n">AR5K_PHY</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Write initial settings */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_write_initvals</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">skip_pcu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Initialize core clock settings */</span>
	<span class="n">ath5k_hw_init_core_clock</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tweak initval settings for revised</span>
<span class="cm">	 * chipsets and add some more config</span>
<span class="cm">	 * bits</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_hw_tweak_initval_settings</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* Commit values from EEPROM */</span>
	<span class="n">ath5k_hw_commit_eeprom_settings</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * Restore saved values</span>
<span class="cm">	 */</span>

	<span class="cm">/* Seqnum, TSF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">!=</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_srev</span> <span class="o">&lt;</span> <span class="n">AR5K_SREV_AR5211</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">s_seq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					<span class="n">AR5K_QUEUE_DCU_SEQNUM</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">s_seq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">AR5K_QUEUE_DCU_SEQNUM</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5211</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">tsf_up</span><span class="p">,</span> <span class="n">AR5K_TSF_U32</span><span class="p">);</span>
			<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">tsf_lo</span><span class="p">,</span> <span class="n">AR5K_TSF_L32</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Ledstate */</span>
	<span class="n">AR5K_REG_ENABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_PCICFG</span><span class="p">,</span> <span class="n">s_led</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Gpio settings */</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">s_led</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">AR5K_GPIOCR</span><span class="p">);</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">s_led</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">AR5K_GPIODO</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize PCU</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_hw_pcu_init</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">op_mode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initialize PHY</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_phy_init</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			<span class="s">&quot;failed to initialize PHY (%i) !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configure QCUs/DCUs</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_init_queues</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * Initialize DMA/Interrupts</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_hw_dma_init</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 * Enable 32KHz clock function for AR5212+ chips</span>
<span class="cm">	 * Set clocks to 32KHz operation and use an</span>
<span class="cm">	 * external 32KHz crystal when sleeping if one</span>
<span class="cm">	 * exists.</span>
<span class="cm">	 * Disabled by default because it is also disabled in</span>
<span class="cm">	 * other drivers and it is known to cause stability</span>
<span class="cm">	 * issues on some devices</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_use_32khz_clock</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5212</span> <span class="o">&amp;&amp;</span>
	    <span class="n">op_mode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
		<span class="n">ath5k_hw_set_sleep_clock</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable beacons and reset the TSF</span>
<span class="cm">	 */</span>
	<span class="n">AR5K_REG_DISABLE_BITS</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_BEACON</span><span class="p">,</span> <span class="n">AR5K_BEACON_ENABLE</span><span class="p">);</span>
	<span class="n">ath5k_hw_reset_tsf</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
