<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath5k › mac80211-ops.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>mac80211-ops.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*-</span>
<span class="cm"> * Copyright (c) 2002-2005 Sam Leffler, Errno Consulting</span>
<span class="cm"> * Copyright (c) 2004-2005 Atheros Communications, Inc.</span>
<span class="cm"> * Copyright (c) 2006 Devicescape Software, Inc.</span>
<span class="cm"> * Copyright (c) 2007 Jiri Slaby &lt;jirislaby@gmail.com&gt;</span>
<span class="cm"> * Copyright (c) 2007 Luis R. Rodriguez &lt;mcgrof@winlab.rutgers.edu&gt;</span>
<span class="cm"> * Copyright (c) 2010 Bruno Randolf &lt;br1@einfach.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer,</span>
<span class="cm"> *    without modification.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce at minimum a disclaimer</span>
<span class="cm"> *    similar to the &quot;NO WARRANTY&quot; disclaimer below (&quot;Disclaimer&quot;) and any</span>
<span class="cm"> *    redistribution must be conditioned upon including a substantially</span>
<span class="cm"> *    similar Disclaimer requirement for further binary redistribution.</span>
<span class="cm"> * 3. Neither the names of the above-listed copyright holders nor the names</span>
<span class="cm"> *    of any contributors may be used to endorse or promote products derived</span>
<span class="cm"> *    from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;) version 2 as published by the Free</span>
<span class="cm"> * Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * NO WARRANTY</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF NONINFRINGEMENT, MERCHANTIBILITY</span>
<span class="cm"> * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY,</span>
<span class="cm"> * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="cm"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER</span>
<span class="cm"> * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF</span>
<span class="cm"> * THE POSSIBILITY OF SUCH DAMAGES.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;ath5k.h&quot;</span>
<span class="cp">#include &quot;base.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>

<span class="cm">/********************\</span>
<span class="cm">* Mac80211 functions *</span>
<span class="cm">\********************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qnum</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">qnum</span> <span class="o">&gt;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_queues</span><span class="p">.</span><span class="n">q_tx_num</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath5k_tx_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">qnum</span><span class="p">]);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_vif</span> <span class="o">*</span><span class="n">avf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
	     <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_ap_vifs</span> <span class="o">+</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_adhoc_vifs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ATH_BCBUF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ELNRNG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Don&#39;t allow other interfaces if one ad-hoc is configured.</span>
<span class="cm">	 * TODO: Fix the problems with ad-hoc and multiple other interfaces.</span>
<span class="cm">	 * We would need to operate the HW in ad-hoc mode to allow TSF updates</span>
<span class="cm">	 * for the IBSS, but this breaks with additional AP or STA interfaces</span>
<span class="cm">	 * at the moment. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_adhoc_vifs</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">nvifs</span> <span class="o">&amp;&amp;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;Only one single ad-hoc interface is allowed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ELNRNG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nvifs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_MODE</span><span class="p">,</span> <span class="s">&quot;add interface mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">);</span>

	<span class="cm">/* Assign the vap/adhoc to a beacon xmit slot. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bcbuf</span><span class="p">));</span>
		<span class="n">avf</span><span class="o">-&gt;</span><span class="n">bbuf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bcbuf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_buf</span><span class="p">,</span>
					     <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">bbuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">avf</span><span class="o">-&gt;</span><span class="n">bslot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">ATH_BCBUF</span><span class="p">;</span> <span class="n">slot</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bslot</span><span class="p">[</span><span class="n">slot</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">avf</span><span class="o">-&gt;</span><span class="n">bslot</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bslot</span><span class="p">[</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">bslot</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bslot</span><span class="p">[</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">bslot</span><span class="p">]</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_ap_vifs</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_adhoc_vifs</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_mesh_vifs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Any MAC address is fine, all others are included through the</span>
<span class="cm">	 * filter.</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_hw_set_lladdr</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">ath5k_update_bssid_mask_and_opmode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">end:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_vif</span> <span class="o">*</span><span class="n">avf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nvifs</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">bbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath5k_txbuf_free_skb</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">avf</span><span class="o">-&gt;</span><span class="n">bbuf</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">bbuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bcbuf</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH_BCBUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bslot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bslot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">avf</span><span class="o">-&gt;</span><span class="n">bbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_ap_vifs</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_adhoc_vifs</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_mesh_vifs</span><span class="o">--</span><span class="p">;</span>

	<span class="n">ath5k_update_bssid_mask_and_opmode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * TODO: Phy disable/diversity etc</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_chan_set</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_POWER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">!=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>

		<span class="cm">/* Half dB steps */</span>
		<span class="n">ath5k_hw_set_txpower_limit</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_RETRY_LIMITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_retry_long</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">long_frame_max_tx_count</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_retry_short</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">short_frame_max_tx_count</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_queues</span><span class="p">.</span><span class="n">q_tx_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ath5k_hw_set_tx_retry_limits</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* TODO:</span>
<span class="cm">	 * 1) Move this on config_interface and handle each case</span>
<span class="cm">	 * separately eg. when we have only one STA vif, use</span>
<span class="cm">	 * AR5K_ANTMODE_SINGLE_AP</span>
<span class="cm">	 *</span>
<span class="cm">	 * 2) Allow the user to change antenna mode eg. when only</span>
<span class="cm">	 * one antenna is present</span>
<span class="cm">	 *</span>
<span class="cm">	 * 3) Allow the user to set default/tx antenna when possible</span>
<span class="cm">	 *</span>
<span class="cm">	 * 4) Default mode should handle 90% of the cases, together</span>
<span class="cm">	 * with fixed a/b and single AP modes we should be able to</span>
<span class="cm">	 * handle 99%. Sectored modes are extreme cases and i still</span>
<span class="cm">	 * haven&#39;t found a usage for them. If we decide to support them,</span>
<span class="cm">	 * then we must allow the user to set how many tx antennas we</span>
<span class="cm">	 * have available</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_hw_set_antenna_mode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ant_mode</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_vif</span> <span class="o">*</span><span class="n">avf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Cache for later use during resets */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">curaid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ath5k_hw_set_bssid</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bintval</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">slot_time</span><span class="p">;</span>

		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_short_slot</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_slot</span><span class="p">;</span>
		<span class="n">slot_time</span> <span class="o">=</span> <span class="n">ath5k_hw_get_default_slottime</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">+</span>
			    <span class="mi">3</span> <span class="o">*</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_coverage_class</span><span class="p">;</span>
		<span class="n">ath5k_hw_set_ifs_intervals</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">slot_time</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">avf</span><span class="o">-&gt;</span><span class="n">assoc</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">assoc</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">assoc</span> <span class="o">=</span> <span class="n">ath5k_any_vif_assoc</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
			<span class="n">ath5k_set_beacon_filter</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">);</span>
		<span class="n">ath5k_hw_set_ledstate</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">assoc</span> <span class="o">?</span>
			<span class="n">AR5K_LED_ASSOC</span> <span class="o">:</span> <span class="n">AR5K_LED_INIT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANY</span><span class="p">,</span>
				  <span class="s">&quot;Bss Info ASSOC %d, bssid: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">);</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">curaid</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">;</span>
			<span class="n">ath5k_hw_set_bssid</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
			<span class="cm">/* Once ANI is available you would start it here */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ath5k_beacon_update</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">enable_beacon</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BSS_CHANGED_BEACON</span> <span class="o">|</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span> <span class="o">|</span>
		       <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">))</span>
		<span class="n">ath5k_beacon_config</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u64</span>
<span class="nf">ath5k_prepare_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">netdev_hw_addr_list</span> <span class="o">*</span><span class="n">mc_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">mfilt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mfilt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">netdev_hw_addr_list_for_each</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mc_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* calculate XOR of eight 6-bit values */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">^</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">^=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">^</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">mfilt</span><span class="p">[</span><span class="n">pos</span> <span class="o">/</span> <span class="mi">32</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pos</span> <span class="o">%</span> <span class="mi">32</span><span class="p">));</span>
		<span class="cm">/* XXX: we might be able to just do this instead,</span>
<span class="cm">		* but not sure, needs testing, if we do use this we&#39;d</span>
<span class="cm">		* need to inform below not to reset the mcast */</span>
		<span class="cm">/* ath5k_hw_set_mcast_filterindex(ah,</span>
<span class="cm">		 *      ha-&gt;addr[5]); */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">mfilt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * o always accept unicast, broadcast, and multicast traffic</span>
<span class="cm"> * o multicast traffic for all BSSIDs will be enabled if mac80211</span>
<span class="cm"> *   says it should be</span>
<span class="cm"> * o maintain current state of phy ofdm or phy cck error reception.</span>
<span class="cm"> *   If the hardware detects any of these type of errors then</span>
<span class="cm"> *   ath5k_hw_get_rx_filter() will pass to us the respective</span>
<span class="cm"> *   hardware filters to be able to receive these type of frames.</span>
<span class="cm"> * o probe request frames are accepted only when operating in</span>
<span class="cm"> *   hostap, adhoc, or monitor modes</span>
<span class="cm"> * o enable promiscuous mode according to the interface state</span>
<span class="cm"> * o accept beacons:</span>
<span class="cm"> *   - when operating in adhoc mode so the 802.11 layer creates</span>
<span class="cm"> *     node table entries for peers,</span>
<span class="cm"> *   - when operating in station mode for collecting rssi data when</span>
<span class="cm"> *     the station is otherwise quiet, or</span>
<span class="cm"> *   - when scanning</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">new_flags</span><span class="p">,</span> <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define SUPPORTED_FIF_FLAGS \</span>
<span class="cp">	(FIF_PROMISC_IN_BSS |  FIF_ALLMULTI | FIF_FCSFAIL | \</span>
<span class="cp">	FIF_PLCPFAIL | FIF_CONTROL | FIF_OTHER_BSS | \</span>
<span class="cp">	FIF_BCN_PRBRESP_PROMISC)</span>

	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rfilt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_vif_iter_data</span> <span class="n">iter_data</span><span class="p">;</span> <span class="cm">/* to count STA interfaces */</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mfilt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">multicast</span><span class="p">;</span>
	<span class="n">mfilt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">multicast</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>

	<span class="cm">/* Only deal with supported flags */</span>
	<span class="n">changed_flags</span> <span class="o">&amp;=</span> <span class="n">SUPPORTED_FIF_FLAGS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;=</span> <span class="n">SUPPORTED_FIF_FLAGS</span><span class="p">;</span>

	<span class="cm">/* If HW detects any phy or radar errors, leave those filters on.</span>
<span class="cm">	 * Also, always enable Unicast, Broadcasts and Multicast</span>
<span class="cm">	 * XXX: move unicast, bssid broadcasts and multicast to mac80211 */</span>
	<span class="n">rfilt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ath5k_hw_get_rx_filter</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AR5K_RX_FILTER_PHYERR</span><span class="p">))</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">AR5K_RX_FILTER_UCAST</span> <span class="o">|</span> <span class="n">AR5K_RX_FILTER_BCAST</span> <span class="o">|</span>
		<span class="n">AR5K_RX_FILTER_MCAST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIF_PROMISC_IN_BSS</span> <span class="o">|</span> <span class="n">FIF_OTHER_BSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">)</span>
			<span class="n">__set_bit</span><span class="p">(</span><span class="n">ATH_STAT_PROMISC</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">__clear_bit</span><span class="p">(</span><span class="n">ATH_STAT_PROMISC</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATH_STAT_PROMISC</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">AR5K_RX_FILTER_PROM</span><span class="p">;</span>

	<span class="cm">/* Note, AR5K_RX_FILTER_MCAST is already enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">FIF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfilt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">mfilt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This is the best we can do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIF_FCSFAIL</span> <span class="o">|</span> <span class="n">FIF_PLCPFAIL</span><span class="p">))</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">AR5K_RX_FILTER_PHYERR</span><span class="p">;</span>

	<span class="cm">/* FIF_BCN_PRBRESP_PROMISC really means to enable beacons</span>
<span class="cm">	* and probes for any BSSID */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">nvifs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">AR5K_RX_FILTER_BEACON</span><span class="p">;</span>

	<span class="cm">/* FIF_CONTROL doc says that if FIF_PROMISC_IN_BSS is not</span>
<span class="cm">	 * set we should only pass on control frames for this</span>
<span class="cm">	 * station. This needs testing. I believe right now this</span>
<span class="cm">	 * enables *all* control frames, which is OK.. but</span>
<span class="cm">	 * but we should see if we can improve on granularity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">)</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">AR5K_RX_FILTER_CONTROL</span><span class="p">;</span>

	<span class="cm">/* Additional settings per mode -- this is per ath5k */</span>

	<span class="cm">/* XXX move these to mac80211, and add a beacon IFF flag to mac80211 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">AR5K_RX_FILTER_CONTROL</span> <span class="o">|</span>
			 <span class="n">AR5K_RX_FILTER_BEACON</span> <span class="o">|</span>
			 <span class="n">AR5K_RX_FILTER_PROBEREQ</span> <span class="o">|</span>
			 <span class="n">AR5K_RX_FILTER_PROM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">AR5K_RX_FILTER_PROBEREQ</span> <span class="o">|</span>
			 <span class="n">AR5K_RX_FILTER_BEACON</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span>
			<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">AR5K_RX_FILTER_BEACON</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iter_data</span><span class="p">.</span><span class="n">hw_macaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">n_stas</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">need_set_hw_addr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ath5k_vif_iter</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">iter_data</span><span class="p">);</span>

	<span class="cm">/* Set up RX Filter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="p">.</span><span class="n">n_stas</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If you have multiple STA interfaces connected to</span>
<span class="cm">		 * different APs, ARPs are not received (most of the time?)</span>
<span class="cm">		 * Enabling PROMISC appears to fix that problem.</span>
<span class="cm">		 */</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">AR5K_RX_FILTER_PROM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set filters */</span>
	<span class="n">ath5k_hw_set_rx_filter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">rfilt</span><span class="p">);</span>

	<span class="cm">/* Set multicast bits */</span>
	<span class="n">ath5k_hw_set_mcast_filter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="cm">/* Set the cached hw filter flags, this will later actually</span>
<span class="cm">	 * be set in HW */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="n">rfilt</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_modparam_nohwcrypt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span> <span class="o">||</span>
	     <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t program group keys when using IBSS_RSN */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">crypt_caps</span> <span class="o">&amp;</span> <span class="n">ATH_CRYPT_CAP_CIPHER_AESCCM</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_KEY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath_key_config</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="cm">/* push IV and Michael MIC generation to stack */</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_IV</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">)</span>
				<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_MMIC</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">)</span>
				<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_SW_MGMT</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISABLE_KEY</span>:
		<span class="n">ath_key_delete</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_sw_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span>
		<span class="n">ath5k_hw_set_ledstate</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_LED_SCAN</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_sw_scan_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">ath5k_hw_set_ledstate</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">assoc</span> <span class="o">?</span>
		<span class="n">AR5K_LED_ASSOC</span> <span class="o">:</span> <span class="n">AR5K_LED_INIT</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ieee80211_low_level_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Force update */</span>
	<span class="n">ath5k_hw_update_mib_counters</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11ACKFailureCount</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ack_fail</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11RTSFailureCount</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rts_fail</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11RTSSuccessCount</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rts_ok</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11FCSErrorCount</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">fcs_error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">queue</span><span class="p">,</span>
	      <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_txq_info</span> <span class="n">qi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_queues</span><span class="p">.</span><span class="n">q_tx_num</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ath5k_hw_get_tx_queueprops</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>

	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_aifs</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cw_min</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cw_max</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_burst_time</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">;</span>

	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANY</span><span class="p">,</span>
		  <span class="s">&quot;Configure tx [queue %d],  &quot;</span>
		  <span class="s">&quot;aifs: %d, cw_min: %d, cw_max: %d, txop: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">queue</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">,</span>
		  <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_hw_set_tx_queueprops</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			  <span class="s">&quot;Unable to update hardware queue %u!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ath5k_hw_reset_tx_queue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u64</span>
<span class="nf">ath5k_get_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath5k_hw_get_tsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_set_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">ath5k_hw_set_tsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">tsf</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_reset_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * in IBSS mode we need to update the beacon timers too.</span>
<span class="cm">	 * this will also reset the TSF if we call it with 0</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="n">ath5k_beacon_update_timers</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ath5k_hw_reset_tsf</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_get_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_cycle_counters</span> <span class="o">*</span><span class="n">cc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_survey</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">div</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">clockrate</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
	<span class="n">ath_hw_cycle_counters_update</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cycles</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">.</span><span class="n">channel_time</span> <span class="o">+=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">cycles</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">.</span><span class="n">channel_time_busy</span> <span class="o">+=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">rx_busy</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">.</span><span class="n">channel_time_rx</span> <span class="o">+=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">rx_frame</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">.</span><span class="n">channel_time_tx</span> <span class="o">+=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">tx_frame</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cc</span><span class="p">));</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">survey</span><span class="p">));</span>

	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_noise_floor</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="n">SURVEY_INFO_NOISE_DBM</span> <span class="o">|</span>
			<span class="n">SURVEY_INFO_CHANNEL_TIME</span> <span class="o">|</span>
			<span class="n">SURVEY_INFO_CHANNEL_TIME_BUSY</span> <span class="o">|</span>
			<span class="n">SURVEY_INFO_CHANNEL_TIME_RX</span> <span class="o">|</span>
			<span class="n">SURVEY_INFO_CHANNEL_TIME_TX</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * ath5k_set_coverage_class - Set IEEE 802.11 coverage class</span>
<span class="cm"> *</span>
<span class="cm"> * @hw: struct ieee80211_hw pointer</span>
<span class="cm"> * @coverage_class: IEEE 802.11 coverage class number</span>
<span class="cm"> *</span>
<span class="cm"> * Mac80211 callback. Sets slot time, ACK timeout and CTS timeout for given</span>
<span class="cm"> * coverage class. The values are persistent, they are restored after device</span>
<span class="cm"> * reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_set_coverage_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">coverage_class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ath5k_hw_set_coverage_class</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">coverage_class</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_set_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx_ant</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ant</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">rx_ant</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ath5k_hw_set_antenna_mode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_ANTMODE_FIXED_A</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tx_ant</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">rx_ant</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">ath5k_hw_set_antenna_mode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_ANTMODE_FIXED_B</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tx_ant</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rx_ant</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">ath5k_hw_set_antenna_mode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_ANTMODE_DEFAULT</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_get_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tx_ant</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx_ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ant_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_ANTMODE_FIXED_A</span>:
		<span class="o">*</span><span class="n">tx_ant</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="o">*</span><span class="n">rx_ant</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_ANTMODE_FIXED_B</span>:
		<span class="o">*</span><span class="n">tx_ant</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="o">*</span><span class="n">rx_ant</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_ANTMODE_DEFAULT</span>:
		<span class="o">*</span><span class="n">tx_ant</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="o">*</span><span class="n">rx_ant</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath5k_get_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tx_max</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tx</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">AR5K_TX_QUEUE_ID_DATA_MIN</span><span class="p">].</span><span class="n">txq_max</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tx_max</span> <span class="o">=</span> <span class="n">ATH5K_TXQ_LEN_MAX</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rx</span> <span class="o">=</span> <span class="o">*</span><span class="n">rx_max</span> <span class="o">=</span> <span class="n">ATH_RXBUF</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath5k_set_ringparam</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qnum</span><span class="p">;</span>

	<span class="cm">/* only support setting tx ring size for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span> <span class="o">!=</span> <span class="n">ATH_RXBUF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* restrict tx ring size min/max */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span> <span class="o">||</span> <span class="n">tx</span> <span class="o">&gt;</span> <span class="n">ATH5K_TXQ_LEN_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">qnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qnum</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">);</span> <span class="n">qnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">qnum</span><span class="p">].</span><span class="n">setup</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">qnum</span><span class="p">].</span><span class="n">qnum</span> <span class="o">&lt;</span> <span class="n">AR5K_TX_QUEUE_ID_DATA_MIN</span> <span class="o">||</span>
		    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">qnum</span><span class="p">].</span><span class="n">qnum</span> <span class="o">&gt;</span> <span class="n">AR5K_TX_QUEUE_ID_DATA_MAX</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">qnum</span><span class="p">].</span><span class="n">txq_max</span> <span class="o">=</span> <span class="n">tx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">qnum</span><span class="p">].</span><span class="n">txq_len</span> <span class="o">&gt;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">qnum</span><span class="p">].</span><span class="n">txq_max</span><span class="p">)</span>
			<span class="n">ieee80211_stop_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">qnum</span><span class="p">].</span><span class="n">qnum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">ath5k_hw_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span>			<span class="o">=</span> <span class="n">ath5k_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>			<span class="o">=</span> <span class="n">ath5k_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>			<span class="o">=</span> <span class="n">ath5k_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span>		<span class="o">=</span> <span class="n">ath5k_add_interface</span><span class="p">,</span>
	<span class="cm">/* .change_interface	= not implemented */</span>
	<span class="p">.</span><span class="n">remove_interface</span>	<span class="o">=</span> <span class="n">ath5k_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span>			<span class="o">=</span> <span class="n">ath5k_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span>	<span class="o">=</span> <span class="n">ath5k_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_multicast</span>	<span class="o">=</span> <span class="n">ath5k_prepare_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span>	<span class="o">=</span> <span class="n">ath5k_configure_filter</span><span class="p">,</span>
	<span class="cm">/* .set_tim		= not implemented */</span>
	<span class="p">.</span><span class="n">set_key</span>		<span class="o">=</span> <span class="n">ath5k_set_key</span><span class="p">,</span>
	<span class="cm">/* .update_tkip_key	= not implemented */</span>
	<span class="cm">/* .hw_scan		= not implemented */</span>
	<span class="p">.</span><span class="n">sw_scan_start</span>		<span class="o">=</span> <span class="n">ath5k_sw_scan_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sw_scan_complete</span>	<span class="o">=</span> <span class="n">ath5k_sw_scan_complete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span>		<span class="o">=</span> <span class="n">ath5k_get_stats</span><span class="p">,</span>
	<span class="cm">/* .get_tkip_seq	= not implemented */</span>
	<span class="cm">/* .set_frag_threshold	= not implemented */</span>
	<span class="cm">/* .set_rts_threshold	= not implemented */</span>
	<span class="cm">/* .sta_add		= not implemented */</span>
	<span class="cm">/* .sta_remove		= not implemented */</span>
	<span class="cm">/* .sta_notify		= not implemented */</span>
	<span class="p">.</span><span class="n">conf_tx</span>		<span class="o">=</span> <span class="n">ath5k_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tsf</span>		<span class="o">=</span> <span class="n">ath5k_get_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tsf</span>		<span class="o">=</span> <span class="n">ath5k_set_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_tsf</span>		<span class="o">=</span> <span class="n">ath5k_reset_tsf</span><span class="p">,</span>
	<span class="cm">/* .tx_last_beacon	= not implemented */</span>
	<span class="cm">/* .ampdu_action	= not needed */</span>
	<span class="p">.</span><span class="n">get_survey</span>		<span class="o">=</span> <span class="n">ath5k_get_survey</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coverage_class</span>	<span class="o">=</span> <span class="n">ath5k_set_coverage_class</span><span class="p">,</span>
	<span class="cm">/* .rfkill_poll		= not implemented */</span>
	<span class="cm">/* .flush		= not implemented */</span>
	<span class="cm">/* .channel_switch	= not implemented */</span>
	<span class="cm">/* .napi_poll		= not implemented */</span>
	<span class="p">.</span><span class="n">set_antenna</span>		<span class="o">=</span> <span class="n">ath5k_set_antenna</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_antenna</span>		<span class="o">=</span> <span class="n">ath5k_get_antenna</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_ringparam</span>		<span class="o">=</span> <span class="n">ath5k_set_ringparam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_ringparam</span>		<span class="o">=</span> <span class="n">ath5k_get_ringparam</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
