<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath5k › desc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>desc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004-2008 Reyk Floeter &lt;reyk@openbsd.org&gt;</span>
<span class="cm"> * Copyright (c) 2006-2008 Nick Kossifidis &lt;mickflemm@gmail.com&gt;</span>
<span class="cm"> * Copyright (c) 2007-2008 Pavel Roskin &lt;proski@gnu.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/******************************\</span>
<span class="cm"> Hardware Descriptor Functions</span>
<span class="cm">\******************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &quot;ath5k.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>


<span class="cm">/**</span>
<span class="cm"> * DOC: Hardware descriptor functions</span>
<span class="cm"> *</span>
<span class="cm"> * Here we handle the processing of the low-level hw descriptors</span>
<span class="cm"> * that hw reads and writes via DMA for each TX and RX attempt (that means</span>
<span class="cm"> * we can also have descriptors for failed TX/RX tries). We have two kind of</span>
<span class="cm"> * descriptors for RX and TX, control descriptors tell the hw how to send or</span>
<span class="cm"> * receive a packet where to read/write it from/to etc and status descriptors</span>
<span class="cm"> * that contain information about how the packet was sent or received (errors</span>
<span class="cm"> * included).</span>
<span class="cm"> *</span>
<span class="cm"> * Descriptor format is not exactly the same for each MAC chip version so we</span>
<span class="cm"> * have function pointers on &amp;struct ath5k_hw we initialize at runtime based on</span>
<span class="cm"> * the chip used.</span>
<span class="cm"> */</span>


<span class="cm">/************************\</span>
<span class="cm">* TX Control descriptors *</span>
<span class="cm">\************************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_setup_2word_tx_desc() - Initialize a 2-word tx control descriptor</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @desc: The &amp;struct ath5k_desc</span>
<span class="cm"> * @pkt_len: Frame length in bytes</span>
<span class="cm"> * @hdr_len: Header length in bytes (only used on AR5210)</span>
<span class="cm"> * @padsize: Any padding we&#39;ve added to the frame length</span>
<span class="cm"> * @type: One of enum ath5k_pkt_type</span>
<span class="cm"> * @tx_power: Tx power in 0.5dB steps</span>
<span class="cm"> * @tx_rate0: HW idx for transmission rate</span>
<span class="cm"> * @tx_tries0: Max number of retransmissions</span>
<span class="cm"> * @key_index: Index on key table to use for encryption</span>
<span class="cm"> * @antenna_mode: Which antenna to use (0 for auto)</span>
<span class="cm"> * @flags: One of AR5K_TXDESC_* flags (desc.h)</span>
<span class="cm"> * @rtscts_rate: HW idx for RTS/CTS transmission rate</span>
<span class="cm"> * @rtscts_duration: What to put on duration field on the header of RTS/CTS</span>
<span class="cm"> *</span>
<span class="cm"> * Internal function to initialize a 2-Word TX control descriptor</span>
<span class="cm"> * found on AR5210 and AR5211 MACs chips.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or -EINVAL on false input</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_setup_2word_tx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hdr_len</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">padsize</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">ath5k_pkt_type</span> <span class="n">type</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_power</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_rate0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_tries0</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_index</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">antenna_mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtscts_rate</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtscts_duration</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">frame_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_hw_2w_tx_ctl</span> <span class="o">*</span><span class="n">tx_ctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_len</span><span class="p">;</span>

	<span class="n">tx_ctl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_tx5210</span><span class="p">.</span><span class="n">tx_ctl</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate input</span>
<span class="cm">	 * - Zero retries don&#39;t make sense.</span>
<span class="cm">	 * - A zero rate will put the HW into a mode where it continuously sends</span>
<span class="cm">	 *   noise on the channel, so it is important to avoid this.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx_tries0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;zero retries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx_rate0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;zero rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear descriptor */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_tx5210</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw_5210_tx_desc</span><span class="p">));</span>

	<span class="cm">/* Setup control descriptor */</span>

	<span class="cm">/* Verify and set frame length */</span>

	<span class="cm">/* remove padding we might have added before */</span>
	<span class="n">frame_len</span> <span class="o">=</span> <span class="n">pkt_len</span> <span class="o">-</span> <span class="n">padsize</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AR5K_2W_TX_DESC_CTL0_FRAME_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_0</span> <span class="o">=</span> <span class="n">frame_len</span> <span class="o">&amp;</span> <span class="n">AR5K_2W_TX_DESC_CTL0_FRAME_LEN</span><span class="p">;</span>

	<span class="cm">/* Verify and set buffer length */</span>

	<span class="cm">/* NB: beacon&#39;s BufLen must be a multiple of 4 bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AR5K_PKT_TYPE_BEACON</span><span class="p">)</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">pkt_len</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AR5K_2W_TX_DESC_CTL1_BUF_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_1</span> <span class="o">=</span> <span class="n">pkt_len</span> <span class="o">&amp;</span> <span class="n">AR5K_2W_TX_DESC_CTL1_BUF_LEN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Verify and set header length (only 5210)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr_len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AR5K_2W_TX_DESC_CTL0_HEADER_LEN_5210</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_0</span> <span class="o">|=</span>
			<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">hdr_len</span><span class="p">,</span> <span class="n">AR5K_2W_TX_DESC_CTL0_HEADER_LEN_5210</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*Differences between 5210-5211*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AR5K_PKT_TYPE_BEACON</span>:
		<span class="k">case</span> <span class="n">AR5K_PKT_TYPE_PROBE_RESP</span>:
			<span class="n">frame_type</span> <span class="o">=</span> <span class="n">AR5K_AR5210_TX_DESC_FRAME_TYPE_NO_DELAY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AR5K_PKT_TYPE_PIFS</span>:
			<span class="n">frame_type</span> <span class="o">=</span> <span class="n">AR5K_AR5210_TX_DESC_FRAME_TYPE_PIFS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">frame_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_0</span> <span class="o">|=</span>
		<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">frame_type</span><span class="p">,</span> <span class="n">AR5K_2W_TX_DESC_CTL0_FRAME_TYPE_5210</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">tx_rate0</span><span class="p">,</span> <span class="n">AR5K_2W_TX_DESC_CTL0_XMIT_RATE</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_0</span> <span class="o">|=</span>
			<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">tx_rate0</span><span class="p">,</span> <span class="n">AR5K_2W_TX_DESC_CTL0_XMIT_RATE</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">antenna_mode</span><span class="p">,</span>
				<span class="n">AR5K_2W_TX_DESC_CTL0_ANT_MODE_XMIT</span><span class="p">);</span>
		<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_1</span> <span class="o">|=</span>
			<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">AR5K_2W_TX_DESC_CTL1_FRAME_TYPE_5211</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#define _TX_FLAGS(_c, _flag)					\</span>
<span class="cp">	if (flags &amp; AR5K_TXDESC_##_flag) {			\</span>
<span class="cp">		tx_ctl-&gt;tx_control_##_c |=			\</span>
<span class="cp">			AR5K_2W_TX_DESC_CTL##_c##_##_flag;	\</span>
<span class="cp">	}</span>
<span class="cp">#define _TX_FLAGS_5211(_c, _flag)					\</span>
<span class="cp">	if (flags &amp; AR5K_TXDESC_##_flag) {				\</span>
<span class="cp">		tx_ctl-&gt;tx_control_##_c |=				\</span>
<span class="cp">			AR5K_2W_TX_DESC_CTL##_c##_##_flag##_5211;	\</span>
<span class="cp">	}</span>
	<span class="n">_TX_FLAGS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CLRDMASK</span><span class="p">);</span>
	<span class="n">_TX_FLAGS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INTREQ</span><span class="p">);</span>
	<span class="n">_TX_FLAGS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RTSENA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5211</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_TX_FLAGS_5211</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VEOL</span><span class="p">);</span>
		<span class="n">_TX_FLAGS_5211</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NOACK</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#undef _TX_FLAGS</span>
<span class="cp">#undef _TX_FLAGS_5211</span>

	<span class="cm">/*</span>
<span class="cm">	 * WEP crap</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span> <span class="o">!=</span> <span class="n">AR5K_TXKEYIX_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_0</span> <span class="o">|=</span>
			<span class="n">AR5K_2W_TX_DESC_CTL0_ENCRYPT_KEY_VALID</span><span class="p">;</span>
		<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_1</span> <span class="o">|=</span>
			<span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">key_index</span><span class="p">,</span>
			<span class="n">AR5K_2W_TX_DESC_CTL1_ENC_KEY_IDX</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * RTS/CTS Duration [5210 ?]</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AR5K_TXDESC_RTSENA</span> <span class="o">|</span> <span class="n">AR5K_TXDESC_CTSENA</span><span class="p">)))</span>
		<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_1</span> <span class="o">|=</span> <span class="n">rtscts_duration</span> <span class="o">&amp;</span>
				<span class="n">AR5K_2W_TX_DESC_CTL1_RTS_DURATION_5210</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_setup_4word_tx_desc() - Initialize a 4-word tx control descriptor</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @desc: The &amp;struct ath5k_desc</span>
<span class="cm"> * @pkt_len: Frame length in bytes</span>
<span class="cm"> * @hdr_len: Header length in bytes (only used on AR5210)</span>
<span class="cm"> * @padsize: Any padding we&#39;ve added to the frame length</span>
<span class="cm"> * @type: One of enum ath5k_pkt_type</span>
<span class="cm"> * @tx_power: Tx power in 0.5dB steps</span>
<span class="cm"> * @tx_rate0: HW idx for transmission rate</span>
<span class="cm"> * @tx_tries0: Max number of retransmissions</span>
<span class="cm"> * @key_index: Index on key table to use for encryption</span>
<span class="cm"> * @antenna_mode: Which antenna to use (0 for auto)</span>
<span class="cm"> * @flags: One of AR5K_TXDESC_* flags (desc.h)</span>
<span class="cm"> * @rtscts_rate: HW idx for RTS/CTS transmission rate</span>
<span class="cm"> * @rtscts_duration: What to put on duration field on the header of RTS/CTS</span>
<span class="cm"> *</span>
<span class="cm"> * Internal function to initialize a 4-Word TX control descriptor</span>
<span class="cm"> * found on AR5212 and later MACs chips.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or -EINVAL on false input</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_setup_4word_tx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hdr_len</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">padsize</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">ath5k_pkt_type</span> <span class="n">type</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_power</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_rate0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_tries0</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key_index</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">antenna_mode</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtscts_rate</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rtscts_duration</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw_4w_tx_ctl</span> <span class="o">*</span><span class="n">tx_ctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use local variables for these to reduce load/store access on</span>
<span class="cm">	 * uncached memory</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">txctl0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">txctl1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">txctl2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">txctl3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tx_ctl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_tx5212</span><span class="p">.</span><span class="n">tx_ctl</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate input</span>
<span class="cm">	 * - Zero retries don&#39;t make sense.</span>
<span class="cm">	 * - A zero rate will put the HW into a mode where it continuously sends</span>
<span class="cm">	 *   noise on the channel, so it is important to avoid this.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx_tries0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;zero retries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx_rate0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;zero rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_power</span> <span class="o">+=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txpower</span><span class="p">.</span><span class="n">txp_offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_power</span> <span class="o">&gt;</span> <span class="n">AR5K_TUNE_MAX_TXPOWER</span><span class="p">)</span>
		<span class="n">tx_power</span> <span class="o">=</span> <span class="n">AR5K_TUNE_MAX_TXPOWER</span><span class="p">;</span>

	<span class="cm">/* Clear descriptor status area */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_tx5212</span><span class="p">.</span><span class="n">tx_stat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_tx5212</span><span class="p">.</span><span class="n">tx_stat</span><span class="p">));</span>

	<span class="cm">/* Setup control descriptor */</span>

	<span class="cm">/* Verify and set frame length */</span>

	<span class="cm">/* remove padding we might have added before */</span>
	<span class="n">frame_len</span> <span class="o">=</span> <span class="n">pkt_len</span> <span class="o">-</span> <span class="n">padsize</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AR5K_4W_TX_DESC_CTL0_FRAME_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">txctl0</span> <span class="o">=</span> <span class="n">frame_len</span> <span class="o">&amp;</span> <span class="n">AR5K_4W_TX_DESC_CTL0_FRAME_LEN</span><span class="p">;</span>

	<span class="cm">/* Verify and set buffer length */</span>

	<span class="cm">/* NB: beacon&#39;s BufLen must be a multiple of 4 bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">AR5K_PKT_TYPE_BEACON</span><span class="p">)</span>
		<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">pkt_len</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt_len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AR5K_4W_TX_DESC_CTL1_BUF_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">txctl1</span> <span class="o">=</span> <span class="n">pkt_len</span> <span class="o">&amp;</span> <span class="n">AR5K_4W_TX_DESC_CTL1_BUF_LEN</span><span class="p">;</span>

	<span class="n">txctl0</span> <span class="o">|=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">tx_power</span><span class="p">,</span> <span class="n">AR5K_4W_TX_DESC_CTL0_XMIT_POWER</span><span class="p">)</span> <span class="o">|</span>
		  <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">antenna_mode</span><span class="p">,</span> <span class="n">AR5K_4W_TX_DESC_CTL0_ANT_MODE_XMIT</span><span class="p">);</span>
	<span class="n">txctl1</span> <span class="o">|=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">AR5K_4W_TX_DESC_CTL1_FRAME_TYPE</span><span class="p">);</span>
	<span class="n">txctl2</span> <span class="o">=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">tx_tries0</span><span class="p">,</span> <span class="n">AR5K_4W_TX_DESC_CTL2_XMIT_TRIES0</span><span class="p">);</span>
	<span class="n">txctl3</span> <span class="o">=</span> <span class="n">tx_rate0</span> <span class="o">&amp;</span> <span class="n">AR5K_4W_TX_DESC_CTL3_XMIT_RATE0</span><span class="p">;</span>

<span class="cp">#define _TX_FLAGS(_c, _flag)					\</span>
<span class="cp">	if (flags &amp; AR5K_TXDESC_##_flag) {			\</span>
<span class="cp">		txctl##_c |= AR5K_4W_TX_DESC_CTL##_c##_##_flag;	\</span>
<span class="cp">	}</span>

	<span class="n">_TX_FLAGS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CLRDMASK</span><span class="p">);</span>
	<span class="n">_TX_FLAGS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VEOL</span><span class="p">);</span>
	<span class="n">_TX_FLAGS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">INTREQ</span><span class="p">);</span>
	<span class="n">_TX_FLAGS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RTSENA</span><span class="p">);</span>
	<span class="n">_TX_FLAGS</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CTSENA</span><span class="p">);</span>
	<span class="n">_TX_FLAGS</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NOACK</span><span class="p">);</span>

<span class="cp">#undef _TX_FLAGS</span>

	<span class="cm">/*</span>
<span class="cm">	 * WEP crap</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span> <span class="o">!=</span> <span class="n">AR5K_TXKEYIX_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txctl0</span> <span class="o">|=</span> <span class="n">AR5K_4W_TX_DESC_CTL0_ENCRYPT_KEY_VALID</span><span class="p">;</span>
		<span class="n">txctl1</span> <span class="o">|=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">key_index</span><span class="p">,</span>
				<span class="n">AR5K_4W_TX_DESC_CTL1_ENCRYPT_KEY_IDX</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * RTS/CTS</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AR5K_TXDESC_RTSENA</span> <span class="o">|</span> <span class="n">AR5K_TXDESC_CTSENA</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXDESC_RTSENA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AR5K_TXDESC_CTSENA</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">txctl2</span> <span class="o">|=</span> <span class="n">rtscts_duration</span> <span class="o">&amp;</span> <span class="n">AR5K_4W_TX_DESC_CTL2_RTS_DURATION</span><span class="p">;</span>
		<span class="n">txctl3</span> <span class="o">|=</span> <span class="n">AR5K_REG_SM</span><span class="p">(</span><span class="n">rtscts_rate</span><span class="p">,</span>
				<span class="n">AR5K_4W_TX_DESC_CTL3_RTS_CTS_RATE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_0</span> <span class="o">=</span> <span class="n">txctl0</span><span class="p">;</span>
	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_1</span> <span class="o">=</span> <span class="n">txctl1</span><span class="p">;</span>
	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_2</span> <span class="o">=</span> <span class="n">txctl2</span><span class="p">;</span>
	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">tx_control_3</span> <span class="o">=</span> <span class="n">txctl3</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_setup_mrr_tx_desc() - Initialize an MRR tx control descriptor</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @desc: The &amp;struct ath5k_desc</span>
<span class="cm"> * @tx_rate1: HW idx for rate used on transmission series 1</span>
<span class="cm"> * @tx_tries1: Max number of retransmissions for transmission series 1</span>
<span class="cm"> * @tx_rate2: HW idx for rate used on transmission series 2</span>
<span class="cm"> * @tx_tries2: Max number of retransmissions for transmission series 2</span>
<span class="cm"> * @tx_rate3: HW idx for rate used on transmission series 3</span>
<span class="cm"> * @tx_tries3: Max number of retransmissions for transmission series 3</span>
<span class="cm"> *</span>
<span class="cm"> * Multi rate retry (MRR) tx control descriptors are available only on AR5212</span>
<span class="cm"> * MACs, they are part of the normal 4-word tx control descriptor (see above)</span>
<span class="cm"> * but we handle them through a separate function for better abstraction.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or -EINVAL on invalid input</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_setup_mrr_tx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
			<span class="n">u_int</span> <span class="n">tx_rate1</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tx_tries1</span><span class="p">,</span>
			<span class="n">u_int</span> <span class="n">tx_rate2</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tx_tries2</span><span class="p">,</span>
			<span class="n">u_int</span> <span class="n">tx_rate3</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">tx_tries3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw_4w_tx_ctl</span> <span class="o">*</span><span class="n">tx_ctl</span><span class="p">;</span>

	<span class="cm">/* no mrr support for cards older than 5212 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">&lt;</span> <span class="n">AR5K_AR5212</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Rates can be 0 as long as the retry count is 0 too.</span>
<span class="cm">	 * A zero rate and nonzero retry count will put the HW into a mode where</span>
<span class="cm">	 * it continuously sends noise on the channel, so it is important to</span>
<span class="cm">	 * avoid this.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">tx_rate1</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tx_tries1</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">tx_rate2</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tx_tries2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">tx_rate3</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">tx_tries3</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;zero rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5212</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_ctl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_tx5212</span><span class="p">.</span><span class="n">tx_ctl</span><span class="p">;</span>

<span class="cp">#define _XTX_TRIES(_n)							\</span>
<span class="cp">	if (tx_tries##_n) {						\</span>
<span class="cp">		tx_ctl-&gt;tx_control_2 |=					\</span>
<span class="cp">		    AR5K_REG_SM(tx_tries##_n,				\</span>
<span class="cp">		    AR5K_4W_TX_DESC_CTL2_XMIT_TRIES##_n);		\</span>
<span class="cp">		tx_ctl-&gt;tx_control_3 |=					\</span>
<span class="cp">		    AR5K_REG_SM(tx_rate##_n,				\</span>
<span class="cp">		    AR5K_4W_TX_DESC_CTL3_XMIT_RATE##_n);		\</span>
<span class="cp">	}</span>

		<span class="n">_XTX_TRIES</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">_XTX_TRIES</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">_XTX_TRIES</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="cp">#undef _XTX_TRIES</span>

		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/***********************\</span>
<span class="cm">* TX Status descriptors *</span>
<span class="cm">\***********************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_proc_2word_tx_status() - Process a tx status descriptor on 5210/1</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @desc: The &amp;struct ath5k_desc</span>
<span class="cm"> * @ts: The &amp;struct ath5k_tx_status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_proc_2word_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath5k_tx_status</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw_tx_status</span> <span class="o">*</span><span class="n">tx_status</span><span class="p">;</span>

	<span class="n">tx_status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_tx5210</span><span class="p">.</span><span class="n">tx_stat</span><span class="p">;</span>

	<span class="cm">/* No frame has been send or error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_1</span> <span class="o">&amp;</span> <span class="n">AR5K_DESC_TX_STATUS1_DONE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get descriptor status</span>
<span class="cm">	 */</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_tstamp</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_0</span><span class="p">,</span>
		<span class="n">AR5K_DESC_TX_STATUS0_SEND_TIMESTAMP</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_shortretry</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_0</span><span class="p">,</span>
		<span class="n">AR5K_DESC_TX_STATUS0_SHORT_RETRY_COUNT</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_final_retry</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_0</span><span class="p">,</span>
		<span class="n">AR5K_DESC_TX_STATUS0_LONG_RETRY_COUNT</span><span class="p">);</span>
	<span class="cm">/*TODO: ts-&gt;ts_virtcol + test*/</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_seqnum</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_1</span><span class="p">,</span>
		<span class="n">AR5K_DESC_TX_STATUS1_SEQ_NUM</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_rssi</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_1</span><span class="p">,</span>
		<span class="n">AR5K_DESC_TX_STATUS1_ACK_SIG_STRENGTH</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_antenna</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_final_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_0</span> <span class="o">&amp;</span> <span class="n">AR5K_DESC_TX_STATUS0_FRAME_XMIT_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_0</span> <span class="o">&amp;</span>
				<span class="n">AR5K_DESC_TX_STATUS0_EXCESSIVE_RETRIES</span><span class="p">)</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">|=</span> <span class="n">AR5K_TXERR_XRETRY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_0</span> <span class="o">&amp;</span> <span class="n">AR5K_DESC_TX_STATUS0_FIFO_UNDERRUN</span><span class="p">)</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">|=</span> <span class="n">AR5K_TXERR_FIFO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_0</span> <span class="o">&amp;</span> <span class="n">AR5K_DESC_TX_STATUS0_FILTERED</span><span class="p">)</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">|=</span> <span class="n">AR5K_TXERR_FILT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_proc_4word_tx_status() - Process a tx status descriptor on 5212</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @desc: The &amp;struct ath5k_desc</span>
<span class="cm"> * @ts: The &amp;struct ath5k_tx_status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_proc_4word_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath5k_tx_status</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw_tx_status</span> <span class="o">*</span><span class="n">tx_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txstat0</span><span class="p">,</span> <span class="n">txstat1</span><span class="p">;</span>

	<span class="n">tx_status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_tx5212</span><span class="p">.</span><span class="n">tx_stat</span><span class="p">;</span>

	<span class="n">txstat1</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_1</span><span class="p">);</span>

	<span class="cm">/* No frame has been send or error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txstat1</span> <span class="o">&amp;</span> <span class="n">AR5K_DESC_TX_STATUS1_DONE</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">txstat0</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">tx_status_0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get descriptor status</span>
<span class="cm">	 */</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_tstamp</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">txstat0</span><span class="p">,</span>
		<span class="n">AR5K_DESC_TX_STATUS0_SEND_TIMESTAMP</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_shortretry</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">txstat0</span><span class="p">,</span>
		<span class="n">AR5K_DESC_TX_STATUS0_SHORT_RETRY_COUNT</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_final_retry</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">txstat0</span><span class="p">,</span>
		<span class="n">AR5K_DESC_TX_STATUS0_LONG_RETRY_COUNT</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_seqnum</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">txstat1</span><span class="p">,</span>
		<span class="n">AR5K_DESC_TX_STATUS1_SEQ_NUM</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_rssi</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">txstat1</span><span class="p">,</span>
		<span class="n">AR5K_DESC_TX_STATUS1_ACK_SIG_STRENGTH</span><span class="p">);</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_antenna</span> <span class="o">=</span> <span class="p">(</span><span class="n">txstat1</span> <span class="o">&amp;</span>
		<span class="n">AR5K_DESC_TX_STATUS1_XMIT_ANTENNA_5212</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_final_idx</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">txstat1</span><span class="p">,</span>
			<span class="n">AR5K_DESC_TX_STATUS1_FINAL_TS_IX_5212</span><span class="p">);</span>

	<span class="cm">/* TX error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txstat0</span> <span class="o">&amp;</span> <span class="n">AR5K_DESC_TX_STATUS0_FRAME_XMIT_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txstat0</span> <span class="o">&amp;</span> <span class="n">AR5K_DESC_TX_STATUS0_EXCESSIVE_RETRIES</span><span class="p">)</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">|=</span> <span class="n">AR5K_TXERR_XRETRY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txstat0</span> <span class="o">&amp;</span> <span class="n">AR5K_DESC_TX_STATUS0_FIFO_UNDERRUN</span><span class="p">)</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">|=</span> <span class="n">AR5K_TXERR_FIFO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txstat0</span> <span class="o">&amp;</span> <span class="n">AR5K_DESC_TX_STATUS0_FILTERED</span><span class="p">)</span>
			<span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">|=</span> <span class="n">AR5K_TXERR_FILT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************\</span>
<span class="cm">* RX Descriptors *</span>
<span class="cm">\****************/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_setup_rx_desc() - Initialize an rx control descriptor</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @desc: The &amp;struct ath5k_desc</span>
<span class="cm"> * @size: RX buffer length in bytes</span>
<span class="cm"> * @flags: One of AR5K_RXDESC_* flags</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_setup_rx_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw_rx_ctl</span> <span class="o">*</span><span class="n">rx_ctl</span><span class="p">;</span>

	<span class="n">rx_ctl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_rx</span><span class="p">.</span><span class="n">rx_ctl</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the descriptor</span>
<span class="cm">	 * If we don&#39;t clean the status descriptor,</span>
<span class="cm">	 * while scanning we get too many results,</span>
<span class="cm">	 * most of them virtual, after some secs</span>
<span class="cm">	 * of scanning system hangs. M.F.</span>
<span class="cm">	*/</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_rx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw_all_rx_desc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AR5K_DESC_RX_CTL1_BUF_LEN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Setup descriptor */</span>
	<span class="n">rx_ctl</span><span class="o">-&gt;</span><span class="n">rx_control_1</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&amp;</span> <span class="n">AR5K_DESC_RX_CTL1_BUF_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AR5K_RXDESC_INTREQ</span><span class="p">)</span>
		<span class="n">rx_ctl</span><span class="o">-&gt;</span><span class="n">rx_control_1</span> <span class="o">|=</span> <span class="n">AR5K_DESC_RX_CTL1_INTREQ</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_proc_5210_rx_status() - Process the rx status descriptor on 5210/1</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @desc: The &amp;struct ath5k_desc</span>
<span class="cm"> * @rs: The &amp;struct ath5k_rx_status</span>
<span class="cm"> *</span>
<span class="cm"> * Internal function used to process an RX status descriptor</span>
<span class="cm"> * on AR5210/5211 MAC.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or -EINPROGRESS in case we haven&#39;t received the who;e</span>
<span class="cm"> * frame yet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_proc_5210_rx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath5k_rx_status</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw_rx_status</span> <span class="o">*</span><span class="n">rx_status</span><span class="p">;</span>

	<span class="n">rx_status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_rx</span><span class="p">.</span><span class="n">rx_stat</span><span class="p">;</span>

	<span class="cm">/* No frame received / not ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_1</span> <span class="o">&amp;</span>
			<span class="n">AR5K_5210_RX_DESC_STATUS1_DONE</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_rx_status</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Frame receive status</span>
<span class="cm">	 */</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_datalen</span> <span class="o">=</span> <span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_0</span> <span class="o">&amp;</span>
		<span class="n">AR5K_5210_RX_DESC_STATUS0_DATA_LEN</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rssi</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_0</span><span class="p">,</span>
		<span class="n">AR5K_5210_RX_DESC_STATUS0_RECEIVE_SIGNAL</span><span class="p">);</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rate</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_0</span><span class="p">,</span>
		<span class="n">AR5K_5210_RX_DESC_STATUS0_RECEIVE_RATE</span><span class="p">);</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_more</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_0</span> <span class="o">&amp;</span>
		<span class="n">AR5K_5210_RX_DESC_STATUS0_MORE</span><span class="p">);</span>
	<span class="cm">/* TODO: this timestamp is 13 bit, later on we assume 15 bit!</span>
<span class="cm">	 * also the HAL code for 5210 says the timestamp is bits [10..22] of the</span>
<span class="cm">	 * TSF, and extends the timestamp here to 15 bit.</span>
<span class="cm">	 * we need to check on 5210...</span>
<span class="cm">	 */</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_tstamp</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_1</span><span class="p">,</span>
		<span class="n">AR5K_5210_RX_DESC_STATUS1_RECEIVE_TIMESTAMP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5211</span><span class="p">)</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_antenna</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_0</span><span class="p">,</span>
				<span class="n">AR5K_5210_RX_DESC_STATUS0_RECEIVE_ANT_5211</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_antenna</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_0</span> <span class="o">&amp;</span>
				<span class="n">AR5K_5210_RX_DESC_STATUS0_RECEIVE_ANT_5210</span><span class="p">)</span>
				<span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Key table status</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_1</span> <span class="o">&amp;</span> <span class="n">AR5K_5210_RX_DESC_STATUS1_KEY_INDEX_VALID</span><span class="p">)</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_keyix</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_1</span><span class="p">,</span>
			<span class="n">AR5K_5210_RX_DESC_STATUS1_KEY_INDEX</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_keyix</span> <span class="o">=</span> <span class="n">AR5K_RXKEYIX_INVALID</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Receive/descriptor errors</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_1</span> <span class="o">&amp;</span>
			<span class="n">AR5K_5210_RX_DESC_STATUS1_FRAME_RECEIVE_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_1</span> <span class="o">&amp;</span>
				<span class="n">AR5K_5210_RX_DESC_STATUS1_CRC_ERROR</span><span class="p">)</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">|=</span> <span class="n">AR5K_RXERR_CRC</span><span class="p">;</span>

		<span class="cm">/* only on 5210 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5210</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_1</span> <span class="o">&amp;</span>
				<span class="n">AR5K_5210_RX_DESC_STATUS1_FIFO_OVERRUN_5210</span><span class="p">))</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">|=</span> <span class="n">AR5K_RXERR_FIFO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_1</span> <span class="o">&amp;</span>
				<span class="n">AR5K_5210_RX_DESC_STATUS1_PHY_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">|=</span> <span class="n">AR5K_RXERR_PHY</span><span class="p">;</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_phyerr</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_1</span><span class="p">,</span>
				<span class="n">AR5K_5210_RX_DESC_STATUS1_PHY_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_1</span> <span class="o">&amp;</span>
				<span class="n">AR5K_5210_RX_DESC_STATUS1_DECRYPT_CRC_ERROR</span><span class="p">)</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">|=</span> <span class="n">AR5K_RXERR_DECRYPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_proc_5212_rx_status() - Process the rx status descriptor on 5212</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> * @desc: The &amp;struct ath5k_desc</span>
<span class="cm"> * @rs: The &amp;struct ath5k_rx_status</span>
<span class="cm"> *</span>
<span class="cm"> * Internal function used to process an RX status descriptor</span>
<span class="cm"> * on AR5212 and later MAC.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or -EINPROGRESS in case we haven&#39;t received the who;e</span>
<span class="cm"> * frame yet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_proc_5212_rx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath5k_rx_status</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw_rx_status</span> <span class="o">*</span><span class="n">rx_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxstat0</span><span class="p">,</span> <span class="n">rxstat1</span><span class="p">;</span>

	<span class="n">rx_status</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ud</span><span class="p">.</span><span class="n">ds_rx</span><span class="p">.</span><span class="n">rx_stat</span><span class="p">;</span>
	<span class="n">rxstat1</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_1</span><span class="p">);</span>

	<span class="cm">/* No frame received / not ready */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxstat1</span> <span class="o">&amp;</span> <span class="n">AR5K_5212_RX_DESC_STATUS1_DONE</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_rx_status</span><span class="p">));</span>
	<span class="n">rxstat0</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rx_status_0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Frame receive status</span>
<span class="cm">	 */</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_datalen</span> <span class="o">=</span> <span class="n">rxstat0</span> <span class="o">&amp;</span> <span class="n">AR5K_5212_RX_DESC_STATUS0_DATA_LEN</span><span class="p">;</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rssi</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rxstat0</span><span class="p">,</span>
		<span class="n">AR5K_5212_RX_DESC_STATUS0_RECEIVE_SIGNAL</span><span class="p">);</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rate</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rxstat0</span><span class="p">,</span>
		<span class="n">AR5K_5212_RX_DESC_STATUS0_RECEIVE_RATE</span><span class="p">);</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_antenna</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rxstat0</span><span class="p">,</span>
		<span class="n">AR5K_5212_RX_DESC_STATUS0_RECEIVE_ANTENNA</span><span class="p">);</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_more</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rxstat0</span> <span class="o">&amp;</span> <span class="n">AR5K_5212_RX_DESC_STATUS0_MORE</span><span class="p">);</span>
	<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_tstamp</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rxstat1</span><span class="p">,</span>
		<span class="n">AR5K_5212_RX_DESC_STATUS1_RECEIVE_TIMESTAMP</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Key table status</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxstat1</span> <span class="o">&amp;</span> <span class="n">AR5K_5212_RX_DESC_STATUS1_KEY_INDEX_VALID</span><span class="p">)</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_keyix</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rxstat1</span><span class="p">,</span>
					   <span class="n">AR5K_5212_RX_DESC_STATUS1_KEY_INDEX</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_keyix</span> <span class="o">=</span> <span class="n">AR5K_RXKEYIX_INVALID</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Receive/descriptor errors</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxstat1</span> <span class="o">&amp;</span> <span class="n">AR5K_5212_RX_DESC_STATUS1_FRAME_RECEIVE_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxstat1</span> <span class="o">&amp;</span> <span class="n">AR5K_5212_RX_DESC_STATUS1_CRC_ERROR</span><span class="p">)</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">|=</span> <span class="n">AR5K_RXERR_CRC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxstat1</span> <span class="o">&amp;</span> <span class="n">AR5K_5212_RX_DESC_STATUS1_PHY_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">|=</span> <span class="n">AR5K_RXERR_PHY</span><span class="p">;</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_phyerr</span> <span class="o">=</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">rxstat1</span><span class="p">,</span>
				<span class="n">AR5K_5212_RX_DESC_STATUS1_PHY_ERROR_CODE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_has_phyerr_counters</span><span class="p">)</span>
				<span class="n">ath5k_ani_phy_error_report</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_phyerr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxstat1</span> <span class="o">&amp;</span> <span class="n">AR5K_5212_RX_DESC_STATUS1_DECRYPT_CRC_ERROR</span><span class="p">)</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">|=</span> <span class="n">AR5K_RXERR_DECRYPT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxstat1</span> <span class="o">&amp;</span> <span class="n">AR5K_5212_RX_DESC_STATUS1_MIC_ERROR</span><span class="p">)</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">|=</span> <span class="n">AR5K_RXERR_MIC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/********\</span>
<span class="cm">* Attach *</span>
<span class="cm">\********/</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_hw_init_desc_functions() - Init function pointers inside ah</span>
<span class="cm"> * @ah: The &amp;struct ath5k_hw</span>
<span class="cm"> *</span>
<span class="cm"> * Maps the internal descriptor functions to the function pointers on ah, used</span>
<span class="cm"> * from above. This is used as an abstraction layer to handle the various chips</span>
<span class="cm"> * the same way.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_hw_init_desc_functions</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5212</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_setup_tx_desc</span> <span class="o">=</span> <span class="n">ath5k_hw_setup_4word_tx_desc</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_proc_tx_desc</span> <span class="o">=</span> <span class="n">ath5k_hw_proc_4word_tx_status</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_proc_rx_desc</span> <span class="o">=</span> <span class="n">ath5k_hw_proc_5212_rx_status</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">&lt;=</span> <span class="n">AR5K_AR5211</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_setup_tx_desc</span> <span class="o">=</span> <span class="n">ath5k_hw_setup_2word_tx_desc</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_proc_tx_desc</span> <span class="o">=</span> <span class="n">ath5k_hw_proc_2word_tx_status</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_proc_rx_desc</span> <span class="o">=</span> <span class="n">ath5k_hw_proc_5210_rx_status</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
