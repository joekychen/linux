<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath5k › base.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>base.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*-</span>
<span class="cm"> * Copyright (c) 2002-2005 Sam Leffler, Errno Consulting</span>
<span class="cm"> * Copyright (c) 2004-2005 Atheros Communications, Inc.</span>
<span class="cm"> * Copyright (c) 2006 Devicescape Software, Inc.</span>
<span class="cm"> * Copyright (c) 2007 Jiri Slaby &lt;jirislaby@gmail.com&gt;</span>
<span class="cm"> * Copyright (c) 2007 Luis R. Rodriguez &lt;mcgrof@winlab.rutgers.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer,</span>
<span class="cm"> *    without modification.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce at minimum a disclaimer</span>
<span class="cm"> *    similar to the &quot;NO WARRANTY&quot; disclaimer below (&quot;Disclaimer&quot;) and any</span>
<span class="cm"> *    redistribution must be conditioned upon including a substantially</span>
<span class="cm"> *    similar Disclaimer requirement for further binary redistribution.</span>
<span class="cm"> * 3. Neither the names of the above-listed copyright holders nor the names</span>
<span class="cm"> *    of any contributors may be used to endorse or promote products derived</span>
<span class="cm"> *    from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;) version 2 as published by the Free</span>
<span class="cm"> * Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * NO WARRANTY</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * ``AS IS&#39;&#39; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF NONINFRINGEMENT, MERCHANTIBILITY</span>
<span class="cm"> * AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL</span>
<span class="cm"> * THE COPYRIGHT HOLDERS OR CONTRIBUTORS BE LIABLE FOR SPECIAL, EXEMPLARY,</span>
<span class="cm"> * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="cm"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER</span>
<span class="cm"> * IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF</span>
<span class="cm"> * THE POSSIBILITY OF SUCH DAMAGES.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/cache.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/nl80211.h&gt;</span>

<span class="cp">#include &lt;net/ieee80211_radiotap.h&gt;</span>

<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;base.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;ani.h&quot;</span>
<span class="cp">#include &quot;ath5k.h&quot;</span>
<span class="cp">#include &quot;../regd.h&quot;</span>

<span class="cp">#define CREATE_TRACE_POINTS</span>
<span class="cp">#include &quot;trace.h&quot;</span>

<span class="n">bool</span> <span class="n">ath5k_modparam_nohwcrypt</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">nohwcrypt</span><span class="p">,</span> <span class="n">ath5k_modparam_nohwcrypt</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nohwcrypt</span><span class="p">,</span> <span class="s">&quot;Disable hardware encryption.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">modparam_all_channels</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">all_channels</span><span class="p">,</span> <span class="n">modparam_all_channels</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">all_channels</span><span class="p">,</span> <span class="s">&quot;Expose all channels the device can use.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">modparam_fastchanswitch</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">fastchanswitch</span><span class="p">,</span> <span class="n">modparam_fastchanswitch</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fastchanswitch</span><span class="p">,</span> <span class="s">&quot;Enable fast channel switching for AR2413/AR5413 radios.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">ath5k_modparam_no_hw_rfkill_switch</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">no_hw_rfkill_switch</span><span class="p">,</span> <span class="n">ath5k_modparam_no_hw_rfkill_switch</span><span class="p">,</span>
								<span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">no_hw_rfkill_switch</span><span class="p">,</span> <span class="s">&quot;Ignore the GPIO RFKill switch state&quot;</span><span class="p">);</span>


<span class="cm">/* Module info */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jiri Slaby&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Nick Kossifidis&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Support for 5xxx series of Atheros 802.11 wireless LAN cards.&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;Atheros 5xxx WLAN cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ath5k_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ath5k_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
								<span class="n">bool</span> <span class="n">skip_pcu</span><span class="p">);</span>

<span class="cm">/* Known SREVs */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath5k_srev_name</span> <span class="n">srev_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ATHEROS_AR231X</span>
	<span class="p">{</span> <span class="s">&quot;5312&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5312_R2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5312&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5312_R7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2313&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR2313_R8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2315&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR2315_R6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2315&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR2315_R7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2317&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR2317_R1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2317&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR2317_R2</span> <span class="p">},</span>
<span class="cp">#else</span>
	<span class="p">{</span> <span class="s">&quot;5210&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5210</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5311&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5311</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5311A&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5311A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5311B&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5311B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5211&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5211</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5212&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5212</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5213&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5213</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5213A&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5213A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2413&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR2413</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2414&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR2414</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5424&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5424</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5413&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5413</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5414&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5414</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2415&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR2415</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5416&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5416</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5418&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR5418</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2425&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR2425</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2417&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_AR2417</span> <span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="s">&quot;xxxxx&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_MAC</span><span class="p">,</span>	<span class="n">AR5K_SREV_UNKNOWN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5110&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_5110</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5111&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_5111</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5111A&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_5111A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2111&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_2111</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5112&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_5112</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5112A&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_5112A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5112B&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_5112B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2112&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_2112</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2112A&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_2112A</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2112B&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_2112B</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2413&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_2413</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5413&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_5413</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5424&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_5424</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;5133&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_5133</span> <span class="p">},</span>
<span class="cp">#ifdef CONFIG_ATHEROS_AR231X</span>
	<span class="p">{</span> <span class="s">&quot;2316&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_2316</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;2317&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_RAD_2317</span> <span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="s">&quot;xxxxx&quot;</span><span class="p">,</span>	<span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>	<span class="n">AR5K_SREV_UNKNOWN</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">ath5k_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_1M</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_2M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_2M</span> <span class="o">|</span> <span class="n">AR5K_SET_SHORT_PREAMBLE</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_5_5M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_5_5M</span> <span class="o">|</span> <span class="n">AR5K_SET_SHORT_PREAMBLE</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_11M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_11M</span> <span class="o">|</span> <span class="n">AR5K_SET_SHORT_PREAMBLE</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_6M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_9M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_12M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_18M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_24M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_36M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_48M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ATH5K_RATE_CODE_54M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">ath5k_extend_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rstamp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">tsf</span> <span class="o">=</span> <span class="n">ath5k_hw_get_tsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tsf</span> <span class="o">&amp;</span> <span class="mh">0x7fff</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rstamp</span><span class="p">)</span>
		<span class="n">tsf</span> <span class="o">-=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">tsf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7fff</span><span class="p">)</span> <span class="o">|</span> <span class="n">rstamp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">ath5k_chip_name</span><span class="p">(</span><span class="k">enum</span> <span class="n">ath5k_srev_type</span> <span class="n">type</span><span class="p">,</span> <span class="n">u_int16_t</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;xxxxx&quot;</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">srev_names</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srev_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sr_type</span> <span class="o">!=</span> <span class="n">type</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="n">srev_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sr_val</span><span class="p">)</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">srev_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sr_name</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">==</span> <span class="n">srev_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sr_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">name</span> <span class="o">=</span> <span class="n">srev_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sr_name</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ath5k_ioread32</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ath5k_hw_reg_read</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath5k_iowrite32</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="n">ath5k_hw_reg_write</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_ops</span> <span class="n">ath5k_common_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath5k_ioread32</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath5k_iowrite32</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/***********************\</span>
<span class="cm">* Driver Initialization *</span>
<span class="cm">\***********************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath5k_reg_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">regulatory_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">wiphy_to_ieee80211_hw</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_regulatory</span> <span class="o">*</span><span class="n">regulatory</span> <span class="o">=</span> <span class="n">ath5k_hw_regulatory</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ath_reg_notifier_apply</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">regulatory</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************\</span>
<span class="cm">* Channel/mode setup *</span>
<span class="cm">\********************/</span>

<span class="cm">/*</span>
<span class="cm"> * Returns true for the channel numbers used without all_channels modparam.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath5k_is_standard_channel</span><span class="p">(</span><span class="kt">short</span> <span class="n">chan</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span>	<span class="cm">/* UNII 1,2 */</span>
		<span class="p">(((</span><span class="n">chan</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">36</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">)</span> <span class="o">||</span>
		<span class="cm">/* midband */</span>
		<span class="p">((</span><span class="n">chan</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">&lt;=</span> <span class="mi">140</span><span class="p">)</span> <span class="o">||</span>
		<span class="cm">/* UNII-3 */</span>
		<span class="p">((</span><span class="n">chan</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">&gt;=</span> <span class="mi">149</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span> <span class="o">&lt;=</span> <span class="mi">165</span><span class="p">)</span> <span class="o">||</span>
		<span class="cm">/* 802.11j 5.030-5.080 GHz (20MHz) */</span>
		<span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">chan</span> <span class="o">==</span> <span class="mi">12</span> <span class="o">||</span> <span class="n">chan</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="o">||</span>
		<span class="cm">/* 802.11j 4.9GHz (20MHz) */</span>
		<span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="mi">184</span> <span class="o">||</span> <span class="n">chan</span> <span class="o">==</span> <span class="mi">188</span> <span class="o">||</span> <span class="n">chan</span> <span class="o">==</span> <span class="mi">192</span> <span class="o">||</span> <span class="n">chan</span> <span class="o">==</span> <span class="mi">196</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">ath5k_setup_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channels</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_MODE_11A</span>:
		<span class="cm">/* 1..220, but 2GHz frequencies are filtered by check_channel */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">220</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_MODE_11B</span>:
	<span class="k">case</span> <span class="n">AR5K_MODE_11G</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ATH5K_WARN</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;bad mode, not copying channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">ieee80211_channel_to_frequency</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* mapping failed - not a standard channel */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Write channel info, needed for ath5k_channel_ok() */</span>
		<span class="n">channels</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">center_freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">channels</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">band</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>
		<span class="n">channels</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

		<span class="cm">/* Check if channel is supported by the chipset */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath5k_channel_ok</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channels</span><span class="p">[</span><span class="n">count</span><span class="p">]))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modparam_all_channels</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">ath5k_is_standard_channel</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">band</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_setup_rate_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR5K_MAX_RATES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">[</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">[</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">][</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value_short</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">[</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">][</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value_short</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_setup_bands</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_c</span><span class="p">,</span> <span class="n">count_c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">IEEE80211_NUM_BANDS</span><span class="p">);</span>
	<span class="n">max_c</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>

	<span class="cm">/* 2GHz band */</span>
	<span class="n">sband</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
	<span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AR5K_MODE_11G</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* G mode */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ath5k_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rate</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ath5k_setup_channels</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span>
					<span class="n">AR5K_MODE_11G</span><span class="p">,</span> <span class="n">max_c</span><span class="p">);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">sband</span><span class="p">;</span>
		<span class="n">count_c</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span>
		<span class="n">max_c</span> <span class="o">-=</span> <span class="n">count_c</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AR5K_MODE_11B</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* B mode */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ath5k_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rate</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="cm">/* 5211 only supports B rates and uses 4bit rate codes</span>
<span class="cm">		 * (e.g normally we have 0x1B for 1M, but on 5211 we have 0x0B)</span>
<span class="cm">		 * fix them up here:</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_version</span> <span class="o">==</span> <span class="n">AR5K_AR5211</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span> <span class="o">=</span>
					<span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
				<span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value_short</span> <span class="o">=</span>
					<span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value_short</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ath5k_setup_channels</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span>
					<span class="n">AR5K_MODE_11B</span><span class="p">,</span> <span class="n">max_c</span><span class="p">);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">sband</span><span class="p">;</span>
		<span class="n">count_c</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span>
		<span class="n">max_c</span> <span class="o">-=</span> <span class="n">count_c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ath5k_setup_rate_idx</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sband</span><span class="p">);</span>

	<span class="cm">/* 5GHz band, A mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AR5K_MODE_11A</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sband</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>
		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ath5k_rates</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rate</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">count_c</span><span class="p">];</span>
		<span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ath5k_setup_channels</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span>
					<span class="n">AR5K_MODE_11A</span><span class="p">,</span> <span class="n">max_c</span><span class="p">);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">sband</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ath5k_setup_rate_idx</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sband</span><span class="p">);</span>

	<span class="n">ath5k_debug_dump_bands</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set/change channels. We always reset the chip.</span>
<span class="cm"> * To accomplish this we must first cleanup any pending DMA,</span>
<span class="cm"> * then restart stuff after a la  ath5k_init.</span>
<span class="cm"> *</span>
<span class="cm"> * Called with ah-&gt;lock.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_chan_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span>
		  <span class="s">&quot;channel set, resetting (%u -&gt; %u MHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * To switch channels clear any pending DMA operations;</span>
<span class="cm">	 * wait long enough for the RX fifo to drain, reset the</span>
<span class="cm">	 * hardware at the new frequency, and then re-enable</span>
<span class="cm">	 * the relevant bits of the h/w.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">ath5k_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath5k_vif_iter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_vif_iter_data</span> <span class="o">*</span><span class="n">iter_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_vif</span> <span class="o">*</span><span class="n">avf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">hw_macaddr</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="p">(</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">hw_macaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">found_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">found_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">active_mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">need_set_hw_addr</span> <span class="o">&amp;&amp;</span> <span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">hw_macaddr</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">hw_macaddr</span><span class="p">,</span> <span class="n">mac</span><span class="p">))</span>
			<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">need_set_hw_addr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">any_assoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span>
			<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">any_assoc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate combined mode - when APs are active, operate in AP mode.</span>
<span class="cm">	 * Otherwise use the mode of the new interface. This can currently</span>
<span class="cm">	 * only deal with combinations of APs and STAs. Only one ad-hoc</span>
<span class="cm">	 * interfaces is allowed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
		<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
			<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">n_stas</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">)</span>
			<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">avf</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ath5k_update_bssid_mask_and_opmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath5k_vif_iter_data</span> <span class="n">iter_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rfilt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the hardware MAC address as reference, the hardware uses it</span>
<span class="cm">	 * together with the BSSID mask when matching addresses.</span>
<span class="cm">	 */</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">hw_macaddr</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter_data</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">found_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">need_set_hw_addr</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">;</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">n_stas</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="p">)</span>
		<span class="n">ath5k_vif_iter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter_data</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="cm">/* Get list of all active MAC addresses */</span>
	<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ath5k_vif_iter</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">iter_data</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bssidmask</span><span class="p">,</span> <span class="n">iter_data</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">iter_data</span><span class="p">.</span><span class="n">opmode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">)</span>
		<span class="cm">/* Nothing active, default to station mode */</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>

	<span class="n">ath5k_hw_set_opmode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">);</span>
	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_MODE</span><span class="p">,</span> <span class="s">&quot;mode setup opmode %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">,</span> <span class="n">ath_opmode_to_string</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="p">.</span><span class="n">need_set_hw_addr</span> <span class="o">&amp;&amp;</span> <span class="n">iter_data</span><span class="p">.</span><span class="n">found_active</span><span class="p">)</span>
		<span class="n">ath5k_hw_set_lladdr</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">iter_data</span><span class="p">.</span><span class="n">active_mac</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_hw_hasbssidmask</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ath5k_hw_set_bssid_mask</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bssidmask</span><span class="p">);</span>

	<span class="cm">/* Set up RX Filter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="p">.</span><span class="n">n_stas</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If you have multiple STA interfaces connected to</span>
<span class="cm">		 * different APs, ARPs are not received (most of the time?)</span>
<span class="cm">		 * Enabling PROMISC appears to fix that problem.</span>
<span class="cm">		 */</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="n">AR5K_RX_FILTER_PROM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rfilt</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">filter_flags</span><span class="p">;</span>
	<span class="n">ath5k_hw_set_rx_filter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">rfilt</span><span class="p">);</span>
	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_MODE</span><span class="p">,</span> <span class="s">&quot;RX filter 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rfilt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ath5k_hw_to_driver_rix</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hw_rix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rix</span><span class="p">;</span>

	<span class="cm">/* return base rate on errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">hw_rix</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hw_rix</span> <span class="o">&gt;=</span> <span class="n">AR5K_MAX_RATES</span><span class="p">,</span>
			<span class="s">&quot;hw_rix out of bounds: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_rix</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rix</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">[</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">][</span><span class="n">hw_rix</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">rix</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;invalid hw_rix: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_rix</span><span class="p">))</span>
		<span class="n">rix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rix</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************\</span>
<span class="cm">* Buffers setup *</span>
<span class="cm">\***************/</span>

<span class="k">static</span>
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">ath5k_rx_skb_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="o">*</span><span class="n">skb_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate buffer with headroom_needed space for the</span>
<span class="cm">	 * fake physical layer header at the start.</span>
<span class="cm">	 */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">ath_rxbuf_alloc</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			      <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
			      <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t alloc skbuff of size %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">skb_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
				   <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">skb_addr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;%s: DMA mapping failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_rxbuf_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">ds</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">ath5k_rx_skb_alloc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup descriptors.  For receive we always terminate</span>
<span class="cm">	 * the descriptor list with a self-linked entry so we&#39;ll</span>
<span class="cm">	 * not get overrun under high load (as can happen with a</span>
<span class="cm">	 * 5212 when ANI processing enables PHY error frames).</span>
<span class="cm">	 *</span>
<span class="cm">	 * To ensure the last descriptor is self-linked we create</span>
<span class="cm">	 * each descriptor as self-linked and add it to the end.  As</span>
<span class="cm">	 * each additional descriptor is added the previous self-linked</span>
<span class="cm">	 * entry is &quot;fixed&quot; naturally.  This should be safe even</span>
<span class="cm">	 * if DMA is happening.  When processing RX interrupts we</span>
<span class="cm">	 * never remove/process the last, self-linked, entry on the</span>
<span class="cm">	 * descriptor list.  This ensures the hardware always has</span>
<span class="cm">	 * someplace to write a new frame.</span>
<span class="cm">	 */</span>
	<span class="n">ds</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_link</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>	<span class="cm">/* link to self */</span>
	<span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_data</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_setup_rx_desc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">rx_bufsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;%s: could not setup RX desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxlink</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxlink</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxlink</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_link</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">ath5k_pkt_type</span> <span class="nf">get_hw_packet_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ath5k_pkt_type</span> <span class="n">htype</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">htype</span> <span class="o">=</span> <span class="n">AR5K_PKT_TYPE_BEACON</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">htype</span> <span class="o">=</span> <span class="n">AR5K_PKT_TYPE_PROBE_RESP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_atim</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">htype</span> <span class="o">=</span> <span class="n">AR5K_PKT_TYPE_ATIM</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">htype</span> <span class="o">=</span> <span class="n">AR5K_PKT_TYPE_PSPOLL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">htype</span> <span class="o">=</span> <span class="n">AR5K_PKT_TYPE_NORMAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">htype</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_txbuf_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">ath5k_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">padsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">ds</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pktlen</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">keyidx</span> <span class="o">=</span> <span class="n">AR5K_TXKEYIX_INVALID</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mrr_rate</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">mrr_tries</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hw_rate</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cts_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_flags</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">AR5K_TXDESC_INTREQ</span> <span class="o">|</span> <span class="n">AR5K_TXDESC_CLRDMASK</span><span class="p">;</span>

	<span class="cm">/* XXX endianness */</span>
	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">ieee80211_get_tx_rate</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">AR5K_TXDESC_NOACK</span><span class="p">;</span>

	<span class="n">rc_flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">hw_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">rc_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_SHORT_PREAMBLE</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value_short</span> <span class="o">:</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>

	<span class="n">pktlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* FIXME: If we are in g mode and rate is a CCK rate</span>
<span class="cm">	 * subtract ah-&gt;ah_txpower.txp_cck_ofdm_pwr_delta</span>
<span class="cm">	 * from tx power (value is in dB units already) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">keyidx</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">;</span>
		<span class="n">pktlen</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">AR5K_TXDESC_RTSENA</span><span class="p">;</span>
		<span class="n">cts_rate</span> <span class="o">=</span> <span class="n">ieee80211_get_rts_cts_rate</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
		<span class="n">duration</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ieee80211_rts_duration</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">,</span> <span class="n">pktlen</span><span class="p">,</span> <span class="n">info</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">AR5K_TXDESC_CTSENA</span><span class="p">;</span>
		<span class="n">cts_rate</span> <span class="o">=</span> <span class="n">ieee80211_get_rts_cts_rate</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
		<span class="n">duration</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ieee80211_ctstoself_duration</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">,</span> <span class="n">pktlen</span><span class="p">,</span> <span class="n">info</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_setup_tx_desc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">pktlen</span><span class="p">,</span>
		<span class="n">ieee80211_get_hdrlen_from_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">padsize</span><span class="p">,</span>
		<span class="n">get_hw_packet_type</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
		<span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">hw_rate</span><span class="p">,</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_tx_ant</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
		<span class="n">cts_rate</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>

	<span class="cm">/* Set up MRR descriptor */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_has_mrr_support</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mrr_rate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mrr_rate</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mrr_tries</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mrr_tries</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">ieee80211_get_alt_retry_rate</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rate</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">mrr_rate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
			<span class="n">mrr_tries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ath5k_hw_setup_mrr_tx_desc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span>
			<span class="n">mrr_rate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mrr_tries</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">mrr_rate</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mrr_tries</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">mrr_rate</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">mrr_tries</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_data</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_len</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="cm">/* is this first packet? */</span>
		<span class="n">ath5k_hw_set_txdp</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">qnum</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* no, so only link it */</span>
		<span class="o">*</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_link</span><span class="p">;</span>
	<span class="n">ath5k_hw_start_tx_dma</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">qnum</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_unmap:</span>
	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************\</span>
<span class="cm">* Descriptors setup *</span>
<span class="cm">\*******************/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_desc_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">ds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">da</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* allocate descriptors */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_desc</span><span class="p">)</span> <span class="o">*</span>
			<span class="p">(</span><span class="n">ATH_TXBUF</span> <span class="o">+</span> <span class="n">ATH_RXBUF</span> <span class="o">+</span> <span class="n">ATH_BCBUF</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc_len</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc_daddr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ds</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">da</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc_daddr</span><span class="p">;</span>
	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_ANY</span><span class="p">,</span> <span class="s">&quot;DMA map: %p (%zu) -&gt; %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ds</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc_daddr</span><span class="p">);</span>

	<span class="n">bf</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ATH_TXBUF</span> <span class="o">+</span> <span class="n">ATH_RXBUF</span> <span class="o">+</span> <span class="n">ATH_BCBUF</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_buf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate bufptr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bufptr</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH_RXBUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">bf</span><span class="o">++</span><span class="p">,</span> <span class="n">ds</span><span class="o">++</span><span class="p">,</span> <span class="n">da</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ds</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">ds</span><span class="p">;</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">da</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf_len</span> <span class="o">=</span> <span class="n">ATH_TXBUF</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH_TXBUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">bf</span><span class="o">++</span><span class="p">,</span> <span class="n">ds</span><span class="o">++</span><span class="p">,</span> <span class="n">da</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ds</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">ds</span><span class="p">;</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">da</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* beacon buffers */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bcbuf</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH_BCBUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">bf</span><span class="o">++</span><span class="p">,</span> <span class="n">ds</span><span class="o">++</span><span class="p">,</span> <span class="n">da</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ds</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">ds</span><span class="p">;</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span> <span class="o">=</span> <span class="n">da</span><span class="p">;</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bcbuf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_free:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc_len</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc_daddr</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ath5k_txbuf_free_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ds_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ath5k_rxbuf_free_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
			<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">ds_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_desc_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">ath5k_txbuf_free_skb</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">ath5k_rxbuf_free_skb</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bcbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="n">ath5k_txbuf_free_skb</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="p">);</span>

	<span class="cm">/* Free memory associated with all descriptors */</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc_len</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc_daddr</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">desc_daddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bufptr</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bufptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**************\</span>
<span class="cm">* Queues setup *</span>
<span class="cm">\**************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ath5k_txq</span> <span class="o">*</span>
<span class="nf">ath5k_txq_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">qtype</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_txq_info</span> <span class="n">qi</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">tqi_subtype</span> <span class="o">=</span> <span class="n">subtype</span><span class="p">,</span>
		<span class="cm">/* XXX: default values not correct for B and XR channels,</span>
<span class="cm">		 * but who cares? */</span>
		<span class="p">.</span><span class="n">tqi_aifs</span> <span class="o">=</span> <span class="n">AR5K_TUNE_AIFS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tqi_cw_min</span> <span class="o">=</span> <span class="n">AR5K_TUNE_CWMIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tqi_cw_max</span> <span class="o">=</span> <span class="n">AR5K_TUNE_CWMAX</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">qnum</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable interrupts only for EOL and DESC conditions.</span>
<span class="cm">	 * We mark tx descriptors to receive a DESC interrupt</span>
<span class="cm">	 * when a tx queue gets deep; otherwise we wait for the</span>
<span class="cm">	 * EOL to reap descriptors.  Note that this is done to</span>
<span class="cm">	 * reduce interrupt load and this only defers reaping</span>
<span class="cm">	 * descriptors, never transmitting frames.  Aside from</span>
<span class="cm">	 * reducing interrupts this also permits more concurrency.</span>
<span class="cm">	 * The only potential downside is if the tx queue backs</span>
<span class="cm">	 * up in which case the top half of the kernel may backup</span>
<span class="cm">	 * due to a lack of tx descriptors.</span>
<span class="cm">	 */</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_flags</span> <span class="o">=</span> <span class="n">AR5K_TXQ_FLAG_TXEOLINT_ENABLE</span> <span class="o">|</span>
				<span class="n">AR5K_TXQ_FLAG_TXDESCINT_ENABLE</span><span class="p">;</span>
	<span class="n">qnum</span> <span class="o">=</span> <span class="n">ath5k_hw_setup_tx_queue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">qtype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qnum</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * NB: don&#39;t print a message, this happens</span>
<span class="cm">		 * normally on parts with too few tx queues</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">qnum</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">qnum</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">qnum</span> <span class="o">=</span> <span class="n">qnum</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_max</span> <span class="o">=</span> <span class="n">ATH5K_TXQ_LEN_MAX</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_poll_mark</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_stuck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">qnum</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_beaconq_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_txq_info</span> <span class="n">qi</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* XXX: default values not correct for B and XR channels,</span>
<span class="cm">		 * but who cares? */</span>
		<span class="p">.</span><span class="n">tqi_aifs</span> <span class="o">=</span> <span class="n">AR5K_TUNE_AIFS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tqi_cw_min</span> <span class="o">=</span> <span class="n">AR5K_TUNE_CWMIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">tqi_cw_max</span> <span class="o">=</span> <span class="n">AR5K_TUNE_CWMAX</span><span class="p">,</span>
		<span class="cm">/* NB: for dynamic turbo, don&#39;t enable any other interrupts */</span>
		<span class="p">.</span><span class="n">tqi_flags</span> <span class="o">=</span> <span class="n">AR5K_TXQ_FLAG_TXDESCINT_ENABLE</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">ath5k_hw_setup_tx_queue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TX_QUEUE_BEACON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_beaconq_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_txq_info</span> <span class="n">qi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_get_tx_queueprops</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
	    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Always burst out beacon and CAB traffic</span>
<span class="cm">		 * (aifs = cwmin = cwmax = 0)</span>
<span class="cm">		 */</span>
		<span class="n">qi</span><span class="p">.</span><span class="n">tqi_aifs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cw_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cw_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Adhoc mode; backoff between 0 and (2 * cw_min).</span>
<span class="cm">		 */</span>
		<span class="n">qi</span><span class="p">.</span><span class="n">tqi_aifs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cw_min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cw_max</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">AR5K_TUNE_CWMIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
		<span class="s">&quot;beacon queueprops tqi_aifs:%d tqi_cw_min:%d tqi_cw_max:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">qi</span><span class="p">.</span><span class="n">tqi_aifs</span><span class="p">,</span> <span class="n">qi</span><span class="p">.</span><span class="n">tqi_cw_min</span><span class="p">,</span> <span class="n">qi</span><span class="p">.</span><span class="n">tqi_cw_max</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_set_tx_queueprops</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;%s: unable to update parameters for beacon &quot;</span>
			<span class="s">&quot;hardware queue!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_reset_tx_queue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">);</span> <span class="cm">/* push to h/w */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* reconfigure cabq with ready time to 80% of beacon_interval */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_get_tx_queueprops</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TX_QUEUE_ID_CAB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_ready_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bintval</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_set_tx_queueprops</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TX_QUEUE_ID_CAB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_reset_tx_queue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TX_QUEUE_ID_CAB</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_drain_tx_buffs - Empty tx buffers</span>
<span class="cm"> *</span>
<span class="cm"> * @ah The &amp;struct ath5k_hw</span>
<span class="cm"> *</span>
<span class="cm"> * Empty tx buffers from all queues in preparation</span>
<span class="cm"> * of a reset or during shutdown.</span>
<span class="cm"> *</span>
<span class="cm"> * NB:	this assumes output has been stopped and</span>
<span class="cm"> *	we do not need to block ath5k_tx_tasklet</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_drain_tx_buffs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="o">*</span><span class="n">bf0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">bf0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath5k_debug_printtxbuf</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="p">);</span>

				<span class="n">ath5k_txbuf_free_skb</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="p">);</span>

				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuflock</span><span class="p">);</span>
				<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">);</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf_len</span><span class="o">++</span><span class="p">;</span>
				<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_len</span><span class="o">--</span><span class="p">;</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuflock</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_poll_mark</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_txq_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_txq</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">txq</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">setup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath5k_hw_release_tx_queue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">qnum</span><span class="p">);</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">setup</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*************\</span>
<span class="cm">* RX Handling *</span>
<span class="cm">\*************/</span>

<span class="cm">/*</span>
<span class="cm"> * Enable the receive h/w following a reset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_rx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">IEEE80211_MAX_FRAME_LEN</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">cachelsz</span><span class="p">);</span>

	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span> <span class="s">&quot;cachelsz %u rx_bufsize %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">common</span><span class="o">-&gt;</span><span class="n">cachelsz</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuflock</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxlink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_rxbuf_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuflock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">ath5k_hw_set_rxdp</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuflock</span><span class="p">);</span>

	<span class="n">ath5k_hw_start_rx_dma</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>	<span class="cm">/* enable recv descriptors */</span>
	<span class="n">ath5k_update_bssid_mask_and_opmode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span> <span class="cm">/* set filters, etc. */</span>
	<span class="n">ath5k_hw_start_rx_pcu</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>	<span class="cm">/* re-enable PCU/DMA engine */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Disable the receive logic on PCU (DRU)</span>
<span class="cm"> * In preparation for a shutdown.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Doesn&#39;t stop rx DMA, ath5k_hw_dma_stop</span>
<span class="cm"> * does.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_rx_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">ath5k_hw_set_rx_filter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* clear recv filter */</span>
	<span class="n">ath5k_hw_stop_rx_pcu</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>	<span class="cm">/* disable PCU */</span>

	<span class="n">ath5k_debug_printrxbuffs</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">ath5k_rx_decrypted</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ath5k_rx_status</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keyix</span><span class="p">,</span> <span class="n">hlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">AR5K_RXERR_DECRYPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_keyix</span> <span class="o">!=</span> <span class="n">AR5K_RXKEYIX_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">;</span>

	<span class="cm">/* Apparently when a default key is used to decrypt the packet</span>
<span class="cm">	   the hw does not set the index used to decrypt.  In such cases</span>
<span class="cm">	   get the index from the packet. */</span>
	<span class="n">hlen</span> <span class="o">=</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">AR5K_RXERR_DECRYPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">hlen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">keyix</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">hlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">keyix</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">keymap</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_check_ibss_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rxs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">tsf</span><span class="p">,</span> <span class="n">bc_tstamp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hw_tu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">capab_info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Received an IBSS beacon with the same BSSID. Hardware *must*</span>
<span class="cm">		 * have updated the local TSF. We have to work around various</span>
<span class="cm">		 * hardware bugs, though...</span>
<span class="cm">		 */</span>
		<span class="n">tsf</span> <span class="o">=</span> <span class="n">ath5k_hw_get_tsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">bc_tstamp</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">timestamp</span><span class="p">);</span>
		<span class="n">hw_tu</span> <span class="o">=</span> <span class="n">TSF_TO_TU</span><span class="p">(</span><span class="n">tsf</span><span class="p">);</span>

		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
			<span class="s">&quot;beacon %llx mactime %llx (diff %lld) tsf now %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bc_tstamp</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rxs</span><span class="o">-&gt;</span><span class="n">mactime</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)(</span><span class="n">rxs</span><span class="o">-&gt;</span><span class="n">mactime</span> <span class="o">-</span> <span class="n">bc_tstamp</span><span class="p">),</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tsf</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Sometimes the HW will give us a wrong tstamp in the rx</span>
<span class="cm">		 * status, causing the timestamp extension to go wrong.</span>
<span class="cm">		 * (This seems to happen especially with beacon frames bigger</span>
<span class="cm">		 * than 78 byte (incl. FCS))</span>
<span class="cm">		 * But we know that the receive timestamp must be later than the</span>
<span class="cm">		 * timestamp of the beacon since HW must have synced to that.</span>
<span class="cm">		 *</span>
<span class="cm">		 * NOTE: here we assume mactime to be after the frame was</span>
<span class="cm">		 * received, not like mac80211 which defines it at the start.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc_tstamp</span> <span class="o">&gt;</span> <span class="n">rxs</span><span class="o">-&gt;</span><span class="n">mactime</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
				<span class="s">&quot;fixing mactime from %llx to %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rxs</span><span class="o">-&gt;</span><span class="n">mactime</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tsf</span><span class="p">);</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">mactime</span> <span class="o">=</span> <span class="n">tsf</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Local TSF might have moved higher than our beacon timers,</span>
<span class="cm">		 * in that case we have to update them to continue sending</span>
<span class="cm">		 * beacons. This also takes care of synchronizing beacon sending</span>
<span class="cm">		 * times with other stations.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw_tu</span> <span class="o">&gt;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">nexttbtt</span><span class="p">)</span>
			<span class="n">ath5k_beacon_update_timers</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bc_tstamp</span><span class="p">);</span>

		<span class="cm">/* Check if the beacon timers are still correct, because a TSF</span>
<span class="cm">		 * update might have created a window between them - for a</span>
<span class="cm">		 * longer description see the comment of this function: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath5k_hw_check_beacon_timers</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bintval</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath5k_beacon_update_timers</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bc_tstamp</span><span class="p">);</span>
			<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
				<span class="s">&quot;fixed beacon timers after beacon receive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_update_beacon_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/* only beacons from our BSSID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ewma_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_beacon_rssi_avg</span><span class="p">,</span> <span class="n">rssi</span><span class="p">);</span>

	<span class="cm">/* in IBSS mode we should keep RSSI statistics per neighbour */</span>
	<span class="cm">/* le16_to_cpu(mgmt-&gt;u.beacon.capab_info) &amp; WLAN_CAPABILITY_IBSS */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Compute padding position. skb must contain an IEEE 802.11 frame</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath5k_common_padpos</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">frame_control</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">padpos</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">padpos</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">padpos</span> <span class="o">+=</span> <span class="n">IEEE80211_QOS_CTL_LEN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">padpos</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function expects an 802.11 frame and returns the number of</span>
<span class="cm"> * bytes added, or -1 if we don&#39;t have enough header room.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath5k_add_padding</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">padpos</span> <span class="o">=</span> <span class="n">ath5k_common_padpos</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">padsize</span> <span class="o">=</span> <span class="n">padpos</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padsize</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">padpos</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">padsize</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">padsize</span><span class="p">);</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">padpos</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">padsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The MAC header is padded to have 32-bit boundary if the</span>
<span class="cm"> * packet payload is non-zero. The general calculation for</span>
<span class="cm"> * padsize would take into account odd header lengths:</span>
<span class="cm"> * padsize = 4 - (hdrlen &amp; 3); however, since only</span>
<span class="cm"> * even-length headers are used, padding can only be 0 or 2</span>
<span class="cm"> * bytes and we can optimize this a bit.  We must not try to</span>
<span class="cm"> * remove padding from short control frames that do not have a</span>
<span class="cm"> * payload.</span>
<span class="cm"> *</span>
<span class="cm"> * This function expects an 802.11 frame and returns the number of</span>
<span class="cm"> * bytes removed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath5k_remove_padding</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">padpos</span> <span class="o">=</span> <span class="n">ath5k_common_padpos</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">padsize</span> <span class="o">=</span> <span class="n">padpos</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padsize</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">padpos</span> <span class="o">+</span> <span class="n">padsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">padpos</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">padsize</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">padsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_receive_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ath5k_rx_status</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rxs</span><span class="p">;</span>

	<span class="n">ath5k_remove_padding</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">rxs</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">AR5K_RXERR_MIC</span><span class="p">))</span>
		<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MMIC_ERROR</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * always extend the mac timestamp, since this information is</span>
<span class="cm">	 * also needed for proper IBSS merging.</span>
<span class="cm">	 *</span>
<span class="cm">	 * XXX: it might be too late to do it here, since rs_tstamp is</span>
<span class="cm">	 * 15bit only. that means TSF extension has to be done within</span>
<span class="cm">	 * 32768usec (about 32ms). it might be necessary to move this to</span>
<span class="cm">	 * the interrupt handler, like it is done in madwifi.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Unfortunately we don&#39;t know when the hardware takes the rx</span>
<span class="cm">	 * timestamp (beginning of phy frame, data frame, end of rx?).</span>
<span class="cm">	 * The only thing we know is that it is hardware specific...</span>
<span class="cm">	 * On AR5213 it seems the rx timestamp is at the end of the</span>
<span class="cm">	 * frame, but I&#39;m not sure.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: mac80211 defines mactime at the beginning of the first</span>
<span class="cm">	 * data symbol. Since we don&#39;t have any time references it&#39;s</span>
<span class="cm">	 * impossible to comply to that. This affects IBSS merge only</span>
<span class="cm">	 * right now, so it&#39;s not too bad...</span>
<span class="cm">	 */</span>
	<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">mactime</span> <span class="o">=</span> <span class="n">ath5k_extend_tsf</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_tstamp</span><span class="p">);</span>
	<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MACTIME_MPDU</span><span class="p">;</span>

	<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">;</span>
	<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>

	<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_noise_floor</span> <span class="o">+</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rssi</span><span class="p">;</span>

	<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">antenna</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_antenna</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_antenna</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_antenna</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">antenna_rx</span><span class="p">[</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_antenna</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">antenna_rx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* invalid */</span>

	<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">ath5k_hw_to_driver_rix</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rate</span><span class="p">);</span>
	<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">ath5k_rx_decrypted</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxs</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rate</span> <span class="o">==</span>
	    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">].</span><span class="n">bitrates</span><span class="p">[</span><span class="n">rxs</span><span class="o">-&gt;</span><span class="n">rate_idx</span><span class="p">].</span><span class="n">hw_value_short</span><span class="p">)</span>
		<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORTPRE</span><span class="p">;</span>

	<span class="n">trace_ath5k_rx</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">ath5k_update_beacon_rssi</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rssi</span><span class="p">);</span>

	<span class="cm">/* check beacons in IBSS mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="n">ath5k_check_ibss_tsf</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rxs</span><span class="p">);</span>

	<span class="n">ieee80211_rx</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/** ath5k_frame_receive_ok() - Do we want to receive this frame or not?</span>
<span class="cm"> *</span>
<span class="cm"> * Check if we want to further process this frame or not. Also update</span>
<span class="cm"> * statistics. Return true if we want this frame, false if not.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">ath5k_receive_frame_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_rx_status</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_all_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes_count</span> <span class="o">+=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_datalen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">AR5K_RXERR_CRC</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxerr_crc</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">AR5K_RXERR_FIFO</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxerr_fifo</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">AR5K_RXERR_PHY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxerr_phy</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_phyerr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_phyerr</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxerr_phy_code</span><span class="p">[</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_phyerr</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">AR5K_RXERR_DECRYPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Decrypt error.  If the error occurred</span>
<span class="cm">			 * because there was no hardware key, then</span>
<span class="cm">			 * let the frame through so the upper layers</span>
<span class="cm">			 * can process it.  This is necessary for 5210</span>
<span class="cm">			 * parts which have no way to setup a ``clear&#39;&#39;</span>
<span class="cm">			 * key cache entry.</span>
<span class="cm">			 *</span>
<span class="cm">			 * XXX do key cache faulting</span>
<span class="cm">			 */</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxerr_decrypt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_keyix</span> <span class="o">==</span> <span class="n">AR5K_RXKEYIX_INVALID</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">AR5K_RXERR_CRC</span><span class="p">))</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">AR5K_RXERR_MIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxerr_mic</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* reject any frames with non-crypto errors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">AR5K_RXERR_DECRYPT</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_more</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxerr_jumbo</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_set_current_imask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">ath5k_int</span> <span class="n">imask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">imask</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rx_pending</span><span class="p">)</span>
		<span class="n">imask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR5K_INT_RX_ALL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">)</span>
		<span class="n">imask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR5K_INT_TX_ALL</span><span class="p">;</span>
	<span class="n">ath5k_hw_set_imr</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">imask</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_tasklet_rx</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_rx_status</span> <span class="n">rs</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">next_skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">next_skb_addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">ds</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuflock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_WARN</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;empty rx buf pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

		<span class="cm">/* bail if HW is still using self-linked descriptor */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_hw_get_rxdp</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">==</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_proc_rx_desc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;error in processing rx descriptor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxerr_proc</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_receive_frame_ok</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">next_skb</span> <span class="o">=</span> <span class="n">ath5k_rx_skb_alloc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_skb_addr</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * If we can&#39;t replace bf-&gt;skb with a new skb under</span>
<span class="cm">			 * memory pressure, just skip this packet</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next_skb</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>

			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">,</span>
					 <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
					 <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rs</span><span class="p">.</span><span class="n">rs_datalen</span><span class="p">);</span>

			<span class="n">ath5k_receive_frame</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">);</span>

			<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">next_skb</span><span class="p">;</span>
			<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span> <span class="o">=</span> <span class="n">next_skb_addr</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">next:</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ath5k_rxbuf_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuflock</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ath5k_set_current_imask</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*************\</span>
<span class="cm">* TX Handling *</span>
<span class="cm">\*************/</span>

<span class="kt">void</span>
<span class="nf">ath5k_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">ath5k_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">padsize</span><span class="p">;</span>

	<span class="n">trace_ath5k_tx</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The hardware expects the header padded to 4 byte boundaries.</span>
<span class="cm">	 * If this is not the case, we add the padding after the header.</span>
<span class="cm">	 */</span>
	<span class="n">padsize</span> <span class="o">=</span> <span class="n">ath5k_add_padding</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padsize</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;tx hdrlen not %%4: not enough&quot;</span>
			  <span class="s">&quot; headroom to pad&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_len</span> <span class="o">&gt;=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_max</span> <span class="o">&amp;&amp;</span>
	    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">qnum</span> <span class="o">&lt;=</span> <span class="n">AR5K_TX_QUEUE_ID_DATA_MAX</span><span class="p">)</span>
		<span class="n">ieee80211_stop_queue</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">qnum</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;no further txbuf available, dropping packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf_len</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">))</span>
		<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_txbuf_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">padsize</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf_len</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_packet</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">drop_packet:</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_tx_frame_completed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ath5k_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_tx_status</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tries</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_all_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes_count</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">tries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span><span class="p">;</span>
	<span class="n">tries</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span><span class="p">;</span>
	<span class="n">tries</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">count</span><span class="p">;</span>

	<span class="n">ieee80211_tx_info_clear_status</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_final_idx</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">r</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">tries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_final_idx</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_final_retry</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_final_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ack_fail</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">&amp;</span> <span class="n">AR5K_TXERR_FILT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_TX_FILTERED</span><span class="p">;</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txerr_filt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">&amp;</span> <span class="n">AR5K_TXERR_XRETRY</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txerr_retry</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">&amp;</span> <span class="n">AR5K_TXERR_FIFO</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">txerr_fifo</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ack_signal</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_rssi</span><span class="p">;</span>

		<span class="cm">/* count the successful attempt as well */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_final_idx</span><span class="p">].</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	* Remove MAC header padding before giving the frame</span>
<span class="cm">	* back to mac80211.</span>
<span class="cm">	*/</span>
	<span class="n">ath5k_remove_padding</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_antenna</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_antenna</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">antenna_tx</span><span class="p">[</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_antenna</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">antenna_tx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* invalid */</span>

	<span class="n">trace_ath5k_tx_complete</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">ts</span><span class="p">);</span>
	<span class="n">ieee80211_tx_status</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_tx_processq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_tx_status</span> <span class="n">ts</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="o">*</span><span class="n">bf0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">ds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">bf0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_poll_mark</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/* skb might already have been processed last time. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ds</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_proc_tx_desc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					<span class="s">&quot;error %d while processing &quot;</span>
					<span class="s">&quot;queue %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">qnum</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
			<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
			<span class="n">ath5k_tx_frame_completed</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * It&#39;s possible that the hardware can say the buffer is</span>
<span class="cm">		 * completed when it hasn&#39;t yet loaded the ds_link from</span>
<span class="cm">		 * host memory and moved on.</span>
<span class="cm">		 * Always keep the last descriptor to avoid HW races...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_hw_get_txdp</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">qnum</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuflock</span><span class="p">);</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf</span><span class="p">);</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuf_len</span><span class="o">++</span><span class="p">;</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_len</span><span class="o">--</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuflock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_len</span> <span class="o">&lt;</span> <span class="n">ATH5K_TXQ_LEN_LOW</span> <span class="o">&amp;&amp;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">qnum</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ieee80211_wake_queue</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">qnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_tasklet_tx</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR5K_NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setup</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_txq_isr_txok_all</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
			<span class="n">ath5k_tx_processq</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ath5k_set_current_imask</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************\</span>
<span class="cm">* Beacon handling *</span>
<span class="cm">\*****************/</span>

<span class="cm">/*</span>
<span class="cm"> * Setup the beacon frame for transmit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_beacon_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span>	<span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath5k_desc</span> <span class="o">*</span><span class="n">ds</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">antenna</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">padsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span> <span class="s">&quot;skb %p [data %p len %u] &quot;</span>
			<span class="s">&quot;skbaddr %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;beacon DMA mapping failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ds</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="n">antenna</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_tx_ant</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">AR5K_TXDESC_NOACK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span> <span class="n">ath5k_hw_hasveol</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_link</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">;</span>	<span class="cm">/* self-linked */</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">AR5K_TXDESC_VEOL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we use multiple antennas on AP and use</span>
<span class="cm">	 * the Sectored AP scenario, switch antenna every</span>
<span class="cm">	 * 4 beacons to make sure everybody hears our AP.</span>
<span class="cm">	 * When a client tries to associate, hw will keep</span>
<span class="cm">	 * track of the tx antenna to be used for this client</span>
<span class="cm">	 * automatically, based on ACKed packets.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: AP still listens and transmits RTS on the</span>
<span class="cm">	 * default antenna which is supposed to be an omni.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note2: On sectored scenarios it&#39;s possible to have</span>
<span class="cm">	 * multiple antennas (1 omni -- the default -- and 14</span>
<span class="cm">	 * sectors), so if we choose to actually support this</span>
<span class="cm">	 * mode, we need to allow the user to set how many antennas</span>
<span class="cm">	 * we have and tweak the code below to send beacons</span>
<span class="cm">	 * on all of them.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ant_mode</span> <span class="o">==</span> <span class="n">AR5K_ANTMODE_SECTOR_AP</span><span class="p">)</span>
		<span class="n">antenna</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bsent</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>


	<span class="cm">/* FIXME: If we are in g mode and rate is a CCK rate</span>
<span class="cm">	 * subtract ah-&gt;ah_txpower.txp_cck_ofdm_pwr_delta</span>
<span class="cm">	 * from tx power (value is in dB units already) */</span>
	<span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_data</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_setup_tx_desc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="n">ieee80211_get_hdrlen_from_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">padsize</span><span class="p">,</span>
			<span class="n">AR5K_PKT_TYPE_BEACON</span><span class="p">,</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">ieee80211_get_tx_rate</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">,</span>
			<span class="mi">1</span><span class="p">,</span> <span class="n">AR5K_TXKEYIX_INVALID</span><span class="p">,</span>
			<span class="n">antenna</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unmap</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_unmap:</span>
	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skbaddr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Updates the beacon that is sent by ath5k_beacon_send.  For adhoc,</span>
<span class="cm"> * this is called only once at config_bss time, for AP we do it every</span>
<span class="cm"> * SWBA interrupt so that the TIM will reflect buffered frames.</span>
<span class="cm"> *</span>
<span class="cm"> * Called with the beacon lock.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_beacon_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_vif</span> <span class="o">*</span><span class="n">avf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath5k_txbuf_free_skb</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">avf</span><span class="o">-&gt;</span><span class="n">bbuf</span><span class="p">);</span>
	<span class="n">avf</span><span class="o">-&gt;</span><span class="n">bbuf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_beacon_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">avf</span><span class="o">-&gt;</span><span class="n">bbuf</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Transmit a beacon frame at SWBA.  Dynamic updates to the</span>
<span class="cm"> * frame contents are done as needed and the slot time is</span>
<span class="cm"> * also adjusted based on current state.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called from software irq context (beacontq tasklets)</span>
<span class="cm"> * or user context from ath5k_beacon_config.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_beacon_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_vif</span> <span class="o">*</span><span class="n">avf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span> <span class="s">&quot;in beacon_send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if the previous beacon has gone out.  If</span>
<span class="cm">	 * not, don&#39;t don&#39;t try to post another: skip this</span>
<span class="cm">	 * period and wait for the next.  Missed beacons</span>
<span class="cm">	 * indicate a problem and should not occur.  If we</span>
<span class="cm">	 * miss too many consecutive beacons reset the device.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ath5k_hw_num_tx_pending</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bmisscount</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
			<span class="s">&quot;missed %u consecutive beacons</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bmisscount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bmisscount</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* NB: 10 is a guess */</span>
			<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
				<span class="s">&quot;stuck beacon time (%u missed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bmisscount</span><span class="p">);</span>
			<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span>
				  <span class="s">&quot;stuck beacon, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bmisscount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
			<span class="s">&quot;resume beacon xmit after %u misses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bmisscount</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bmisscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_ap_vifs</span> <span class="o">+</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_mesh_vifs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">tsf</span> <span class="o">=</span> <span class="n">ath5k_hw_get_tsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">tsftu</span> <span class="o">=</span> <span class="n">TSF_TO_TU</span><span class="p">(</span><span class="n">tsf</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">slot</span> <span class="o">=</span> <span class="p">((</span><span class="n">tsftu</span> <span class="o">%</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bintval</span><span class="p">)</span> <span class="o">*</span> <span class="n">ATH_BCBUF</span><span class="p">)</span> <span class="o">/</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bintval</span><span class="p">;</span>
		<span class="n">vif</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bslot</span><span class="p">[(</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">ATH_BCBUF</span><span class="p">];</span>
		<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
			<span class="s">&quot;tsf %llx tsftu %x intval %u slot %u vif %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">tsf</span><span class="p">,</span> <span class="n">tsftu</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bintval</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="cm">/* only one interface */</span>
		<span class="n">vif</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bslot</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">avf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">bf</span> <span class="o">=</span> <span class="n">avf</span><span class="o">-&gt;</span><span class="n">bbuf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop any current dma and put the new frame on the queue.</span>
<span class="cm">	 * This should never fail since we check above that no frames</span>
<span class="cm">	 * are still pending on the queue.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ath5k_hw_stop_beacon_queue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ATH5K_WARN</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;beacon queue %u didn&#39;t start/stop ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">);</span>
		<span class="cm">/* NB: hw still stops DMA, so proceed */</span>
	<span class="p">}</span>

	<span class="cm">/* refresh the beacon for AP or MESH mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
	    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ath5k_beacon_update</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">||</span>
		     <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_WARN</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;bf=%p bf_skb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_ath5k_tx</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">]);</span>

	<span class="n">ath5k_hw_set_txdp</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">);</span>
	<span class="n">ath5k_hw_start_tx_dma</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">);</span>
	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span> <span class="s">&quot;TXDP[%u] = %llx (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_get_buffered_bc</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath5k_tx_queue</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">cabq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">cabq</span><span class="o">-&gt;</span><span class="n">txq_len</span> <span class="o">&gt;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">cabq</span><span class="o">-&gt;</span><span class="n">txq_max</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_get_buffered_bc</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bsent</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_beacon_update_timers - update beacon timers</span>
<span class="cm"> *</span>
<span class="cm"> * @ah: struct ath5k_hw pointer we are operating on</span>
<span class="cm"> * @bc_tsf: the timestamp of the beacon. 0 to reset the TSF. -1 to perform a</span>
<span class="cm"> *          beacon timer update based on the current HW TSF.</span>
<span class="cm"> *</span>
<span class="cm"> * Calculate the next target beacon transmit time (TBTT) based on the timestamp</span>
<span class="cm"> * of a received beacon or the current local hardware TSF and write it to the</span>
<span class="cm"> * beacon timer registers.</span>
<span class="cm"> *</span>
<span class="cm"> * This is called in a variety of situations, e.g. when a beacon is received,</span>
<span class="cm"> * when a TSF update has been detected, but also when an new IBSS is created or</span>
<span class="cm"> * when we otherwise know we have to update the timers, but we keep it in this</span>
<span class="cm"> * function to have it all together in one place.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_beacon_update_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u64</span> <span class="n">bc_tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nexttbtt</span><span class="p">,</span> <span class="n">intval</span><span class="p">,</span> <span class="n">hw_tu</span><span class="p">,</span> <span class="n">bc_tu</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hw_tsf</span><span class="p">;</span>

	<span class="n">intval</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bintval</span> <span class="o">&amp;</span> <span class="n">AR5K_BEACON_PERIOD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_ap_vifs</span>
		<span class="o">+</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">num_mesh_vifs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intval</span> <span class="o">/=</span> <span class="n">ATH_BCBUF</span><span class="p">;</span>	<span class="cm">/* staggered multi-bss beacons */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intval</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">ATH5K_WARN</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;intval %u is too low, min 15</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">intval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">intval</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* beacon TSF converted to TU */</span>
	<span class="n">bc_tu</span> <span class="o">=</span> <span class="n">TSF_TO_TU</span><span class="p">(</span><span class="n">bc_tsf</span><span class="p">);</span>

	<span class="cm">/* current TSF converted to TU */</span>
	<span class="n">hw_tsf</span> <span class="o">=</span> <span class="n">ath5k_hw_get_tsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">hw_tu</span> <span class="o">=</span> <span class="n">TSF_TO_TU</span><span class="p">(</span><span class="n">hw_tsf</span><span class="p">);</span>

<span class="cp">#define FUDGE (AR5K_TUNE_SW_BEACON_RESP + 3)</span>
	<span class="cm">/* We use FUDGE to make sure the next TBTT is ahead of the current TU.</span>
<span class="cm">	 * Since we later subtract AR5K_TUNE_SW_BEACON_RESP (10) in the timer</span>
<span class="cm">	 * configuration we need to make sure it is bigger than that. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bc_tsf</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * no beacons received, called internally.</span>
<span class="cm">		 * just need to refresh timers based on HW TSF.</span>
<span class="cm">		 */</span>
		<span class="n">nexttbtt</span> <span class="o">=</span> <span class="n">roundup</span><span class="p">(</span><span class="n">hw_tu</span> <span class="o">+</span> <span class="n">FUDGE</span><span class="p">,</span> <span class="n">intval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bc_tsf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * no beacon received, probably called by ath5k_reset_tsf().</span>
<span class="cm">		 * reset TSF to start with 0.</span>
<span class="cm">		 */</span>
		<span class="n">nexttbtt</span> <span class="o">=</span> <span class="n">intval</span><span class="p">;</span>
		<span class="n">intval</span> <span class="o">|=</span> <span class="n">AR5K_BEACON_RESET_TSF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bc_tsf</span> <span class="o">&gt;</span> <span class="n">hw_tsf</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * beacon received, SW merge happened but HW TSF not yet updated.</span>
<span class="cm">		 * not possible to reconfigure timers yet, but next time we</span>
<span class="cm">		 * receive a beacon with the same BSSID, the hardware will</span>
<span class="cm">		 * automatically update the TSF and then we need to reconfigure</span>
<span class="cm">		 * the timers.</span>
<span class="cm">		 */</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
			<span class="s">&quot;need to wait for HW TSF sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * most important case for beacon synchronization between STA.</span>
<span class="cm">		 *</span>
<span class="cm">		 * beacon received and HW TSF has been already updated by HW.</span>
<span class="cm">		 * update next TBTT based on the TSF of the beacon, but make</span>
<span class="cm">		 * sure it is ahead of our local TSF timer.</span>
<span class="cm">		 */</span>
		<span class="n">nexttbtt</span> <span class="o">=</span> <span class="n">bc_tu</span> <span class="o">+</span> <span class="n">roundup</span><span class="p">(</span><span class="n">hw_tu</span> <span class="o">+</span> <span class="n">FUDGE</span> <span class="o">-</span> <span class="n">bc_tu</span><span class="p">,</span> <span class="n">intval</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#undef FUDGE</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nexttbtt</span> <span class="o">=</span> <span class="n">nexttbtt</span><span class="p">;</span>

	<span class="n">intval</span> <span class="o">|=</span> <span class="n">AR5K_BEACON_ENA</span><span class="p">;</span>
	<span class="n">ath5k_hw_init_beacon_timers</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">nexttbtt</span><span class="p">,</span> <span class="n">intval</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * debugging output last in order to preserve the time critical aspect</span>
<span class="cm">	 * of this function</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bc_tsf</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
			<span class="s">&quot;reconfigured timers based on HW TSF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bc_tsf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
			<span class="s">&quot;reset HW TSF and timers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
			<span class="s">&quot;updated timers based on beacon TSF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
			  <span class="s">&quot;bc_tsf %llx hw_tsf %llx bc_tu %u hw_tu %u nexttbtt %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">bc_tsf</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">hw_tsf</span><span class="p">,</span> <span class="n">bc_tu</span><span class="p">,</span> <span class="n">hw_tu</span><span class="p">,</span> <span class="n">nexttbtt</span><span class="p">);</span>
	<span class="n">ATH5K_DBG_UNLIMIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span> <span class="s">&quot;intval %u %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">intval</span> <span class="o">&amp;</span> <span class="n">AR5K_BEACON_PERIOD</span><span class="p">,</span>
		<span class="n">intval</span> <span class="o">&amp;</span> <span class="n">AR5K_BEACON_ENA</span> <span class="o">?</span> <span class="s">&quot;AR5K_BEACON_ENA&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">intval</span> <span class="o">&amp;</span> <span class="n">AR5K_BEACON_RESET_TSF</span> <span class="o">?</span> <span class="s">&quot;AR5K_BEACON_RESET_TSF&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath5k_beacon_config - Configure the beacon queues and interrupts</span>
<span class="cm"> *</span>
<span class="cm"> * @ah: struct ath5k_hw pointer we are operating on</span>
<span class="cm"> *</span>
<span class="cm"> * In IBSS mode we use a self-linked tx descriptor if possible. We enable SWBA</span>
<span class="cm"> * interrupts to detect TSF updates only.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">ath5k_beacon_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bmisscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AR5K_INT_BMISS</span> <span class="o">|</span> <span class="n">AR5K_INT_SWBA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * In IBSS mode we use a self-linked tx descriptor and let the</span>
<span class="cm">		 * hardware send the beacons automatically. We have to load it</span>
<span class="cm">		 * only once here.</span>
<span class="cm">		 * We use the SWBA interrupt only to keep track of the beacon</span>
<span class="cm">		 * timers in order to detect automatic TSF updates.</span>
<span class="cm">		 */</span>
		<span class="n">ath5k_beaconq_config</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">|=</span> <span class="n">AR5K_INT_SWBA</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_hw_hasveol</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
				<span class="n">ath5k_beacon_send</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ath5k_beacon_update_timers</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath5k_hw_stop_beacon_queue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath5k_hw_set_imr</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath5k_tasklet_beacon</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Software beacon alert--time to send a beacon.</span>
<span class="cm">	 *</span>
<span class="cm">	 * In IBSS mode we use this interrupt just to</span>
<span class="cm">	 * keep track of the next TBTT (target beacon</span>
<span class="cm">	 * transmission time) in order to detect whether</span>
<span class="cm">	 * automatic TSF updates happened.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* XXX: only if VEOL supported */</span>
		<span class="n">u64</span> <span class="n">tsf</span> <span class="o">=</span> <span class="n">ath5k_hw_get_tsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nexttbtt</span> <span class="o">+=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bintval</span><span class="p">;</span>
		<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_BEACON</span><span class="p">,</span>
				<span class="s">&quot;SWBA nexttbtt: %x hw_tu: %x &quot;</span>
				<span class="s">&quot;TSF: %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nexttbtt</span><span class="p">,</span>
				<span class="n">TSF_TO_TU</span><span class="p">(</span><span class="n">tsf</span><span class="p">),</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">tsf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">);</span>
		<span class="n">ath5k_beacon_send</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/********************\</span>
<span class="cm">* Interrupt handling *</span>
<span class="cm">\********************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_intr_calibration_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_is_before_eq_jiffies</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_next_ani</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">&amp;</span> <span class="n">AR5K_CALIBRATION_FULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">&amp;</span> <span class="n">AR5K_CALIBRATION_SHORT</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* Run ANI only when calibration is not active */</span>

		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_next_ani</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH5K_TUNE_CALIBRATION_INTERVAL_ANI</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_tasklet</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">time_is_before_eq_jiffies</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_next_short</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">&amp;</span> <span class="n">AR5K_CALIBRATION_FULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">&amp;</span> <span class="n">AR5K_CALIBRATION_SHORT</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* Run calibration only when another calibration</span>
<span class="cm">		 * is not running.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note: This is for both full/short calibration,</span>
<span class="cm">		 * if it&#39;s time for a full one, ath5k_calibrate_work will deal</span>
<span class="cm">		 * with it. */</span>

		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_next_short</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH5K_TUNE_CALIBRATION_INTERVAL_SHORT</span><span class="p">);</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">calib_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* we could use SWI to generate enough interrupts to meet our</span>
<span class="cm">	 * calibration interval requirements, if necessary:</span>
<span class="cm">	 * AR5K_REG_ENABLE_BITS(ah, AR5K_CR, AR5K_CR_SWI); */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_schedule_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxtq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_schedule_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txtq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">ath5k_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ath5k_int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">counter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * If hw is not ready (or detached) and we get an</span>
<span class="cm">	 * interrupt, or if we have no interrupts pending</span>
<span class="cm">	 * (that means it&#39;s not for us) skip it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: Group 0/1 PCI interface registers are not</span>
<span class="cm">	 * supported on WiSOCs, so we can&#39;t check for pending</span>
<span class="cm">	 * interrupts (ISR belongs to another register group</span>
<span class="cm">	 * so we are ok).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATH_STAT_INVALID</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">ath5k_get_bus_type</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ATH_AHB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">ath5k_hw_is_intr_pending</span><span class="p">(</span><span class="n">ah</span><span class="p">))))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/** Main loop **/</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ath5k_hw_get_isr</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>	<span class="cm">/* NB: clears IRQ too */</span>

		<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_INTR</span><span class="p">,</span> <span class="s">&quot;status 0x%x/0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">status</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Fatal hw error -&gt; Log and reset</span>
<span class="cm">		 *</span>
<span class="cm">		 * Fatal errors are unrecoverable so we have to</span>
<span class="cm">		 * reset the card. These errors include bus and</span>
<span class="cm">		 * dma errors.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AR5K_INT_FATAL</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span>
				  <span class="s">&quot;fatal int, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * RX Overrun -&gt; Count and reset if needed</span>
<span class="cm">		 *</span>
<span class="cm">		 * Receive buffers are full. Either the bus is busy or</span>
<span class="cm">		 * the CPU is not fast enough to process all received</span>
<span class="cm">		 * frames.</span>
<span class="cm">		 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AR5K_INT_RXORN</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 * Older chipsets need a reset to come out of this</span>
<span class="cm">			 * condition, but we treat it as RX for newer chips.</span>
<span class="cm">			 * We don&#39;t know exactly which versions need a reset</span>
<span class="cm">			 * this guess is copied from the HAL.</span>
<span class="cm">			 */</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxorn_intr</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_srev</span> <span class="o">&lt;</span> <span class="n">AR5K_SREV_AR5212</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span>
					  <span class="s">&quot;rx overrun, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">ath5k_schedule_rx</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="cm">/* Software Beacon Alert -&gt; Schedule beacon tasklet */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AR5K_INT_SWBA</span><span class="p">)</span>
				<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">beacontq</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * No more RX descriptors -&gt; Just count</span>
<span class="cm">			 *</span>
<span class="cm">			 * NB: the hardware should re-read the link when</span>
<span class="cm">			 *     RXE bit is written, but it doesn&#39;t work at</span>
<span class="cm">			 *     least on older hardware revs.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AR5K_INT_RXEOL</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rxeol_intr</span><span class="o">++</span><span class="p">;</span>


			<span class="cm">/* TX Underrun -&gt; Bump tx trigger level */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AR5K_INT_TXURN</span><span class="p">)</span>
				<span class="n">ath5k_hw_update_tx_triglevel</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

			<span class="cm">/* RX -&gt; Schedule rx tasklet */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AR5K_INT_RXOK</span> <span class="o">|</span> <span class="n">AR5K_INT_RXERR</span><span class="p">))</span>
				<span class="n">ath5k_schedule_rx</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

			<span class="cm">/* TX -&gt; Schedule tx tasklet */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AR5K_INT_TXOK</span>
					<span class="o">|</span> <span class="n">AR5K_INT_TXDESC</span>
					<span class="o">|</span> <span class="n">AR5K_INT_TXERR</span>
					<span class="o">|</span> <span class="n">AR5K_INT_TXEOL</span><span class="p">))</span>
				<span class="n">ath5k_schedule_tx</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

			<span class="cm">/* Missed beacon -&gt; TODO</span>
<span class="cm">			if (status &amp; AR5K_INT_BMISS)</span>
<span class="cm">			*/</span>

			<span class="cm">/* MIB event -&gt; Update counters and notify ANI */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AR5K_INT_MIB</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">mib_intr</span><span class="o">++</span><span class="p">;</span>
				<span class="n">ath5k_hw_update_mib_counters</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
				<span class="n">ath5k_ani_mib_intr</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* GPIO -&gt; Notify RFKill layer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">AR5K_INT_GPIO</span><span class="p">)</span>
				<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rf_kill</span><span class="p">.</span><span class="n">toggleq</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_get_bus_type</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">==</span> <span class="n">ATH_AHB</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ath5k_hw_is_intr_pending</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Until we handle rx/tx interrupts mask them on IMR</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: ah-&gt;(rx/tx)_pending are set when scheduling the tasklets</span>
<span class="cm">	 * and unset after we &#39;ve handled the interrupts.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">||</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">)</span>
		<span class="n">ath5k_set_current_imask</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">counter</span><span class="p">))</span>
		<span class="n">ATH5K_WARN</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;too many interrupts, giving up for now</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Fire up calibration poll */</span>
	<span class="n">ath5k_intr_calibration_poll</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Periodically recalibrate the PHY to account</span>
<span class="cm"> * for temperature/environment changes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_calibrate_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_hw</span><span class="p">,</span>
		<span class="n">calib_work</span><span class="p">);</span>

	<span class="cm">/* Should we run a full calibration ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_is_before_eq_jiffies</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_next_full</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_next_full</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH5K_TUNE_CALIBRATION_INTERVAL_FULL</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">|=</span> <span class="n">AR5K_CALIBRATION_FULL</span><span class="p">;</span>

		<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_CALIBRATE</span><span class="p">,</span>
				<span class="s">&quot;running full calibration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_hw_gainf_calibrate</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">==</span> <span class="n">AR5K_RFGAIN_NEED_CHANGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Rfgain is out of bounds, reset the chip</span>
<span class="cm">			 * to load new gain values.</span>
<span class="cm">			 */</span>
			<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span>
					<span class="s">&quot;got new rfgain, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">|=</span> <span class="n">AR5K_CALIBRATION_SHORT</span><span class="p">;</span>


	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_CALIBRATE</span><span class="p">,</span> <span class="s">&quot;channel %u/%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">),</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath5k_hw_phy_calibrate</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">))</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;calibration of channel %u failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">));</span>

	<span class="cm">/* Clear calibration flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">&amp;</span> <span class="n">AR5K_CALIBRATION_FULL</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR5K_CALIBRATION_FULL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">&amp;</span> <span class="n">AR5K_CALIBRATION_SHORT</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR5K_CALIBRATION_SHORT</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_tasklet_ani</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">|=</span> <span class="n">AR5K_CALIBRATION_ANI</span><span class="p">;</span>
	<span class="n">ath5k_ani_calibration</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR5K_CALIBRATION_ANI</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ath5k_tx_complete_poll_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_hw</span><span class="p">,</span>
			<span class="n">tx_complete_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath5k_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">needreset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setup</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_poll_mark</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_XMIT</span><span class="p">,</span>
						  <span class="s">&quot;TX queue stuck %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">txq</span><span class="o">-&gt;</span><span class="n">qnum</span><span class="p">);</span>
					<span class="n">needreset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_stuck</span><span class="o">++</span><span class="p">;</span>
					<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_poll_mark</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">needreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span>
			  <span class="s">&quot;TX queues stuck, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ath5k_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_complete_work</span><span class="p">,</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH5K_TX_COMPLETE_POLL_INT</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/*************************\</span>
<span class="cm">* Initialization routines *</span>
<span class="cm">\*************************/</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_iface_limit</span> <span class="n">if_limits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>	<span class="p">.</span><span class="n">types</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>	<span class="p">.</span><span class="n">types</span> <span class="o">=</span>
<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
				 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#endif</span>
				 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_iface_combination</span> <span class="n">if_comb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">limits</span> <span class="o">=</span> <span class="n">if_limits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_limits</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">if_limits</span><span class="p">),</span>
	<span class="p">.</span><span class="n">max_interfaces</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_different_channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">ath5k_init_ah</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_bus_ops</span> <span class="o">*</span><span class="n">bus_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">csz</span><span class="p">;</span>

	<span class="cm">/* Initialize driver private data */</span>
	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_RX_INCLUDES_FCS</span> <span class="o">|</span>
			<span class="n">IEEE80211_HW_HOST_BROADCAST_PS_BUFFERING</span> <span class="o">|</span>
			<span class="n">IEEE80211_HW_SIGNAL_DBM</span> <span class="o">|</span>
			<span class="n">IEEE80211_HW_REPORTS_TX_ACK_STATUS</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">iface_combinations</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">if_comb</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_iface_combinations</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* SW support for IBSS_RSN is provided by mac80211 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_IBSS_RSN</span><span class="p">;</span>

	<span class="cm">/* both antennas can be configured as RX or TX */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">available_antennas_tx</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">available_antennas_rx</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_change_time</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mark the device as detached to avoid processing</span>
<span class="cm">	 * interrupts until setup is complete.</span>
<span class="cm">	 */</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">ATH_STAT_INVALID</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bintval</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxbuflock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txbuflock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">block</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">);</span>

	<span class="cm">/* Setup interrupt handler */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ath5k_intr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;ath&quot;</span><span class="p">,</span> <span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;request_irq failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath5k_common_ops</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span> <span class="o">=</span> <span class="n">bus_ops</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ah</span> <span class="o">=</span> <span class="n">ah</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">ah</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">clockrate</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cache line size is used to size and align various</span>
<span class="cm">	 * structures used to communicate with the hardware.</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_read_cachesize</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csz</span><span class="p">);</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cachelsz</span> <span class="o">=</span> <span class="n">csz</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* convert to bytes */</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

	<span class="cm">/* Initialize device */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_init</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_irq</span><span class="p">;</span>

	<span class="cm">/* Set up multi-rate retry capabilities */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_has_mrr_support</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rate_tries</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">AR5K_INIT_RETRY_SHORT</span><span class="p">,</span>
					 <span class="n">AR5K_INIT_RETRY_LONG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vif_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_vif</span><span class="p">);</span>

	<span class="cm">/* Finish private driver data initialization */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_ah</span><span class="p">;</span>

	<span class="n">ATH5K_INFO</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;Atheros AR%s chip found (MAC: 0x%x, PHY: 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ath5k_chip_name</span><span class="p">(</span><span class="n">AR5K_VERSION_MAC</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_srev</span><span class="p">),</span>
					<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_srev</span><span class="p">,</span>
					<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_phy_revision</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_single_chip</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Single chip radio (!RF5111) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_5ghz_revision</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_2ghz_revision</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No 5GHz support -&gt; report 2GHz radio */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AR5K_MODE_11A</span><span class="p">,</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_mode</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ATH5K_INFO</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;RF%s 2GHz radio found (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ath5k_chip_name</span><span class="p">(</span><span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>
						<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_5ghz_revision</span><span class="p">),</span>
						<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_5ghz_revision</span><span class="p">);</span>
			<span class="cm">/* No 2GHz support (5110 and some</span>
<span class="cm">			 * 5GHz only cards) -&gt; report 5GHz radio */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">AR5K_MODE_11B</span><span class="p">,</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_mode</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ATH5K_INFO</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;RF%s 5GHz radio found (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ath5k_chip_name</span><span class="p">(</span><span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>
						<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_5ghz_revision</span><span class="p">),</span>
						<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_5ghz_revision</span><span class="p">);</span>
			<span class="cm">/* Multiband radio */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ATH5K_INFO</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;RF%s multiband radio found&quot;</span>
					<span class="s">&quot; (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ath5k_chip_name</span><span class="p">(</span><span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>
						<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_5ghz_revision</span><span class="p">),</span>
						<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_5ghz_revision</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Multi chip radio (RF5111 - RF2111) -&gt;</span>
<span class="cm">		 * report both 2GHz/5GHz radios */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_5ghz_revision</span> <span class="o">&amp;&amp;</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_2ghz_revision</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ATH5K_INFO</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;RF%s 5GHz radio found (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ath5k_chip_name</span><span class="p">(</span><span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>
					<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_5ghz_revision</span><span class="p">),</span>
					<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_5ghz_revision</span><span class="p">);</span>
			<span class="n">ATH5K_INFO</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;RF%s 2GHz radio found (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ath5k_chip_name</span><span class="p">(</span><span class="n">AR5K_VERSION_RAD</span><span class="p">,</span>
					<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_2ghz_revision</span><span class="p">),</span>
					<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_radio_2ghz_revision</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ath5k_debug_init_device</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/* ready to process interrupts */</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">ATH_STAT_INVALID</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_ah:</span>
	<span class="n">ath5k_hw_deinit</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="nl">err_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ah</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_stop_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span> <span class="s">&quot;invalid %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">ATH_STAT_INVALID</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Shutdown the hardware and driver:</span>
<span class="cm">	 *    stop output from above</span>
<span class="cm">	 *    disable interrupts</span>
<span class="cm">	 *    turn off timers</span>
<span class="cm">	 *    turn off the radio</span>
<span class="cm">	 *    clear transmit machinery</span>
<span class="cm">	 *    clear receive machinery</span>
<span class="cm">	 *    drain and release tx queues</span>
<span class="cm">	 *    reclaim beacon resources</span>
<span class="cm">	 *    power down hardware</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note that some of this work is not possible if the</span>
<span class="cm">	 * hardware is gone (invalid).</span>
<span class="cm">	 */</span>
	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATH_STAT_INVALID</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath5k_led_off</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">ath5k_hw_set_imr</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">ath5k_rx_stop</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">ath5k_hw_dma_stop</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">ath5k_drain_tx_buffs</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">ath5k_hw_phy_disable</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath5k_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span> <span class="s">&quot;mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop anything previously setup.  This is safe</span>
<span class="cm">	 * no matter this is the first time through or not.</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_stop_locked</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The basic interface to setting the hardware in a good</span>
<span class="cm">	 * state is ``reset&#39;&#39;.  On return the hardware is known to</span>
<span class="cm">	 * be powered up and with interrupts disabled.  This must</span>
<span class="cm">	 * be followed by initialization of the appropriate bits</span>
<span class="cm">	 * and then setup of the interrupt mask.</span>
<span class="cm">	 */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">AR5K_INT_RXOK</span>
		<span class="o">|</span> <span class="n">AR5K_INT_RXERR</span>
		<span class="o">|</span> <span class="n">AR5K_INT_RXEOL</span>
		<span class="o">|</span> <span class="n">AR5K_INT_RXORN</span>
		<span class="o">|</span> <span class="n">AR5K_INT_TXDESC</span>
		<span class="o">|</span> <span class="n">AR5K_INT_TXEOL</span>
		<span class="o">|</span> <span class="n">AR5K_INT_FATAL</span>
		<span class="o">|</span> <span class="n">AR5K_INT_GLOBAL</span>
		<span class="o">|</span> <span class="n">AR5K_INT_MIB</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath5k_modparam_no_hw_rfkill_switch</span><span class="p">)</span>
		<span class="n">ath5k_rfkill_hw_start</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset the key cache since some parts do not reset the</span>
<span class="cm">	 * contents on initial power up or resume from suspend.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">keymax</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ath_hw_keyreset</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Use higher rates for acks instead of base</span>
<span class="cm">	 * rate */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ack_bitrate_high</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bslot</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bslot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_complete_work</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH5K_TX_COMPLETE_POLL_INT</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath5k_stop_tasklets</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rx_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxtq</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txtq</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">beacontq</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop the device, grabbing the top-level lock to protect</span>
<span class="cm"> * against concurrent entry through ath5k_init (which can happen</span>
<span class="cm"> * if another thread does a system call and the thread doing the</span>
<span class="cm"> * stop is preempted).</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ath5k_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_stop_locked</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATH_STAT_INVALID</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Don&#39;t set the card in full sleep mode!</span>
<span class="cm">		 *</span>
<span class="cm">		 * a) When the device is in this state it must be carefully</span>
<span class="cm">		 * woken up or references to registers in the PCI clock</span>
<span class="cm">		 * domain may freeze the bus (and system).  This varies</span>
<span class="cm">		 * by chip and is mostly an issue with newer parts</span>
<span class="cm">		 * (madwifi sources mentioned srev &gt;= 0x78) that go to</span>
<span class="cm">		 * sleep more quickly.</span>
<span class="cm">		 *</span>
<span class="cm">		 * b) On older chips full sleep results a weird behaviour</span>
<span class="cm">		 * during wakeup. I tested various cards with srev &lt; 0x78</span>
<span class="cm">		 * and they don&#39;t wake up after module reload, a second</span>
<span class="cm">		 * module reload is needed to bring the card up again.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Until we figure out what&#39;s going on don&#39;t enable</span>
<span class="cm">		 * full chip reset on any chip (this is what Legacy HAL</span>
<span class="cm">		 * and Sam&#39;s HAL do anyway). Instead Perform a full reset</span>
<span class="cm">		 * on the device (same as initial state after attach) and</span>
<span class="cm">		 * leave it idle (keep MAC/BB on warm reset) */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_on_hold</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

		<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span>
				<span class="s">&quot;putting device to sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ath5k_stop_tasklets</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_complete_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath5k_modparam_no_hw_rfkill_switch</span><span class="p">)</span>
		<span class="n">ath5k_rfkill_hw_stop</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reset the hardware.  If chan is not NULL, then also pause rx/tx</span>
<span class="cm"> * and change to the given channel.</span>
<span class="cm"> *</span>
<span class="cm"> * This should be called with ah-&gt;lock.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
							<span class="n">bool</span> <span class="n">skip_pcu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ani_mode</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fast</span><span class="p">;</span>

	<span class="n">ATH5K_DBG</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_DEBUG_RESET</span><span class="p">,</span> <span class="s">&quot;resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ath5k_hw_set_imr</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">ath5k_stop_tasklets</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/* Save ani mode and disable ANI during</span>
<span class="cm">	 * reset. If we don&#39;t we might get false</span>
<span class="cm">	 * PHY error interrupts. */</span>
	<span class="n">ani_mode</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_state</span><span class="p">.</span><span class="n">ani_mode</span><span class="p">;</span>
	<span class="n">ath5k_ani_init</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH5K_ANI_MODE_OFF</span><span class="p">);</span>

	<span class="cm">/* We are going to empty hw queues</span>
<span class="cm">	 * so we should also free any remaining</span>
<span class="cm">	 * tx buffers */</span>
	<span class="n">ath5k_drain_tx_buffs</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>

	<span class="n">fast</span> <span class="o">=</span> <span class="p">((</span><span class="n">chan</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">modparam_fastchanswitch</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">,</span> <span class="n">fast</span><span class="p">,</span> <span class="n">skip_pcu</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t reset hardware (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_rx_start</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t start recv logic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath5k_ani_init</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ani_mode</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set calibration intervals</span>
<span class="cm">	 *</span>
<span class="cm">	 * Note: We don&#39;t need to run calibration imediately</span>
<span class="cm">	 * since some initial calibration is done on reset</span>
<span class="cm">	 * even for fast channel switching. Also on scanning</span>
<span class="cm">	 * this will get set again and again and it won&#39;t get</span>
<span class="cm">	 * executed unless we connect somewhere and spend some</span>
<span class="cm">	 * time on the channel (that&#39;s what calibration needs</span>
<span class="cm">	 * anyway to be accurate).</span>
<span class="cm">	 */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_next_full</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH5K_TUNE_CALIBRATION_INTERVAL_FULL</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_next_ani</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH5K_TUNE_CALIBRATION_INTERVAL_ANI</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_cal_next_short</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
		<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH5K_TUNE_CALIBRATION_INTERVAL_SHORT</span><span class="p">);</span>

	<span class="n">ewma_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_beacon_rssi_avg</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* clear survey data and cycle counters */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">));</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
	<span class="n">ath_hw_cycle_counters_update</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_survey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_survey</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_ani</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_ani</span><span class="p">));</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Change channels and update the h/w rate map if we&#39;re switching;</span>
<span class="cm">	 * e.g. 11a to 11b/g.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We may be doing a reset in response to an ioctl that changes the</span>
<span class="cm">	 * channel so update any state that might change as a result.</span>
<span class="cm">	 *</span>
<span class="cm">	 * XXX needed?</span>
<span class="cm">	 */</span>
<span class="cm">/*	ath5k_chan_change(ah, c); */</span>

	<span class="n">ath5k_beacon_config</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="cm">/* intrs are enabled by ath5k_beacon_config */</span>

	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath5k_reset_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath5k_hw</span><span class="p">,</span>
		<span class="n">reset_work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ath5k_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">ath5k_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_regulatory</span> <span class="o">*</span><span class="n">regulatory</span> <span class="o">=</span> <span class="n">ath5k_hw_regulatory</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath5k_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * Collect the channel list.  The 802.11 layer</span>
<span class="cm">	 * is responsible for filtering this list based</span>
<span class="cm">	 * on settings like the phy mode and regulatory</span>
<span class="cm">	 * domain restrictions.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_setup_bands</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t get channels</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate tx+rx descriptors and populate the lists.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_desc_alloc</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate descriptors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Allocate hardware transmit queues: one queue for</span>
<span class="cm">	 * beacon frames and one data queue for each QoS</span>
<span class="cm">	 * priority.  Note that hw functions handle resetting</span>
<span class="cm">	 * these queues at the needed time.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_beaconq_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t setup a beacon xmit queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_desc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">cabq</span> <span class="o">=</span> <span class="n">ath5k_txq_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TX_QUEUE_CAB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">cabq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t setup cab queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">cabq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_bhal</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 5211 and 5212 usually support 10 queues but we better rely on the</span>
<span class="cm">	 * capability information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_queues</span><span class="p">.</span><span class="n">q_tx_num</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This order matches mac80211&#39;s queue priority, so we can</span>
<span class="cm">		* directly use the mac80211 queue number without any mapping */</span>
		<span class="n">txq</span> <span class="o">=</span> <span class="n">ath5k_txq_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TX_QUEUE_DATA</span><span class="p">,</span> <span class="n">AR5K_WME_AC_VO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t setup xmit queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_queues</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">txq</span> <span class="o">=</span> <span class="n">ath5k_txq_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TX_QUEUE_DATA</span><span class="p">,</span> <span class="n">AR5K_WME_AC_VI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t setup xmit queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_queues</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">txq</span> <span class="o">=</span> <span class="n">ath5k_txq_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TX_QUEUE_DATA</span><span class="p">,</span> <span class="n">AR5K_WME_AC_BE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t setup xmit queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_queues</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">txq</span> <span class="o">=</span> <span class="n">ath5k_txq_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TX_QUEUE_DATA</span><span class="p">,</span> <span class="n">AR5K_WME_AC_BK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t setup xmit queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_queues</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* older hardware (5210) can only support one data queue */</span>
		<span class="n">txq</span> <span class="o">=</span> <span class="n">ath5k_txq_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5K_TX_QUEUE_DATA</span><span class="p">,</span> <span class="n">AR5K_WME_AC_BE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t setup xmit queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">txq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_queues</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxtq</span><span class="p">,</span> <span class="n">ath5k_tasklet_rx</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txtq</span><span class="p">,</span> <span class="n">ath5k_tasklet_tx</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">beacontq</span><span class="p">,</span> <span class="n">ath5k_tasklet_beacon</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_tasklet</span><span class="p">,</span> <span class="n">ath5k_tasklet_ani</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">reset_work</span><span class="p">,</span> <span class="n">ath5k_reset_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">calib_work</span><span class="p">,</span> <span class="n">ath5k_calibrate_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_complete_work</span><span class="p">,</span> <span class="n">ath5k_tx_complete_poll_work</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="o">-&gt;</span><span class="n">eeprom_read_mac</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;unable to read address from EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_queues</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="cm">/* All MAC address bits matter for ACKs */</span>
	<span class="n">ath5k_update_bssid_mask_and_opmode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">regulatory</span><span class="o">-&gt;</span><span class="n">current_rd</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">.</span><span class="n">ee_regdomain</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath_regd_init</span><span class="p">(</span><span class="n">regulatory</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">ath5k_reg_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t initialize regulatory system</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_queues</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;can&#39;t register ieee80211 hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_queues</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_is_world_regd</span><span class="p">(</span><span class="n">regulatory</span><span class="p">))</span>
		<span class="n">regulatory_hint</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">regulatory</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">);</span>

	<span class="n">ath5k_init_leds</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ath5k_sysfs_register</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_queues:</span>
	<span class="n">ath5k_txq_release</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="nl">err_bhal:</span>
	<span class="n">ath5k_hw_release_tx_queue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">);</span>
<span class="nl">err_desc:</span>
	<span class="n">ath5k_desc_free</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ath5k_deinit_ah</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * NB: the order of these is important:</span>
<span class="cm">	 * o call the 802.11 layer before detaching ath5k_hw to</span>
<span class="cm">	 *   ensure callbacks into the driver to delete global</span>
<span class="cm">	 *   key cache entries can be handled</span>
<span class="cm">	 * o reclaim the tx queue data structures after calling</span>
<span class="cm">	 *   the 802.11 layer as we&#39;ll get called back to reclaim</span>
<span class="cm">	 *   node state and potentially want to use them</span>
<span class="cm">	 * o to cleanup the tx queues the hal is called, so detach</span>
<span class="cm">	 *   it last</span>
<span class="cm">	 * XXX: ??? detach ath5k_hw ???</span>
<span class="cm">	 * Other than that, it&#39;s straightforward...</span>
<span class="cm">	 */</span>
	<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">ath5k_desc_free</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath5k_txq_release</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath5k_hw_release_tx_queue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bhalq</span><span class="p">);</span>
	<span class="n">ath5k_unregister_leds</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ath5k_sysfs_unregister</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * NB: can&#39;t reclaim these until after ieee80211_ifdetach</span>
<span class="cm">	 * returns because we&#39;ll get called back to reclaim node</span>
<span class="cm">	 * state and potentially want to use them.</span>
<span class="cm">	 */</span>
	<span class="n">ath5k_hw_deinit</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span>
<span class="nf">ath5k_any_vif_assoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_vif_iter_data</span> <span class="n">iter_data</span><span class="p">;</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">hw_macaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">any_assoc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">need_set_hw_addr</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">found_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ath5k_vif_iter</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">iter_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">iter_data</span><span class="p">.</span><span class="n">any_assoc</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ath5k_set_beacon_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rfilt</span><span class="p">;</span>
	<span class="n">rfilt</span> <span class="o">=</span> <span class="n">ath5k_hw_get_rx_filter</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">AR5K_RX_FILTER_BEACON</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rfilt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR5K_RX_FILTER_BEACON</span><span class="p">;</span>
	<span class="n">ath5k_hw_set_rx_filter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">rfilt</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="n">rfilt</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">_ath5k_printk</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">level</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="n">pr_fmt</span><span class="p">(</span><span class="s">&quot;%s: %pV&quot;</span><span class="p">),</span>
		       <span class="n">level</span><span class="p">,</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s&quot;</span> <span class="n">pr_fmt</span><span class="p">(</span><span class="s">&quot;%pV&quot;</span><span class="p">),</span> <span class="n">level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
