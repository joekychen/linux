<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath5k › eeprom.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>eeprom.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004-2008 Reyk Floeter &lt;reyk@openbsd.org&gt;</span>
<span class="cm"> * Copyright (c) 2006-2009 Nick Kossifidis &lt;mickflemm@gmail.com&gt;</span>
<span class="cm"> * Copyright (c) 2008-2009 Felix Fietkau &lt;nbd@openwrt.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*************************************\</span>
<span class="cm">* EEPROM access functions and helpers *</span>
<span class="cm">\*************************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;ath5k.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>


<span class="cm">/******************\</span>
<span class="cm">* Helper functions *</span>
<span class="cm">\******************/</span>

<span class="cm">/*</span>
<span class="cm"> * Translate binary channel representation in EEPROM to frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bin</span><span class="p">,</span>
							<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bin</span> <span class="o">==</span> <span class="n">AR5K_EEPROM_CHANNEL_DIS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bin</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&gt;</span> <span class="n">AR5K_EEPROM_VERSION_3_2</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">bin</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4800</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">bin</span> <span class="o">&gt;</span> <span class="mi">62</span> <span class="o">?</span> <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="mi">62</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">bin</span> <span class="o">-</span> <span class="mi">62</span><span class="p">))</span> <span class="o">+</span> <span class="mi">5100</span> <span class="o">:</span>
				<span class="p">(</span><span class="n">bin</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&gt;</span> <span class="n">AR5K_EEPROM_VERSION_3_2</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">bin</span> <span class="o">+</span> <span class="mi">2300</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">bin</span> <span class="o">+</span> <span class="mi">2400</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*********\</span>
<span class="cm">* Parsers *</span>
<span class="cm">\*********/</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize eeprom &amp; capabilities structs</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_init_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cksum</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">eep_max</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_INFO_MAX</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read values from EEPROM and store them in the capability structure</span>
<span class="cm">	 */</span>
	<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_MAGIC</span><span class="p">,</span> <span class="n">ee_magic</span><span class="p">);</span>
	<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_PROTECT</span><span class="p">,</span> <span class="n">ee_protect</span><span class="p">);</span>
	<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_REG_DOMAIN</span><span class="p">,</span> <span class="n">ee_regdomain</span><span class="p">);</span>
	<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_VERSION</span><span class="p">,</span> <span class="n">ee_version</span><span class="p">);</span>
	<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_HDR</span><span class="p">,</span> <span class="n">ee_header</span><span class="p">);</span>

	<span class="cm">/* Return if we have an old EEPROM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_VERSION_3_0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Validate the checksum of the EEPROM date. There are some</span>
<span class="cm">	 * devices with invalid EEPROMs.</span>
<span class="cm">	 */</span>
	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">AR5K_EEPROM_SIZE_UPPER</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eep_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_SIZE_UPPER_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			   <span class="n">AR5K_EEPROM_SIZE_ENDLOC_SHIFT</span><span class="p">;</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">AR5K_EEPROM_SIZE_LOWER</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">eep_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">eep_max</span> <span class="o">|</span> <span class="n">val</span><span class="p">)</span> <span class="o">-</span> <span class="n">AR5K_EEPROM_INFO_BASE</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Fail safe check to prevent stupid loops due</span>
<span class="cm">		 * to busted EEPROMs. XXX: This value is likely too</span>
<span class="cm">		 * big still, waiting on a better value.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eep_max</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">AR5K_EEPROM_INFO_MAX</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;Invalid max custom EEPROM size: &quot;</span>
				  <span class="s">&quot;%d (0x%04x) max expected: %d (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">eep_max</span><span class="p">,</span> <span class="n">eep_max</span><span class="p">,</span>
				  <span class="mi">3</span> <span class="o">*</span> <span class="n">AR5K_EEPROM_INFO_MAX</span><span class="p">,</span>
				  <span class="mi">3</span> <span class="o">*</span> <span class="n">AR5K_EEPROM_INFO_MAX</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">eep_max</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">AR5K_EEPROM_INFO</span><span class="p">(</span><span class="n">offset</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">cksum</span> <span class="o">^=</span> <span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cksum</span> <span class="o">!=</span> <span class="n">AR5K_EEPROM_INFO_CKSUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ATH5K_ERR</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="s">&quot;Invalid EEPROM &quot;</span>
			  <span class="s">&quot;checksum: 0x%04x eep_max: 0x%04x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">cksum</span><span class="p">,</span> <span class="n">eep_max</span><span class="p">,</span>
			  <span class="n">eep_max</span> <span class="o">==</span> <span class="n">AR5K_EEPROM_INFO_MAX</span> <span class="o">?</span>
				<span class="s">&quot;default size&quot;</span> <span class="o">:</span> <span class="s">&quot;custom size&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_ANT_GAIN</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span><span class="p">),</span>
	    <span class="n">ee_ant_gain</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_MISC0</span><span class="p">,</span> <span class="n">ee_misc0</span><span class="p">);</span>
		<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_MISC1</span><span class="p">,</span> <span class="n">ee_misc1</span><span class="p">);</span>

		<span class="cm">/* XXX: Don&#39;t know which versions include these two */</span>
		<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_MISC2</span><span class="p">,</span> <span class="n">ee_misc2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_3</span><span class="p">)</span>
			<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_MISC3</span><span class="p">,</span> <span class="n">ee_misc3</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_5_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_MISC4</span><span class="p">,</span> <span class="n">ee_misc4</span><span class="p">);</span>
			<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_MISC5</span><span class="p">,</span> <span class="n">ee_misc5</span><span class="p">);</span>
			<span class="n">AR5K_EEPROM_READ_HDR</span><span class="p">(</span><span class="n">AR5K_EEPROM_MISC6</span><span class="p">,</span> <span class="n">ee_misc6</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_VERSION_3_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">AR5K_EEPROM_OBDB0_2GHZ</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ob</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11B</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_db</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11B</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">AR5K_EEPROM_OBDB1_2GHZ</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ob</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11G</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_db</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11G</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">AR5K_EEPROM_IS_HB63</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mac_version</span> <span class="o">==</span> <span class="p">(</span><span class="n">AR5K_SREV_AR2425</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="p">)</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_is_hb63</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_is_hb63</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">AR5K_EEPROM_RFKILL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_rfkill_pin</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">AR5K_REG_MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR5K_EEPROM_RFKILL_GPIO_SEL</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_rfkill_pol</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_RFKILL_POLARITY</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Check if PCIE_OFFSET points to PCIE_SERDES_SECTION</span>
<span class="cm">	 * and enable serdes programming if needed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * XXX: Serdes values seem to be fixed so</span>
<span class="cm">	 * no need to read them here, we write them</span>
<span class="cm">	 * during ath5k_hw_init */</span>
	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">AR5K_EEPROM_PCIE_OFFSET</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_serdes</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">AR5K_EEPROM_PCIE_SERDES_SECTION</span><span class="p">)</span> <span class="o">?</span>
							<span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read antenna infos from eeprom</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath5k_eeprom_read_ants</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">o</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_switch_settling</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_atn_tx_rx</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="o">++</span><span class="p">]</span>	<span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="o">++</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="o">++</span><span class="p">]</span>	<span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="o">++</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="o">++</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="o">++</span><span class="p">]</span>	<span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="o">++</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="o">++</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="o">++</span><span class="p">]</span>	<span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="o">++</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">i</span><span class="o">++</span><span class="p">]</span>	<span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="cm">/* Get antenna switch tables */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ant_ctl</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">AR5K_ANT_CTL</span><span class="p">]</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ant_ctl</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">AR5K_ANT_SWTABLE_A</span><span class="p">]</span> <span class="o">=</span>
	     <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>	<span class="o">|</span>
	    <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span>	<span class="o">|</span>
	    <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ant_ctl</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">AR5K_ANT_SWTABLE_B</span><span class="p">]</span> <span class="o">=</span>
	     <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">6</span><span class="p">]</span>	<span class="o">|</span>
	    <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span>	<span class="o">|</span>
	    <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ant_control</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="cm">/* return new offset */</span>
	<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">o</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read supported modes and some mode-specific calibration data</span>
<span class="cm"> * from eeprom</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath5k_eeprom_read_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">o</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_adc_desired_size</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11A</span>:
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ob</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_db</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ob</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ob</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>	<span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_db</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ob</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_db</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ob</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_db</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11G</span>:
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11B</span>:
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ob</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_db</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_tx_end2xlna_enable</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_thr_62</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>		<span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&lt;=</span> <span class="n">AR5K_EEPROM_VERSION_3_2</span><span class="p">)</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_thr_62</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">AR5K_EEPROM_MODE_11A</span> <span class="o">?</span> <span class="mi">15</span> <span class="o">:</span> <span class="mi">28</span><span class="p">;</span>

	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_tx_end2xpa_disable</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_tx_frm2xpa_enable</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>	<span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pga_desired_size</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>	<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_noise_floor_thr</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0xff</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_noise_floor_thr</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&lt;=</span> <span class="n">AR5K_EEPROM_VERSION_3_2</span><span class="p">)</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_noise_floor_thr</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">mode</span> <span class="o">==</span> <span class="n">AR5K_EEPROM_MODE_11A</span> <span class="o">?</span> <span class="o">-</span><span class="mi">54</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_xlna_gain</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_x_gain</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>		<span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_xpd</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>		<span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mode</span> <span class="o">!=</span> <span class="n">AR5K_EEPROM_MODE_11B</span><span class="p">)</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_fixed_bias</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_3_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_false_detect</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">)</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_xr_power</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* b_DB_11[bg] and b_OB_11[bg] */</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ob</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_db</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_VERSION_3_4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_i_gain</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_I_GAIN</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_cck_ofdm_power_delta</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_CCK_OFDM_DELTA</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_i_gain</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_i_gain</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x38</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">AR5K_EEPROM_MODE_11G</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_cck_ofdm_power_delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_6</span><span class="p">)</span>
				<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_scaled_cck_delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_0</span> <span class="o">&amp;&amp;</span>
			<span class="n">mode</span> <span class="o">==</span> <span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_i_cal</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_q_cal</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_VERSION_4_0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Note: &gt;= v5 have bg freq piers on another location</span>
<span class="cm">	 * so these freq piers are ignored for &gt;= v5 (should be 0xff</span>
<span class="cm">	 * anyway) */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11A</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_VERSION_4_1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_margin_tx_rx</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11B</span>:
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_b</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span>
			<span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_b</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">freq</span> <span class="o">!=</span> <span class="n">AR5K_EEPROM_CHANNEL_DIS</span><span class="p">)</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_b</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span>
			<span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_b</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">freq</span> <span class="o">!=</span> <span class="n">AR5K_EEPROM_CHANNEL_DIS</span><span class="p">)</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_b</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span>
			<span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_b</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">freq</span> <span class="o">!=</span> <span class="n">AR5K_EEPROM_CHANNEL_DIS</span><span class="p">)</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_1</span><span class="p">)</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_margin_tx_rx</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11G</span>:
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_g</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span>
			<span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_g</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">freq</span> <span class="o">!=</span> <span class="n">AR5K_EEPROM_CHANNEL_DIS</span><span class="p">)</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_g</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span>
			<span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_g</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">freq</span> <span class="o">!=</span> <span class="n">AR5K_EEPROM_CHANNEL_DIS</span><span class="p">)</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_turbo_max_power</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_xr_power</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_g</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span>
			<span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_g</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">freq</span> <span class="o">!=</span> <span class="n">AR5K_EEPROM_CHANNEL_DIS</span><span class="p">)</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_1</span><span class="p">)</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_margin_tx_rx</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_i_cal</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_q_cal</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_cck_ofdm_gain_delta</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read turbo mode information on newer EEPROM versions</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_VERSION_5_0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11A</span>:
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_switch_settling_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_atn_tx_rx_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_atn_tx_rx_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_margin_tx_rx_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_adc_desired_size_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_adc_desired_size_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pga_desired_size_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">AR5K_EEPROM_EEMAP</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_misc0</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pd_gain_overlap</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11G</span>:
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_switch_settling_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_atn_tx_rx_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_atn_tx_rx_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_margin_tx_rx_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_adc_desired_size_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_adc_desired_size_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pga_desired_size_turbo</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="cm">/* return new offset */</span>
	<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">o</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read mode-specific data (except power calibration data) */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_init_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mode_offset</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get values for all modes</span>
<span class="cm">	 */</span>
	<span class="n">mode_offset</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_MODES_11A</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span><span class="p">);</span>
	<span class="n">mode_offset</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11B</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_MODES_11B</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span><span class="p">);</span>
	<span class="n">mode_offset</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11G</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_MODES_11G</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span><span class="p">);</span>

	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_turbo_max_power</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">AR5K_EEPROM_HDR_T_5GHZ_DBM</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">;</span> <span class="n">mode</span> <span class="o">&lt;=</span> <span class="n">AR5K_EEPROM_MODE_11G</span><span class="p">;</span> <span class="n">mode</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">mode_offset</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_eeprom_read_ants</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_eeprom_read_modes</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* override for older eeprom versions for better performance */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&lt;=</span> <span class="n">AR5K_EEPROM_VERSION_3_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_thr_62</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_thr_62</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11B</span><span class="p">]</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_thr_62</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11G</span><span class="p">]</span> <span class="o">=</span> <span class="mi">28</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read the frequency piers for each mode (mostly used on newer eeproms with 0xff</span>
<span class="cm"> * frequency mask) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_read_freq_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info</span> <span class="o">*</span><span class="n">pc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">o</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">freq1</span><span class="p">,</span> <span class="n">freq2</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">o</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">freq1</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freq1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">pc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span>
				<span class="n">freq1</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="n">freq2</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freq2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">pc</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span>
				<span class="n">freq2</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* return new offset */</span>
	<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">o</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read frequency piers for 802.11a */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_init_11a_pcal_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info</span> <span class="o">*</span><span class="n">pcal</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_a</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_3_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath5k_eeprom_read_freq_list</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span>
			<span class="n">AR5K_EEPROM_N_5GHZ_CHAN</span><span class="p">,</span> <span class="n">pcal</span><span class="p">,</span>
			<span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_FREQ_M</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span><span class="p">);</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">freq</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">freq</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">freq</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">freq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">freq</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">freq</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">freq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">freq</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">freq</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">freq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">freq</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">freq</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">freq</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">freq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

		<span class="cm">/* Fixed number of piers */</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_N_5GHZ_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcal</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span>
				<span class="n">pcal</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span><span class="p">,</span> <span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read frequency piers for 802.11bg on eeprom versions &gt;= 5 and eemap &gt;= 2 */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_init_11bg_2413</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info</span> <span class="o">*</span><span class="n">pcal</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11B</span>:
		<span class="n">pcal</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_b</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11G</span>:
		<span class="n">pcal</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_g</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath5k_eeprom_read_freq_list</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span>
		<span class="n">AR5K_EEPROM_N_2GHZ_CHAN_2413</span><span class="p">,</span> <span class="n">pcal</span><span class="p">,</span>
		<span class="n">mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read power calibration for RF5111 chips</span>
<span class="cm"> *</span>
<span class="cm"> * For RF5111 we have an XPD -eXternal Power Detector- curve</span>
<span class="cm"> * for each calibrated channel. Each curve has 0,5dB Power steps</span>
<span class="cm"> * on x axis and PCDAC steps (offsets) on y axis and looks like an</span>
<span class="cm"> * exponential function. To recreate the curve we read 11 points</span>
<span class="cm"> * here and interpolate later.</span>
<span class="cm"> */</span>

<span class="cm">/* Used to match PCDAC steps with power values on RF5111 chips</span>
<span class="cm"> * (eeprom versions &lt; 4). For RF5111 we have 11 pre-defined PCDAC</span>
<span class="cm"> * steps that match with the power values we read from eeprom. On</span>
<span class="cm"> * older eeprom versions (&lt; 3.2) these steps are equally spaced at</span>
<span class="cm"> * 10% of the pcdac curve -until the curve reaches its maximum-</span>
<span class="cm"> * (11 steps from 0 to 100%) but on newer eeprom versions (&gt;= 3.2)</span>
<span class="cm"> * these 11 steps are spaced in a different way. This function returns</span>
<span class="cm"> * the pcdac steps based on eeprom version and curve min/max so that we</span>
<span class="cm"> * can have pcdac/pwr points.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">ath5k_get_pcdac_intercepts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u8</span> <span class="n">min</span><span class="p">,</span> <span class="n">u8</span> <span class="n">max</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">intercepts3</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">100</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">intercepts3_2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span>
	<span class="p">};</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_3_2</span><span class="p">)</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="n">intercepts3_2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ip</span> <span class="o">=</span> <span class="n">intercepts3</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">intercepts3</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">max</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">ip</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_free_pcal_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info</span> <span class="o">*</span><span class="n">chinfo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pier</span><span class="p">,</span> <span class="n">pdg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11A</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR5K_EEPROM_HDR_11A</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chinfo</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_a</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11B</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR5K_EEPROM_HDR_11B</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chinfo</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_b</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11G</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR5K_EEPROM_HDR_11G</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chinfo</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_g</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pier</span> <span class="o">&lt;</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span> <span class="n">pier</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">pdg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pdg</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_N_PD_CURVES</span><span class="p">;</span> <span class="n">pdg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ath5k_pdgain_info</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span><span class="p">[</span><span class="n">pdg</span><span class="p">];</span>

			<span class="n">kfree</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert RF5111 specific data to generic raw data</span>
<span class="cm"> * used by interpolation code */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_convert_pcal_info_5111</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info</span> <span class="o">*</span><span class="n">chinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info_rf5111</span> <span class="o">*</span><span class="n">pcinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_pdgain_info</span> <span class="o">*</span><span class="n">pd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pier</span><span class="p">,</span> <span class="n">point</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pdgain_idx</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pdc_to_idx</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span>

	<span class="cm">/* Fill raw data for each calibration pier */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pier</span> <span class="o">&lt;</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span> <span class="n">pier</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pcinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">rf5111_info</span><span class="p">;</span>

		<span class="cm">/* Allocate pd_curves for this cal pier */</span>
		<span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span> <span class="o">=</span>
			<span class="n">kcalloc</span><span class="p">(</span><span class="n">AR5K_EEPROM_N_PD_CURVES</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_pdgain_info</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="cm">/* Only one curve for RF5111</span>
<span class="cm">		 * find out which one and place</span>
<span class="cm">		 * in pd_curves.</span>
<span class="cm">		 * Note: ee_x_gain is reversed here */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_N_PD_CURVES</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_x_gain</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pdgain_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pd_gains</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">pd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_N_PWR_POINTS_5111</span><span class="p">;</span>

		<span class="cm">/* Allocate pd points for this curve */</span>
		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">AR5K_EEPROM_N_PWR_POINTS_5111</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">AR5K_EEPROM_N_PWR_POINTS_5111</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">s16</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="cm">/* Fill raw dataset</span>
<span class="cm">		 * (convert power to 0.25dB units</span>
<span class="cm">		 * for RF5112 compatibility) */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">point</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">point</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span><span class="p">;</span> <span class="n">point</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Absolute values */</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="n">point</span><span class="p">];</span>

			<span class="cm">/* Already sorted */</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pcdac</span><span class="p">[</span><span class="n">point</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="cm">/* Set min/max pwr */</span>
		<span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">min_pwr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">max_pwr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">ath5k_eeprom_free_pcal_info</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Parse EEPROM data */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_read_pcal_info_5111</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info</span> <span class="o">*</span><span class="n">pcal</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_GROUPS_START</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11A</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR5K_EEPROM_HDR_11A</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath5k_eeprom_init_11a_pcal_freq</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			<span class="n">offset</span> <span class="o">+</span> <span class="n">AR5K_EEPROM_GROUP1_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_GROUP2_OFFSET</span><span class="p">;</span>
		<span class="n">pcal</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_a</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11B</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR5K_EEPROM_HDR_11B</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">AR5K_EEPROM_HDR_11G</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pcal</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_b</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_GROUP3_OFFSET</span><span class="p">;</span>

		<span class="cm">/* fixed piers */</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">2412</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">2447</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">2484</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11G</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR5K_EEPROM_HDR_11G</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pcal</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_g</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_GROUP4_OFFSET</span><span class="p">;</span>

		<span class="cm">/* fixed piers */</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">2312</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">2412</span><span class="p">;</span>
		<span class="n">pcal</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="mi">2484</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info_rf5111</span> <span class="o">*</span><span class="n">cdata</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">pcal</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rf5111_info</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pcdac_max</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_PCDAC_M</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pcdac_min</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_PCDAC_M</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">);</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">);</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span>  <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">);</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">);</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">);</span>
		<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">);</span>

		<span class="n">ath5k_get_pcdac_intercepts</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pcdac_min</span><span class="p">,</span>
			<span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pcdac_max</span><span class="p">,</span> <span class="n">cdata</span><span class="o">-&gt;</span><span class="n">pcdac</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ath5k_eeprom_convert_pcal_info_5111</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">pcal</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read power calibration for RF5112 chips</span>
<span class="cm"> *</span>
<span class="cm"> * For RF5112 we have 4 XPD -eXternal Power Detector- curves</span>
<span class="cm"> * for each calibrated channel on 0, -6, -12 and -18dBm but we only</span>
<span class="cm"> * use the higher (3) and the lower (0) curves. Each curve has 0.5dB</span>
<span class="cm"> * power steps on x axis and PCDAC steps on y axis and looks like a</span>
<span class="cm"> * linear function. To recreate the curve and pass the power values</span>
<span class="cm"> * on hw, we read 4 points for xpd 0 (lower gain -&gt; max power)</span>
<span class="cm"> * and 3 points for xpd 3 (higher gain -&gt; lower power) here and</span>
<span class="cm"> * interpolate later.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Many vendors just use xpd 0 so xpd 3 is zeroed.</span>
<span class="cm"> */</span>

<span class="cm">/* Convert RF5112 specific data to generic raw data</span>
<span class="cm"> * used by interpolation code */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_convert_pcal_info_5112</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info</span> <span class="o">*</span><span class="n">chinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info_rf5112</span> <span class="o">*</span><span class="n">pcinfo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pdgain_idx</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pdc_to_idx</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pier</span><span class="p">,</span> <span class="n">pdg</span><span class="p">,</span> <span class="n">point</span><span class="p">;</span>

	<span class="cm">/* Fill raw data for each calibration pier */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pier</span> <span class="o">&lt;</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span> <span class="n">pier</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pcinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">rf5112_info</span><span class="p">;</span>

		<span class="cm">/* Allocate pd_curves for this cal pier */</span>
		<span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span> <span class="o">=</span>
				<span class="n">kcalloc</span><span class="p">(</span><span class="n">AR5K_EEPROM_N_PD_CURVES</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_pdgain_info</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="cm">/* Fill pd_curves */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pdg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pdg</span> <span class="o">&lt;</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pd_gains</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span> <span class="n">pdg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">u8</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">pdgain_idx</span><span class="p">[</span><span class="n">pdg</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">ath5k_pdgain_info</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

			<span class="cm">/* Lowest gain curve (max power) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* One more point for better accuracy */</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_N_XPD0_POINTS</span><span class="p">;</span>

				<span class="cm">/* Allocate pd points for this curve */</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">s16</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

				<span class="cm">/* Fill raw dataset</span>
<span class="cm">				 * (all power levels are in 0.25dB units) */</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pcdac_x0</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr_x0</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">point</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">point</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span><span class="p">;</span>
				<span class="n">point</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Absolute values */</span>
					<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr_x0</span><span class="p">[</span><span class="n">point</span><span class="p">];</span>

					<span class="cm">/* Deltas */</span>
					<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">[</span><span class="n">point</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
						<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pcdac_x0</span><span class="p">[</span><span class="n">point</span><span class="p">];</span>
				<span class="p">}</span>

				<span class="cm">/* Set min power for this frequency */</span>
				<span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">min_pwr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="cm">/* Highest gain curve (min power) */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pdg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_N_XPD3_POINTS</span><span class="p">;</span>

				<span class="cm">/* Allocate pd points for this curve */</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">s16</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

				<span class="cm">/* Fill raw dataset</span>
<span class="cm">				 * (all power levels are in 0.25dB units) */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">point</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">point</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span><span class="p">;</span>
				<span class="n">point</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Absolute values */</span>
					<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr_x3</span><span class="p">[</span><span class="n">point</span><span class="p">];</span>

					<span class="cm">/* Fixed points */</span>
					<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pcdac_x3</span><span class="p">[</span><span class="n">point</span><span class="p">];</span>
				<span class="p">}</span>

				<span class="cm">/* Since we have a higher gain curve</span>
<span class="cm">				 * override min power */</span>
				<span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">min_pwr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">ath5k_eeprom_free_pcal_info</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Parse EEPROM data */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_read_pcal_info_5112</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info_rf5112</span> <span class="o">*</span><span class="n">chan_pcal_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info</span> <span class="o">*</span><span class="n">gen_chan_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pdgain_idx</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pdc_to_idx</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pd_gains</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Count how many curves we have and</span>
<span class="cm">	 * identify them (which one of the 4</span>
<span class="cm">	 * available curves we have on each count).</span>
<span class="cm">	 * Curves are stored from lower (x0) to</span>
<span class="cm">	 * higher (x3) gain */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_N_PD_CURVES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ee_x_gain[mode] is x gain mask */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_x_gain</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">pdgain_idx</span><span class="p">[</span><span class="n">pd_gains</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pd_gains</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd_gains</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd_gains</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pd_gains</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11A</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Read 5GHz EEPROM channels</span>
<span class="cm">		 */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_GROUPS_START</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>
		<span class="n">ath5k_eeprom_init_11a_pcal_freq</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_GROUP2_OFFSET</span><span class="p">;</span>
		<span class="n">gen_chan_info</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_a</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11B</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_GROUPS_START</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR5K_EEPROM_HDR_11A</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_GROUP3_OFFSET</span><span class="p">;</span>

		<span class="cm">/* NB: frequency piers parsed during mode init */</span>
		<span class="n">gen_chan_info</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_b</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11G</span>:
		<span class="n">offset</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_GROUPS_START</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR5K_EEPROM_HDR_11A</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_GROUP4_OFFSET</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR5K_EEPROM_HDR_11B</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_GROUP2_OFFSET</span><span class="p">;</span>

		<span class="cm">/* NB: frequency piers parsed during mode init */</span>
		<span class="n">gen_chan_info</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_g</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan_pcal_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">gen_chan_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rf5112_info</span><span class="p">;</span>

		<span class="cm">/* Power values in quarter dB</span>
<span class="cm">		 * for the lower xpd gain curve</span>
<span class="cm">		 * (0 dBm -&gt; higher output power) */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_N_XPD0_POINTS</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pwr_x0</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pwr_x0</span><span class="p">[</span><span class="o">++</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* PCDAC steps</span>
<span class="cm">		 * corresponding to the above power</span>
<span class="cm">		 * measurements */</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pcdac_x0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pcdac_x0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pcdac_x0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>

		<span class="cm">/* Power values in quarter dB</span>
<span class="cm">		 * for the higher xpd gain curve</span>
<span class="cm">		 * (18 dBm -&gt; lower output power) */</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pwr_x3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pwr_x3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pwr_x3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="cm">/* PCDAC steps</span>
<span class="cm">		 * corresponding to the above power</span>
<span class="cm">		 * measurements (fixed) */</span>
		<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pcdac_x3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pcdac_x3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span>
		<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pcdac_x3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pcdac_x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>

			<span class="cm">/* Last xpd0 power level is also channel maximum */</span>
			<span class="n">gen_chan_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_pwr</span> <span class="o">=</span> <span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pwr_x0</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chan_pcal_info</span><span class="o">-&gt;</span><span class="n">pcdac_x0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">gen_chan_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max_pwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ath5k_eeprom_convert_pcal_info_5112</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">gen_chan_info</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read power calibration for RF2413 chips</span>
<span class="cm"> *</span>
<span class="cm"> * For RF2413 we have a Power to PDDAC table (Power Detector)</span>
<span class="cm"> * instead of a PCDAC and 4 pd gain curves for each calibrated channel.</span>
<span class="cm"> * Each curve has power on x axis in 0.5 db steps and PDDADC steps on y</span>
<span class="cm"> * axis and looks like an exponential function like the RF5111 curve.</span>
<span class="cm"> *</span>
<span class="cm"> * To recreate the curves we read here the points and interpolate</span>
<span class="cm"> * later. Note that in most cases only 2 (higher and lower) curves are</span>
<span class="cm"> * used (like RF5112) but vendors have the opportunity to include all</span>
<span class="cm"> * 4 curves on eeprom. The final curve (higher power) has an extra</span>
<span class="cm"> * point for better accuracy like RF5112.</span>
<span class="cm"> */</span>

<span class="cm">/* For RF2413 power calibration data doesn&#39;t start on a fixed location and</span>
<span class="cm"> * if a mode is not supported, its section is missing -not zeroed-.</span>
<span class="cm"> * So we need to calculate the starting offset for each section by using</span>
<span class="cm"> * these two functions */</span>

<span class="cm">/* Return the size of each section based on the mode and the number of pd</span>
<span class="cm"> * gains available (maximum 4). */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">ath5k_pdgains_size_2413</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pdgains_size</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">12</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">;</span>

	<span class="n">sz</span> <span class="o">=</span> <span class="n">pdgains_size</span><span class="p">[</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pd_gains</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">sz</span> <span class="o">*=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">sz</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return the starting offset for a section based on the modes supported</span>
<span class="cm"> * and each section&#39;s size. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">ath5k_cal_data_offset_2413</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_CAL_DATA_START</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_misc4</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11G</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">AR5K_EEPROM_HDR_11B</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">ath5k_pdgains_size_2413</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span>
					<span class="n">AR5K_EEPROM_MODE_11B</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">AR5K_EEPROM_N_2GHZ_CHAN_2413</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11B</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">AR5K_EEPROM_HDR_11A</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">ath5k_pdgains_size_2413</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span>
					<span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">AR5K_EEPROM_N_5GHZ_CHAN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11A</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert RF2413 specific data to generic raw data</span>
<span class="cm"> * used by interpolation code */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_convert_pcal_info_2413</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info</span> <span class="o">*</span><span class="n">chinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info_rf2413</span> <span class="o">*</span><span class="n">pcinfo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pdgain_idx</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pdc_to_idx</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pier</span><span class="p">,</span> <span class="n">pdg</span><span class="p">,</span> <span class="n">point</span><span class="p">;</span>

	<span class="cm">/* Fill raw data for each calibration pier */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pier</span> <span class="o">&lt;</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span> <span class="n">pier</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pcinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">rf2413_info</span><span class="p">;</span>

		<span class="cm">/* Allocate pd_curves for this cal pier */</span>
		<span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span> <span class="o">=</span>
				<span class="n">kcalloc</span><span class="p">(</span><span class="n">AR5K_EEPROM_N_PD_CURVES</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_pdgain_info</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

		<span class="cm">/* Fill pd_curves */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pdg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pdg</span> <span class="o">&lt;</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pd_gains</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span> <span class="n">pdg</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">u8</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">pdgain_idx</span><span class="p">[</span><span class="n">pdg</span><span class="p">];</span>
			<span class="k">struct</span> <span class="n">ath5k_pdgain_info</span> <span class="o">*</span><span class="n">pd</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">pd_curves</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

			<span class="cm">/* One more point for the highest power</span>
<span class="cm">			 * curve (lowest gain) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdg</span> <span class="o">==</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pd_gains</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_N_PD_POINTS</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_N_PD_POINTS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* Allocate pd points for this curve */</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">s16</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

			<span class="cm">/* Fill raw dataset</span>
<span class="cm">			 * convert all pwr levels to</span>
<span class="cm">			 * quarter dB for RF5112 compatibility */</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac_i</span><span class="p">[</span><span class="n">pdg</span><span class="p">];</span>
			<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr_i</span><span class="p">[</span><span class="n">pdg</span><span class="p">];</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">point</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">point</span> <span class="o">&lt;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span><span class="p">;</span> <span class="n">point</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="n">point</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
					<span class="mi">2</span> <span class="o">*</span> <span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="n">pdg</span><span class="p">][</span><span class="n">point</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

				<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">[</span><span class="n">point</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_step</span><span class="p">[</span><span class="n">point</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
						<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="n">pdg</span><span class="p">][</span><span class="n">point</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

			<span class="p">}</span>

			<span class="cm">/* Highest gain curve -&gt; min power */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">min_pwr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="cm">/* Lowest gain curve -&gt; max power */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdg</span> <span class="o">==</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pd_gains</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">chinfo</span><span class="p">[</span><span class="n">pier</span><span class="p">].</span><span class="n">max_pwr</span> <span class="o">=</span>
					<span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_pwr</span><span class="p">[</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pd_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">ath5k_eeprom_free_pcal_info</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Parse EEPROM data */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_read_pcal_info_2413</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info_rf2413</span> <span class="o">*</span><span class="n">pcinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_chan_pcal_info</span> <span class="o">*</span><span class="n">chinfo</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pdgain_idx</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pdc_to_idx</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pd_gains</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Count how many curves we have and</span>
<span class="cm">	 * identify them (which one of the 4</span>
<span class="cm">	 * available curves we have on each count).</span>
<span class="cm">	 * Curves are stored from higher to</span>
<span class="cm">	 * lower gain so we go backwards */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_N_PD_CURVES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ee_x_gain[mode] is x gain mask */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_x_gain</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">pdgain_idx</span><span class="p">[</span><span class="n">pd_gains</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pd_gains</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd_gains</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pd_gains</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">ath5k_cal_data_offset_2413</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11A</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR5K_EEPROM_HDR_11A</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ath5k_eeprom_init_11a_pcal_freq</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_N_5GHZ_CHAN</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">chinfo</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_a</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11B</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR5K_EEPROM_HDR_11B</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ath5k_eeprom_init_11bg_2413</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_N_2GHZ_CHAN_2413</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">chinfo</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_b</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11G</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR5K_EEPROM_HDR_11G</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_header</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ath5k_eeprom_init_11bg_2413</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_N_2GHZ_CHAN_2413</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">chinfo</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_pwr_cal_g</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_n_piers</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rf2413_info</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Read pwr_i, pddac_i and the first</span>
<span class="cm">		 * 2 pd points (pwr, pddac)</span>
<span class="cm">		 */</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

		<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pd_gains</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Pd gain 0 is not the last pd gain</span>
<span class="cm">			 * so it only has 2 pd points.</span>
<span class="cm">			 * Continue with pd gain 1.</span>
<span class="cm">			 */</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pd_gains</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Pd gain 0 is the last one so</span>
<span class="cm">			 * read the extra point.</span>
<span class="cm">			 */</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Proceed with the other pd_gains</span>
<span class="cm">		 * as above.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pd_gains</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pd_gains</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pd_gains</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr_i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr_i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac_i</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>

			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pd_gains</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pwr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

			<span class="n">pcinfo</span><span class="o">-&gt;</span><span class="n">pddac</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ath5k_eeprom_convert_pcal_info_2413</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">chinfo</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read per rate target power (this is the maximum tx power</span>
<span class="cm"> * supported by the card). This info is used when setting</span>
<span class="cm"> * tx power, no matter the channel.</span>
<span class="cm"> *</span>
<span class="cm"> * This also works for v5 EEPROMs.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_read_target_rate_pwr_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_rate_pcal_info</span> <span class="o">*</span><span class="n">rate_pcal_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rate_target_pwr_num</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_TARGET_PWRSTART</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_misc1</span><span class="p">);</span>
	<span class="n">rate_target_pwr_num</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_rate_target_pwr_num</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11A</span>:
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_TARGET_PWR_OFF_11A</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>
		<span class="n">rate_pcal_info</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_rate_tpwr_a</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_rate_target_pwr_num</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_N_5GHZ_CHAN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11B</span>:
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_TARGET_PWR_OFF_11B</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>
		<span class="n">rate_pcal_info</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_rate_tpwr_b</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_rate_target_pwr_num</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* 3rd is g mode&#39;s 1st */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_EEPROM_MODE_11G</span>:
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_TARGET_PWR_OFF_11G</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>
		<span class="n">rate_pcal_info</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_rate_tpwr_g</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_rate_target_pwr_num</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_N_2GHZ_CHAN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Different freq mask for older eeproms (&lt;= v3.2) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&lt;=</span> <span class="n">AR5K_EEPROM_VERSION_3_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">rate_target_pwr_num</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span>
			    <span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target_power_6to24</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target_power_36</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">==</span> <span class="n">AR5K_EEPROM_CHANNEL_DIS</span> <span class="o">||</span>
			    <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">rate_target_pwr_num</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target_power_36</span> <span class="o">|=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target_power_48</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target_power_54</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="o">*</span><span class="n">rate_target_pwr_num</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span>
			    <span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target_power_6to24</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target_power_36</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">==</span> <span class="n">AR5K_EEPROM_CHANNEL_DIS</span> <span class="o">||</span>
			    <span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">rate_target_pwr_num</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target_power_36</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target_power_48</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
			<span class="n">rate_pcal_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">target_power_54</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Read per channel calibration info from EEPROM</span>
<span class="cm"> *</span>
<span class="cm"> * This info is used to calibrate the baseband power table. Imagine</span>
<span class="cm"> * that for each channel there is a power curve that&#39;s hw specific</span>
<span class="cm"> * (depends on amplifier etc) and we try to &quot;correct&quot; this curve using</span>
<span class="cm"> * offsets we pass on to phy chip (baseband -&gt; before amplifier) so that</span>
<span class="cm"> * it can use accurate power values when setting tx power (takes amplifier&#39;s</span>
<span class="cm"> * performance on each channel into account).</span>
<span class="cm"> *</span>
<span class="cm"> * EEPROM provides us with the offsets for some pre-calibrated channels</span>
<span class="cm"> * and we have to interpolate to create the full table for these channels and</span>
<span class="cm"> * also the table for any channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_read_pcal_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read_pcal</span><span class="p">)(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">AR5K_EEPROM_EEMAP</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_misc0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">read_pcal</span> <span class="o">=</span> <span class="n">ath5k_eeprom_read_pcal_info_5112</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_5_0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">AR5K_EEPROM_EEMAP</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_misc0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">read_pcal</span> <span class="o">=</span> <span class="n">ath5k_eeprom_read_pcal_info_2413</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">read_pcal</span> <span class="o">=</span> <span class="n">ath5k_eeprom_read_pcal_info_5111</span><span class="p">;</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">;</span> <span class="n">mode</span> <span class="o">&lt;=</span> <span class="n">AR5K_EEPROM_MODE_11G</span><span class="p">;</span>
	<span class="n">mode</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">read_pcal</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">ath5k_eeprom_read_target_rate_pwr_info</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Read conformance test limits used for regulatory control */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_read_ctl_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath5k_edge_power</span> <span class="o">*</span><span class="n">rep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmask</span><span class="p">,</span> <span class="n">pmask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctl_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">pmask</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_POWER_M</span><span class="p">;</span>
	<span class="n">fmask</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_FREQ_M</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_CTL</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>
	<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ctls</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_N_CTLS</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ctls</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ctl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ctl</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_GROUP8_OFFSET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_4_0</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_TARGET_PWRSTART</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_misc1</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">AR5K_EEPROM_GROUP5_OFFSET</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_GROUPS_START</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>

	<span class="n">rep</span> <span class="o">=</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ctl_pwr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ctls</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ctl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">AR5K_CTL_MODE_M</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AR5K_CTL_11A</span>:
		<span class="k">case</span> <span class="n">AR5K_CTL_TURBO</span>:
			<span class="n">ctl_mode</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ctl_mode</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_MODE_11G</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_ctl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_3_3</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">rep</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_N_EDGES</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_3_3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_N_EDGES</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="n">rep</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fmask</span><span class="p">;</span>
				<span class="n">rep</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">fmask</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_N_EDGES</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="n">rep</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pmask</span><span class="p">;</span>
				<span class="n">rep</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">rep</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">edge</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">pmask</span><span class="p">;</span>
				<span class="n">rep</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fmask</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fmask</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fmask</span><span class="p">;</span>

			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">freq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fmask</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fmask</span><span class="p">;</span>

			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">freq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fmask</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fmask</span><span class="p">;</span>

			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">freq</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fmask</span><span class="p">;</span>

			<span class="n">rep</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pmask</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pmask</span><span class="p">;</span>

			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">edge</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pmask</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">edge</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">pmask</span><span class="p">;</span>

			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pmask</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pmask</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pmask</span><span class="p">;</span>

			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="o">++</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">edge</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
			<span class="n">rep</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">edge</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">pmask</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_N_EDGES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rep</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">freq</span> <span class="o">=</span> <span class="n">ath5k_eeprom_bin2freq</span><span class="p">(</span><span class="n">ee</span><span class="p">,</span>
				<span class="n">rep</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">freq</span><span class="p">,</span> <span class="n">ctl_mode</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rep</span> <span class="o">+=</span> <span class="n">AR5K_EEPROM_N_EDGES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ath5k_eeprom_read_spur_chans</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath5k_eeprom_info</span> <span class="o">*</span><span class="n">ee</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_capabilities</span><span class="p">.</span><span class="n">cap_eeprom</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_CTL</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">)</span> <span class="o">+</span>
				<span class="n">AR5K_EEPROM_N_CTLS</span><span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_VERSION_5_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No spur info for 5GHz */</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_spur_chans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_NO_SPUR</span><span class="p">;</span>
		<span class="cm">/* 2 channels for 2GHz (2464/2420) */</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_spur_chans</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_5413_SPUR_CHAN_1</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_spur_chans</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_5413_SPUR_CHAN_2</span><span class="p">;</span>
		<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_spur_chans</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_NO_SPUR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_version</span> <span class="o">&gt;=</span> <span class="n">AR5K_EEPROM_VERSION_5_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR5K_EEPROM_N_SPUR_CHANS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_spur_chans</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">AR5K_EEPROM_READ</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">AR5K_EEPROM_N_SPUR_CHANS</span><span class="p">,</span>
									<span class="n">val</span><span class="p">);</span>
			<span class="n">ee</span><span class="o">-&gt;</span><span class="n">ee_spur_chans</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">offset</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/***********************\</span>
<span class="cm">* Init/Detach functions *</span>
<span class="cm">\***********************/</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize eeprom data structure</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">ath5k_eeprom_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ath5k_eeprom_init_header</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ath5k_eeprom_init_modes</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ath5k_eeprom_read_pcal_info</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ath5k_eeprom_read_ctl_info</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ath5k_eeprom_read_spur_chans</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ath5k_eeprom_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath5k_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">mode</span> <span class="o">=</span> <span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">;</span> <span class="n">mode</span> <span class="o">&lt;=</span> <span class="n">AR5K_EEPROM_MODE_11G</span><span class="p">;</span> <span class="n">mode</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ath5k_eeprom_free_pcal_info</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">ath5k_eeprom_mode_from_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5K_MODE_11A</span>:
		<span class="k">return</span> <span class="n">AR5K_EEPROM_MODE_11A</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_MODE_11G</span>:
		<span class="k">return</span> <span class="n">AR5K_EEPROM_MODE_11G</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR5K_MODE_11B</span>:
		<span class="k">return</span> <span class="n">AR5K_EEPROM_MODE_11B</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
