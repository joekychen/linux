<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › ar9003_phy.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ar9003_phy.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &quot;hw.h&quot;</span>
<span class="cp">#include &quot;ar9003_phy.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">firstep_table</span><span class="p">[]</span> <span class="o">=</span>
<span class="cm">/* level:  0   1   2   3   4   5   6   7   8  */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span> <span class="p">};</span> <span class="cm">/* lvl 0-8, default 2 */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">cycpwrThr1_table</span><span class="p">[]</span> <span class="o">=</span>
<span class="cm">/* level:  0   1   2   3   4   5   6   7   8  */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">};</span>     <span class="cm">/* lvl 0-7, default 3 */</span>

<span class="cm">/*</span>
<span class="cm"> * register values to turn OFDM weak signal detection OFF</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m1ThreshLow_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2ThreshLow_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m1Thresh_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2Thresh_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2CountThr_off</span> <span class="o">=</span>  <span class="mi">31</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2CountThrLow_off</span> <span class="o">=</span>  <span class="mi">63</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m1ThreshLowExt_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2ThreshLowExt_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m1ThreshExt_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2ThreshExt_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * ar9003_hw_set_channel - set channel on single-chip device</span>
<span class="cm"> * @ah: atheros hardware structure</span>
<span class="cm"> * @chan:</span>
<span class="cm"> *</span>
<span class="cm"> * This is the function to change channel on single-chip devices, that is</span>
<span class="cm"> * for AR9300 family of chipsets.</span>
<span class="cm"> *</span>
<span class="cm"> * This function takes the channel value in MHz and sets</span>
<span class="cm"> * hardware channel value. Assumes writes have been enabled to analog bus.</span>
<span class="cm"> *</span>
<span class="cm"> * Actual Expression,</span>
<span class="cm"> *</span>
<span class="cm"> * For 2GHz channel,</span>
<span class="cm"> * Channel Frequency = (3/4) * freq_ref * (chansel[8:0] + chanfrac[16:0]/2^17)</span>
<span class="cm"> * (freq_ref = 40MHz)</span>
<span class="cm"> *</span>
<span class="cm"> * For 5GHz channel,</span>
<span class="cm"> * Channel Frequency = (3/2) * freq_ref * (chansel[8:0] + chanfrac[16:0]/2^10)</span>
<span class="cm"> * (freq_ref = 40MHz/(24&gt;&gt;amodeRefSel))</span>
<span class="cm"> *</span>
<span class="cm"> * For 5GHz channels which are 5MHz spaced,</span>
<span class="cm"> * Channel Frequency = (3/2) * freq_ref * (chansel[8:0] + chanfrac[16:0]/2^17)</span>
<span class="cm"> * (freq_ref = 40MHz)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ar9003_hw_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">bMode</span><span class="p">,</span> <span class="n">fracMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aModeRefSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">freq</span><span class="p">,</span> <span class="n">channelSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chan_centers</span> <span class="n">centers</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loadSynthChannel</span><span class="p">;</span>

	<span class="n">ath9k_hw_get_channel_centers</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">centers</span><span class="p">);</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">centers</span><span class="p">.</span><span class="n">synth_center</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">4800</span><span class="p">)</span> <span class="p">{</span>     <span class="cm">/* 2 GHz, fractional mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">chan_frac</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">div</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_clk_25mhz</span><span class="p">)</span>
				<span class="n">div</span> <span class="o">=</span> <span class="mi">75</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">div</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>

			<span class="n">channelSel</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
			<span class="n">chan_frac</span> <span class="o">=</span> <span class="p">(((</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="n">div</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x20000</span><span class="p">)</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
			<span class="n">channelSel</span> <span class="o">=</span> <span class="p">(</span><span class="n">channelSel</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="n">chan_frac</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">chan_frac</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * freq_ref = 40 / (refdiva &gt;&gt; amoderefsel); where refdiva=1 and amoderefsel=0</span>
<span class="cm">			 * ndiv = ((chan_mhz * 4) / 3) / freq_ref;</span>
<span class="cm">			 * chansel = int(ndiv), chanfrac = (ndiv - chansel) * 0x20000</span>
<span class="cm">			 */</span>
			<span class="n">channelSel</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">120</span><span class="p">;</span>
			<span class="n">chan_frac</span> <span class="o">=</span> <span class="p">(((</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">%</span> <span class="mi">120</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x20000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">120</span><span class="p">;</span>
			<span class="n">channelSel</span> <span class="o">=</span> <span class="p">(</span><span class="n">channelSel</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="n">chan_frac</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_clk_25mhz</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">chan_frac</span><span class="p">;</span>

				<span class="n">channelSel</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">75</span><span class="p">;</span>
				<span class="n">chan_frac</span> <span class="o">=</span> <span class="p">(((</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">75</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x20000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">75</span><span class="p">;</span>
				<span class="n">channelSel</span> <span class="o">=</span> <span class="p">(</span><span class="n">channelSel</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="n">chan_frac</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">channelSel</span> <span class="o">=</span> <span class="n">CHANSEL_2G</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">channelSel</span> <span class="o">=</span> <span class="n">CHANSEL_2G</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span>
		<span class="cm">/* Set to 2G mode */</span>
		<span class="n">bMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_clk_25mhz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">chan_frac</span><span class="p">;</span>

			<span class="n">channelSel</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">75</span><span class="p">;</span>
			<span class="n">chan_frac</span> <span class="o">=</span> <span class="p">(((</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="mi">75</span><span class="p">)</span> <span class="o">*</span> <span class="mh">0x20000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">75</span><span class="p">;</span>
			<span class="n">channelSel</span> <span class="o">=</span> <span class="p">(</span><span class="n">channelSel</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">|</span> <span class="n">chan_frac</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">channelSel</span> <span class="o">=</span> <span class="n">CHANSEL_5G</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span>
			<span class="cm">/* Doubler is ON, so, divide channelSel by 2. */</span>
			<span class="n">channelSel</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Set to 5G mode */</span>
		<span class="n">bMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable fractional mode for all channels */</span>
	<span class="n">fracMode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">aModeRefSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">loadSynthChannel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reg32</span> <span class="o">=</span> <span class="p">(</span><span class="n">bMode</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SYNTH_CONTROL</span><span class="p">,</span> <span class="n">reg32</span><span class="p">);</span>

	<span class="cm">/* Enable Long shift Select for Synthesizer */</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_65NM_CH0_SYNTH4</span><span class="p">,</span>
		      <span class="n">AR_PHY_SYNTH4_LONG_SHIFT_SELECT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Program Synth. setting */</span>
	<span class="n">reg32</span> <span class="o">=</span> <span class="p">(</span><span class="n">channelSel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">fracMode</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">aModeRefSel</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">loadSynthChannel</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_65NM_CH0_SYNTH7</span><span class="p">,</span> <span class="n">reg32</span><span class="p">);</span>

	<span class="cm">/* Toggle Load Synth channel bit */</span>
	<span class="n">loadSynthChannel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">reg32</span> <span class="o">=</span> <span class="p">(</span><span class="n">channelSel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">fracMode</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">aModeRefSel</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">loadSynthChannel</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_65NM_CH0_SYNTH7</span><span class="p">,</span> <span class="n">reg32</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ar9003_hw_spur_mitigate_mrc_cck - convert baseband spur frequency</span>
<span class="cm"> * @ah: atheros hardware structure</span>
<span class="cm"> * @chan:</span>
<span class="cm"> *</span>
<span class="cm"> * For single-chip solutions. Converts to baseband spur frequency given the</span>
<span class="cm"> * input channel frequency and compute register settings below.</span>
<span class="cm"> *</span>
<span class="cm"> * Spur mitigation for MRC CCK</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_spur_mitigate_mrc_cck</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">spur_freq</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2420</span><span class="p">,</span> <span class="mi">2440</span><span class="p">,</span> <span class="mi">2464</span><span class="p">,</span> <span class="mi">2480</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">cur_bb_spur</span><span class="p">,</span> <span class="n">negative</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cck_spur_freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">range</span><span class="p">,</span> <span class="n">max_spur_cnts</span><span class="p">,</span> <span class="n">synth_freq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">spur_fbin_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Need to verify range +/- 10 MHz in control channel, otherwise spur</span>
<span class="cm">	 * is out-of-band and can be ignored.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spur_fbin_ptr</span> <span class="o">=</span> <span class="n">ar9003_get_spur_chan_ptr</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
							 <span class="n">IS_CHAN_2GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spur_fbin_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* No spur */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">max_spur_cnts</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HT40</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">range</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_GEN_CTRL</span><span class="p">,</span>
					   <span class="n">AR_PHY_GC_DYN2040_PRI_CH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">synth_freq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">synth_freq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">range</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">synth_freq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">range</span> <span class="o">=</span> <span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">max_spur_cnts</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">synth_freq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_spur_cnts</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">negative</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">cur_bb_spur</span> <span class="o">=</span> <span class="n">ath9k_hw_fbin2freq</span><span class="p">(</span><span class="n">spur_fbin_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
							 <span class="n">IS_CHAN_2GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">cur_bb_spur</span> <span class="o">=</span> <span class="n">spur_freq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">cur_bb_spur</span> <span class="o">-=</span> <span class="n">synth_freq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_bb_spur</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">negative</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">cur_bb_spur</span> <span class="o">=</span> <span class="o">-</span><span class="n">cur_bb_spur</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_bb_spur</span> <span class="o">&lt;</span> <span class="n">range</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cck_spur_freq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">cur_bb_spur</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">/</span> <span class="mi">11</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">negative</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">cck_spur_freq</span> <span class="o">=</span> <span class="o">-</span><span class="n">cck_spur_freq</span><span class="p">;</span>

			<span class="n">cck_spur_freq</span> <span class="o">=</span> <span class="n">cck_spur_freq</span> <span class="o">&amp;</span> <span class="mh">0xfffff</span><span class="p">;</span>

			<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_AGC_CONTROL</span><span class="p">,</span>
				      <span class="n">AR_PHY_AGC_CONTROL_YCOK_MAX</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
			<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_SPUR_MIT</span><span class="p">,</span>
				      <span class="n">AR_PHY_CCK_SPUR_MIT_SPUR_RSSI_THR</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">);</span>
			<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_SPUR_MIT</span><span class="p">,</span>
				      <span class="n">AR_PHY_CCK_SPUR_MIT_SPUR_FILTER_TYPE</span><span class="p">,</span>
				      <span class="mh">0x2</span><span class="p">);</span>
			<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_SPUR_MIT</span><span class="p">,</span>
				      <span class="n">AR_PHY_CCK_SPUR_MIT_USE_CCK_SPUR_MIT</span><span class="p">,</span>
				      <span class="mh">0x1</span><span class="p">);</span>
			<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_SPUR_MIT</span><span class="p">,</span>
				      <span class="n">AR_PHY_CCK_SPUR_MIT_CCK_SPUR_FREQ</span><span class="p">,</span>
				      <span class="n">cck_spur_freq</span><span class="p">);</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_AGC_CONTROL</span><span class="p">,</span>
		      <span class="n">AR_PHY_AGC_CONTROL_YCOK_MAX</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_SPUR_MIT</span><span class="p">,</span>
		      <span class="n">AR_PHY_CCK_SPUR_MIT_USE_CCK_SPUR_MIT</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_SPUR_MIT</span><span class="p">,</span>
		      <span class="n">AR_PHY_CCK_SPUR_MIT_CCK_SPUR_FREQ</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Clean all spur register fields */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_spur_ofdm_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING4</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING4_ENABLE_SPUR_FILTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING11</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING11_SPUR_FREQ_SD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING11</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING11_SPUR_DELTA_PHASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT</span><span class="p">,</span>
		      <span class="n">AR_PHY_SFCORR_EXT_SPUR_SUBCHANNEL_SD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING11</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING11_USE_SPUR_FILTER_IN_AGC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING11</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING11_USE_SPUR_FILTER_IN_SELFCOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING4</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING4_ENABLE_SPUR_RSSI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_REG</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_REG_EN_VIT_SPUR_RSSI</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_REG</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_REG_ENABLE_NF_RSSI_SPUR_MIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_REG</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_REG_ENABLE_MASK_PPM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING4</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING4_ENABLE_PILOT_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING4</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING4_ENABLE_CHAN_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PILOT_SPUR_MASK</span><span class="p">,</span>
		      <span class="n">AR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_IDX_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_MASK_A</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_MASK_A_CF_PUNC_MASK_IDX_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CHAN_SPUR_MASK</span><span class="p">,</span>
		      <span class="n">AR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_IDX_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PILOT_SPUR_MASK</span><span class="p">,</span>
		      <span class="n">AR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CHAN_SPUR_MASK</span><span class="p">,</span>
		      <span class="n">AR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_MASK_A</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_MASK_A_CF_PUNC_MASK_A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_REG</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_REG_MASK_RATE_CNTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_spur_ofdm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">freq_offset</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">spur_freq_sd</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">spur_delta_phase</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">spur_subchannel_sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mask_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* OFDM Spur mitigation */</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING4</span><span class="p">,</span>
		 <span class="n">AR_PHY_TIMING4_ENABLE_SPUR_FILTER</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING11</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING11_SPUR_FREQ_SD</span><span class="p">,</span> <span class="n">spur_freq_sd</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING11</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING11_SPUR_DELTA_PHASE</span><span class="p">,</span> <span class="n">spur_delta_phase</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT</span><span class="p">,</span>
		      <span class="n">AR_PHY_SFCORR_EXT_SPUR_SUBCHANNEL_SD</span><span class="p">,</span> <span class="n">spur_subchannel_sd</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING11</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING11_USE_SPUR_FILTER_IN_AGC</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING11</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING11_USE_SPUR_FILTER_IN_SELFCOR</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING4</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING4_ENABLE_SPUR_RSSI</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_REG</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_REG_SPUR_RSSI_THRESH</span><span class="p">,</span> <span class="mi">34</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_REG</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_REG_EN_VIT_SPUR_RSSI</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MODE</span><span class="p">,</span>
			   <span class="n">AR_PHY_MODE_DYNAMIC</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_REG</span><span class="p">,</span>
			      <span class="n">AR_PHY_SPUR_REG_ENABLE_NF_RSSI_SPUR_MIT</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">mask_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mask_index</span> <span class="o">=</span> <span class="n">mask_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mask_index</span> <span class="o">=</span> <span class="n">mask_index</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_REG</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_REG_ENABLE_MASK_PPM</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING4</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING4_ENABLE_PILOT_MASK</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING4</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING4_ENABLE_CHAN_MASK</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PILOT_SPUR_MASK</span><span class="p">,</span>
		      <span class="n">AR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_IDX_A</span><span class="p">,</span> <span class="n">mask_index</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_MASK_A</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_MASK_A_CF_PUNC_MASK_IDX_A</span><span class="p">,</span> <span class="n">mask_index</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CHAN_SPUR_MASK</span><span class="p">,</span>
		      <span class="n">AR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_IDX_A</span><span class="p">,</span> <span class="n">mask_index</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PILOT_SPUR_MASK</span><span class="p">,</span>
		      <span class="n">AR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_A</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CHAN_SPUR_MASK</span><span class="p">,</span>
		      <span class="n">AR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_A</span><span class="p">,</span> <span class="mh">0xc</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_MASK_A</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_MASK_A_CF_PUNC_MASK_A</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_REG</span><span class="p">,</span>
		      <span class="n">AR_PHY_SPUR_REG_MASK_RATE_CNTL</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_spur_ofdm_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				     <span class="kt">int</span> <span class="n">freq_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">spur_freq_sd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spur_subchannel_sd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spur_delta_phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HT40</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq_offset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_GEN_CTRL</span><span class="p">,</span>
					   <span class="n">AR_PHY_GC_DYN2040_PRI_CH</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
				<span class="n">spur_subchannel_sd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">spur_subchannel_sd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">spur_freq_sd</span> <span class="o">=</span> <span class="p">((</span><span class="n">freq_offset</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="mi">11</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_GEN_CTRL</span><span class="p">,</span>
			    <span class="n">AR_PHY_GC_DYN2040_PRI_CH</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
				<span class="n">spur_subchannel_sd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">spur_subchannel_sd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">spur_freq_sd</span> <span class="o">=</span> <span class="p">((</span><span class="n">freq_offset</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="mi">11</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="n">spur_delta_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spur_subchannel_sd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spur_freq_sd</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span><span class="mi">11</span><span class="p">;</span>
		<span class="n">spur_delta_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">freq_offset</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spur_freq_sd</span> <span class="o">=</span> <span class="n">spur_freq_sd</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>
	<span class="n">spur_delta_phase</span> <span class="o">=</span> <span class="n">spur_delta_phase</span> <span class="o">&amp;</span> <span class="mh">0xfffff</span><span class="p">;</span>

	<span class="n">ar9003_hw_spur_ofdm</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			    <span class="n">freq_offset</span><span class="p">,</span>
			    <span class="n">spur_freq_sd</span><span class="p">,</span>
			    <span class="n">spur_delta_phase</span><span class="p">,</span>
			    <span class="n">spur_subchannel_sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Spur mitigation for OFDM */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_spur_mitigate_ofdm</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">synth_freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">range</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freq_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u8</span><span class="o">*</span> <span class="n">spurChansPtr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ar9300_eeprom</span> <span class="o">*</span><span class="n">eep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ar9300_eep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_5GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spurChansPtr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">eep</span><span class="o">-&gt;</span><span class="n">modalHeader5G</span><span class="p">.</span><span class="n">spurChans</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">spurChansPtr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">eep</span><span class="o">-&gt;</span><span class="n">modalHeader2G</span><span class="p">.</span><span class="n">spurChans</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spurChansPtr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* No spur in the mode */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HT40</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">range</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_GEN_CTRL</span><span class="p">,</span>
				   <span class="n">AR_PHY_GC_DYN2040_PRI_CH</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span>
			<span class="n">synth_freq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">synth_freq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">range</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">synth_freq</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar9003_hw_spur_ofdm_clear</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR_EEPROM_MODAL_SPURS</span> <span class="o">&amp;&amp;</span> <span class="n">spurChansPtr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq_offset</span> <span class="o">=</span> <span class="n">ath9k_hw_fbin2freq</span><span class="p">(</span><span class="n">spurChansPtr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">freq_offset</span> <span class="o">-=</span> <span class="n">synth_freq</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">freq_offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">range</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ar9003_hw_spur_ofdm_work</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">freq_offset</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_spur_mitigate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ar9003_hw_spur_mitigate_mrc_cck</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">ar9003_hw_spur_mitigate_ofdm</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ar9003_hw_compute_pll_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pll</span><span class="p">;</span>

	<span class="n">pll</span> <span class="o">=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0x5</span><span class="p">,</span> <span class="n">AR_RTC_9300_PLL_REFDIV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span> <span class="n">IS_CHAN_HALF_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">pll</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">AR_RTC_9300_PLL_CLKSEL</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span> <span class="n">IS_CHAN_QUARTER_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">pll</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0x2</span><span class="p">,</span> <span class="n">AR_RTC_9300_PLL_CLKSEL</span><span class="p">);</span>

	<span class="n">pll</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0x2c</span><span class="p">,</span> <span class="n">AR_RTC_9300_PLL_DIV</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pll</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_set_channel_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phymode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">enableDacFifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">enableDacFifo</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_GEN_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR_PHY_GC_ENABLE_DAC_FIFO</span><span class="p">);</span>

	<span class="cm">/* Enable 11n HT, 20 MHz */</span>
	<span class="n">phymode</span> <span class="o">=</span> <span class="n">AR_PHY_GC_HT_EN</span> <span class="o">|</span> <span class="n">AR_PHY_GC_SINGLE_HT_LTF1</span> <span class="o">|</span>
		  <span class="n">AR_PHY_GC_SHORT_GI_40</span> <span class="o">|</span> <span class="n">enableDacFifo</span><span class="p">;</span>

	<span class="cm">/* Configure baseband for dynamic 20/40 operation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HT40</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phymode</span> <span class="o">|=</span> <span class="n">AR_PHY_GC_DYN2040_EN</span><span class="p">;</span>
		<span class="cm">/* Configure control (primary) channel at +-10MHz */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chanmode</span> <span class="o">==</span> <span class="n">CHANNEL_A_HT40PLUS</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chanmode</span> <span class="o">==</span> <span class="n">CHANNEL_G_HT40PLUS</span><span class="p">))</span>
			<span class="n">phymode</span> <span class="o">|=</span> <span class="n">AR_PHY_GC_DYN2040_PRI_CH</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* make sure we preserve INI settings */</span>
	<span class="n">phymode</span> <span class="o">|=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_GEN_CTRL</span><span class="p">);</span>
	<span class="cm">/* turn off Green Field detection for STA for now */</span>
	<span class="n">phymode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR_PHY_GC_GF_DETECT_EN</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_GEN_CTRL</span><span class="p">,</span> <span class="n">phymode</span><span class="p">);</span>

	<span class="cm">/* Configure MAC for 20/40 operation */</span>
	<span class="n">ath9k_hw_set11nmac2040</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/* global transmit timeout (25 TUs default)*/</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_GTXTO</span><span class="p">,</span> <span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="n">AR_GTXTO_TIMEOUT_LIMIT_S</span><span class="p">);</span>
	<span class="cm">/* carrier sense timeout */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CST</span><span class="p">,</span> <span class="mh">0xF</span> <span class="o">&lt;&lt;</span> <span class="n">AR_CST_TIMEOUT_LIMIT_S</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_init_bb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">synthDelay</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for the frequency synth to settle (synth goes on</span>
<span class="cm">	 * via AR_PHY_ACTIVE_EN).  Read the phy active delay register.</span>
<span class="cm">	 * Value is in 100ns increments.</span>
<span class="cm">	 */</span>
	<span class="n">synthDelay</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RX_DELAY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR_PHY_RX_DELAY_DELAY</span><span class="p">;</span>

	<span class="cm">/* Activate the PHY (includes baseband activate + synthesizer on) */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ACTIVE</span><span class="p">,</span> <span class="n">AR_PHY_ACTIVE_EN</span><span class="p">);</span>
	<span class="n">ath9k_hw_synth_delay</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">synthDelay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_set_chain_masks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x5</span>:
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ANALOG_SWAP</span><span class="p">,</span>
			    <span class="n">AR_PHY_SWAP_ALT_CHAIN</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x3</span>:
	<span class="k">case</span> <span class="mh">0x1</span>:
	<span class="k">case</span> <span class="mh">0x2</span>:
	<span class="k">case</span> <span class="mh">0x7</span>:
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RX_CHAINMASK</span><span class="p">,</span> <span class="n">rx</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CAL_CHAINMASK</span><span class="p">,</span> <span class="n">rx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_APM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tx</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">))</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SELFGEN_MASK</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="cm">/* xxx only when MCI support is enabled */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SELFGEN_MASK</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SELFGEN_MASK</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">==</span> <span class="mh">0x5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ANALOG_SWAP</span><span class="p">,</span>
			    <span class="n">AR_PHY_SWAP_ALT_CHAIN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Override INI values with chip specific configuration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_override_ini</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the RX_ABORT and RX_DIS and clear it only after</span>
<span class="cm">	 * RXE is set for MAC. This prevents frames with</span>
<span class="cm">	 * corrupted descriptor status.</span>
<span class="cm">	 */</span>
	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_DIAG_SW</span><span class="p">,</span> <span class="p">(</span><span class="n">AR_DIAG_RX_DIS</span> <span class="o">|</span> <span class="n">AR_DIAG_RX_ABORT</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * For AR9280 and above, there is a new feature that allows</span>
<span class="cm">	 * Multicast search based on both MAC Address and Key ID. By default,</span>
<span class="cm">	 * this feature is enabled. But since the driver is not using this</span>
<span class="cm">	 * feature, we switch it off; otherwise multicast search based on</span>
<span class="cm">	 * MAC addr only will fail.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCU_MISC_MODE2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">AR_ADHOC_MCAST_KEYID_ENABLE</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCU_MISC_MODE2</span><span class="p">,</span>
		  <span class="n">val</span> <span class="o">|</span> <span class="n">AR_AGG_WEP_ENABLE_FIX</span> <span class="o">|</span> <span class="n">AR_AGG_WEP_ENABLE</span><span class="p">);</span>

	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_DETECT</span><span class="p">,</span>
		    <span class="n">AR_PHY_CCK_DETECT_BB_ENABLE_ANT_FAST_DIV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_prog_ini</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ar5416IniArray</span> <span class="o">*</span><span class="n">iniArr</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">column</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">regWrites</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* New INI format: Array may be undefined (pre, core, post arrays) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iniArr</span><span class="o">-&gt;</span><span class="n">ia_array</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * New INI format: Pre, core, and post arrays for a given subsystem</span>
<span class="cm">	 * may be modal (&gt; 2 columns) or non-modal (2 columns). Determine if</span>
<span class="cm">	 * the array is non-modal and force the column to 1.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">column</span> <span class="o">&gt;=</span> <span class="n">iniArr</span><span class="o">-&gt;</span><span class="n">ia_columns</span><span class="p">)</span>
		<span class="n">column</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iniArr</span><span class="o">-&gt;</span><span class="n">ia_rows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">INI_RA</span><span class="p">(</span><span class="n">iniArr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">INI_RA</span><span class="p">(</span><span class="n">iniArr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">column</span><span class="p">);</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="n">DO_DELAY</span><span class="p">(</span><span class="n">regWrites</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ar9003_hw_process_ini</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regWrites</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">modesIndex</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chanmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHANNEL_A</span>:
	<span class="k">case</span> <span class="n">CHANNEL_A_HT20</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_A_HT40PLUS</span>:
	<span class="k">case</span> <span class="n">CHANNEL_A_HT40MINUS</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_G</span>:
	<span class="k">case</span> <span class="n">CHANNEL_G_HT20</span>:
	<span class="k">case</span> <span class="n">CHANNEL_B</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_G_HT40PLUS</span>:
	<span class="k">case</span> <span class="n">CHANNEL_G_HT40MINUS</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH_INI_NUM_SPLIT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ar9003_hw_prog_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniSOC</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">modesIndex</span><span class="p">);</span>
		<span class="n">ar9003_hw_prog_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniMac</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">modesIndex</span><span class="p">);</span>
		<span class="n">ar9003_hw_prog_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBB</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">modesIndex</span><span class="p">);</span>
		<span class="n">ar9003_hw_prog_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniRadio</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">modesIndex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ATH_INI_POST</span> <span class="o">&amp;&amp;</span> <span class="n">AR_SREV_9462_20</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">ar9003_hw_prog_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ini_radio_post_sys2ant</span><span class="p">,</span>
					   <span class="n">modesIndex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesRxGain</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regWrites</span><span class="p">);</span>
	<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span> <span class="n">modesIndex</span><span class="p">,</span> <span class="n">regWrites</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For 5GHz channels requiring Fast Clock, apply</span>
<span class="cm">	 * different modal values.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_A_FAST_CLOCK</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
		<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesFastClock</span><span class="p">,</span>
				<span class="n">modesIndex</span><span class="p">,</span> <span class="n">regWrites</span><span class="p">);</span>

	<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniAdditional</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regWrites</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">2484</span><span class="p">)</span>
		<span class="n">ar9003_hw_prog_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ini_japan2484</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">modes_index</span> <span class="o">=</span> <span class="n">modesIndex</span><span class="p">;</span>
	<span class="n">ar9003_hw_override_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ar9003_hw_set_channel_regs</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">ar9003_hw_set_chain_masks</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxchainmask</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span><span class="p">);</span>
	<span class="n">ath9k_hw_apply_txpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TX_IQCAL_CONTROL_0</span><span class="p">,</span>
				<span class="n">AR_PHY_TX_IQCAL_CONTROL_0_ENABLE_TXIQ_CAL</span><span class="p">))</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">enabled_cals</span> <span class="o">|=</span> <span class="n">TX_IQ_CAL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">enabled_cals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_IQ_CAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CL_CAL_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR_PHY_CL_CAL_ENABLE</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">enabled_cals</span> <span class="o">|=</span> <span class="n">TX_CL_CAL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">enabled_cals</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_CL_CAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_set_rfmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rfMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rfMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IS_CHAN_B</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_CHAN_G</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="o">?</span> <span class="n">AR_PHY_MODE_DYNAMIC</span> <span class="o">:</span> <span class="n">AR_PHY_MODE_OFDM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_A_FAST_CLOCK</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
		<span class="n">rfMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AR_PHY_MODE_DYNAMIC</span> <span class="o">|</span> <span class="n">AR_PHY_MODE_DYN_CCK_DISABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_QUARTER_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">rfMode</span> <span class="o">|=</span> <span class="n">AR_PHY_MODE_QUARTER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HALF_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">rfMode</span> <span class="o">|=</span> <span class="n">AR_PHY_MODE_HALF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfMode</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AR_PHY_MODE_QUARTER</span> <span class="o">|</span> <span class="n">AR_PHY_MODE_HALF</span><span class="p">))</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_FRAME_CTL</span><span class="p">,</span>
			      <span class="n">AR_PHY_FRAME_CTL_CF_OVERLAP_WINDOW</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MODE</span><span class="p">,</span> <span class="n">rfMode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_mark_phy_inactive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ACTIVE</span><span class="p">,</span> <span class="n">AR_PHY_ACTIVE_DIS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_set_delta_slope</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">coef_scaled</span><span class="p">,</span> <span class="n">ds_coef_exp</span><span class="p">,</span> <span class="n">ds_coef_man</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clockMhzScaled</span> <span class="o">=</span> <span class="mh">0x64000000</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chan_centers</span> <span class="n">centers</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * half and quarter rate can divide the scaled clock by 2 or 4</span>
<span class="cm">	 * scale for selected channel bandwidth</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HALF_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">clockMhzScaled</span> <span class="o">=</span> <span class="n">clockMhzScaled</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_QUARTER_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">clockMhzScaled</span> <span class="o">=</span> <span class="n">clockMhzScaled</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ALGO -&gt; coef = 1e8/fcarrier*fclock/40;</span>
<span class="cm">	 * scaled coef to provide precision for this floating calculation</span>
<span class="cm">	 */</span>
	<span class="n">ath9k_hw_get_channel_centers</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">centers</span><span class="p">);</span>
	<span class="n">coef_scaled</span> <span class="o">=</span> <span class="n">clockMhzScaled</span> <span class="o">/</span> <span class="n">centers</span><span class="p">.</span><span class="n">synth_center</span><span class="p">;</span>

	<span class="n">ath9k_hw_get_delta_slope_vals</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">coef_scaled</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds_coef_man</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">ds_coef_exp</span><span class="p">);</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING3</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING3_DSC_MAN</span><span class="p">,</span> <span class="n">ds_coef_man</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING3</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING3_DSC_EXP</span><span class="p">,</span> <span class="n">ds_coef_exp</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For Short GI,</span>
<span class="cm">	 * scaled coeff is 9/10 that of normal coeff</span>
<span class="cm">	 */</span>
	<span class="n">coef_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">coef_scaled</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">ath9k_hw_get_delta_slope_vals</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">coef_scaled</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds_coef_man</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">ds_coef_exp</span><span class="p">);</span>

	<span class="cm">/* for short gi */</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SGI_DELTA</span><span class="p">,</span>
		      <span class="n">AR_PHY_SGI_DSC_MAN</span><span class="p">,</span> <span class="n">ds_coef_man</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SGI_DELTA</span><span class="p">,</span>
		      <span class="n">AR_PHY_SGI_DSC_EXP</span><span class="p">,</span> <span class="n">ds_coef_exp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ar9003_hw_rfbus_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RFBUS_REQ</span><span class="p">,</span> <span class="n">AR_PHY_RFBUS_REQ_EN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath9k_hw_wait</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RFBUS_GRANT</span><span class="p">,</span> <span class="n">AR_PHY_RFBUS_GRANT_EN</span><span class="p">,</span>
			     <span class="n">AR_PHY_RFBUS_GRANT_EN</span><span class="p">,</span> <span class="n">AH_WAIT_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for the frequency synth to settle (synth goes on via PHY_ACTIVE_EN).</span>
<span class="cm"> * Read the phy active delay register. Value is in 100ns increments.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_rfbus_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">synthDelay</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RX_DELAY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR_PHY_RX_DELAY_DELAY</span><span class="p">;</span>

	<span class="n">ath9k_hw_synth_delay</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">,</span> <span class="n">synthDelay</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RFBUS_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ar9003_hw_ani_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">ath9k_ani_cmd</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ar5416AniState</span> <span class="o">*</span><span class="n">aniState</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">value</span><span class="p">,</span> <span class="n">value2</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION</span>:<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * on == 1 means ofdm weak signal detection is ON</span>
<span class="cm">		 * on == 1 is the default, for less noise immunity</span>
<span class="cm">		 *</span>
<span class="cm">		 * on == 0 means ofdm weak signal detection is OFF</span>
<span class="cm">		 * on == 0 means more noise imm</span>
<span class="cm">		 */</span>
		<span class="n">u32</span> <span class="n">on</span> <span class="o">=</span> <span class="n">param</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW</span><span class="p">,</span>
				    <span class="n">AR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW</span><span class="p">,</span>
				    <span class="n">AR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span> <span class="o">!=</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;** ch %d: ofdm weak signal: %s=&gt;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="o">!</span><span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span> <span class="o">?</span>
				<span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
				<span class="n">on</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_ofdmon</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_ofdmoff</span><span class="o">++</span><span class="p">;</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span> <span class="o">=</span> <span class="o">!</span><span class="n">on</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_FIRSTEP_LEVEL</span>:<span class="p">{</span>
		<span class="n">u32</span> <span class="n">level</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">firstep_table</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;ATH9K_ANI_FIRSTEP_LEVEL: level out of range (%u &gt; %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">firstep_table</span><span class="p">));</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * make register setting relative to default</span>
<span class="cm">		 * from INI file &amp; cap value</span>
<span class="cm">		 */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">firstep_table</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">-</span>
			<span class="n">firstep_table</span><span class="p">[</span><span class="n">ATH9K_ANI_FIRSTEP_LVL_NEW</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">firstep</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MIN</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MAX</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MAX</span><span class="p">;</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_FIND_SIG</span><span class="p">,</span>
			      <span class="n">AR_PHY_FIND_SIG_FIRSTEP</span><span class="p">,</span>
			      <span class="n">value</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * we need to set first step low register too</span>
<span class="cm">		 * make register setting relative to default</span>
<span class="cm">		 * from INI file &amp; cap value</span>
<span class="cm">		 */</span>
		<span class="n">value2</span> <span class="o">=</span> <span class="n">firstep_table</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">-</span>
			 <span class="n">firstep_table</span><span class="p">[</span><span class="n">ATH9K_ANI_FIRSTEP_LVL_NEW</span><span class="p">]</span> <span class="o">+</span>
			 <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">firstepLow</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value2</span> <span class="o">&lt;</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MIN</span><span class="p">)</span>
			<span class="n">value2</span> <span class="o">=</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value2</span> <span class="o">&gt;</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MAX</span><span class="p">)</span>
			<span class="n">value2</span> <span class="o">=</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MAX</span><span class="p">;</span>

		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_FIND_SIG_LOW</span><span class="p">,</span>
			      <span class="n">AR_PHY_FIND_SIG_LOW_FIRSTEP_LOW</span><span class="p">,</span> <span class="n">value2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;** ch %d: level %d=&gt;%d[def:%d] firstep[level]=%d ini=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span>
				<span class="n">ATH9K_ANI_FIRSTEP_LVL_NEW</span><span class="p">,</span>
				<span class="n">value</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">firstep</span><span class="p">);</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;** ch %d: level %d=&gt;%d[def:%d] firstep_low[level]=%d ini=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span>
				<span class="n">ATH9K_ANI_FIRSTEP_LVL_NEW</span><span class="p">,</span>
				<span class="n">value2</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">firstepLow</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_stepup</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_stepdown</span><span class="o">++</span><span class="p">;</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_SPUR_IMMUNITY_LEVEL</span>:<span class="p">{</span>
		<span class="n">u32</span> <span class="n">level</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cycpwrThr1_table</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;ATH9K_ANI_SPUR_IMMUNITY_LEVEL: level out of range (%u &gt; %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cycpwrThr1_table</span><span class="p">));</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * make register setting relative to default</span>
<span class="cm">		 * from INI file &amp; cap value</span>
<span class="cm">		 */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">cycpwrThr1_table</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">-</span>
			<span class="n">cycpwrThr1_table</span><span class="p">[</span><span class="n">ATH9K_ANI_SPUR_IMMUNE_LVL_NEW</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">cycpwrThr1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MIN</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MAX</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MAX</span><span class="p">;</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING5</span><span class="p">,</span>
			      <span class="n">AR_PHY_TIMING5_CYCPWR_THR1</span><span class="p">,</span>
			      <span class="n">value</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * set AR_PHY_EXT_CCA for extension channel</span>
<span class="cm">		 * make register setting relative to default</span>
<span class="cm">		 * from INI file &amp; cap value</span>
<span class="cm">		 */</span>
		<span class="n">value2</span> <span class="o">=</span> <span class="n">cycpwrThr1_table</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">-</span>
			 <span class="n">cycpwrThr1_table</span><span class="p">[</span><span class="n">ATH9K_ANI_SPUR_IMMUNE_LVL_NEW</span><span class="p">]</span> <span class="o">+</span>
			 <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">cycpwrThr1Ext</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value2</span> <span class="o">&lt;</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MIN</span><span class="p">)</span>
			<span class="n">value2</span> <span class="o">=</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value2</span> <span class="o">&gt;</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MAX</span><span class="p">)</span>
			<span class="n">value2</span> <span class="o">=</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MAX</span><span class="p">;</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_EXT_CCA</span><span class="p">,</span>
			      <span class="n">AR_PHY_EXT_CYCPWR_THR1</span><span class="p">,</span> <span class="n">value2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;** ch %d: level %d=&gt;%d[def:%d] cycpwrThr1[level]=%d ini=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span>
				<span class="n">ATH9K_ANI_SPUR_IMMUNE_LVL_NEW</span><span class="p">,</span>
				<span class="n">value</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">cycpwrThr1</span><span class="p">);</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;** ch %d: level %d=&gt;%d[def:%d] cycpwrThr1Ext[level]=%d ini=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span>
				<span class="n">ATH9K_ANI_SPUR_IMMUNE_LVL_NEW</span><span class="p">,</span>
				<span class="n">value2</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">cycpwrThr1Ext</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_spurup</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_spurdown</span><span class="o">++</span><span class="p">;</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_MRC_CCK</span>:<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * is_on == 1 means MRC CCK ON (default, less noise imm)</span>
<span class="cm">		 * is_on == 0 means MRC CCK is OFF (more noise imm)</span>
<span class="cm">		 */</span>
		<span class="n">bool</span> <span class="n">is_on</span> <span class="o">=</span> <span class="n">param</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MRC_CCK_CTRL</span><span class="p">,</span>
			      <span class="n">AR_PHY_MRC_CCK_ENABLE</span><span class="p">,</span> <span class="n">is_on</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MRC_CCK_CTRL</span><span class="p">,</span>
			      <span class="n">AR_PHY_MRC_CCK_MUX_REG</span><span class="p">,</span> <span class="n">is_on</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_on</span> <span class="o">!=</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">mrcCCKOff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;** ch %d: MRC CCK: %s=&gt;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="o">!</span><span class="n">aniState</span><span class="o">-&gt;</span><span class="n">mrcCCKOff</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
				<span class="n">is_on</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_on</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_ccklow</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_cckhigh</span><span class="o">++</span><span class="p">;</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">mrcCCKOff</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_on</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_PRESENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;invalid cmd %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
		<span class="s">&quot;ANI parameters: SI=%d, ofdmWS=%s FS=%d MRCcck=%s listenTime=%d ofdmErrs=%d cckErrs=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">,</span>
		<span class="o">!</span><span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">,</span>
		<span class="o">!</span><span class="n">aniState</span><span class="o">-&gt;</span><span class="n">mrcCCKOff</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">listenTime</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmPhyErrCount</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">cckPhyErrCount</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_do_getnf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			      <span class="kt">int16_t</span> <span class="n">nfarray</span><span class="p">[</span><span class="n">NUM_NF_READINGS</span><span class="p">])</span>
<span class="p">{</span>
<span class="cp">#define AR_PHY_CH_MINCCA_PWR	0x1FF00000</span>
<span class="cp">#define AR_PHY_CH_MINCCA_PWR_S	20</span>
<span class="cp">#define AR_PHY_CH_EXT_MINCCA_PWR 0x01FF0000</span>
<span class="cp">#define AR_PHY_CH_EXT_MINCCA_PWR_S 16</span>

	<span class="kt">int16_t</span> <span class="n">nf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR9300_MAX_CHAINS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxchainmask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nf</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_regs</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
					 <span class="n">AR_PHY_CH_MINCCA_PWR</span><span class="p">);</span>
			<span class="n">nfarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign_extend32</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HT40</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">ext_idx</span> <span class="o">=</span> <span class="n">AR9300_MAX_CHAINS</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

				<span class="n">nf</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_regs</span><span class="p">[</span><span class="n">ext_idx</span><span class="p">]),</span>
						 <span class="n">AR_PHY_CH_EXT_MINCCA_PWR</span><span class="p">);</span>
				<span class="n">nfarray</span><span class="p">[</span><span class="n">ext_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign_extend32</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_set_nf_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_2g</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_MAX_GOOD_VAL_9300_2GHZ</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_2g</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_MIN_GOOD_VAL_9300_2GHZ</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_2g</span><span class="p">.</span><span class="n">nominal</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_NOM_VAL_9300_2GHZ</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_5g</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_MAX_GOOD_VAL_9300_5GHZ</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_5g</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_MIN_GOOD_VAL_9300_5GHZ</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_5g</span><span class="p">.</span><span class="n">nominal</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_NOM_VAL_9300_5GHZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_2g</span><span class="p">.</span><span class="n">nominal</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_NOM_VAL_9330_2GHZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_2g</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_MIN_GOOD_VAL_9462_2GHZ</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_2g</span><span class="p">.</span><span class="n">nominal</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_NOM_VAL_9462_2GHZ</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_5g</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_MIN_GOOD_VAL_9462_5GHZ</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_5g</span><span class="p">.</span><span class="n">nominal</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_NOM_VAL_9462_5GHZ</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the ANI register values with default (ini) values.</span>
<span class="cm"> * This routine is called during a (full) hardware reset after</span>
<span class="cm"> * all the registers are initialised from the INI.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_ani_cache_ini_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar5416AniState</span> <span class="o">*</span><span class="n">aniState</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_ani_default</span> <span class="o">*</span><span class="n">iniDef</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">aniState</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">;</span>
	<span class="n">iniDef</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;ver %d.%d opmode %u chan %d Mhz/0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span><span class="p">,</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macRev</span><span class="p">,</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">,</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channelFlags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m1Thresh</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_M1_THRESH</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2Thresh</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_M2_THRESH</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2CountThr</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_M2COUNT_THR</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m1ThreshLow</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW_M1_THRESH_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2ThreshLow</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW_M2_THRESH_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2CountThrLow</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW_M2COUNT_THR_LOW</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m1ThreshExt</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT_M1_THRESH</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2ThreshExt</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT_M2_THRESH</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m1ThreshLowExt</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT_M1_THRESH_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2ThreshLowExt</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT_M2_THRESH_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">firstep</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					 <span class="n">AR_PHY_FIND_SIG</span><span class="p">,</span>
					 <span class="n">AR_PHY_FIND_SIG_FIRSTEP</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">firstepLow</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					    <span class="n">AR_PHY_FIND_SIG_LOW</span><span class="p">,</span>
					    <span class="n">AR_PHY_FIND_SIG_LOW_FIRSTEP_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">cycpwrThr1</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					    <span class="n">AR_PHY_TIMING5</span><span class="p">,</span>
					    <span class="n">AR_PHY_TIMING5_CYCPWR_THR1</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">cycpwrThr1Ext</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					       <span class="n">AR_PHY_EXT_CCA</span><span class="p">,</span>
					       <span class="n">AR_PHY_EXT_CYCPWR_THR1</span><span class="p">);</span>

	<span class="cm">/* these levels just got reset to defaults by the INI */</span>
	<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span> <span class="o">=</span> <span class="n">ATH9K_ANI_SPUR_IMMUNE_LVL_NEW</span><span class="p">;</span>
	<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span> <span class="o">=</span> <span class="n">ATH9K_ANI_FIRSTEP_LVL_NEW</span><span class="p">;</span>
	<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span> <span class="o">=</span> <span class="o">!</span><span class="n">ATH9K_ANI_USE_OFDM_WEAK_SIG</span><span class="p">;</span>
	<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">mrcCCKOff</span> <span class="o">=</span> <span class="o">!</span><span class="n">ATH9K_ANI_ENABLE_MRC_CCK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_set_radar_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ath_hw_radar_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">radar_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radar_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_ENA</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">AR_PHY_RADAR_0_ENA</span> <span class="o">|</span> <span class="n">AR_PHY_RADAR_0_FFT_ENA</span><span class="p">;</span>
	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fir_power</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_FIRPWR</span><span class="p">);</span>
	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">radar_rssi</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_RRSSI</span><span class="p">);</span>
	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_height</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_HEIGHT</span><span class="p">);</span>
	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_rssi</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_PRSSI</span><span class="p">);</span>
	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_inband</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_INBAND</span><span class="p">);</span>

	<span class="n">radar_1</span> <span class="o">|=</span> <span class="n">AR_PHY_RADAR_1_MAX_RRSSI</span><span class="p">;</span>
	<span class="n">radar_1</span> <span class="o">|=</span> <span class="n">AR_PHY_RADAR_1_BLOCK_CHECK</span><span class="p">;</span>
	<span class="n">radar_1</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_maxlen</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_1_MAXLEN</span><span class="p">);</span>
	<span class="n">radar_1</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_inband_step</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_1_RELSTEP_THRESH</span><span class="p">);</span>
	<span class="n">radar_1</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">radar_inband</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_1_RELPWR_THRESH</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0</span><span class="p">,</span> <span class="n">radar_0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_1</span><span class="p">,</span> <span class="n">radar_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">ext_channel</span><span class="p">)</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_EXT</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_EXT_ENA</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_EXT</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_EXT_ENA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_set_radar_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw_radar_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">radar_conf</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fir_power</span> <span class="o">=</span> <span class="o">-</span><span class="mi">28</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">radar_rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_height</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_rssi</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_inband</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_maxlen</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_inband_step</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">radar_inband</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_antdiv_comb_conf_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ath_hw_antcomb_conf</span> <span class="o">*</span><span class="n">antconf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>

	<span class="n">regval</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MC_GAIN_CTRL</span><span class="p">);</span>
	<span class="n">antconf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">AR_PHY_9485_ANT_DIV_MAIN_LNACONF</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				  <span class="n">AR_PHY_9485_ANT_DIV_MAIN_LNACONF_S</span><span class="p">;</span>
	<span class="n">antconf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">AR_PHY_9485_ANT_DIV_ALT_LNACONF</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				 <span class="n">AR_PHY_9485_ANT_DIV_ALT_LNACONF_S</span><span class="p">;</span>
	<span class="n">antconf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="n">AR_PHY_9485_ANT_FAST_DIV_BIAS</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				  <span class="n">AR_PHY_9485_ANT_FAST_DIV_BIAS_S</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9330_11</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">antconf</span><span class="o">-&gt;</span><span class="n">lna1_lna2_delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span><span class="p">;</span>
		<span class="n">antconf</span><span class="o">-&gt;</span><span class="n">div_group</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">antconf</span><span class="o">-&gt;</span><span class="n">lna1_lna2_delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9</span><span class="p">;</span>
		<span class="n">antconf</span><span class="o">-&gt;</span><span class="n">div_group</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">antconf</span><span class="o">-&gt;</span><span class="n">lna1_lna2_delta</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">antconf</span><span class="o">-&gt;</span><span class="n">div_group</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_hw_antdiv_comb_conf_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ath_hw_antcomb_conf</span> <span class="o">*</span><span class="n">antconf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>

	<span class="n">regval</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MC_GAIN_CTRL</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AR_PHY_9485_ANT_DIV_MAIN_LNACONF</span> <span class="o">|</span>
		    <span class="n">AR_PHY_9485_ANT_DIV_ALT_LNACONF</span> <span class="o">|</span>
		    <span class="n">AR_PHY_9485_ANT_FAST_DIV_BIAS</span> <span class="o">|</span>
		    <span class="n">AR_PHY_9485_ANT_DIV_MAIN_GAINTB</span> <span class="o">|</span>
		    <span class="n">AR_PHY_9485_ANT_DIV_ALT_GAINTB</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">|=</span> <span class="p">((</span><span class="n">antconf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">&lt;&lt;</span>
					<span class="n">AR_PHY_9485_ANT_DIV_MAIN_LNACONF_S</span><span class="p">)</span>
		   <span class="o">&amp;</span> <span class="n">AR_PHY_9485_ANT_DIV_MAIN_LNACONF</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">|=</span> <span class="p">((</span><span class="n">antconf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">&lt;&lt;</span> <span class="n">AR_PHY_9485_ANT_DIV_ALT_LNACONF_S</span><span class="p">)</span>
		   <span class="o">&amp;</span> <span class="n">AR_PHY_9485_ANT_DIV_ALT_LNACONF</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">|=</span> <span class="p">((</span><span class="n">antconf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">&lt;&lt;</span> <span class="n">AR_PHY_9485_ANT_FAST_DIV_BIAS_S</span><span class="p">)</span>
		   <span class="o">&amp;</span> <span class="n">AR_PHY_9485_ANT_FAST_DIV_BIAS</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">|=</span> <span class="p">((</span><span class="n">antconf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">&lt;&lt;</span> <span class="n">AR_PHY_9485_ANT_DIV_MAIN_GAINTB_S</span><span class="p">)</span>
		   <span class="o">&amp;</span> <span class="n">AR_PHY_9485_ANT_DIV_MAIN_GAINTB</span><span class="p">);</span>
	<span class="n">regval</span> <span class="o">|=</span> <span class="p">((</span><span class="n">antconf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">&lt;&lt;</span> <span class="n">AR_PHY_9485_ANT_DIV_ALT_GAINTB_S</span><span class="p">)</span>
		   <span class="o">&amp;</span> <span class="n">AR_PHY_9485_ANT_DIV_ALT_GAINTB</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MC_GAIN_CTRL</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ar9003_hw_fast_chan_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				      <span class="n">u8</span> <span class="o">*</span><span class="n">ini_reloaded</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regWrites</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">modesIndex</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chanmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHANNEL_A</span>:
	<span class="k">case</span> <span class="n">CHANNEL_A_HT20</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_A_HT40PLUS</span>:
	<span class="k">case</span> <span class="n">CHANNEL_A_HT40MINUS</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_G</span>:
	<span class="k">case</span> <span class="n">CHANNEL_G_HT20</span>:
	<span class="k">case</span> <span class="n">CHANNEL_B</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_G_HT40PLUS</span>:
	<span class="k">case</span> <span class="n">CHANNEL_G_HT40MINUS</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modesIndex</span> <span class="o">==</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">modes_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ini_reloaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">set_rfmode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar9003_hw_prog_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniSOC</span><span class="p">[</span><span class="n">ATH_INI_POST</span><span class="p">],</span> <span class="n">modesIndex</span><span class="p">);</span>
	<span class="n">ar9003_hw_prog_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniMac</span><span class="p">[</span><span class="n">ATH_INI_POST</span><span class="p">],</span> <span class="n">modesIndex</span><span class="p">);</span>
	<span class="n">ar9003_hw_prog_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBB</span><span class="p">[</span><span class="n">ATH_INI_POST</span><span class="p">],</span> <span class="n">modesIndex</span><span class="p">);</span>
	<span class="n">ar9003_hw_prog_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniRadio</span><span class="p">[</span><span class="n">ATH_INI_POST</span><span class="p">],</span> <span class="n">modesIndex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462_20</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ar9003_hw_prog_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ini_radio_post_sys2ant</span><span class="p">,</span>
				<span class="n">modesIndex</span><span class="p">);</span>

	<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span> <span class="n">modesIndex</span><span class="p">,</span> <span class="n">regWrites</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For 5GHz channels requiring Fast Clock, apply</span>
<span class="cm">	 * different modal values.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_A_FAST_CLOCK</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
		<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesFastClock</span><span class="p">,</span> <span class="n">modesIndex</span><span class="p">,</span> <span class="n">regWrites</span><span class="p">);</span>

	<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniAdditional</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regWrites</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">modes_index</span> <span class="o">=</span> <span class="n">modesIndex</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ini_reloaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">set_rfmode:</span>
	<span class="n">ar9003_hw_set_rfmode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ar9003_hw_attach_phy_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw_private_ops</span> <span class="o">*</span><span class="n">priv_ops</span> <span class="o">=</span> <span class="n">ath9k_hw_private_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_hw_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ath9k_hw_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ar9300_cca_regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">AR_PHY_CCA_0</span><span class="p">,</span>
		<span class="n">AR_PHY_CCA_1</span><span class="p">,</span>
		<span class="n">AR_PHY_CCA_2</span><span class="p">,</span>
		<span class="n">AR_PHY_EXT_CCA</span><span class="p">,</span>
		<span class="n">AR_PHY_EXT_CCA_1</span><span class="p">,</span>
		<span class="n">AR_PHY_EXT_CCA_2</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">rf_set_freq</span> <span class="o">=</span> <span class="n">ar9003_hw_set_channel</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">spur_mitigate_freq</span> <span class="o">=</span> <span class="n">ar9003_hw_spur_mitigate</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">compute_pll_control</span> <span class="o">=</span> <span class="n">ar9003_hw_compute_pll_control</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">set_channel_regs</span> <span class="o">=</span> <span class="n">ar9003_hw_set_channel_regs</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">init_bb</span> <span class="o">=</span> <span class="n">ar9003_hw_init_bb</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">process_ini</span> <span class="o">=</span> <span class="n">ar9003_hw_process_ini</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">set_rfmode</span> <span class="o">=</span> <span class="n">ar9003_hw_set_rfmode</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">mark_phy_inactive</span> <span class="o">=</span> <span class="n">ar9003_hw_mark_phy_inactive</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">set_delta_slope</span> <span class="o">=</span> <span class="n">ar9003_hw_set_delta_slope</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">rfbus_req</span> <span class="o">=</span> <span class="n">ar9003_hw_rfbus_req</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">rfbus_done</span> <span class="o">=</span> <span class="n">ar9003_hw_rfbus_done</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">ani_control</span> <span class="o">=</span> <span class="n">ar9003_hw_ani_control</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">do_getnf</span> <span class="o">=</span> <span class="n">ar9003_hw_do_getnf</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">ani_cache_ini_regs</span> <span class="o">=</span> <span class="n">ar9003_hw_ani_cache_ini_regs</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">set_radar_params</span> <span class="o">=</span> <span class="n">ar9003_hw_set_radar_params</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">fast_chan_change</span> <span class="o">=</span> <span class="n">ar9003_hw_fast_chan_change</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">antdiv_comb_conf_get</span> <span class="o">=</span> <span class="n">ar9003_hw_antdiv_comb_conf_get</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">antdiv_comb_conf_set</span> <span class="o">=</span> <span class="n">ar9003_hw_antdiv_comb_conf_set</span><span class="p">;</span>

	<span class="n">ar9003_hw_set_nf_limits</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ar9003_hw_set_radar_conf</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_regs</span><span class="p">,</span> <span class="n">ar9300_cca_regs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_regs</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ar9003_hw_bb_watchdog_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">idle_tmo_ms</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bb_watchdog_timeout_ms</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">idle_count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idle_tmo_ms</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable IRQ, disable chip-reset for BB panic */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_CTL_2</span><span class="p">,</span>
			  <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_CTL_2</span><span class="p">)</span> <span class="o">&amp;</span>
			  <span class="o">~</span><span class="p">(</span><span class="n">AR_PHY_WATCHDOG_RST_ENABLE</span> <span class="o">|</span>
			    <span class="n">AR_PHY_WATCHDOG_IRQ_ENABLE</span><span class="p">));</span>

		<span class="cm">/* disable watchdog in non-IDLE mode, disable in IDLE mode */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_CTL_1</span><span class="p">,</span>
			  <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_CTL_1</span><span class="p">)</span> <span class="o">&amp;</span>
			  <span class="o">~</span><span class="p">(</span><span class="n">AR_PHY_WATCHDOG_NON_IDLE_ENABLE</span> <span class="o">|</span>
			    <span class="n">AR_PHY_WATCHDOG_IDLE_ENABLE</span><span class="p">));</span>

		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;Disabled BB Watchdog</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enable IRQ, disable chip-reset for BB watchdog */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_CTL_2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR_PHY_WATCHDOG_CNTL2_MASK</span><span class="p">;</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_CTL_2</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">AR_PHY_WATCHDOG_IRQ_ENABLE</span><span class="p">)</span> <span class="o">&amp;</span>
		  <span class="o">~</span><span class="n">AR_PHY_WATCHDOG_RST_ENABLE</span><span class="p">);</span>

	<span class="cm">/* bound limit to 10 secs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idle_tmo_ms</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span>
		<span class="n">idle_tmo_ms</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The time unit for watchdog event is 2^15 44/88MHz cycles.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For HT20 we have a time unit of 2^15/44 MHz = .74 ms per tick</span>
<span class="cm">	 * For HT40 we have a time unit of 2^15/88 MHz = .37 ms per tick</span>
<span class="cm">	 *</span>
<span class="cm">	 * Given we use fast clock now in 5 GHz, these time units should</span>
<span class="cm">	 * be common for both 2 GHz and 5 GHz.</span>
<span class="cm">	 */</span>
	<span class="n">idle_count</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">idle_tmo_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mi">74</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">&amp;&amp;</span> <span class="n">IS_CHAN_HT40</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">))</span>
		<span class="n">idle_count</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">idle_tmo_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mi">37</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * enable watchdog in non-IDLE mode, disable in IDLE mode,</span>
<span class="cm">	 * set idle time-out.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_CTL_1</span><span class="p">,</span>
		  <span class="n">AR_PHY_WATCHDOG_NON_IDLE_ENABLE</span> <span class="o">|</span>
		  <span class="n">AR_PHY_WATCHDOG_IDLE_MASK</span> <span class="o">|</span>
		  <span class="p">(</span><span class="n">AR_PHY_WATCHDOG_NON_IDLE_MASK</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">idle_count</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)));</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;Enabled BB Watchdog timeout (%u ms)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">idle_tmo_ms</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ar9003_hw_bb_watchdog_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * we want to avoid printing in ISR context so we save the</span>
<span class="cm">	 * watchdog status to be printed later in bottom half context.</span>
<span class="cm">	 */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bb_watchdog_last_status</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_STATUS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * the watchdog timer should reset on status read but to be sure</span>
<span class="cm">	 * sure we write 0 to the watchdog status bit.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_STATUS</span><span class="p">,</span>
		  <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bb_watchdog_last_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AR_PHY_WATCHDOG_STATUS_CLR</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ar9003_hw_bb_watchdog_dbg_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">debug_mask</span> <span class="o">&amp;</span> <span class="n">ATH_DBG_RESET</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bb_watchdog_last_status</span><span class="p">;</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span>
		<span class="s">&quot;</span><span class="se">\n</span><span class="s">==== BB update: BB status=0x%08x ====</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span>
		<span class="s">&quot;** BB state: wd=%u det=%u rdar=%u rOFDM=%d rCCK=%u tOFDM=%u tCCK=%u agc=%u src=%u **</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">MS</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_INFO</span><span class="p">),</span>
		<span class="n">MS</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_DET_HANG</span><span class="p">),</span>
		<span class="n">MS</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_RADAR_SM</span><span class="p">),</span>
		<span class="n">MS</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_RX_OFDM_SM</span><span class="p">),</span>
		<span class="n">MS</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_RX_CCK_SM</span><span class="p">),</span>
		<span class="n">MS</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_TX_OFDM_SM</span><span class="p">),</span>
		<span class="n">MS</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_TX_CCK_SM</span><span class="p">),</span>
		<span class="n">MS</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_AGC_SM</span><span class="p">),</span>
		<span class="n">MS</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_SRCH_SM</span><span class="p">));</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;** BB WD cntl: cntl1=0x%08x cntl2=0x%08x **</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_CTL_1</span><span class="p">),</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_WATCHDOG_CTL_2</span><span class="p">));</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;** BB mode: BB_gen_controls=0x%08x **</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_GEN_CTRL</span><span class="p">));</span>

<span class="cp">#define PCT(_field) (common-&gt;cc_survey._field * 100 / common-&gt;cc_survey.cycles)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_survey</span><span class="p">.</span><span class="n">cycles</span><span class="p">)</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span>
			<span class="s">&quot;** BB busy times: rx_clear=%d%%, rx_frame=%d%%, tx_frame=%d%% **</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PCT</span><span class="p">(</span><span class="n">rx_busy</span><span class="p">),</span> <span class="n">PCT</span><span class="p">(</span><span class="n">rx_frame</span><span class="p">),</span> <span class="n">PCT</span><span class="p">(</span><span class="n">tx_frame</span><span class="p">));</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;==== BB update: done ====</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ar9003_hw_bb_watchdog_dbg_info</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ar9003_hw_disable_phy_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* While receiving unsupported rate frame rx state machine</span>
<span class="cm">	 * gets into a state 0xb and if phy_restart happens in that</span>
<span class="cm">	 * state, BB would go hang. If RXSM is in 0xb state after</span>
<span class="cm">	 * first bb panic, ensure to disable the phy_restart.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">MS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bb_watchdog_last_status</span><span class="p">,</span>
		  <span class="n">AR_PHY_WATCHDOG_RX_OFDM_SM</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xb</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">bb_hang_rx_ofdm</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bb_hang_rx_ofdm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RESTART</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR_PHY_RESTART_ENA</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RESTART</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ar9003_hw_disable_phy_restart</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
