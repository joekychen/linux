<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › htc_drv_txrx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>htc_drv_txrx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;htc.h&quot;</span>

<span class="cm">/******/</span>
<span class="cm">/* TX */</span>
<span class="cm">/******/</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">subtype_txq_to_hwq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">WME_AC_BE</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATH_TXQ_AC_BE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">WME_AC_BK</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATH_TXQ_AC_BK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">WME_AC_VI</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATH_TXQ_AC_VI</span><span class="p">,</span>
	<span class="p">[</span><span class="n">WME_AC_VO</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATH_TXQ_AC_VO</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define ATH9K_HTC_INIT_TXQ(subtype) do {			\</span>
<span class="cp">		qi.tqi_subtype = subtype_txq_to_hwq[subtype];	\</span>
<span class="cp">		qi.tqi_aifs = ATH9K_TXQ_USEDEFAULT;		\</span>
<span class="cp">		qi.tqi_cwmin = ATH9K_TXQ_USEDEFAULT;		\</span>
<span class="cp">		qi.tqi_cwmax = ATH9K_TXQ_USEDEFAULT;		\</span>
<span class="cp">		qi.tqi_physCompBuf = 0;				\</span>
<span class="cp">		qi.tqi_qflags = TXQ_FLAG_TXEOLINT_ENABLE |	\</span>
<span class="cp">			TXQ_FLAG_TXDESCINT_ENABLE;		\</span>
<span class="cp">	} while (0)</span>

<span class="kt">int</span> <span class="nf">get_hw_qnum</span><span class="p">(</span><span class="n">u16</span> <span class="n">queue</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">hwq_map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">hwq_map</span><span class="p">[</span><span class="n">WME_AC_VO</span><span class="p">];</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">hwq_map</span><span class="p">[</span><span class="n">WME_AC_VI</span><span class="p">];</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">hwq_map</span><span class="p">[</span><span class="n">WME_AC_BE</span><span class="p">];</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">hwq_map</span><span class="p">[</span><span class="n">WME_AC_BK</span><span class="p">];</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">hwq_map</span><span class="p">[</span><span class="n">WME_AC_BE</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_check_stop_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">queued_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">queued_cnt</span> <span class="o">&gt;=</span> <span class="n">ATH9K_HTC_TX_THRESHOLD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_HTC_OP_TX_QUEUES_STOP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_HTC_OP_TX_QUEUES_STOP</span><span class="p">;</span>
		<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_check_wake_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">queued_cnt</span> <span class="o">&lt;</span> <span class="n">ATH9K_HTC_TX_THRESHOLD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_HTC_OP_TX_QUEUES_STOP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_HTC_OP_TX_QUEUES_STOP</span><span class="p">;</span>
		<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_htc_tx_get_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_slot</span><span class="p">,</span> <span class="n">MAX_TX_BUF_NUM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&gt;=</span> <span class="n">MAX_TX_BUF_NUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_slot</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">slot</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_tx_clear_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_slot</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="nf">get_htc_epid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
						<span class="n">u16</span> <span class="n">qnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">epid</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qnum</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">TX_QSTAT_INC</span><span class="p">(</span><span class="n">WME_AC_VO</span><span class="p">);</span>
		<span class="n">epid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vo_ep</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">TX_QSTAT_INC</span><span class="p">(</span><span class="n">WME_AC_VI</span><span class="p">);</span>
		<span class="n">epid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vi_ep</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">TX_QSTAT_INC</span><span class="p">(</span><span class="n">WME_AC_BE</span><span class="p">);</span>
		<span class="n">epid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_be_ep</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
	<span class="nl">default:</span>
		<span class="n">TX_QSTAT_INC</span><span class="p">(</span><span class="n">WME_AC_BK</span><span class="p">);</span>
		<span class="n">epid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_bk_ep</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">epid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">sk_buff_head</span><span class="o">*</span>
<span class="nf">get_htc_epid_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">epid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">epid_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mgmt_ep</span><span class="p">)</span>
		<span class="n">epid_queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">mgmt_ep_queue</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cab_ep</span><span class="p">)</span>
		<span class="n">epid_queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cab_ep_queue</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_be_ep</span><span class="p">)</span>
		<span class="n">epid_queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_be_queue</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_bk_ep</span><span class="p">)</span>
		<span class="n">epid_queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_bk_queue</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vi_ep</span><span class="p">)</span>
		<span class="n">epid_queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_vi_queue</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vo_ep</span><span class="p">)</span>
		<span class="n">epid_queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_vo_queue</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Invalid EPID: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">epid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">epid_queue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Removes the driver header and returns the TX slot number</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">strip_drv_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_tx_ctl</span> <span class="o">*</span><span class="n">tx_ctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">tx_ctl</span> <span class="o">=</span> <span class="n">HTC_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mgmt_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_mgmt_hdr</span> <span class="o">*</span><span class="n">tx_mhdr</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">tx_mgmt_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">tx_mhdr</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_mgmt_hdr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_bk_ep</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_be_ep</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vi_ep</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vo_ep</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cab_ep</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_frame_hdr</span> <span class="o">*</span><span class="n">tx_fhdr</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">tx_frame_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="n">tx_fhdr</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_frame_hdr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unsupported EPID: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">epid</span><span class="p">);</span>
		<span class="n">slot</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">slot</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath_htc_txq_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qnum</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span> <span class="o">*</span><span class="n">qinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span> <span class="n">qi</span><span class="p">;</span>

	<span class="n">ath9k_hw_get_txq_props</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">qnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>

	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_aifs</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_aifs</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cwmin</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_cwmin</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* XXX */</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cwmax</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_cwmax</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_burstTime</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_burstTime</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_readyTime</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_readyTime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_set_txq_props</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">qnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span>
			<span class="s">&quot;Unable to update hardware queue %u!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qnum</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath9k_hw_resettxqueue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">qnum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_tx_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ath9k_htc_vif</span> <span class="o">*</span><span class="n">avp</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">sta_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">vif_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_mgmt_hdr</span> <span class="n">mgmt_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_tx_ctl</span> <span class="o">*</span><span class="n">tx_ctl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tx_fhdr</span><span class="p">;</span>

	<span class="n">tx_ctl</span> <span class="o">=</span> <span class="n">HTC_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tx_ctl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ctl</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgmt_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_mgmt_hdr</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the TSF adjust value for probe response</span>
<span class="cm">	 * frame also.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avp</span> <span class="o">&amp;&amp;</span> <span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">probe_resp</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">tsfadjust</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ATH9K_HTC_MGMT</span><span class="p">;</span>

	<span class="n">mgmt_hdr</span><span class="p">.</span><span class="n">node_idx</span> <span class="o">=</span> <span class="n">sta_idx</span><span class="p">;</span>
	<span class="n">mgmt_hdr</span><span class="p">.</span><span class="n">vif_idx</span> <span class="o">=</span> <span class="n">vif_idx</span><span class="p">;</span>
	<span class="n">mgmt_hdr</span><span class="p">.</span><span class="n">tidno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mgmt_hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mgmt_hdr</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">mgmt_hdr</span><span class="p">.</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">ath9k_cmn_get_hw_crypto_keytype</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt_hdr</span><span class="p">.</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">ATH9K_KEY_TYPE_CLEAR</span><span class="p">)</span>
		<span class="n">mgmt_hdr</span><span class="p">.</span><span class="n">keyix</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">ATH9K_TXKEYIX_INVALID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mgmt_hdr</span><span class="p">.</span><span class="n">keyix</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">;</span>

	<span class="n">tx_fhdr</span> <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt_hdr</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_fhdr</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">mgmt_hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt_hdr</span><span class="p">));</span>
	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">epid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mgmt_ep</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_tx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">sta_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">vif_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">slot</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">is_cab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_tx_ctl</span> <span class="o">*</span><span class="n">tx_ctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_frame_hdr</span> <span class="n">tx_hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span><span class="p">,</span> <span class="o">*</span><span class="n">tx_fhdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">qnum</span><span class="p">;</span>

	<span class="n">tx_ctl</span> <span class="o">=</span> <span class="n">HTC_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tx_ctl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_ctl</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_frame_hdr</span><span class="p">));</span>

	<span class="n">tx_hdr</span><span class="p">.</span><span class="n">node_idx</span> <span class="o">=</span> <span class="n">sta_idx</span><span class="p">;</span>
	<span class="n">tx_hdr</span><span class="p">.</span><span class="n">vif_idx</span> <span class="o">=</span> <span class="n">vif_idx</span><span class="p">;</span>
	<span class="n">tx_hdr</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is a bit redundant but it helps to get</span>
<span class="cm">	 * the per-packet index quickly when draining the</span>
<span class="cm">	 * TX queue in the HIF layer. Otherwise we would</span>
<span class="cm">	 * have to parse the packet contents ...</span>
<span class="cm">	 */</span>
	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">sta_idx</span> <span class="o">=</span> <span class="n">sta_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ATH9K_HTC_AMPDU</span><span class="p">;</span>
		<span class="n">tx_hdr</span><span class="p">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">ATH9K_HTC_AMPDU</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ATH9K_HTC_NORMAL</span><span class="p">;</span>
		<span class="n">tx_hdr</span><span class="p">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">ATH9K_HTC_NORMAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">tx_hdr</span><span class="p">.</span><span class="n">tidno</span> <span class="o">=</span> <span class="n">qc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for RTS protection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_HTC_TX_RTSCTS</span><span class="p">;</span>

	<span class="cm">/* CTS-to-self */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_HTC_TX_RTSCTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_cts_prot</span><span class="p">))</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_HTC_TX_CTSONLY</span><span class="p">;</span>

	<span class="n">tx_hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tx_hdr</span><span class="p">.</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">ath9k_cmn_get_hw_crypto_keytype</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_hdr</span><span class="p">.</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">ATH9K_KEY_TYPE_CLEAR</span><span class="p">)</span>
		<span class="n">tx_hdr</span><span class="p">.</span><span class="n">keyix</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">ATH9K_TXKEYIX_INVALID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tx_hdr</span><span class="p">.</span><span class="n">keyix</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">;</span>

	<span class="n">tx_fhdr</span> <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_hdr</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_fhdr</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tx_hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_hdr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_cab</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CAB_STAT_INC</span><span class="p">;</span>
		<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">epid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cab_ep</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">qnum</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">epid</span> <span class="o">=</span> <span class="n">get_htc_epid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">qnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_htc_tx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		       <span class="n">u8</span> <span class="n">slot</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_cab</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="n">ista</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_vif</span> <span class="o">*</span><span class="n">avp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_idx</span><span class="p">,</span> <span class="n">vif_idx</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find out on which interface this packet has to be</span>
<span class="cm">	 * sent out.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">avp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_vif</span> <span class="o">*</span><span class="p">)</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
		<span class="n">vif_idx</span> <span class="o">=</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">),</span> <span class="n">XMIT</span><span class="p">,</span>
				<span class="s">&quot;VIF is null, but no monitor interface !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vif_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mon_vif_idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find out which station this packet is destined for.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ista</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
		<span class="n">sta_idx</span> <span class="o">=</span> <span class="n">ista</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sta_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_sta_pos</span><span class="p">[</span><span class="n">vif_idx</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">ath9k_htc_tx_data</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				  <span class="n">sta_idx</span><span class="p">,</span> <span class="n">vif_idx</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="n">is_cab</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ath9k_htc_tx_mgmt</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">avp</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
				  <span class="n">sta_idx</span><span class="p">,</span> <span class="n">vif_idx</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>


	<span class="k">return</span> <span class="n">htc_send</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">__ath9k_htc_check_tx_aggr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="n">ista</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tid</span> <span class="o">&lt;</span> <span class="n">ATH9K_HTC_MAX_TID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ista</span><span class="o">-&gt;</span><span class="n">tid_state</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">==</span> <span class="n">AGGR_STOP</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_check_tx_aggr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="n">ieee80211_find_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">conf_is_ht</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_PAE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span><span class="p">,</span> <span class="n">tid</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="n">ista</span><span class="p">;</span>

			<span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
			<span class="n">tid</span> <span class="o">=</span> <span class="n">qc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">ista</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">__ath9k_htc_check_tx_aggr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ista</span><span class="p">,</span> <span class="n">tid</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ieee80211_start_tx_ba_session</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
				<span class="n">ista</span><span class="o">-&gt;</span><span class="n">tid_state</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">AGGR_PROGRESS</span><span class="p">;</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_tx_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">__wmi_event_txstatus</span> <span class="o">*</span><span class="n">txs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_tx_ctl</span> <span class="o">*</span><span class="n">tx_ctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">cur_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">txok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">strip_drv_header</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_ctl</span> <span class="o">=</span> <span class="n">HTC_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">txok</span> <span class="o">=</span> <span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">txok</span><span class="p">;</span>
	<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">vif</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * URB submission failed for this frame, it never reached</span>
<span class="cm">	 * the target.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txok</span> <span class="o">||</span> <span class="o">!</span><span class="n">vif</span> <span class="o">||</span> <span class="o">!</span><span class="n">txs</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">send_mac80211</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">ts_flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_HTC_TXSTAT_ACK</span><span class="p">)</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">ts_flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_HTC_TXSTAT_FILT</span><span class="p">)</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_TX_FILTERED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">ts_flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_HTC_TXSTAT_RTC_CTS</span><span class="p">)</span>
		<span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span><span class="p">;</span>

	<span class="n">rate</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rate</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">ts_rate</span><span class="p">,</span> <span class="n">ATH9K_HTC_TXSTAT_RATE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">ts_flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_HTC_TXSTAT_MCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">ts_flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_HTC_TXSTAT_CW40</span><span class="p">)</span>
			<span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">ts_flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_HTC_TXSTAT_SGI</span><span class="p">)</span>
			<span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">rate</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* No CCK rates */</span>
	<span class="p">}</span>

	<span class="n">ath9k_htc_check_tx_aggr</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="nl">send_mac80211:</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">--</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">queued_cnt</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">queued_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">ath9k_htc_tx_clear_slot</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>

	<span class="cm">/* Send status to mac80211 */</span>
	<span class="n">ieee80211_tx_status</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ath9k_htc_tx_drainq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath9k_htc_tx_process</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_tx_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_tx_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_HTC_OP_TX_DRAIN</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ensure that all pending TX frames are flushed,</span>
<span class="cm">	 * and that the TX completion/failed tasklets is killed.</span>
<span class="cm">	 */</span>
	<span class="n">htc_stop</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">wmi_event_tasklet</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_failed_tasklet</span><span class="p">);</span>

	<span class="n">ath9k_htc_tx_drainq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">mgmt_ep_queue</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_drainq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cab_ep_queue</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_drainq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_be_queue</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_drainq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_bk_queue</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_drainq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_vi_queue</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_drainq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_vo_queue</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_drainq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_failed</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The TX cleanup timer has already been killed.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">pending_tx_events</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_HTC_OP_TX_DRAIN</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_tx_failed_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_HTC_OP_TX_DRAIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">ath9k_htc_tx_drainq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_failed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">check_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">u8</span> <span class="n">epid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">fcookie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mgmt_ep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_mgmt_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_mgmt_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">fcookie</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_bk_ep</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_be_ep</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vi_ep</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vo_ep</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">epid</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cab_ep</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tx_frame_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_frame_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">fcookie</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fcookie</span> <span class="o">==</span> <span class="n">cookie</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="nf">ath9k_htc_tx_get_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">__wmi_event_txstatus</span> <span class="o">*</span><span class="n">txs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">epid_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">epid</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">ts_rate</span><span class="p">,</span> <span class="n">ATH9K_HTC_TXSTAT_EPID</span><span class="p">);</span>

	<span class="n">epid_queue</span> <span class="o">=</span> <span class="n">get_htc_epid_queue</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">epid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epid_queue</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epid_queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">skb_queue_walk_safe</span><span class="p">(</span><span class="n">epid_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_cookie</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">txs</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span> <span class="n">epid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">epid_queue</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epid_queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epid_queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;No matching packet for cookie: %d, epid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">txs</span><span class="o">-&gt;</span><span class="n">cookie</span><span class="p">,</span> <span class="n">epid</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_txstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">wmi_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_event_txstatus</span> <span class="o">*</span><span class="n">txs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_event_txstatus</span> <span class="o">*</span><span class="p">)</span><span class="n">wmi_event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">__wmi_event_txstatus</span> <span class="o">*</span><span class="n">__txs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_tx_event</span> <span class="o">*</span><span class="n">tx_pend</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">txs</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">HTC_MAX_TX_STATUS</span><span class="p">);</span>

		<span class="n">__txs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txs</span><span class="o">-&gt;</span><span class="n">txstatus</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">ath9k_htc_tx_get_packet</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">__txs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Store this event, so that the TX cleanup</span>
<span class="cm">			 * routine can check later for the needed packet.</span>
<span class="cm">			 */</span>
			<span class="n">tx_pend</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_tx_event</span><span class="p">),</span>
					  <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_pend</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pend</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">,</span> <span class="n">__txs</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">__wmi_event_txstatus</span><span class="p">));</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pend</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">pending_tx_events</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>

			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ath9k_htc_tx_process</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">__txs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Wake TX queues if needed */</span>
	<span class="n">ath9k_htc_check_wake_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_txep</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">drv_priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		    <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">ep_id</span><span class="p">,</span> <span class="n">bool</span> <span class="n">txok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span> <span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_tx_ctl</span> <span class="o">*</span><span class="n">tx_ctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">epid_queue</span><span class="p">;</span>

	<span class="n">tx_ctl</span> <span class="o">=</span> <span class="n">HTC_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">txok</span> <span class="o">=</span> <span class="n">txok</span><span class="p">;</span>
	<span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_failed</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_failed_tasklet</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">epid_queue</span> <span class="o">=</span> <span class="n">get_htc_epid_queue</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ep_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epid_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="n">epid_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">check_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_tx_ctl</span> <span class="o">*</span><span class="n">tx_ctl</span><span class="p">;</span>

	<span class="n">tx_ctl</span> <span class="o">=</span> <span class="n">HTC_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
		       <span class="n">tx_ctl</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">+</span>
		       <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH9K_HTC_TX_TIMEOUT_INTERVAL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;Dropping a packet due to TX timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_tx_cleanup_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">epid_queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">process</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">queue</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epid_queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">skb_queue_walk_safe</span><span class="p">(</span><span class="n">epid_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_packet</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">epid_queue</span><span class="p">);</span>
			<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">process</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epid_queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">process</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_walk_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
			<span class="n">ath9k_htc_tx_process</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_tx_cleanup_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_tx_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">pending_tx_events</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">ath9k_htc_tx_get_packet</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span>
				<span class="s">&quot;Found packet for cookie: %d, epid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">event</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">.</span><span class="n">cookie</span><span class="p">,</span>
				<span class="n">MS</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">.</span><span class="n">ts_rate</span><span class="p">,</span> <span class="n">ATH9K_HTC_TXSTAT_EPID</span><span class="p">));</span>

			<span class="n">ath9k_htc_tx_process</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">txs</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">ATH9K_HTC_TX_TIMEOUT_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">event_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if status-pending packets have to be cleaned up.</span>
<span class="cm">	 */</span>
	<span class="n">ath9k_htc_tx_cleanup_queue</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">mgmt_ep_queue</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_cleanup_queue</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cab_ep_queue</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_cleanup_queue</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_be_queue</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_cleanup_queue</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_bk_queue</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_cleanup_queue</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_vi_queue</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_cleanup_queue</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_vo_queue</span><span class="p">);</span>

	<span class="cm">/* Wake TX queues if needed */</span>
	<span class="n">ath9k_htc_check_wake_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cleanup_timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH9K_HTC_TX_CLEANUP_INTERVAL</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_tx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">mgmt_ep_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cab_ep_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_be_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_bk_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_vi_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">data_vo_queue</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_failed</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_tx_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ath9k_htc_txq_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span> <span class="n">qi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qnum</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qi</span><span class="p">));</span>
	<span class="n">ATH9K_HTC_INIT_TXQ</span><span class="p">(</span><span class="n">subtype</span><span class="p">);</span>

	<span class="n">qnum</span> <span class="o">=</span> <span class="n">ath9k_hw_setuptxqueue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_TX_QUEUE_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qnum</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qnum</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwq_map</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;qnum %u out of range, max %zu!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">qnum</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwq_map</span><span class="p">));</span>
		<span class="n">ath9k_hw_releasetxqueue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">qnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwq_map</span><span class="p">[</span><span class="n">subtype</span><span class="p">]</span> <span class="o">=</span> <span class="n">qnum</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_htc_cabq_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span> <span class="n">qi</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qi</span><span class="p">));</span>
	<span class="n">ATH9K_HTC_INIT_TXQ</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ath9k_hw_setuptxqueue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_TX_QUEUE_CAB</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******/</span>
<span class="cm">/* RX */</span>
<span class="cm">/******/</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate the RX filter to be set in the HW.</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">ath9k_htc_calcrxfilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define	RX_FILTER_PRESERVE (ATH9K_RX_FILTER_PHYERR | ATH9K_RX_FILTER_PHYRADAR)</span>

	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rfilt</span><span class="p">;</span>

	<span class="n">rfilt</span> <span class="o">=</span> <span class="p">(</span><span class="n">ath9k_hw_getrxfilter</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_FILTER_PRESERVE</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">ATH9K_RX_FILTER_UCAST</span> <span class="o">|</span> <span class="n">ATH9K_RX_FILTER_BCAST</span>
		<span class="o">|</span> <span class="n">ATH9K_RX_FILTER_MCAST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">&amp;</span> <span class="n">FIF_PROBE_REQ</span><span class="p">)</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_PROBEREQ</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set promiscuous mode when FIF_PROMISC_IN_BSS is enabled for station</span>
<span class="cm">	 * mode interface or when in monitor mode. AP mode does not need this</span>
<span class="cm">	 * since it receives all in-BSS frames anyway.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">&amp;</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span><span class="p">)</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_PROM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">)</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_CONTROL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nvifs</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">))</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_MYBEACON</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_BEACON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_COMP_BAR</span><span class="p">;</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_UNCOMP_BA_BAR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">&amp;</span> <span class="n">FIF_PSPOLL</span><span class="p">)</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_PSPOLL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nvifs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_MCAST_BCAST_ALL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rfilt</span><span class="p">;</span>

<span class="cp">#undef RX_FILTER_PRESERVE</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Recv initialization for opmode change.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_opmode_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rfilt</span><span class="p">,</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* configure rx filter */</span>
	<span class="n">rfilt</span> <span class="o">=</span> <span class="n">ath9k_htc_calcrxfilter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_hw_setrxfilter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">rfilt</span><span class="p">);</span>

	<span class="cm">/* calculate and install multicast filter */</span>
	<span class="n">mfilt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">ath9k_hw_setmcastfilter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_host_rx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath9k_hw_rxena</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_htc_opmode_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_hw_startpcureceive</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">OP_SCANNING</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">last_rssi</span> <span class="o">=</span> <span class="n">ATH_RSSI_DUMMY_MARKER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_process_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rxs</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">rx_rate</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rs_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_rate</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* HT rate */</span>
		<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_HT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs_flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_RX_2040</span><span class="p">)</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_40MHZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs_flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_RX_GI</span><span class="p">)</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORT_GI</span><span class="p">;</span>
		<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">rx_rate</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">band</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="n">sband</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span> <span class="o">==</span> <span class="n">rx_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value_short</span> <span class="o">==</span> <span class="n">rx_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORTPRE</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_rx_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ath9k_htc_rxbuf</span> <span class="o">*</span><span class="n">rxbuf</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rx_status</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_htc_rx_status</span> <span class="o">*</span><span class="n">rxstatus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">padpos</span><span class="p">,</span> <span class="n">padsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_rssi</span> <span class="o">=</span> <span class="n">ATH_RSSI_DUMMY_MARKER</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">HTC_RX_FRAME_HEADER_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Corrupted RX frame, dropping (len: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rxstatus</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_htc_rx_status</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rxstatus</span><span class="o">-&gt;</span><span class="n">rs_datalen</span><span class="p">)</span> <span class="o">-</span>
	    <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">HTC_RX_FRAME_HEADER_SIZE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Corrupted RX data len, dropping (dlen: %d, skblen: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rxstatus</span><span class="o">-&gt;</span><span class="n">rs_datalen</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_htc_err_stat_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rxstatus</span><span class="p">);</span>

	<span class="cm">/* Get the RX status information */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">,</span> <span class="n">rxstatus</span><span class="p">,</span> <span class="n">HTC_RX_FRAME_HEADER_SIZE</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">HTC_RX_FRAME_HEADER_SIZE</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_get_hdrlen_from_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">padpos</span> <span class="o">=</span> <span class="n">ath9k_cmn_padpos</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

	<span class="n">padsize</span> <span class="o">=</span> <span class="n">padpos</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padsize</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">padpos</span><span class="o">+</span><span class="n">padsize</span><span class="o">+</span><span class="n">FCS_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">padpos</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">padsize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">rx_status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_status</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_RXERR_CRC</span><span class="p">)</span>
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_FAILED_FCS_CRC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_RXERR_PHY</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rx_next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_RXERR_DECRYPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FIXME */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_RXERR_MIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_ctl</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
				<span class="cm">/*</span>
<span class="cm">				 * Sometimes, we get invalid</span>
<span class="cm">				 * MIC failures on valid control frames.</span>
<span class="cm">				 * Remove these mic errors.</span>
<span class="cm">				 */</span>
				<span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_RXERR_MIC</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MMIC_ERROR</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Reject error frames with the exception of</span>
<span class="cm">		 * decryption and MIC failures. For monitor mode,</span>
<span class="cm">		 * we also ignore the CRC error.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_status</span> <span class="o">&amp;</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">ATH9K_RXERR_DECRYPT</span> <span class="o">|</span> <span class="n">ATH9K_RXERR_MIC</span> <span class="o">|</span>
			      <span class="n">ATH9K_RXERR_CRC</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">rx_next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_status</span> <span class="o">&amp;</span>
			    <span class="o">~</span><span class="p">(</span><span class="n">ATH9K_RXERR_DECRYPT</span> <span class="o">|</span> <span class="n">ATH9K_RXERR_MIC</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">rx_next</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_RXERR_DECRYPT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">keyix</span><span class="p">;</span>
		<span class="n">keyix</span> <span class="o">=</span> <span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_keyix</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">keyix</span> <span class="o">!=</span> <span class="n">ATH9K_RXKEYIX_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">keyix</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">keyix</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">keymap</span><span class="p">))</span>
				<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ath9k_process_rate</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_rate</span><span class="p">,</span>
			   <span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_rssi</span> <span class="o">!=</span> <span class="n">ATH9K_RSSI_BAD</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_moreaggr</span><span class="p">)</span>
		<span class="n">ATH_RSSI_LPF</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">last_rssi</span><span class="p">,</span>
			     <span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_rssi</span><span class="p">);</span>

	<span class="n">last_rssi</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">last_rssi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">last_rssi</span> <span class="o">!=</span> <span class="n">ATH_RSSI_DUMMY_MARKER</span><span class="p">))</span>
		<span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_rssi</span> <span class="o">=</span> <span class="n">ATH_EP_RND</span><span class="p">(</span><span class="n">last_rssi</span><span class="p">,</span>
						     <span class="n">ATH_RSSI_EP_MULTIPLIER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_rssi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">avgbrssi</span> <span class="o">=</span> <span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_rssi</span><span class="p">;</span>

	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">mactime</span> <span class="o">=</span> <span class="n">be64_to_cpu</span><span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_tstamp</span><span class="p">);</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span>  <span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_rssi</span> <span class="o">+</span> <span class="n">ATH_DEFAULT_NOISE_FLOOR</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">antenna</span> <span class="o">=</span> <span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">rxstatus</span><span class="p">.</span><span class="n">rs_antenna</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MACTIME_MPDU</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">rx_next:</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FIXME: Handle FLUSH later on.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ath9k_rx_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_rxbuf</span> <span class="o">*</span><span class="n">rxbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="n">rx_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_buf</span><span class="o">-&gt;</span><span class="n">in_process</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rxbuf</span> <span class="o">=</span> <span class="n">tmp_buf</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">requeue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_rx_prepare</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rxbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">requeue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rx_status</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_status</span><span class="p">));</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_enabled</span><span class="p">)</span>
				<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_work</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">ieee80211_rx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">requeue:</span>
		<span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">in_process</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>
		<span class="n">rxbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_rxep</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">drv_priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		    <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">ep_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_rxbuf</span> <span class="o">*</span><span class="n">rxbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_buf</span><span class="o">-&gt;</span><span class="n">in_process</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxbuf</span> <span class="o">=</span> <span class="n">tmp_buf</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANY</span><span class="p">,</span> <span class="s">&quot;No free RX buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>
	<span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">in_process</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>

	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* FIXME: Locking for cleanup/init */</span>

<span class="kt">void</span> <span class="nf">ath9k_rx_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_rxbuf</span> <span class="o">*</span><span class="n">rxbuf</span><span class="p">,</span> <span class="o">*</span><span class="n">tbuf</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">tbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_rx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_rxbuf</span> <span class="o">*</span><span class="n">rxbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_HTC_RXBUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_rxbuf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to allocate RX buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxbuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">ath9k_rx_cleanup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
