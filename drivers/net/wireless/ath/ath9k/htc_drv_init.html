<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › htc_drv_init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>htc_drv_init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &quot;htc.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Atheros Communications&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Atheros driver 802.11n HTC based wireless devices&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ath9k_debug</span> <span class="o">=</span> <span class="n">ATH_DBG_DEFAULT</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">ath9k_debug</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debugging mask&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">htc_modparam_nohwcrypt</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">nohwcrypt</span><span class="p">,</span> <span class="n">htc_modparam_nohwcrypt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nohwcrypt</span><span class="p">,</span> <span class="s">&quot;Disable hardware encryption&quot;</span><span class="p">);</span>

<span class="cp">#define CHAN2G(_freq, _idx)  { \</span>
<span class="cp">	.center_freq = (_freq), \</span>
<span class="cp">	.hw_value = (_idx), \</span>
<span class="cp">	.max_power = 20, \</span>
<span class="cp">}</span>

<span class="cp">#define CHAN5G(_freq, _idx) { \</span>
<span class="cp">	.band = IEEE80211_BAND_5GHZ, \</span>
<span class="cp">	.center_freq = (_freq), \</span>
<span class="cp">	.hw_value = (_idx), \</span>
<span class="cp">	.max_power = 20, \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">ath9k_2ghz_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* Channel 1 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* Channel 2 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* Channel 3 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="cm">/* Channel 4 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="cm">/* Channel 5 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="cm">/* Channel 6 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="cm">/* Channel 7 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="cm">/* Channel 8 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="cm">/* Channel 9 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="cm">/* Channel 10 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="cm">/* Channel 11 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2467</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="cm">/* Channel 12 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2472</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="cm">/* Channel 13 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2484</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="cm">/* Channel 14 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">ath9k_5ghz_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* _We_ call this UNII 1 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5180</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="cm">/* Channel 36 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5200</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="cm">/* Channel 40 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5220</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="cm">/* Channel 44 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5240</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span> <span class="cm">/* Channel 48 */</span>
	<span class="cm">/* _We_ call this UNII 2 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5260</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="cm">/* Channel 52 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5280</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span> <span class="cm">/* Channel 56 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5300</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="cm">/* Channel 60 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5320</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span> <span class="cm">/* Channel 64 */</span>
	<span class="cm">/* _We_ call this &quot;Middle band&quot; */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5500</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span> <span class="cm">/* Channel 100 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5520</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="cm">/* Channel 104 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5540</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="cm">/* Channel 108 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5560</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="cm">/* Channel 112 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5580</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span> <span class="cm">/* Channel 116 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5600</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span> <span class="cm">/* Channel 120 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5620</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="cm">/* Channel 124 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5640</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span> <span class="cm">/* Channel 128 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5660</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="cm">/* Channel 132 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5680</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="cm">/* Channel 136 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5700</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="cm">/* Channel 140 */</span>
	<span class="cm">/* _We_ call this UNII 3 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5745</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span> <span class="cm">/* Channel 149 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5765</span><span class="p">,</span> <span class="mi">34</span><span class="p">),</span> <span class="cm">/* Channel 153 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5785</span><span class="p">,</span> <span class="mi">35</span><span class="p">),</span> <span class="cm">/* Channel 157 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5805</span><span class="p">,</span> <span class="mi">36</span><span class="p">),</span> <span class="cm">/* Channel 161 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5825</span><span class="p">,</span> <span class="mi">37</span><span class="p">),</span> <span class="cm">/* Channel 165 */</span>
<span class="p">};</span>

<span class="cm">/* Atheros hardware rate code addition for short premble */</span>
<span class="cp">#define SHPCHECK(__hw_rate, __flags) \</span>
<span class="cp">	((__flags &amp; IEEE80211_RATE_SHORT_PREAMBLE) ? (__hw_rate | 0x04) : 0)</span>

<span class="cp">#define RATE(_bitrate, _hw_rate, _flags) {		\</span>
<span class="cp">	.bitrate	= (_bitrate),			\</span>
<span class="cp">	.flags		= (_flags),			\</span>
<span class="cp">	.hw_value	= (_hw_rate),			\</span>
<span class="cp">	.hw_value_short = (SHPCHECK(_hw_rate, _flags))	\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">ath9k_legacy_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span> <span class="cm">/* shortp : 0x1e */</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span> <span class="cm">/* shortp: 0x1d */</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span> <span class="cm">/* short: 0x1c */</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">540</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_MAC80211_LEDS</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tpt_blink</span> <span class="n">ath9k_htc_tpt_blink</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">334</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">260</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">220</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">190</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">170</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">150</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">70</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">130</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">110</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">50</span> <span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_wait_for_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">time_left</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="o">-&gt;</span><span class="n">tgt_ready</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="o">-&gt;</span><span class="n">tgt_ready</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Firmware can take up to 50ms to get ready, to be safe use 1 second */</span>
	<span class="n">time_left</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="o">-&gt;</span><span class="n">target_wait</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_left</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ath9k_htc: Target is unresponsive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="o">-&gt;</span><span class="n">tgt_ready</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_deinit_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath9k_hw_deinit</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_deinit_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">wiphy_rfkill_stop_polling</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">ath9k_deinit_leds</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">ath9k_rx_cleanup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_tx_cleanup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_deinit_priv</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ath9k_htc_connect_svc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">service_id</span><span class="p">,</span>
					<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">tx</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span>
						    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span>
						    <span class="k">enum</span> <span class="n">htc_endpoint_id</span><span class="p">,</span>
						    <span class="n">bool</span> <span class="n">txok</span><span class="p">),</span>
					<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="o">*</span><span class="n">ep_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_service_connreq</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_service_connreq</span><span class="p">));</span>

	<span class="n">req</span><span class="p">.</span><span class="n">service_id</span> <span class="o">=</span> <span class="n">service_id</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">ep_callbacks</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">ep_callbacks</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">ath9k_htc_rxep</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">ep_callbacks</span><span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">tx</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">htc_connect_service</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="n">ep_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_init_htc_services</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">devid</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">drv_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* WMI CMD*/</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_wmi_connect</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi_cmd_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Beacon */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_connect_svc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WMI_BEACON_SVC</span><span class="p">,</span> <span class="n">ath9k_htc_beaconep</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* CAB */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_connect_svc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WMI_CAB_SVC</span><span class="p">,</span> <span class="n">ath9k_htc_txep</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cab_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>


	<span class="cm">/* UAPSD */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_connect_svc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WMI_UAPSD_SVC</span><span class="p">,</span> <span class="n">ath9k_htc_txep</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">uapsd_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* MGMT */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_connect_svc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WMI_MGMT_SVC</span><span class="p">,</span> <span class="n">ath9k_htc_txep</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mgmt_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* DATA BE */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_connect_svc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WMI_DATA_BE_SVC</span><span class="p">,</span> <span class="n">ath9k_htc_txep</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_be_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* DATA BK */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_connect_svc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WMI_DATA_BK_SVC</span><span class="p">,</span> <span class="n">ath9k_htc_txep</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_bk_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* DATA VI */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_connect_svc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WMI_DATA_VI_SVC</span><span class="p">,</span> <span class="n">ath9k_htc_txep</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vi_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* DATA VO */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_connect_svc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WMI_DATA_VO_SVC</span><span class="p">,</span> <span class="n">ath9k_htc_txep</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vo_ep</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup required credits before initializing HTC.</span>
<span class="cm">	 * This is a bit hacky, but, since queuing is done in</span>
<span class="cm">	 * the HIF layer, shouldn&#39;t matter much.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_AR7010_DEVICE</span><span class="p">(</span><span class="n">drv_info</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">=</span> <span class="mi">45</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">=</span> <span class="mi">33</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">htc_init</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ath9k_htc: HTC initialized with %d credits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ath9k_htc: Unable to initialize HTC services</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_reg_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">regulatory_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">wiphy_to_ieee80211_hw</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ath_reg_notifier_apply</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span>
				      <span class="n">ath9k_hw_regulatory</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ath9k_regread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">reg_offset</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_wmi_cmd</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">WMI_REG_READ_CMDID</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span>
			  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span>
			  <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">WMI</span><span class="p">,</span> <span class="s">&quot;REGISTER READ FAILED: (0x%04x, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">reg_offset</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_multi_regread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="n">u16</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">tmpaddr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__be32</span> <span class="n">tmpval</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

       <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">tmpaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
       <span class="p">}</span>

       <span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_wmi_cmd</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">WMI_REG_READ_CMDID</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">tmpaddr</span> <span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">,</span>
			   <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">tmpval</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">count</span><span class="p">,</span>
			   <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">WMI</span><span class="p">,</span>
			<span class="s">&quot;Multiple REGISTER READ FAILED (count: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>

       <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">val</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">tmpval</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
       <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_regwrite_single</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">reg_offset</span><span class="p">),</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val</span><span class="p">),</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_wmi_cmd</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">WMI_REG_WRITE_CMDID</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
			  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">),</span>
			  <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">WMI</span><span class="p">,</span> <span class="s">&quot;REGISTER WRITE FAILED:(0x%04x, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">reg_offset</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_regwrite_buffer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rsp_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_mutex</span><span class="p">);</span>

	<span class="cm">/* Store the register/value */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_idx</span><span class="p">].</span><span class="n">reg</span> <span class="o">=</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">reg_offset</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_idx</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span>
		<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_idx</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* If the buffer is full, send it out. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_idx</span> <span class="o">==</span> <span class="n">MAX_CMD_NUMBER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_wmi_cmd</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">WMI_REG_WRITE_CMDID</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">register_write</span><span class="p">)</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_idx</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rsp_status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp_status</span><span class="p">),</span>
			  <span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">WMI</span><span class="p">,</span>
				<span class="s">&quot;REGISTER WRITE FAILED, multi len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_regwrite</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">mwrite_cnt</span><span class="p">))</span>
		<span class="n">ath9k_regwrite_buffer</span><span class="p">(</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ath9k_regwrite_single</span><span class="p">(</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_enable_regwrite_buffer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">mwrite_cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_regwrite_flush</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rsp_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">mwrite_cnt</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_wmi_cmd</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">WMI_REG_WRITE_CMDID</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write</span><span class="p">,</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">register_write</span><span class="p">)</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_idx</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rsp_status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp_status</span><span class="p">),</span>
			  <span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">WMI</span><span class="p">,</span>
				<span class="s">&quot;REGISTER WRITE FAILED, multi len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="o">-&gt;</span><span class="n">multi_write_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ath9k_reg_rmw</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">set</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ath9k_regread</span><span class="p">(</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clr</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">ath9k_regwrite</span><span class="p">(</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_usb_read_cachesize</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">csz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">csz</span> <span class="o">=</span> <span class="n">L1_CACHE_BYTES</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath_usb_eeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">,</span> <span class="n">u32</span> <span class="n">off</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR5416_EEPROM_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">off</span> <span class="o">&lt;&lt;</span> <span class="n">AR5416_EEPROM_S</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_wait</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			   <span class="n">AR_EEPROM_STATUS_DATA</span><span class="p">,</span>
			   <span class="n">AR_EEPROM_STATUS_DATA_BUSY</span> <span class="o">|</span>
			   <span class="n">AR_EEPROM_STATUS_DATA_PROT_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">AH_WAIT_TIMEOUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_EEPROM_STATUS_DATA</span><span class="p">),</span>
		   <span class="n">AR_EEPROM_STATUS_DATA_VAL</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_bus_ops</span> <span class="n">ath9k_usb_bus_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ath_bus_type</span> <span class="o">=</span> <span class="n">ATH_USB</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_cachesize</span> <span class="o">=</span> <span class="n">ath_usb_read_cachesize</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eeprom_read</span> <span class="o">=</span> <span class="n">ath_usb_eeprom_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_ht_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">tx_streams</span><span class="p">,</span> <span class="n">rx_streams</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">=</span> <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span> <span class="o">|</span>
		       <span class="n">IEEE80211_HT_CAP_SM_PS</span> <span class="o">|</span>
		       <span class="n">IEEE80211_HT_CAP_SGI_40</span> <span class="o">|</span>
		       <span class="n">IEEE80211_HT_CAP_DSSSCCK40</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_SGI_20</span><span class="p">)</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span><span class="p">;</span>

	<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_HT_CAP_RX_STBC_SHIFT</span><span class="p">);</span>

	<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MAX_AMPDU_64K</span><span class="p">;</span>
	<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">ampdu_density</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MPDU_DENSITY_8</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">));</span>

	<span class="cm">/* ath9k_htc supports only 1 or 2 stream devices */</span>
	<span class="n">tx_streams</span> <span class="o">=</span> <span class="n">ath9k_cmn_count_streams</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rx_streams</span> <span class="o">=</span> <span class="n">ath9k_cmn_count_streams</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxchainmask</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;TX streams %d, RX streams: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tx_streams</span><span class="p">,</span> <span class="n">rx_streams</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_streams</span> <span class="o">!=</span> <span class="n">rx_streams</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_MCS_TX_RX_DIFF</span><span class="p">;</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">|=</span> <span class="p">((</span><span class="n">tx_streams</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
					   <span class="n">IEEE80211_HT_MCS_TX_MAX_STREAMS_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_streams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_MCS_TX_DEFINED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_init_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwq_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwq_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beaconq</span> <span class="o">=</span> <span class="n">ath9k_hw_beaconq_setup</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beaconq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to setup BEACON xmit queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cabq</span> <span class="o">=</span> <span class="n">ath9k_htc_cabq_setup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cabq</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to setup CAB xmit queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_htc_txq_setup</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WME_AC_BE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to setup xmit queue for BE traffic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_htc_txq_setup</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WME_AC_BK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to setup xmit queue for BK traffic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_htc_txq_setup</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WME_AC_VI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to setup xmit queue for VI traffic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_htc_txq_setup</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WME_AC_VO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to setup xmit queue for VO traffic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_init_channels_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">channels</span> <span class="o">=</span>
			<span class="n">ath9k_2ghz_channels</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">n_channels</span> <span class="o">=</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_2ghz_channels</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">ath9k_legacy_rates</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">n_bitrates</span> <span class="o">=</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_legacy_rates</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">channels</span> <span class="o">=</span> <span class="n">ath9k_5ghz_channels</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">n_channels</span> <span class="o">=</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_5ghz_channels</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">bitrates</span> <span class="o">=</span>
			<span class="n">ath9k_legacy_rates</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">n_bitrates</span> <span class="o">=</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_legacy_rates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_init_misc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bssidmask</span><span class="p">,</span> <span class="n">ath_bcast_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_init_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">devid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">product</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">drv_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">csz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">|=</span> <span class="n">OP_INVALID</span><span class="p">;</span>

	<span class="n">ah</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">devid</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">drv_info</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_flags</span> <span class="o">|=</span> <span class="n">AH_USE_EEPROM</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">reg_ops</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath9k_regread</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">reg_ops</span><span class="p">.</span><span class="n">multi_read</span> <span class="o">=</span> <span class="n">ath9k_multi_regread</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">reg_ops</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath9k_regwrite</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">reg_ops</span><span class="p">.</span><span class="n">enable_write_buffer</span> <span class="o">=</span> <span class="n">ath9k_enable_regwrite_buffer</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">reg_ops</span><span class="p">.</span><span class="n">write_flush</span> <span class="o">=</span> <span class="n">ath9k_regwrite_flush</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">reg_ops</span><span class="p">.</span><span class="n">rmw</span> <span class="o">=</span> <span class="n">ath9k_reg_rmw</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span> <span class="o">=</span> <span class="n">ah</span><span class="p">;</span>

	<span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">reg_ops</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath9k_usb_bus_ops</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ah</span> <span class="o">=</span> <span class="n">ah</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">debug_mask</span> <span class="o">=</span> <span class="n">ath9k_debug</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">,</span> <span class="n">ath9k_rx_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_failed_tasklet</span><span class="p">,</span> <span class="n">ath9k_tx_failed_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ani_work</span><span class="p">,</span> <span class="n">ath9k_htc_ani_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_work</span><span class="p">,</span> <span class="n">ath9k_ps_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_work</span><span class="p">,</span> <span class="n">ath9k_fatal_work</span><span class="p">);</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cleanup_timer</span><span class="p">,</span> <span class="n">ath9k_htc_tx_cleanup_timer</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cache line size is used to size and align various</span>
<span class="cm">	 * structures used to communicate with the hardware.</span>
<span class="cm">	 */</span>
	<span class="n">ath_read_cachesize</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csz</span><span class="p">);</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cachelsz</span> <span class="o">=</span> <span class="n">csz</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* convert to bytes */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_init</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Unable to initialize hardware; initialization status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_init_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_queues</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_HTC_MAX_BCN_VIF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_beacon_conf</span><span class="p">.</span><span class="n">bslot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ath9k_cmn_init_crypto</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_init_channels_rates</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_init_misc</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_htc_init_btcoex</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">product</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_queues:</span>
	<span class="n">ath9k_hw_deinit</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="nl">err_hw:</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_set_hw_capab</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_AMPDU_AGGREGATION</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SPECTRUM_MGMT</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_HAS_RATE_CONTROL</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_RX_INCLUDES_FCS</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SUPPORTS_PS</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_PS_NULLFUNC_STACK</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_REPORTS_TX_ACK_STATUS</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_HOST_BROADCAST_PS_BUFFERING</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WIPHY_FLAG_PS_ON_BY_DEFAULT</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_IBSS_RSN</span> <span class="o">|</span>
			    <span class="n">WIPHY_FLAG_HAS_REMAIN_ON_CHANNEL</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_change_time</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_listen_interval</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vif_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_vif</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">sta_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_sta</span><span class="p">);</span>

	<span class="cm">/* tx_frame_hdr is larger than tx_mgmt_hdr anyway */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_frame_hdr</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_2GHZ</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_5GHZ</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_HT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_2GHZ</span><span class="p">)</span>
			<span class="n">setup_ht_cap</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">ht_cap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_5GHZ</span><span class="p">)</span>
			<span class="n">setup_ht_cap</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">ht_cap</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_init_firmware_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_fw_version</span> <span class="n">cmd_rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd_rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd_rsp</span><span class="p">));</span>

	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_GET_FW_VERSION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version_major</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cmd_rsp</span><span class="p">.</span><span class="n">major</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version_minor</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">cmd_rsp</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">ETHTOOL_BUSINFO_LEN</span><span class="p">,</span> <span class="s">&quot;%d.%d&quot;</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version_major</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version_minor</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ath9k_htc: FW Version: %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version_major</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version_minor</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if the available FW matches the driver&#39;s</span>
<span class="cm">	 * required version.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version_major</span> <span class="o">!=</span> <span class="n">MAJOR_VERSION_REQ</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version_minor</span> <span class="o">!=</span> <span class="n">MINOR_VERSION_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ath9k_htc: Please upgrade to FW version %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">MAJOR_VERSION_REQ</span><span class="p">,</span> <span class="n">MINOR_VERSION_REQ</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">devid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">product</span><span class="p">,</span> <span class="n">u32</span> <span class="n">drv_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_regulatory</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">hw_name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="cm">/* Bring up device */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ath9k_init_priv</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">drv_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>

	<span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_set_hw_capab</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ath9k_init_firmware_version</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_fw</span><span class="p">;</span>

	<span class="cm">/* Initialize regulatory */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ath_regd_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">regulatory</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			      <span class="n">ath9k_reg_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_regd</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">regulatory</span><span class="p">;</span>

	<span class="cm">/* Setup TX */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ath9k_tx_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_tx</span><span class="p">;</span>

	<span class="cm">/* Setup RX */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ath9k_rx_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_rx</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MAC80211_LEDS</span>
	<span class="cm">/* must be initialized before ieee80211_register_hw */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">default_trigger</span> <span class="o">=</span> <span class="n">ieee80211_create_tpt_led_trigger</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
		<span class="n">IEEE80211_TPT_LEDTRIG_FL_RADIO</span><span class="p">,</span> <span class="n">ath9k_htc_tpt_blink</span><span class="p">,</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_htc_tpt_blink</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="cm">/* Register with mac80211 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_register</span><span class="p">;</span>

	<span class="cm">/* Handle world regulatory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_is_world_regd</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">regulatory_hint</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_world</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ath9k_htc_init_debug</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to create debugfs files</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_world</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
		<span class="s">&quot;WMI:%d, BCN:%d, CAB:%d, UAPSD:%d, MGMT:%d, BE:%d, BK:%d, VI:%d, VO:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi_cmd_ep</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_ep</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cab_ep</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">uapsd_ep</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mgmt_ep</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_be_ep</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_bk_ep</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vi_ep</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">data_vo_ep</span><span class="p">);</span>

	<span class="n">ath9k_hw_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="n">hw_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hw_name</span><span class="p">));</span>
	<span class="n">wiphy_info</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw_name</span><span class="p">);</span>

	<span class="n">ath9k_init_leds</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_start_rfkill_poll</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_world:</span>
	<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="nl">err_register:</span>
	<span class="n">ath9k_rx_cleanup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">err_rx:</span>
	<span class="n">ath9k_tx_cleanup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">err_tx:</span>
	<span class="cm">/* Nothing */</span>
<span class="nl">err_regd:</span>
	<span class="cm">/* Nothing */</span>
<span class="nl">err_fw:</span>
	<span class="n">ath9k_deinit_priv</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">err_init:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_htc_probe_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">htc_handle</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">devid</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">product</span><span class="p">,</span> <span class="n">u32</span> <span class="n">drv_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ath9k_htc_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span> <span class="o">=</span> <span class="n">htc_handle</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">htc_handle</span><span class="o">-&gt;</span><span class="n">drv_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_wait_for_target</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span> <span class="o">=</span> <span class="n">ath9k_init_wmi</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_init_htc_services</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">drv_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_init_device</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">devid</span><span class="p">,</span> <span class="n">product</span><span class="p">,</span> <span class="n">drv_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_init</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_init:</span>
	<span class="n">ath9k_deinit_wmi</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">err_free:</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_disconnect_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">htc_handle</span><span class="p">,</span> <span class="n">bool</span> <span class="n">hotunplug</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">htc_handle</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Check if the device has been yanked out. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hotunplug</span><span class="p">)</span>
			<span class="n">htc_handle</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_flags</span> <span class="o">|=</span> <span class="n">AH_UNPLUGGED</span><span class="p">;</span>

		<span class="n">ath9k_deinit_device</span><span class="p">(</span><span class="n">htc_handle</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">);</span>
		<span class="n">ath9k_deinit_wmi</span><span class="p">(</span><span class="n">htc_handle</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">);</span>
		<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">htc_handle</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">htc_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath9k_htc_setpower</span><span class="p">(</span><span class="n">htc_handle</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">,</span> <span class="n">ATH9K_PM_FULL_SLEEP</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_htc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">htc_handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">htc_handle</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_wait_for_target</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_init_htc_services</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">devid</span><span class="p">,</span>
				      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ath9k_htc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_hif_usb_init</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No USB devices found, driver not installed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">ath9k_htc_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ath9k_htc_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath9k_hif_usb_exit</span><span class="p">();</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Driver unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ath9k_htc_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
