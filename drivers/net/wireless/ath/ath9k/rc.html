<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › rc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>rc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004 Video54 Technologies, Inc.</span>
<span class="cm"> * Copyright (c) 2004-2011 Atheros Communications, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &quot;ath9k.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="n">ar5416_11na_ratetable</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">68</span><span class="p">,</span>
	<span class="mi">8</span><span class="p">,</span> <span class="cm">/* MCS start */</span>
	<span class="p">{</span>
		<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span>
			<span class="mi">5400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* 6 Mb */</span>
		<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span>
			<span class="mi">7800</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* 9 Mb */</span>
		<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span>
			<span class="mi">10000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* 12 Mb */</span>
		<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">18000</span><span class="p">,</span>
			<span class="mi">13900</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> <span class="cm">/* 18 Mb */</span>
		<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">24000</span><span class="p">,</span>
			<span class="mi">17300</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span> <span class="cm">/* 24 Mb */</span>
		<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">36000</span><span class="p">,</span>
			<span class="mi">23000</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span> <span class="cm">/* 36 Mb */</span>
		<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span>
			<span class="mi">27400</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span> <span class="cm">/* 48 Mb */</span>
		<span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">54000</span><span class="p">,</span>
			<span class="mi">29300</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span> <span class="cm">/* 54 Mb */</span>
		<span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SDT_2040</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">6500</span><span class="p">,</span>
			<span class="mi">6400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">38</span> <span class="p">},</span> <span class="cm">/* 6.5 Mb */</span>
		<span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SDT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">13000</span><span class="p">,</span>
			<span class="mi">12700</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">39</span> <span class="p">},</span> <span class="cm">/* 13 Mb */</span>
		<span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SDT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">19500</span><span class="p">,</span>
			<span class="mi">18800</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">40</span> <span class="p">},</span> <span class="cm">/* 19.5 Mb */</span>
		<span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SD_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">26000</span><span class="p">,</span>
			<span class="mi">25000</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">41</span> <span class="p">},</span> <span class="cm">/* 26 Mb */</span>
		<span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SD_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">39000</span><span class="p">,</span>
			<span class="mi">36700</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span> <span class="cm">/* 39 Mb */</span>
		<span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">52000</span><span class="p">,</span>
			<span class="mi">48100</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">43</span> <span class="p">},</span> <span class="cm">/* 52 Mb */</span>
		<span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">58500</span><span class="p">,</span>
			<span class="mi">53500</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span> <span class="cm">/* 58.5 Mb */</span>
		<span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">65000</span><span class="p">,</span>
			<span class="mi">59000</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">46</span> <span class="p">},</span> <span class="cm">/* 65 Mb */</span>
		<span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS_HGI</span><span class="p">,</span> <span class="mi">72200</span><span class="p">,</span>
			<span class="mi">65400</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">46</span> <span class="p">},</span> <span class="cm">/* 75 Mb */</span>
		<span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">13000</span><span class="p">,</span>
			<span class="mi">12700</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">47</span> <span class="p">},</span> <span class="cm">/* 13 Mb */</span>
		<span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">26000</span><span class="p">,</span>
			<span class="mi">24800</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">48</span> <span class="p">},</span> <span class="cm">/* 26 Mb */</span>
		<span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">39000</span><span class="p">,</span>
			<span class="mi">36600</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">49</span> <span class="p">},</span> <span class="cm">/* 39 Mb */</span>
		<span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">52000</span><span class="p">,</span>
			<span class="mi">48100</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span> <span class="p">},</span> <span class="cm">/* 52 Mb */</span>
		<span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">78000</span><span class="p">,</span>
			<span class="mi">69500</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">51</span> <span class="p">},</span> <span class="cm">/* 78 Mb */</span>
		<span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">104000</span><span class="p">,</span>
			<span class="mi">89500</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">52</span> <span class="p">},</span> <span class="cm">/* 104 Mb */</span>
		<span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">117000</span><span class="p">,</span>
			<span class="mi">98900</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">53</span> <span class="p">},</span> <span class="cm">/* 117 Mb */</span>
		<span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">130000</span><span class="p">,</span>
			<span class="mi">108300</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">55</span> <span class="p">},</span> <span class="cm">/* 130 Mb */</span>
		<span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS_HGI</span><span class="p">,</span> <span class="mi">144400</span><span class="p">,</span>
			<span class="mi">120000</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">55</span> <span class="p">},</span> <span class="cm">/* 144.4 Mb */</span>
		<span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">19500</span><span class="p">,</span>
			<span class="mi">17400</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">56</span> <span class="p">},</span> <span class="cm">/* 19.5 Mb */</span>
		<span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">39000</span><span class="p">,</span>
			<span class="mi">35100</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">57</span> <span class="p">},</span> <span class="cm">/* 39 Mb */</span>
		<span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">58500</span><span class="p">,</span>
			<span class="mi">52600</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">58</span> <span class="p">},</span> <span class="cm">/* 58.5 Mb */</span>
		<span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">78000</span><span class="p">,</span>
			<span class="mi">70400</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">59</span> <span class="p">},</span> <span class="cm">/* 78 Mb */</span>
		<span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">117000</span><span class="p">,</span>
			<span class="mi">104900</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">61</span> <span class="p">},</span> <span class="cm">/* 117 Mb */</span>
		<span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS_HGI</span><span class="p">,</span> <span class="mi">130000</span><span class="p">,</span>
			<span class="mi">115800</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">61</span> <span class="p">},</span> <span class="cm">/* 130 Mb*/</span>
		<span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">156000</span><span class="p">,</span>
			<span class="mi">137200</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">63</span> <span class="p">},</span> <span class="cm">/* 156 Mb */</span>
		<span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS_HGI</span><span class="p">,</span> <span class="mi">173300</span><span class="p">,</span>
			<span class="mi">151100</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">63</span> <span class="p">},</span> <span class="cm">/* 173.3 Mb */</span>
		<span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">175500</span><span class="p">,</span>
			<span class="mi">152800</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">65</span> <span class="p">},</span> <span class="cm">/* 175.5 Mb */</span>
		<span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS_HGI</span><span class="p">,</span> <span class="mi">195000</span><span class="p">,</span>
			<span class="mi">168400</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">65</span> <span class="p">},</span> <span class="cm">/* 195 Mb*/</span>
		<span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">195000</span><span class="p">,</span>
			<span class="mi">168400</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">67</span> <span class="p">},</span> <span class="cm">/* 195 Mb */</span>
		<span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS_HGI</span><span class="p">,</span> <span class="mi">216700</span><span class="p">,</span>
			<span class="mi">185000</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">67</span> <span class="p">},</span> <span class="cm">/* 216.7 Mb */</span>
		<span class="p">[</span><span class="mi">38</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SDT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">13500</span><span class="p">,</span>
			<span class="mi">13200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span> <span class="p">},</span> <span class="cm">/* 13.5 Mb*/</span>
		<span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SDT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">27500</span><span class="p">,</span>
			<span class="mi">25900</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span> <span class="p">},</span> <span class="cm">/* 27.0 Mb*/</span>
		<span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SDT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">40500</span><span class="p">,</span>
			<span class="mi">38600</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span> <span class="p">},</span> <span class="cm">/* 40.5 Mb*/</span>
		<span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SD_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">54000</span><span class="p">,</span>
			<span class="mi">49800</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">41</span> <span class="p">},</span> <span class="cm">/* 54 Mb */</span>
		<span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SD_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">81500</span><span class="p">,</span>
			<span class="mi">72200</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span> <span class="cm">/* 81 Mb */</span>
		<span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">108000</span><span class="p">,</span>
			<span class="mi">92900</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">43</span> <span class="p">},</span> <span class="cm">/* 108 Mb */</span>
		<span class="p">[</span><span class="mi">44</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">121500</span><span class="p">,</span>
			<span class="mi">102700</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span> <span class="cm">/* 121.5 Mb*/</span>
		<span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">135000</span><span class="p">,</span>
			<span class="mi">112000</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">46</span> <span class="p">},</span> <span class="cm">/* 135 Mb */</span>
		<span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS_HGI</span><span class="p">,</span> <span class="mi">150000</span><span class="p">,</span>
			<span class="mi">122000</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">46</span> <span class="p">},</span> <span class="cm">/* 150 Mb */</span>
		<span class="p">[</span><span class="mi">47</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">27000</span><span class="p">,</span>
			<span class="mi">25800</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span> <span class="p">},</span> <span class="cm">/* 27 Mb */</span>
		<span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">54000</span><span class="p">,</span>
			<span class="mi">49800</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span> <span class="p">},</span> <span class="cm">/* 54 Mb */</span>
		<span class="p">[</span><span class="mi">49</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">81000</span><span class="p">,</span>
			<span class="mi">71900</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">49</span> <span class="p">},</span> <span class="cm">/* 81 Mb */</span>
		<span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">108000</span><span class="p">,</span>
			<span class="mi">92500</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span> <span class="p">},</span> <span class="cm">/* 108 Mb */</span>
		<span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">162000</span><span class="p">,</span>
			<span class="mi">130300</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">51</span> <span class="p">},</span> <span class="cm">/* 162 Mb */</span>
		<span class="p">[</span><span class="mi">52</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">216000</span><span class="p">,</span>
			<span class="mi">162800</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">52</span> <span class="p">},</span> <span class="cm">/* 216 Mb */</span>
		<span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">243000</span><span class="p">,</span>
			<span class="mi">178200</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">53</span> <span class="p">},</span> <span class="cm">/* 243 Mb */</span>
		<span class="p">[</span><span class="mi">54</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">270000</span><span class="p">,</span>
			<span class="mi">192100</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">55</span> <span class="p">},</span> <span class="cm">/* 270 Mb */</span>
		<span class="p">[</span><span class="mi">55</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS_HGI</span><span class="p">,</span> <span class="mi">300000</span><span class="p">,</span>
			<span class="mi">207000</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">55</span> <span class="p">},</span> <span class="cm">/* 300 Mb */</span>
		<span class="p">[</span><span class="mi">56</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">40500</span><span class="p">,</span>
			<span class="mi">36100</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">56</span> <span class="p">},</span> <span class="cm">/* 40.5 Mb */</span>
		<span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">81000</span><span class="p">,</span>
			<span class="mi">72900</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">57</span> <span class="p">},</span> <span class="cm">/* 81 Mb */</span>
		<span class="p">[</span><span class="mi">58</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">121500</span><span class="p">,</span>
			<span class="mi">108300</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">58</span> <span class="p">},</span> <span class="cm">/* 121.5 Mb */</span>
		<span class="p">[</span><span class="mi">59</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">162000</span><span class="p">,</span>
			<span class="mi">142000</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">59</span> <span class="p">},</span> <span class="cm">/*  162 Mb */</span>
		<span class="p">[</span><span class="mi">60</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">243000</span><span class="p">,</span>
			<span class="mi">205100</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">61</span> <span class="p">},</span> <span class="cm">/*  243 Mb */</span>
		<span class="p">[</span><span class="mi">61</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS_HGI</span><span class="p">,</span> <span class="mi">270000</span><span class="p">,</span>
			<span class="mi">224700</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">61</span> <span class="p">},</span> <span class="cm">/*  270 Mb */</span>
		<span class="p">[</span><span class="mi">62</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">324000</span><span class="p">,</span>
			<span class="mi">263100</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span> <span class="p">},</span> <span class="cm">/*  324 Mb */</span>
		<span class="p">[</span><span class="mi">63</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS_HGI</span><span class="p">,</span> <span class="mi">360000</span><span class="p">,</span>
			<span class="mi">288000</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span> <span class="p">},</span> <span class="cm">/*  360 Mb */</span>
		<span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">364500</span><span class="p">,</span>
			<span class="mi">290700</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">65</span> <span class="p">},</span> <span class="cm">/* 364.5 Mb */</span>
		<span class="p">[</span><span class="mi">65</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS_HGI</span><span class="p">,</span> <span class="mi">405000</span><span class="p">,</span>
			<span class="mi">317200</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">65</span> <span class="p">},</span> <span class="cm">/* 405 Mb */</span>
		<span class="p">[</span><span class="mi">66</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">405000</span><span class="p">,</span>
			<span class="mi">317200</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">67</span> <span class="p">},</span> <span class="cm">/* 405 Mb */</span>
		<span class="p">[</span><span class="mi">67</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS_HGI</span><span class="p">,</span> <span class="mi">450000</span><span class="p">,</span>
			<span class="mi">346400</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">67</span> <span class="p">},</span> <span class="cm">/* 450 Mb */</span>
	<span class="p">},</span>
	<span class="mi">50</span><span class="p">,</span>  <span class="cm">/* probe interval */</span>
	<span class="n">WLAN_RC_HT_FLAG</span><span class="p">,</span>  <span class="cm">/* Phy rates allowed initially */</span>
<span class="p">};</span>

<span class="cm">/* 4ms frame limit not used for NG mode.  The values filled</span>
<span class="cm"> * for HT are the 64K max aggregate limit */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="n">ar5416_11ng_ratetable</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">72</span><span class="p">,</span>
	<span class="mi">12</span><span class="p">,</span> <span class="cm">/* MCS start */</span>
	<span class="p">{</span>
		<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_ALL</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_CCK</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span>
			<span class="mi">900</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* 1 Mb */</span>
		<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_ALL</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_CCK</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span>
			<span class="mi">1900</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* 2 Mb */</span>
		<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_ALL</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_CCK</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span>
			<span class="mi">4900</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* 5.5 Mb */</span>
		<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_ALL</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_CCK</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span>
			<span class="mi">8100</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span> <span class="p">},</span> <span class="cm">/* 11 Mb */</span>
		<span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span>
			<span class="mi">5400</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span> <span class="cm">/* 6 Mb */</span>
		<span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span>
			<span class="mi">7800</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span> <span class="p">},</span> <span class="cm">/* 9 Mb */</span>
		<span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span>
			<span class="mi">10100</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span> <span class="p">},</span> <span class="cm">/* 12 Mb */</span>
		<span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">18000</span><span class="p">,</span>
			<span class="mi">14100</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span> <span class="p">},</span> <span class="cm">/* 18 Mb */</span>
		<span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">24000</span><span class="p">,</span>
			<span class="mi">17700</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span> <span class="cm">/* 24 Mb */</span>
		<span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">36000</span><span class="p">,</span>
			<span class="mi">23700</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span> <span class="p">},</span> <span class="cm">/* 36 Mb */</span>
		<span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span>
			<span class="mi">27400</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span> <span class="p">},</span> <span class="cm">/* 48 Mb */</span>
		<span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">54000</span><span class="p">,</span>
			<span class="mi">30900</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span> <span class="p">},</span> <span class="cm">/* 54 Mb */</span>
		<span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">6500</span><span class="p">,</span>
			<span class="mi">6400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span> <span class="cm">/* 6.5 Mb */</span>
		<span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SDT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">13000</span><span class="p">,</span>
			<span class="mi">12700</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">43</span> <span class="p">},</span> <span class="cm">/* 13 Mb */</span>
		<span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SDT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">19500</span><span class="p">,</span>
			<span class="mi">18800</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span> <span class="cm">/* 19.5 Mb*/</span>
		<span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SD_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">26000</span><span class="p">,</span>
			<span class="mi">25000</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">45</span> <span class="p">},</span> <span class="cm">/* 26 Mb */</span>
		<span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SD_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">39000</span><span class="p">,</span>
			<span class="mi">36700</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">46</span> <span class="p">},</span> <span class="cm">/* 39 Mb */</span>
		<span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">52000</span><span class="p">,</span>
			<span class="mi">48100</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">47</span> <span class="p">},</span> <span class="cm">/* 52 Mb */</span>
		<span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">58500</span><span class="p">,</span>
			<span class="mi">53500</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">48</span> <span class="p">},</span> <span class="cm">/* 58.5 Mb */</span>
		<span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">,</span> <span class="mi">65000</span><span class="p">,</span>
			<span class="mi">59000</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span> <span class="p">},</span> <span class="cm">/* 65 Mb */</span>
		<span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_SS_HGI</span><span class="p">,</span> <span class="mi">72200</span><span class="p">,</span>
			<span class="mi">65400</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span> <span class="p">},</span> <span class="cm">/* 65 Mb*/</span>
		<span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">13000</span><span class="p">,</span>
			<span class="mi">12700</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">51</span> <span class="p">},</span> <span class="cm">/* 13 Mb */</span>
		<span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">26000</span><span class="p">,</span>
			<span class="mi">24800</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">52</span> <span class="p">},</span> <span class="cm">/* 26 Mb */</span>
		<span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">39000</span><span class="p">,</span>
			<span class="mi">36600</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">53</span> <span class="p">},</span> <span class="cm">/* 39 Mb */</span>
		<span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">52000</span><span class="p">,</span>
			<span class="mi">48100</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">54</span> <span class="p">},</span> <span class="cm">/* 52 Mb */</span>
		<span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">78000</span><span class="p">,</span>
			<span class="mi">69500</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">55</span> <span class="p">},</span> <span class="cm">/* 78 Mb */</span>
		<span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">104000</span><span class="p">,</span>
			<span class="mi">89500</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">56</span> <span class="p">},</span> <span class="cm">/* 104 Mb */</span>
		<span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">117000</span><span class="p">,</span>
			<span class="mi">98900</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">57</span> <span class="p">},</span> <span class="cm">/* 117 Mb */</span>
		<span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS</span><span class="p">,</span> <span class="mi">130000</span><span class="p">,</span>
			<span class="mi">108300</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">59</span> <span class="p">},</span> <span class="cm">/* 130 Mb */</span>
		<span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_DS_HGI</span><span class="p">,</span> <span class="mi">144400</span><span class="p">,</span>
			<span class="mi">120000</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">59</span> <span class="p">},</span> <span class="cm">/* 144.4 Mb */</span>
		<span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">19500</span><span class="p">,</span>
			<span class="mi">17400</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span> <span class="cm">/* 19.5 Mb */</span>
		<span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">39000</span><span class="p">,</span>
			<span class="mi">35100</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">61</span> <span class="p">},</span> <span class="cm">/* 39 Mb */</span>
		<span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">58500</span><span class="p">,</span>
			<span class="mi">52600</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">62</span> <span class="p">},</span> <span class="cm">/* 58.5 Mb */</span>
		<span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">78000</span><span class="p">,</span>
			<span class="mi">70400</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">63</span> <span class="p">},</span> <span class="cm">/* 78 Mb */</span>
		<span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">117000</span><span class="p">,</span>
			<span class="mi">104900</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">65</span> <span class="p">},</span> <span class="cm">/* 117 Mb */</span>
		<span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS_HGI</span><span class="p">,</span> <span class="mi">130000</span><span class="p">,</span>
			<span class="mi">115800</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">65</span> <span class="p">},</span> <span class="cm">/* 130 Mb */</span>
		<span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">156000</span><span class="p">,</span>
			<span class="mi">137200</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">67</span> <span class="p">},</span> <span class="cm">/* 156 Mb */</span>
		<span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS_HGI</span><span class="p">,</span> <span class="mi">173300</span><span class="p">,</span>
			<span class="mi">151100</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">67</span> <span class="p">},</span> <span class="cm">/* 173.3 Mb */</span>
		<span class="p">[</span><span class="mi">38</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">175500</span><span class="p">,</span>
			<span class="mi">152800</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">69</span> <span class="p">},</span> <span class="cm">/* 175.5 Mb */</span>
		<span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS_HGI</span><span class="p">,</span> <span class="mi">195000</span><span class="p">,</span>
			<span class="mi">168400</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">69</span> <span class="p">},</span> <span class="cm">/* 195 Mb */</span>
		<span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS</span><span class="p">,</span> <span class="mi">195000</span><span class="p">,</span>
			<span class="mi">168400</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">71</span> <span class="p">},</span> <span class="cm">/* 195 Mb */</span>
		<span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_20</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_20_TS_HGI</span><span class="p">,</span> <span class="mi">216700</span><span class="p">,</span>
			<span class="mi">185000</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">71</span> <span class="p">},</span> <span class="cm">/* 216.7 Mb */</span>
		<span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SDT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">13500</span><span class="p">,</span>
			<span class="mi">13200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">42</span> <span class="p">},</span> <span class="cm">/* 13.5 Mb */</span>
		<span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SDT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">27500</span><span class="p">,</span>
			<span class="mi">25900</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">43</span> <span class="p">},</span> <span class="cm">/* 27.0 Mb */</span>
		<span class="p">[</span><span class="mi">44</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SDT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">40500</span><span class="p">,</span>
			<span class="mi">38600</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">44</span> <span class="p">},</span> <span class="cm">/* 40.5 Mb */</span>
		<span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SD_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">54000</span><span class="p">,</span>
			<span class="mi">49800</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span> <span class="p">},</span> <span class="cm">/* 54 Mb */</span>
		<span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_SD_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">81500</span><span class="p">,</span>
			<span class="mi">72200</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">46</span> <span class="p">},</span> <span class="cm">/* 81 Mb */</span>
		<span class="p">[</span><span class="mi">47</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_40</span> <span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">108000</span><span class="p">,</span>
			<span class="mi">92900</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">47</span> <span class="p">},</span> <span class="cm">/* 108 Mb */</span>
		<span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">121500</span><span class="p">,</span>
			<span class="mi">102700</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span> <span class="p">},</span> <span class="cm">/* 121.5 Mb */</span>
		<span class="p">[</span><span class="mi">49</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">,</span> <span class="mi">135000</span><span class="p">,</span>
			<span class="mi">112000</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span> <span class="p">},</span> <span class="cm">/* 135 Mb */</span>
		<span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_S_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_SS_HGI</span><span class="p">,</span> <span class="mi">150000</span><span class="p">,</span>
			<span class="mi">122000</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span> <span class="p">},</span> <span class="cm">/* 150 Mb */</span>
		<span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">27000</span><span class="p">,</span>
			<span class="mi">25800</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">51</span> <span class="p">},</span> <span class="cm">/* 27 Mb */</span>
		<span class="p">[</span><span class="mi">52</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">54000</span><span class="p">,</span>
			<span class="mi">49800</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">52</span> <span class="p">},</span> <span class="cm">/* 54 Mb */</span>
		<span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">81000</span><span class="p">,</span>
			<span class="mi">71900</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">53</span> <span class="p">},</span> <span class="cm">/* 81 Mb */</span>
		<span class="p">[</span><span class="mi">54</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">108000</span><span class="p">,</span>
			<span class="mi">92500</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">54</span> <span class="p">},</span> <span class="cm">/* 108 Mb */</span>
		<span class="p">[</span><span class="mi">55</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">162000</span><span class="p">,</span>
			<span class="mi">130300</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">55</span> <span class="p">},</span> <span class="cm">/* 162 Mb */</span>
		<span class="p">[</span><span class="mi">56</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">216000</span><span class="p">,</span>
			<span class="mi">162800</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">56</span> <span class="p">},</span> <span class="cm">/* 216 Mb */</span>
		<span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">243000</span><span class="p">,</span>
			<span class="mi">178200</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">57</span> <span class="p">},</span> <span class="cm">/* 243 Mb */</span>
		<span class="p">[</span><span class="mi">58</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS</span><span class="p">,</span> <span class="mi">270000</span><span class="p">,</span>
			<span class="mi">192100</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">59</span> <span class="p">},</span> <span class="cm">/* 270 Mb */</span>
		<span class="p">[</span><span class="mi">59</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">RC_HT_DT_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_DS_HGI</span><span class="p">,</span> <span class="mi">300000</span><span class="p">,</span>
			<span class="mi">207000</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">59</span> <span class="p">},</span> <span class="cm">/* 300 Mb */</span>
		<span class="p">[</span><span class="mi">60</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">40500</span><span class="p">,</span>
			<span class="mi">36100</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">60</span> <span class="p">},</span> <span class="cm">/* 40.5 Mb */</span>
		<span class="p">[</span><span class="mi">61</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">81000</span><span class="p">,</span>
			<span class="mi">72900</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">61</span> <span class="p">},</span> <span class="cm">/* 81 Mb */</span>
		<span class="p">[</span><span class="mi">62</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">121500</span><span class="p">,</span>
			<span class="mi">108300</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">62</span> <span class="p">},</span> <span class="cm">/* 121.5 Mb */</span>
		<span class="p">[</span><span class="mi">63</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">162000</span><span class="p">,</span>
			<span class="mi">142000</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">63</span> <span class="p">},</span> <span class="cm">/* 162 Mb */</span>
		<span class="p">[</span><span class="mi">64</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">243000</span><span class="p">,</span>
			<span class="mi">205100</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">65</span> <span class="p">},</span> <span class="cm">/* 243 Mb */</span>
		<span class="p">[</span><span class="mi">65</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS_HGI</span><span class="p">,</span> <span class="mi">270000</span><span class="p">,</span>
			<span class="mi">224700</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">65</span> <span class="p">},</span> <span class="cm">/* 270 Mb */</span>
		<span class="p">[</span><span class="mi">66</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">324000</span><span class="p">,</span>
			<span class="mi">263100</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">67</span> <span class="p">},</span> <span class="cm">/* 324 Mb */</span>
		<span class="p">[</span><span class="mi">67</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS_HGI</span><span class="p">,</span> <span class="mi">360000</span><span class="p">,</span>
			<span class="mi">288000</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">67</span> <span class="p">},</span> <span class="cm">/* 360 Mb */</span>
		<span class="p">[</span><span class="mi">68</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">364500</span><span class="p">,</span>
			<span class="mi">290700</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">69</span> <span class="p">},</span> <span class="cm">/* 364.5 Mb */</span>
		<span class="p">[</span><span class="mi">69</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS_HGI</span><span class="p">,</span> <span class="mi">405000</span><span class="p">,</span>
			<span class="mi">317200</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">69</span> <span class="p">},</span> <span class="cm">/* 405 Mb */</span>
		<span class="p">[</span><span class="mi">70</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS</span><span class="p">,</span> <span class="mi">405000</span><span class="p">,</span>
			<span class="mi">317200</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">71</span> <span class="p">},</span> <span class="cm">/* 405 Mb */</span>
		<span class="p">[</span><span class="mi">71</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>  <span class="n">RC_HT_T_40</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_HT_40_TS_HGI</span><span class="p">,</span> <span class="mi">450000</span><span class="p">,</span>
			<span class="mi">346400</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">71</span> <span class="p">},</span> <span class="cm">/* 450 Mb */</span>
	<span class="p">},</span>
	<span class="mi">50</span><span class="p">,</span>  <span class="cm">/* probe interval */</span>
	<span class="n">WLAN_RC_HT_FLAG</span><span class="p">,</span>  <span class="cm">/* Phy rates allowed initially */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="n">ar5416_11a_ratetable</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">8</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="p">{</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="cm">/* 6 Mb */</span>
			<span class="mi">5400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span> <span class="cm">/* 9 Mb */</span>
			<span class="mi">7800</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="cm">/* 12 Mb */</span>
			<span class="mi">10000</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">18000</span><span class="p">,</span> <span class="cm">/* 18 Mb */</span>
			<span class="mi">13900</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">24000</span><span class="p">,</span> <span class="cm">/* 24 Mb */</span>
			<span class="mi">17300</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">36000</span><span class="p">,</span> <span class="cm">/* 36 Mb */</span>
			<span class="mi">23000</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="cm">/* 48 Mb */</span>
			<span class="mi">27400</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">54000</span><span class="p">,</span> <span class="cm">/* 54 Mb */</span>
			<span class="mi">29300</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
	<span class="p">},</span>
	<span class="mi">50</span><span class="p">,</span>  <span class="cm">/* probe interval */</span>
	<span class="mi">0</span><span class="p">,</span>   <span class="cm">/* Phy rates allowed initially */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="n">ar5416_11g_ratetable</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">12</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="p">{</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_CCK</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="cm">/* 1 Mb */</span>
			<span class="mi">900</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_CCK</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="cm">/* 2 Mb */</span>
			<span class="mi">1900</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_CCK</span><span class="p">,</span> <span class="mi">5500</span><span class="p">,</span> <span class="cm">/* 5.5 Mb */</span>
			<span class="mi">4900</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_CCK</span><span class="p">,</span> <span class="mi">11000</span><span class="p">,</span> <span class="cm">/* 11 Mb */</span>
			<span class="mi">8100</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">6000</span><span class="p">,</span> <span class="cm">/* 6 Mb */</span>
			<span class="mi">5400</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_INVALID</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">9000</span><span class="p">,</span> <span class="cm">/* 9 Mb */</span>
			<span class="mi">7800</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">4</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="cm">/* 12 Mb */</span>
			<span class="mi">10000</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">18000</span><span class="p">,</span> <span class="cm">/* 18 Mb */</span>
			<span class="mi">13900</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">6</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">24000</span><span class="p">,</span> <span class="cm">/* 24 Mb */</span>
			<span class="mi">17300</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">36000</span><span class="p">,</span> <span class="cm">/* 36 Mb */</span>
			<span class="mi">23000</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">48000</span><span class="p">,</span> <span class="cm">/* 48 Mb */</span>
			<span class="mi">27400</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
		<span class="p">{</span> <span class="n">RC_L_SDT</span><span class="p">,</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">,</span> <span class="mi">54000</span><span class="p">,</span> <span class="cm">/* 54 Mb */</span>
			<span class="mi">29300</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>
	<span class="p">},</span>
	<span class="mi">50</span><span class="p">,</span>  <span class="cm">/* probe interval */</span>
	<span class="mi">0</span><span class="p">,</span>   <span class="cm">/* Phy rates allowed initially */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath_rc_get_rateindex</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mcs_rix_off</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mcs_rix_off</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="n">mcs_rix_off</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">rix</span><span class="o">++</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rix</span> <span class="o">+=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">+</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">mcs_start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">))</span>
		<span class="n">rix</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">ht_index</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">)</span>
		<span class="n">rix</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">sgi_index</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span>
		<span class="n">rix</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">cw40index</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rix</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rc_sort_validrates</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idx_next</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">max_valid_rate</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">idx_next</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">ratekbps</span> <span class="o">&gt;</span>
				<span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">idx_next</span><span class="p">].</span><span class="n">ratekbps</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx_next</span><span class="p">;</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rc_init_valid_rate_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ath_rc_set_valid_rate_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">,</span>
					   <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">valid_tx_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table_size</span><span class="p">);</span>
	<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="o">!!</span><span class="n">valid_tx_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">int</span> <span class="nf">ath_rc_get_nextvalid_txrate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">cur_valid_txrate</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">next_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">max_valid_rate</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_valid_txrate</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">next_idx</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* No more valid rates */</span>
	<span class="o">*</span><span class="n">next_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return true only for single stream */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath_rc_valid_phyrate</span><span class="p">(</span><span class="n">u32</span> <span class="n">phy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">capflag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ignore_cw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_RC_PHY_HT</span><span class="p">(</span><span class="n">phy</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">capflag</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_HT_FLAG</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_RC_PHY_DS</span><span class="p">(</span><span class="n">phy</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">capflag</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_DS_FLAG</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_RC_PHY_TS</span><span class="p">(</span><span class="n">phy</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">capflag</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_TS_FLAG</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_RC_PHY_SGI</span><span class="p">(</span><span class="n">phy</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">capflag</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_SGI_FLAG</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore_cw</span> <span class="o">&amp;&amp;</span> <span class="n">WLAN_RC_PHY_HT</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_RC_PHY_40</span><span class="p">(</span><span class="n">phy</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">capflag</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_40_FLAG</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">ath_rc_get_lower_rix</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">,</span>
		     <span class="n">u8</span> <span class="n">cur_valid_txrate</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">next_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int8_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">max_valid_rate</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_valid_txrate</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">next_idx</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ath_rc_init_validrates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">,</span>
				 <span class="n">u32</span> <span class="n">capflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">rate_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rate_flags</span> <span class="o">&amp;</span> <span class="n">RC_LEGACY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">phy</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">valid_rate_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_rc_valid_phyrate</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">capflag</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">valid_rate_count</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_ratecnt</span><span class="p">[</span><span class="n">phy</span><span class="p">];</span>

			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_rateidx</span><span class="p">[</span><span class="n">phy</span><span class="p">][</span><span class="n">valid_rate_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_ratecnt</span><span class="p">[</span><span class="n">phy</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ath_rc_set_valid_rate_idx</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ath_rc_setvalid_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath_rateset</span> <span class="o">*</span><span class="n">rateset</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">capflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Use intersection of working rates and valid rates */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rateset</span><span class="o">-&gt;</span><span class="n">rs_nrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">rate_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">phy</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">phy</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">rate_flags</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rate_flags</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">rateset</span><span class="o">-&gt;</span><span class="n">rs_rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">u8</span> <span class="n">dot11rate</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dot11rate</span><span class="p">;</span>

			<span class="cm">/* We allow a rate only if its valid and the</span>
<span class="cm">			 * capflag matches one of the validity</span>
<span class="cm">			 * (VALID/VALID_20/VALID_40) flags */</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">rate</span> <span class="o">==</span> <span class="n">dot11rate</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">rate_flags</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_CAP_MODE</span><span class="p">(</span><span class="n">capflag</span><span class="p">))</span> <span class="o">==</span>
			    <span class="n">WLAN_RC_CAP_MODE</span><span class="p">(</span><span class="n">capflag</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">rate_flags</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_CAP_STREAM</span><span class="p">(</span><span class="n">capflag</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">WLAN_RC_PHY_HT</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">valid_rate_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_rc_valid_phyrate</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">capflag</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="n">valid_rate_count</span> <span class="o">=</span>
					<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_ratecnt</span><span class="p">[</span><span class="n">phy</span><span class="p">];</span>

				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_rateidx</span><span class="p">[</span><span class="n">phy</span><span class="p">]</span>
					<span class="p">[</span><span class="n">valid_rate_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_ratecnt</span><span class="p">[</span><span class="n">phy</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ath_rc_set_valid_rate_idx</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">hi</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ath_rc_setvalid_htrates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ath_rateset</span> <span class="o">*</span><span class="n">rateset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">capflag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Use intersection of working rates and valid rates */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rateset</span><span class="o">-&gt;</span><span class="n">rs_nrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">rate_cnt</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">phy</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">phy</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">rate_flags</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">rate_flags</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">rateset</span><span class="o">-&gt;</span><span class="n">rs_rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">u8</span> <span class="n">dot11rate</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dot11rate</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">rate</span> <span class="o">!=</span> <span class="n">dot11rate</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">WLAN_RC_PHY_HT</span><span class="p">(</span><span class="n">phy</span><span class="p">)</span> <span class="o">||</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">rate_flags</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_CAP_STREAM</span><span class="p">(</span><span class="n">capflag</span><span class="p">))</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">WLAN_RC_PHY_HT_VALID</span><span class="p">(</span><span class="n">rate_flags</span><span class="p">,</span> <span class="n">capflag</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_rc_valid_phyrate</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span> <span class="n">capflag</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_rateidx</span><span class="p">[</span><span class="n">phy</span><span class="p">]</span>
				<span class="p">[</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_ratecnt</span><span class="p">[</span><span class="n">phy</span><span class="p">]]</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_ratecnt</span><span class="p">[</span><span class="n">phy</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ath_rc_set_valid_rate_idx</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">hi</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hi</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Finds the highest rate index we can use */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">ath_rc_get_highest_rix</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
			         <span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="o">*</span><span class="n">is_probing</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="n">legacy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">best_thruput</span><span class="p">,</span> <span class="n">this_thruput</span><span class="p">,</span> <span class="n">now_msec</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">,</span> <span class="n">next_rate</span><span class="p">,</span> <span class="n">best_rate</span><span class="p">,</span> <span class="n">maxindex</span><span class="p">,</span> <span class="n">minindex</span><span class="p">;</span>
	<span class="kt">int8_t</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">now_msec</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
	<span class="o">*</span><span class="n">is_probing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">best_thruput</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">maxindex</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">max_valid_rate</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">minindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">best_rate</span> <span class="o">=</span> <span class="n">minindex</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Try the higher rate first. It will reduce memory moving time</span>
<span class="cm">	 * if we have very good channel characteristics.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">maxindex</span><span class="p">;</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="n">minindex</span> <span class="p">;</span> <span class="n">index</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">per_thres</span><span class="p">;</span>

		<span class="n">rate</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">legacy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rate</span><span class="p">].</span><span class="n">rate_flags</span> <span class="o">&amp;</span> <span class="n">RC_LEGACY</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_max_phy</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * For TCP the average collision rate is around 11%,</span>
<span class="cm">		 * so we ignore PERs less than this.  This is to</span>
<span class="cm">		 * prevent the rate we are currently using (whose</span>
<span class="cm">		 * PER might be in the 10-15 range because of TCP</span>
<span class="cm">		 * collisions) looking worse than the next lower</span>
<span class="cm">		 * rate whose PER has decayed close to 0.  If we</span>
<span class="cm">		 * used to next lower rate, its PER would grow to</span>
<span class="cm">		 * 10-15 and we would be worse off then staying</span>
<span class="cm">		 * at the current rate.</span>
<span class="cm">		 */</span>
		<span class="n">per_thres</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">rate</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">per_thres</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">)</span>
			<span class="n">per_thres</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>

		<span class="n">this_thruput</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rate</span><span class="p">].</span><span class="n">user_ratekbps</span> <span class="o">*</span>
			<span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">per_thres</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">best_thruput</span> <span class="o">&lt;=</span> <span class="n">this_thruput</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_thruput</span> <span class="o">=</span> <span class="n">this_thruput</span><span class="p">;</span>
			<span class="n">best_rate</span>    <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">best_rate</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Must check the actual rate (ratekbps) to account for</span>
<span class="cm">	 * non-monoticity of 11g&#39;s rate table</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_max_phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_max_phy</span><span class="p">;</span>

		<span class="cm">/* Probe the next allowed phy state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_get_nextvalid_txrate</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span>
					<span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_rate</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">now_msec</span> <span class="o">-</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_time</span> <span class="o">&gt;</span>
		     <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">probe_interval</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">hw_maxretry_pktcnt</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">next_rate</span><span class="p">;</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_time</span> <span class="o">=</span> <span class="n">now_msec</span><span class="p">;</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">hw_maxretry_pktcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">is_probing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RC_TS_ONLY</span><span class="p">(</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rate</span><span class="p">].</span><span class="n">rate_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_TS_FLAG</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RC_DS_OR_LATER</span><span class="p">(</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rate</span><span class="p">].</span><span class="n">rate_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WLAN_RC_DS_FLAG</span> <span class="o">|</span> <span class="n">WLAN_RC_TS_FLAG</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RC_SS_OR_LEGACY</span><span class="p">(</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rate</span><span class="p">].</span><span class="n">rate_flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>

	<span class="cm">/* This should not happen */</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rc_rate_set_series</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_tx_rate_control</span> <span class="o">*</span><span class="n">txrc</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="n">tries</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rtsctsenable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rate</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">tries</span><span class="p">;</span>
	<span class="n">rate</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">ratecode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txrc</span><span class="o">-&gt;</span><span class="n">short_preamble</span><span class="p">)</span>
		<span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_USE_SHORT_PREAMBLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txrc</span><span class="o">-&gt;</span><span class="n">rts</span> <span class="o">||</span> <span class="n">rtsctsenable</span><span class="p">)</span>
		<span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_RC_PHY_HT</span><span class="p">(</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_RC_PHY_40</span><span class="p">(</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">phy</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">conf_is_ht40</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txrc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">))</span>
			<span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_RC_PHY_SGI</span><span class="p">(</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">phy</span><span class="p">))</span>
			<span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rc_rate_set_rtscts</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rates</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cix</span><span class="p">,</span> <span class="n">enable_g_protection</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get the cix for the lowest valid rix */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rix</span> <span class="o">=</span> <span class="n">ath_rc_get_rateindex</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">cix</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">ctrl_rate</span><span class="p">;</span>

	<span class="cm">/* All protection frames are transmited at 2Mb/s for 802.11g,</span>
<span class="cm">	 * otherwise we transmit them at 1Mb/s */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">conf_is_ht</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">))</span>
		<span class="n">enable_g_protection</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If 802.11g protection is enabled, determine whether to use RTS/CTS or</span>
<span class="cm">	 * just CTS.  Note that this is only done for OFDM/HT unicast frames.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span> <span class="o">&amp;&amp;</span>
	     <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_cts_prot</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">phy</span> <span class="o">==</span> <span class="n">WLAN_RC_PHY_OFDM</span> <span class="o">||</span>
	     <span class="n">WLAN_RC_PHY_HT</span><span class="p">(</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">phy</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">;</span>
		<span class="n">cix</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">enable_g_protection</span><span class="p">].</span><span class="n">ctrl_rate</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rts_cts_rate_idx</span> <span class="o">=</span> <span class="n">cix</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_get_rate</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_sta</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_tx_rate_control</span> <span class="o">*</span><span class="n">txrc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span> <span class="o">=</span> <span class="n">priv_sta</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">txrc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rates</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">try_per_rate</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="n">high_rix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_probe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_control_send_low</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">priv_sta</span><span class="p">,</span> <span class="n">txrc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For Multi Rate Retry we use a different number of</span>
<span class="cm">	 * retry attempt counts. This ends up looking like this:</span>
<span class="cm">	 *</span>
<span class="cm">	 * MRR[0] = 4</span>
<span class="cm">	 * MRR[1] = 4</span>
<span class="cm">	 * MRR[2] = 4</span>
<span class="cm">	 * MRR[3] = 8</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="n">try_per_rate</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">rate_table</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table</span><span class="p">;</span>
	<span class="n">rix</span> <span class="o">=</span> <span class="n">ath_rc_get_highest_rix</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">rate_table</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">is_probe</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">high_rix</span> <span class="o">=</span> <span class="n">rix</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re in HT mode and both us and our peer supports LDPC.</span>
<span class="cm">	 * We don&#39;t need to check our own device&#39;s capabilities as our own</span>
<span class="cm">	 * ht capabilities would have already been intersected with our peer&#39;s.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_LDPC_CODING</span><span class="p">))</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_LDPC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_TX_STBC</span><span class="p">))</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_TX_CTL_STBC_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_probe</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set one try for probe rates. For the</span>
<span class="cm">		 * probes don&#39;t enable rts */</span>
		<span class="n">ath_rc_rate_set_series</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span> <span class="n">txrc</span><span class="p">,</span>
				       <span class="mi">1</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Get the next tried/allowed rate. No RTS for the next series</span>
<span class="cm">		 * after the probe rate</span>
<span class="cm">		 */</span>
		<span class="n">ath_rc_get_lower_rix</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rix</span><span class="p">);</span>
		<span class="n">ath_rc_rate_set_series</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span> <span class="n">txrc</span><span class="p">,</span>
				       <span class="n">try_per_rate</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_RATE_CTRL_PROBE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set the chosen rate. No RTS for first series entry. */</span>
		<span class="n">ath_rc_rate_set_series</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span> <span class="n">txrc</span><span class="p">,</span>
				       <span class="n">try_per_rate</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Fill in the other rates for multirate retry */</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ath_rc_get_lower_rix</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rix</span><span class="p">);</span>
		<span class="cm">/* All other rates in the series have RTS enabled */</span>
		<span class="n">ath_rc_rate_set_series</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">txrc</span><span class="p">,</span>
				       <span class="n">try_per_rate</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Use twice the number of tries for the last MRR segment. */</span>
	<span class="n">try_per_rate</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use a legacy rate as last retry to ensure that the frame</span>
<span class="cm">	 * is tried in both MCS and legacy rates.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rates</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">high_rix</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">45</span><span class="p">)))</span>
		<span class="n">rix</span> <span class="o">=</span> <span class="n">ath_rc_get_highest_rix</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">rate_table</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">is_probe</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ath_rc_get_lower_rix</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rix</span><span class="p">);</span>

	<span class="cm">/* All other rates in the series have RTS enabled */</span>
	<span class="n">ath_rc_rate_set_series</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">txrc</span><span class="p">,</span>
			       <span class="n">try_per_rate</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * NB:Change rate series to enable aggregation when operating</span>
<span class="cm">	 * at lower MCS rates. When first rate in series is MCS2</span>
<span class="cm">	 * in HT40 @ 2.4GHz, series should look like:</span>
<span class="cm">	 *</span>
<span class="cm">	 * {MCS2, MCS1, MCS0, MCS0}.</span>
<span class="cm">	 *</span>
<span class="cm">	 * When first rate in series is MCS3 in HT20 @ 2.4GHz, series should</span>
<span class="cm">	 * look like:</span>
<span class="cm">	 *</span>
<span class="cm">	 * {MCS3, MCS2, MCS1, MCS1}</span>
<span class="cm">	 *</span>
<span class="cm">	 * So, set fourth rate in series to be same as third one for</span>
<span class="cm">	 * above conditions.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">conf_is_ht</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">dot11rate</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">dot11rate</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">phy</span> <span class="o">=</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">rix</span><span class="p">].</span><span class="n">phy</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">dot11rate</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span> <span class="o">==</span> <span class="n">WLAN_RC_PHY_HT_40_SS</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">dot11rate</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span> <span class="o">==</span> <span class="n">WLAN_RC_PHY_HT_20_SS</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rates</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
			<span class="n">rates</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Force hardware to use computed duration for next</span>
<span class="cm">	 * fragment by disabling multi-rate retry, which</span>
<span class="cm">	 * updates duration based on the multi-rate duration table.</span>
<span class="cm">	 *</span>
<span class="cm">	 * FIXME: Fix duration</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_FRAG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rates</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rates</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">ATH_TXMAXTRY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup RTS/CTS */</span>
	<span class="n">ath_rc_rate_set_rtscts</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">rate_table</span><span class="p">,</span> <span class="n">tx_info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rc_update_per</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">tx_rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xretries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">now_msec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">n_bad_frames</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">last_per</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">nretry_to_per_lookup</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">100</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">/</span> <span class="mi">1</span><span class="p">,</span>
		<span class="mi">100</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
		<span class="mi">100</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
		<span class="mi">100</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
		<span class="mi">100</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span>
		<span class="mi">100</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">/</span> <span class="mi">6</span><span class="p">,</span>
		<span class="mi">100</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">/</span> <span class="mi">7</span><span class="p">,</span>
		<span class="mi">100</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span>
		<span class="mi">100</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">9</span><span class="p">,</span>
		<span class="mi">100</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">/</span> <span class="mi">10</span>
	<span class="p">};</span>

	<span class="n">last_per</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">];</span>
	<span class="n">n_bad_frames</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span> <span class="o">-</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xretries</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xretries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">30</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* xretries == 2 */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nretry_to_per_lookup</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">)</span>
				<span class="n">retries</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* new_PER = 7/8*old_PER + 1/8*(currentPER) */</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">last_per</span> <span class="o">-</span> <span class="p">(</span><span class="n">last_per</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">100</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* xretries == 1 or 2 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_rate</span> <span class="o">==</span> <span class="n">tx_rate</span><span class="p">)</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* xretries == 0 */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">nretry_to_per_lookup</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;=</span> <span class="n">count</span><span class="p">)</span>
			<span class="n">retries</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n_bad_frames</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* new_PER = 7/8*old_PER + 1/8*(currentPER)</span>
<span class="cm">			 * Assuming that n_frames is not 0.  The current PER</span>
<span class="cm">			 * from the retries is 100 * retries / (retries+1),</span>
<span class="cm">			 * since the first retries attempts failed, and the</span>
<span class="cm">			 * next one worked.  For the one that worked,</span>
<span class="cm">			 * n_bad_frames subframes out of n_frames wored,</span>
<span class="cm">			 * so the PER for that part is</span>
<span class="cm">			 * 100 * n_bad_frames / n_frames, and it contributes</span>
<span class="cm">			 * 100 * n_bad_frames / (n_frames * (retries+1)) to</span>
<span class="cm">			 * the above PER.  The expression below is a</span>
<span class="cm">			 * simplified version of the sum of these two terms.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">n_frames</span><span class="p">,</span> <span class="n">n_bad_tries</span><span class="p">;</span>
				<span class="n">u8</span> <span class="n">cur_per</span><span class="p">,</span> <span class="n">new_per</span><span class="p">;</span>

				<span class="n">n_bad_tries</span> <span class="o">=</span> <span class="n">retries</span> <span class="o">*</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span> <span class="o">+</span>
					<span class="n">n_bad_frames</span><span class="p">;</span>
				<span class="n">n_frames</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span> <span class="o">*</span> <span class="p">(</span><span class="n">retries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">cur_per</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">n_bad_tries</span> <span class="o">/</span> <span class="n">n_frames</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">new_per</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">last_per</span> <span class="o">-</span> <span class="p">(</span><span class="n">last_per</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">cur_per</span><span class="p">);</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_per</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">last_per</span> <span class="o">-</span> <span class="p">(</span><span class="n">last_per</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
				     <span class="p">(</span><span class="n">nretry_to_per_lookup</span><span class="p">[</span><span class="n">retries</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">));</span>
		<span class="p">}</span>


		<span class="cm">/*</span>
<span class="cm">		 * If we got at most one retry then increase the max rate if</span>
<span class="cm">		 * this was a probe.  Otherwise, ignore the probe.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_rate</span> <span class="o">&amp;&amp;</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_rate</span> <span class="o">==</span> <span class="n">tx_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_bad_frames</span> <span class="o">&gt;</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Since we probed with just a single attempt,</span>
<span class="cm">				 * any retries means the probe failed.  Also,</span>
<span class="cm">				 * if the attempt worked, but more than half</span>
<span class="cm">				 * the subframes were bad then also consider</span>
<span class="cm">				 * the probe a failure.</span>
<span class="cm">				 */</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">probe_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_max_phy</span> <span class="o">=</span>
					<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_rate</span><span class="p">;</span>
				<span class="n">probe_rate</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_rate</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">probe_rate</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span>
					<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">probe_rate</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * Since this probe succeeded, we allow the next</span>
<span class="cm">				 * probe twice as soon.  This allows the maxRate</span>
<span class="cm">				 * to move up faster if the probes are</span>
<span class="cm">				 * successful.</span>
<span class="cm">				 */</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_time</span> <span class="o">=</span>
					<span class="n">now_msec</span> <span class="o">-</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">probe_interval</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Don&#39;t update anything.  We don&#39;t know if</span>
<span class="cm">			 * this was because of collisions or poor signal.</span>
<span class="cm">			 */</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">hw_maxretry_pktcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * It worked with no retries. First ignore bogus (small)</span>
<span class="cm">			 * rssi_ack values.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_rate</span> <span class="o">==</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_max_phy</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">hw_maxretry_pktcnt</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">hw_maxretry_pktcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_debug_stat_retries</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rix</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">xretries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">,</span> <span class="n">u8</span> <span class="n">per</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_rc_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rcstats</span><span class="p">[</span><span class="n">rix</span><span class="p">];</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">xretries</span> <span class="o">+=</span> <span class="n">xretries</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">+=</span> <span class="n">retries</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">per</span> <span class="o">=</span> <span class="n">per</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Update PER, RSSI and whatever else that the code thinks it is doing.</span>
<span class="cm">   If you can make sense of all this, you really need to go out more. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rc_update_ht</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">tx_rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xretries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">retries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">now_msec</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">last_per</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tx_rate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tx_rate</span> <span class="o">&gt;</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">rate_cnt</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">last_per</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">];</span>

	<span class="cm">/* Update PER first */</span>
	<span class="n">ath_rc_update_per</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">rate_table</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="p">,</span>
			  <span class="n">tx_info</span><span class="p">,</span> <span class="n">tx_rate</span><span class="p">,</span> <span class="n">xretries</span><span class="p">,</span>
			  <span class="n">retries</span><span class="p">,</span> <span class="n">now_msec</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If this rate looks bad (high PER) then stop using it for</span>
<span class="cm">	 * a while (except if we are probing).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">55</span> <span class="o">&amp;&amp;</span> <span class="n">tx_rate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">].</span><span class="n">ratekbps</span> <span class="o">&lt;=</span>
	    <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_max_phy</span><span class="p">].</span><span class="n">ratekbps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_rc_get_lower_rix</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tx_rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_max_phy</span><span class="p">);</span>

		<span class="cm">/* Don&#39;t probe for a little while. */</span>
		<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">probe_time</span> <span class="o">=</span> <span class="n">now_msec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Make sure the rates below this have lower PER */</span>
	<span class="cm">/* Monotonicity is kept only for rates below the current rate. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">last_per</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">rate</span> <span class="o">=</span> <span class="n">tx_rate</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">rate</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rate</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">&gt;</span>
			    <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">rate</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">rate</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Maintain monotonicity for rates above the current rate */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rate</span> <span class="o">=</span> <span class="n">tx_rate</span><span class="p">;</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">rate</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">rate</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span>
		    <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">rate</span><span class="p">])</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">rate</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">rate</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Every so often, we reduce the thresholds</span>
<span class="cm">	 * and PER (different for CCK and OFDM). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">now_msec</span> <span class="o">-</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per_down_time</span> <span class="o">&gt;=</span>
	    <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">probe_interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">rate</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span>
				<span class="mi">7</span> <span class="o">*</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per_down_time</span> <span class="o">=</span> <span class="n">now_msec</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath_debug_stat_retries</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">tx_rate</span><span class="p">,</span> <span class="n">xretries</span><span class="p">,</span> <span class="n">retries</span><span class="p">,</span>
			       <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">tx_rate</span><span class="p">]);</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rc_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">final_ts_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">xretries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">long_retry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rates</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rix</span><span class="p">;</span>

	<span class="n">rate_table</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the first rate is not the final index, there</span>
<span class="cm">	 * are intermediate rate failures to be processed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">final_ts_idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Process intermediate rates that failed.*/</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">final_ts_idx</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">flags</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>

				<span class="cm">/* If HT40 and we have switched mode from</span>
<span class="cm">				 * 40 to 20 =&gt; don&#39;t update */</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="o">!</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_40_FLAG</span><span class="p">))</span>
					<span class="k">return</span><span class="p">;</span>

				<span class="n">rix</span> <span class="o">=</span> <span class="n">ath_rc_get_rateindex</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">ath_rc_update_ht</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">tx_info</span><span class="p">,</span>
						<span class="n">rix</span><span class="p">,</span> <span class="n">xretries</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
						<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Handle the special case of MIMO PS burst, where the second</span>
<span class="cm">		 * aggregate is sent out with only one rate and one try.</span>
<span class="cm">		 * Treating it as an excessive retry penalizes the rate</span>
<span class="cm">		 * inordinately.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">xretries</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">xretries</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* If HT40 and we have switched mode from 40 to 20 =&gt; don&#39;t update */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_40_FLAG</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rix</span> <span class="o">=</span> <span class="n">ath_rc_get_rateindex</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">ath_rc_update_ht</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">tx_info</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="n">xretries</span><span class="p">,</span> <span class="n">long_retry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span>
<span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="nf">ath_choose_rate_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
					     <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span>
					     <span class="n">bool</span> <span class="n">is_ht</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ht</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">ar5416_11ng_ratetable</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">ar5416_11g_ratetable</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_5GHZ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_ht</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">ar5416_11na_ratetable</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">ar5416_11a_ratetable</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Invalid band</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_rateset</span> <span class="o">*</span><span class="n">rateset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">neg_rates</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_rateset</span> <span class="o">*</span><span class="n">ht_mcs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">neg_ht_rates</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">hi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hthi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initial rate table size. Will change depending</span>
<span class="cm">	 * on the working rate set */</span>
	<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table_size</span> <span class="o">=</span> <span class="n">RATE_TABLE_SIZE</span><span class="p">;</span>

	<span class="cm">/* Initialize thresholds according to the global rate table */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Determine the valid rates */</span>
	<span class="n">ath_rc_init_valid_rate_idx</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WLAN_RC_PHY_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">RATE_TABLE_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_rateidx</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_ratecnt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rateset</span><span class="o">-&gt;</span><span class="n">rs_nrates</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No working rate, just initialize valid rates */</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">ath_rc_init_validrates</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">rate_table</span><span class="p">,</span>
					    <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Use intersection of working rates and valid rates */</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">ath_rc_setvalid_rates</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">rate_table</span><span class="p">,</span>
					   <span class="n">rateset</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_HT_FLAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hthi</span> <span class="o">=</span> <span class="n">ath_rc_setvalid_htrates</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="p">,</span>
						       <span class="n">rate_table</span><span class="p">,</span>
						       <span class="n">ht_mcs</span><span class="p">,</span>
						       <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hi</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">hi</span><span class="p">,</span> <span class="n">hthi</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table_size</span> <span class="o">=</span> <span class="n">hi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_max_phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table_size</span> <span class="o">&gt;</span> <span class="n">RATE_TABLE_SIZE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WLAN_RC_PHY_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_ratecnt</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_rateidx</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_rc_valid_phyrate</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">initial_ratemax</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
		    <span class="o">||</span> <span class="o">!</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_ratecnt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_max_phy</span> <span class="o">=</span> <span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_phy_rateidx</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table_size</span> <span class="o">&gt;</span> <span class="n">RATE_TABLE_SIZE</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="n">RATE_TABLE_SIZE</span><span class="p">);</span>

	<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">max_valid_rate</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
	<span class="n">ath_rc_sort_validrates</span><span class="p">(</span><span class="n">rate_table</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="p">);</span>
	<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_max_phy</span> <span class="o">=</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span>
					<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">valid_rate_index</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table</span> <span class="o">=</span> <span class="n">rate_table</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;RC Initialized with capabilities: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ath_rc_build_ht_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="n">is_cw40</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_sgi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">caps</span> <span class="o">=</span> <span class="n">WLAN_RC_HT_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
			<span class="n">caps</span> <span class="o">|=</span> <span class="n">WLAN_RC_TS_FLAG</span> <span class="o">|</span> <span class="n">WLAN_RC_DS_FLAG</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">caps</span> <span class="o">|=</span> <span class="n">WLAN_RC_DS_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_cw40</span><span class="p">)</span>
			<span class="n">caps</span> <span class="o">|=</span> <span class="n">WLAN_RC_40_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_sgi</span><span class="p">)</span>
			<span class="n">caps</span> <span class="o">|=</span> <span class="n">WLAN_RC_SGI_FLAG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">caps</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath_tx_aggr_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">tidno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">txtid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">txtid</span> <span class="o">=</span> <span class="n">ATH_AN_2_TID</span><span class="p">(</span><span class="n">an</span><span class="p">,</span> <span class="n">tidno</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txtid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AGGR_ADDBA_COMPLETE</span> <span class="o">|</span> <span class="n">AGGR_ADDBA_PROGRESS</span><span class="p">)))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/***********************************/</span>
<span class="cm">/* mac80211 Rate Control callbacks */</span>
<span class="cm">/***********************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_debug_stat_rc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">rc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">final_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_rc_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rcstats</span><span class="p">[</span><span class="n">final_rate</span><span class="p">];</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">success</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_status</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_sta</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span> <span class="o">=</span> <span class="n">priv_sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">final_ts_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">long_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">final_ts_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">long_retry</span> <span class="o">=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv_sta</span> <span class="o">||</span> <span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* This packet was aggregated but doesn&#39;t carry status info */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_AMPDU</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_TX_FILTERED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">))</span>
		<span class="n">tx_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ath_rc_tx_status</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ath_rc_priv</span><span class="p">,</span> <span class="n">tx_info</span><span class="p">,</span> <span class="n">final_ts_idx</span><span class="p">,</span> <span class="n">tx_status</span><span class="p">,</span>
			 <span class="n">long_retry</span><span class="p">);</span>

	<span class="cm">/* Check if aggregation has to be enabled for this tid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_PAE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">IEEE80211_AC_VO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span><span class="p">,</span> <span class="n">tid</span><span class="p">;</span>

			<span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
			<span class="n">tid</span> <span class="o">=</span> <span class="n">qc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span><span class="n">ath_tx_aggr_check</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">))</span>
				<span class="n">ieee80211_start_tx_ba_session</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ath_debug_stat_rc</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="p">,</span>
		<span class="n">ath_rc_get_rateindex</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">rate_table</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">final_ts_idx</span><span class="p">]));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rate_init</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">,</span>
                          <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span> <span class="o">=</span> <span class="n">priv_sta</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_cw40</span><span class="p">,</span> <span class="n">is_sgi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">neg_rates</span><span class="p">.</span><span class="n">rs_rates</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
				<span class="o">=</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">neg_rates</span><span class="p">.</span><span class="n">rs_nrates</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">77</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="mi">8</span><span class="p">)))</span>
				<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">neg_ht_rates</span><span class="p">.</span><span class="n">rs_rates</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">ATH_RATE_MAX</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">neg_ht_rates</span><span class="p">.</span><span class="n">rs_nrates</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">is_cw40</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_cw40</span><span class="p">)</span>
		<span class="n">is_sgi</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_SGI_20</span><span class="p">)</span>
		<span class="n">is_sgi</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span><span class="p">);</span>

	<span class="cm">/* Choose rate table first */</span>

	<span class="n">rate_table</span> <span class="o">=</span> <span class="n">ath_choose_rate_table</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span>
	                      <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">);</span>

	<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span> <span class="o">=</span> <span class="n">ath_rc_build_ht_caps</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">is_cw40</span><span class="p">,</span> <span class="n">is_sgi</span><span class="p">);</span>
	<span class="n">ath_rc_init</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">priv_sta</span><span class="p">,</span> <span class="n">sband</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">rate_table</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rate_update</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_sta</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">ath_rc_priv</span> <span class="o">=</span> <span class="n">priv_sta</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ath_rate_table</span> <span class="o">*</span><span class="n">rate_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">oper_cw40</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">oper_sgi</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">local_cw40</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_40_FLAG</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">local_sgi</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span> <span class="o">&amp;</span> <span class="n">WLAN_RC_SGI_FLAG</span><span class="p">);</span>

	<span class="cm">/* FIXME: Handle AP mode later when we support CWM */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RC_BW_CHANGED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span><span class="p">)</span>
			<span class="n">oper_cw40</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">oper_cw40</span><span class="p">)</span>
			<span class="n">oper_sgi</span> <span class="o">=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">)</span> <span class="o">?</span>
				   <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_SGI_20</span><span class="p">)</span>
			<span class="n">oper_sgi</span> <span class="o">=</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span><span class="p">)</span> <span class="o">?</span>
				   <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">oper_sgi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">local_cw40</span> <span class="o">!=</span> <span class="n">oper_cw40</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">local_sgi</span> <span class="o">!=</span> <span class="n">oper_sgi</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rate_table</span> <span class="o">=</span> <span class="n">ath_choose_rate_table</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span>
						   <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">);</span>
			<span class="n">ath_rc_priv</span><span class="o">-&gt;</span><span class="n">ht_cap</span> <span class="o">=</span> <span class="n">ath_rc_build_ht_caps</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
						   <span class="n">oper_cw40</span><span class="p">,</span> <span class="n">oper_sgi</span><span class="p">);</span>
			<span class="n">ath_rc_init</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">priv_sta</span><span class="p">,</span> <span class="n">sband</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">rate_table</span><span class="p">);</span>

			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">),</span> <span class="n">CONFIG</span><span class="p">,</span>
				<span class="s">&quot;Operating HT Bandwidth changed to: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel_type</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ATH9K_DEBUGFS</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">read_file_rcstat</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rate_table</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span> <span class="mi">80</span> <span class="o">+</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">rate_table_size</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%6s %6s %6s &quot;</span>
		       <span class="s">&quot;%10s %10s %10s %10s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="s">&quot;HT&quot;</span><span class="p">,</span> <span class="s">&quot;MCS&quot;</span><span class="p">,</span> <span class="s">&quot;Rate&quot;</span><span class="p">,</span>
		       <span class="s">&quot;Success&quot;</span><span class="p">,</span> <span class="s">&quot;Retries&quot;</span><span class="p">,</span> <span class="s">&quot;XRetries&quot;</span><span class="p">,</span> <span class="s">&quot;PER&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">rate_table_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ratekbps</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ratekbps</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ath_rc_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rcstats</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">char</span> <span class="n">mcs</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="kt">char</span> <span class="n">htmode</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">used_mcs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">used_htmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_RC_PHY_HT</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">used_mcs</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">mcs</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span>
				<span class="n">rc</span><span class="o">-&gt;</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ratecode</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">WLAN_RC_PHY_40</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy</span><span class="p">))</span>
				<span class="n">used_htmode</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">htmode</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;HT40&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">WLAN_RC_PHY_20</span><span class="p">(</span><span class="n">rc</span><span class="o">-&gt;</span><span class="n">rate_table</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phy</span><span class="p">))</span>
				<span class="n">used_htmode</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">htmode</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;HT20&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">used_htmode</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">htmode</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;????&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">mcs</span><span class="p">[</span><span class="n">used_mcs</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">htmode</span><span class="p">[</span><span class="n">used_htmode</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">max</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span>
			<span class="s">&quot;%6s %6s %3u.%d: &quot;</span>
			<span class="s">&quot;%10u %10u %10u %10u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">htmode</span><span class="p">,</span>
			<span class="n">mcs</span><span class="p">,</span>
			<span class="n">ratekbps</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
			<span class="p">(</span><span class="n">ratekbps</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">success</span><span class="p">,</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">,</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">xretries</span><span class="p">,</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">per</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fops_rcstat</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">read_file_rcstat</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rate_add_sta_debugfs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv_sta</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">priv_sta</span><span class="p">;</span>
	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rc_stats&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fops_rcstat</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_ATH9K_DEBUGFS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ath_rate_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfsdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rate_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ath_rate_alloc_sta</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">rate_priv</span><span class="p">;</span>

	<span class="n">rate_priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_rate_priv</span><span class="p">),</span> <span class="n">gfp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rate_priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">),</span>
			<span class="s">&quot;Unable to allocate private rc structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rate_priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rate_free_sta</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">priv_sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_rate_priv</span> <span class="o">*</span><span class="n">rate_priv</span> <span class="o">=</span> <span class="n">priv_sta</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rate_priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rate_control_ops</span> <span class="n">ath_rate_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ath9k_rate_control&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_status</span> <span class="o">=</span> <span class="n">ath_tx_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span> <span class="o">=</span> <span class="n">ath_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_init</span> <span class="o">=</span> <span class="n">ath_rate_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_update</span> <span class="o">=</span> <span class="n">ath_rate_update</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">ath_rate_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">ath_rate_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_sta</span> <span class="o">=</span> <span class="n">ath_rate_alloc_sta</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_sta</span> <span class="o">=</span> <span class="n">ath_rate_free_sta</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_ATH9K_DEBUGFS</span>
	<span class="p">.</span><span class="n">add_sta_debugfs</span> <span class="o">=</span> <span class="n">ath_rate_add_sta_debugfs</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">ath_rate_control_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ieee80211_rate_control_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ath_rate_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_rate_control_unregister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_rate_control_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ath_rate_ops</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
