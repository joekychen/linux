<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/nl80211.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &quot;ath9k.h&quot;</span>
<span class="cp">#include &quot;btcoex.h&quot;</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">parse_mpdudensity</span><span class="p">(</span><span class="n">u8</span> <span class="n">mpdudensity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * 802.11n D2.0 defined values for &quot;Minimum MPDU Start Spacing&quot;:</span>
<span class="cm">	 *   0 for no restriction</span>
<span class="cm">	 *   1 for 1/4 us</span>
<span class="cm">	 *   2 for 1/2 us</span>
<span class="cm">	 *   3 for 1 us</span>
<span class="cm">	 *   4 for 2 us</span>
<span class="cm">	 *   5 for 4 us</span>
<span class="cm">	 *   6 for 8 us</span>
<span class="cm">	 *   7 for 16 us</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mpdudensity</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* Our lower layer calculations limit our precision to</span>
<span class="cm">		   1 microsecond */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">return</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">return</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_has_pending_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_depth</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_acq</span><span class="p">))</span>
		<span class="n">pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pending</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_setpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ath9k_power_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_ps_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ath9k_power_mode</span> <span class="n">power_mode</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_usecount</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">power_mode</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">;</span>
	<span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * While the hardware is asleep, the cycle counters contain no</span>
<span class="cm">	 * useful data. Better clear them now so that they don&#39;t mess up</span>
<span class="cm">	 * survey data results.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">power_mode</span> <span class="o">!=</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
		<span class="n">ath_hw_cycle_counters_update</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_survey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_survey</span><span class="p">));</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_ps_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">ath9k_power_mode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">reset</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_usecount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath9k_hw_setrxabort</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ath9k_hw_stopdmarecv</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reset</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">ATH9K_PM_FULL_SLEEP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_enabled</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PS_WAIT_FOR_BEACON</span> <span class="o">|</span>
				     <span class="n">PS_WAIT_FOR_CAB</span> <span class="o">|</span>
				     <span class="n">PS_WAIT_FOR_PSPOLL_DATA</span> <span class="o">|</span>
				     <span class="n">PS_WAIT_FOR_TX_ACK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">ATH9K_PM_NETWORK_SLEEP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
	<span class="n">ath_hw_cycle_counters_update</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

	<span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

 <span class="nl">unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_start_ani</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_ANI_RUN</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_OFFCHANNEL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">longcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">shortcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">checkani_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span>
			<span class="n">msecs_to_jiffies</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ani_poll_interval</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_update_survey_nf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">noisefloor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">SURVEY_INFO_NOISE_DBM</span><span class="p">;</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">ath9k_hw_getchan_noise</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Updates the survey statistics and returns the busy time since last</span>
<span class="cm"> * update in %, if the measurement duration was long enough for the</span>
<span class="cm"> * result to be useful, -1 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath_update_survey_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ath_cycle_counters</span> <span class="o">*</span><span class="n">cc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_survey</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">div</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">clockrate</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">)</span>
		<span class="n">ath_hw_cycle_counters_update</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cycles</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">SURVEY_INFO_CHANNEL_TIME</span> <span class="o">|</span>
			<span class="n">SURVEY_INFO_CHANNEL_TIME_BUSY</span> <span class="o">|</span>
			<span class="n">SURVEY_INFO_CHANNEL_TIME_RX</span> <span class="o">|</span>
			<span class="n">SURVEY_INFO_CHANNEL_TIME_TX</span><span class="p">;</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time</span> <span class="o">+=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">cycles</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_busy</span> <span class="o">+=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">rx_busy</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_rx</span> <span class="o">+=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">rx_frame</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_tx</span> <span class="o">+=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">tx_frame</span> <span class="o">/</span> <span class="n">div</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cycles</span> <span class="o">&lt;</span> <span class="n">div</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">-&gt;</span><span class="n">cycles</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">rx_busy</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">cc</span><span class="o">-&gt;</span><span class="n">cycles</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cc</span><span class="p">));</span>

	<span class="n">ath_update_survey_nf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ath_cancel_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">paprd_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_check_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx_complete_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_pll_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_cancel_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__ath_cancel_work</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_reset_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath_prepare_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">retry_tx</span><span class="p">,</span> <span class="n">bool</span> <span class="n">flush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_busy_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx_poll_timer</span><span class="p">);</span>

	<span class="n">ath9k_debug_samp_bb_mac</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ath9k_hw_disable_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_stoprecv</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_drain_all_txq</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">retry_tx</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flush</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span>
			<span class="n">ath_rx_tasklet</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">ath_rx_tasklet</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath_flushrecv</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath_complete_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath_startrecv</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to restart recv logic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_cmn_update_txpow</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">,</span>
			       <span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txpowlimit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">);</span>
	<span class="n">ath9k_hw_set_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_hw_enable_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SC_OP_OFFCHANNEL</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_BEACONS</span><span class="p">)</span>
			<span class="n">ath_set_beacon</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx_complete_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_pll_work</span><span class="p">,</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">ath_start_rx_poll</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">disable_ani</span><span class="p">)</span>
			<span class="n">ath_start_ani</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_ANT_DIV_COMB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">ant_rx</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ath_hw_antcomb_conf</span> <span class="n">div_ant_conf</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">lna_conf</span><span class="p">;</span>

		<span class="n">ath9k_hw_antdiv_comb_conf_get</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div_ant_conf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ant_rx</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">lna_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lna_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
		<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span> <span class="n">lna_conf</span><span class="p">;</span>
		<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span> <span class="o">=</span> <span class="n">lna_conf</span><span class="p">;</span>

		<span class="n">ath9k_hw_antdiv_comb_conf_set</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div_ant_conf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath_reset_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">hchan</span><span class="p">,</span>
			      <span class="n">bool</span> <span class="n">retry_tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_hw_cal_data</span> <span class="o">*</span><span class="n">caldata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fastcc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">flush</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">__ath_cancel_work</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_OFFCHANNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fastcc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">caldata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hchan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fastcc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">flush</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">hchan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_prepare_reset</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">retry_tx</span><span class="p">,</span> <span class="n">flush</span><span class="p">))</span>
		<span class="n">fastcc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Reset to %u MHz, HT40: %d fastcc: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hchan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">IS_CHAN_HT40</span><span class="p">(</span><span class="n">hchan</span><span class="p">),</span> <span class="n">fastcc</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_hw_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">hchan</span><span class="p">,</span> <span class="n">caldata</span><span class="p">,</span> <span class="n">fastcc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Unable to reset channel, reset status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_complete_reset</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Set/change channels.  If the channel is really being changed, it&#39;s done</span>
<span class="cm"> * by reseting the chip.  To accomplish this we must first cleanup any pending</span>
<span class="cm"> * DMA, then restart stuff.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">hchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ath_reset_internal</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">hchan</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_paprd_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_hw_cal_data</span> <span class="o">*</span><span class="n">caldata</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">caldata</span> <span class="o">||</span> <span class="o">!</span><span class="n">caldata</span><span class="o">-&gt;</span><span class="n">paprd_done</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ar9003_paprd_enable</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chain</span> <span class="o">&lt;</span> <span class="n">AR9300_MAX_CHAINS</span><span class="p">;</span> <span class="n">chain</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">chain</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ar9003_paprd_populate_single_table</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">caldata</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ar9003_paprd_enable</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath_paprd_send_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_tx_control</span> <span class="n">txctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">time_left</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txctl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txctl</span><span class="p">));</span>
	<span class="n">txctl</span><span class="p">.</span><span class="n">txq</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq_map</span><span class="p">[</span><span class="n">WME_AC_BE</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tx_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_info</span><span class="p">));</span>
	<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">;</span>
	<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">;</span>
	<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">paprd_complete</span><span class="p">);</span>
	<span class="n">txctl</span><span class="p">.</span><span class="n">paprd</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">chain</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath_tx_start</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txctl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CALIBRATE</span><span class="p">,</span> <span class="s">&quot;PAPRD TX failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">time_left</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">paprd_complete</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH_PAPRD_TIMEOUT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_left</span><span class="p">)</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CALIBRATE</span><span class="p">,</span>
			<span class="s">&quot;Timeout waiting for paprd training on TX chain %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chain</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!!</span><span class="n">time_left</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_paprd_calibrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_softc</span><span class="p">,</span> <span class="n">paprd_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_hw_cal_data</span> <span class="o">*</span><span class="n">caldata</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ftype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chain_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">1800</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">caldata</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar9003_paprd_init_table</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_paprd</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_paprd</span><span class="p">;</span>

	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">ftype</span> <span class="o">=</span> <span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_NULLFUNC</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ftype</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">duration_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">chain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chain</span> <span class="o">&lt;</span> <span class="n">AR9300_MAX_CHAINS</span><span class="p">;</span> <span class="n">chain</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">chain</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">chain_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CALIBRATE</span><span class="p">,</span>
			<span class="s">&quot;Sending PAPRD frame for thermal measurement on chain %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_paprd_send_frame</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">chain</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail_paprd</span><span class="p">;</span>

		<span class="n">ar9003_paprd_setup_gain_table</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>

		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CALIBRATE</span><span class="p">,</span>
			<span class="s">&quot;Sending PAPRD training frame on chain %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_paprd_send_frame</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">chain</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail_paprd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar9003_paprd_is_done</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CALIBRATE</span><span class="p">,</span>
				<span class="s">&quot;PAPRD not yet done on chain %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ar9003_paprd_create_curve</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">caldata</span><span class="p">,</span> <span class="n">chain</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CALIBRATE</span><span class="p">,</span>
				<span class="s">&quot;PAPRD create curve failed on chain %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								   <span class="n">chain</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chain_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chain_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">caldata</span><span class="o">-&gt;</span><span class="n">paprd_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ath_paprd_activate</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">fail_paprd:</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  This routine performs the periodic noise floor calibration function</span>
<span class="cm"> *  that is used to adjust and optimize the chip performance.  This</span>
<span class="cm"> *  takes environmental changes (location, temperature) into account.</span>
<span class="cm"> *  When the task is complete, it reschedules itself depending on the</span>
<span class="cm"> *  appropriate interval that was calculated.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ath_ani_calibrate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">longcal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">shortcal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">aniflag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cal_interval</span><span class="p">,</span> <span class="n">short_cal_interval</span><span class="p">,</span> <span class="n">long_cal_interval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="o">-&gt;</span><span class="n">nfcal_interference</span><span class="p">)</span>
		<span class="n">long_cal_interval</span> <span class="o">=</span> <span class="n">ATH_LONG_CALINTERVAL_INT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">long_cal_interval</span> <span class="o">=</span> <span class="n">ATH_LONG_CALINTERVAL</span><span class="p">;</span>

	<span class="n">short_cal_interval</span> <span class="o">=</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">ATH_AP_SHORT_CALINTERVAL</span> <span class="o">:</span> <span class="n">ATH_STA_SHORT_CALINTERVAL</span><span class="p">;</span>

	<span class="cm">/* Only calibrate if awake */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">!=</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">set_timer</span><span class="p">;</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="cm">/* Long calibration runs independently of short calibration. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">longcal_timer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">long_cal_interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">longcal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">longcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Short calibration applies only while caldone is false */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">caldone</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">shortcal_timer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">short_cal_interval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shortcal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">shortcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">resetcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">resetcal_timer</span><span class="p">)</span> <span class="o">&gt;=</span>
		    <span class="n">ATH_RESTART_CALINTERVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">caldone</span> <span class="o">=</span> <span class="n">ath9k_hw_reset_calvalid</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">caldone</span><span class="p">)</span>
				<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">resetcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Verify whether we must check ANI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">enable_ani</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">checkani_timer</span><span class="p">)</span> <span class="o">&gt;=</span>
	    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ani_poll_interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aniflag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">checkani_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Call ANI routine if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aniflag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ath9k_hw_ani_monitor</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">);</span>
		<span class="n">ath_update_survey_stats</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Perform calibration if necessary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">longcal</span> <span class="o">||</span> <span class="n">shortcal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">caldone</span> <span class="o">=</span>
			<span class="n">ath9k_hw_calibrate</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">,</span>
						<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxchainmask</span><span class="p">,</span> <span class="n">longcal</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
		<span class="s">&quot;Calibration @%lu finished: %s %s %s, caldone: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">jiffies</span><span class="p">,</span>
		<span class="n">longcal</span> <span class="o">?</span> <span class="s">&quot;long&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">shortcal</span> <span class="o">?</span> <span class="s">&quot;short&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="n">aniflag</span> <span class="o">?</span> <span class="s">&quot;ani&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">caldone</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">);</span>

	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

<span class="nl">set_timer:</span>
	<span class="cm">/*</span>
<span class="cm">	* Set timer interval based on previous results.</span>
<span class="cm">	* The interval must be the shortest necessary to satisfy ANI,</span>
<span class="cm">	* short calibration and long calibration.</span>
<span class="cm">	*/</span>
	<span class="n">ath9k_debug_samp_bb_mac</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">cal_interval</span> <span class="o">=</span> <span class="n">ATH_LONG_CALINTERVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">enable_ani</span><span class="p">)</span>
		<span class="n">cal_interval</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cal_interval</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ani_poll_interval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">caldone</span><span class="p">)</span>
		<span class="n">cal_interval</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cal_interval</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">short_cal_interval</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">cal_interval</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_PAPRD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="o">-&gt;</span><span class="n">paprd_done</span><span class="p">)</span>
			<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">paprd_work</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_table_write_done</span><span class="p">)</span>
			<span class="n">ath_paprd_activate</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_node_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span><span class="p">;</span>
	<span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ATH9K_DEBUGFS</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">nodes_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">nodes_lock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">an</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">=</span> <span class="n">sta</span><span class="p">;</span>
	<span class="n">an</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_HT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_tx_node_init</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">an</span><span class="p">);</span>
		<span class="n">an</span><span class="o">-&gt;</span><span class="n">maxampdu</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">IEEE80211_HT_MAX_AMPDU_FACTOR</span> <span class="o">+</span>
				     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span><span class="p">);</span>
		<span class="n">an</span><span class="o">-&gt;</span><span class="n">mpdudensity</span> <span class="o">=</span> <span class="n">parse_mpdudensity</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_density</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_node_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ATH9K_DEBUGFS</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">nodes_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">nodes_lock</span><span class="p">);</span>
	<span class="n">an</span><span class="o">-&gt;</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_HT</span><span class="p">)</span>
		<span class="n">ath_tx_node_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">an</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ath9k_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">intrstatus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rxmask</span><span class="p">;</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_FATAL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_BB_WATCHDOG</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ATH9K_DEBUGFS</span>
		<span class="k">enum</span> <span class="n">ath_reset_type</span> <span class="n">type</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_FATAL</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">RESET_TYPE_FATAL_INT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">RESET_TYPE_BB_WATCHDOG</span><span class="p">;</span>

		<span class="n">RESET_STAT_INC</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_reset_work</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_TSFOOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TSF sync does not look correct; remain awake to sync with</span>
<span class="cm">		 * the next Beacon.</span>
<span class="cm">		 */</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span> <span class="s">&quot;TSFOOR - Sync with next Beacon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">|=</span> <span class="n">PS_WAIT_FOR_BEACON</span> <span class="o">|</span> <span class="n">PS_BEACON_SYNC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span>
		<span class="n">rxmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATH9K_INT_RXHP</span> <span class="o">|</span> <span class="n">ATH9K_INT_RXLP</span> <span class="o">|</span> <span class="n">ATH9K_INT_RXEOL</span> <span class="o">|</span>
			  <span class="n">ATH9K_INT_RXORN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rxmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATH9K_INT_RX</span> <span class="o">|</span> <span class="n">ATH9K_INT_RXEOL</span> <span class="o">|</span> <span class="n">ATH9K_INT_RXORN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">rxmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check for high priority Rx first */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_RXHP</span><span class="p">))</span>
			<span class="n">ath_rx_tasklet</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="n">ath_rx_tasklet</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span>
			<span class="n">ath_tx_edma_tasklet</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ath_tx_tasklet</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath9k_btcoex_handle_interrupt</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="cm">/* re-enable hardware interrupt */</span>
	<span class="n">ath9k_hw_enable_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">ath_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define SCHED_INTR (				\</span>
<span class="cp">		ATH9K_INT_FATAL |		\</span>
<span class="cp">		ATH9K_INT_BB_WATCHDOG |		\</span>
<span class="cp">		ATH9K_INT_RXORN |		\</span>
<span class="cp">		ATH9K_INT_RXEOL |		\</span>
<span class="cp">		ATH9K_INT_RX |			\</span>
<span class="cp">		ATH9K_INT_RXLP |		\</span>
<span class="cp">		ATH9K_INT_RXHP |		\</span>
<span class="cp">		ATH9K_INT_TX |			\</span>
<span class="cp">		ATH9K_INT_BMISS |		\</span>
<span class="cp">		ATH9K_INT_CST |			\</span>
<span class="cp">		ATH9K_INT_TSFOOR |		\</span>
<span class="cp">		ATH9K_INT_GENTIMER |		\</span>
<span class="cp">		ATH9K_INT_MCI)</span>

	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">ath9k_int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The hardware is not ready/present, don&#39;t</span>
<span class="cm">	 * touch anything. Note this can happen early</span>
<span class="cm">	 * on if the IRQ is shared.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>


	<span class="cm">/* shared irq, not for us */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_intrpend</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Figure out the reason(s) for the interrupt.  Note</span>
<span class="cm">	 * that the hal returns a pseudo-ISR that may include</span>
<span class="cm">	 * bits we haven&#39;t explicitly enabled so we mask the</span>
<span class="cm">	 * value to insure we only process bits we requested.</span>
<span class="cm">	 */</span>
	<span class="n">ath9k_hw_getisr</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>	<span class="cm">/* NB: clears ISR too */</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span><span class="p">;</span>	<span class="cm">/* discard unasked-for bits */</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there are no status bits set, then this interrupt was not</span>
<span class="cm">	 * for me (should have been caught above).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="cm">/* Cache the status */</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">intrstatus</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SCHED_INTR</span><span class="p">)</span>
		<span class="n">sched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If a FATAL or RXORN interrupt is received, we have to reset the</span>
<span class="cm">	 * chip immediately.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_FATAL</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_RXORN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">chip_reset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_BB_WATCHDOG</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
		<span class="n">ath_hw_cycle_counters_update</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
		<span class="n">ar9003_hw_bb_watchdog_dbg_info</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">chip_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_SWBA</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">bcon_tasklet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_TXURN</span><span class="p">)</span>
		<span class="n">ath9k_hw_updatetxtriglevel</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_RXEOL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ATH9K_INT_RXEOL</span> <span class="o">|</span> <span class="n">ATH9K_INT_RXORN</span><span class="p">);</span>
		<span class="n">ath9k_hw_set_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_MIB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disable interrupts until we service the MIB</span>
<span class="cm">		 * interrupt; otherwise it will continue to</span>
<span class="cm">		 * fire.</span>
<span class="cm">		 */</span>
		<span class="n">ath9k_hw_disable_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Let the hal handle the event. We assume</span>
<span class="cm">		 * it will clear whatever condition caused</span>
<span class="cm">		 * the interrupt.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
		<span class="n">ath9k_hw_proc_mib_event</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>
		<span class="n">ath9k_hw_enable_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_AUTOSLEEP</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_TIM_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ATH_DBG_WARN_ON_ONCE</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_idle</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">chip_reset</span><span class="p">;</span>
			<span class="cm">/* Clear RxAbort bit so that we can</span>
<span class="cm">			 * receive frames */</span>
			<span class="n">ath9k_setpower</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">);</span>
			<span class="n">ath9k_hw_setrxabort</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">|=</span> <span class="n">PS_WAIT_FOR_BEACON</span><span class="p">;</span>
		<span class="p">}</span>

<span class="nl">chip_reset:</span>

	<span class="n">ath_debug_stat_interrupt</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sched</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* turn off every interrupt */</span>
		<span class="n">ath9k_hw_disable_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">intr_tq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

<span class="cp">#undef SCHED_INTR</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">retry_tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ath_reset_internal</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">retry_tx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retry_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ATH_TXQ_SETUP</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axq_lock</span><span class="p">);</span>
				<span class="n">ath_txq_schedule</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axq_lock</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_reset_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_softc</span><span class="p">,</span> <span class="n">hw_reset_work</span><span class="p">);</span>

	<span class="n">ath_reset</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_hw_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_softc</span><span class="p">,</span> <span class="n">hw_check_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">busy</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">is_alive</span><span class="p">,</span> <span class="n">nbeacon</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">is_alive</span> <span class="o">=</span> <span class="n">ath9k_hw_check_alive</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_alive</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">AR_SREV_9300</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_alive</span> <span class="o">&amp;&amp;</span> <span class="n">AR_SREV_9300</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span>
			<span class="s">&quot;DCU stuck is detected. Schedule chip reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">RESET_STAT_INC</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">RESET_TYPE_MAC_HANG</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">sched_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">busy</span> <span class="o">=</span> <span class="n">ath_update_survey_stats</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;Possible baseband hang, busy=%d (try %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">busy</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_busy_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">busy</span> <span class="o">&gt;=</span> <span class="mi">99</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_busy_count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RESET_STAT_INC</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">RESET_TYPE_BB_HANG</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">sched_reset</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">busy</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_busy_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nbeacon</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath_start_rx_poll</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">nbeacon</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">sched_reset:</span>
	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_reset_work</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_hw_pll_rx_hang_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pll_sqsum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pll_sqsum</span> <span class="o">&gt;=</span> <span class="mh">0x40000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Rx is hung for more than 500ms. Reset it */</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;Possible RX hang, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">RESET_STAT_INC</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">RESET_TYPE_PLL_HANG</span><span class="p">);</span>
			<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_reset_work</span><span class="p">);</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_hw_pll_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_softc</span><span class="p">,</span>
					    <span class="n">hw_pll_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">pll_sqsum</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ensure that the PLL WAR is executed only</span>
<span class="cm">	 * after the STA is associated (or) if the</span>
<span class="cm">	 * beaconing had started in interfaces that</span>
<span class="cm">	 * uses beacons.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_BEACONS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">pll_sqsum</span> <span class="o">=</span> <span class="n">ar9003_get_pll_sqsum_dvc</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
		<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

		<span class="n">ath_hw_pll_rx_hang_check</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">pll_sqsum</span><span class="p">);</span>

		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_pll_work</span><span class="p">,</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**********************/</span>
<span class="cm">/* mac80211 callbacks */</span>
<span class="cm">/**********************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">init_channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
		<span class="s">&quot;Starting driver with initial channel: %d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">curchan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">init_channel</span> <span class="o">=</span> <span class="n">ath9k_cmn_get_curchannel</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ah</span><span class="p">);</span>

	<span class="cm">/* Reset SERDES registers */</span>
	<span class="n">ath9k_hw_configpcipowersave</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The basic interface to setting the hardware in a good</span>
<span class="cm">	 * state is ``reset&#39;&#39;.  On return the hardware is known to</span>
<span class="cm">	 * be powered up and with interrupts disabled.  This must</span>
<span class="cm">	 * be followed by initialization of the appropriate bits</span>
<span class="cm">	 * and then setup of the interrupt mask.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">intr_ref_cnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_hw_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">init_channel</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Unable to reset hardware; reset status %d (freq %u MHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">r</span><span class="p">,</span> <span class="n">curchan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mutex_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup our intr mask. */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">=</span> <span class="n">ATH9K_INT_TX</span> <span class="o">|</span> <span class="n">ATH9K_INT_RXEOL</span> <span class="o">|</span>
		    <span class="n">ATH9K_INT_RXORN</span> <span class="o">|</span> <span class="n">ATH9K_INT_FATAL</span> <span class="o">|</span>
		    <span class="n">ATH9K_INT_GLOBAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">|=</span> <span class="n">ATH9K_INT_RXHP</span> <span class="o">|</span>
			     <span class="n">ATH9K_INT_RXLP</span> <span class="o">|</span>
			     <span class="n">ATH9K_INT_BB_WATCHDOG</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">|=</span> <span class="n">ATH9K_INT_RX</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">|=</span> <span class="n">ATH9K_INT_GTT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_HT</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">|=</span> <span class="n">ATH9K_INT_CST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_MCI</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">|=</span> <span class="n">ATH9K_INT_MCI</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_OP_INVALID</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_complete_reset</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">mutex_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">led_pin</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath9k_hw_cfg_output</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">led_pin</span><span class="p">,</span>
				    <span class="n">AR_GPIO_OUTPUT_MUX_AS_OUTPUT</span><span class="p">);</span>
		<span class="n">ath9k_hw_set_gpio</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">led_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reset key cache to sane defaults (all entries cleared) instead of</span>
<span class="cm">	 * semi-random values after suspend/resume.</span>
<span class="cm">	 */</span>
	<span class="n">ath9k_cmn_init_crypto</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>

	<span class="n">ath9k_start_btcoex</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">pcie_lcr_extsync_en</span> <span class="o">&amp;&amp;</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="o">-&gt;</span><span class="n">extn_synch_en</span><span class="p">)</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="o">-&gt;</span><span class="n">extn_synch_en</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

<span class="nl">mutex_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_tx_control</span> <span class="n">txctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * mac80211 does not set PM field for normal data frames, so we</span>
<span class="cm">		 * need to update that based on the current PS mode.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">ieee80211_is_nullfunc</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">ieee80211_has_pm</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span>
				<span class="s">&quot;Add PM=1 for a TX frame while in PS mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_PM</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">ATH9K_PM_NETWORK_SLEEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We are using PS-Poll and mac80211 can request TX while in</span>
<span class="cm">		 * power save mode. Need to wake up hardware for the TX to be</span>
<span class="cm">		 * completed and if needed, also for RX of buffered frames.</span>
<span class="cm">		 */</span>
		<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_AUTOSLEEP</span><span class="p">))</span>
			<span class="n">ath9k_hw_setrxabort</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span>
				<span class="s">&quot;Sending PS-Poll to pick a buffered frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">|=</span> <span class="n">PS_WAIT_FOR_PSPOLL_DATA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span> <span class="s">&quot;Wake up to complete TX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">|=</span> <span class="n">PS_WAIT_FOR_TX_ACK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * The actual restore operation will happen only after</span>
<span class="cm">		 * the ps_flags bit is cleared. We are just dropping</span>
<span class="cm">		 * the ps_usecount here.</span>
<span class="cm">		 */</span>
		<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cannot tx while the hardware is in full sleep, it first needs a full</span>
<span class="cm">	 * chip reset to recover from that</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">ATH9K_PM_FULL_SLEEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;TX while HW is in FULL_SLEEP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txctl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_tx_control</span><span class="p">));</span>
	<span class="n">txctl</span><span class="p">.</span><span class="n">txq</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq_map</span><span class="p">[</span><span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">)];</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;transmitting packet, skb: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath_tx_start</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txctl</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;TX failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">TX_STAT_INC</span><span class="p">(</span><span class="n">txctl</span><span class="p">.</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">txfailed</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="nl">exit:</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">prev_idle</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ath_cancel_work</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx_poll_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANY</span><span class="p">,</span> <span class="s">&quot;Device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure HW is awake when we try to shut it down. */</span>
	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">ath9k_stop_btcoex</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>

	<span class="cm">/* prevent tasklets to enable interrupts once we disable them */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_INT_GLOBAL</span><span class="p">;</span>

	<span class="cm">/* make sure h/w will not generate any interrupt</span>
<span class="cm">	 * before setting the invalid flag. */</span>
	<span class="n">ath9k_hw_disable_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>

	<span class="cm">/* we can now sync irq and kill any running tasklets, since we already</span>
<span class="cm">	 * disabled interrupts and not holding a spin lock */</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">intr_tq</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">bcon_tasklet</span><span class="p">);</span>

	<span class="n">prev_idle</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_idle</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_idle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">led_pin</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath9k_hw_set_gpio</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">led_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ath9k_hw_cfg_gpio_input</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">led_pin</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath_prepare_reset</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">ath9k_cmn_get_curchannel</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ah</span><span class="p">);</span>

	<span class="n">ath9k_hw_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">ath9k_hw_phy_disable</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ath9k_hw_configpcipowersave</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>

	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">|=</span> <span class="n">SC_OP_INVALID</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_idle</span> <span class="o">=</span> <span class="n">prev_idle</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Driver halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ath9k_uses_beacons</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_reclaim_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_vif</span> <span class="o">*</span><span class="n">avp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="n">ath9k_set_beaconing_status</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">ath_beacon_return</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">avp</span><span class="p">);</span>
	<span class="n">ath9k_set_beaconing_status</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_vif_iter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_vif_iter_data</span> <span class="o">*</span><span class="n">iter_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">hw_macaddr</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span>
				<span class="o">~</span><span class="p">(</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">hw_macaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">naps</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">nstations</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">nadhocs</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">nmeshes</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_WDS</span>:
		<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">nwds</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Called with sc-&gt;mutex held. */</span>
<span class="kt">void</span> <span class="nf">ath9k_calculate_iter_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ath9k_vif_iter_data</span> <span class="o">*</span><span class="n">iter_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the hardware MAC address as reference, the hardware uses it</span>
<span class="cm">	 * together with the BSSID mask when matching addresses.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">iter_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iter_data</span><span class="p">));</span>
	<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">hw_macaddr</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="p">)</span>
		<span class="n">ath9k_vif_iter</span><span class="p">(</span><span class="n">iter_data</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="cm">/* Get list of all active MAC addresses */</span>
	<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ath9k_vif_iter</span><span class="p">,</span>
						   <span class="n">iter_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called with sc-&gt;mutex held. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_calculate_summary_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_vif_iter_data</span> <span class="n">iter_data</span><span class="p">;</span>

	<span class="n">ath9k_calculate_iter_data</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iter_data</span><span class="p">);</span>

	<span class="cm">/* Set BSSID mask. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bssidmask</span><span class="p">,</span> <span class="n">iter_data</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">ath_hw_setbssidmask</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

	<span class="cm">/* Set op-mode &amp; TSF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="p">.</span><span class="n">naps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath9k_hw_set_tsfadjust</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">|=</span> <span class="n">SC_OP_TSF_RESET</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath9k_hw_set_tsfadjust</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_OP_TSF_RESET</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="p">.</span><span class="n">nmeshes</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="p">.</span><span class="n">nwds</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="p">.</span><span class="n">nadhocs</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable MIB interrupts when there are hardware phy counters.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">iter_data</span><span class="p">.</span><span class="n">nstations</span> <span class="o">+</span> <span class="n">iter_data</span><span class="p">.</span><span class="n">nadhocs</span> <span class="o">+</span> <span class="n">iter_data</span><span class="p">.</span><span class="n">nmeshes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">enable_ani</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">|=</span> <span class="n">ATH9K_INT_MIB</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">|=</span> <span class="n">ATH9K_INT_TSFOOR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_INT_MIB</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_INT_TSFOOR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_hw_set_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/* Set up ANI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iter_data</span><span class="p">.</span><span class="n">naps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">avgbrssi</span> <span class="o">=</span> <span class="n">ATH_RSSI_DUMMY_MARKER</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">disable_ani</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">|=</span> <span class="n">SC_OP_ANI_RUN</span><span class="p">;</span>
			<span class="n">ath_start_ani</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_OP_ANI_RUN</span><span class="p">;</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Called with sc-&gt;mutex held, vif counts set up properly. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_do_vif_add_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">ath9k_calculate_summary_state</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_uses_beacons</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Reserve a beacon slot for the vif */</span>
		<span class="n">ath9k_set_beaconing_status</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">ath_beacon_alloc</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="n">ath9k_set_beaconing_status</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_start_rx_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">nbeacon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_PRIM_STA_VIF</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx_poll_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span>
			<span class="p">(</span><span class="n">nbeacon</span> <span class="o">*</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">cur_beacon_conf</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_rx_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_check_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_WDS</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Interface type %d not yet supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_uses_beacons</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">nbcnvifs</span> <span class="o">&gt;=</span> <span class="n">ATH_BCBUF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Not enough beacon buffers when adding&quot;</span>
				<span class="s">&quot; new interface of type: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Attach a VIF of type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">nvifs</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ath9k_do_vif_add_setup</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_change_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">new_type</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">p2p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Change Interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_uses_beacons</span><span class="p">(</span><span class="n">new_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ath9k_uses_beacons</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">nbcnvifs</span> <span class="o">&gt;=</span> <span class="n">ATH_BCBUF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;No beacon slot available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Clean up old vif stuff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_uses_beacons</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
		<span class="n">ath9k_reclaim_beacon</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="cm">/* Add new settings */</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">new_type</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">p2p</span> <span class="o">=</span> <span class="n">p2p</span><span class="p">;</span>

	<span class="n">ath9k_do_vif_add_setup</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Detach Interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">nvifs</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* Reclaim beacon resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_uses_beacons</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span>
		<span class="n">ath9k_reclaim_beacon</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="n">ath9k_calculate_summary_state</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_enable_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_AUTOSLEEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_TIM_TIMER</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">|=</span> <span class="n">ATH9K_INT_TIM_TIMER</span><span class="p">;</span>
			<span class="n">ath9k_hw_set_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ath9k_hw_setrxabort</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span> <span class="s">&quot;PowerSave enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_disable_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_AUTOSLEEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath9k_hw_setrxabort</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PS_WAIT_FOR_BEACON</span> <span class="o">|</span>
				  <span class="n">PS_WAIT_FOR_CAB</span> <span class="o">|</span>
				  <span class="n">PS_WAIT_FOR_PSPOLL_DATA</span> <span class="o">|</span>
				  <span class="n">PS_WAIT_FOR_TX_ACK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_TIM_TIMER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_INT_TIM_TIMER</span><span class="p">;</span>
			<span class="n">ath9k_hw_set_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span> <span class="s">&quot;PowerSave disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">reset_channel</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_idle</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_IDLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_idle</span><span class="p">)</span>
			<span class="n">ath_cancel_work</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/*</span>
<span class="cm">			 * The chip needs a reset to properly wake up from</span>
<span class="cm">			 * full sleep</span>
<span class="cm">			 */</span>
			<span class="n">reset_channel</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">chip_fullsleep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We just prepare to enable PS. We have to wait until our AP has</span>
<span class="cm">	 * ACK&#39;d our null data frame to disable RX otherwise we&#39;ll ignore</span>
<span class="cm">	 * those ACKs and end up retransmitting the same null data frames.</span>
<span class="cm">	 * IEEE80211_CONF_CHANGE_PS is only passed by mac80211 for STA mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_PS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">)</span>
			<span class="n">ath9k_enable_ps</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ath9k_disable_ps</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_MONITOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Monitor mode is enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Monitor mode is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_CHANNEL</span><span class="p">)</span> <span class="o">||</span> <span class="n">reset_channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">curchan</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">old_pos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">)</span>
			<span class="n">old_pos</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">-</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_OFFCHANNEL</span><span class="p">)</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">|=</span> <span class="n">SC_OP_OFFCHANNEL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_OP_OFFCHANNEL</span><span class="p">;</span>

		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Set channel: %d MHz type: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">curchan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span><span class="p">);</span>

		<span class="cm">/* update survey stats for the old channel before switching */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ath_update_survey_stats</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Preserve the current channel values, before updating</span>
<span class="cm">		 * the same channel</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">old_pos</span> <span class="o">==</span> <span class="n">pos</span><span class="p">))</span>
			<span class="n">ath9k_hw_getnf</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">);</span>

		<span class="n">ath9k_cmn_update_ichannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span>
					  <span class="n">curchan</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the operating channel changes, change the survey in-use flags</span>
<span class="cm">		 * along with it.</span>
<span class="cm">		 * Reset the survey data for the new channel, unless we&#39;re switching</span>
<span class="cm">		 * back to the operating channel from an off-channel operation.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_OFFCHANNEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">cur_survey</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">cur_survey</span><span class="p">)</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cur_survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SURVEY_INFO_IN_USE</span><span class="p">;</span>

			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cur_survey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>

			<span class="n">memset</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">cur_survey</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">survey_info</span><span class="p">));</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">cur_survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">SURVEY_INFO_IN_USE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">[</span><span class="n">pos</span><span class="p">].</span><span class="n">filled</span> <span class="o">&amp;</span> <span class="n">SURVEY_INFO_IN_USE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">survey_info</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath_set_channel</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to set channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * The most recent snapshot of channel-&gt;noisefloor for the old</span>
<span class="cm">		 * channel is only available after the hardware reset. Copy it to</span>
<span class="cm">		 * the survey stats now.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_pos</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ath_update_survey_nf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">old_pos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Set power: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txpowlimit</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>
		<span class="n">ath9k_cmn_update_txpow</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">,</span>
				       <span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txpowlimit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SUPPORTED_FILTERS			\</span>
<span class="cp">	(FIF_PROMISC_IN_BSS |			\</span>
<span class="cp">	FIF_ALLMULTI |				\</span>
<span class="cp">	FIF_CONTROL |				\</span>
<span class="cp">	FIF_PSPOLL |				\</span>
<span class="cp">	FIF_OTHER_BSS |				\</span>
<span class="cp">	FIF_BCN_PRBRESP_PROMISC |		\</span>
<span class="cp">	FIF_PROBE_REQ |				\</span>
<span class="cp">	FIF_FCSFAIL)</span>

<span class="cm">/* FIXME: sc-&gt;sc_full_reset ? */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">,</span>
				   <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rfilt</span><span class="p">;</span>

	<span class="n">changed_flags</span> <span class="o">&amp;=</span> <span class="n">SUPPORTED_FILTERS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;=</span> <span class="n">SUPPORTED_FILTERS</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxfilter</span> <span class="o">=</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">;</span>
	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">rfilt</span> <span class="o">=</span> <span class="n">ath_calcrxfilter</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ath9k_hw_setrxfilter</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="n">rfilt</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">),</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Set HW RX filter: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rfilt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_sta_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="n">ps_key</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

	<span class="n">ath_node_attach</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">an</span><span class="o">-&gt;</span><span class="n">ps_key</span> <span class="o">=</span> <span class="n">ath_key_config</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps_key</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_del_ps_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="n">ps_key</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">an</span><span class="o">-&gt;</span><span class="n">ps_key</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">ps_key</span><span class="p">)</span>
	    <span class="k">return</span><span class="p">;</span>

	<span class="n">ath_key_delete</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ps_key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_sta_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">ath9k_del_ps_key</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="n">ath_node_detach</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_sta_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">sta_notify_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STA_NOTIFY_SLEEP</span>:
		<span class="n">an</span><span class="o">-&gt;</span><span class="n">sleeping</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ath_tx_aggr_sleep</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">an</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STA_NOTIFY_AWAKE</span>:
		<span class="n">an</span><span class="o">-&gt;</span><span class="n">sleeping</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ath_tx_aggr_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">an</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">queue</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span> <span class="n">qi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">WME_NUM_AC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">txq</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq_map</span><span class="p">[</span><span class="n">queue</span><span class="p">];</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span><span class="p">));</span>

	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_aifs</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cwmin</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cwmax</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_burstTime</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
		<span class="s">&quot;Configure tx [queue/halq] [%d/%d], aifs: %d, cw_min: %d, cw_max: %d, txop: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">queue</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">,</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath_txq_update</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;TXQ Update failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">==</span> <span class="n">WME_AC_BE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ath_beaconq_config</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_modparam_nohwcrypt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">||</span>
	     <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span> <span class="o">||</span>
	     <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For now, disable hw crypto for the RSN IBSS group keys. This</span>
<span class="cm">		 * could be optimized in the future to use a modified key cache</span>
<span class="cm">		 * design to support per-STA RX GTK, but until that gets</span>
<span class="cm">		 * implemented, use of software crypto for group addressed</span>
<span class="cm">		 * frames is a acceptable to allow RSN IBSS to be used.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Set HW Key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_KEY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">ath9k_del_ps_key</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath_key_config</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="cm">/* push IV and Michael MIC generation to stack */</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_IV</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">)</span>
				<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_MMIC</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">sw_mgmt_crypto</span> <span class="o">&amp;&amp;</span>
			    <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">)</span>
				<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_SW_MGMT</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISABLE_KEY</span>:
		<span class="n">ath_key_delete</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_bss_iter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_vif</span> <span class="o">*</span><span class="n">avp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Skip iteration if primary station vif&#39;s bss info</span>
<span class="cm">	 * was not changed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_PRIM_STA_VIF</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">|=</span> <span class="n">SC_OP_PRIM_STA_VIF</span><span class="p">;</span>
		<span class="n">avp</span><span class="o">-&gt;</span><span class="n">primary_sta_vif</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">curaid</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">;</span>
		<span class="n">ath9k_hw_write_associd</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Bss Info ASSOC %d, bssid: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">);</span>
		<span class="n">ath_beacon_config</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Request a re-configuration of Beacon related timers</span>
<span class="cm">		 * on the receipt of the first Beacon frame (i.e.,</span>
<span class="cm">		 * after time sync with the AP).</span>
<span class="cm">		 */</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">|=</span> <span class="n">PS_BEACON_SYNC</span> <span class="o">|</span> <span class="n">PS_WAIT_FOR_BEACON</span><span class="p">;</span>
		<span class="cm">/* Reset rssi stats */</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">last_rssi</span> <span class="o">=</span> <span class="n">ATH_RSSI_DUMMY_MARKER</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">avgbrssi</span> <span class="o">=</span> <span class="n">ATH_RSSI_DUMMY_MARKER</span><span class="p">;</span>

		<span class="n">ath_start_rx_poll</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">disable_ani</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">|=</span> <span class="n">SC_OP_ANI_RUN</span><span class="p">;</span>
			<span class="n">ath_start_ani</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_config_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_vif</span> <span class="o">*</span><span class="n">avp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Reconfigure bss info */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avp</span><span class="o">-&gt;</span><span class="n">primary_sta_vif</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Bss Info DISASSOC %d, bssid %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">curaid</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SC_OP_PRIM_STA_VIF</span> <span class="o">|</span> <span class="n">SC_OP_BEACONS</span><span class="p">);</span>
		<span class="n">avp</span><span class="o">-&gt;</span><span class="n">primary_sta_vif</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">curaid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ath9k_bss_iter</span><span class="p">,</span> <span class="n">sc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * None of station vifs are associated.</span>
<span class="cm">	 * Clear bssid &amp; aid</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_PRIM_STA_VIF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath9k_hw_write_associd</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
		<span class="cm">/* Stop ANI */</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_OP_ANI_RUN</span><span class="p">;</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx_poll_timer</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_vif</span> <span class="o">*</span><span class="n">avp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slottime</span><span class="p">;</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath9k_config_bss</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;BSSID: %pM aid: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">curaid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_IBSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* There can be only one vif available */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">curaid</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">;</span>
		<span class="n">ath9k_hw_write_associd</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ibss_joined</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">avgbrssi</span> <span class="o">=</span> <span class="n">ATH_RSSI_DUMMY_MARKER</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">disable_ani</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">|=</span> <span class="n">SC_OP_ANI_RUN</span><span class="p">;</span>
				<span class="n">ath_start_ani</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_OP_ANI_RUN</span><span class="p">;</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx_poll_timer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case of AP mode, the HW TSF has to be reset</span>
<span class="cm">	 * when the beacon interval changes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">))</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">|=</span> <span class="n">SC_OP_TSF_RESET</span><span class="p">;</span>

	<span class="cm">/* Configure beaconing (AP, IBSS, MESH) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_uses_beacons</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ath9k_set_beaconing_status</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">)</span>
			<span class="n">ath_beacon_alloc</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">avp</span><span class="o">-&gt;</span><span class="n">is_bslot_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ath_beacon_config</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="n">ath9k_set_beaconing_status</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_slot</span><span class="p">)</span>
			<span class="n">slottime</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">slottime</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Defer update, so that connected stations can adjust</span>
<span class="cm">			 * their settings at the same time.</span>
<span class="cm">			 * See beacon.c for more details</span>
<span class="cm">			 */</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">slottime</span> <span class="o">=</span> <span class="n">slottime</span><span class="p">;</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">updateslot</span> <span class="o">=</span> <span class="n">UPDATE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">slottime</span> <span class="o">=</span> <span class="n">slottime</span><span class="p">;</span>
			<span class="n">ath9k_hw_init_global_settings</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ath9k_get_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tsf</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">tsf</span> <span class="o">=</span> <span class="n">ath9k_hw_gettsf64</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tsf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_set_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			  <span class="n">u64</span> <span class="n">tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ath9k_hw_settsf64</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="n">tsf</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_reset_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ath9k_hw_reset_tsf</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_ampdu_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">ieee80211_ampdu_mlme_action</span> <span class="n">action</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			      <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ssn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_bh_disable</span><span class="p">();</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_START</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_STOP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_START</span>:
		<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath_tx_aggr_start</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">ssn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ieee80211_start_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_STOP</span>:
		<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">ath_tx_aggr_stop</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">ieee80211_stop_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_OPERATIONAL</span>:
		<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">ath_tx_aggr_resume</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">),</span> <span class="s">&quot;Unknown AMPDU action</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">local_bh_enable</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_get_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ath_update_survey_stats</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sband</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">-=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span>
		<span class="n">sband</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="p">)</span>
		<span class="n">sband</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sband</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">survey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">survey</span><span class="p">));</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_set_coverage_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u8</span> <span class="n">coverage_class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">coverage_class</span> <span class="o">=</span> <span class="n">coverage_class</span><span class="p">;</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ath9k_hw_init_global_settings</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">drop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="cm">/* ms */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">drain_txq</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx_complete_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_flags</span> <span class="o">&amp;</span> <span class="n">AH_UNPLUGGED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANY</span><span class="p">,</span> <span class="s">&quot;Device has been unplugged!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANY</span><span class="p">,</span> <span class="s">&quot;Device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">timeout</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">npend</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
			<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ATH_TXQ_SETUP</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">npend</span> <span class="o">=</span> <span class="n">ath9k_has_pending_frames</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">npend</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">npend</span><span class="p">)</span>
		    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">drop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>
		<span class="n">drain_txq</span> <span class="o">=</span> <span class="n">ath_drain_all_txq</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drain_txq</span><span class="p">)</span>
			<span class="n">ath_reset</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx_complete_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_tx_frames_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ATH_TXQ_SETUP</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_has_pending_frames</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_tx_last_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_vif</span> <span class="o">*</span><span class="n">avp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="n">ts</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">edma</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">bslot</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">avp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">avp</span><span class="o">-&gt;</span><span class="n">is_bslot_active</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">tx_processed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">edma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">bcon_tasklet</span><span class="p">);</span>

		<span class="n">bf</span> <span class="o">=</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">av_bcbuf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span> <span class="o">||</span> <span class="o">!</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ath9k_hw_txprocdesc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip</span><span class="p">;</span>

		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">tx_processed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">tx_last</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">ts_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_TXERR_MASK</span><span class="p">);</span>

<span class="nl">skip:</span>
		<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">bcon_tasklet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">tx_last</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ieee80211_low_level_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_mib_stats</span> <span class="o">*</span><span class="n">mib_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mibStats</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11ACKFailureCount</span> <span class="o">=</span> <span class="n">mib_stats</span><span class="o">-&gt;</span><span class="n">ackrcv_bad</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11RTSFailureCount</span> <span class="o">=</span> <span class="n">mib_stats</span><span class="o">-&gt;</span><span class="n">rts_bad</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11FCSErrorCount</span> <span class="o">=</span> <span class="n">mib_stats</span><span class="o">-&gt;</span><span class="n">fcs_bad</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11RTSSuccessCount</span> <span class="o">=</span> <span class="n">mib_stats</span><span class="o">-&gt;</span><span class="n">rts_good</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">fill_chainmask</span><span class="p">(</span><span class="n">u32</span> <span class="n">cap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">filled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cap</span> <span class="o">&amp;&amp;</span> <span class="n">new</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">cap</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
			<span class="n">filled</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

		<span class="n">new</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">filled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_set_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx_ant</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rx_ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_ant</span> <span class="o">||</span> <span class="o">!</span><span class="n">tx_ant</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ant_rx</span> <span class="o">=</span> <span class="n">rx_ant</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ant_tx</span> <span class="o">=</span> <span class="n">tx_ant</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_chainmask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* AR9100 runs into calibration issues if not all rx chains are enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxchainmask</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxchainmask</span> <span class="o">=</span> <span class="n">fill_chainmask</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_chainmask</span><span class="p">,</span> <span class="n">rx_ant</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span> <span class="o">=</span> <span class="n">fill_chainmask</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">tx_chainmask</span><span class="p">,</span> <span class="n">tx_ant</span><span class="p">);</span>
	<span class="n">ath9k_reload_chainmask_settings</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_get_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">tx_ant</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rx_ant</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">tx_ant</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">ant_tx</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rx_ant</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">ant_rx</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">ath9k_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span> 		    <span class="o">=</span> <span class="n">ath9k_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> 		    <span class="o">=</span> <span class="n">ath9k_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> 		    <span class="o">=</span> <span class="n">ath9k_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span> 	    <span class="o">=</span> <span class="n">ath9k_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_interface</span>   <span class="o">=</span> <span class="n">ath9k_change_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span>   <span class="o">=</span> <span class="n">ath9k_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span> 	    <span class="o">=</span> <span class="n">ath9k_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span>   <span class="o">=</span> <span class="n">ath9k_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_add</span>	    <span class="o">=</span> <span class="n">ath9k_sta_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_remove</span>	    <span class="o">=</span> <span class="n">ath9k_sta_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_notify</span>         <span class="o">=</span> <span class="n">ath9k_sta_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conf_tx</span> 	    <span class="o">=</span> <span class="n">ath9k_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span>   <span class="o">=</span> <span class="n">ath9k_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_key</span>            <span class="o">=</span> <span class="n">ath9k_set_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tsf</span> 	    <span class="o">=</span> <span class="n">ath9k_get_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tsf</span> 	    <span class="o">=</span> <span class="n">ath9k_set_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_tsf</span> 	    <span class="o">=</span> <span class="n">ath9k_reset_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ampdu_action</span>       <span class="o">=</span> <span class="n">ath9k_ampdu_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_survey</span>	    <span class="o">=</span> <span class="n">ath9k_get_survey</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rfkill_poll</span>        <span class="o">=</span> <span class="n">ath9k_rfkill_poll_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coverage_class</span> <span class="o">=</span> <span class="n">ath9k_set_coverage_class</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush</span>		    <span class="o">=</span> <span class="n">ath9k_flush</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_frames_pending</span>  <span class="o">=</span> <span class="n">ath9k_tx_frames_pending</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_last_beacon</span>     <span class="o">=</span> <span class="n">ath9k_tx_last_beacon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span>	    <span class="o">=</span> <span class="n">ath9k_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_antenna</span>	    <span class="o">=</span> <span class="n">ath9k_set_antenna</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_antenna</span>	    <span class="o">=</span> <span class="n">ath9k_get_antenna</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
