<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › recv.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>recv.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &quot;ath9k.h&quot;</span>
<span class="cp">#include &quot;ar9003_mac.h&quot;</span>

<span class="cp">#define SKB_CB_ATHBUF(__skb)	(*((struct ath_buf **)__skb-&gt;cb))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ath_is_alt_ant_ratio_better</span><span class="p">(</span><span class="kt">int</span> <span class="n">alt_ratio</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxdelta</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">mindelta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">main_rssi_avg</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">alt_rssi_avg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pkt_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(((</span><span class="n">alt_ratio</span> <span class="o">&gt;=</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">alt_rssi_avg</span> <span class="o">&gt;</span> <span class="n">main_rssi_avg</span> <span class="o">+</span> <span class="n">maxdelta</span><span class="p">))</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">alt_rssi_avg</span> <span class="o">&gt;</span> <span class="n">main_rssi_avg</span> <span class="o">+</span> <span class="n">mindelta</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt_count</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ath_ant_div_comb_alt_check</span><span class="p">(</span><span class="n">u8</span> <span class="n">div_group</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alt_ratio</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">curr_main_set</span><span class="p">,</span> <span class="kt">int</span> <span class="n">curr_alt_set</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">alt_rssi_avg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">main_rssi_avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">div_group</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">alt_ratio</span> <span class="o">&gt;</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO</span><span class="p">)</span>
			<span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">((((</span><span class="n">curr_main_set</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">curr_alt_set</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">alt_rssi_avg</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">main_rssi_avg</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)))</span> <span class="o">||</span>
			<span class="p">((</span><span class="n">curr_main_set</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">curr_alt_set</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">alt_rssi_avg</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">main_rssi_avg</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))))</span> <span class="o">&amp;&amp;</span>
							<span class="p">(</span><span class="n">alt_rssi_avg</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">))</span>
			<span class="n">result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">ath9k_check_auto_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_enabled</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_AUTOSLEEP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup and link descriptors.</span>
<span class="cm"> *</span>
<span class="cm"> * 11N: we can no longer afford to self link the last descriptor.</span>
<span class="cm"> * MAC acknowledges BA status as long as it copies frames to host</span>
<span class="cm"> * buffer (or rx fifo). This can incorrectly acknowledge packets</span>
<span class="cm"> * to a sender if last desc is self-linked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rx_buf_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_desc</span> <span class="o">*</span><span class="n">ds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">ATH_RXBUF_RESET</span><span class="p">(</span><span class="n">bf</span><span class="p">);</span>

	<span class="n">ds</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_desc</span><span class="p">;</span>
	<span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* link to null */</span>
	<span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_data</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">;</span>

	<span class="cm">/* virtual addr of the beginning of the buffer. */</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_vdata</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * setup rx descriptors. The rx_bufsize here tells the hardware</span>
<span class="cm">	 * how much data it can DMA to us and that we are prepared</span>
<span class="cm">	 * to process</span>
<span class="cm">	 */</span>
	<span class="n">ath9k_hw_setuprxdesc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span>
			     <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxlink</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ath9k_hw_putrxbuf</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_daddr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxlink</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_daddr</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxlink</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">ds_link</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_setdefantenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">antenna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* XXX block beacon interrupts */</span>
	<span class="n">ath9k_hw_setantenna</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="n">antenna</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">defant</span> <span class="o">=</span> <span class="n">antenna</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxotherant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_opmode_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">u32</span> <span class="n">rfilt</span><span class="p">,</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="cm">/* configure rx filter */</span>
	<span class="n">rfilt</span> <span class="o">=</span> <span class="n">ath_calcrxfilter</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ath9k_hw_setrxfilter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">rfilt</span><span class="p">);</span>

	<span class="cm">/* configure bssid mask */</span>
	<span class="n">ath_hw_setbssidmask</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>

	<span class="cm">/* configure operational mode */</span>
	<span class="n">ath9k_hw_setopmode</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/* calculate and install multicast filter */</span>
	<span class="n">mfilt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">ath9k_hw_setmcastfilter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mfilt</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath_rx_edma_buf_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">ath9k_rx_qtype</span> <span class="n">qtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_rx_edma</span> <span class="o">*</span><span class="n">rx_edma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>

	<span class="n">rx_edma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_edma</span><span class="p">[</span><span class="n">qtype</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_edma</span><span class="o">-&gt;</span><span class="n">rx_fifo</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">rx_edma</span><span class="o">-&gt;</span><span class="n">rx_fifo_hwsize</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>

	<span class="n">ATH_RXBUF_RESET</span><span class="p">(</span><span class="n">bf</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_status_len</span><span class="p">);</span>
	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">,</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_status_len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">SKB_CB_ATHBUF</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">ath9k_hw_addrxbuf_edma</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">,</span> <span class="n">qtype</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_edma</span><span class="o">-&gt;</span><span class="n">rx_fifo</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rx_addbuffer_edma</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">ath9k_rx_qtype</span> <span class="n">qtype</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="o">*</span><span class="n">tbf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">QUEUE</span><span class="p">,</span> <span class="s">&quot;No free rx buf available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">tbf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_rx_edma_buf_link</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">qtype</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rx_remove_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">ath9k_rx_qtype</span> <span class="n">qtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_rx_edma</span> <span class="o">*</span><span class="n">rx_edma</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">rx_edma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_edma</span><span class="p">[</span><span class="n">qtype</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_edma</span><span class="o">-&gt;</span><span class="n">rx_fifo</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">SKB_CB_ATHBUF</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rx_edma_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>

	<span class="n">ath_rx_remove_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH9K_RX_QUEUE_LP</span><span class="p">);</span>
	<span class="n">ath_rx_remove_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH9K_RX_QUEUE_HP</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">,</span>
					<span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
					<span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">);</span>
			<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_bufptr</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_bufptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rx_edma_init_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_rx_edma</span> <span class="o">*</span><span class="n">rx_edma</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_edma</span><span class="o">-&gt;</span><span class="n">rx_fifo</span><span class="p">);</span>
	<span class="n">rx_edma</span><span class="o">-&gt;</span><span class="n">rx_fifo_hwsize</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath_rx_edma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbufs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">ath9k_hw_set_rx_bufsize</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span> <span class="o">-</span>
				    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_status_len</span><span class="p">);</span>

	<span class="n">ath_rx_edma_init_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_edma</span><span class="p">[</span><span class="n">ATH9K_RX_QUEUE_LP</span><span class="p">],</span>
			       <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_lp_qdepth</span><span class="p">);</span>
	<span class="n">ath_rx_edma_init_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_edma</span><span class="p">[</span><span class="n">ATH9K_RX_QUEUE_HP</span><span class="p">],</span>
			       <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_hp_qdepth</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_buf</span><span class="p">)</span> <span class="o">*</span> <span class="n">nbufs</span><span class="p">;</span>
	<span class="n">bf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_bufptr</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbufs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">bf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">ath_rxbuf_alloc</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">rx_init_fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">);</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						 <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
						 <span class="n">DMA_BIDIRECTIONAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
					<span class="s">&quot;dma_mapping_error() on RX init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">rx_init_fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">rx_init_fail:</span>
	<span class="n">ath_rx_edma_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_edma_start_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>

	<span class="n">ath9k_hw_rxena</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>

	<span class="n">ath_rx_addbuffer_edma</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH9K_RX_QUEUE_HP</span><span class="p">,</span>
			      <span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_edma</span><span class="p">[</span><span class="n">ATH9K_RX_QUEUE_HP</span><span class="p">].</span><span class="n">rx_fifo_hwsize</span><span class="p">);</span>

	<span class="n">ath_rx_addbuffer_edma</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH9K_RX_QUEUE_LP</span><span class="p">,</span>
			      <span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_edma</span><span class="p">[</span><span class="n">ATH9K_RX_QUEUE_LP</span><span class="p">].</span><span class="n">rx_fifo_hwsize</span><span class="p">);</span>

	<span class="n">ath_opmode_init</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">ath9k_hw_startpcureceive</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_OFFCHANNEL</span><span class="p">));</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_edma_stop_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath_rx_remove_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH9K_RX_QUEUE_HP</span><span class="p">);</span>
	<span class="n">ath_rx_remove_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH9K_RX_QUEUE_LP</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath_rx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbufs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pcu_lock</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_OP_RXFLUSH</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_MPDU_LEN</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span>
			     <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_status_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ath_rx_edma_init</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">nbufs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;cachelsz %u rxbufsize %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">cachelsz</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">);</span>

		<span class="cm">/* Initialize rx descriptors */</span>

		<span class="n">error</span> <span class="o">=</span> <span class="n">ath_descdma_setup</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxdma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span>
				<span class="s">&quot;rx&quot;</span><span class="p">,</span> <span class="n">nbufs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
				<span class="s">&quot;failed to allocate rx descriptors: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">error</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">ath_rxbuf_alloc</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
					      <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					<span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
					<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
					<span class="s">&quot;dma_mapping_error() on RX init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxlink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">ath_rx_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_rx_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_rx_edma_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">,</span>
						<span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
						<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxdma</span><span class="p">.</span><span class="n">dd_desc_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ath_descdma_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxdma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate the receive filter according to the</span>
<span class="cm"> * operating mode and state:</span>
<span class="cm"> *</span>
<span class="cm"> * o always accept unicast, broadcast, and multicast traffic</span>
<span class="cm"> * o maintain current state of phy error reception (the hal</span>
<span class="cm"> *   may enable phy error frames for noise immunity work)</span>
<span class="cm"> * o probe request frames are accepted only when operating in</span>
<span class="cm"> *   hostap, adhoc, or monitor modes</span>
<span class="cm"> * o enable promiscuous mode according to the interface state</span>
<span class="cm"> * o accept beacons:</span>
<span class="cm"> *   - when operating in adhoc mode so the 802.11 layer creates</span>
<span class="cm"> *     node table entries for peers,</span>
<span class="cm"> *   - when operating in station mode for collecting rssi data when</span>
<span class="cm"> *     the station is otherwise quiet, or</span>
<span class="cm"> *   - when operating as a repeater so we see repeater-sta beacons</span>
<span class="cm"> *   - when scanning</span>
<span class="cm"> */</span>

<span class="n">u32</span> <span class="nf">ath_calcrxfilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rfilt</span><span class="p">;</span>

	<span class="n">rfilt</span> <span class="o">=</span> <span class="n">ATH9K_RX_FILTER_UCAST</span> <span class="o">|</span> <span class="n">ATH9K_RX_FILTER_BCAST</span>
		<span class="o">|</span> <span class="n">ATH9K_RX_FILTER_MCAST</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxfilter</span> <span class="o">&amp;</span> <span class="n">FIF_PROBE_REQ</span><span class="p">)</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_PROBEREQ</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set promiscuous mode when FIF_PROMISC_IN_BSS is enabled for station</span>
<span class="cm">	 * mode interface or when in monitor mode. AP mode does not need this</span>
<span class="cm">	 * since it receives all in-BSS frames anyway.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span><span class="p">)</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_PROM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxfilter</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">)</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_CONTROL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">nvifs</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxfilter</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">))</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_MYBEACON</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_BEACON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxfilter</span> <span class="o">&amp;</span> <span class="n">FIF_PSPOLL</span><span class="p">))</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_PSPOLL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">))</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_COMP_BAR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">nvifs</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxfilter</span> <span class="o">&amp;</span> <span class="n">FIF_OTHER_BSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* The following may also be needed for other older chips */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span> <span class="o">==</span> <span class="n">AR_SREV_VERSION_9160</span><span class="p">)</span>
			<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_PROM</span><span class="p">;</span>
		<span class="n">rfilt</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_MCAST_BCAST_ALL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rfilt</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath_startrecv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="o">*</span><span class="n">tbf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_edma_start_recv</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">start_recv</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxlink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">tbf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_rx_buf_link</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We could have deleted elements so the list may be empty now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">start_recv</span><span class="p">;</span>

	<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">ath9k_hw_putrxbuf</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_daddr</span><span class="p">);</span>
	<span class="n">ath9k_hw_rxena</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

<span class="nl">start_recv:</span>
	<span class="n">ath_opmode_init</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ath9k_hw_startpcureceive</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_OFFCHANNEL</span><span class="p">));</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ath_stoprecv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">stopped</span><span class="p">,</span> <span class="n">reset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>
	<span class="n">ath9k_hw_abortpcurecv</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_hw_setrxfilter</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">stopped</span> <span class="o">=</span> <span class="n">ath9k_hw_stopdmarecv</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span>
		<span class="n">ath_edma_stop_recv</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxlink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_flags</span> <span class="o">&amp;</span> <span class="n">AH_UNPLUGGED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">stopped</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">),</span>
			<span class="s">&quot;Could not stop RX, we could be &quot;</span>
			<span class="s">&quot;confusing the DMA engine when we start RX up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ATH_DBG_WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">stopped</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">reset</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_flushrecv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">|=</span> <span class="n">SC_OP_RXFLUSH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span>
		<span class="n">ath_rx_tasklet</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">ath_rx_tasklet</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SC_OP_RXFLUSH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath_beacon_dtim_pending_cab</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check whether the Beacon frame has DTIM indicating buffered bc/mc */</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">elen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tim_ie</span> <span class="o">*</span><span class="n">tim</span><span class="p">;</span>

	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
		<span class="n">elen</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">elen</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">WLAN_EID_TIM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">elen</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tim</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">tim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tim_ie</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tim</span><span class="o">-&gt;</span><span class="n">dtim_count</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">tim</span><span class="o">-&gt;</span><span class="n">bitmap_ctrl</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pos</span> <span class="o">+=</span> <span class="n">elen</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rx_ps_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PS_WAIT_FOR_BEACON</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">PS_BEACON_SYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PS_BEACON_SYNC</span><span class="p">;</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span>
			<span class="s">&quot;Reconfigure Beacon timers based on timestamp from the AP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ath_set_beacon</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath_beacon_dtim_pending_cab</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Remain awake waiting for buffered broadcast/multicast</span>
<span class="cm">		 * frames. If the last broadcast/multicast frame is not</span>
<span class="cm">		 * received properly, the next beacon frame will work as</span>
<span class="cm">		 * a backup trigger for returning into NETWORK SLEEP state,</span>
<span class="cm">		 * so we are waiting for it as well.</span>
<span class="cm">		 */</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span>
			<span class="s">&quot;Received DTIM beacon indicating buffered broadcast/multicast frame(s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">|=</span> <span class="n">PS_WAIT_FOR_CAB</span> <span class="o">|</span> <span class="n">PS_WAIT_FOR_BEACON</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">PS_WAIT_FOR_CAB</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This can happen if a broadcast frame is dropped or the AP</span>
<span class="cm">		 * fails to send a frame indicating that all CAB frames have</span>
<span class="cm">		 * been delivered.</span>
<span class="cm">		 */</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PS_WAIT_FOR_CAB</span><span class="p">;</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span> <span class="s">&quot;PS wait for CAB frames timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_rx_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mybeacon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Process Beacon and CAB receive in PS state */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">PS_WAIT_FOR_BEACON</span><span class="p">)</span> <span class="o">||</span> <span class="n">ath9k_check_auto_sleep</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="n">mybeacon</span><span class="p">)</span>
		<span class="n">ath_rx_ps_beacon</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">PS_WAIT_FOR_CAB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
		  <span class="n">ieee80211_is_action</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		 <span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		 <span class="o">!</span><span class="n">ieee80211_has_moredata</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * No more broadcast/multicast frames to be received at this</span>
<span class="cm">		 * point.</span>
<span class="cm">		 */</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PS_WAIT_FOR_CAB</span> <span class="o">|</span> <span class="n">PS_WAIT_FOR_BEACON</span><span class="p">);</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span>
			<span class="s">&quot;All PS CAB frames received, back to sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">PS_WAIT_FOR_PSPOLL_DATA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PS_WAIT_FOR_PSPOLL_DATA</span><span class="p">;</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span>
			<span class="s">&quot;Going back to sleep after having received PS-Poll data (0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PS_WAIT_FOR_BEACON</span> <span class="o">|</span>
					<span class="n">PS_WAIT_FOR_CAB</span> <span class="o">|</span>
					<span class="n">PS_WAIT_FOR_PSPOLL_DATA</span> <span class="o">|</span>
					<span class="n">PS_WAIT_FOR_TX_ACK</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath_edma_get_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">ath9k_rx_qtype</span> <span class="n">qtype</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ath_rx_status</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">**</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_rx_edma</span> <span class="o">*</span><span class="n">rx_edma</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_edma</span><span class="p">[</span><span class="n">qtype</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_edma</span><span class="o">-&gt;</span><span class="n">rx_fifo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">bf</span> <span class="o">=</span> <span class="n">SKB_CB_ATHBUF</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">);</span>

	<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">,</span>
				<span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_process_rxdesc_edma</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*let device gain the buffer again*/</span>
		<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">,</span>
				<span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_edma</span><span class="o">-&gt;</span><span class="n">rx_fifo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* corrupt descriptor, skip this one and the following one */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>
		<span class="n">ath_rx_edma_buf_link</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">qtype</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_edma</span><span class="o">-&gt;</span><span class="n">rx_fifo</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bf</span> <span class="o">=</span> <span class="n">SKB_CB_ATHBUF</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">);</span>

			<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_edma</span><span class="o">-&gt;</span><span class="n">rx_fifo</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>
			<span class="n">ath_rx_edma_buf_link</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">qtype</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="nf">ath_edma_get_next_rx_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ath_rx_status</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span>
						<span class="k">enum</span> <span class="n">ath9k_rx_qtype</span> <span class="n">qtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ath_edma_get_buffers</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">qtype</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">bf</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="nf">ath_get_next_rx_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ath_rx_status</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_desc</span> <span class="o">*</span><span class="n">ds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxlink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">ds</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_desc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Must provide the virtual address of the current</span>
<span class="cm">	 * descriptor, the physical address, and the virtual</span>
<span class="cm">	 * address of the next descriptor in the h/w chain.</span>
<span class="cm">	 * This allows the HAL to look ahead to see if the</span>
<span class="cm">	 * hardware is done with a descriptor by checking the</span>
<span class="cm">	 * done bit in the following descriptor and the address</span>
<span class="cm">	 * of the current descriptor the DMA engine is working</span>
<span class="cm">	 * on.  All this is necessary because of our use of</span>
<span class="cm">	 * a self-linked list to avoid rx overruns.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_rxprocdesc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">rs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ath_rx_status</span> <span class="n">trs</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">tbf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ath_desc</span> <span class="o">*</span><span class="n">tds</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">trs</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxlink</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tbf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * On some hardware the descriptor status words could</span>
<span class="cm">		 * get corrupted, including the done bit. Because of</span>
<span class="cm">		 * this, check if the next descriptor&#39;s done bit is</span>
<span class="cm">		 * set or not.</span>
<span class="cm">		 *</span>
<span class="cm">		 * If the next descriptor&#39;s done bit is set, the current</span>
<span class="cm">		 * descriptor has been corrupted. Force s/w to discard</span>
<span class="cm">		 * this descriptor and continue...</span>
<span class="cm">		 */</span>

		<span class="n">tds</span> <span class="o">=</span> <span class="n">tbf</span><span class="o">-&gt;</span><span class="n">bf_desc</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_rxprocdesc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">tds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Synchronize the DMA transfer with CPU before</span>
<span class="cm">	 * 1. accessing the frame</span>
<span class="cm">	 * 2. requeueing the same buffer to h/w</span>
<span class="cm">	 */</span>
	<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">,</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
			<span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Assumes you&#39;ve already done the endian to CPU conversion */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_rx_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rxs</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ath_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="o">*</span><span class="n">decrypt_error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_mc</span><span class="p">,</span> <span class="n">is_valid_tkip</span><span class="p">,</span> <span class="n">strip_mic</span><span class="p">,</span> <span class="n">mic_error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rx_status_len</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_status_len</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

	<span class="n">is_mc</span> <span class="o">=</span> <span class="o">!!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
	<span class="n">is_valid_tkip</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_keyix</span> <span class="o">!=</span> <span class="n">ATH9K_RXKEYIX_INVALID</span> <span class="o">&amp;&amp;</span>
		<span class="n">test_bit</span><span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_keyix</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">tkip_keymap</span><span class="p">);</span>
	<span class="n">strip_mic</span> <span class="o">=</span> <span class="n">is_valid_tkip</span> <span class="o">&amp;&amp;</span> <span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">ATH9K_RXERR_DECRYPT</span> <span class="o">|</span> <span class="n">ATH9K_RXERR_CRC</span> <span class="o">|</span> <span class="n">ATH9K_RXERR_MIC</span> <span class="o">|</span>
		 <span class="n">ATH9K_RXERR_KEYMISS</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Key miss events are only relevant for pairwise keys where the</span>
<span class="cm">	 * descriptor does contain a valid key index. This has been observed</span>
<span class="cm">	 * mostly with CCMP encryption.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_keyix</span> <span class="o">==</span> <span class="n">ATH9K_RXKEYIX_INVALID</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_keyix</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ccmp_keymap</span><span class="p">))</span>
		<span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_RXERR_KEYMISS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_datalen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RX_STAT_INC</span><span class="p">(</span><span class="n">rx_len_err</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

        <span class="cm">/*</span>
<span class="cm">         * rs_status follows rs_datalen so if rs_datalen is too large</span>
<span class="cm">         * we can take a hint that hardware corrupted it, so ignore</span>
<span class="cm">         * those frames.</span>
<span class="cm">         */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_datalen</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span> <span class="o">-</span> <span class="n">rx_status_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RX_STAT_INC</span><span class="p">(</span><span class="n">rx_len_err</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Only use error bits from the last fragment */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_more</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">mic_error</span> <span class="o">=</span> <span class="n">is_valid_tkip</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ieee80211_is_ctl</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_FRAG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_RXERR_MIC</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The rx_stats-&gt;rs_status will not be set until the end of the</span>
<span class="cm">	 * chained descriptors so it can be ignored if rs_more is set. The</span>
<span class="cm">	 * rs_more will be false at the last element of the chained</span>
<span class="cm">	 * descriptors.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">status_mask</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_RXERR_CRC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_FAILED_FCS_CRC</span><span class="p">;</span>
			<span class="n">mic_error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_RXERR_PHY</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_RXERR_DECRYPT</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">is_mc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_RXERR_KEYMISS</span><span class="p">)))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">decrypt_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">mic_error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Reject error frames with the exception of</span>
<span class="cm">		 * decryption and MIC failures. For monitor mode,</span>
<span class="cm">		 * we also ignore the CRC error.</span>
<span class="cm">		 */</span>
		<span class="n">status_mask</span> <span class="o">=</span> <span class="n">ATH9K_RXERR_DECRYPT</span> <span class="o">|</span> <span class="n">ATH9K_RXERR_MIC</span> <span class="o">|</span>
			      <span class="n">ATH9K_RXERR_KEYMISS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxfilter</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">))</span>
			<span class="n">status_mask</span> <span class="o">|=</span> <span class="n">ATH9K_RXERR_CRC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">status_mask</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For unicast frames the MIC error bit can have false positives,</span>
<span class="cm">	 * so all MIC error reports need to be validated in software.</span>
<span class="cm">	 * False negatives are not common, so skip software verification</span>
<span class="cm">	 * if the hardware considers the MIC valid.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strip_mic</span><span class="p">)</span>
		<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MMIC_STRIPPED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_mc</span> <span class="o">&amp;&amp;</span> <span class="n">mic_error</span><span class="p">)</span>
		<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MMIC_ERROR</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_process_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ath_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rxs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="n">__maybe_unused</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">band</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="n">sband</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_rate</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* HT rate */</span>
		<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_HT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_RX_2040</span><span class="p">)</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_40MHZ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_RX_GI</span><span class="p">)</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORT_GI</span><span class="p">;</span>
		<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_rate</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span> <span class="o">==</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value_short</span> <span class="o">==</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORTPRE</span><span class="p">;</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * No valid hardware bitrate found -- we should not get here</span>
<span class="cm">	 * because hardware has already validated this frame as OK.</span>
<span class="cm">	 */</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANY</span><span class="p">,</span>
		<span class="s">&quot;unsupported hw bitrate detected 0x%02x using 1 Mbit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_rate</span><span class="p">);</span>
	<span class="n">RX_STAT_INC</span><span class="p">(</span><span class="n">rx_rate_err</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_process_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ath_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_rssi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rssi</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_rssi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">is_mybeacon</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_rssi</span> <span class="o">!=</span> <span class="n">ATH9K_RSSI_BAD</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_moreaggr</span><span class="p">)</span>
		<span class="n">ATH_RSSI_LPF</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">last_rssi</span><span class="p">,</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_rssi</span><span class="p">);</span>

	<span class="n">last_rssi</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">last_rssi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">last_rssi</span> <span class="o">!=</span> <span class="n">ATH_RSSI_DUMMY_MARKER</span><span class="p">))</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="n">ATH_EP_RND</span><span class="p">(</span><span class="n">last_rssi</span><span class="p">,</span> <span class="n">ATH_RSSI_EP_MULTIPLIER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Update Beacon RSSI, this is used by ANI. */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">avgbrssi</span> <span class="o">=</span> <span class="n">rssi</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * For Decrypt or Demic errors, we only mark packet status here and always push</span>
<span class="cm"> * up the frame up to let mac80211 handle the actual error case, be it no</span>
<span class="cm"> * decryption key or real decryption error. This let us keep statistics there.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_rx_skb_preprocess</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ath_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rx_status</span><span class="p">,</span>
				   <span class="n">bool</span> <span class="o">*</span><span class="n">decrypt_error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * everything but the rate is checked here, the rate check is done</span>
<span class="cm">	 * separately to avoid doing two lookups for a rate for each frame.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_rx_accept</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="n">decrypt_error</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Only use status info from the last fragment */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_more</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ath9k_process_rssi</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_process_rate</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">+</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_rssi</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">antenna</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_antenna</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MACTIME_MPDU</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_moreaggr</span><span class="p">)</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_NO_SIGNAL_VAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_rx_skb_postprocess</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ath_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rxs</span><span class="p">,</span>
				     <span class="n">bool</span> <span class="n">decrypt_error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">padpos</span><span class="p">,</span> <span class="n">padsize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">keyix</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="cm">/* see if any padding is done by the hw and remove it */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ieee80211_get_hdrlen_from_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="n">padpos</span> <span class="o">=</span> <span class="n">ath9k_cmn_padpos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="cm">/* The MAC header is padded to have 32-bit boundary if the</span>
<span class="cm">	 * packet payload is non-zero. The general calculation for</span>
<span class="cm">	 * padsize would take into account odd header lengths:</span>
<span class="cm">	 * padsize = (4 - padpos % 4) % 4; However, since only</span>
<span class="cm">	 * even-length headers are used, padding can only be 0 or 2</span>
<span class="cm">	 * bytes and we can optimize this a bit. In addition, we must</span>
<span class="cm">	 * not try to remove padding from short control frames that do</span>
<span class="cm">	 * not have payload. */</span>
	<span class="n">padsize</span> <span class="o">=</span> <span class="n">padpos</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padsize</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">&gt;=</span><span class="n">padpos</span><span class="o">+</span><span class="n">padsize</span><span class="o">+</span><span class="n">FCS_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">padpos</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">padsize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">keyix</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rs_keyix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">keyix</span> <span class="o">==</span> <span class="n">ATH9K_RXKEYIX_INVALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">decrypt_error</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span>
		   <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">decrypt_error</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">keyix</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">keyix</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">keymap</span><span class="p">))</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">sw_mgmt_crypto</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="cm">/* Use software decrypt for management frames. */</span>
		<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX_FLAG_DECRYPTED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_lnaconf_alt_good_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_ant_comb</span> <span class="o">*</span><span class="n">antcomb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ath_hw_antcomb_conf</span> <span class="n">ant_conf</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">main_rssi_avg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">quick_scan_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna2</span> <span class="o">=</span> <span class="n">main_rssi_avg</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna1</span> <span class="o">=</span> <span class="n">main_rssi_avg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x10</span>: <span class="cm">/* LNA2 A-B */</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span> <span class="o">=</span>
			<span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x20</span>: <span class="cm">/* LNA1 A-B */</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span> <span class="o">=</span>
			<span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x21</span>: <span class="cm">/* LNA1 LNA2 */</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span> <span class="o">=</span>
			<span class="n">ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">=</span>
			<span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x12</span>: <span class="cm">/* LNA2 LNA1 */</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span> <span class="o">=</span>
			<span class="n">ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">=</span>
			<span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x13</span>: <span class="cm">/* LNA2 A+B */</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span> <span class="o">=</span>
			<span class="n">ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x23</span>: <span class="cm">/* LNA1 A+B */</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span> <span class="o">=</span>
			<span class="n">ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_select_ant_div_from_quick_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_ant_comb</span> <span class="o">*</span><span class="n">antcomb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath_hw_antcomb_conf</span> <span class="o">*</span><span class="n">div_ant_conf</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">main_rssi_avg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alt_rssi_avg</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">alt_ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* alt_good */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">quick_scan_cnt</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* set alt to main, and alt to first conf */</span>
		<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">=</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span><span class="p">;</span>
		<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* set alt to main, and alt to first conf */</span>
		<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">=</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span><span class="p">;</span>
		<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_first</span> <span class="o">=</span> <span class="n">main_rssi_avg</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_second</span> <span class="o">=</span> <span class="n">alt_rssi_avg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* main is LNA1 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ath_is_alt_ant_ratio_better</span><span class="p">(</span><span class="n">alt_ratio</span><span class="p">,</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_DELTA_HI</span><span class="p">,</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_DELTA_LOW</span><span class="p">,</span>
						<span class="n">main_rssi_avg</span><span class="p">,</span> <span class="n">alt_rssi_avg</span><span class="p">,</span>
						<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span><span class="p">))</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_ratio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_ratio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ath_is_alt_ant_ratio_better</span><span class="p">(</span><span class="n">alt_ratio</span><span class="p">,</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_DELTA_MID</span><span class="p">,</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_DELTA_LOW</span><span class="p">,</span>
						<span class="n">main_rssi_avg</span><span class="p">,</span> <span class="n">alt_rssi_avg</span><span class="p">,</span>
						<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span><span class="p">))</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_ratio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_ratio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((((</span><span class="n">alt_ratio</span> <span class="o">&gt;=</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">alt_rssi_avg</span> <span class="o">&gt;</span> <span class="n">main_rssi_avg</span> <span class="o">+</span>
			    <span class="n">ATH_ANT_DIV_COMB_LNA1_DELTA_HI</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">alt_rssi_avg</span> <span class="o">&gt;</span> <span class="n">main_rssi_avg</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">))</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_ratio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_ratio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_good</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan_not_start</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_first</span> <span class="o">=</span> <span class="n">main_rssi_avg</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_third</span> <span class="o">=</span> <span class="n">alt_rssi_avg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna1</span> <span class="o">=</span> <span class="n">alt_rssi_avg</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">==</span>
			 <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna2</span> <span class="o">=</span> <span class="n">alt_rssi_avg</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">==</span>
			 <span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna2</span> <span class="o">=</span> <span class="n">main_rssi_avg</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna1</span> <span class="o">=</span> <span class="n">main_rssi_avg</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna2</span> <span class="o">&gt;</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna1</span> <span class="o">+</span>
		    <span class="n">ATH_ANT_DIV_COMB_LNA1_LNA2_SWITCH_DELTA</span><span class="p">)</span>
			<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ath_is_alt_ant_ratio_better</span><span class="p">(</span><span class="n">alt_ratio</span><span class="p">,</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_DELTA_HI</span><span class="p">,</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_DELTA_LOW</span><span class="p">,</span>
						<span class="n">main_rssi_avg</span><span class="p">,</span> <span class="n">alt_rssi_avg</span><span class="p">,</span>
						<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span><span class="p">))</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_ratio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_ratio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ath_is_alt_ant_ratio_better</span><span class="p">(</span><span class="n">alt_ratio</span><span class="p">,</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_DELTA_MID</span><span class="p">,</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_DELTA_LOW</span><span class="p">,</span>
						<span class="n">main_rssi_avg</span><span class="p">,</span> <span class="n">alt_rssi_avg</span><span class="p">,</span>
						<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span><span class="p">))</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_ratio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_ratio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((((</span><span class="n">alt_ratio</span> <span class="o">&gt;=</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">alt_rssi_avg</span> <span class="o">&gt;</span> <span class="n">main_rssi_avg</span> <span class="o">+</span>
			    <span class="n">ATH_ANT_DIV_COMB_LNA1_DELTA_HI</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">alt_rssi_avg</span> <span class="o">&gt;</span> <span class="n">main_rssi_avg</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">))</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_ratio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_ratio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* set alt to the conf with maximun ratio */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_ratio</span> <span class="o">&amp;&amp;</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_ratio</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_second</span> <span class="o">&gt;</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_third</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* first alt*/</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span> <span class="o">==</span>
				    <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span> <span class="o">==</span>
				    <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">))</span>
					<span class="cm">/* Set alt LNA1 or LNA2*/</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">==</span>
					    <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span>
						<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
							<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
							<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="cm">/* Set alt to A+B or A-B */</span>
					<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">==</span>
				   <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="o">||</span>
				   <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">==</span>
				   <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Set alt LNA1 or LNA2 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">==</span>
				    <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span>
					<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Set alt to A+B or A-B */</span>
				<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
					<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_ratio</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* first alt */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span> <span class="o">==</span>
			    <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span> <span class="o">==</span>
			    <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">))</span>
					<span class="cm">/* Set alt LNA1 or LNA2 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">==</span>
				    <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span>
					<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
							<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
							<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="cm">/* Set alt to A+B or A-B */</span>
				<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">first_quick_scan_conf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_ratio</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* second alt */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">==</span>
			    <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span> <span class="o">==</span>
			    <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">))</span>
				<span class="cm">/* Set alt LNA1 or LNA2 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">==</span>
				    <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span>
					<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="cm">/* Set alt to A+B or A-B */</span>
				<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">second_quick_scan_conf</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* main is largest */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">))</span>
				<span class="cm">/* Set alt LNA1 or LNA2 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">==</span>
				    <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span>
					<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
							<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
							<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="cm">/* Set alt to A+B or A-B */</span>
				<span class="n">div_ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span> <span class="o">=</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_conf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_ant_div_conf_fast_divbias</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw_antcomb_conf</span> <span class="o">*</span><span class="n">ant_conf</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">ath_ant_comb</span> <span class="o">*</span><span class="n">antcomb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alt_ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">div_group</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Adjust the fast_div_bias based on main and alt lna conf */</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x01</span>: <span class="cm">/* A-B LNA2 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x3b</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>: <span class="cm">/* A-B LNA1 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x3d</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>: <span class="cm">/* A-B A+B */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x10</span>: <span class="cm">/* LNA2 A-B */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x12</span>: <span class="cm">/* LNA2 LNA1 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x13</span>: <span class="cm">/* LNA2 A+B */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x20</span>: <span class="cm">/* LNA1 A-B */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x21</span>: <span class="cm">/* LNA1 LNA2 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x23</span>: <span class="cm">/* LNA1 A+B */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x30</span>: <span class="cm">/* A+B A-B */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x31</span>: <span class="cm">/* A+B LNA2 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x3b</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x32</span>: <span class="cm">/* A+B LNA1 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x3d</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">div_group</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Adjust the fast_div_bias based on main and alt_lna_conf */</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x01</span>: <span class="cm">/* A-B LNA2 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>: <span class="cm">/* A-B LNA1 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>: <span class="cm">/* A-B A+B */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x10</span>: <span class="cm">/* LNA2 A-B */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">alt_ratio</span> <span class="o">&gt;</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO</span><span class="p">))</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x12</span>: <span class="cm">/* LNA2 LNA1 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x13</span>: <span class="cm">/* LNA2 A+B */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">alt_ratio</span> <span class="o">&gt;</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO</span><span class="p">))</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x20</span>: <span class="cm">/* LNA1 A-B */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">alt_ratio</span> <span class="o">&gt;</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO</span><span class="p">))</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x21</span>: <span class="cm">/* LNA1 LNA2 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x23</span>: <span class="cm">/* LNA1 A+B */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">alt_ratio</span> <span class="o">&gt;</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO</span><span class="p">))</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x30</span>: <span class="cm">/* A+B A-B */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x31</span>: <span class="cm">/* A+B LNA2 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x32</span>: <span class="cm">/* A+B LNA1 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">div_group</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Adjust the fast_div_bias based on main and alt_lna_conf */</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_lna_conf</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_lna_conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x01</span>: <span class="cm">/* A-B LNA2 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>: <span class="cm">/* A-B LNA1 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>: <span class="cm">/* A-B A+B */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x10</span>: <span class="cm">/* LNA2 A-B */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">alt_ratio</span> <span class="o">&gt;</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO</span><span class="p">))</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x12</span>: <span class="cm">/* LNA2 LNA1 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x13</span>: <span class="cm">/* LNA2 A+B */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">alt_ratio</span> <span class="o">&gt;</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO</span><span class="p">))</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x20</span>: <span class="cm">/* LNA1 A-B */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">alt_ratio</span> <span class="o">&gt;</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO</span><span class="p">))</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x21</span>: <span class="cm">/* LNA1 LNA2 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x23</span>: <span class="cm">/* LNA1 A+B */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">alt_ratio</span> <span class="o">&gt;</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO</span><span class="p">))</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x30</span>: <span class="cm">/* A+B A-B */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x31</span>: <span class="cm">/* A+B LNA2 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x32</span>: <span class="cm">/* A+B LNA1 */</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">fast_div_bias</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">main_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ant_conf</span><span class="o">-&gt;</span><span class="n">alt_gaintb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Antenna diversity and combining */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_ant_comb_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_rx_status</span> <span class="o">*</span><span class="n">rs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw_antcomb_conf</span> <span class="n">div_ant_conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_ant_comb</span> <span class="o">*</span><span class="n">antcomb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ant_comb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alt_ratio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">alt_rssi_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">main_rssi_avg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">curr_alt_set</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">curr_main_set</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">main_rssi</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rssi_ctl0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alt_rssi</span> <span class="o">=</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rssi_ctl1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_ant_conf</span><span class="p">,</span>  <span class="n">main_ant_conf</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">short_scan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">rx_ant_conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rssi_ctl2</span> <span class="o">&gt;&gt;</span> <span class="n">ATH_ANT_RX_CURRENT_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
		       <span class="n">ATH_ANT_RX_MASK</span><span class="p">;</span>
	<span class="n">main_ant_conf</span> <span class="o">=</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_rssi_ctl2</span> <span class="o">&gt;&gt;</span> <span class="n">ATH_ANT_RX_MAIN_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="n">ATH_ANT_RX_MASK</span><span class="p">;</span>

	<span class="cm">/* Record packet only when both main_rssi and  alt_rssi is positive */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">main_rssi</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">alt_rssi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_total_rssi</span> <span class="o">+=</span> <span class="n">main_rssi</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_total_rssi</span>  <span class="o">+=</span> <span class="n">alt_rssi</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">main_ant_conf</span> <span class="o">==</span> <span class="n">rx_ant_conf</span><span class="p">)</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_recv_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_recv_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Short scan check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span> <span class="o">&amp;&amp;</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_good</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan_start_time</span> <span class="o">+</span>
		    <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH_ANT_DIV_COMB_SHORT_SCAN_INTR</span><span class="p">)))</span>
			<span class="n">short_scan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span> <span class="o">==</span>
			    <span class="n">ATH_ANT_DIV_COMB_SHORT_SCAN_PKTCOUNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">alt_ratio</span> <span class="o">=</span> <span class="p">((</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_recv_cnt</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span>
					    <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">alt_ratio</span> <span class="o">&lt;</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO</span><span class="p">)</span>
					<span class="n">short_scan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span> <span class="o">&lt;</span> <span class="n">ATH_ANT_DIV_COMB_MAX_PKTCOUNT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">rs</span><span class="o">-&gt;</span><span class="n">rs_moreaggr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">short_scan</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">alt_ratio</span> <span class="o">=</span> <span class="p">((</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_recv_cnt</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span>
			     <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span><span class="p">);</span>
		<span class="n">main_rssi_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_total_rssi</span> <span class="o">/</span>
				 <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span><span class="p">);</span>
		<span class="n">alt_rssi_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_total_rssi</span> <span class="o">/</span>
				 <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">ath9k_hw_antdiv_comb_conf_get</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div_ant_conf</span><span class="p">);</span>
	<span class="n">curr_alt_set</span> <span class="o">=</span> <span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span><span class="p">;</span>
	<span class="n">curr_main_set</span> <span class="o">=</span> <span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span><span class="p">;</span>

	<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_MAX_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">alt_ratio</span> <span class="o">&gt;</span> <span class="n">ATH_ANT_DIV_COMB_ALT_ANT_RATIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_lnaconf_alt_good_scan</span><span class="p">(</span><span class="n">antcomb</span><span class="p">,</span> <span class="n">div_ant_conf</span><span class="p">,</span>
						  <span class="n">main_rssi_avg</span><span class="p">);</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_good</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_good</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan_not_start</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath_ant_div_comb_alt_check</span><span class="p">(</span><span class="n">div_ant_conf</span><span class="p">.</span><span class="n">div_group</span><span class="p">,</span>
					<span class="n">alt_ratio</span><span class="p">,</span> <span class="n">curr_main_set</span><span class="p">,</span> <span class="n">curr_alt_set</span><span class="p">,</span>
					<span class="n">alt_rssi_avg</span><span class="p">,</span> <span class="n">main_rssi_avg</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curr_alt_set</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Switch main and alt LNA */</span>
				<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
				<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span>  <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">curr_alt_set</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
				<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span>  <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">goto</span> <span class="n">div_comb_done</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">curr_alt_set</span> <span class="o">!=</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">curr_alt_set</span> <span class="o">!=</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Set alt to another LNA */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curr_main_set</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span>
				<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">curr_main_set</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span>
				<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>

			<span class="k">goto</span> <span class="n">div_comb_done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">alt_rssi_avg</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">main_rssi_avg</span> <span class="o">+</span>
						<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">lna1_lna2_delta</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">div_comb_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan_not_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">curr_alt_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span>:
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna2</span> <span class="o">=</span> <span class="n">alt_rssi_avg</span><span class="p">;</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna1</span> <span class="o">=</span> <span class="n">main_rssi_avg</span><span class="p">;</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* set to A+B */</span>
			<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span>
				<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
			<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span>  <span class="o">=</span>
				<span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span>:
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna1</span> <span class="o">=</span> <span class="n">alt_rssi_avg</span><span class="p">;</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna2</span> <span class="o">=</span> <span class="n">main_rssi_avg</span><span class="p">;</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* set to A+B */</span>
			<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
			<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span>  <span class="o">=</span>
				<span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span>:
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_add</span> <span class="o">=</span> <span class="n">alt_rssi_avg</span><span class="p">;</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* set to A-B */</span>
			<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
				<span class="n">ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2</span>:
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_sub</span> <span class="o">=</span> <span class="n">alt_rssi_avg</span><span class="p">;</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna2</span> <span class="o">&gt;</span>
			    <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna1</span> <span class="o">+</span>
			    <span class="n">ATH_ANT_DIV_COMB_LNA1_LNA2_SWITCH_DELTA</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* use LNA2 as main LNA */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_add</span> <span class="o">&gt;</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_add</span> <span class="o">&gt;</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_sub</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* set to A+B */</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span>  <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_sub</span> <span class="o">&gt;</span>
					   <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* set to A-B */</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* set to LNA1 */</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* use LNA1 as main LNA */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_add</span> <span class="o">&gt;</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_add</span> <span class="o">&gt;</span> <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_sub</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* set to A+B */</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span>  <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_sub</span> <span class="o">&gt;</span>
					   <span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">rssi_lna1</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* set to A-B */</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* set to LNA2 */</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
					<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_good</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan_not_start</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="cm">/* Set alt to another LNA */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curr_main_set</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
				<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">curr_main_set</span> <span class="o">==</span> <span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">main_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA1</span><span class="p">;</span>
				<span class="n">div_ant_conf</span><span class="p">.</span><span class="n">alt_lna_conf</span> <span class="o">=</span>
						<span class="n">ATH_ANT_DIV_COMB_LNA2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">div_comb_done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ath_select_ant_div_from_quick_scan</span><span class="p">(</span><span class="n">antcomb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div_ant_conf</span><span class="p">,</span>
					   <span class="n">main_rssi_avg</span><span class="p">,</span> <span class="n">alt_rssi_avg</span><span class="p">,</span>
					   <span class="n">alt_ratio</span><span class="p">);</span>

	<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">quick_scan_cnt</span><span class="o">++</span><span class="p">;</span>

<span class="nl">div_comb_done:</span>
	<span class="n">ath_ant_div_conf_fast_divbias</span><span class="p">(</span><span class="o">&amp;</span><span class="n">div_ant_conf</span><span class="p">,</span> <span class="n">antcomb</span><span class="p">,</span> <span class="n">alt_ratio</span><span class="p">);</span>
	<span class="n">ath9k_hw_antdiv_comb_conf_set</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">div_ant_conf</span><span class="p">);</span>

	<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">scan_start_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">total_pkt_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_total_rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_total_rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">main_recv_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">antcomb</span><span class="o">-&gt;</span><span class="n">alt_recv_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath_rx_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flush</span><span class="p">,</span> <span class="n">bool</span> <span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">requeue_skb</span><span class="p">,</span> <span class="o">*</span><span class="n">hdr_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rxs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">decrypt_error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_rx_status</span> <span class="n">rs</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ath9k_rx_qtype</span> <span class="n">qtype</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">edma</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">dma_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rx_status_len</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_status_len</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tsf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tsf_lower</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edma</span><span class="p">)</span>
		<span class="n">dma_type</span> <span class="o">=</span> <span class="n">DMA_BIDIRECTIONAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dma_type</span> <span class="o">=</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>

	<span class="n">qtype</span> <span class="o">=</span> <span class="n">hp</span> <span class="o">?</span> <span class="n">ATH9K_RX_QUEUE_HP</span> <span class="o">:</span> <span class="n">ATH9K_RX_QUEUE_LP</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>

	<span class="n">tsf</span> <span class="o">=</span> <span class="n">ath9k_hw_gettsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">tsf_lower</span> <span class="o">=</span> <span class="n">tsf</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* If handling rx interrupt and flush is in progress =&gt; exit */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_RXFLUSH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flush</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rs</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edma</span><span class="p">)</span>
			<span class="n">bf</span> <span class="o">=</span> <span class="n">ath_edma_get_next_rx_buf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="n">qtype</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">bf</span> <span class="o">=</span> <span class="n">ath_get_next_rx_buf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Take frame header from the first fragment and RX status from</span>
<span class="cm">		 * the last one.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span><span class="p">)</span>
			<span class="n">hdr_skb</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">hdr_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">hdr_skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">rx_status_len</span><span class="p">);</span>
		<span class="n">rxs</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">hdr_skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RX_STAT_INC</span><span class="p">(</span><span class="n">rx_beacons</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">))</span>
				<span class="n">rs</span><span class="p">.</span><span class="n">is_mybeacon</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rs</span><span class="p">.</span><span class="n">is_mybeacon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">rs</span><span class="p">.</span><span class="n">is_mybeacon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">ath_debug_stat_rx</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If we&#39;re asked to flush receive queue, directly</span>
<span class="cm">		 * chain it back at the queue without processing it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_RXFLUSH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RX_STAT_INC</span><span class="p">(</span><span class="n">rx_drop_rxflush</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">requeue_drop_frag</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">rxs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_rx_status</span><span class="p">));</span>

		<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">mactime</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsf</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffffffffULL</span><span class="p">)</span> <span class="o">|</span> <span class="n">rs</span><span class="p">.</span><span class="n">rs_tstamp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">rs_tstamp</span> <span class="o">&gt;</span> <span class="n">tsf_lower</span> <span class="o">&amp;&amp;</span>
		    <span class="n">unlikely</span><span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">rs_tstamp</span> <span class="o">-</span> <span class="n">tsf_lower</span> <span class="o">&gt;</span> <span class="mh">0x10000000</span><span class="p">))</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">mactime</span> <span class="o">-=</span> <span class="mh">0x100000000ULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">rs_tstamp</span> <span class="o">&lt;</span> <span class="n">tsf_lower</span> <span class="o">&amp;&amp;</span>
		    <span class="n">unlikely</span><span class="p">(</span><span class="n">tsf_lower</span> <span class="o">-</span> <span class="n">rs</span><span class="p">.</span><span class="n">rs_tstamp</span> <span class="o">&gt;</span> <span class="mh">0x10000000</span><span class="p">))</span>
			<span class="n">rxs</span><span class="o">-&gt;</span><span class="n">mactime</span> <span class="o">+=</span> <span class="mh">0x100000000ULL</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">ath9k_rx_skb_preprocess</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span>
						 <span class="n">rxs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">decrypt_error</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">requeue_drop_frag</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">is_mybeacon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_busy_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ath_start_rx_poll</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Ensure we always have an skb to requeue once we are done</span>
<span class="cm">		 * processing the current buffer&#39;s skb */</span>
		<span class="n">requeue_skb</span> <span class="o">=</span> <span class="n">ath_rxbuf_alloc</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="cm">/* If there is no memory we ignore the current RX&#39;d frame,</span>
<span class="cm">		 * tell hardware it can give us a new frame using the old</span>
<span class="cm">		 * skb and put it at the tail of the sc-&gt;rx.rxbuf list for</span>
<span class="cm">		 * processing. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">requeue_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RX_STAT_INC</span><span class="p">(</span><span class="n">rx_oom_err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">requeue_drop_frag</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Unmap the frame */</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">,</span>
				 <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
				 <span class="n">dma_type</span><span class="p">);</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rs</span><span class="p">.</span><span class="n">rs_datalen</span> <span class="o">+</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_status_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_status_len</span><span class="p">)</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_status_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs</span><span class="p">.</span><span class="n">rs_more</span><span class="p">)</span>
			<span class="n">ath9k_rx_skb_postprocess</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">hdr_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span>
						 <span class="n">rxs</span><span class="p">,</span> <span class="n">decrypt_error</span><span class="p">);</span>

		<span class="cm">/* We will now give hardware our shiny new allocated skb */</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="n">requeue_skb</span><span class="p">;</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">requeue_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						 <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span><span class="p">,</span>
						 <span class="n">dma_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">requeue_skb</span><span class="p">);</span>
			<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;dma_mapping_error() on RX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ieee80211_rx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rs</span><span class="p">.</span><span class="n">rs_more</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RX_STAT_INC</span><span class="p">(</span><span class="n">rx_frags</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * rs_more indicates chained descriptors which can be</span>
<span class="cm">			 * used to link buffers together for a sort of</span>
<span class="cm">			 * scatter-gather operation.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* too many fragments - cannot handle frame */</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">RX_STAT_INC</span><span class="p">(</span><span class="n">rx_too_many_frags_err</span><span class="p">);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">requeue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">space</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">hdr_skb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">hdr_skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">RX_STAT_INC</span><span class="p">(</span><span class="n">rx_oom_err</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">requeue_drop_frag</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">hdr_skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
						  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">hdr_skb</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_ANT_DIV_COMB</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 * change the default rx antenna if rx diversity</span>
<span class="cm">			 * chooses the other antenna 3 times in a row.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">defant</span> <span class="o">!=</span> <span class="n">rs</span><span class="p">.</span><span class="n">rs_antenna</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxotherant</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
					<span class="n">ath_setdefantenna</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">rs</span><span class="p">.</span><span class="n">rs_antenna</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxotherant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxs</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">RX_FLAG_MMIC_STRIPPED</span><span class="p">)</span>
			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PS_WAIT_FOR_BEACON</span> <span class="o">|</span>
				     <span class="n">PS_WAIT_FOR_CAB</span> <span class="o">|</span>
				     <span class="n">PS_WAIT_FOR_PSPOLL_DATA</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">ath9k_check_auto_sleep</span><span class="p">(</span><span class="n">sc</span><span class="p">))</span>
			<span class="n">ath_rx_ps</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rs</span><span class="p">.</span><span class="n">is_mybeacon</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pm_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_ANT_DIV_COMB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">ant_rx</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">ath_ant_comb_scan</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">);</span>

		<span class="n">ieee80211_rx</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

<span class="nl">requeue_drop_frag:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span><span class="p">);</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">frag</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">requeue:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">edma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>
			<span class="n">ath_rx_edma_buf_link</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">qtype</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuf</span><span class="p">);</span>
			<span class="n">ath_rx_buf_link</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flush</span><span class="p">)</span>
				<span class="n">ath9k_hw_rxena</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">rxbuflock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">&amp;</span> <span class="n">ATH9K_INT_RXEOL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ATH9K_INT_RXEOL</span> <span class="o">|</span> <span class="n">ATH9K_INT_RXORN</span><span class="p">);</span>
		<span class="n">ath9k_hw_set_interrupts</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
