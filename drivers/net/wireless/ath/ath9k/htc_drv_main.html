<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › htc_drv_main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>htc_drv_main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;htc.h&quot;</span>

<span class="cm">/*************/</span>
<span class="cm">/* Utilities */</span>
<span class="cm">/*************/</span>

<span class="cm">/* HACK Alert: Use 11NG for 2.4, use 11NA for 5 */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">htc_phymode</span> <span class="nf">ath9k_htc_get_curmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">ichan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">htc_phymode</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ichan</span><span class="o">-&gt;</span><span class="n">chanmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHANNEL_G</span>:
	<span class="k">case</span> <span class="n">CHANNEL_G_HT20</span>:
	<span class="k">case</span> <span class="n">CHANNEL_G_HT40PLUS</span>:
	<span class="k">case</span> <span class="n">CHANNEL_G_HT40MINUS</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">HTC_MODE_11NG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_A</span>:
	<span class="k">case</span> <span class="n">CHANNEL_A_HT20</span>:
	<span class="k">case</span> <span class="n">CHANNEL_A_HT40PLUS</span>:
	<span class="k">case</span> <span class="n">CHANNEL_A_HT40MINUS</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">HTC_MODE_11NA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ath9k_htc_setpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">ath9k_power_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_usecount</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_ps_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_usecount</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_idle</span><span class="p">)</span>
		<span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_PM_FULL_SLEEP</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_enabled</span><span class="p">)</span>
		<span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_PM_NETWORK_SLEEP</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_ps_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_htc_priv</span><span class="p">,</span>
			     <span class="n">ps_work</span><span class="p">);</span>
	<span class="n">ath9k_htc_setpower</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">);</span>

	<span class="cm">/* The chip wakes up after receiving the first beacon</span>
<span class="cm">	   while network sleep is enabled. For the driver to</span>
<span class="cm">	   be in sync with the hw, set the chip to awake and</span>
<span class="cm">	   only then set it to sleep.</span>
<span class="cm">	 */</span>
	<span class="n">ath9k_htc_setpower</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ATH9K_PM_NETWORK_SLEEP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_vif_iter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reconfig_beacon</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rearm_ani</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reconfig_beacon</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_vif_reconfig</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rearm_ani</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reconfig_beacon</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
						   <span class="n">ath9k_htc_vif_iter</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rearm_ani</span><span class="p">)</span>
		<span class="n">ath9k_htc_start_ani</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reconfig_beacon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">ath9k_htc_beacon_reconfig</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_bssid_iter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_vif_iter_data</span> <span class="o">*</span><span class="n">iter_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">iter_data</span><span class="o">-&gt;</span><span class="n">hw_macaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_set_bssid_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_vif_iter_data</span> <span class="n">iter_data</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the hardware MAC address as reference, the hardware uses it</span>
<span class="cm">	 * together with the BSSID mask when matching addresses.</span>
<span class="cm">	 */</span>
	<span class="n">iter_data</span><span class="p">.</span><span class="n">hw_macaddr</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter_data</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="p">)</span>
		<span class="n">ath9k_htc_bssid_iter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iter_data</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="cm">/* Get list of all active MAC addresses */</span>
	<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ath9k_htc_bssid_iter</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">iter_data</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bssidmask</span><span class="p">,</span> <span class="n">iter_data</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">ath_hw_setbssidmask</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_set_opmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ibss_vif</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ap_vif</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>

	<span class="n">ath9k_hw_setopmode</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_hw_cal_data</span> <span class="o">*</span><span class="n">caldata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_phymode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">htc_mode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">ath9k_htc_stop_ani</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cleanup_timer</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_drain</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_DISABLE_INTR_CMDID</span><span class="p">);</span>
	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_DRAIN_TXQ_ALL_CMDID</span><span class="p">);</span>
	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_STOP_RECV_CMDID</span><span class="p">);</span>

	<span class="n">ath9k_wmi_event_drain</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">caldata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">,</span> <span class="n">caldata</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Unable to reset device (%u Mhz) reset status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath9k_cmn_update_txpow</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpowlimit</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">);</span>

	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_START_RECV_CMDID</span><span class="p">);</span>
	<span class="n">ath9k_host_rx_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">ath9k_htc_get_curmode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">);</span>
	<span class="n">htc_mode</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_SET_MODE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">htc_mode</span><span class="p">);</span>

	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_ENABLE_INTR_CMDID</span><span class="p">);</span>
	<span class="n">htc_start</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="p">);</span>
	<span class="n">ath9k_htc_vif_reconfig</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cleanup_timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH9K_HTC_TX_CLEANUP_INTERVAL</span><span class="p">));</span>

	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">hchan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">fastcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_hw_cal_data</span> <span class="o">*</span><span class="n">caldata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_phymode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">htc_mode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">OP_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">fastcc</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_OFFCHANNEL</span><span class="p">);</span>

	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cleanup_timer</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_drain</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_DISABLE_INTR_CMDID</span><span class="p">);</span>
	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_DRAIN_TXQ_ALL_CMDID</span><span class="p">);</span>
	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_STOP_RECV_CMDID</span><span class="p">);</span>

	<span class="n">ath9k_wmi_event_drain</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
		<span class="s">&quot;(%u MHz) -&gt; (%u MHz), HT: %d, HT40: %d fastcc: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">,</span> <span class="n">conf_is_ht</span><span class="p">(</span><span class="n">conf</span><span class="p">),</span> <span class="n">conf_is_ht40</span><span class="p">(</span><span class="n">conf</span><span class="p">),</span>
		<span class="n">fastcc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fastcc</span><span class="p">)</span>
		<span class="n">caldata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">hchan</span><span class="p">,</span> <span class="n">caldata</span><span class="p">,</span> <span class="n">fastcc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Unable to reset channel (%u Mhz) reset status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_cmn_update_txpow</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpowlimit</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">);</span>

	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_START_RECV_CMDID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ath9k_host_rx_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">ath9k_htc_get_curmode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hchan</span><span class="p">);</span>
	<span class="n">htc_mode</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_SET_MODE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">htc_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_ENABLE_INTR_CMDID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">htc_start</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">OP_SCANNING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_OFFCHANNEL</span><span class="p">))</span>
		<span class="n">ath9k_htc_vif_reconfig</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cleanup_timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH9K_HTC_TX_CLEANUP_INTERVAL</span><span class="p">));</span>

<span class="nl">err:</span>
	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Monitor mode handling is a tad complicated because the firmware requires</span>
<span class="cm"> * an interface to be created exclusively, while mac80211 doesn&#39;t associate</span>
<span class="cm"> * an interface with the mode.</span>
<span class="cm"> *</span>
<span class="cm"> * So, for now, only one monitor interface can be configured.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ath9k_htc_remove_monitor_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_target_vif</span> <span class="n">hvif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hvif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_target_vif</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hvif</span><span class="p">.</span><span class="n">myaddr</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">hvif</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mon_vif_idx</span><span class="p">;</span>
	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_VAP_REMOVE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to remove monitor interface at idx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mon_vif_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nvifs</span><span class="o">--</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_slot</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mon_vif_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_add_monitor_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_target_vif</span> <span class="n">hvif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_target_sta</span> <span class="n">tsta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sta_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nvifs</span> <span class="o">&gt;=</span> <span class="n">ATH9K_HTC_MAX_VIF</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nstations</span> <span class="o">&gt;=</span> <span class="n">ATH9K_HTC_MAX_STA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_vif</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sta_idx</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sta_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sta_idx</span> <span class="o">&gt;</span> <span class="n">ATH9K_HTC_MAX_STA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_vif</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add an interface.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hvif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_target_vif</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hvif</span><span class="p">.</span><span class="n">myaddr</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">hvif</span><span class="p">.</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">HTC_M_MONITOR</span><span class="p">;</span>
	<span class="n">hvif</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_slot</span><span class="p">);</span>

	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_VAP_CREATE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_vif</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Assign the monitor interface index as a special case here.</span>
<span class="cm">	 * This is needed when the interface is brought down.</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mon_vif_idx</span> <span class="o">=</span> <span class="n">hvif</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_slot</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hvif</span><span class="p">.</span><span class="n">index</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the hardware mode to monitor only if there are no</span>
<span class="cm">	 * other interfaces.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nvifs</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_MONITOR</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nvifs</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Associate a station with the interface for packet injection.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsta</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_target_sta</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsta</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">tsta</span><span class="p">.</span><span class="n">is_vif_sta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tsta</span><span class="p">.</span><span class="n">sta_index</span> <span class="o">=</span> <span class="n">sta_idx</span><span class="p">;</span>
	<span class="n">tsta</span><span class="p">.</span><span class="n">vif_index</span> <span class="o">=</span> <span class="n">hvif</span><span class="p">.</span><span class="n">index</span><span class="p">;</span>
	<span class="n">tsta</span><span class="p">.</span><span class="n">maxampdu</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>

	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_NODE_CREATE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to add station entry for monitor mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_sta</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_slot</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sta_idx</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nstations</span><span class="o">++</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_sta_pos</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mon_vif_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_idx</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
		<span class="s">&quot;Attached a monitor interface at idx: %d, sta idx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mon_vif_idx</span><span class="p">,</span> <span class="n">sta_idx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_sta:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Remove the interface from the target.</span>
<span class="cm">	 */</span>
	<span class="n">__ath9k_htc_remove_monitor_interface</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">err_vif:</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">FATAL</span><span class="p">,</span> <span class="s">&quot;Unable to attach a monitor interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_remove_monitor_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">,</span> <span class="n">sta_idx</span><span class="p">;</span>

	<span class="n">__ath9k_htc_remove_monitor_interface</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">sta_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_sta_pos</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mon_vif_idx</span><span class="p">];</span>

	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_NODE_REMOVE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to remove station entry for monitor mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_slot</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sta_idx</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nstations</span><span class="o">--</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
		<span class="s">&quot;Removed a monitor interface at idx: %d, sta idx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mon_vif_idx</span><span class="p">,</span> <span class="n">sta_idx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_add_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_target_sta</span> <span class="n">tsta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_vif</span> <span class="o">*</span><span class="n">avp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_vif</span> <span class="o">*</span><span class="p">)</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="n">ista</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">sta_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">maxampdu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nstations</span> <span class="o">&gt;=</span> <span class="n">ATH9K_HTC_MAX_STA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">sta_idx</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sta_idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sta_idx</span> <span class="o">&gt;</span> <span class="n">ATH9K_HTC_MAX_STA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsta</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_target_sta</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ista</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsta</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsta</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">tsta</span><span class="p">.</span><span class="n">is_vif_sta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ista</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">sta_idx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsta</span><span class="p">.</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">tsta</span><span class="p">.</span><span class="n">is_vif_sta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tsta</span><span class="p">.</span><span class="n">sta_index</span> <span class="o">=</span> <span class="n">sta_idx</span><span class="p">;</span>
	<span class="n">tsta</span><span class="p">.</span><span class="n">vif_index</span> <span class="o">=</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tsta</span><span class="p">.</span><span class="n">maxampdu</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">maxampdu</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">IEEE80211_HT_MAX_AMPDU_FACTOR</span> <span class="o">+</span>
				 <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span><span class="p">);</span>
		<span class="n">tsta</span><span class="p">.</span><span class="n">maxampdu</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">maxampdu</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_NODE_CREATE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
				<span class="s">&quot;Unable to add station entry for: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
			<span class="s">&quot;Added a station entry for: %pM (idx: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tsta</span><span class="p">.</span><span class="n">sta_index</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
			<span class="s">&quot;Added a station entry for VIF %d (idx: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">tsta</span><span class="p">.</span><span class="n">sta_index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_slot</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sta_idx</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nstations</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_sta_pos</span><span class="p">[</span><span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta_idx</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_remove_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_vif</span> <span class="o">*</span><span class="n">avp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_vif</span> <span class="o">*</span><span class="p">)</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="n">ista</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">,</span> <span class="n">sta_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ista</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
		<span class="n">sta_idx</span> <span class="o">=</span> <span class="n">ista</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sta_idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_sta_pos</span><span class="p">[</span><span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_NODE_REMOVE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
				<span class="s">&quot;Unable to remove station entry for: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
			<span class="s">&quot;Removed a station entry for: %pM (idx: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta_idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
			<span class="s">&quot;Removed a station entry for VIF %d (idx: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">sta_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sta_slot</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">sta_idx</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nstations</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_htc_update_cap_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">enable_coex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_cap_target</span> <span class="n">tcap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tcap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_cap_target</span><span class="p">));</span>

	<span class="n">tcap</span><span class="p">.</span><span class="n">ampdu_limit</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">tcap</span><span class="p">.</span><span class="n">ampdu_subframes</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tcap</span><span class="p">.</span><span class="n">enable_coex</span> <span class="o">=</span> <span class="n">enable_coex</span><span class="p">;</span>
	<span class="n">tcap</span><span class="p">.</span><span class="n">tx_chainmask</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">tx_chainmask</span><span class="p">;</span>

	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_TARGET_IC_UPDATE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tcap</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_setup_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ath9k_htc_target_rate</span> <span class="o">*</span><span class="n">trate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="n">ista</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">caps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">trate</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">.</span><span class="n">legacy_rates</span><span class="p">.</span><span class="n">rs_rates</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
				<span class="o">=</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">trate</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">.</span><span class="n">legacy_rates</span><span class="p">.</span><span class="n">rs_nrates</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">77</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="mi">8</span><span class="p">)))</span>
				<span class="n">trate</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">.</span><span class="n">ht_rates</span><span class="p">.</span><span class="n">rs_rates</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="n">ATH_HTC_RATE_MAX</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">trate</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">.</span><span class="n">ht_rates</span><span class="p">.</span><span class="n">rs_nrates</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

		<span class="n">caps</span> <span class="o">=</span> <span class="n">WLAN_RC_HT_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="n">caps</span> <span class="o">|=</span> <span class="n">WLAN_RC_DS_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">conf_is_ht40</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)))</span>
			<span class="n">caps</span> <span class="o">|=</span> <span class="n">WLAN_RC_40_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht40</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">))</span>
			<span class="n">caps</span> <span class="o">|=</span> <span class="n">WLAN_RC_SGI_FLAG</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht20</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span><span class="p">))</span>
			<span class="n">caps</span> <span class="o">|=</span> <span class="n">WLAN_RC_SGI_FLAG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trate</span><span class="o">-&gt;</span><span class="n">sta_index</span> <span class="o">=</span> <span class="n">ista</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">trate</span><span class="o">-&gt;</span><span class="n">isnew</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">trate</span><span class="o">-&gt;</span><span class="n">capflags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">caps</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_send_rate_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ath9k_htc_target_rate</span> <span class="o">*</span><span class="n">trate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>

	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_RC_RATE_UPDATE_CMDID</span><span class="p">,</span> <span class="n">trate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Unable to initialize Rate information on target</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_init_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_target_rate</span> <span class="n">trate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_target_rate</span><span class="p">));</span>
	<span class="n">ath9k_htc_setup_rate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trate</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_send_rate_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
			<span class="s">&quot;Updated target sta: %pM, rate caps: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">trate</span><span class="p">.</span><span class="n">capflags</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_update_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_target_rate</span> <span class="n">trate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">trate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_target_rate</span><span class="p">));</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ieee80211_find_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ath9k_htc_setup_rate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trate</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_send_rate_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
			<span class="s">&quot;Updated target sta: %pM, rate caps: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">trate</span><span class="p">.</span><span class="n">capflags</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_tx_aggr_oper</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">ieee80211_ampdu_mlme_action</span> <span class="n">action</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_target_aggr</span> <span class="n">aggr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="n">ista</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">ATH9K_HTC_MAX_TID</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aggr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_target_aggr</span><span class="p">));</span>
	<span class="n">ista</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="n">aggr</span><span class="p">.</span><span class="n">sta_index</span> <span class="o">=</span> <span class="n">ista</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">aggr</span><span class="p">.</span><span class="n">tidno</span> <span class="o">=</span> <span class="n">tid</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">aggr</span><span class="p">.</span><span class="n">aggr_enable</span> <span class="o">=</span> <span class="p">(</span><span class="n">action</span> <span class="o">==</span> <span class="n">IEEE80211_AMPDU_TX_START</span><span class="p">)</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_TX_AGGR_ENABLE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aggr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
			<span class="s">&quot;Unable to %s TX aggregation for (%pM, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">aggr</span><span class="p">.</span><span class="n">aggr_enable</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;start&quot;</span> <span class="o">:</span> <span class="s">&quot;stop&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
			<span class="s">&quot;%s TX aggregation for (%pM, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">aggr</span><span class="p">.</span><span class="n">aggr_enable</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Starting&quot;</span> <span class="o">:</span> <span class="s">&quot;Stopping&quot;</span><span class="p">,</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">ista</span><span class="o">-&gt;</span><span class="n">tid_state</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">aggr</span><span class="p">.</span><span class="n">aggr_enable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="o">?</span> <span class="n">AGGR_START</span> <span class="o">:</span> <span class="n">AGGR_STOP</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******/</span>
<span class="cm">/* ANI */</span>
<span class="cm">/*******/</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_start_ani</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">longcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">shortcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">checkani_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">|=</span> <span class="n">OP_ANI_RUNNING</span><span class="p">;</span>

	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ani_work</span><span class="p">,</span>
				     <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH_ANI_POLLINTERVAL</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_stop_ani</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ani_work</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OP_ANI_RUNNING</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_htc_ani_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_htc_priv</span><span class="p">,</span> <span class="n">ani_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">longcal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">shortcal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">aniflag</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">cal_interval</span><span class="p">,</span> <span class="n">short_cal_interval</span><span class="p">;</span>

	<span class="n">short_cal_interval</span> <span class="o">=</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">ATH_AP_SHORT_CALINTERVAL</span> <span class="o">:</span> <span class="n">ATH_STA_SHORT_CALINTERVAL</span><span class="p">;</span>

	<span class="cm">/* Only calibrate if awake */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">!=</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">set_timer</span><span class="p">;</span>

	<span class="cm">/* Long calibration runs independently of short calibration. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">longcal_timer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ATH_LONG_CALINTERVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">longcal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;longcal @%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">longcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Short calibration applies only while caldone is false */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">caldone</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">shortcal_timer</span><span class="p">)</span> <span class="o">&gt;=</span>
		    <span class="n">short_cal_interval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">shortcal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;shortcal @%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">shortcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">resetcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">resetcal_timer</span><span class="p">)</span> <span class="o">&gt;=</span>
		    <span class="n">ATH_RESTART_CALINTERVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">caldone</span> <span class="o">=</span> <span class="n">ath9k_hw_reset_calvalid</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">caldone</span><span class="p">)</span>
				<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">resetcal_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Verify whether we must check ANI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">enable_ani</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">timestamp</span> <span class="o">-</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">checkani_timer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ATH_ANI_POLLINTERVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">aniflag</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">checkani_timer</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Skip all processing if there&#39;s nothing to do. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">longcal</span> <span class="o">||</span> <span class="n">shortcal</span> <span class="o">||</span> <span class="n">aniflag</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

		<span class="cm">/* Call ANI routine if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aniflag</span><span class="p">)</span>
			<span class="n">ath9k_hw_ani_monitor</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">);</span>

		<span class="cm">/* Perform calibration if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">longcal</span> <span class="o">||</span> <span class="n">shortcal</span><span class="p">)</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">caldone</span> <span class="o">=</span>
				<span class="n">ath9k_hw_calibrate</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">,</span>
						   <span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxchainmask</span><span class="p">,</span> <span class="n">longcal</span><span class="p">);</span>

		<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">set_timer:</span>
	<span class="cm">/*</span>
<span class="cm">	* Set timer interval based on previous results.</span>
<span class="cm">	* The interval must be the shortest necessary to satisfy ANI,</span>
<span class="cm">	* short calibration and long calibration.</span>
<span class="cm">	*/</span>
	<span class="n">cal_interval</span> <span class="o">=</span> <span class="n">ATH_LONG_CALINTERVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">enable_ani</span><span class="p">)</span>
		<span class="n">cal_interval</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cal_interval</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ATH_ANI_POLLINTERVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">caldone</span><span class="p">)</span>
		<span class="n">cal_interval</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cal_interval</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">short_cal_interval</span><span class="p">);</span>

	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ani_work</span><span class="p">,</span>
				     <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">cal_interval</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**********************/</span>
<span class="cm">/* mac80211 Callbacks */</span>
<span class="cm">/**********************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">padpos</span><span class="p">,</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">slot</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Add the padding after the header if this is not already done */</span>
	<span class="n">padpos</span> <span class="o">=</span> <span class="n">ath9k_cmn_padpos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">padsize</span> <span class="o">=</span> <span class="n">padpos</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padsize</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">padpos</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">padsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;No room for padding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">padsize</span><span class="p">);</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">padpos</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">ath9k_htc_tx_get_slot</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;No free TX slot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_tx_start</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;Tx failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">clear_slot</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_htc_check_stop_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">clear_slot:</span>
	<span class="n">ath9k_htc_tx_clear_slot</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
<span class="nl">fail_tx:</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">init_channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_phymode</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">htc_mode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
		<span class="s">&quot;Starting driver with initial channel: %d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">curchan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>

	<span class="cm">/* Ensure that HW is awake before flushing RX */</span>
	<span class="n">ath9k_htc_setpower</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">);</span>
	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_FLUSH_RECV_CMDID</span><span class="p">);</span>

	<span class="cm">/* setup initial channel */</span>
	<span class="n">init_channel</span> <span class="o">=</span> <span class="n">ath9k_cmn_get_curchannel</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ah</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">init_channel</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Unable to reset hardware; reset status %d (freq %u MHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">,</span> <span class="n">curchan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_cmn_update_txpow</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpowlimit</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">ath9k_htc_get_curmode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">init_channel</span><span class="p">);</span>
	<span class="n">htc_mode</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_SET_MODE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">htc_mode</span><span class="p">);</span>
	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_ATH_INIT_CMDID</span><span class="p">);</span>
	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_START_RECV_CMDID</span><span class="p">);</span>

	<span class="n">ath9k_host_rx_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_update_cap_target</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
			<span class="s">&quot;Failed to update capability in target</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OP_INVALID</span><span class="p">;</span>
	<span class="n">htc_start</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_HTC_OP_TX_QUEUES_STOP</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cleanup_timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH9K_HTC_TX_CLEANUP_INTERVAL</span><span class="p">));</span>

	<span class="n">ath9k_htc_start_btcoex</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">unused</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">OP_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANY</span><span class="p">,</span> <span class="s">&quot;Device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_DISABLE_INTR_CMDID</span><span class="p">);</span>
	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_DRAIN_TXQ_ALL_CMDID</span><span class="p">);</span>
	<span class="n">WMI_CMD</span><span class="p">(</span><span class="n">WMI_STOP_RECV_CMDID</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">cleanup_timer</span><span class="p">);</span>
	<span class="n">ath9k_htc_tx_drain</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_wmi_event_drain</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Cancel all the running timers/work .. */</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fatal_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_work</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MAC80211_LEDS</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">led_work</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ath9k_htc_stop_ani</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ath9k_htc_stop_btcoex</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* Remove a monitor interface if it&#39;s present. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span><span class="p">)</span>
		<span class="n">ath9k_htc_remove_monitor_interface</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">ath9k_hw_phy_disable</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_hw_disable</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_htc_setpower</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ATH9K_PM_FULL_SLEEP</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">|=</span> <span class="n">OP_INVALID</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Driver halt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_vif</span> <span class="o">*</span><span class="n">avp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_target_vif</span> <span class="n">hvif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nvifs</span> <span class="o">&gt;=</span> <span class="n">ATH9K_HTC_MAX_VIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ibss_vif</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nvifs</span> <span class="o">&amp;&amp;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;IBSS coexistence with other modes is not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ap_vif</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ibss_vif</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ATH9K_HTC_MAX_BCN_VIF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Max. number of beaconing interfaces reached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hvif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_target_vif</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hvif</span><span class="p">.</span><span class="n">myaddr</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">hvif</span><span class="p">.</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">HTC_M_STA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">hvif</span><span class="p">.</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">HTC_M_IBSS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">hvif</span><span class="p">.</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">HTC_M_HOSTAP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Interface type %d not yet supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Index starts from zero on the target */</span>
	<span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">hvif</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_slot</span><span class="p">);</span>
	<span class="n">hvif</span><span class="p">.</span><span class="n">rtsthreshold</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="mi">2304</span><span class="p">);</span>
	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_VAP_CREATE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need a node in target to tx mgmt frames</span>
<span class="cm">	 * before association.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_add_station</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_VAP_REMOVE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hvif</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_htc_set_bssid_mask</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_slot</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nvifs</span><span class="o">++</span><span class="p">;</span>

	<span class="n">INC_VIF</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span>
		<span class="n">ath9k_htc_assign_bslot</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="n">ath9k_htc_set_opmode</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">OP_ANI_RUNNING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath9k_hw_set_tsfadjust</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ath9k_htc_start_ani</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Attach a VIF of type: %d at idx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_vif</span> <span class="o">*</span><span class="n">avp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_target_vif</span> <span class="n">hvif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hvif</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_target_vif</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hvif</span><span class="p">.</span><span class="n">myaddr</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">hvif</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_VAP_REMOVE_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to remove interface at idx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nvifs</span><span class="o">--</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif_slot</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">ath9k_htc_remove_station</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">DEC_VIF</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span>
		<span class="n">ath9k_htc_remove_bslot</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="n">ath9k_htc_set_opmode</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">ath9k_htc_set_bssid_mask</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Stop ANI only if there are no associated station interfaces.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ap_vif</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rearm_ani</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
						   <span class="n">ath9k_htc_vif_iter</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rearm_ani</span><span class="p">)</span>
			<span class="n">ath9k_htc_stop_ani</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Detach Interface at idx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">enable_radio</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">bool</span> <span class="n">idle</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_IDLE</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idle</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_idle</span><span class="p">)</span>
			<span class="n">enable_radio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_idle</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">enable_radio</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;not-idle: enabling radio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ath9k_htc_setpower</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">);</span>
			<span class="n">ath9k_htc_radio_enable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Monitor interface should be added before</span>
<span class="cm">	 * IEEE80211_CONF_CHANGE_CHANNEL is handled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_MONITOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span><span class="p">)</span>
			<span class="n">ath9k_htc_add_monitor_interface</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span><span class="p">)</span>
			<span class="n">ath9k_htc_remove_monitor_interface</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">curchan</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>

		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Set channel: %d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">curchan</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>

		<span class="n">ath9k_cmn_update_ichannel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span>
					  <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span>
					  <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel_type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_htc_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to set channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_PS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath9k_htc_setpower</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ATH9K_PM_NETWORK_SLEEP</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_work</span><span class="p">);</span>
			<span class="n">ath9k_htc_setpower</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpowlimit</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>
		<span class="n">ath9k_cmn_update_txpow</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">,</span>
				       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txpowlimit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curtxpow</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_idle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc_pm_lock</span><span class="p">);</span>

		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;idle: disabling radio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ath9k_htc_radio_disable</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SUPPORTED_FILTERS			\</span>
<span class="cp">	(FIF_PROMISC_IN_BSS |			\</span>
<span class="cp">	FIF_ALLMULTI |				\</span>
<span class="cp">	FIF_CONTROL |				\</span>
<span class="cp">	FIF_PSPOLL |				\</span>
<span class="cp">	FIF_OTHER_BSS |				\</span>
<span class="cp">	FIF_BCN_PRBRESP_PROMISC |		\</span>
<span class="cp">	FIF_PROBE_REQ |				\</span>
<span class="cp">	FIF_FCSFAIL)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">,</span>
				       <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rfilt</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">changed_flags</span> <span class="o">&amp;=</span> <span class="n">SUPPORTED_FILTERS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;=</span> <span class="n">SUPPORTED_FILTERS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;</span> <span class="n">OP_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">),</span> <span class="n">ANY</span><span class="p">,</span>
			<span class="s">&quot;Unable to configure filter on invalid state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxfilter</span> <span class="o">=</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">;</span>
	<span class="n">rfilt</span> <span class="o">=</span> <span class="n">ath9k_htc_calcrxfilter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_hw_setrxfilter</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="n">rfilt</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">),</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Set HW RX filter: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">rfilt</span><span class="p">);</span>

	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_sta_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_add_station</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ath9k_htc_init_rate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_sta_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="n">ista</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ista</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">htc_sta_drain</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">htc</span><span class="p">,</span> <span class="n">ista</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_remove_station</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">queue</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span> <span class="n">qi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">qnum</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">WME_NUM_AC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span><span class="p">));</span>

	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_aifs</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cwmin</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cwmax</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_burstTime</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">;</span>

	<span class="n">qnum</span> <span class="o">=</span> <span class="n">get_hw_qnum</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwq_map</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
		<span class="s">&quot;Configure tx [queue/hwq] [%d/%d],  aifs: %d, cw_min: %d, cw_max: %d, txop: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">queue</span><span class="p">,</span> <span class="n">qnum</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">,</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath_htc_txq_update</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">qnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;TXQ Update failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">qnum</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hwq_map</span><span class="p">[</span><span class="n">WME_AC_BE</span><span class="p">]))</span>
		    <span class="n">ath9k_htc_beaconq_config</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">htc_modparam_nohwcrypt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">||</span>
	     <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span> <span class="o">||</span>
	     <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For now, disable hw crypto for the RSN IBSS group keys. This</span>
<span class="cm">		 * could be optimized in the future to use a modified key cache</span>
<span class="cm">		 * design to support per-STA RX GTK, but until that gets</span>
<span class="cm">		 * implemented, use of software crypto for group addressed</span>
<span class="cm">		 * frames is a acceptable to allow RSN IBSS to be used.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Set HW Key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_KEY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath_key_config</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="cm">/* push IV and Michael MIC generation to stack */</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_IV</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">)</span>
				<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_MMIC</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">sw_mgmt_crypto</span> <span class="o">&amp;&amp;</span>
			    <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">)</span>
				<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_SW_MGMT</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISABLE_KEY</span>:
		<span class="n">ath_key_delete</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_set_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ath9k_hw_write_associd</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;BSSID: %pM aid: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">curaid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_bss_iter</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">curaid</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_choose_set_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_sta_assoc_vif</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_iterate_active_interfaces_atomic</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
							   <span class="n">ath9k_htc_bss_iter</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
		<span class="n">ath9k_htc_set_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;BSS Changed ASSOC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">);</span>

		<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span> <span class="o">?</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_sta_assoc_vif</span><span class="o">++</span> <span class="o">:</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_sta_assoc_vif</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath9k_htc_choose_set_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_sta_assoc_vif</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
				<span class="n">ath9k_htc_start_ani</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_sta_assoc_vif</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ath9k_htc_stop_ani</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_IBSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">common</span><span class="o">-&gt;</span><span class="n">curaid</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">ath9k_htc_set_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Beacon enabled for BSS: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="n">ath9k_htc_set_tsfadjust</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">|=</span> <span class="n">OP_ENABLE_BEACON</span><span class="p">;</span>
		<span class="n">ath9k_htc_beacon_config</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disable SWBA interrupt only if there are no</span>
<span class="cm">		 * AP/IBSS interfaces.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ap_vif</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ibss_vif</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
				<span class="s">&quot;Beacon disabled for BSS: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OP_ENABLE_BEACON</span><span class="p">;</span>
			<span class="n">ath9k_htc_beacon_config</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Reset the HW TSF for the first AP interface.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nvifs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_ap_vif</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">|=</span> <span class="n">OP_TSF_RESET</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span>
			<span class="s">&quot;Beacon interval changed for BSS: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="n">ath9k_htc_beacon_config</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_slot</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">slottime</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">slottime</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

		<span class="n">ath9k_hw_init_global_settings</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_HT</span><span class="p">)</span>
		<span class="n">ath9k_htc_update_rate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">bss_conf</span><span class="p">);</span>

	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">ath9k_htc_get_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tsf</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">tsf</span> <span class="o">=</span> <span class="n">ath9k_hw_gettsf64</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tsf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_set_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_hw_settsf64</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">,</span> <span class="n">tsf</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_reset_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_hw_reset_tsf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_ampdu_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">ieee80211_ampdu_mlme_action</span> <span class="n">action</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ssn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="n">ista</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_START</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_STOP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_START</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_htc_tx_aggr_oper</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ieee80211_start_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_STOP</span>:
		<span class="n">ath9k_htc_tx_aggr_oper</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">ieee80211_stop_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_OPERATIONAL</span>:
		<span class="n">ista</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_sta</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
		<span class="n">ista</span><span class="o">-&gt;</span><span class="n">tid_state</span><span class="p">[</span><span class="n">tid</span><span class="p">]</span> <span class="o">=</span> <span class="n">AGGR_OPERATIONAL</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">),</span> <span class="s">&quot;Unknown AMPDU action</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_sw_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">|=</span> <span class="n">OP_SCANNING</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ps_work</span><span class="p">);</span>
	<span class="n">ath9k_htc_stop_ani</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_sw_scan_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">op_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OP_SCANNING</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_lock</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_htc_vif_reconfig</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_set_rts_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_htc_set_coverage_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					 <span class="n">u8</span> <span class="n">coverage_class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_wakeup</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">coverage_class</span> <span class="o">=</span> <span class="n">coverage_class</span><span class="p">;</span>
	<span class="n">ath9k_hw_init_global_settings</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_htc_ps_restore</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Currently, this is used only for selecting the minimum rate</span>
<span class="cm"> * for management frames, rate selection for data frames remain</span>
<span class="cm"> * unaffected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_set_bitrate_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">cfg80211_bitrate_mask</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_target_rate_mask</span> <span class="n">tmask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_vif</span> <span class="o">*</span><span class="n">avp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_rsp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmask</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath9k_htc_target_rate_mask</span><span class="p">));</span>

	<span class="n">tmask</span><span class="p">.</span><span class="n">vif_index</span> <span class="o">=</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">tmask</span><span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
	<span class="n">tmask</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">legacy</span><span class="p">);</span>

	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_BITRATE_MASK_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Unable to set 2G rate mask for &quot;</span>
			<span class="s">&quot;interface at idx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmask</span><span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
	<span class="n">tmask</span><span class="p">.</span><span class="n">mask</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">legacy</span><span class="p">);</span>

	<span class="n">WMI_CMD_BUF</span><span class="p">(</span><span class="n">WMI_BITRATE_MASK_CMDID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Unable to set 5G rate mask for &quot;</span>
			<span class="s">&quot;interface at idx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">avp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Set bitrate masks: 0x%x, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">legacy</span><span class="p">,</span>
		<span class="n">mask</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">legacy</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_htc_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_low_level_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_htc_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_mib_stats</span> <span class="o">*</span><span class="n">mib_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_mibStats</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11ACKFailureCount</span> <span class="o">=</span> <span class="n">mib_stats</span><span class="o">-&gt;</span><span class="n">ackrcv_bad</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11RTSFailureCount</span> <span class="o">=</span> <span class="n">mib_stats</span><span class="o">-&gt;</span><span class="n">rts_bad</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11FCSErrorCount</span> <span class="o">=</span> <span class="n">mib_stats</span><span class="o">-&gt;</span><span class="n">fcs_bad</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">dot11RTSSuccessCount</span> <span class="o">=</span> <span class="n">mib_stats</span><span class="o">-&gt;</span><span class="n">rts_good</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">ath9k_htc_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span>                 <span class="o">=</span> <span class="n">ath9k_htc_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>              <span class="o">=</span> <span class="n">ath9k_htc_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>               <span class="o">=</span> <span class="n">ath9k_htc_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span>      <span class="o">=</span> <span class="n">ath9k_htc_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span>   <span class="o">=</span> <span class="n">ath9k_htc_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span>             <span class="o">=</span> <span class="n">ath9k_htc_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span>   <span class="o">=</span> <span class="n">ath9k_htc_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_add</span>            <span class="o">=</span> <span class="n">ath9k_htc_sta_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_remove</span>         <span class="o">=</span> <span class="n">ath9k_htc_sta_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conf_tx</span>            <span class="o">=</span> <span class="n">ath9k_htc_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span>   <span class="o">=</span> <span class="n">ath9k_htc_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_key</span>            <span class="o">=</span> <span class="n">ath9k_htc_set_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tsf</span>            <span class="o">=</span> <span class="n">ath9k_htc_get_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tsf</span>            <span class="o">=</span> <span class="n">ath9k_htc_set_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_tsf</span>          <span class="o">=</span> <span class="n">ath9k_htc_reset_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ampdu_action</span>       <span class="o">=</span> <span class="n">ath9k_htc_ampdu_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sw_scan_start</span>      <span class="o">=</span> <span class="n">ath9k_htc_sw_scan_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sw_scan_complete</span>   <span class="o">=</span> <span class="n">ath9k_htc_sw_scan_complete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rts_threshold</span>  <span class="o">=</span> <span class="n">ath9k_htc_set_rts_threshold</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rfkill_poll</span>        <span class="o">=</span> <span class="n">ath9k_htc_rfkill_poll_state</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_coverage_class</span> <span class="o">=</span> <span class="n">ath9k_htc_set_coverage_class</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_bitrate_mask</span>   <span class="o">=</span> <span class="n">ath9k_htc_set_bitrate_mask</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span>	    <span class="o">=</span> <span class="n">ath9k_htc_get_stats</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
