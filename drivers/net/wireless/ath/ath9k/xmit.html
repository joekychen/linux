<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › xmit.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>xmit.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &quot;ath9k.h&quot;</span>
<span class="cp">#include &quot;ar9003_mac.h&quot;</span>

<span class="cp">#define BITS_PER_BYTE           8</span>
<span class="cp">#define OFDM_PLCP_BITS          22</span>
<span class="cp">#define HT_RC_2_STREAMS(_rc)    ((((_rc) &amp; 0x78) &gt;&gt; 3) + 1)</span>
<span class="cp">#define L_STF                   8</span>
<span class="cp">#define L_LTF                   8</span>
<span class="cp">#define L_SIG                   4</span>
<span class="cp">#define HT_SIG                  8</span>
<span class="cp">#define HT_STF                  4</span>
<span class="cp">#define HT_LTF(_ns)             (4 * (_ns))</span>
<span class="cp">#define SYMBOL_TIME(_ns)        ((_ns) &lt;&lt; 2) </span><span class="cm">/* ns * 4 us */</span><span class="cp"></span>
<span class="cp">#define SYMBOL_TIME_HALFGI(_ns) (((_ns) * 18 + 4) / 5)  </span><span class="cm">/* ns * 3.6 us */</span><span class="cp"></span>
<span class="cp">#define NUM_SYMBOLS_PER_USEC(_usec) (_usec &gt;&gt; 2)</span>
<span class="cp">#define NUM_SYMBOLS_PER_USEC_HALFGI(_usec) (((_usec*5)-4)/18)</span>


<span class="k">static</span> <span class="n">u16</span> <span class="n">bits_per_symbol</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 20MHz 40MHz */</span>
	<span class="p">{</span>    <span class="mi">26</span><span class="p">,</span>   <span class="mi">54</span> <span class="p">},</span>     <span class="cm">/*  0: BPSK */</span>
	<span class="p">{</span>    <span class="mi">52</span><span class="p">,</span>  <span class="mi">108</span> <span class="p">},</span>     <span class="cm">/*  1: QPSK 1/2 */</span>
	<span class="p">{</span>    <span class="mi">78</span><span class="p">,</span>  <span class="mi">162</span> <span class="p">},</span>     <span class="cm">/*  2: QPSK 3/4 */</span>
	<span class="p">{</span>   <span class="mi">104</span><span class="p">,</span>  <span class="mi">216</span> <span class="p">},</span>     <span class="cm">/*  3: 16-QAM 1/2 */</span>
	<span class="p">{</span>   <span class="mi">156</span><span class="p">,</span>  <span class="mi">324</span> <span class="p">},</span>     <span class="cm">/*  4: 16-QAM 3/4 */</span>
	<span class="p">{</span>   <span class="mi">208</span><span class="p">,</span>  <span class="mi">432</span> <span class="p">},</span>     <span class="cm">/*  5: 64-QAM 2/3 */</span>
	<span class="p">{</span>   <span class="mi">234</span><span class="p">,</span>  <span class="mi">486</span> <span class="p">},</span>     <span class="cm">/*  6: 64-QAM 3/4 */</span>
	<span class="p">{</span>   <span class="mi">260</span><span class="p">,</span>  <span class="mi">540</span> <span class="p">},</span>     <span class="cm">/*  7: 64-QAM 5/6 */</span>
<span class="p">};</span>

<span class="cp">#define IS_HT_RATE(_rate)     ((_rate) &amp; 0x80)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ath_tx_send_normal</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ath_tx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">tx_flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ath_tx_complete_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">bf_q</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txok</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ath_tx_txqaddbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="n">bool</span> <span class="n">internal</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ath_tx_rc_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nframes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbad</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">txok</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ath_tx_update_baw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">seqno</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">ath_tx_setup_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					   <span class="n">bool</span> <span class="n">dequeue</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">MCS_HT20</span><span class="p">,</span>
	<span class="n">MCS_HT20_SGI</span><span class="p">,</span>
	<span class="n">MCS_HT40</span><span class="p">,</span>
	<span class="n">MCS_HT40_SGI</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ath_max_4ms_framelen</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">MCS_HT20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">3212</span><span class="p">,</span>  <span class="mi">6432</span><span class="p">,</span>  <span class="mi">9648</span><span class="p">,</span>  <span class="mi">12864</span><span class="p">,</span>  <span class="mi">19300</span><span class="p">,</span>  <span class="mi">25736</span><span class="p">,</span>  <span class="mi">28952</span><span class="p">,</span>  <span class="mi">32172</span><span class="p">,</span>
		<span class="mi">6424</span><span class="p">,</span>  <span class="mi">12852</span><span class="p">,</span> <span class="mi">19280</span><span class="p">,</span> <span class="mi">25708</span><span class="p">,</span>  <span class="mi">38568</span><span class="p">,</span>  <span class="mi">51424</span><span class="p">,</span>  <span class="mi">57852</span><span class="p">,</span>  <span class="mi">64280</span><span class="p">,</span>
		<span class="mi">9628</span><span class="p">,</span>  <span class="mi">19260</span><span class="p">,</span> <span class="mi">28896</span><span class="p">,</span> <span class="mi">38528</span><span class="p">,</span>  <span class="mi">57792</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
		<span class="mi">12828</span><span class="p">,</span> <span class="mi">25656</span><span class="p">,</span> <span class="mi">38488</span><span class="p">,</span> <span class="mi">51320</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">MCS_HT20_SGI</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">3572</span><span class="p">,</span>  <span class="mi">7144</span><span class="p">,</span>  <span class="mi">10720</span><span class="p">,</span>  <span class="mi">14296</span><span class="p">,</span>  <span class="mi">21444</span><span class="p">,</span>  <span class="mi">28596</span><span class="p">,</span>  <span class="mi">32172</span><span class="p">,</span>  <span class="mi">35744</span><span class="p">,</span>
		<span class="mi">7140</span><span class="p">,</span>  <span class="mi">14284</span><span class="p">,</span> <span class="mi">21428</span><span class="p">,</span>  <span class="mi">28568</span><span class="p">,</span>  <span class="mi">42856</span><span class="p">,</span>  <span class="mi">57144</span><span class="p">,</span>  <span class="mi">64288</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
		<span class="mi">10700</span><span class="p">,</span> <span class="mi">21408</span><span class="p">,</span> <span class="mi">32112</span><span class="p">,</span>  <span class="mi">42816</span><span class="p">,</span>  <span class="mi">64228</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
		<span class="mi">14256</span><span class="p">,</span> <span class="mi">28516</span><span class="p">,</span> <span class="mi">42780</span><span class="p">,</span>  <span class="mi">57040</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">MCS_HT40</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">6680</span><span class="p">,</span>  <span class="mi">13360</span><span class="p">,</span>  <span class="mi">20044</span><span class="p">,</span>  <span class="mi">26724</span><span class="p">,</span>  <span class="mi">40092</span><span class="p">,</span>  <span class="mi">53456</span><span class="p">,</span>  <span class="mi">60140</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
		<span class="mi">13348</span><span class="p">,</span> <span class="mi">26700</span><span class="p">,</span>  <span class="mi">40052</span><span class="p">,</span>  <span class="mi">53400</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
		<span class="mi">20004</span><span class="p">,</span> <span class="mi">40008</span><span class="p">,</span>  <span class="mi">60016</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
		<span class="mi">26644</span><span class="p">,</span> <span class="mi">53292</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">[</span><span class="n">MCS_HT40_SGI</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">7420</span><span class="p">,</span>  <span class="mi">14844</span><span class="p">,</span>  <span class="mi">22272</span><span class="p">,</span>  <span class="mi">29696</span><span class="p">,</span>  <span class="mi">44544</span><span class="p">,</span>  <span class="mi">59396</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
		<span class="mi">14832</span><span class="p">,</span> <span class="mi">29668</span><span class="p">,</span>  <span class="mi">44504</span><span class="p">,</span>  <span class="mi">59340</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
		<span class="mi">22232</span><span class="p">,</span> <span class="mi">44464</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
		<span class="mi">29616</span><span class="p">,</span> <span class="mi">59232</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>  <span class="mi">65532</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*********************/</span>
<span class="cm">/* Aggregation logic */</span>
<span class="cm">/*********************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_txq_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
	<span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_txq_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_txq_unlock_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="p">);</span>
	<span class="n">skb_queue_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">complete_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">q</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="p">)))</span>
		<span class="n">ieee80211_tx_status</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_queue_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_atx_ac</span> <span class="o">*</span><span class="n">ac</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">sched</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tid</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">tid_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">sched</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ac</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_acq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_resume_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">);</span>

	<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="n">tid</span><span class="o">-&gt;</span><span class="n">paused</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">ath_tx_queue_tid</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">ath_txq_schedule</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
<span class="nl">unlock:</span>
	<span class="n">ath_txq_unlock_complete</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="nf">get_frame_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_frame_info</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_send_bar</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">seqno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_send_bar</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">tidno</span><span class="p">,</span>
			   <span class="n">seqno</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_SEQ_SEQ_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_flush_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">bf_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sendbar</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ts</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">bf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bf</span> <span class="o">&amp;&amp;</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
			<span class="n">ath_tx_update_baw</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">seqno</span><span class="p">);</span>
			<span class="n">ath_tx_complete_buf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">sendbar</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ath_tx_send_normal</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_head</span> <span class="o">==</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AGGR_ADDBA_COMPLETE</span><span class="p">;</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AGGR_CLEANUP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sendbar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_txq_unlock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
		<span class="n">ath_send_bar</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span><span class="p">);</span>
		<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_update_baw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">seqno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">cindex</span><span class="p">;</span>

	<span class="n">index</span>  <span class="o">=</span> <span class="n">ATH_BA_INDEX</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>
	<span class="n">cindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_head</span> <span class="o">+</span> <span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATH_TID_MAX_BUFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">cindex</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_head</span> <span class="o">!=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_tail</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_head</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">INCR</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span><span class="p">,</span> <span class="n">IEEE80211_SEQ_MAX</span><span class="p">);</span>
		<span class="n">INCR</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_head</span><span class="p">,</span> <span class="n">ATH_TID_MAX_BUFS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">bar_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tid</span><span class="o">-&gt;</span><span class="n">bar_index</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_addto_baw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">seqno</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">cindex</span><span class="p">;</span>

	<span class="n">index</span>  <span class="o">=</span> <span class="n">ATH_BA_INDEX</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>
	<span class="n">cindex</span> <span class="o">=</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_head</span> <span class="o">+</span> <span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATH_TID_MAX_BUFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">cindex</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_tail</span> <span class="o">-</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_head</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">ATH_TID_MAX_BUFS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_tail</span> <span class="o">=</span> <span class="n">cindex</span><span class="p">;</span>
		<span class="n">INCR</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_tail</span><span class="p">,</span> <span class="n">ATH_TID_MAX_BUFS</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TODO: For frame(s) that are in the retry state, we will reuse the</span>
<span class="cm"> * sequence number(s) without setting the retry bit. The</span>
<span class="cm"> * alternative is to give up on these and BAR the receiver&#39;s window</span>
<span class="cm"> * forward.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tid_drain</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">)</span>

<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">bf_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ts</span><span class="p">));</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">bf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_tx_complete</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">ATH_TX_ERROR</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">)</span>
			<span class="n">ath_tx_update_baw</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">seqno</span><span class="p">);</span>

		<span class="n">ath_tx_complete_buf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_next</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span><span class="p">;</span>
	<span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_tail</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_head</span><span class="p">;</span>
	<span class="n">tid</span><span class="o">-&gt;</span><span class="n">bar_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_set_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">bf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">;</span>

	<span class="n">TX_STAT_INC</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">a_retries</span><span class="p">);</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_RETRY</span><span class="p">);</span>
	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="nf">ath_tx_get_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuflock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuflock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuflock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">bf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_return_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuflock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuf</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuflock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="o">*</span> <span class="nf">ath_clone_txbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">tbf</span><span class="p">;</span>

	<span class="n">tbf</span> <span class="o">=</span> <span class="n">ath_tx_get_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">tbf</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ATH_TXBUF_RESET</span><span class="p">(</span><span class="n">tbf</span><span class="p">);</span>

	<span class="n">tbf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
	<span class="n">tbf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tbf</span><span class="o">-&gt;</span><span class="n">bf_desc</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_desc</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">tx_desc_len</span><span class="p">);</span>
	<span class="n">tbf</span><span class="o">-&gt;</span><span class="n">bf_state</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tbf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_count_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span>
			        <span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txok</span><span class="p">,</span>
			        <span class="kt">int</span> <span class="o">*</span><span class="n">nframes</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nbad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq_st</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ba</span><span class="p">[</span><span class="n">WME_BA_BMP_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ba_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isaggr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">nbad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">nframes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">isaggr</span> <span class="o">=</span> <span class="n">bf_isaggr</span><span class="p">(</span><span class="n">bf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isaggr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_st</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_seqnum</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ba_low</span><span class="p">,</span> <span class="n">WME_BA_BMP_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">);</span>
		<span class="n">ba_index</span> <span class="o">=</span> <span class="n">ATH_BA_INDEX</span><span class="p">(</span><span class="n">seq_st</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">seqno</span><span class="p">);</span>

		<span class="p">(</span><span class="o">*</span><span class="n">nframes</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txok</span> <span class="o">||</span> <span class="p">(</span><span class="n">isaggr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ATH_BA_ISSET</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">ba_index</span><span class="p">)))</span>
			<span class="p">(</span><span class="o">*</span><span class="n">nbad</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

		<span class="n">bf</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_complete_aggr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">bf_q</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txok</span><span class="p">,</span> <span class="n">bool</span> <span class="n">retry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf_next</span><span class="p">,</span> <span class="o">*</span><span class="n">bf_last</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_lastbf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">bf_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">bf_pending</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq_st</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">acked_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">txfail_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">seq_first</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ba</span><span class="p">[</span><span class="n">WME_BA_BMP_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">isaggr</span><span class="p">,</span> <span class="n">txfail</span><span class="p">,</span> <span class="n">txpending</span><span class="p">,</span> <span class="n">sendbar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">needreset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nbad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rc_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="n">rates</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nframes</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tidno</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">flush</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_TX_FLUSH</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bar_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rates</span><span class="p">));</span>

	<span class="n">retries</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_longretry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_rateindex</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">retries</span> <span class="o">+=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="n">ieee80211_find_sta_by_ifaddr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">bf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bf_next</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_next</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_stale</span> <span class="o">||</span> <span class="n">bf_next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>

			<span class="n">ath_tx_complete_buf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">bf</span> <span class="o">=</span> <span class="n">bf_next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">tidno</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>
	<span class="n">tid</span> <span class="o">=</span> <span class="n">ATH_AN_2_TID</span><span class="p">(</span><span class="n">an</span><span class="p">,</span> <span class="n">tidno</span><span class="p">);</span>
	<span class="n">seq_first</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The hardware occasionally sends a tx status for the wrong TID.</span>
<span class="cm">	 * In this case, the BA status cannot be considered valid and all</span>
<span class="cm">	 * subframes need to be retransmitted</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tidno</span> <span class="o">!=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">)</span>
		<span class="n">txok</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">isaggr</span> <span class="o">=</span> <span class="n">bf_isaggr</span><span class="p">(</span><span class="n">bf</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">WME_BA_BMP_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isaggr</span> <span class="o">&amp;&amp;</span> <span class="n">txok</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_TX_BA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_st</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_seqnum</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ba_low</span><span class="p">,</span> <span class="n">WME_BA_BMP_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * AR5416 can become deaf/mute when BA</span>
<span class="cm">			 * issue happens. Chip needs to be reset.</span>
<span class="cm">			 * But AP code may have sychronization issues</span>
<span class="cm">			 * when perform internal reset in this routine.</span>
<span class="cm">			 * Only enable reset in STA mode for now.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
				<span class="n">needreset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_pending</span><span class="p">);</span>

	<span class="n">ath_tx_count_frames</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">txok</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nframes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nbad</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">seqno</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">seqno</span><span class="p">;</span>

		<span class="n">txfail</span> <span class="o">=</span> <span class="n">txpending</span> <span class="o">=</span> <span class="n">sendbar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bf_next</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_next</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
		<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ATH_BA_ISSET</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">ATH_BA_INDEX</span><span class="p">(</span><span class="n">seq_st</span><span class="p">,</span> <span class="n">seqno</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* transmit completion, subframe is</span>
<span class="cm">			 * acked by block ack */</span>
			<span class="n">acked_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isaggr</span> <span class="o">&amp;&amp;</span> <span class="n">txok</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* transmit completion */</span>
			<span class="n">acked_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">AGGR_CLEANUP</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">retry</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * cleanup in progress, just fail</span>
<span class="cm">			 * the un-acked sub-frames</span>
<span class="cm">			 */</span>
			<span class="n">txfail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flush</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txpending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">retries</span> <span class="o">&lt;</span> <span class="n">ATH_MAX_SW_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txok</span> <span class="o">||</span> <span class="o">!</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">sleeping</span><span class="p">)</span>
				<span class="n">ath_tx_set_retry</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">,</span>
						 <span class="n">retries</span><span class="p">);</span>

			<span class="n">txpending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">txfail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">txfail_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">bar_index</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">bar_index</span><span class="p">,</span>
				<span class="n">ATH_BA_INDEX</span><span class="p">(</span><span class="n">seq_first</span><span class="p">,</span> <span class="n">seqno</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Make sure the last desc is reclaimed if it</span>
<span class="cm">		 * not a holding desc.</span>
<span class="cm">		 */</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">bf_next</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">bf_last</span><span class="o">-&gt;</span><span class="n">bf_stale</span><span class="p">)</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txpending</span> <span class="o">||</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">AGGR_CLEANUP</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * complete the acked-ones/xretried ones; update</span>
<span class="cm">			 * block-ack window</span>
<span class="cm">			 */</span>
			<span class="n">ath_tx_update_baw</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rc_update</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">acked_cnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">txfail_cnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">,</span> <span class="n">rates</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rates</span><span class="p">));</span>
				<span class="n">ath_tx_rc_status</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">nframes</span><span class="p">,</span> <span class="n">nbad</span><span class="p">,</span> <span class="n">txok</span><span class="p">);</span>
				<span class="n">rc_update</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ath_tx_complete_buf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span>
				<span class="o">!</span><span class="n">txfail</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* retry the un-acked ones */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_next</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">bf_last</span><span class="o">-&gt;</span><span class="n">bf_stale</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">tbf</span><span class="p">;</span>

				<span class="n">tbf</span> <span class="o">=</span> <span class="n">ath_clone_txbuf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf_last</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * Update tx baw and complete the</span>
<span class="cm">				 * frame with failed status if we</span>
<span class="cm">				 * run out of tx buf.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbf</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ath_tx_update_baw</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>

					<span class="n">ath_tx_complete_buf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">bar_index</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">bar_index</span><span class="p">,</span>
						<span class="n">ATH_BA_INDEX</span><span class="p">(</span><span class="n">seq_first</span><span class="p">,</span> <span class="n">seqno</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">fi</span><span class="o">-&gt;</span><span class="n">bf</span> <span class="o">=</span> <span class="n">tbf</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Put this buffer to the temporary pending</span>
<span class="cm">			 * queue to retain ordering</span>
<span class="cm">			 */</span>
			<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_pending</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">bf</span> <span class="o">=</span> <span class="n">bf_next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* prepend un-acked frames to the beginning of the pending frame queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_pending</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">sleeping</span><span class="p">)</span>
			<span class="n">ieee80211_sta_set_buffered</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">tidno</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="n">skb_queue_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_pending</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">sleeping</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_tx_queue_tid</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_TXERR_FILT</span><span class="p">)</span>
				<span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">clear_ps_filter</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bar_index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">bar_seq</span> <span class="o">=</span> <span class="n">ATH_BA_INDEX2SEQ</span><span class="p">(</span><span class="n">seq_first</span><span class="p">,</span> <span class="n">bar_index</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">BAW_WITHIN</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_size</span><span class="p">,</span> <span class="n">bar_seq</span><span class="p">))</span>
			<span class="n">tid</span><span class="o">-&gt;</span><span class="n">bar_index</span> <span class="o">=</span> <span class="n">ATH_BA_INDEX</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span><span class="p">,</span> <span class="n">bar_seq</span><span class="p">);</span>

		<span class="n">ath_txq_unlock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
		<span class="n">ath_send_bar</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">ATH_BA_INDEX2SEQ</span><span class="p">(</span><span class="n">seq_first</span><span class="p">,</span> <span class="n">bar_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">AGGR_CLEANUP</span><span class="p">)</span>
		<span class="n">ath_tx_flush_tid</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="n">rcu_read_unlock</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">needreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RESET_STAT_INC</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">RESET_TYPE_TX_ERROR</span><span class="p">);</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_reset_work</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath_lookup_legacy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rates</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
	<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">rates</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">||</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ath_lookup_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rates</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_4ms_framelen</span><span class="p">,</span> <span class="n">frmlen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">aggr_limit</span><span class="p">,</span> <span class="n">bt_aggr_limit</span><span class="p">,</span> <span class="n">legacy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
	<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">rates</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find the lowest frame length among the rate series that will have a</span>
<span class="cm">	 * 4ms transmit duration.</span>
<span class="cm">	 * TODO - TXOP limit needs to be considered.</span>
<span class="cm">	 */</span>
	<span class="n">max_4ms_framelen</span> <span class="o">=</span> <span class="n">ATH_AMPDU_LIMIT_MAX</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">modeidx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">legacy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span>
			<span class="n">modeidx</span> <span class="o">=</span> <span class="n">MCS_HT40</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">modeidx</span> <span class="o">=</span> <span class="n">MCS_HT20</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">)</span>
			<span class="n">modeidx</span><span class="o">++</span><span class="p">;</span>

		<span class="n">frmlen</span> <span class="o">=</span> <span class="n">ath_max_4ms_framelen</span><span class="p">[</span><span class="n">modeidx</span><span class="p">][</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">max_4ms_framelen</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_4ms_framelen</span><span class="p">,</span> <span class="n">frmlen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * limit aggregate size by the minimum rate if rate selected is</span>
<span class="cm">	 * not a probe rate, if rate selected is a probe rate then</span>
<span class="cm">	 * avoid aggregation of this packet.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_RATE_CTRL_PROBE</span> <span class="o">||</span> <span class="n">legacy</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">aggr_limit</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_4ms_framelen</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">ATH_AMPDU_LIMIT_MAX</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Override the default aggregation limit for BTCOEX.</span>
<span class="cm">	 */</span>
	<span class="n">bt_aggr_limit</span> <span class="o">=</span> <span class="n">ath9k_btcoex_aggr_limit</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">max_4ms_framelen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bt_aggr_limit</span><span class="p">)</span>
		<span class="n">aggr_limit</span> <span class="o">=</span> <span class="n">bt_aggr_limit</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * h/w can accept aggregates up to 16 bit lengths (65535).</span>
<span class="cm">	 * The IE, however can hold up to 65536, which shows up here</span>
<span class="cm">	 * as zero. Ignore 65536 since we  are constrained by hw.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">maxampdu</span><span class="p">)</span>
		<span class="n">aggr_limit</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">aggr_limit</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">maxampdu</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">aggr_limit</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns the number of delimiters to be added to</span>
<span class="cm"> * meet the minimum required mpdudensity.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath_compute_num_delims</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">frmlen</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="n">first_subfrm</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define FIRST_DESC_NDELIMS 60</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">nsymbits</span><span class="p">,</span> <span class="n">nsymbols</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">minlen</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">,</span> <span class="n">rix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">streams</span><span class="p">,</span> <span class="n">half_gi</span><span class="p">,</span> <span class="n">ndelim</span><span class="p">,</span> <span class="n">mindelim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">);</span>

	<span class="cm">/* Select standard number of delimiters based on frame length alone */</span>
	<span class="n">ndelim</span> <span class="o">=</span> <span class="n">ATH_AGGR_GET_NDELIM</span><span class="p">(</span><span class="n">frmlen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If encryption enabled, hardware requires some more padding between</span>
<span class="cm">	 * subframes.</span>
<span class="cm">	 * TODO - this could be improved to be dependent on the rate.</span>
<span class="cm">	 *      The hardware can keep up at lower rates, but not higher rates</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">keyix</span> <span class="o">!=</span> <span class="n">ATH9K_TXKEYIX_INVALID</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">))</span>
		<span class="n">ndelim</span> <span class="o">+=</span> <span class="n">ATH_AGGR_ENCRYPTDELIM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add delimiter when using RTS/CTS with aggregation</span>
<span class="cm">	 * and non enterprise AR9003 card</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first_subfrm</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">AR_SREV_9580_10_OR_LATER</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">ent_mode</span> <span class="o">&amp;</span> <span class="n">AR_ENT_OTP_MIN_PKT_SIZE_DISABLE</span><span class="p">))</span>
		<span class="n">ndelim</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">ndelim</span><span class="p">,</span> <span class="n">FIRST_DESC_NDELIMS</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Convert desired mpdu density from microeconds to bytes based</span>
<span class="cm">	 * on highest rate in rate series (i.e. first rate) to determine</span>
<span class="cm">	 * required minimum length for subframe. Take into account</span>
<span class="cm">	 * whether high rate is 20 or 40Mhz and half or full GI.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If there is no mpdu density restriction, no further calculation</span>
<span class="cm">	 * is needed.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">mpdudensity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ndelim</span><span class="p">;</span>

	<span class="n">rix</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">half_gi</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">half_gi</span><span class="p">)</span>
		<span class="n">nsymbols</span> <span class="o">=</span> <span class="n">NUM_SYMBOLS_PER_USEC_HALFGI</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">mpdudensity</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">nsymbols</span> <span class="o">=</span> <span class="n">NUM_SYMBOLS_PER_USEC</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">mpdudensity</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nsymbols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nsymbols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">streams</span> <span class="o">=</span> <span class="n">HT_RC_2_STREAMS</span><span class="p">(</span><span class="n">rix</span><span class="p">);</span>
	<span class="n">nsymbits</span> <span class="o">=</span> <span class="n">bits_per_symbol</span><span class="p">[</span><span class="n">rix</span> <span class="o">%</span> <span class="mi">8</span><span class="p">][</span><span class="n">width</span><span class="p">]</span> <span class="o">*</span> <span class="n">streams</span><span class="p">;</span>
	<span class="n">minlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">nsymbols</span> <span class="o">*</span> <span class="n">nsymbits</span><span class="p">)</span> <span class="o">/</span> <span class="n">BITS_PER_BYTE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frmlen</span> <span class="o">&lt;</span> <span class="n">minlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mindelim</span> <span class="o">=</span> <span class="p">(</span><span class="n">minlen</span> <span class="o">-</span> <span class="n">frmlen</span><span class="p">)</span> <span class="o">/</span> <span class="n">ATH_AGGR_DELIM_SZ</span><span class="p">;</span>
		<span class="n">ndelim</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">mindelim</span><span class="p">,</span> <span class="n">ndelim</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ndelim</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">ATH_AGGR_STATUS</span> <span class="nf">ath_tx_form_aggr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">bf_q</span><span class="p">,</span>
					     <span class="kt">int</span> <span class="o">*</span><span class="n">aggr_len</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define PADBYTES(_len) ((4 - ((_len) % 4)) % 4)</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="o">*</span><span class="n">bf_first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">bf_prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nframes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ndelim</span><span class="p">,</span> <span class="n">prev_al</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">aggr_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">al</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bpad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">al_delta</span><span class="p">,</span> <span class="n">h_baw</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ATH_AGGR_STATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ATH_AGGR_DONE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seqno</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">);</span>
		<span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">bf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">bf</span><span class="p">)</span>
			<span class="n">bf</span> <span class="o">=</span> <span class="n">ath_tx_setup_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bf_type</span> <span class="o">=</span> <span class="n">BUF_AMPDU</span> <span class="o">|</span> <span class="n">BUF_AGGR</span><span class="p">;</span>
		<span class="n">seqno</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">seqno</span><span class="p">;</span>

		<span class="cm">/* do not step over block-ack window */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">BAW_WITHIN</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_size</span><span class="p">,</span> <span class="n">seqno</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ATH_AGGR_BAW_CLOSED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">bar_index</span> <span class="o">&gt;</span> <span class="n">ATH_BA_INDEX</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span><span class="p">,</span> <span class="n">seqno</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="n">ts</span> <span class="o">=</span> <span class="p">{};</span>
			<span class="k">struct</span> <span class="n">list_head</span> <span class="n">bf_head</span><span class="p">;</span>

			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
			<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">);</span>
			<span class="n">ath_tx_update_baw</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>
			<span class="n">ath_tx_complete_buf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf_first</span><span class="p">)</span>
			<span class="n">bf_first</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">aggr_limit</span> <span class="o">=</span> <span class="n">ath_lookup_rate</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
			<span class="n">rl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* do not exceed aggregation limit */</span>
		<span class="n">al_delta</span> <span class="o">=</span> <span class="n">ATH_AGGR_DELIM_SZ</span> <span class="o">+</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nframes</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">aggr_limit</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">al</span> <span class="o">+</span> <span class="n">bpad</span> <span class="o">+</span> <span class="n">al_delta</span> <span class="o">+</span> <span class="n">prev_al</span><span class="p">))</span> <span class="o">||</span>
		     <span class="n">ath_lookup_legacy</span><span class="p">(</span><span class="n">bf</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ATH_AGGR_LIMITED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nframes</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_RATE_CTRL_PROBE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* do not exceed subframe limit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nframes</span> <span class="o">&gt;=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">h_baw</span><span class="p">,</span> <span class="n">ATH_AMPDU_SUBFRAME_DEFAULT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ATH_AGGR_LIMITED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* add padding for previous frame to aggregation length */</span>
		<span class="n">al</span> <span class="o">+=</span> <span class="n">bpad</span> <span class="o">+</span> <span class="n">al_delta</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Get the delimiters needed to meet the MPDU</span>
<span class="cm">		 * density for this node.</span>
<span class="cm">		 */</span>
		<span class="n">ndelim</span> <span class="o">=</span> <span class="n">ath_compute_num_delims</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">bf_first</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">,</span>
						<span class="o">!</span><span class="n">nframes</span><span class="p">);</span>
		<span class="n">bpad</span> <span class="o">=</span> <span class="n">PADBYTES</span><span class="p">(</span><span class="n">al_delta</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">ndelim</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">nframes</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* link buffers of this frame to the aggregate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">retries</span><span class="p">)</span>
			<span class="n">ath_tx_addto_baw</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">seqno</span><span class="p">);</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">ndelim</span> <span class="o">=</span> <span class="n">ndelim</span><span class="p">;</span>

		<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">bf_q</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bf_prev</span><span class="p">)</span>
			<span class="n">bf_prev</span><span class="o">-&gt;</span><span class="n">bf_next</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>

		<span class="n">bf_prev</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">));</span>

	<span class="o">*</span><span class="n">aggr_len</span> <span class="o">=</span> <span class="n">al</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="cp">#undef PADBYTES</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rix - rate index</span>
<span class="cm"> * pktlen - total bytes (delims + data + fcs + pads + pad delims)</span>
<span class="cm"> * width  - 0 for 20 MHz, 1 for 40 MHz</span>
<span class="cm"> * half_gi - to use 4us v/s 3.6 us for symbol time</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">ath_pkt_duration</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rix</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pktlen</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">half_gi</span><span class="p">,</span> <span class="n">bool</span> <span class="n">shortPreamble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nbits</span><span class="p">,</span> <span class="n">nsymbits</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">nsymbols</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">streams</span><span class="p">;</span>

	<span class="cm">/* find number of symbols: PLCP + data */</span>
	<span class="n">streams</span> <span class="o">=</span> <span class="n">HT_RC_2_STREAMS</span><span class="p">(</span><span class="n">rix</span><span class="p">);</span>
	<span class="n">nbits</span> <span class="o">=</span> <span class="p">(</span><span class="n">pktlen</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">OFDM_PLCP_BITS</span><span class="p">;</span>
	<span class="n">nsymbits</span> <span class="o">=</span> <span class="n">bits_per_symbol</span><span class="p">[</span><span class="n">rix</span> <span class="o">%</span> <span class="mi">8</span><span class="p">][</span><span class="n">width</span><span class="p">]</span> <span class="o">*</span> <span class="n">streams</span><span class="p">;</span>
	<span class="n">nsymbols</span> <span class="o">=</span> <span class="p">(</span><span class="n">nbits</span> <span class="o">+</span> <span class="n">nsymbits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">nsymbits</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">half_gi</span><span class="p">)</span>
		<span class="n">duration</span> <span class="o">=</span> <span class="n">SYMBOL_TIME</span><span class="p">(</span><span class="n">nsymbols</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">duration</span> <span class="o">=</span> <span class="n">SYMBOL_TIME_HALFGI</span><span class="p">(</span><span class="n">nsymbols</span><span class="p">);</span>

	<span class="cm">/* addup duration for legacy/ht training and signal fields */</span>
	<span class="n">duration</span> <span class="o">+=</span> <span class="n">L_STF</span> <span class="o">+</span> <span class="n">L_LTF</span> <span class="o">+</span> <span class="n">L_SIG</span> <span class="o">+</span> <span class="n">HT_SIG</span> <span class="o">+</span> <span class="n">HT_STF</span> <span class="o">+</span> <span class="n">HT_LTF</span><span class="p">(</span><span class="n">streams</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">duration</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_buf_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ath_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">rates</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
	<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">rates</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* set dur_update_en for l-sig computation except for PS-Poll frames */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">dur_update</span> <span class="o">=</span> <span class="o">!</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rtscts_rate</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">rtscts_rate</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">is_40</span><span class="p">,</span> <span class="n">is_sgi</span><span class="p">,</span> <span class="n">is_sp</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">phy</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">||</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">rix</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Tries</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">;</span>

		    <span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RateFlags</span> <span class="o">|=</span> <span class="n">ATH9K_RATESERIES_RTS_CTS</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_TXDESC_RTSENA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RateFlags</span> <span class="o">|=</span> <span class="n">ATH9K_RATESERIES_RTS_CTS</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_TXDESC_CTSENA</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RateFlags</span> <span class="o">|=</span> <span class="n">ATH9K_RATESERIES_2040</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RateFlags</span> <span class="o">|=</span> <span class="n">ATH9K_RATESERIES_HALFGI</span><span class="p">;</span>

		<span class="n">is_sgi</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">);</span>
		<span class="n">is_40</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">);</span>
		<span class="n">is_sp</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_SHORT_PREAMBLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* MCS rates */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Rate</span> <span class="o">=</span> <span class="n">rix</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ChSel</span> <span class="o">=</span> <span class="n">ath_txchainmask_reduction</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span>
					<span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Rate</span><span class="p">);</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PktDuration</span> <span class="o">=</span> <span class="n">ath_pkt_duration</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				 <span class="n">is_40</span><span class="p">,</span> <span class="n">is_sgi</span><span class="p">,</span> <span class="n">is_sp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rix</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_STBC</span><span class="p">))</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RateFlags</span> <span class="o">|=</span> <span class="n">ATH9K_RATESERIES_STBC</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* legacy rates */</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">].</span><span class="n">bitrates</span><span class="p">[</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_RATE_ERP_G</span><span class="p">))</span>
			<span class="n">phy</span> <span class="o">=</span> <span class="n">WLAN_RC_PHY_CCK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phy</span> <span class="o">=</span> <span class="n">WLAN_RC_PHY_OFDM</span><span class="p">;</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Rate</span> <span class="o">=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value_short</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_SHORT_PREAMBLE</span><span class="p">)</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Rate</span> <span class="o">|=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value_short</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">is_sp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bfs_paprd</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ChSel</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ChSel</span> <span class="o">=</span> <span class="n">ath_txchainmask_reduction</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span>
					<span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">Rate</span><span class="p">);</span>

		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">PktDuration</span> <span class="o">=</span> <span class="n">ath9k_hw_computetxtime</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span>
			<span class="n">phy</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rix</span><span class="p">,</span> <span class="n">is_sp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* For AR5416 - RTS cannot be followed by a frame larger than 8K */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bf_isaggr</span><span class="p">(</span><span class="n">bf</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rts_aggr_limit</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_TXDESC_RTSENA</span><span class="p">;</span>

	<span class="cm">/* ATH9K_TXDESC_RTSENA and ATH9K_TXDESC_CTSENA are mutually exclusive. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ATH9K_TXDESC_RTSENA</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_TXDESC_CTSENA</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">ath9k_pkt_type</span> <span class="nf">get_hw_packet_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ath9k_pkt_type</span> <span class="n">htype</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">htype</span> <span class="o">=</span> <span class="n">ATH9K_PKT_TYPE_BEACON</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">htype</span> <span class="o">=</span> <span class="n">ATH9K_PKT_TYPE_PROBE_RESP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_atim</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">htype</span> <span class="o">=</span> <span class="n">ATH9K_PKT_TYPE_ATIM</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">htype</span> <span class="o">=</span> <span class="n">ATH9K_PKT_TYPE_PSPOLL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">htype</span> <span class="o">=</span> <span class="n">ATH9K_PKT_TYPE_NORMAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">htype</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_fill_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf_first</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_tx_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">aggr</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bf_type</span> <span class="o">&amp;</span> <span class="n">BUF_AGGR</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="n">info</span><span class="p">.</span><span class="n">is_first</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">is_last</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">txpower</span> <span class="o">=</span> <span class="n">MAX_RATE_POWER</span><span class="p">;</span>
	<span class="n">info</span><span class="p">.</span><span class="n">qcu</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">;</span>

	<span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ATH9K_TXDESC_INTREQ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)</span>
		<span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_TXDESC_NOACK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_LDPC</span><span class="p">)</span>
		<span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_TXDESC_LDPC</span><span class="p">;</span>

	<span class="n">ath_buf_set_rate</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_CLEAR_PS_FILT</span><span class="p">)</span>
		<span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">ATH9K_TXDESC_CLRDMASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bfs_paprd</span><span class="p">)</span>
		<span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bfs_paprd</span> <span class="o">&lt;&lt;</span> <span class="n">ATH9K_TXDESC_PAPRD_S</span><span class="p">;</span>


	<span class="k">while</span> <span class="p">(</span><span class="n">bf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">info</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">get_hw_packet_type</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_next</span><span class="p">)</span>
			<span class="n">info</span><span class="p">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_next</span><span class="o">-&gt;</span><span class="n">bf_daddr</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="p">.</span><span class="n">link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">info</span><span class="p">.</span><span class="n">buf_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">buf_len</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">pkt_len</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">keyix</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">keyix</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">keytype</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">keytype</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">aggr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bf</span> <span class="o">==</span> <span class="n">bf_first</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">aggr</span> <span class="o">=</span> <span class="n">AGGR_BUF_FIRST</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_next</span><span class="p">)</span>
				<span class="n">info</span><span class="p">.</span><span class="n">aggr</span> <span class="o">=</span> <span class="n">AGGR_BUF_LAST</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">info</span><span class="p">.</span><span class="n">aggr</span> <span class="o">=</span> <span class="n">AGGR_BUF_MIDDLE</span><span class="p">;</span>

			<span class="n">info</span><span class="p">.</span><span class="n">ndelim</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">ndelim</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">aggr_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ath9k_hw_set_txdesc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_desc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_sched_aggr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ATH_AGGR_STATUS</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">bf_q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aggr_len</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_q</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ath_tx_form_aggr</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aggr_len</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * no frames picked up to be aggregated;</span>
<span class="cm">		 * block-ack window is not open.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_q</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_lastbf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">bf_q</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">clear_ps_filter</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">clear_ps_filter</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_CLEAR_PS_FILT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_CTL_CLEAR_PS_FILT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* if only one frame, send as non-aggregate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bf</span> <span class="o">==</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_lastbf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">aggr_len</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">;</span>
			<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bf_type</span> <span class="o">=</span> <span class="n">BUF_AMPDU</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TX_STAT_INC</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">a_aggr</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ath_tx_fill_desc</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">aggr_len</span><span class="p">);</span>
		<span class="n">ath_tx_txqaddbuf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_q</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_ampdu_depth</span> <span class="o">&lt;</span> <span class="n">ATH_AGGR_MIN_QDEPTH</span> <span class="o">&amp;&amp;</span>
		 <span class="n">status</span> <span class="o">!=</span> <span class="n">ATH_AGGR_BAW_CLOSED</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath_tx_aggr_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
		      <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ssn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">txtid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span><span class="p">;</span>

	<span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">txtid</span> <span class="o">=</span> <span class="n">ATH_AN_2_TID</span><span class="p">(</span><span class="n">an</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txtid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AGGR_CLEANUP</span> <span class="o">|</span> <span class="n">AGGR_ADDBA_COMPLETE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">txtid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">AGGR_ADDBA_PROGRESS</span><span class="p">;</span>
	<span class="n">txtid</span><span class="o">-&gt;</span><span class="n">paused</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ssn</span> <span class="o">=</span> <span class="n">txtid</span><span class="o">-&gt;</span><span class="n">seq_start</span> <span class="o">=</span> <span class="n">txtid</span><span class="o">-&gt;</span><span class="n">seq_next</span><span class="p">;</span>
	<span class="n">txtid</span><span class="o">-&gt;</span><span class="n">bar_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">txtid</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txtid</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">));</span>
	<span class="n">txtid</span><span class="o">-&gt;</span><span class="n">baw_head</span> <span class="o">=</span> <span class="n">txtid</span><span class="o">-&gt;</span><span class="n">baw_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_tx_aggr_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">txtid</span> <span class="o">=</span> <span class="n">ATH_AN_2_TID</span><span class="p">(</span><span class="n">an</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">txtid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txtid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">AGGR_CLEANUP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">txtid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">AGGR_ADDBA_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txtid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AGGR_ADDBA_PROGRESS</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="n">txtid</span><span class="o">-&gt;</span><span class="n">paused</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If frames are still being transmitted for this TID, they will be</span>
<span class="cm">	 * cleaned up during tx completion. To prevent race conditions, this</span>
<span class="cm">	 * TID can only be reused after all in-progress subframes have been</span>
<span class="cm">	 * completed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txtid</span><span class="o">-&gt;</span><span class="n">baw_head</span> <span class="o">!=</span> <span class="n">txtid</span><span class="o">-&gt;</span><span class="n">baw_tail</span><span class="p">)</span>
		<span class="n">txtid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">AGGR_CLEANUP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">txtid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AGGR_ADDBA_COMPLETE</span><span class="p">;</span>

	<span class="n">ath_tx_flush_tid</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txtid</span><span class="p">);</span>
	<span class="n">ath_txq_unlock_complete</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_tx_aggr_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_atx_ac</span> <span class="o">*</span><span class="n">ac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">buffered</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tidno</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tidno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">[</span><span class="n">tidno</span><span class="p">];</span>
	     <span class="n">tidno</span> <span class="o">&lt;</span> <span class="n">WME_NUM_TID</span><span class="p">;</span> <span class="n">tidno</span><span class="o">++</span><span class="p">,</span> <span class="n">tid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">sched</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ac</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">;</span>
		<span class="n">txq</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">;</span>

		<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>

		<span class="n">buffered</span> <span class="o">=</span> <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">);</span>

		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">sched</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ath_txq_unlock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>

		<span class="n">ieee80211_sta_set_buffered</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tidno</span><span class="p">,</span> <span class="n">buffered</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_tx_aggr_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_atx_ac</span> <span class="o">*</span><span class="n">ac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tidno</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tidno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">[</span><span class="n">tidno</span><span class="p">];</span>
	     <span class="n">tidno</span> <span class="o">&lt;</span> <span class="n">WME_NUM_TID</span><span class="p">;</span> <span class="n">tidno</span><span class="o">++</span><span class="p">,</span> <span class="n">tid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ac</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">;</span>
		<span class="n">txq</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">;</span>

		<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">clear_ps_filter</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_tx_queue_tid</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
			<span class="n">ath_txq_schedule</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ath_txq_unlock_complete</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_tx_aggr_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">txtid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span><span class="p">;</span>

	<span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="n">txtid</span> <span class="o">=</span> <span class="n">ATH_AN_2_TID</span><span class="p">(</span><span class="n">an</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="n">txtid</span><span class="o">-&gt;</span><span class="n">baw_size</span> <span class="o">=</span> <span class="n">IEEE80211_MIN_AMPDU_BUF</span> <span class="o">&lt;&lt;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span><span class="p">;</span>
	<span class="n">txtid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">AGGR_ADDBA_COMPLETE</span><span class="p">;</span>
	<span class="n">txtid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AGGR_ADDBA_PROGRESS</span><span class="p">;</span>
	<span class="n">ath_tx_resume_tid</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txtid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************/</span>
<span class="cm">/* Queue Management */</span>
<span class="cm">/********************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_txq_drain_pending_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_atx_ac</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span> <span class="o">*</span><span class="n">ac_tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span> <span class="o">*</span><span class="n">tid_tmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">ac_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_acq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">tid</span><span class="p">,</span> <span class="n">tid_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">tid_q</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">tid</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">ath_tid_drain</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="nf">ath_txq_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qtype</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span> <span class="n">qi</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">subtype_txq_to_hwq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">WME_AC_BE</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATH_TXQ_AC_BE</span><span class="p">,</span>
		<span class="p">[</span><span class="n">WME_AC_BK</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATH_TXQ_AC_BK</span><span class="p">,</span>
		<span class="p">[</span><span class="n">WME_AC_VI</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATH_TXQ_AC_VI</span><span class="p">,</span>
		<span class="p">[</span><span class="n">WME_AC_VO</span><span class="p">]</span> <span class="o">=</span> <span class="n">ATH_TXQ_AC_VO</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">axq_qnum</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qi</span><span class="p">));</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_subtype</span> <span class="o">=</span> <span class="n">subtype_txq_to_hwq</span><span class="p">[</span><span class="n">subtype</span><span class="p">];</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_aifs</span> <span class="o">=</span> <span class="n">ATH9K_TXQ_USEDEFAULT</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cwmin</span> <span class="o">=</span> <span class="n">ATH9K_TXQ_USEDEFAULT</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cwmax</span> <span class="o">=</span> <span class="n">ATH9K_TXQ_USEDEFAULT</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_physCompBuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable interrupts only for EOL and DESC conditions.</span>
<span class="cm">	 * We mark tx descriptors to receive a DESC interrupt</span>
<span class="cm">	 * when a tx queue gets deep; otherwise waiting for the</span>
<span class="cm">	 * EOL to reap descriptors.  Note that this is done to</span>
<span class="cm">	 * reduce interrupt load and this only defers reaping</span>
<span class="cm">	 * descriptors, never transmitting frames.  Aside from</span>
<span class="cm">	 * reducing interrupts this also permits more concurrency.</span>
<span class="cm">	 * The only potential downside is if the tx queue backs</span>
<span class="cm">	 * up in which case the top half of the kernel may backup</span>
<span class="cm">	 * due to a lack of tx descriptors.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The UAPSD queue is an exception, since we take a desc-</span>
<span class="cm">	 * based intr on the EOSP frames.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">qi</span><span class="p">.</span><span class="n">tqi_qflags</span> <span class="o">=</span> <span class="n">TXQ_FLAG_TXINT_ENABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qtype</span> <span class="o">==</span> <span class="n">ATH9K_TX_QUEUE_UAPSD</span><span class="p">)</span>
			<span class="n">qi</span><span class="p">.</span><span class="n">tqi_qflags</span> <span class="o">=</span> <span class="n">TXQ_FLAG_TXDESCINT_ENABLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">qi</span><span class="p">.</span><span class="n">tqi_qflags</span> <span class="o">=</span> <span class="n">TXQ_FLAG_TXEOLINT_ENABLE</span> <span class="o">|</span>
					<span class="n">TXQ_FLAG_TXDESCINT_ENABLE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">axq_qnum</span> <span class="o">=</span> <span class="n">ath9k_hw_setuptxqueue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">qtype</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">axq_qnum</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * NB: don&#39;t print a message, this happens</span>
<span class="cm">		 * normally on parts with too few tx queues</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ATH_TXQ_SETUP</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">axq_qnum</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">axq_qnum</span><span class="p">];</span>

		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span> <span class="o">=</span> <span class="n">axq_qnum</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">mac80211_qnum</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">complete_q</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_q</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_acq</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_lock</span><span class="p">);</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_ampdu_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_tx_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txqsetup</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">axq_qnum</span><span class="p">;</span>

		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_headidx</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_tailidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH_TXFIFO_DEPTH</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_fifo</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">axq_qnum</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath_txq_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">qnum</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span> <span class="o">*</span><span class="n">qinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span> <span class="n">qi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qnum</span> <span class="o">==</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">beaconq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX: for beacon queue, we just save the parameter.</span>
<span class="cm">		 * It will be picked up by ath_beaconq_config when</span>
<span class="cm">		 * it&#39;s necessary.</span>
<span class="cm">		 */</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">beacon_qi</span> <span class="o">=</span> <span class="o">*</span><span class="n">qinfo</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">qnum</span><span class="p">].</span><span class="n">axq_qnum</span> <span class="o">!=</span> <span class="n">qnum</span><span class="p">);</span>

	<span class="n">ath9k_hw_get_txq_props</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">qnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_aifs</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_aifs</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cwmin</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_cwmin</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_cwmax</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_cwmax</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_burstTime</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_burstTime</span><span class="p">;</span>
	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_readyTime</span> <span class="o">=</span> <span class="n">qinfo</span><span class="o">-&gt;</span><span class="n">tqi_readyTime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_set_txq_props</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">qnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">),</span>
			<span class="s">&quot;Unable to update hardware queue %u!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qnum</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath9k_hw_resettxqueue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">qnum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath_cabq_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_tx_queue_info</span> <span class="n">qi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_beacon_config</span> <span class="o">*</span><span class="n">cur_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">cur_beacon_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">qnum</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">cabq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">;</span>

	<span class="n">ath9k_hw_get_txq_props</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="n">qnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Ensure the readytime % is within the bounds.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cabqReadytime</span> <span class="o">&lt;</span> <span class="n">ATH9K_READY_TIME_LO_BOUND</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cabqReadytime</span> <span class="o">=</span> <span class="n">ATH9K_READY_TIME_LO_BOUND</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cabqReadytime</span> <span class="o">&gt;</span> <span class="n">ATH9K_READY_TIME_HI_BOUND</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cabqReadytime</span> <span class="o">=</span> <span class="n">ATH9K_READY_TIME_HI_BOUND</span><span class="p">;</span>

	<span class="n">qi</span><span class="p">.</span><span class="n">tqi_readyTime</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_conf</span><span class="o">-&gt;</span><span class="n">beacon_interval</span> <span class="o">*</span>
			    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cabqReadytime</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">ath_txq_update</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">qnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qi</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">bf_is_ampdu_not_probing</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">bf_isampdu</span><span class="p">(</span><span class="n">bf</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_RATE_CTRL_PROBE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_drain_txq_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="n">bool</span> <span class="n">retry_tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="o">*</span><span class="n">lastbf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">bf_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="n">ts</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ts</span><span class="p">));</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">ts_status</span> <span class="o">=</span> <span class="n">ATH9K_TX_FLUSH</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_stale</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

			<span class="n">ath_tx_return_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lastbf</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_lastbf</span><span class="p">;</span>
		<span class="n">list_cut_position</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lastbf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_depth</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bf_is_ampdu_not_probing</span><span class="p">(</span><span class="n">bf</span><span class="p">))</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_ampdu_depth</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bf_isampdu</span><span class="p">(</span><span class="n">bf</span><span class="p">))</span>
			<span class="n">ath_tx_complete_aggr</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="n">retry_tx</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ath_tx_complete_buf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Drain a given TX queue (could be Beacon or Data)</span>
<span class="cm"> *</span>
<span class="cm"> * This assumes output has been stopped and</span>
<span class="cm"> * we do not need to block ath_tx_tasklet.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ath_draintxq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="n">bool</span> <span class="n">retry_tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_tailidx</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_fifo</span><span class="p">[</span><span class="n">idx</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">ath_drain_txq_list</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_fifo</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
					   <span class="n">retry_tx</span><span class="p">);</span>

			<span class="n">INCR</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">ATH_TXFIFO_DEPTH</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_tailidx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_tx_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ath_drain_txq_list</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_q</span><span class="p">,</span> <span class="n">retry_tx</span><span class="p">);</span>

	<span class="cm">/* flush any pending frames if aggregation is enabled */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_HT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">retry_tx</span><span class="p">)</span>
		<span class="n">ath_txq_drain_pending_buffers</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>

	<span class="n">ath_txq_unlock_complete</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ath_drain_all_txq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">retry_tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">npend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_flags</span> <span class="o">&amp;</span> <span class="n">SC_OP_INVALID</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">ath9k_hw_abort_tx_dma</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/* Check if any queue remains active */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ATH_TXQ_SETUP</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_hw_numtxpending</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">axq_qnum</span><span class="p">))</span>
			<span class="n">npend</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">npend</span><span class="p">)</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Failed to stop TX DMA, queues=0x%03x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">npend</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ATH_TXQ_SETUP</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The caller will resume queues with ieee80211_wake_queues.</span>
<span class="cm">		 * Mark the queue as not stopped to prevent ath_tx_complete</span>
<span class="cm">		 * from waking the queue too early.</span>
<span class="cm">		 */</span>
		<span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ath_draintxq</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">retry_tx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">npend</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_tx_cleanupq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath9k_hw_releasetxqueue</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txqsetup</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* For each axq_acq entry, for each tid, try to schedule packets</span>
<span class="cm"> * for transmit until ampdu_depth has reached min Q depth.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ath_txq_schedule</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_atx_ac</span> <span class="o">*</span><span class="n">ac</span><span class="p">,</span> <span class="o">*</span><span class="n">ac_tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">last_ac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span> <span class="o">*</span><span class="n">last_tid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_reset_work</span><span class="p">)</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_acq</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_ampdu_depth</span> <span class="o">&gt;=</span> <span class="n">ATH_AGGR_MIN_QDEPTH</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ac</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_acq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_ac</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">last_ac</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_acq</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_ac</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">ac_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_acq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last_tid</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">tid_q</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_tid</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">tid_q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tid</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">tid_q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_tid</span><span class="p">,</span>
					       <span class="n">list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">tid</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">paused</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ath_tx_sched_aggr</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * add tid to round-robin queue if more frames</span>
<span class="cm">			 * are pending for the tid</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">))</span>
				<span class="n">ath_tx_queue_tid</span><span class="p">(</span><span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">==</span> <span class="n">last_tid</span> <span class="o">||</span>
			    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_ampdu_depth</span> <span class="o">&gt;=</span> <span class="n">ATH_AGGR_MIN_QDEPTH</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">tid_q</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">sched</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ac</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_acq</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span> <span class="o">==</span> <span class="n">last_ac</span> <span class="o">||</span>
		    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_ampdu_depth</span> <span class="o">&gt;=</span> <span class="n">ATH_AGGR_MIN_QDEPTH</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/***********/</span>
<span class="cm">/* TX, DMA */</span>
<span class="cm">/***********/</span>

<span class="cm">/*</span>
<span class="cm"> * Insert a chain of ath_buf (descriptors) on a txq and</span>
<span class="cm"> * assume the descriptors are already chained together by caller.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_txqaddbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="n">bool</span> <span class="n">internal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="o">*</span><span class="n">bf_last</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">puttxbuf</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">edma</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Insert the frame on the outbound list and</span>
<span class="cm">	 * pass it on to the hardware.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">edma</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">);</span>
	<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">bf_last</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">QUEUE</span><span class="p">,</span> <span class="s">&quot;qnum: %d, txq depth: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_depth</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edma</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_fifo</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_headidx</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_fifo</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_headidx</span><span class="p">]);</span>
		<span class="n">INCR</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_headidx</span><span class="p">,</span> <span class="n">ATH_TXFIFO_DEPTH</span><span class="p">);</span>
		<span class="n">puttxbuf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="n">head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_q</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_link</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath9k_hw_set_desc_link</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_link</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_daddr</span><span class="p">);</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;link[%u] (%p)=%llx (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_link</span><span class="p">,</span>
				<span class="n">ito64</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_daddr</span><span class="p">),</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_desc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edma</span><span class="p">)</span>
			<span class="n">puttxbuf</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_link</span> <span class="o">=</span> <span class="n">bf_last</span><span class="o">-&gt;</span><span class="n">bf_desc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">puttxbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TX_STAT_INC</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">puttxbuf</span><span class="p">);</span>
		<span class="n">ath9k_hw_puttxbuf</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_daddr</span><span class="p">);</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;TXDP[%u] = %llx (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">ito64</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_daddr</span><span class="p">),</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_desc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">edma</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TX_STAT_INC</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">txstart</span><span class="p">);</span>
		<span class="n">ath9k_hw_txstart</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">internal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_depth</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bf_is_ampdu_not_probing</span><span class="p">(</span><span class="n">bf</span><span class="p">))</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_ampdu_depth</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_send_ampdu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_tx_control</span> <span class="o">*</span><span class="n">txctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">bf_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do not queue to h/w when any of the following conditions is true:</span>
<span class="cm">	 * - there are pending frames in software queue</span>
<span class="cm">	 * - the TID is currently paused for ADDBA/BAR request</span>
<span class="cm">	 * - seqno is not within block-ack window</span>
<span class="cm">	 * - h/w queue depth exceeds low water mark</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">)</span> <span class="o">||</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">paused</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">BAW_WITHIN</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_size</span><span class="p">,</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_next</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">txctl</span><span class="o">-&gt;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_ampdu_depth</span> <span class="o">&gt;=</span> <span class="n">ATH_AGGR_MIN_QDEPTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Add this frame to software queue for scheduling later</span>
<span class="cm">		 * for aggregation.</span>
<span class="cm">		 */</span>
		<span class="n">TX_STAT_INC</span><span class="p">(</span><span class="n">txctl</span><span class="o">-&gt;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">a_queued_sw</span><span class="p">);</span>
		<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txctl</span><span class="o">-&gt;</span><span class="n">an</span> <span class="o">||</span> <span class="o">!</span><span class="n">txctl</span><span class="o">-&gt;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">sleeping</span><span class="p">)</span>
			<span class="n">ath_tx_queue_tid</span><span class="p">(</span><span class="n">txctl</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bf</span> <span class="o">=</span> <span class="n">ath_tx_setup_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txctl</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bf_type</span> <span class="o">=</span> <span class="n">BUF_AMPDU</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>

	<span class="cm">/* Add sub-frame to BAW */</span>
	<span class="n">ath_tx_addto_baw</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">seqno</span><span class="p">);</span>

	<span class="cm">/* Queue to h/w without aggregation */</span>
	<span class="n">TX_STAT_INC</span><span class="p">(</span><span class="n">txctl</span><span class="o">-&gt;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">a_queued_hw</span><span class="p">);</span>
	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_lastbf</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">ath_tx_fill_desc</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txctl</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">);</span>
	<span class="n">ath_tx_txqaddbuf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txctl</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_send_normal</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">bf_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>

	<span class="n">bf</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">bf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">)</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">ath_tx_setup_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bf_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_lastbf</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>
	<span class="n">ath_tx_fill_desc</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">);</span>
	<span class="n">ath_tx_txqaddbuf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">TX_STAT_INC</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">queued</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_frame_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">framelen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">hw_key</span> <span class="o">=</span> <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ath9k_key_type</span> <span class="n">keytype</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">short_preamble</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We check if Short Preamble is needed for the CTS rate by</span>
<span class="cm">	 * checking the BSS&#39;s global flag.</span>
<span class="cm">	 * But for the rate series, IEEE80211_TX_RC_USE_SHORT_PREAMBLE is used.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">)</span>
		<span class="n">short_preamble</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">ieee80211_get_rts_cts_rate</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">tx_info</span><span class="p">);</span>
	<span class="n">keytype</span> <span class="o">=</span> <span class="n">ath9k_cmn_get_hw_crypto_keytype</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fi</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw_key</span><span class="p">)</span>
		<span class="n">fi</span><span class="o">-&gt;</span><span class="n">keyix</span> <span class="o">=</span> <span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">an</span> <span class="o">&amp;&amp;</span> <span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">an</span><span class="o">-&gt;</span><span class="n">ps_key</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fi</span><span class="o">-&gt;</span><span class="n">keyix</span> <span class="o">=</span> <span class="n">an</span><span class="o">-&gt;</span><span class="n">ps_key</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fi</span><span class="o">-&gt;</span><span class="n">keyix</span> <span class="o">=</span> <span class="n">ATH9K_TXKEYIX_INVALID</span><span class="p">;</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">keytype</span> <span class="o">=</span> <span class="n">keytype</span><span class="p">;</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">=</span> <span class="n">framelen</span><span class="p">;</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">rtscts_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">short_preamble</span><span class="p">)</span>
		<span class="n">fi</span><span class="o">-&gt;</span><span class="n">rtscts_rate</span> <span class="o">|=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value_short</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">ath_txchainmask_reduction</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chainmask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_APM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">channelFlags</span> <span class="o">&amp;</span> <span class="n">CHANNEL_5GHZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">chainmask</span> <span class="o">==</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mh">0x90</span><span class="p">))</span>
		<span class="k">return</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">chainmask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Assign a descriptor (and sequence number if necessary,</span>
<span class="cm"> * and map buffer for DMA. Frees skb on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="nf">ath_tx_setup_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					   <span class="n">bool</span> <span class="n">dequeue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_frame_info</span> <span class="o">*</span><span class="n">fi</span> <span class="o">=</span> <span class="n">get_frame_info</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fragno</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seqno</span><span class="p">;</span>

	<span class="n">bf</span> <span class="o">=</span> <span class="n">ath_tx_get_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;TX buffers are full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ATH_TXBUF_RESET</span><span class="p">(</span><span class="n">bf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fragno</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_FRAG</span><span class="p">;</span>
		<span class="n">seqno</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_next</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_next</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_SEQ_SEQ_SHIFT</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fragno</span><span class="p">)</span>
			<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fragno</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
			<span class="n">INCR</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_next</span><span class="p">,</span> <span class="n">IEEE80211_SEQ_MAX</span><span class="p">);</span>

		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">seqno</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">dma_mapping_error</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">),</span>
			<span class="s">&quot;dma_mapping_error() on TX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ath_tx_return_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">bf</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bf</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dequeue</span><span class="p">)</span>
		<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME: tx power */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_start_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ath_tx_control</span> <span class="o">*</span><span class="n">txctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tidno</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_HT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">txctl</span><span class="o">-&gt;</span><span class="n">an</span> <span class="o">&amp;&amp;</span>
		<span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tidno</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span>
			<span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">ATH_AN_2_TID</span><span class="p">(</span><span class="n">txctl</span><span class="o">-&gt;</span><span class="n">an</span><span class="p">,</span> <span class="n">tidno</span><span class="p">);</span>

		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">!=</span> <span class="n">txctl</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Try aggregation if it&#39;s a unicast data frame</span>
<span class="cm">		 * and the destination is HT capable.</span>
<span class="cm">		 */</span>
		<span class="n">ath_tx_send_ampdu</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">txctl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">ath_tx_setup_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txctl</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bfs_paprd</span> <span class="o">=</span> <span class="n">txctl</span><span class="o">-&gt;</span><span class="n">paprd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txctl</span><span class="o">-&gt;</span><span class="n">paprd</span><span class="p">)</span>
			<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bfs_paprd_timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

		<span class="n">ath_tx_send_normal</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txctl</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Upon failure caller should free skb */</span>
<span class="kt">int</span> <span class="nf">ath_tx_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">ath_tx_control</span> <span class="o">*</span><span class="n">txctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">vif</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="n">txctl</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">padpos</span><span class="p">,</span> <span class="n">padsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frmlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q</span><span class="p">;</span>

	<span class="cm">/* NOTE:  sta can be NULL according to net/mac80211.h */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">txctl</span><span class="o">-&gt;</span><span class="n">an</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">)</span>
		<span class="n">frmlen</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * As a temporary workaround, assign seq# here; this will likely need</span>
<span class="cm">	 * to be cleaned up to work better with Beacon transmission and virtual</span>
<span class="cm">	 * BSSes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_ASSIGN_SEQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_FIRST_FRAGMENT</span><span class="p">)</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">seq_no</span> <span class="o">+=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_SCTL_FRAG</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">seq_no</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Add the padding after the header if this is not already done */</span>
	<span class="n">padpos</span> <span class="o">=</span> <span class="n">ath9k_cmn_padpos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">padsize</span> <span class="o">=</span> <span class="n">padpos</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padsize</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">padpos</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">padsize</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">padsize</span><span class="p">);</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">padpos</span><span class="p">);</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	            <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP_VLAN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_CTL_CLEAR_PS_FILT</span><span class="p">;</span>

	<span class="n">setup_frame_info</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">frmlen</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point, the vif, hw_key and sta pointers in the tx control</span>
<span class="cm">	 * info are no longer valid (overwritten by the ath_frame_info data.</span>
<span class="cm">	 */</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span> <span class="o">==</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq_map</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="o">++</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">pending_frames</span> <span class="o">&gt;</span> <span class="n">ATH_MAX_QDEPTH</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">stopped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_stop_queue</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath_tx_start_dma</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">txctl</span><span class="p">);</span>

	<span class="n">ath_txq_unlock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************/</span>
<span class="cm">/* TX Completion */</span>
<span class="cm">/*****************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">tx_flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span> <span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">q</span><span class="p">,</span> <span class="n">padpos</span><span class="p">,</span> <span class="n">padsize</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;TX complete: skb: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tx_flags</span> <span class="o">&amp;</span> <span class="n">ATH_TX_ERROR</span><span class="p">))</span>
		<span class="cm">/* Frame was ACKed */</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>

	<span class="n">padpos</span> <span class="o">=</span> <span class="n">ath9k_cmn_padpos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">padsize</span> <span class="o">=</span> <span class="n">padpos</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padsize</span> <span class="o">&amp;&amp;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">&gt;</span><span class="n">padpos</span><span class="o">+</span><span class="n">padsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Remove MAC header padding before giving the frame back to</span>
<span class="cm">		 * mac80211.</span>
<span class="cm">		 */</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">padsize</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">padpos</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">padsize</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">PS_WAIT_FOR_TX_ACK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PS_WAIT_FOR_TX_ACK</span><span class="p">;</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">PS</span><span class="p">,</span>
			<span class="s">&quot;Going back to sleep after having received TX status (0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PS_WAIT_FOR_BEACON</span> <span class="o">|</span>
					<span class="n">PS_WAIT_FOR_CAB</span> <span class="o">|</span>
					<span class="n">PS_WAIT_FOR_PSPOLL_DATA</span> <span class="o">|</span>
					<span class="n">PS_WAIT_FOR_TX_ACK</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">q</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span> <span class="o">==</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq_map</span><span class="p">[</span><span class="n">q</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">--</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">pending_frames</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">pending_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">&amp;&amp;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">pending_frames</span> <span class="o">&lt;</span> <span class="n">ATH_MAX_QDEPTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee80211_wake_queue</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">stopped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">complete_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_complete_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">bf_q</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txok</span><span class="p">)</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">ATH_TX_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_TXERR_FILT</span><span class="p">)</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_TX_FILTERED</span><span class="p">;</span>

	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_buf_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bfs_paprd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
				<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_state</span><span class="p">.</span><span class="n">bfs_paprd_timestamp</span> <span class="o">+</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH_PAPRD_TIMEOUT</span><span class="p">)))</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">paprd_complete</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath_debug_stat_tx</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">tx_flags</span><span class="p">);</span>
		<span class="n">ath_tx_complete</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tx_flags</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* At this point, skb (bf-&gt;bf_mpdu) is consumed...make sure we don&#39;t</span>
<span class="cm">	 * accidentally reference it later.</span>
<span class="cm">	 */</span>
	<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Return the list of ath_buf of this mpdu to free queue</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="n">bf_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuf</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuflock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_rc_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nframes</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbad</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">txok</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_mpdu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">tx_info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">tx_rateindex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txok</span><span class="p">)</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ack_signal</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_rssi</span><span class="p">;</span>

	<span class="n">tx_rateindex</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_rateindex</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">tx_rateindex</span> <span class="o">&gt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_AMPDU</span><span class="p">;</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">nbad</span> <span class="o">&gt;</span> <span class="n">nframes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span> <span class="o">=</span> <span class="n">nframes</span><span class="p">;</span>
	<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span> <span class="o">=</span> <span class="n">nframes</span> <span class="o">-</span> <span class="n">nbad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_TXERR_FILT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If an underrun error is seen assume it as an excessive</span>
<span class="cm">		 * retry only if max frame trigger level has been reached</span>
<span class="cm">		 * (2 KB for single stream, and 4 KB for dual stream).</span>
<span class="cm">		 * Adjust the long retry as if the frame was tried</span>
<span class="cm">		 * hw-&gt;max_rate_tries times to affect how rate control updates</span>
<span class="cm">		 * PER for the failed rate.</span>
<span class="cm">		 * In case of congestion on the bus penalizing this type of</span>
<span class="cm">		 * underruns should help hardware actually transmit new frames</span>
<span class="cm">		 * successfully by eventually preferring slower rates.</span>
<span class="cm">		 * This itself should also alleviate congestion on the bus.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ATH9K_TX_DATA_UNDERRUN</span> <span class="o">|</span>
		                             <span class="n">ATH9K_TX_DELIM_UNDERRUN</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_trig_level</span> <span class="o">&gt;=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">max_txtrig_level</span><span class="p">)</span>
			<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">tx_rateindex</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rate_tries</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">tx_rateindex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">tx_rateindex</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_longretry</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_process_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="o">*</span><span class="n">ts</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">bf_head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">txok</span><span class="p">;</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_depth</span><span class="o">--</span><span class="p">;</span>
	<span class="n">txok</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_TXERR_MASK</span><span class="p">);</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_tx_inprogress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bf_is_ampdu_not_probing</span><span class="p">(</span><span class="n">bf</span><span class="p">))</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_ampdu_depth</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf_isampdu</span><span class="p">(</span><span class="n">bf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_tx_rc_status</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">txok</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="n">txok</span><span class="p">);</span>
		<span class="n">ath_tx_complete_buf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">bf_head</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">txok</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ath_tx_complete_aggr</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">bf_head</span><span class="p">,</span> <span class="n">ts</span><span class="p">,</span> <span class="n">txok</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_HT</span><span class="p">)</span>
		<span class="n">ath_txq_schedule</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_processq</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="o">*</span><span class="n">lastbf</span><span class="p">,</span> <span class="o">*</span><span class="n">bf_held</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">bf_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_desc</span> <span class="o">*</span><span class="n">ds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="n">ts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">QUEUE</span><span class="p">,</span> <span class="s">&quot;tx queue %d (%x), link %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">ath9k_hw_gettxbuf</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">),</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_link</span><span class="p">);</span>

	<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_reset_work</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_q</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_HT</span><span class="p">)</span>
				<span class="n">ath_txq_schedule</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * There is a race condition that a BH gets scheduled</span>
<span class="cm">		 * after sw writes TxE and before hw re-load the last</span>
<span class="cm">		 * descriptor to get the newly chained one.</span>
<span class="cm">		 * Software must keep the last DONE descriptor as a</span>
<span class="cm">		 * holding descriptor - software does so by marking</span>
<span class="cm">		 * it with the STALE flag.</span>
<span class="cm">		 */</span>
		<span class="n">bf_held</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_stale</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bf_held</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_is_last</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_held</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_q</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">bf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">bf_held</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span>
					<span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">lastbf</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_lastbf</span><span class="p">;</span>
		<span class="n">ds</span> <span class="o">=</span> <span class="n">lastbf</span><span class="o">-&gt;</span><span class="n">bf_desc</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ts</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath9k_hw_txprocdesc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">TX_STAT_INC</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_qnum</span><span class="p">,</span> <span class="n">txprocdesc</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Remove ath_buf&#39;s of the same transmit unit from txq,</span>
<span class="cm">		 * however leave the last descriptor back as the holding</span>
<span class="cm">		 * descriptor for hw.</span>
<span class="cm">		 */</span>
		<span class="n">lastbf</span><span class="o">-&gt;</span><span class="n">bf_stale</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_is_singular</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lastbf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span>
			<span class="n">list_cut_position</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_q</span><span class="p">,</span> <span class="n">lastbf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bf_held</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_held</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">ath_tx_return_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">bf_held</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ath_tx_process_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ath_txq_unlock_complete</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_complete_poll_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_softc</span><span class="p">,</span>
			<span class="n">tx_complete_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">needreset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ATH9K_DEBUGFS</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx_complete_poll_work_seen</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ATH_TXQ_SETUP</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_depth</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_tx_inprogress</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">needreset</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
					<span class="n">ath_txq_unlock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_tx_inprogress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">ath_txq_unlock_complete</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">needreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">),</span> <span class="n">RESET</span><span class="p">,</span>
			<span class="s">&quot;tx hung, resetting the chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">RESET_STAT_INC</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">RESET_TYPE_TX_HANG</span><span class="p">);</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_reset_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx_complete_work</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ATH_TX_COMPLETE_POLL_INT</span><span class="p">));</span>
<span class="p">}</span>



<span class="kt">void</span> <span class="nf">ath_tx_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qcumask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ATH9K_NUM_TX_QUEUES</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">intr_txqs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ATH_TXQ_SETUP</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qcumask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="n">ath_tx_processq</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_tx_edma_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_tx_status</span> <span class="n">ts</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="o">*</span><span class="n">lastbf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">bf_head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_reset_work</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ath9k_hw_txprocdesc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;Error processing tx status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Process beacon completions separately */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">qid</span> <span class="o">==</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">beaconq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">tx_processed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">tx_last</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">ts_status</span> <span class="o">&amp;</span> <span class="n">ATH9K_TXERR_MASK</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">qid</span><span class="p">];</span>

		<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_fifo</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_tailidx</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">ath_txq_unlock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_fifo</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_tailidx</span><span class="p">],</span>
				      <span class="k">struct</span> <span class="n">ath_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">lastbf</span> <span class="o">=</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_lastbf</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
		<span class="n">list_cut_position</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_fifo</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_tailidx</span><span class="p">],</span>
				  <span class="o">&amp;</span><span class="n">lastbf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_fifo</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_tailidx</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">INCR</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txq_tailidx</span><span class="p">,</span> <span class="n">ATH_TXFIFO_DEPTH</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_q</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">list_head</span> <span class="n">bf_q</span><span class="p">;</span>

				<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf_q</span><span class="p">);</span>
				<span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">axq_q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_q</span><span class="p">);</span>
				<span class="n">ath_tx_txqaddbuf</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_q</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ath_tx_process_buffer</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf_head</span><span class="p">);</span>
		<span class="n">ath_txq_unlock_complete</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*****************/</span>
<span class="cm">/* Init, Cleanup */</span>
<span class="cm">/*****************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath_txstatus_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_descdma</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">txsdma</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">txs_len</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">txs_len</span><span class="p">;</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">txs_len</span><span class="p">;</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_paddr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath_tx_edma_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ath_txstatus_setup</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH_TXSTATUS_RING_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">ath9k_hw_setup_statusring</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">txsdma</span><span class="p">.</span><span class="n">dd_desc</span><span class="p">,</span>
					  <span class="n">sc</span><span class="o">-&gt;</span><span class="n">txsdma</span><span class="p">.</span><span class="n">dd_desc_paddr</span><span class="p">,</span>
					  <span class="n">ATH_TXSTATUS_RING_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath_tx_edma_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_descdma</span> <span class="o">*</span><span class="n">dd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">txsdma</span><span class="p">;</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc</span><span class="p">,</span>
			  <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_paddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath_tx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbufs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuflock</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ath_descdma_setup</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txdma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuf</span><span class="p">,</span>
				  <span class="s">&quot;tx&quot;</span><span class="p">,</span> <span class="n">nbufs</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Failed to allocate tx descriptors: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ath_descdma_setup</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">bdma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">bbuf</span><span class="p">,</span>
				  <span class="s">&quot;beacon&quot;</span><span class="p">,</span> <span class="n">ATH_BCBUF</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Failed to allocate beacon descriptors: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx_complete_work</span><span class="p">,</span> <span class="n">ath_tx_complete_poll_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">ath_tx_edma_init</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ath_tx_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_tx_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">bdma</span><span class="p">.</span><span class="n">dd_desc_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ath_descdma_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">bdma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">bbuf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txdma</span><span class="p">.</span><span class="n">dd_desc_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ath_descdma_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txdma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txbuf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">)</span>
		<span class="n">ath_tx_edma_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_tx_node_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_atx_ac</span> <span class="o">*</span><span class="n">ac</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tidno</span><span class="p">,</span> <span class="n">acno</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tidno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">[</span><span class="n">tidno</span><span class="p">];</span>
	     <span class="n">tidno</span> <span class="o">&lt;</span> <span class="n">WME_NUM_TID</span><span class="p">;</span>
	     <span class="n">tidno</span><span class="o">++</span><span class="p">,</span> <span class="n">tid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">an</span>        <span class="o">=</span> <span class="n">an</span><span class="p">;</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">tidno</span>     <span class="o">=</span> <span class="n">tidno</span><span class="p">;</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_start</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">seq_next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_size</span>  <span class="o">=</span> <span class="n">WME_MAX_BA</span><span class="p">;</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_head</span>  <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">baw_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">sched</span>     <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">paused</span>    <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AGGR_CLEANUP</span><span class="p">;</span>
		<span class="n">__skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">buf_q</span><span class="p">);</span>
		<span class="n">acno</span> <span class="o">=</span> <span class="n">TID_TO_WME_AC</span><span class="p">(</span><span class="n">tidno</span><span class="p">);</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">[</span><span class="n">acno</span><span class="p">];</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AGGR_ADDBA_COMPLETE</span><span class="p">;</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AGGR_ADDBA_PROGRESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">acno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">[</span><span class="n">acno</span><span class="p">];</span>
	     <span class="n">acno</span> <span class="o">&lt;</span> <span class="n">WME_NUM_AC</span><span class="p">;</span> <span class="n">acno</span><span class="o">++</span><span class="p">,</span> <span class="n">ac</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">sched</span>    <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">ac</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq_map</span><span class="p">[</span><span class="n">acno</span><span class="p">];</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">tid_q</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_tx_node_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_node</span> <span class="o">*</span><span class="n">an</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_atx_ac</span> <span class="o">*</span><span class="n">ac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_atx_tid</span> <span class="o">*</span><span class="n">tid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_txq</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tidno</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">tidno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">an</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">[</span><span class="n">tidno</span><span class="p">];</span>
	     <span class="n">tidno</span> <span class="o">&lt;</span> <span class="n">WME_NUM_TID</span><span class="p">;</span> <span class="n">tidno</span><span class="o">++</span><span class="p">,</span> <span class="n">tid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ac</span> <span class="o">=</span> <span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">;</span>
		<span class="n">txq</span> <span class="o">=</span> <span class="n">ac</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">;</span>

		<span class="n">ath_txq_lock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">sched</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">tid</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">sched</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">tid</span><span class="o">-&gt;</span><span class="n">ac</span><span class="o">-&gt;</span><span class="n">sched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ath_tid_drain</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AGGR_ADDBA_COMPLETE</span><span class="p">;</span>
		<span class="n">tid</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AGGR_CLEANUP</span><span class="p">;</span>

		<span class="n">ath_txq_unlock</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
