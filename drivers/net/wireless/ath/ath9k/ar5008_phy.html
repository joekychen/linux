<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › ar5008_phy.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ar5008_phy.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;hw.h&quot;</span>
<span class="cp">#include &quot;hw-ops.h&quot;</span>
<span class="cp">#include &quot;../regd.h&quot;</span>
<span class="cp">#include &quot;ar9002_phy.h&quot;</span>

<span class="cm">/* All code below is for AR5008, AR9001, AR9002 */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">firstep_table</span><span class="p">[]</span> <span class="o">=</span>
<span class="cm">/* level:  0   1   2   3   4   5   6   7   8  */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span> <span class="p">};</span> <span class="cm">/* lvl 0-8, default 2 */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">cycpwrThr1_table</span><span class="p">[]</span> <span class="o">=</span>
<span class="cm">/* level:  0   1   2   3   4   5   6   7   8  */</span>
	<span class="p">{</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>  <span class="mi">0</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span>  <span class="mi">8</span> <span class="p">};</span>     <span class="cm">/* lvl 0-7, default 3 */</span>

<span class="cm">/*</span>
<span class="cm"> * register values to turn OFDM weak signal detection OFF</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m1ThreshLow_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2ThreshLow_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m1Thresh_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2Thresh_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2CountThr_off</span> <span class="o">=</span>  <span class="mi">31</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2CountThrLow_off</span> <span class="o">=</span>  <span class="mi">63</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m1ThreshLowExt_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2ThreshLowExt_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m1ThreshExt_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">m2ThreshExt_off</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_rf_bank_setup</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">bank</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ar5416IniArray</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">col</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">array</span><span class="o">-&gt;</span><span class="n">ia_rows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">bank</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">INI_RA</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#define REG_WRITE_RF_ARRAY(iniarray, regData, regWr) \</span>
<span class="cp">	ar5008_write_rf_array(ah, iniarray, regData, &amp;(regWr))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_write_rf_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ar5416IniArray</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">writecnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">array</span><span class="o">-&gt;</span><span class="n">ia_rows</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">INI_RA</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">data</span><span class="p">[</span><span class="n">r</span><span class="p">]);</span>
		<span class="n">DO_DELAY</span><span class="p">(</span><span class="o">*</span><span class="n">writecnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ar5008_hw_phy_modify_rx_buffer() - perform analog swizzling of parameters</span>
<span class="cm"> * @rfbuf:</span>
<span class="cm"> * @reg32:</span>
<span class="cm"> * @numBits:</span>
<span class="cm"> * @firstBit:</span>
<span class="cm"> * @column:</span>
<span class="cm"> *</span>
<span class="cm"> * Performs analog &quot;swizzling&quot; of parameters into their location.</span>
<span class="cm"> * Used on external AR2133/AR5133 radios.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_phy_modify_rx_buffer</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">rfBuf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg32</span><span class="p">,</span>
					   <span class="n">u32</span> <span class="n">numBits</span><span class="p">,</span> <span class="n">u32</span> <span class="n">firstBit</span><span class="p">,</span>
					   <span class="n">u32</span> <span class="n">column</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp32</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">arrayEntry</span><span class="p">,</span> <span class="n">lastBit</span><span class="p">;</span>
	<span class="kt">int32_t</span> <span class="n">bitPosition</span><span class="p">,</span> <span class="n">bitsLeft</span><span class="p">;</span>

	<span class="n">tmp32</span> <span class="o">=</span> <span class="n">ath9k_hw_reverse_bits</span><span class="p">(</span><span class="n">reg32</span><span class="p">,</span> <span class="n">numBits</span><span class="p">);</span>
	<span class="n">arrayEntry</span> <span class="o">=</span> <span class="p">(</span><span class="n">firstBit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">bitPosition</span> <span class="o">=</span> <span class="p">(</span><span class="n">firstBit</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">bitsLeft</span> <span class="o">=</span> <span class="n">numBits</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">bitsLeft</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lastBit</span> <span class="o">=</span> <span class="p">(</span><span class="n">bitPosition</span> <span class="o">+</span> <span class="n">bitsLeft</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span>
		    <span class="mi">8</span> <span class="o">:</span> <span class="n">bitPosition</span> <span class="o">+</span> <span class="n">bitsLeft</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">lastBit</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bitPosition</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
		    <span class="p">(</span><span class="n">column</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">rfBuf</span><span class="p">[</span><span class="n">arrayEntry</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="n">rfBuf</span><span class="p">[</span><span class="n">arrayEntry</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">tmp32</span> <span class="o">&lt;&lt;</span> <span class="n">bitPosition</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				      <span class="p">(</span><span class="n">column</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">bitsLeft</span> <span class="o">-=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">bitPosition</span><span class="p">;</span>
		<span class="n">tmp32</span> <span class="o">=</span> <span class="n">tmp32</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">bitPosition</span><span class="p">);</span>
		<span class="n">bitPosition</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">arrayEntry</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fix on 2.4 GHz band for orientation sensitivity issue by increasing</span>
<span class="cm"> * rf_pwd_icsyndiv.</span>
<span class="cm"> *</span>
<span class="cm"> * Theoretical Rules:</span>
<span class="cm"> *   if 2 GHz band</span>
<span class="cm"> *      if forceBiasAuto</span>
<span class="cm"> *         if synth_freq &lt; 2412</span>
<span class="cm"> *            bias = 0</span>
<span class="cm"> *         else if 2412 &lt;= synth_freq &lt;= 2422</span>
<span class="cm"> *            bias = 1</span>
<span class="cm"> *         else // synth_freq &gt; 2422</span>
<span class="cm"> *            bias = 2</span>
<span class="cm"> *      else if forceBias &gt; 0</span>
<span class="cm"> *         bias = forceBias &amp; 7</span>
<span class="cm"> *      else</span>
<span class="cm"> *         no change, use value from ini file</span>
<span class="cm"> *   else</span>
<span class="cm"> *      no change, invalid band</span>
<span class="cm"> *</span>
<span class="cm"> *  1st Mod:</span>
<span class="cm"> *    2422 also uses value of 2</span>
<span class="cm"> *    &lt;approved&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  2nd Mod:</span>
<span class="cm"> *    Less than 2412 uses value of 0, 2412 and above uses value of 2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_force_bias</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u16</span> <span class="n">synth_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tmp_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg_writes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_bias</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_5416</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">synth_freq</span> <span class="o">&gt;=</span> <span class="mi">3000</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">synth_freq</span> <span class="o">&lt;</span> <span class="mi">2412</span><span class="p">)</span>
		<span class="n">new_bias</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">synth_freq</span> <span class="o">&lt;</span> <span class="mi">2422</span><span class="p">)</span>
		<span class="n">new_bias</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">new_bias</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* pre-reverse this field */</span>
	<span class="n">tmp_reg</span> <span class="o">=</span> <span class="n">ath9k_hw_reverse_bits</span><span class="p">(</span><span class="n">new_bias</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Force rf_pwd_icsyndiv to %1d on %4d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">new_bias</span><span class="p">,</span> <span class="n">synth_freq</span><span class="p">);</span>

	<span class="cm">/* swizzle rf_pwd_icsyndiv */</span>
	<span class="n">ar5008_hw_phy_modify_rx_buffer</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6Data</span><span class="p">,</span> <span class="n">tmp_reg</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* write Bank 6 with new params */</span>
	<span class="n">REG_WRITE_RF_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank6</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6Data</span><span class="p">,</span> <span class="n">reg_writes</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ar5008_hw_set_channel - tune to a channel on the external AR2133/AR5133 radios</span>
<span class="cm"> * @ah: atheros hardware structure</span>
<span class="cm"> * @chan:</span>
<span class="cm"> *</span>
<span class="cm"> * For the external AR2133/AR5133 radios, takes the MHz channel value and set</span>
<span class="cm"> * the channel value. Assumes writes enabled to analog bus and bank6 register</span>
<span class="cm"> * cache in ah-&gt;analogBank6Data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ar5008_hw_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">channelSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bModeSynth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">aModeRefSel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">freq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chan_centers</span> <span class="n">centers</span><span class="p">;</span>

	<span class="n">ath9k_hw_get_channel_centers</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">centers</span><span class="p">);</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">centers</span><span class="p">.</span><span class="n">synth_center</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">4800</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">txctl</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">freq</span> <span class="o">-</span> <span class="mi">2192</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">channelSel</span> <span class="o">=</span> <span class="p">((</span><span class="n">freq</span> <span class="o">-</span> <span class="mi">672</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">3040</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">bModeSynth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(((</span><span class="n">freq</span> <span class="o">-</span> <span class="mi">2224</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">channelSel</span> <span class="o">=</span> <span class="p">((</span><span class="n">freq</span> <span class="o">-</span> <span class="mi">704</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">3040</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">bModeSynth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Invalid channel %u MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">channelSel</span> <span class="o">=</span> <span class="p">(</span><span class="n">channelSel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">channelSel</span> <span class="o">=</span> <span class="n">ath9k_hw_reverse_bits</span><span class="p">(</span><span class="n">channelSel</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">txctl</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_TX_CTRL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">==</span> <span class="mi">2484</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_TX_CTRL</span><span class="p">,</span>
				  <span class="n">txctl</span> <span class="o">|</span> <span class="n">AR_PHY_CCK_TX_CTRL_JAPAN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_TX_CTRL</span><span class="p">,</span>
				  <span class="n">txctl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AR_PHY_CCK_TX_CTRL_JAPAN</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">freq</span> <span class="o">%</span> <span class="mi">20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">5120</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channelSel</span> <span class="o">=</span>
		    <span class="n">ath9k_hw_reverse_bits</span><span class="p">(((</span><span class="n">freq</span> <span class="o">-</span> <span class="mi">4800</span><span class="p">)</span> <span class="o">/</span> <span class="mi">20</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">aModeRefSel</span> <span class="o">=</span> <span class="n">ath9k_hw_reverse_bits</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">freq</span> <span class="o">%</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channelSel</span> <span class="o">=</span>
		    <span class="n">ath9k_hw_reverse_bits</span><span class="p">(((</span><span class="n">freq</span> <span class="o">-</span> <span class="mi">4800</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9160_10_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">aModeRefSel</span> <span class="o">=</span> <span class="n">ath9k_hw_reverse_bits</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">aModeRefSel</span> <span class="o">=</span> <span class="n">ath9k_hw_reverse_bits</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">freq</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channelSel</span> <span class="o">=</span> <span class="n">ath9k_hw_reverse_bits</span><span class="p">((</span><span class="n">freq</span> <span class="o">-</span> <span class="mi">4800</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">aModeRefSel</span> <span class="o">=</span> <span class="n">ath9k_hw_reverse_bits</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Invalid channel %u MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar5008_hw_force_bias</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="n">reg32</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">channelSel</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">aModeRefSel</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bModeSynth</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY</span><span class="p">(</span><span class="mh">0x37</span><span class="p">),</span> <span class="n">reg32</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ar5008_hw_spur_mitigate - convert baseband spur frequency for external radios</span>
<span class="cm"> * @ah: atheros hardware structure</span>
<span class="cm"> * @chan:</span>
<span class="cm"> *</span>
<span class="cm"> * For non single-chip solutions. Converts to baseband spur frequency given the</span>
<span class="cm"> * input channel frequency and compute register settings below.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_spur_mitigate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bb_spur</span> <span class="o">=</span> <span class="n">AR_NO_SPUR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bin</span><span class="p">,</span> <span class="n">cur_bin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spur_freq_sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spur_delta_phase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">denominator</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">upper</span><span class="p">,</span> <span class="n">lower</span><span class="p">,</span> <span class="n">cur_vit_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">pilot_mask_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">AR_PHY_TIMING7</span><span class="p">,</span> <span class="n">AR_PHY_TIMING8</span><span class="p">,</span>
		<span class="n">AR_PHY_PILOT_MASK_01_30</span><span class="p">,</span> <span class="n">AR_PHY_PILOT_MASK_31_60</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">chan_mask_reg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">AR_PHY_TIMING9</span><span class="p">,</span> <span class="n">AR_PHY_TIMING10</span><span class="p">,</span>
		<span class="n">AR_PHY_CHANNEL_MASK_01_30</span><span class="p">,</span> <span class="n">AR_PHY_CHANNEL_MASK_31_60</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">inc</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="kt">int8_t</span> <span class="n">mask_m</span><span class="p">[</span><span class="mi">123</span><span class="p">];</span>
	<span class="kt">int8_t</span> <span class="n">mask_p</span><span class="p">[</span><span class="mi">123</span><span class="p">];</span>
	<span class="kt">int8_t</span> <span class="n">mask_amt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur_bb_spur</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is2GHz</span> <span class="o">=</span> <span class="n">IS_CHAN_2GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask_m</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">123</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mask_p</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int8_t</span><span class="p">)</span> <span class="o">*</span> <span class="mi">123</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR_EEPROM_MODAL_SPURS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cur_bb_spur</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_spur_channel</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">is2GHz</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_NO_SPUR</span> <span class="o">==</span> <span class="n">cur_bb_spur</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cur_bb_spur</span> <span class="o">=</span> <span class="n">cur_bb_spur</span> <span class="o">-</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cur_bb_spur</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">95</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur_bb_spur</span> <span class="o">&lt;</span> <span class="mi">95</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bb_spur</span> <span class="o">=</span> <span class="n">cur_bb_spur</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_NO_SPUR</span> <span class="o">==</span> <span class="n">bb_spur</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bin</span> <span class="o">=</span> <span class="n">bb_spur</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING_CTRL4</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">|</span> <span class="p">(</span><span class="n">AR_PHY_TIMING_CTRL4_ENABLE_SPUR_RSSI</span> <span class="o">|</span>
		     <span class="n">AR_PHY_TIMING_CTRL4_ENABLE_SPUR_FILTER</span> <span class="o">|</span>
		     <span class="n">AR_PHY_TIMING_CTRL4_ENABLE_CHAN_MASK</span> <span class="o">|</span>
		     <span class="n">AR_PHY_TIMING_CTRL4_ENABLE_PILOT_MASK</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING_CTRL4</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">new</span><span class="p">);</span>

	<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">AR_PHY_SPUR_REG_MASK_RATE_CNTL</span> <span class="o">|</span>
	       <span class="n">AR_PHY_SPUR_REG_ENABLE_MASK_PPM</span> <span class="o">|</span>
	       <span class="n">AR_PHY_SPUR_REG_MASK_RATE_SELECT</span> <span class="o">|</span>
	       <span class="n">AR_PHY_SPUR_REG_ENABLE_VIT_SPUR_RSSI</span> <span class="o">|</span>
	       <span class="n">SM</span><span class="p">(</span><span class="n">SPUR_RSSI_THRESH</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_REG_SPUR_RSSI_THRESH</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPUR_REG</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>

	<span class="n">spur_delta_phase</span> <span class="o">=</span> <span class="p">((</span><span class="n">bb_spur</span> <span class="o">*</span> <span class="mi">524288</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">AR_PHY_TIMING11_SPUR_DELTA_PHASE</span><span class="p">;</span>

	<span class="n">denominator</span> <span class="o">=</span> <span class="n">IS_CHAN_2GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">?</span> <span class="mi">440</span> <span class="o">:</span> <span class="mi">400</span><span class="p">;</span>
	<span class="n">spur_freq_sd</span> <span class="o">=</span> <span class="p">((</span><span class="n">bb_spur</span> <span class="o">*</span> <span class="mi">2048</span><span class="p">)</span> <span class="o">/</span> <span class="n">denominator</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3ff</span><span class="p">;</span>

	<span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">AR_PHY_TIMING11_USE_SPUR_IN_AGC</span> <span class="o">|</span>
	       <span class="n">SM</span><span class="p">(</span><span class="n">spur_freq_sd</span><span class="p">,</span> <span class="n">AR_PHY_TIMING11_SPUR_FREQ_SD</span><span class="p">)</span> <span class="o">|</span>
	       <span class="n">SM</span><span class="p">(</span><span class="n">spur_delta_phase</span><span class="p">,</span> <span class="n">AR_PHY_TIMING11_SPUR_DELTA_PHASE</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING11</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>

	<span class="n">cur_bin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6000</span><span class="p">;</span>
	<span class="n">upper</span> <span class="o">=</span> <span class="n">bin</span> <span class="o">+</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">lower</span> <span class="o">=</span> <span class="n">bin</span> <span class="o">-</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pilot_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">chan_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bp</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">bp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cur_bin</span> <span class="o">&gt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur_bin</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pilot_mask</span> <span class="o">=</span> <span class="n">pilot_mask</span> <span class="o">|</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">bp</span><span class="p">;</span>
				<span class="n">chan_mask</span> <span class="o">=</span> <span class="n">chan_mask</span> <span class="o">|</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">bp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cur_bin</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cur_bin</span> <span class="o">+=</span> <span class="n">inc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">pilot_mask_reg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">pilot_mask</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan_mask_reg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">chan_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cur_vit_mask</span> <span class="o">=</span> <span class="mi">6100</span><span class="p">;</span>
	<span class="n">upper</span> <span class="o">=</span> <span class="n">bin</span> <span class="o">+</span> <span class="mi">120</span><span class="p">;</span>
	<span class="n">lower</span> <span class="o">=</span> <span class="n">bin</span> <span class="o">-</span> <span class="mi">120</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">123</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cur_vit_mask</span> <span class="o">&gt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cur_vit_mask</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* workaround for gcc bug #37014 */</span>
			<span class="k">volatile</span> <span class="kt">int</span> <span class="n">tmp_v</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">cur_vit_mask</span> <span class="o">-</span> <span class="n">bin</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tmp_v</span> <span class="o">&lt;</span> <span class="mi">75</span><span class="p">)</span>
				<span class="n">mask_amt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mask_amt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cur_vit_mask</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">mask_m</span><span class="p">[</span><span class="n">abs</span><span class="p">(</span><span class="n">cur_vit_mask</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mask_amt</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mask_p</span><span class="p">[</span><span class="n">cur_vit_mask</span> <span class="o">/</span> <span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask_amt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cur_vit_mask</span> <span class="o">-=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmp_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">47</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">49</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">52</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">54</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">55</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">58</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">59</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">60</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">61</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_BIN_MASK_1</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_VIT_MASK2_M_46_61</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>

	<span class="n">tmp_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_BIN_MASK_2</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MASK2_M_31_45</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>

	<span class="n">tmp_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_BIN_MASK_3</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MASK2_M_16_30</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>

	<span class="n">tmp_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_m</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MASK_CTL</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MASK2_M_00_15</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>

	<span class="n">tmp_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_BIN_MASK2_1</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MASK2_P_15_01</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>

	<span class="n">tmp_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">29</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">23</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_BIN_MASK2_2</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MASK2_P_30_16</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>

	<span class="n">tmp_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">45</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">44</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">43</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">42</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">40</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">39</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">38</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">37</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">36</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">35</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">34</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_BIN_MASK2_3</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MASK2_P_45_31</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>

	<span class="n">tmp_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">61</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">60</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">59</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">58</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">57</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">56</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">55</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">54</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">53</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">52</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">51</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">49</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">47</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">mask_p</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_BIN_MASK2_4</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MASK2_P_61_45</span><span class="p">,</span> <span class="n">tmp_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ar5008_hw_rf_alloc_ext_banks - allocates banks for external radio programming</span>
<span class="cm"> * @ah: atheros hardware structure</span>
<span class="cm"> *</span>
<span class="cm"> * Only required for older devices with external AR2133/AR5133 radios.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ar5008_hw_rf_alloc_ext_banks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define ATH_ALLOC_BANK(bank, size) do { \</span>
<span class="cp">		bank = kzalloc((sizeof(u32) * size), GFP_KERNEL); \</span>
<span class="cp">		if (!bank) { \</span>
<span class="cp">			ath_err(common, &quot;Cannot allocate RF banks\n&quot;); \</span>
<span class="cp">			return -ENOMEM; \</span>
<span class="cp">		} \</span>
<span class="cp">	} while (0);</span>

	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">));</span>

	<span class="n">ATH_ALLOC_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank0Data</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank0</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">);</span>
	<span class="n">ATH_ALLOC_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank1Data</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank1</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">);</span>
	<span class="n">ATH_ALLOC_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank2Data</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank2</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">);</span>
	<span class="n">ATH_ALLOC_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank3Data</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank3</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">);</span>
	<span class="n">ATH_ALLOC_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6Data</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank6</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">);</span>
	<span class="n">ATH_ALLOC_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6TPCData</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank6TPC</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">);</span>
	<span class="n">ATH_ALLOC_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank7Data</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank7</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">);</span>
	<span class="n">ATH_ALLOC_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bank6Temp</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank6</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#undef ATH_ALLOC_BANK</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * ar5008_hw_rf_free_ext_banks - Free memory for analog bank scratch buffers</span>
<span class="cm"> * @ah: atheros hardware struture</span>
<span class="cm"> * For the external AR2133/AR5133 radios banks.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_rf_free_ext_banks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define ATH_FREE_BANK(bank) do { \</span>
<span class="cp">		kfree(bank); \</span>
<span class="cp">		bank = NULL; \</span>
<span class="cp">	} while (0);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">));</span>

	<span class="n">ATH_FREE_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank0Data</span><span class="p">);</span>
	<span class="n">ATH_FREE_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank1Data</span><span class="p">);</span>
	<span class="n">ATH_FREE_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank2Data</span><span class="p">);</span>
	<span class="n">ATH_FREE_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank3Data</span><span class="p">);</span>
	<span class="n">ATH_FREE_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6Data</span><span class="p">);</span>
	<span class="n">ATH_FREE_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6TPCData</span><span class="p">);</span>
	<span class="n">ATH_FREE_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank7Data</span><span class="p">);</span>
	<span class="n">ATH_FREE_BANK</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">bank6Temp</span><span class="p">);</span>

<span class="cp">#undef ATH_FREE_BANK</span>
<span class="p">}</span>

<span class="cm">/* *</span>
<span class="cm"> * ar5008_hw_set_rf_regs - programs rf registers based on EEPROM</span>
<span class="cm"> * @ah: atheros hardware structure</span>
<span class="cm"> * @chan:</span>
<span class="cm"> * @modesIndex:</span>
<span class="cm"> *</span>
<span class="cm"> * Used for the external AR2133/AR5133 radios.</span>
<span class="cm"> *</span>
<span class="cm"> * Reads the EEPROM header info from the device structure and programs</span>
<span class="cm"> * all rf registers. This routine requires access to the analog</span>
<span class="cm"> * rf device. This is not required for single-chip devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ar5008_hw_set_rf_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">modesIndex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">eepMinorRev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ob5GHz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">db5GHz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ob2GHz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">db2GHz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">regWrites</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Software does not need to program bank data</span>
<span class="cm">	 * for single chip devices, that is AR9280 or anything</span>
<span class="cm">	 * after that.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Setup rf parameters */</span>
	<span class="n">eepMinorRev</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_MINOR_REV</span><span class="p">);</span>

	<span class="cm">/* Setup Bank 0 Write */</span>
	<span class="n">ar5008_rf_bank_setup</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank0Data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Setup Bank 1 Write */</span>
	<span class="n">ar5008_rf_bank_setup</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank1Data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Setup Bank 2 Write */</span>
	<span class="n">ar5008_rf_bank_setup</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank2Data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Setup Bank 6 Write */</span>
	<span class="n">ar5008_rf_bank_setup</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank3Data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank3</span><span class="p">,</span>
		      <span class="n">modesIndex</span><span class="p">);</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank6TPC</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6Data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			    <span class="n">INI_RA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank6TPC</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">modesIndex</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Only the 5 or 2 GHz OB/DB need to be set for a mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eepMinorRev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_2GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ob2GHz</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_OB_2</span><span class="p">);</span>
			<span class="n">db2GHz</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_DB_2</span><span class="p">);</span>
			<span class="n">ar5008_hw_phy_modify_rx_buffer</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6Data</span><span class="p">,</span>
						       <span class="n">ob2GHz</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ar5008_hw_phy_modify_rx_buffer</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6Data</span><span class="p">,</span>
						       <span class="n">db2GHz</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ob5GHz</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_OB_5</span><span class="p">);</span>
			<span class="n">db5GHz</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_DB_5</span><span class="p">);</span>
			<span class="n">ar5008_hw_phy_modify_rx_buffer</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6Data</span><span class="p">,</span>
						       <span class="n">ob5GHz</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ar5008_hw_phy_modify_rx_buffer</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6Data</span><span class="p">,</span>
						       <span class="n">db5GHz</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Setup Bank 7 Setup */</span>
	<span class="n">ar5008_rf_bank_setup</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank7Data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank7</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Write Analog registers */</span>
	<span class="n">REG_WRITE_RF_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank0</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank0Data</span><span class="p">,</span>
			   <span class="n">regWrites</span><span class="p">);</span>
	<span class="n">REG_WRITE_RF_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank1</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank1Data</span><span class="p">,</span>
			   <span class="n">regWrites</span><span class="p">);</span>
	<span class="n">REG_WRITE_RF_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank2</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank2Data</span><span class="p">,</span>
			   <span class="n">regWrites</span><span class="p">);</span>
	<span class="n">REG_WRITE_RF_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank3</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank3Data</span><span class="p">,</span>
			   <span class="n">regWrites</span><span class="p">);</span>
	<span class="n">REG_WRITE_RF_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank6TPC</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank6Data</span><span class="p">,</span>
			   <span class="n">regWrites</span><span class="p">);</span>
	<span class="n">REG_WRITE_RF_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank7</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">analogBank7Data</span><span class="p">,</span>
			   <span class="n">regWrites</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_init_bb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">synthDelay</span><span class="p">;</span>

	<span class="n">synthDelay</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RX_DELAY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR_PHY_RX_DELAY_DELAY</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ACTIVE</span><span class="p">,</span> <span class="n">AR_PHY_ACTIVE_EN</span><span class="p">);</span>

	<span class="n">ath9k_hw_synth_delay</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">synthDelay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_init_chain_masks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rx_chainmask</span><span class="p">,</span> <span class="n">tx_chainmask</span><span class="p">;</span>

	<span class="n">rx_chainmask</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxchainmask</span><span class="p">;</span>
	<span class="n">tx_chainmask</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span><span class="p">;</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">rx_chainmask</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x5</span>:
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ANALOG_SWAP</span><span class="p">,</span>
			    <span class="n">AR_PHY_SWAP_ALT_CHAIN</span><span class="p">);</span>
	<span class="k">case</span> <span class="mh">0x3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span> <span class="o">==</span> <span class="n">AR_SREV_REVISION_5416_10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RX_CHAINMASK</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CAL_CHAINMASK</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mh">0x1</span>:
	<span class="k">case</span> <span class="mh">0x2</span>:
	<span class="k">case</span> <span class="mh">0x7</span>:
		<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RX_CHAINMASK</span><span class="p">,</span> <span class="n">rx_chainmask</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CAL_CHAINMASK</span><span class="p">,</span> <span class="n">rx_chainmask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SELFGEN_MASK</span><span class="p">,</span> <span class="n">tx_chainmask</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_chainmask</span> <span class="o">==</span> <span class="mh">0x5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ANALOG_SWAP</span><span class="p">,</span>
			    <span class="n">AR_PHY_SWAP_ALT_CHAIN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ANALOG_SWAP</span><span class="p">,</span>
			  <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ANALOG_SWAP</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00000001</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_override_ini</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set the RX_ABORT and RX_DIS and clear if off only after</span>
<span class="cm">	 * RXE is set for MAC. This prevents frames with corrupted</span>
<span class="cm">	 * descriptor status.</span>
<span class="cm">	 */</span>
	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_DIAG_SW</span><span class="p">,</span> <span class="p">(</span><span class="n">AR_DIAG_RX_DIS</span> <span class="o">|</span> <span class="n">AR_DIAG_RX_ABORT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCU_MISC_MODE2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR_PCU_MISC_MODE2_HWWAR1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287_11_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">AR_PCU_MISC_MODE2_HWWAR2</span><span class="p">);</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCU_MISC_MODE2</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_DETECT</span><span class="p">,</span>
		    <span class="n">AR_PHY_CCK_DETECT_BB_ENABLE_ANT_FAST_DIV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Disable BB clock gating</span>
<span class="cm">	 * Necessary to avoid issues on AR5416 2.0</span>
<span class="cm">	 */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x9800</span> <span class="o">+</span> <span class="p">(</span><span class="mi">651</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mh">0x11</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable RIFS search on some chips to avoid baseband</span>
<span class="cm">	 * hang issues.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9160</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_HEAVY_CLIP_FACTOR_RIFS</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR_PHY_RIFS_INIT_DELAY</span><span class="p">;</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_HEAVY_CLIP_FACTOR_RIFS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_set_channel_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phymode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">enableDacFifo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285_12_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">enableDacFifo</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TURBO</span><span class="p">)</span> <span class="o">&amp;</span>
					 <span class="n">AR_PHY_FC_ENABLE_DAC_FIFO</span><span class="p">);</span>

	<span class="n">phymode</span> <span class="o">=</span> <span class="n">AR_PHY_FC_HT_EN</span> <span class="o">|</span> <span class="n">AR_PHY_FC_SHORT_GI_40</span>
		<span class="o">|</span> <span class="n">AR_PHY_FC_SINGLE_HT_LTF1</span> <span class="o">|</span> <span class="n">AR_PHY_FC_WALSH</span> <span class="o">|</span> <span class="n">enableDacFifo</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HT40</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phymode</span> <span class="o">|=</span> <span class="n">AR_PHY_FC_DYN2040_EN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chanmode</span> <span class="o">==</span> <span class="n">CHANNEL_A_HT40PLUS</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chanmode</span> <span class="o">==</span> <span class="n">CHANNEL_G_HT40PLUS</span><span class="p">))</span>
			<span class="n">phymode</span> <span class="o">|=</span> <span class="n">AR_PHY_FC_DYN2040_PRI_CH</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TURBO</span><span class="p">,</span> <span class="n">phymode</span><span class="p">);</span>

	<span class="n">ath9k_hw_set11nmac2040</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_GTXTO</span><span class="p">,</span> <span class="mi">25</span> <span class="o">&lt;&lt;</span> <span class="n">AR_GTXTO_TIMEOUT_LIMIT_S</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CST</span><span class="p">,</span> <span class="mh">0xF</span> <span class="o">&lt;&lt;</span> <span class="n">AR_CST_TIMEOUT_LIMIT_S</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ar5008_hw_process_ini</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">regWrites</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">modesIndex</span><span class="p">,</span> <span class="n">freqIndex</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chanmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHANNEL_A</span>:
	<span class="k">case</span> <span class="n">CHANNEL_A_HT20</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">freqIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_A_HT40PLUS</span>:
	<span class="k">case</span> <span class="n">CHANNEL_A_HT40MINUS</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">freqIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_G</span>:
	<span class="k">case</span> <span class="n">CHANNEL_G_HT20</span>:
	<span class="k">case</span> <span class="n">CHANNEL_B</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">freqIndex</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_G_HT40PLUS</span>:
	<span class="k">case</span> <span class="n">CHANNEL_G_HT40MINUS</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">freqIndex</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set correct baseband to analog shift setting to</span>
<span class="cm">	 * access analog chips.</span>
<span class="cm">	 */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mh">0x00000007</span><span class="p">);</span>

	<span class="cm">/* Write ADDAC shifts */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ADC_SERIAL_CTL</span><span class="p">,</span> <span class="n">AR_PHY_SEL_EXTERNAL_RADIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">set_addac</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">set_addac</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniAddac</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">regWrites</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ADC_SERIAL_CTL</span><span class="p">,</span> <span class="n">AR_PHY_SEL_INTERNAL_ADDAC</span><span class="p">);</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">INI_RA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">INI_RA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">modesIndex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">AR_AN_TOP2</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">need_an_top2_fixup</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR_AN_TOP2_PWDCLKIND</span><span class="p">;</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x7800</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x78a0</span>
		    <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">analog_shiftreg</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="o">-&gt;</span><span class="n">ath_bus_type</span> <span class="o">!=</span> <span class="n">ATH_USB</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">DO_DELAY</span><span class="p">(</span><span class="n">regWrites</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9287_11_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesRxGain</span><span class="p">,</span> <span class="n">modesIndex</span><span class="p">,</span> <span class="n">regWrites</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9285_12_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">AR_SREV_9287_11_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span> <span class="n">modesIndex</span><span class="p">,</span> <span class="n">regWrites</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271_10</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SPECTRAL_SCAN</span><span class="p">,</span> <span class="n">AR_PHY_SPECTRAL_SCAN_ENA</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RF_CTL3</span><span class="p">,</span> <span class="n">AR_PHY_TX_END_TO_ADC_ON</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/* Write common array parameters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCommon</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">INI_RA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCommon</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">INI_RA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCommon</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x7800</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x78a0</span>
		    <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">analog_shiftreg</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="o">-&gt;</span><span class="n">ath_bus_type</span> <span class="o">!=</span> <span class="n">ATH_USB</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">DO_DELAY</span><span class="p">(</span><span class="n">regWrites</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBB_RfGain</span><span class="p">,</span> <span class="n">freqIndex</span><span class="p">,</span> <span class="n">regWrites</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_A_FAST_CLOCK</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
		<span class="n">REG_WRITE_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesFastClock</span><span class="p">,</span> <span class="n">modesIndex</span><span class="p">,</span>
				<span class="n">regWrites</span><span class="p">);</span>

	<span class="n">ar5008_hw_override_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">ar5008_hw_set_channel_regs</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">ar5008_hw_init_chain_masks</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_olc_init</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_hw_apply_txpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* Write analog registers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_set_rf_regs</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">freqIndex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="s">&quot;ar5416SetRfRegs failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_set_rfmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rfMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rfMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IS_CHAN_B</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_CHAN_G</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="o">?</span> <span class="n">AR_PHY_MODE_DYNAMIC</span> <span class="o">:</span> <span class="n">AR_PHY_MODE_OFDM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">rfMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">IS_CHAN_5GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="o">?</span>
			<span class="n">AR_PHY_MODE_RF5GHZ</span> <span class="o">:</span> <span class="n">AR_PHY_MODE_RF2GHZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_A_FAST_CLOCK</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
		<span class="n">rfMode</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AR_PHY_MODE_DYNAMIC</span> <span class="o">|</span> <span class="n">AR_PHY_MODE_DYN_CCK_DISABLE</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MODE</span><span class="p">,</span> <span class="n">rfMode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_mark_phy_inactive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ACTIVE</span><span class="p">,</span> <span class="n">AR_PHY_ACTIVE_DIS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_set_delta_slope</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">coef_scaled</span><span class="p">,</span> <span class="n">ds_coef_exp</span><span class="p">,</span> <span class="n">ds_coef_man</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clockMhzScaled</span> <span class="o">=</span> <span class="mh">0x64000000</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chan_centers</span> <span class="n">centers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HALF_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">clockMhzScaled</span> <span class="o">=</span> <span class="n">clockMhzScaled</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_QUARTER_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">clockMhzScaled</span> <span class="o">=</span> <span class="n">clockMhzScaled</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ath9k_hw_get_channel_centers</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">centers</span><span class="p">);</span>
	<span class="n">coef_scaled</span> <span class="o">=</span> <span class="n">clockMhzScaled</span> <span class="o">/</span> <span class="n">centers</span><span class="p">.</span><span class="n">synth_center</span><span class="p">;</span>

	<span class="n">ath9k_hw_get_delta_slope_vals</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">coef_scaled</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds_coef_man</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">ds_coef_exp</span><span class="p">);</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING3</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING3_DSC_MAN</span><span class="p">,</span> <span class="n">ds_coef_man</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING3</span><span class="p">,</span>
		      <span class="n">AR_PHY_TIMING3_DSC_EXP</span><span class="p">,</span> <span class="n">ds_coef_exp</span><span class="p">);</span>

	<span class="n">coef_scaled</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span> <span class="o">*</span> <span class="n">coef_scaled</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">ath9k_hw_get_delta_slope_vals</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">coef_scaled</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ds_coef_man</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">ds_coef_exp</span><span class="p">);</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_HALFGI</span><span class="p">,</span>
		      <span class="n">AR_PHY_HALFGI_DSC_MAN</span><span class="p">,</span> <span class="n">ds_coef_man</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_HALFGI</span><span class="p">,</span>
		      <span class="n">AR_PHY_HALFGI_DSC_EXP</span><span class="p">,</span> <span class="n">ds_coef_exp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ar5008_hw_rfbus_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RFBUS_REQ</span><span class="p">,</span> <span class="n">AR_PHY_RFBUS_REQ_EN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath9k_hw_wait</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RFBUS_GRANT</span><span class="p">,</span> <span class="n">AR_PHY_RFBUS_GRANT_EN</span><span class="p">,</span>
			   <span class="n">AR_PHY_RFBUS_GRANT_EN</span><span class="p">,</span> <span class="n">AH_WAIT_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_rfbus_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">synthDelay</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RX_DELAY</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR_PHY_RX_DELAY_DELAY</span><span class="p">;</span>

	<span class="n">ath9k_hw_synth_delay</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">,</span> <span class="n">synthDelay</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RFBUS_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_restore_chainmask</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rx_chainmask</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxchainmask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rx_chainmask</span> <span class="o">==</span> <span class="mh">0x5</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rx_chainmask</span> <span class="o">==</span> <span class="mh">0x3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RX_CHAINMASK</span><span class="p">,</span> <span class="n">rx_chainmask</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CAL_CHAINMASK</span><span class="p">,</span> <span class="n">rx_chainmask</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ar9160_hw_compute_pll_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pll</span><span class="p">;</span>

	<span class="n">pll</span> <span class="o">=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0x5</span><span class="p">,</span> <span class="n">AR_RTC_9160_PLL_REFDIV</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span> <span class="n">IS_CHAN_HALF_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">pll</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">AR_RTC_9160_PLL_CLKSEL</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span> <span class="n">IS_CHAN_QUARTER_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">pll</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0x2</span><span class="p">,</span> <span class="n">AR_RTC_9160_PLL_CLKSEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span> <span class="n">IS_CHAN_5GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">pll</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="n">AR_RTC_9160_PLL_DIV</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pll</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="n">AR_RTC_9160_PLL_DIV</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pll</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ar5008_hw_compute_pll_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pll</span><span class="p">;</span>

	<span class="n">pll</span> <span class="o">=</span> <span class="n">AR_RTC_PLL_REFDIV_5</span> <span class="o">|</span> <span class="n">AR_RTC_PLL_DIV2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span> <span class="n">IS_CHAN_HALF_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">pll</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span> <span class="n">AR_RTC_PLL_CLKSEL</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span> <span class="n">IS_CHAN_QUARTER_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">pll</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0x2</span><span class="p">,</span> <span class="n">AR_RTC_PLL_CLKSEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&amp;&amp;</span> <span class="n">IS_CHAN_5GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">pll</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0xa</span><span class="p">,</span> <span class="n">AR_RTC_PLL_DIV</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pll</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="mh">0xb</span><span class="p">,</span> <span class="n">AR_RTC_PLL_DIV</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pll</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ar5008_hw_ani_control_old</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">ath9k_ani_cmd</span> <span class="n">cmd</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ar5416AniState</span> <span class="o">*</span><span class="n">aniState</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_NOISE_IMMUNITY_LEVEL</span>:<span class="p">{</span>
		<span class="n">u32</span> <span class="n">level</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">totalSizeDesired</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;level out of range (%u &gt; %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">totalSizeDesired</span><span class="p">));</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_DESIRED_SZ</span><span class="p">,</span>
			      <span class="n">AR_PHY_DESIRED_SZ_TOT_DES</span><span class="p">,</span>
			      <span class="n">ah</span><span class="o">-&gt;</span><span class="n">totalSizeDesired</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_AGC_CTL1</span><span class="p">,</span>
			      <span class="n">AR_PHY_AGC_CTL1_COARSE_LOW</span><span class="p">,</span>
			      <span class="n">ah</span><span class="o">-&gt;</span><span class="n">coarse_low</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_AGC_CTL1</span><span class="p">,</span>
			      <span class="n">AR_PHY_AGC_CTL1_COARSE_HIGH</span><span class="p">,</span>
			      <span class="n">ah</span><span class="o">-&gt;</span><span class="n">coarse_high</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_FIND_SIG</span><span class="p">,</span>
			      <span class="n">AR_PHY_FIND_SIG_FIRPWR</span><span class="p">,</span>
			      <span class="n">ah</span><span class="o">-&gt;</span><span class="n">firpwr</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">noiseImmunityLevel</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_niup</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">noiseImmunityLevel</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_nidown</span><span class="o">++</span><span class="p">;</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">noiseImmunityLevel</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION</span>:<span class="p">{</span>
		<span class="n">u32</span> <span class="n">on</span> <span class="o">=</span> <span class="n">param</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW</span><span class="p">,</span>
				    <span class="n">AR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW</span><span class="p">,</span>
				    <span class="n">AR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span> <span class="o">!=</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_ofdmon</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_ofdmoff</span><span class="o">++</span><span class="p">;</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span> <span class="o">=</span> <span class="o">!</span><span class="n">on</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_CCK_WEAK_SIGNAL_THR</span>:<span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">weakSigThrCck</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span> <span class="p">};</span>
		<span class="n">u32</span> <span class="n">high</span> <span class="o">=</span> <span class="n">param</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCK_DETECT</span><span class="p">,</span>
			      <span class="n">AR_PHY_CCK_DETECT_WEAK_SIG_THR_CCK</span><span class="p">,</span>
			      <span class="n">weakSigThrCck</span><span class="p">[</span><span class="n">high</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">cckWeakSigThreshold</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">high</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_cckhigh</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_ccklow</span><span class="o">++</span><span class="p">;</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">cckWeakSigThreshold</span> <span class="o">=</span> <span class="n">high</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_FIRSTEP_LEVEL</span>:<span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">firstep</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span> <span class="p">};</span>
		<span class="n">u32</span> <span class="n">level</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">firstep</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;level out of range (%u &gt; %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">firstep</span><span class="p">));</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_FIND_SIG</span><span class="p">,</span>
			      <span class="n">AR_PHY_FIND_SIG_FIRSTEP</span><span class="p">,</span>
			      <span class="n">firstep</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_stepup</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_stepdown</span><span class="o">++</span><span class="p">;</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_SPUR_IMMUNITY_LEVEL</span>:<span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">cycpwrThr1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>
		<span class="n">u32</span> <span class="n">level</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cycpwrThr1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;level out of range (%u &gt; %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cycpwrThr1</span><span class="p">));</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING5</span><span class="p">,</span>
			      <span class="n">AR_PHY_TIMING5_CYCPWR_THR1</span><span class="p">,</span>
			      <span class="n">cycpwrThr1</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_spurup</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_spurdown</span><span class="o">++</span><span class="p">;</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_PRESENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;invalid cmd %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;ANI parameters:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
		<span class="s">&quot;noiseImmunityLevel=%d, spurImmunityLevel=%d, ofdmWeakSigDetectOff=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">noiseImmunityLevel</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">,</span>
		<span class="o">!</span><span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span><span class="p">);</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
		<span class="s">&quot;cckWeakSigThreshold=%d, firstepLevel=%d, listenTime=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">cckWeakSigThreshold</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">listenTime</span><span class="p">);</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;ofdmPhyErrCount=%d, cckPhyErrCount=%d</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmPhyErrCount</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">cckPhyErrCount</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ar5008_hw_ani_control_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">ath9k_ani_cmd</span> <span class="n">cmd</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ar5416AniState</span> <span class="o">*</span><span class="n">aniState</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">value</span><span class="p">,</span> <span class="n">value2</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION</span>:<span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * on == 1 means ofdm weak signal detection is ON</span>
<span class="cm">		 * on == 1 is the default, for less noise immunity</span>
<span class="cm">		 *</span>
<span class="cm">		 * on == 0 means ofdm weak signal detection is OFF</span>
<span class="cm">		 * on == 0 means more noise imm</span>
<span class="cm">		 */</span>
		<span class="n">u32</span> <span class="n">on</span> <span class="o">=</span> <span class="n">param</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * make register setting for default</span>
<span class="cm">		 * (weak sig detect ON) come from INI file</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">m1ThreshLow</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">m1ThreshLow</span> <span class="o">:</span> <span class="n">m1ThreshLow_off</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">m2ThreshLow</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">m2ThreshLow</span> <span class="o">:</span> <span class="n">m2ThreshLow_off</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">m1Thresh</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">m1Thresh</span> <span class="o">:</span> <span class="n">m1Thresh_off</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">m2Thresh</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">m2Thresh</span> <span class="o">:</span> <span class="n">m2Thresh_off</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">m2CountThr</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">m2CountThr</span> <span class="o">:</span> <span class="n">m2CountThr_off</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">m2CountThrLow</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">m2CountThrLow</span> <span class="o">:</span> <span class="n">m2CountThrLow_off</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">m1ThreshLowExt</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">m1ThreshLowExt</span> <span class="o">:</span> <span class="n">m1ThreshLowExt_off</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">m2ThreshLowExt</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">m2ThreshLowExt</span> <span class="o">:</span> <span class="n">m2ThreshLowExt_off</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">m1ThreshExt</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">m1ThreshExt</span> <span class="o">:</span> <span class="n">m1ThreshExt_off</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">m2ThreshExt</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">m2ThreshExt</span> <span class="o">:</span> <span class="n">m2ThreshExt_off</span><span class="p">;</span>

		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW</span><span class="p">,</span>
			      <span class="n">AR_PHY_SFCORR_LOW_M1_THRESH_LOW</span><span class="p">,</span>
			      <span class="n">m1ThreshLow</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW</span><span class="p">,</span>
			      <span class="n">AR_PHY_SFCORR_LOW_M2_THRESH_LOW</span><span class="p">,</span>
			      <span class="n">m2ThreshLow</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR</span><span class="p">,</span>
			      <span class="n">AR_PHY_SFCORR_M1_THRESH</span><span class="p">,</span> <span class="n">m1Thresh</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR</span><span class="p">,</span>
			      <span class="n">AR_PHY_SFCORR_M2_THRESH</span><span class="p">,</span> <span class="n">m2Thresh</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR</span><span class="p">,</span>
			      <span class="n">AR_PHY_SFCORR_M2COUNT_THR</span><span class="p">,</span> <span class="n">m2CountThr</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW</span><span class="p">,</span>
			      <span class="n">AR_PHY_SFCORR_LOW_M2COUNT_THR_LOW</span><span class="p">,</span>
			      <span class="n">m2CountThrLow</span><span class="p">);</span>

		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT</span><span class="p">,</span>
			      <span class="n">AR_PHY_SFCORR_EXT_M1_THRESH_LOW</span><span class="p">,</span> <span class="n">m1ThreshLowExt</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT</span><span class="p">,</span>
			      <span class="n">AR_PHY_SFCORR_EXT_M2_THRESH_LOW</span><span class="p">,</span> <span class="n">m2ThreshLowExt</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT</span><span class="p">,</span>
			      <span class="n">AR_PHY_SFCORR_EXT_M1_THRESH</span><span class="p">,</span> <span class="n">m1ThreshExt</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT</span><span class="p">,</span>
			      <span class="n">AR_PHY_SFCORR_EXT_M2_THRESH</span><span class="p">,</span> <span class="n">m2ThreshExt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW</span><span class="p">,</span>
				    <span class="n">AR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW</span><span class="p">,</span>
				    <span class="n">AR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span> <span class="o">!=</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;** ch %d: ofdm weak signal: %s=&gt;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="o">!</span><span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span> <span class="o">?</span>
				<span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
				<span class="n">on</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_ofdmon</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_ofdmoff</span><span class="o">++</span><span class="p">;</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span> <span class="o">=</span> <span class="o">!</span><span class="n">on</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_FIRSTEP_LEVEL</span>:<span class="p">{</span>
		<span class="n">u32</span> <span class="n">level</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">firstep_table</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;ATH9K_ANI_FIRSTEP_LEVEL: level out of range (%u &gt; %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">firstep_table</span><span class="p">));</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * make register setting relative to default</span>
<span class="cm">		 * from INI file &amp; cap value</span>
<span class="cm">		 */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">firstep_table</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">-</span>
			<span class="n">firstep_table</span><span class="p">[</span><span class="n">ATH9K_ANI_FIRSTEP_LVL_NEW</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">firstep</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MIN</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MAX</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MAX</span><span class="p">;</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_FIND_SIG</span><span class="p">,</span>
			      <span class="n">AR_PHY_FIND_SIG_FIRSTEP</span><span class="p">,</span>
			      <span class="n">value</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * we need to set first step low register too</span>
<span class="cm">		 * make register setting relative to default</span>
<span class="cm">		 * from INI file &amp; cap value</span>
<span class="cm">		 */</span>
		<span class="n">value2</span> <span class="o">=</span> <span class="n">firstep_table</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">-</span>
			 <span class="n">firstep_table</span><span class="p">[</span><span class="n">ATH9K_ANI_FIRSTEP_LVL_NEW</span><span class="p">]</span> <span class="o">+</span>
			 <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">firstepLow</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value2</span> <span class="o">&lt;</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MIN</span><span class="p">)</span>
			<span class="n">value2</span> <span class="o">=</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value2</span> <span class="o">&gt;</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MAX</span><span class="p">)</span>
			<span class="n">value2</span> <span class="o">=</span> <span class="n">ATH9K_SIG_FIRSTEP_SETTING_MAX</span><span class="p">;</span>

		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_FIND_SIG_LOW</span><span class="p">,</span>
			      <span class="n">AR_PHY_FIND_SIG_FIRSTEP_LOW</span><span class="p">,</span> <span class="n">value2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;** ch %d: level %d=&gt;%d[def:%d] firstep[level]=%d ini=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span>
				<span class="n">ATH9K_ANI_FIRSTEP_LVL_NEW</span><span class="p">,</span>
				<span class="n">value</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">firstep</span><span class="p">);</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;** ch %d: level %d=&gt;%d[def:%d] firstep_low[level]=%d ini=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span>
				<span class="n">ATH9K_ANI_FIRSTEP_LVL_NEW</span><span class="p">,</span>
				<span class="n">value2</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">firstepLow</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_stepup</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_stepdown</span><span class="o">++</span><span class="p">;</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_SPUR_IMMUNITY_LEVEL</span>:<span class="p">{</span>
		<span class="n">u32</span> <span class="n">level</span> <span class="o">=</span> <span class="n">param</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cycpwrThr1_table</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;ATH9K_ANI_SPUR_IMMUNITY_LEVEL: level out of range (%u &gt; %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cycpwrThr1_table</span><span class="p">));</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * make register setting relative to default</span>
<span class="cm">		 * from INI file &amp; cap value</span>
<span class="cm">		 */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">cycpwrThr1_table</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">-</span>
			<span class="n">cycpwrThr1_table</span><span class="p">[</span><span class="n">ATH9K_ANI_SPUR_IMMUNE_LVL_NEW</span><span class="p">]</span> <span class="o">+</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">cycpwrThr1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MIN</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MAX</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MAX</span><span class="p">;</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TIMING5</span><span class="p">,</span>
			      <span class="n">AR_PHY_TIMING5_CYCPWR_THR1</span><span class="p">,</span>
			      <span class="n">value</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * set AR_PHY_EXT_CCA for extension channel</span>
<span class="cm">		 * make register setting relative to default</span>
<span class="cm">		 * from INI file &amp; cap value</span>
<span class="cm">		 */</span>
		<span class="n">value2</span> <span class="o">=</span> <span class="n">cycpwrThr1_table</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">-</span>
			 <span class="n">cycpwrThr1_table</span><span class="p">[</span><span class="n">ATH9K_ANI_SPUR_IMMUNE_LVL_NEW</span><span class="p">]</span> <span class="o">+</span>
			 <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">cycpwrThr1Ext</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value2</span> <span class="o">&lt;</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MIN</span><span class="p">)</span>
			<span class="n">value2</span> <span class="o">=</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MIN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value2</span> <span class="o">&gt;</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MAX</span><span class="p">)</span>
			<span class="n">value2</span> <span class="o">=</span> <span class="n">ATH9K_SIG_SPUR_IMM_SETTING_MAX</span><span class="p">;</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_EXT_CCA</span><span class="p">,</span>
			      <span class="n">AR_PHY_EXT_TIMING5_CYCPWR_THR1</span><span class="p">,</span> <span class="n">value2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">!=</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;** ch %d: level %d=&gt;%d[def:%d] cycpwrThr1[level]=%d ini=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span>
				<span class="n">ATH9K_ANI_SPUR_IMMUNE_LVL_NEW</span><span class="p">,</span>
				<span class="n">value</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">cycpwrThr1</span><span class="p">);</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
				<span class="s">&quot;** ch %d: level %d=&gt;%d[def:%d] cycpwrThr1Ext[level]=%d ini=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">,</span>
				<span class="n">level</span><span class="p">,</span>
				<span class="n">ATH9K_ANI_SPUR_IMMUNE_LVL_NEW</span><span class="p">,</span>
				<span class="n">value2</span><span class="p">,</span>
				<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">.</span><span class="n">cycpwrThr1Ext</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_spurup</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">)</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ast_ani_spurdown</span><span class="o">++</span><span class="p">;</span>
			<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_MRC_CCK</span>:
		<span class="cm">/*</span>
<span class="cm">		 * You should not see this as AR5008, AR9001, AR9002</span>
<span class="cm">		 * does not have hardware support for MRC CCK.</span>
<span class="cm">		 */</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH9K_ANI_PRESENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;invalid cmd %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span>
		<span class="s">&quot;ANI parameters: SI=%d, ofdmWS=%s FS=%d MRCcck=%s listenTime=%d ofdmErrs=%d cckErrs=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span><span class="p">,</span>
		<span class="o">!</span><span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span><span class="p">,</span>
		<span class="o">!</span><span class="n">aniState</span><span class="o">-&gt;</span><span class="n">mrcCCKOff</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">listenTime</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmPhyErrCount</span><span class="p">,</span>
		<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">cckPhyErrCount</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_do_getnf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			      <span class="kt">int16_t</span> <span class="n">nfarray</span><span class="p">[</span><span class="n">NUM_NF_READINGS</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">int16_t</span> <span class="n">nf</span><span class="p">;</span>

	<span class="n">nf</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CCA</span><span class="p">),</span> <span class="n">AR_PHY_MINCCA_PWR</span><span class="p">);</span>
	<span class="n">nfarray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign_extend32</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">nf</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CH1_CCA</span><span class="p">),</span> <span class="n">AR_PHY_CH1_MINCCA_PWR</span><span class="p">);</span>
	<span class="n">nfarray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign_extend32</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">nf</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CH2_CCA</span><span class="p">),</span> <span class="n">AR_PHY_CH2_MINCCA_PWR</span><span class="p">);</span>
	<span class="n">nfarray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign_extend32</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_CHAN_HT40</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">nf</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_EXT_CCA</span><span class="p">),</span> <span class="n">AR_PHY_EXT_MINCCA_PWR</span><span class="p">);</span>
	<span class="n">nfarray</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign_extend32</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">nf</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CH1_EXT_CCA</span><span class="p">),</span> <span class="n">AR_PHY_CH1_EXT_MINCCA_PWR</span><span class="p">);</span>
	<span class="n">nfarray</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign_extend32</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">nf</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CH2_EXT_CCA</span><span class="p">),</span> <span class="n">AR_PHY_CH2_EXT_MINCCA_PWR</span><span class="p">);</span>
	<span class="n">nfarray</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">sign_extend32</span><span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize the ANI register values with default (ini) values.</span>
<span class="cm"> * This routine is called during a (full) hardware reset after</span>
<span class="cm"> * all the registers are initialised from the INI.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_ani_cache_ini_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ar5416AniState</span> <span class="o">*</span><span class="n">aniState</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_ani_default</span> <span class="o">*</span><span class="n">iniDef</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iniDef</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">aniState</span><span class="o">-&gt;</span><span class="n">iniDef</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">ANI</span><span class="p">,</span> <span class="s">&quot;ver %d.%d opmode %u chan %d Mhz/0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span><span class="p">,</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macRev</span><span class="p">,</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">,</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channelFlags</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m1Thresh</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_M1_THRESH</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2Thresh</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_M2_THRESH</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2CountThr</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_M2COUNT_THR</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m1ThreshLow</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW_M1_THRESH_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2ThreshLow</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW_M2_THRESH_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2CountThrLow</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_LOW_M2COUNT_THR_LOW</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m1ThreshExt</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT_M1_THRESH</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2ThreshExt</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT_M2_THRESH</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m1ThreshLowExt</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT_M1_THRESH_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">m2ThreshLowExt</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_PHY_SFCORR_EXT_M2_THRESH_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">firstep</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					 <span class="n">AR_PHY_FIND_SIG</span><span class="p">,</span>
					 <span class="n">AR_PHY_FIND_SIG_FIRSTEP</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">firstepLow</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					    <span class="n">AR_PHY_FIND_SIG_LOW</span><span class="p">,</span>
					    <span class="n">AR_PHY_FIND_SIG_FIRSTEP_LOW</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">cycpwrThr1</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					    <span class="n">AR_PHY_TIMING5</span><span class="p">,</span>
					    <span class="n">AR_PHY_TIMING5_CYCPWR_THR1</span><span class="p">);</span>
	<span class="n">iniDef</span><span class="o">-&gt;</span><span class="n">cycpwrThr1Ext</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
					       <span class="n">AR_PHY_EXT_CCA</span><span class="p">,</span>
					       <span class="n">AR_PHY_EXT_TIMING5_CYCPWR_THR1</span><span class="p">);</span>

	<span class="cm">/* these levels just got reset to defaults by the INI */</span>
	<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">spurImmunityLevel</span> <span class="o">=</span> <span class="n">ATH9K_ANI_SPUR_IMMUNE_LVL_NEW</span><span class="p">;</span>
	<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">firstepLevel</span> <span class="o">=</span> <span class="n">ATH9K_ANI_FIRSTEP_LVL_NEW</span><span class="p">;</span>
	<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">ofdmWeakSigDetectOff</span> <span class="o">=</span> <span class="o">!</span><span class="n">ATH9K_ANI_USE_OFDM_WEAK_SIG</span><span class="p">;</span>
	<span class="n">aniState</span><span class="o">-&gt;</span><span class="n">mrcCCKOff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* not available on pre AR9003 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_set_nf_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_2g</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_MAX_GOOD_VAL_5416_2GHZ</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_2g</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_MIN_GOOD_VAL_5416_2GHZ</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_2g</span><span class="p">.</span><span class="n">nominal</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_NOM_VAL_5416_2GHZ</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_5g</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_MAX_GOOD_VAL_5416_5GHZ</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_5g</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_MIN_GOOD_VAL_5416_5GHZ</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_5g</span><span class="p">.</span><span class="n">nominal</span> <span class="o">=</span> <span class="n">AR_PHY_CCA_NOM_VAL_5416_5GHZ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_set_radar_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ath_hw_radar_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">radar_0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">radar_1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_ENA</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">AR_PHY_RADAR_0_ENA</span> <span class="o">|</span> <span class="n">AR_PHY_RADAR_0_FFT_ENA</span><span class="p">;</span>
	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">fir_power</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_FIRPWR</span><span class="p">);</span>
	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">radar_rssi</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_RRSSI</span><span class="p">);</span>
	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_height</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_HEIGHT</span><span class="p">);</span>
	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_rssi</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_PRSSI</span><span class="p">);</span>
	<span class="n">radar_0</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_inband</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0_INBAND</span><span class="p">);</span>

	<span class="n">radar_1</span> <span class="o">|=</span> <span class="n">AR_PHY_RADAR_1_MAX_RRSSI</span><span class="p">;</span>
	<span class="n">radar_1</span> <span class="o">|=</span> <span class="n">AR_PHY_RADAR_1_BLOCK_CHECK</span><span class="p">;</span>
	<span class="n">radar_1</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_maxlen</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_1_MAXLEN</span><span class="p">);</span>
	<span class="n">radar_1</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_inband_step</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_1_RELSTEP_THRESH</span><span class="p">);</span>
	<span class="n">radar_1</span> <span class="o">|=</span> <span class="n">SM</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">radar_inband</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_1_RELPWR_THRESH</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_0</span><span class="p">,</span> <span class="n">radar_0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_1</span><span class="p">,</span> <span class="n">radar_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">ext_channel</span><span class="p">)</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_EXT</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_EXT_ENA</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_EXT</span><span class="p">,</span> <span class="n">AR_PHY_RADAR_EXT_ENA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar5008_hw_set_radar_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw_radar_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">radar_conf</span><span class="p">;</span>

	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">fir_power</span> <span class="o">=</span> <span class="o">-</span><span class="mi">33</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">radar_rssi</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_height</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_rssi</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_inband</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_maxlen</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">pulse_inband_step</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">conf</span><span class="o">-&gt;</span><span class="n">radar_inband</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ar5008_hw_attach_phy_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw_private_ops</span> <span class="o">*</span><span class="n">priv_ops</span> <span class="o">=</span> <span class="n">ath9k_hw_private_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ar5416_cca_regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">AR_PHY_CCA</span><span class="p">,</span>
		<span class="n">AR_PHY_CH1_CCA</span><span class="p">,</span>
		<span class="n">AR_PHY_CH2_CCA</span><span class="p">,</span>
		<span class="n">AR_PHY_EXT_CCA</span><span class="p">,</span>
		<span class="n">AR_PHY_CH1_EXT_CCA</span><span class="p">,</span>
		<span class="n">AR_PHY_CH2_EXT_CCA</span>
	<span class="p">};</span>

	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">rf_set_freq</span> <span class="o">=</span> <span class="n">ar5008_hw_set_channel</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">spur_mitigate_freq</span> <span class="o">=</span> <span class="n">ar5008_hw_spur_mitigate</span><span class="p">;</span>

	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">rf_alloc_ext_banks</span> <span class="o">=</span> <span class="n">ar5008_hw_rf_alloc_ext_banks</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">rf_free_ext_banks</span> <span class="o">=</span> <span class="n">ar5008_hw_rf_free_ext_banks</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">set_rf_regs</span> <span class="o">=</span> <span class="n">ar5008_hw_set_rf_regs</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">set_channel_regs</span> <span class="o">=</span> <span class="n">ar5008_hw_set_channel_regs</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">init_bb</span> <span class="o">=</span> <span class="n">ar5008_hw_init_bb</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">process_ini</span> <span class="o">=</span> <span class="n">ar5008_hw_process_ini</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">set_rfmode</span> <span class="o">=</span> <span class="n">ar5008_hw_set_rfmode</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">mark_phy_inactive</span> <span class="o">=</span> <span class="n">ar5008_hw_mark_phy_inactive</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">set_delta_slope</span> <span class="o">=</span> <span class="n">ar5008_hw_set_delta_slope</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">rfbus_req</span> <span class="o">=</span> <span class="n">ar5008_hw_rfbus_req</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">rfbus_done</span> <span class="o">=</span> <span class="n">ar5008_hw_rfbus_done</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">restore_chainmask</span> <span class="o">=</span> <span class="n">ar5008_restore_chainmask</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">do_getnf</span> <span class="o">=</span> <span class="n">ar5008_hw_do_getnf</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">set_radar_params</span> <span class="o">=</span> <span class="n">ar5008_hw_set_radar_params</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modparam_force_new_ani</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">ani_control</span> <span class="o">=</span> <span class="n">ar5008_hw_ani_control_new</span><span class="p">;</span>
		<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">ani_cache_ini_regs</span> <span class="o">=</span> <span class="n">ar5008_hw_ani_cache_ini_regs</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">ani_control</span> <span class="o">=</span> <span class="n">ar5008_hw_ani_control_old</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9160_10_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">compute_pll_control</span> <span class="o">=</span> <span class="n">ar9160_hw_compute_pll_control</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">compute_pll_control</span> <span class="o">=</span> <span class="n">ar5008_hw_compute_pll_control</span><span class="p">;</span>

	<span class="n">ar5008_hw_set_nf_limits</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ar5008_hw_set_radar_conf</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_regs</span><span class="p">,</span> <span class="n">ar5416_cca_regs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">nf_regs</span><span class="p">));</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
