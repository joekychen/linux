<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;hw.h&quot;</span>
<span class="cp">#include &quot;hw-ops.h&quot;</span>
<span class="cp">#include &quot;rc.h&quot;</span>
<span class="cp">#include &quot;ar9003_mac.h&quot;</span>
<span class="cp">#include &quot;ar9003_mci.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;ath9k.h&quot;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">ath9k_hw_set_reset_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Atheros Communications&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Support for Atheros 802.11n wireless LAN cards.&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;Atheros 802.11n WLAN cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ath9k_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">ath9k_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ath9k_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ath9k_exit</span><span class="p">);</span>

<span class="cm">/* Private hardware callbacks */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_init_cal_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath9k_hw_private_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">init_cal_settings</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_init_mode_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath9k_hw_private_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">init_mode_regs</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ath9k_hw_compute_pll_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ath9k_hw_private_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">compute_pll_control</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_init_mode_gain_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_private_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">init_mode_gain_regs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ath9k_hw_private_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">init_mode_gain_regs</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_ani_cache_ini_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* You will not have this callback if using the old ANI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_private_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ani_cache_ini_regs</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ath9k_hw_private_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ani_cache_ini_regs</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********************/</span>
<span class="cm">/* Helper Functions */</span>
<span class="cm">/********************/</span>

<span class="cp">#ifdef CONFIG_ATH9K_DEBUGFS</span>

<span class="kt">void</span> <span class="nf">ath9k_debug_sync_cause</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sync_cause</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">sync_cause_all</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_RTC_IRQ</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">sync_rtc_irq</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_MAC_IRQ</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">sync_mac_irq</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_EEPROM_ILLEGAL_ACCESS</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">eeprom_illegal_access</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_APB_TIMEOUT</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">apb_timeout</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_PCI_MODE_CONFLICT</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">pci_mode_conflict</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_HOST1_FATAL</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">host1_fatal</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_HOST1_PERR</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">host1_perr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_TRCV_FIFO_PERR</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">trcv_fifo_perr</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_RADM_CPL_EP</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">radm_cpl_ep</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_RADM_CPL_DLLP_ABORT</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">radm_cpl_dllp_abort</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_RADM_CPL_TLP_ABORT</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">radm_cpl_tlp_abort</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_RADM_CPL_ECRC_ERR</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">radm_cpl_ecrc_err</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_RADM_CPL_TIMEOUT</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">radm_cpl_timeout</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_LOCAL_TIMEOUT</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">local_timeout</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_PM_ACCESS</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">pm_access</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_MAC_AWAKE</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">mac_awake</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_MAC_ASLEEP</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">mac_asleep</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sync_cause</span> <span class="o">&amp;</span> <span class="n">AR_INTR_SYNC_MAC_SLEEP_ACCESS</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">istats</span><span class="p">.</span><span class="n">mac_sleep_access</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_set_clockrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clockrate</span><span class="p">;</span>

	<span class="cm">/* AR9287 v1.3+ uses async FIFO and runs the MAC at 117 MHz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">AR_SREV_9287_13_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">clockrate</span> <span class="o">=</span> <span class="mi">117</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">)</span> <span class="cm">/* should really check for CCK instead */</span>
		<span class="n">clockrate</span> <span class="o">=</span> <span class="n">ATH9K_CLOCK_RATE_CCK</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="n">clockrate</span> <span class="o">=</span> <span class="n">ATH9K_CLOCK_RATE_2GHZ_OFDM</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_FASTCLOCK</span><span class="p">)</span>
		<span class="n">clockrate</span> <span class="o">=</span> <span class="n">ATH9K_CLOCK_FAST_RATE_5GHZ_OFDM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">clockrate</span> <span class="o">=</span> <span class="n">ATH9K_CLOCK_RATE_5GHZ_OFDM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht40</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
		<span class="n">clockrate</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HALF_RATE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">))</span>
			<span class="n">clockrate</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_QUARTER_RATE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">))</span>
			<span class="n">clockrate</span> <span class="o">/=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">clockrate</span> <span class="o">=</span> <span class="n">clockrate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ath9k_hw_mac_to_clks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">usecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">usecs</span> <span class="o">*</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">clockrate</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ath9k_hw_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="n">AH_TIME_QUANTUM</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">/</span> <span class="n">AH_TIME_QUANTUM</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="n">AH_TIME_QUANTUM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">ANY</span><span class="p">,</span>
		<span class="s">&quot;timeout (%d us) on reg 0x%x: 0x%08x &amp; 0x%08x != 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">timeout</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">),</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_wait</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_synth_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">hw_delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_B</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">hw_delay</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">hw_delay</span><span class="p">)</span> <span class="o">/</span> <span class="mi">22</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hw_delay</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HALF_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">hw_delay</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_QUARTER_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">hw_delay</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">hw_delay</span> <span class="o">+</span> <span class="n">BASE_ACTIVATE_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_write_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ar5416IniArray</span> <span class="o">*</span><span class="n">array</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">column</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">writecnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">array</span><span class="o">-&gt;</span><span class="n">ia_rows</span><span class="p">;</span> <span class="n">r</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">INI_RA</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			  <span class="n">INI_RA</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">column</span><span class="p">));</span>
		<span class="n">DO_DELAY</span><span class="p">(</span><span class="o">*</span><span class="n">writecnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ath9k_hw_reverse_bits</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">ath9k_hw_computetxtime</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kbps</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">frameLen</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rateix</span><span class="p">,</span>
			   <span class="n">bool</span> <span class="n">shortPreamble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bitsPerSymbol</span><span class="p">,</span> <span class="n">numBits</span><span class="p">,</span> <span class="n">numSymbols</span><span class="p">,</span> <span class="n">phyTime</span><span class="p">,</span> <span class="n">txTime</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kbps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_RC_PHY_CCK</span>:
		<span class="n">phyTime</span> <span class="o">=</span> <span class="n">CCK_PREAMBLE_BITS</span> <span class="o">+</span> <span class="n">CCK_PLCP_BITS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">shortPreamble</span><span class="p">)</span>
			<span class="n">phyTime</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">numBits</span> <span class="o">=</span> <span class="n">frameLen</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">txTime</span> <span class="o">=</span> <span class="n">CCK_SIFS_TIME</span> <span class="o">+</span> <span class="n">phyTime</span> <span class="o">+</span> <span class="p">((</span><span class="n">numBits</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">kbps</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_RC_PHY_OFDM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">&amp;&amp;</span> <span class="n">IS_CHAN_QUARTER_RATE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bitsPerSymbol</span> <span class="o">=</span>	<span class="p">(</span><span class="n">kbps</span> <span class="o">*</span> <span class="n">OFDM_SYMBOL_TIME_QUARTER</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">numBits</span> <span class="o">=</span> <span class="n">OFDM_PLCP_BITS</span> <span class="o">+</span> <span class="p">(</span><span class="n">frameLen</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">numSymbols</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">numBits</span><span class="p">,</span> <span class="n">bitsPerSymbol</span><span class="p">);</span>
			<span class="n">txTime</span> <span class="o">=</span> <span class="n">OFDM_SIFS_TIME_QUARTER</span>
				<span class="o">+</span> <span class="n">OFDM_PREAMBLE_TIME_QUARTER</span>
				<span class="o">+</span> <span class="p">(</span><span class="n">numSymbols</span> <span class="o">*</span> <span class="n">OFDM_SYMBOL_TIME_QUARTER</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">&amp;&amp;</span>
			   <span class="n">IS_CHAN_HALF_RATE</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bitsPerSymbol</span> <span class="o">=</span>	<span class="p">(</span><span class="n">kbps</span> <span class="o">*</span> <span class="n">OFDM_SYMBOL_TIME_HALF</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">numBits</span> <span class="o">=</span> <span class="n">OFDM_PLCP_BITS</span> <span class="o">+</span> <span class="p">(</span><span class="n">frameLen</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">numSymbols</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">numBits</span><span class="p">,</span> <span class="n">bitsPerSymbol</span><span class="p">);</span>
			<span class="n">txTime</span> <span class="o">=</span> <span class="n">OFDM_SIFS_TIME_HALF</span> <span class="o">+</span>
				<span class="n">OFDM_PREAMBLE_TIME_HALF</span>
				<span class="o">+</span> <span class="p">(</span><span class="n">numSymbols</span> <span class="o">*</span> <span class="n">OFDM_SYMBOL_TIME_HALF</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bitsPerSymbol</span> <span class="o">=</span> <span class="p">(</span><span class="n">kbps</span> <span class="o">*</span> <span class="n">OFDM_SYMBOL_TIME</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="n">numBits</span> <span class="o">=</span> <span class="n">OFDM_PLCP_BITS</span> <span class="o">+</span> <span class="p">(</span><span class="n">frameLen</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">numSymbols</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">numBits</span><span class="p">,</span> <span class="n">bitsPerSymbol</span><span class="p">);</span>
			<span class="n">txTime</span> <span class="o">=</span> <span class="n">OFDM_SIFS_TIME</span> <span class="o">+</span> <span class="n">OFDM_PREAMBLE_TIME</span>
				<span class="o">+</span> <span class="p">(</span><span class="n">numSymbols</span> <span class="o">*</span> <span class="n">OFDM_SYMBOL_TIME</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span>
			<span class="s">&quot;Unknown phy %u (rate ix %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span> <span class="n">rateix</span><span class="p">);</span>
		<span class="n">txTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">txTime</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_computetxtime</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_get_channel_centers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">chan_centers</span> <span class="o">*</span><span class="n">centers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int8_t</span> <span class="n">extoff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_CHAN_HT40</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">centers</span><span class="o">-&gt;</span><span class="n">ctl_center</span> <span class="o">=</span> <span class="n">centers</span><span class="o">-&gt;</span><span class="n">ext_center</span> <span class="o">=</span>
			<span class="n">centers</span><span class="o">-&gt;</span><span class="n">synth_center</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chanmode</span> <span class="o">==</span> <span class="n">CHANNEL_A_HT40PLUS</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chanmode</span> <span class="o">==</span> <span class="n">CHANNEL_G_HT40PLUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">centers</span><span class="o">-&gt;</span><span class="n">synth_center</span> <span class="o">=</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">+</span> <span class="n">HT40_CHANNEL_CENTER_SHIFT</span><span class="p">;</span>
		<span class="n">extoff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">centers</span><span class="o">-&gt;</span><span class="n">synth_center</span> <span class="o">=</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">-</span> <span class="n">HT40_CHANNEL_CENTER_SHIFT</span><span class="p">;</span>
		<span class="n">extoff</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">centers</span><span class="o">-&gt;</span><span class="n">ctl_center</span> <span class="o">=</span>
		<span class="n">centers</span><span class="o">-&gt;</span><span class="n">synth_center</span> <span class="o">-</span> <span class="p">(</span><span class="n">extoff</span> <span class="o">*</span> <span class="n">HT40_CHANNEL_CENTER_SHIFT</span><span class="p">);</span>
	<span class="cm">/* 25 MHz spacing is supported by hw but not on upper layers */</span>
	<span class="n">centers</span><span class="o">-&gt;</span><span class="n">ext_center</span> <span class="o">=</span>
		<span class="n">centers</span><span class="o">-&gt;</span><span class="n">synth_center</span> <span class="o">+</span> <span class="p">(</span><span class="n">extoff</span> <span class="o">*</span> <span class="n">HT40_CHANNEL_CENTER_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/******************/</span>
<span class="cm">/* Chip Revisions */</span>
<span class="cm">/******************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_read_revisions</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">devid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5416_AR9100_DEVID</span>:
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span> <span class="o">=</span> <span class="n">AR_SREV_VERSION_9100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR9300_DEVID_AR9330</span>:
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span> <span class="o">=</span> <span class="n">AR_SREV_VERSION_9330</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">get_mac_revision</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macRev</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">get_mac_revision</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SREV</span><span class="p">);</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macRev</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_SREV_REVISION2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR9300_DEVID_AR9340</span>:
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span> <span class="o">=</span> <span class="n">AR_SREV_VERSION_9340</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SREV</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macRev</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_SREV_REVISION2</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SREV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR_SREV_ID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SREV</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AR_SREV_VERSION2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">AR_SREV_TYPE2_S</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macRev</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_SREV_REVISION2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_pciexpress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_pciexpress</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span>
					     <span class="n">AR_SREV_TYPE2_HOST_MODE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR_SREV_VERSION</span><span class="p">);</span>

		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macRev</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="n">AR_SREV_REVISION</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span> <span class="o">==</span> <span class="n">AR_SREV_VERSION_5416_PCIE</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_pciexpress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/************************************/</span>
<span class="cm">/* HW Attach, Detach, Init Routines */</span>
<span class="cm">/************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_disablepcie</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_5416</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x9248fc00</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x24924924</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x28000029</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x57160824</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x25980579</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x1aaabe40</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0xbe105554</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x000e1007</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES2</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_aspm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="o">-&gt;</span><span class="n">aspm_init</span><span class="p">)</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="o">-&gt;</span><span class="n">aspm_init</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This should work for all families including legacy */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_hw_chip_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">regAddr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AR_STA_ID0</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">regHold</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">patternData</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x55555555</span><span class="p">,</span> <span class="mh">0xaaaaaaaa</span><span class="p">,</span> <span class="mh">0x66666666</span><span class="p">,</span> <span class="mh">0x99999999</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">loop_max</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">loop_max</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">regAddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR_PHY_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">loop_max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">regAddr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">u32</span> <span class="n">wrData</span><span class="p">,</span> <span class="n">rdData</span><span class="p">;</span>

		<span class="n">regHold</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wrData</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">wrData</span><span class="p">);</span>
			<span class="n">rdData</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdData</span> <span class="o">!=</span> <span class="n">wrData</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
					<span class="s">&quot;address test failed addr: 0x%08x - wr:0x%08x != rd:0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span> <span class="n">wrData</span><span class="p">,</span> <span class="n">rdData</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wrData</span> <span class="o">=</span> <span class="n">patternData</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">wrData</span><span class="p">);</span>
			<span class="n">rdData</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wrData</span> <span class="o">!=</span> <span class="n">rdData</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
					<span class="s">&quot;address test failed addr: 0x%08x - wr:0x%08x != rd:0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">addr</span><span class="p">,</span> <span class="n">wrData</span><span class="p">,</span> <span class="n">rdData</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">regAddr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">regHold</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_init_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">dma_beacon_response_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">sw_beacon_response_time</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">additional_swba_backoff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ack_6mb</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cwm_ignore_extcca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">pcie_clock_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">pcie_waen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">analog_shiftreg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">enable_ani</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR_EEPROM_MODAL_SPURS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">spurchans</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR_NO_SPUR</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">spurchans</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">AR_NO_SPUR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* PAPRD needs some more work to be enabled */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">paprd_disable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rx_intr_mitigation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">pcieSerDesWrite</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need this for PCI devices only (Cardbus, PCI, miniPCI)</span>
<span class="cm">	 * _and_ if on non-uniprocessor systems (Multiprocessor/HT).</span>
<span class="cm">	 * This means we use it for all AR5416 devices, and the few</span>
<span class="cm">	 * minor PCI AR9280 devices out there.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Serialization is required because these devices do not handle</span>
<span class="cm">	 * well the case of two concurrent reads/writes due to the latency</span>
<span class="cm">	 * involved. During one read/write another read/write can be issued</span>
<span class="cm">	 * on another CPU while the previous read/write may still be working</span>
<span class="cm">	 * on our hardware, if we hit this case the hardware poops in a loop.</span>
<span class="cm">	 * We prevent this by serializing reads and writes.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This issue is not present on PCI-Express devices or pre-AR5416</span>
<span class="cm">	 * devices (legacy, 802.11abg).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_possible_cpus</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">serialize_regmode</span> <span class="o">=</span> <span class="n">SER_REG_MODE_AUTO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_init_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_regulatory</span> <span class="o">*</span><span class="n">regulatory</span> <span class="o">=</span> <span class="n">ath9k_hw_regulatory</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">regulatory</span><span class="o">-&gt;</span><span class="n">country_code</span> <span class="o">=</span> <span class="n">CTRY_DEFAULT</span><span class="p">;</span>
	<span class="n">regulatory</span><span class="o">-&gt;</span><span class="n">power_limit</span> <span class="o">=</span> <span class="n">MAX_RATE_POWER</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">magic</span> <span class="o">=</span> <span class="n">AR5416_MAGIC</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">subvendorid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">atim_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">sta_id1_defaults</span> <span class="o">=</span>
		<span class="n">AR_STA_ID1_CRPT_MIC_ENABLE</span> <span class="o">|</span>
		<span class="n">AR_STA_ID1_MCAST_KSRCH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">sta_id1_defaults</span> <span class="o">|=</span> <span class="n">AR_STA_ID1_AR9100_BA_FIX</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">slottime</span> <span class="o">=</span> <span class="n">ATH9K_SLOT_TIME_9</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">globaltxtimeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">ATH9K_PM_UNDEFINED</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">htc_reset_init</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_hw_init_macaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eeval</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">EEP_MAC</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">EEP_MAC_LSW</span><span class="p">,</span> <span class="n">EEP_MAC_MID</span><span class="p">,</span> <span class="n">EEP_MAC_MSW</span> <span class="p">};</span>

	<span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eeval</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_MAC</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">eeval</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">eeval</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">eeval</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sum</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">sum</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRNOTAVAIL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_hw_post_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ecode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="o">-&gt;</span><span class="n">ath_bus_type</span> <span class="o">!=</span> <span class="n">ATH_USB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_chip_test</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ecode</span> <span class="o">=</span> <span class="n">ar9002_hw_rf_claim</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ecode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ecode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ecode</span> <span class="o">=</span> <span class="n">ath9k_hw_eeprom_init</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ecode</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;Eeprom VER: %d, REV: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom_ver</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom_rev</span><span class="p">(</span><span class="n">ah</span><span class="p">));</span>

	<span class="n">ecode</span> <span class="o">=</span> <span class="n">ath9k_hw_rf_alloc_ext_banks</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span>
			<span class="s">&quot;Failed allocating banks for external radio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ath9k_hw_rf_free_ext_banks</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ecode</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">enable_ani</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath9k_hw_ani_setup</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">ath9k_hw_ani_init</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_attach_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ar9003_hw_attach_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ar9002_hw_attach_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called for all hardware families */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ath9k_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ath9k_hw_read_revisions</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read back AR_WA into a permanent copy and set bits 14 and 17.</span>
<span class="cm">	 * We need to do this to avoid RMW of this register. We cannot</span>
<span class="cm">	 * read the reg when chip is asleep.</span>
<span class="cm">	 */</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">WARegVal</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_WA</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">WARegVal</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AR_WA_D3_L1_DISABLE</span> <span class="o">|</span>
			 <span class="n">AR_WA_ASPM_TIMER_BASED_DISABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_set_reset_reg</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_RESET_POWER_ON</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t reset chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">WARegVal</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR_WA_D3_L1_DISABLE</span><span class="p">;</span>

	<span class="n">ath9k_hw_init_defaults</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_hw_init_config</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ath9k_hw_attach_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t wakeup chip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NR_CPUS</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">serialize_regmode</span> <span class="o">==</span> <span class="n">SER_REG_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span> <span class="o">==</span> <span class="n">AR_SREV_VERSION_5416_PCI</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">AR_SREV_9160</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9280</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9287</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_pciexpress</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">serialize_regmode</span> <span class="o">=</span>
				<span class="n">SER_REG_MODE_ON</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">serialize_regmode</span> <span class="o">=</span>
				<span class="n">SER_REG_MODE_OFF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;serialize_regmode is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">serialize_regmode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">max_txtrig_level</span> <span class="o">=</span> <span class="n">MAX_TX_FIFO_THRESHOLD</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">max_txtrig_level</span> <span class="o">=</span> <span class="n">MAX_TX_FIFO_THRESHOLD</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_5416_PCI</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_5416_PCIE</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9160</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9100</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9280</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9285</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9287</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9271</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9300</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9330</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9485</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9340</span>:
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9462</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Mac Chip Rev 0x%02x.%x is not supported by this driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macRev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_pciexpress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">phyRev</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CHIP_ID</span><span class="p">);</span>
	<span class="n">ath9k_hw_init_cal_settings</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_function</span> <span class="o">=</span> <span class="n">ATH9K_ANI_ALL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_function</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_ANI_NOISE_IMMUNITY_LEVEL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ani_function</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_ANI_MRC_CCK</span><span class="p">;</span>

	<span class="cm">/* disable ANI for 9340 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">enable_ani</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ath9k_hw_init_mode_regs</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_pciexpress</span><span class="p">)</span>
		<span class="n">ath9k_hw_disablepcie</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_hw_post_init</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ath9k_hw_init_mode_gain_regs</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_hw_fill_cap_info</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_pciexpress</span><span class="p">)</span>
		<span class="n">ath9k_hw_aspm_init</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_hw_init_macaddr</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Failed to initialize MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_trig_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">AR_FTRIG_256B</span> <span class="o">&gt;&gt;</span> <span class="n">AR_FTRIG_S</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_trig_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">AR_FTRIG_512B</span> <span class="o">&gt;&gt;</span> <span class="n">AR_FTRIG_S</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bb_watchdog_timeout_ms</span> <span class="o">=</span> <span class="mi">85</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">bb_watchdog_timeout_ms</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ATH_HW_INITIALIZED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/* These are all the AR5008/AR9001/AR9002 hardware family of chipsets */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">devid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AR5416_DEVID_PCI</span>:
	<span class="k">case</span> <span class="n">AR5416_DEVID_PCIE</span>:
	<span class="k">case</span> <span class="n">AR5416_AR9100_DEVID</span>:
	<span class="k">case</span> <span class="n">AR9160_DEVID_PCI</span>:
	<span class="k">case</span> <span class="n">AR9280_DEVID_PCI</span>:
	<span class="k">case</span> <span class="n">AR9280_DEVID_PCIE</span>:
	<span class="k">case</span> <span class="n">AR9285_DEVID_PCIE</span>:
	<span class="k">case</span> <span class="n">AR9287_DEVID_PCI</span>:
	<span class="k">case</span> <span class="n">AR9287_DEVID_PCIE</span>:
	<span class="k">case</span> <span class="n">AR2427_DEVID_PCIE</span>:
	<span class="k">case</span> <span class="n">AR9300_DEVID_PCIE</span>:
	<span class="k">case</span> <span class="n">AR9300_DEVID_AR9485_PCIE</span>:
	<span class="k">case</span> <span class="n">AR9300_DEVID_AR9330</span>:
	<span class="k">case</span> <span class="n">AR9300_DEVID_AR9340</span>:
	<span class="k">case</span> <span class="n">AR9300_DEVID_AR9580</span>:
	<span class="k">case</span> <span class="n">AR9300_DEVID_AR9462</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="o">-&gt;</span><span class="n">ath_bus_type</span> <span class="o">==</span> <span class="n">ATH_USB</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Hardware device ID 0x%04x not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">devid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__ath9k_hw_init</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;Unable to initialize hardware; initialization status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_init_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MIC_QOS_CONTROL</span><span class="p">,</span> <span class="mh">0x100aa</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MIC_QOS_SELECT</span><span class="p">,</span> <span class="mh">0x3210</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_QOS_NO_ACK</span><span class="p">,</span>
		  <span class="n">SM</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">AR_QOS_NO_ACK_TWO_BIT</span><span class="p">)</span> <span class="o">|</span>
		  <span class="n">SM</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">AR_QOS_NO_ACK_BIT_OFF</span><span class="p">)</span> <span class="o">|</span>
		  <span class="n">SM</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">AR_QOS_NO_ACK_BYTE_OFF</span><span class="p">));</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TXOP_X</span><span class="p">,</span> <span class="n">AR_TXOP_X_VAL</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TXOP_0_3</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TXOP_4_7</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TXOP_8_11</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TXOP_12_15</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ar9003_get_pll_sqsum_dvc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">PLL3</span><span class="p">,</span> <span class="n">PLL3_DO_MEAS_MASK</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">PLL3</span><span class="p">,</span> <span class="n">PLL3_DO_MEAS_MASK</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">PLL4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PLL4_MEAS_DONE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;PLL4 meaurement not done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">PLL3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SQSUM_DVC_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ar9003_get_pll_sqsum_dvc</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_init_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">pll</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>

		<span class="cm">/* program BB PLL ki and kd value, ki=0x4, kd=0x40 */</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL2</span><span class="p">,</span>
			      <span class="n">AR_CH0_BB_DPLL2_PLL_PWD</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL2</span><span class="p">,</span>
			      <span class="n">AR_CH0_DPLL2_KD</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL2</span><span class="p">,</span>
			      <span class="n">AR_CH0_DPLL2_KI</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>

		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL1</span><span class="p">,</span>
			      <span class="n">AR_CH0_BB_DPLL1_REFDIV</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL1</span><span class="p">,</span>
			      <span class="n">AR_CH0_BB_DPLL1_NINI</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL1</span><span class="p">,</span>
			      <span class="n">AR_CH0_BB_DPLL1_NFRAC</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL2</span><span class="p">,</span>
			      <span class="n">AR_CH0_BB_DPLL2_OUTDIV</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL2</span><span class="p">,</span>
			      <span class="n">AR_CH0_BB_DPLL2_LOCAL_PLL</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL2</span><span class="p">,</span>
			      <span class="n">AR_CH0_BB_DPLL2_EN_NEGTRIG</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

		<span class="cm">/* program BB PLL phase_shift to 0x6 */</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL3</span><span class="p">,</span>
			      <span class="n">AR_CH0_BB_DPLL3_PHASE_SHIFT</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">);</span>

		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL2</span><span class="p">,</span>
			      <span class="n">AR_CH0_BB_DPLL2_PLL_PWD</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ddr_dpll2</span><span class="p">,</span> <span class="n">pll_control2</span><span class="p">,</span> <span class="n">kd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_clk_25mhz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ddr_dpll2</span> <span class="o">=</span> <span class="mh">0x18e82f01</span><span class="p">;</span>
			<span class="n">pll_control2</span> <span class="o">=</span> <span class="mh">0xe04a3d</span><span class="p">;</span>
			<span class="n">kd</span> <span class="o">=</span> <span class="mh">0x1d</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ddr_dpll2</span> <span class="o">=</span> <span class="mh">0x19e82f01</span><span class="p">;</span>
			<span class="n">pll_control2</span> <span class="o">=</span> <span class="mh">0x886666</span><span class="p">;</span>
			<span class="n">kd</span> <span class="o">=</span> <span class="mh">0x3d</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* program DDR PLL ki and kd value */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_DDR_DPLL2</span><span class="p">,</span> <span class="n">ddr_dpll2</span><span class="p">);</span>

		<span class="cm">/* program DDR PLL phase_shift */</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_DDR_DPLL3</span><span class="p">,</span>
			      <span class="n">AR_CH0_DPLL3_PHASE_SHIFT</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_PLL_CONTROL</span><span class="p">,</span> <span class="mh">0x1142c</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		<span class="cm">/* program refdiv, nint, frac to RTC register */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_PLL_CONTROL2</span><span class="p">,</span> <span class="n">pll_control2</span><span class="p">);</span>

		<span class="cm">/* program BB PLL kd and ki value */</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL2</span><span class="p">,</span> <span class="n">AR_CH0_DPLL2_KD</span><span class="p">,</span> <span class="n">kd</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL2</span><span class="p">,</span> <span class="n">AR_CH0_DPLL2_KI</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>

		<span class="cm">/* program BB PLL phase_shift */</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CH0_BB_DPLL3</span><span class="p">,</span>
			      <span class="n">AR_CH0_BB_DPLL3_PHASE_SHIFT</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">regval</span><span class="p">,</span> <span class="n">pll2_divint</span><span class="p">,</span> <span class="n">pll2_divfrac</span><span class="p">,</span> <span class="n">refdiv</span><span class="p">;</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_PLL_CONTROL</span><span class="p">,</span> <span class="mh">0x1142c</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PLL_MODE</span><span class="p">,</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_clk_25mhz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pll2_divint</span> <span class="o">=</span> <span class="mh">0x54</span><span class="p">;</span>
			<span class="n">pll2_divfrac</span> <span class="o">=</span> <span class="mh">0x1eb85</span><span class="p">;</span>
			<span class="n">refdiv</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pll2_divint</span> <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>
			<span class="n">pll2_divfrac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">refdiv</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">regval</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PLL_MODE</span><span class="p">);</span>
		<span class="n">regval</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PLL_MODE</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PLL_CONTROL</span><span class="p">,</span> <span class="p">(</span><span class="n">refdiv</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="n">pll2_divint</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">|</span> <span class="n">pll2_divfrac</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="n">regval</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PLL_MODE</span><span class="p">);</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="mh">0x80071fff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="mh">0x4</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x18</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PLL_MODE</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PLL_MODE</span><span class="p">,</span>
			  <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PLL_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffeffff</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pll</span> <span class="o">=</span> <span class="n">ath9k_hw_compute_pll_control</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_PLL_CONTROL</span><span class="p">,</span> <span class="n">pll</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* Switch the core clock for ar9271 to 117Mhz */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mh">0x50040</span><span class="p">,</span> <span class="mh">0x304</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">RTC_PLL_SETTLE_DELAY</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_SLEEP_CLK</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_DERIVED_CLK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_clk_25mhz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_DERIVED_CLK</span><span class="p">,</span> <span class="mh">0x17c</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SLP32_MODE</span><span class="p">,</span> <span class="mh">0x0010f3d7</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>  <span class="n">AR_SLP32_INC</span><span class="p">,</span> <span class="mh">0x0001e7ae</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_DERIVED_CLK</span><span class="p">,</span> <span class="mh">0x261</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SLP32_MODE</span><span class="p">,</span> <span class="mh">0x0010f400</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>  <span class="n">AR_SLP32_INC</span><span class="p">,</span> <span class="mh">0x0001e800</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_init_interrupt_masks</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">opmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sync_default</span> <span class="o">=</span> <span class="n">AR_INTR_SYNC_DEFAULT</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">imr_reg</span> <span class="o">=</span> <span class="n">AR_IMR_TXERR</span> <span class="o">|</span>
		<span class="n">AR_IMR_TXURN</span> <span class="o">|</span>
		<span class="n">AR_IMR_RXERR</span> <span class="o">|</span>
		<span class="n">AR_IMR_RXORN</span> <span class="o">|</span>
		<span class="n">AR_IMR_BCNMISC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">sync_default</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR_INTR_SYNC_HOST1_FATAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">imr_reg</span> <span class="o">|=</span> <span class="n">AR_IMR_RXOK_HP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rx_intr_mitigation</span><span class="p">)</span>
			<span class="n">imr_reg</span> <span class="o">|=</span> <span class="n">AR_IMR_RXINTM</span> <span class="o">|</span> <span class="n">AR_IMR_RXMINTR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">imr_reg</span> <span class="o">|=</span> <span class="n">AR_IMR_RXOK_LP</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rx_intr_mitigation</span><span class="p">)</span>
			<span class="n">imr_reg</span> <span class="o">|=</span> <span class="n">AR_IMR_RXINTM</span> <span class="o">|</span> <span class="n">AR_IMR_RXMINTR</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">imr_reg</span> <span class="o">|=</span> <span class="n">AR_IMR_RXOK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_intr_mitigation</span><span class="p">)</span>
		<span class="n">imr_reg</span> <span class="o">|=</span> <span class="n">AR_IMR_TXINTM</span> <span class="o">|</span> <span class="n">AR_IMR_TXMINTR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">imr_reg</span> <span class="o">|=</span> <span class="n">AR_IMR_TXOK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
		<span class="n">imr_reg</span> <span class="o">|=</span> <span class="n">AR_IMR_MIB</span><span class="p">;</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_IMR</span><span class="p">,</span> <span class="n">imr_reg</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">imrs2_reg</span> <span class="o">|=</span> <span class="n">AR_IMR_S2_GTT</span><span class="p">;</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_IMR_S2</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">imrs2_reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_INTR_SYNC_CAUSE</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_INTR_SYNC_ENABLE</span><span class="p">,</span> <span class="n">sync_default</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_INTR_SYNC_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_INTR_PRIO_ASYNC_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_INTR_PRIO_ASYNC_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_INTR_PRIO_SYNC_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_INTR_PRIO_SYNC_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_set_sifs_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ath9k_hw_mac_to_clks</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">us</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_D_GBL_IFS_SIFS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_setslottime</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ath9k_hw_mac_to_clks</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_D_GBL_IFS_SLOT</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_set_ack_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ath9k_hw_mac_to_clks</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">MS</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">AR_TIME_OUT_ACK</span><span class="p">));</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TIME_OUT</span><span class="p">,</span> <span class="n">AR_TIME_OUT_ACK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_set_cts_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">us</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">ath9k_hw_mac_to_clks</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">us</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">MS</span><span class="p">(</span><span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">AR_TIME_OUT_CTS</span><span class="p">));</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TIME_OUT</span><span class="p">,</span> <span class="n">AR_TIME_OUT_CTS</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_hw_set_global_txtimeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tu</span> <span class="o">&gt;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">XMIT</span><span class="p">,</span> <span class="s">&quot;bad global tx timeout %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tu</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">globaltxtimeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_GTXTO</span><span class="p">,</span> <span class="n">AR_GTXTO_TIMEOUT_LIMIT</span><span class="p">,</span> <span class="n">tu</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">globaltxtimeout</span> <span class="o">=</span> <span class="n">tu</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_init_global_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">acktimeout</span><span class="p">,</span> <span class="n">ctstimeout</span><span class="p">,</span> <span class="n">ack_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slottime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sifstime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_lat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tx_lat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eifs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;ah-&gt;misc_mode 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">misc_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">misc_mode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCU_MISC</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">misc_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_A_FAST_CLOCK</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
		<span class="n">rx_lat</span> <span class="o">=</span> <span class="mi">41</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rx_lat</span> <span class="o">=</span> <span class="mi">37</span><span class="p">;</span>
	<span class="n">tx_lat</span> <span class="o">=</span> <span class="mi">54</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_5GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">sifstime</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sifstime</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HALF_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">eifs</span> <span class="o">=</span> <span class="mi">175</span><span class="p">;</span>
		<span class="n">rx_lat</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">tx_lat</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_A_FAST_CLOCK</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
		    <span class="n">tx_lat</span> <span class="o">+=</span> <span class="mi">11</span><span class="p">;</span>

		<span class="n">sifstime</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ack_offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">slottime</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_QUARTER_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">eifs</span> <span class="o">=</span> <span class="mi">340</span><span class="p">;</span>
		<span class="n">rx_lat</span> <span class="o">=</span> <span class="p">(</span><span class="n">rx_lat</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tx_lat</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_A_FAST_CLOCK</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
		    <span class="n">tx_lat</span> <span class="o">+=</span> <span class="mi">22</span><span class="p">;</span>

		<span class="n">sifstime</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ack_offset</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">slottime</span> <span class="o">=</span> <span class="mi">21</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">AR_SREV_9287_13_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">eifs</span> <span class="o">=</span> <span class="n">AR_D_GBL_IFS_EIFS_ASYNC_FIFO</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">AR_USEC_ASYNC_FIFO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">eifs</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_D_GBL_IFS_EIFS</span><span class="p">)</span><span class="o">/</span>
				<span class="n">common</span><span class="o">-&gt;</span><span class="n">clockrate</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_USEC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rx_lat</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">AR_USEC_RX_LAT</span><span class="p">);</span>
		<span class="n">tx_lat</span> <span class="o">=</span> <span class="n">MS</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">AR_USEC_TX_LAT</span><span class="p">);</span>

		<span class="n">slottime</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">slottime</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* As defined by IEEE 802.11-2007 17.3.8.6 */</span>
	<span class="n">acktimeout</span> <span class="o">=</span> <span class="n">slottime</span> <span class="o">+</span> <span class="n">sifstime</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">coverage_class</span> <span class="o">+</span> <span class="n">ack_offset</span><span class="p">;</span>
	<span class="n">ctstimeout</span> <span class="o">=</span> <span class="n">acktimeout</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Workaround for early ACK timeouts, add an offset to match the</span>
<span class="cm">	 * initval&#39;s 64us ack timeout value. Use 48us for the CTS timeout.</span>
<span class="cm">	 * This was initially only meant to work around an issue with delayed</span>
<span class="cm">	 * BA frames in some implementations, but it has been found to fix ACK</span>
<span class="cm">	 * timeout issues in other cases as well.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;&amp;</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">IS_CHAN_HALF_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_CHAN_QUARTER_RATE</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">acktimeout</span> <span class="o">+=</span> <span class="mi">64</span> <span class="o">-</span> <span class="n">sifstime</span> <span class="o">-</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">slottime</span><span class="p">;</span>
		<span class="n">ctstimeout</span> <span class="o">+=</span> <span class="mi">48</span> <span class="o">-</span> <span class="n">sifstime</span> <span class="o">-</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">slottime</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">ath9k_hw_set_sifs_time</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sifstime</span><span class="p">);</span>
	<span class="n">ath9k_hw_setslottime</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">slottime</span><span class="p">);</span>
	<span class="n">ath9k_hw_set_ack_timeout</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">acktimeout</span><span class="p">);</span>
	<span class="n">ath9k_hw_set_cts_timeout</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ctstimeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">globaltxtimeout</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">ath9k_hw_set_global_txtimeout</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">globaltxtimeout</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_D_GBL_IFS_EIFS</span><span class="p">,</span> <span class="n">ath9k_hw_mac_to_clks</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">eifs</span><span class="p">));</span>
	<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_USEC</span><span class="p">,</span>
		<span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">clockrate</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">SM</span><span class="p">(</span><span class="n">rx_lat</span><span class="p">,</span> <span class="n">AR_USEC_RX_LAT</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">SM</span><span class="p">(</span><span class="n">tx_lat</span><span class="p">,</span> <span class="n">AR_USEC_TX_LAT</span><span class="p">),</span>
		<span class="n">AR_USEC_TX_LAT</span> <span class="o">|</span> <span class="n">AR_USEC_RX_LAT</span> <span class="o">|</span> <span class="n">AR_USEC_USEC</span><span class="p">);</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_init_global_settings</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_deinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">ATH_HW_INITIALIZED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_hw</span><span class="p">;</span>

	<span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_PM_FULL_SLEEP</span><span class="p">);</span>

<span class="nl">free_hw:</span>
	<span class="n">ath9k_hw_rf_free_ext_banks</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_deinit</span><span class="p">);</span>

<span class="cm">/*******/</span>
<span class="cm">/* INI */</span>
<span class="cm">/*******/</span>

<span class="n">u32</span> <span class="nf">ath9k_regd_get_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_regulatory</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctl</span> <span class="o">=</span> <span class="n">ath_regd_get_band_ctl</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_B</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">CTL_11B</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_G</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">CTL_11G</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">CTL_11A</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ctl</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************/</span>
<span class="cm">/* Reset and Channel Switching Routines */</span>
<span class="cm">/****************************************/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ath9k_hw_set_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * set AHB_MODE not to do cacheline prefetches</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_AHB_MODE</span><span class="p">,</span> <span class="n">AR_AHB_PREFETCH_RD_EN</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * let mac dma reads be in 128 byte chunks</span>
<span class="cm">	 */</span>
	<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TXCFG</span><span class="p">,</span> <span class="n">AR_TXCFG_DMASZ_128B</span><span class="p">,</span> <span class="n">AR_TXCFG_DMASZ_MASK</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Restore TX Trigger Level to its pre-reset value.</span>
<span class="cm">	 * The initial value depends on whether aggregation is enabled, and is</span>
<span class="cm">	 * adjusted whenever underruns are detected.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TXCFG</span><span class="p">,</span> <span class="n">AR_FTRIG</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">tx_trig_level</span><span class="p">);</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * let mac dma writes be in 128 byte chunks</span>
<span class="cm">	 */</span>
	<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RXCFG</span><span class="p">,</span> <span class="n">AR_RXCFG_DMASZ_128B</span><span class="p">,</span> <span class="n">AR_RXCFG_DMASZ_MASK</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup receive FIFO threshold to hold off TX activities</span>
<span class="cm">	 */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RXFIFO_CFG</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RXBP_THRESH</span><span class="p">,</span> <span class="n">AR_RXBP_THRESH_HP</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RXBP_THRESH</span><span class="p">,</span> <span class="n">AR_RXBP_THRESH_LP</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

		<span class="n">ath9k_hw_set_rx_bufsize</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">rx_bufsize</span> <span class="o">-</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">rx_status_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * reduce the number of usable entries in PCU TXBUF to avoid</span>
<span class="cm">	 * wrap around issues.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* For AR9285 the number of Fifos are reduced to half.</span>
<span class="cm">		 * So set the usable tx buf size also to half to</span>
<span class="cm">		 * avoid data/delimiter underruns</span>
<span class="cm">		 */</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCU_TXBUF_CTRL</span><span class="p">,</span>
			  <span class="n">AR_9285_PCU_TXBUF_CTRL_USABLE_SIZE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCU_TXBUF_CTRL</span><span class="p">,</span>
			  <span class="n">AR_PCU_TXBUF_CTRL_USABLE_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ath9k_hw_reset_txstatus_ring</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_set_operating_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">opmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">AR_STA_ID1_STA_AP</span> <span class="o">|</span> <span class="n">AR_STA_ID1_ADHOC</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">set</span> <span class="o">=</span> <span class="n">AR_STA_ID1_KSRCH_MODE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">opmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="n">set</span> <span class="o">|=</span> <span class="n">AR_STA_ID1_ADHOC</span><span class="p">;</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CFG</span><span class="p">,</span> <span class="n">AR_CFG_AP_ADHOC_INDICATION</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">set</span> <span class="o">|=</span> <span class="n">AR_STA_ID1_STA_AP</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CFG</span><span class="p">,</span> <span class="n">AR_CFG_AP_ADHOC_INDICATION</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_monitoring</span><span class="p">)</span>
			<span class="n">set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_STA_ID1</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_get_delta_slope_vals</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">coef_scaled</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="o">*</span><span class="n">coef_mantissa</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">coef_exponent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">coef_exp</span><span class="p">,</span> <span class="n">coef_man</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">coef_exp</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">coef_exp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">coef_exp</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">coef_scaled</span> <span class="o">&gt;&gt;</span> <span class="n">coef_exp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">coef_exp</span> <span class="o">=</span> <span class="mi">14</span> <span class="o">-</span> <span class="p">(</span><span class="n">coef_exp</span> <span class="o">-</span> <span class="n">COEF_SCALE_S</span><span class="p">);</span>

	<span class="n">coef_man</span> <span class="o">=</span> <span class="n">coef_scaled</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">COEF_SCALE_S</span> <span class="o">-</span> <span class="n">coef_exp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="o">*</span><span class="n">coef_mantissa</span> <span class="o">=</span> <span class="n">coef_man</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">COEF_SCALE_S</span> <span class="o">-</span> <span class="n">coef_exp</span><span class="p">);</span>
	<span class="o">*</span><span class="n">coef_exponent</span> <span class="o">=</span> <span class="n">coef_exp</span> <span class="o">-</span> <span class="mi">16</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_hw_set_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rst_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmpReg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_DERIVED_CLK</span><span class="p">,</span>
			      <span class="n">AR_RTC_DERIVED_CLK_PERIOD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_DERIVED_CLK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_WA</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">WARegVal</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_WAKE</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_WAKE_EN</span> <span class="o">|</span>
		  <span class="n">AR_RTC_FORCE_WAKE_ON_INT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rst_flags</span> <span class="o">=</span> <span class="n">AR_RTC_RC_MAC_WARM</span> <span class="o">|</span> <span class="n">AR_RTC_RC_MAC_COLD</span> <span class="o">|</span>
			<span class="n">AR_RTC_RC_COLD_RESET</span> <span class="o">|</span> <span class="n">AR_RTC_RC_WARM_RESET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmpReg</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_INTR_SYNC_CAUSE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmpReg</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">AR_INTR_SYNC_LOCAL_TIMEOUT</span> <span class="o">|</span>
		     <span class="n">AR_INTR_SYNC_RADM_CPL_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_INTR_SYNC_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">val</span> <span class="o">=</span> <span class="n">AR_RC_HOSTIF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">AR_RC_AHB</span><span class="p">;</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RC</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RC</span><span class="p">,</span> <span class="n">AR_RC_AHB</span><span class="p">);</span>

		<span class="n">rst_flags</span> <span class="o">=</span> <span class="n">AR_RTC_RC_MAC_WARM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ATH9K_RESET_COLD</span><span class="p">)</span>
			<span class="n">rst_flags</span> <span class="o">|=</span> <span class="n">AR_RTC_RC_MAC_COLD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">npend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* AR9330 WAR:</span>
<span class="cm">		 * call external reset function to reset WMAC if:</span>
<span class="cm">		 * - doing a cold reset</span>
<span class="cm">		 * - we have pending frames in the TX queues</span>
<span class="cm">		 */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR_NUM_QCU</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">npend</span> <span class="o">=</span> <span class="n">ath9k_hw_numtxpending</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">npend</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">external_reset</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">npend</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">ATH9K_RESET_COLD</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">reset_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">RESET</span><span class="p">,</span>
				<span class="s">&quot;reset MAC via external reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">reset_err</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">external_reset</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reset_err</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span>
					<span class="s">&quot;External reset failed, err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">reset_err</span><span class="p">);</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_RC</span><span class="p">,</span> <span class="n">rst_flags</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_RC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_wait</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_RC</span><span class="p">,</span> <span class="n">AR_RTC_RC_M</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">AH_WAIT_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;RTC stuck in MAC reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_hw_set_reset_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_WA</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">WARegVal</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_WAKE</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_WAKE_EN</span> <span class="o">|</span>
		  <span class="n">AR_RTC_FORCE_WAKE_ON_INT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RC</span><span class="p">,</span> <span class="n">AR_RC_AHB</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_RESET</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_wait</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			   <span class="n">AR_RTC_STATUS</span><span class="p">,</span>
			   <span class="n">AR_RTC_STATUS_M</span><span class="p">,</span>
			   <span class="n">AR_RTC_STATUS_ON</span><span class="p">,</span>
			   <span class="n">AH_WAIT_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;RTC not waking up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ath9k_hw_set_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_RESET_WARM</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_hw_set_reset_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_WA</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">WARegVal</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_WAKE</span><span class="p">,</span>
		  <span class="n">AR_RTC_FORCE_WAKE_EN</span> <span class="o">|</span> <span class="n">AR_RTC_FORCE_WAKE_ON_INT</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATH9K_RESET_POWER_ON</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_set_reset_power_on</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH9K_RESET_WARM</span>:
	<span class="k">case</span> <span class="n">ATH9K_RESET_COLD</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_set_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_MCI</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_KEEP_AWAKE</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_hw_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reset_type</span> <span class="o">=</span> <span class="n">ATH9K_RESET_WARM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_OL_PWRCTRL</span><span class="p">))</span>
			<span class="n">reset_type</span> <span class="o">=</span> <span class="n">ATH9K_RESET_POWER_ON</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reset_type</span> <span class="o">=</span> <span class="n">ATH9K_RESET_COLD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_set_reset_reg</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reset_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">chip_fullsleep</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ar9003_hw_internal_regulator_apply</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_hw_init_pll</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">ath9k_hw_set_rfmode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_hw_channel_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">qnum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">edma</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_EDMA</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">band_switch</span><span class="p">,</span> <span class="n">mode_diff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ini_reloaded</span><span class="p">;</span>

	<span class="n">band_switch</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">channelFlags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CHANNEL_2GHZ</span> <span class="o">|</span> <span class="n">CHANNEL_5GHZ</span><span class="p">))</span> <span class="o">!=</span>
		      <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">channelFlags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CHANNEL_2GHZ</span> <span class="o">|</span>
						    <span class="n">CHANNEL_5GHZ</span><span class="p">));</span>
	<span class="n">mode_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chanmode</span> <span class="o">!=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">chanmode</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">qnum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">qnum</span> <span class="o">&lt;</span> <span class="n">AR_NUM_QCU</span><span class="p">;</span> <span class="n">qnum</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_hw_numtxpending</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">qnum</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">QUEUE</span><span class="p">,</span>
				<span class="s">&quot;Transmit frames pending on queue %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qnum</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_rfbus_req</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Could not kill baseband RX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">band_switch</span> <span class="o">||</span> <span class="n">mode_diff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath9k_hw_mark_phy_inactive</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">ath9k_hw_init_pll</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_hw_fast_chan_change</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ini_reloaded</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Failed to do fast channel change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ath9k_hw_set_channel_regs</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_hw_rf_set_freq</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Failed to set channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ath9k_hw_set_clockrate</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_hw_apply_txpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">ath9k_hw_rfbus_done</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_OFDM</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_CHAN_HT</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">ath9k_hw_set_delta_slope</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">ath9k_hw_spur_mitigate_freq</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">edma</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">band_switch</span> <span class="o">||</span> <span class="n">mode_diff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_flags</span> <span class="o">|=</span> <span class="n">AH_FASTCC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band_switch</span> <span class="o">||</span> <span class="n">ini_reloaded</span><span class="p">)</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">set_board_values</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

		<span class="n">ath9k_hw_init_bb</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">band_switch</span> <span class="o">||</span> <span class="n">ini_reloaded</span><span class="p">)</span>
			<span class="n">ath9k_hw_init_cal</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AH_FASTCC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_apply_gpio_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gpio_mask</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">gpio_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">gpio_mask</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">gpio_mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">gpio_mask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ath9k_hw_cfg_output</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">AR_GPIO_OUTPUT_MUX_AS_OUTPUT</span><span class="p">);</span>
		<span class="n">ath9k_hw_set_gpio</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">!!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">)));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_hw_check_dcs</span><span class="p">(</span><span class="n">u32</span> <span class="n">dma_dbg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num_dcu_states</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">hang_state</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">hang_pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">dcu_chain_state</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">};</span> <span class="cm">/* DCU chain stuck states */</span>
	<span class="n">u32</span> <span class="n">chain_state</span><span class="p">,</span> <span class="n">dcs_pos</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dcs_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">dcs_pos</span> <span class="o">&lt;</span> <span class="n">num_dcu_states</span><span class="p">;</span> <span class="n">dcs_pos</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chain_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_dbg</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">dcs_pos</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chain_state</span> <span class="o">==</span> <span class="n">dcu_chain_state</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">hang_state</span> <span class="o">=</span> <span class="n">chain_state</span><span class="p">;</span>
				<span class="o">*</span><span class="n">hang_pos</span> <span class="o">=</span> <span class="n">dcs_pos</span><span class="p">;</span>
				<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define DCU_COMPLETE_STATE        1</span>
<span class="cp">#define DCU_COMPLETE_STATE_MASK 0x3</span>
<span class="cp">#define NUM_STATUS_READS         50</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_hw_detect_mac_hang</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">chain_state</span><span class="p">,</span> <span class="n">comp_state</span><span class="p">,</span> <span class="n">dcs_reg</span> <span class="o">=</span> <span class="n">AR_DMADBG_4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">hang_pos</span><span class="p">,</span> <span class="n">hang_state</span><span class="p">,</span> <span class="n">num_state</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">comp_state</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_DMADBG_6</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">comp_state</span> <span class="o">&amp;</span> <span class="n">DCU_COMPLETE_STATE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DCU_COMPLETE_STATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">RESET</span><span class="p">,</span>
			<span class="s">&quot;MAC Hang signature not found at DCU complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chain_state</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">dcs_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_hw_check_dcs</span><span class="p">(</span><span class="n">chain_state</span><span class="p">,</span> <span class="n">num_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hang_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hang_pos</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">hang_check_iter</span><span class="p">;</span>

	<span class="n">dcs_reg</span> <span class="o">=</span> <span class="n">AR_DMADBG_5</span><span class="p">;</span>
	<span class="n">num_state</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">chain_state</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">dcs_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_hw_check_dcs</span><span class="p">(</span><span class="n">chain_state</span><span class="p">,</span> <span class="n">num_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hang_state</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hang_pos</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">hang_check_iter</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">RESET</span><span class="p">,</span>
		<span class="s">&quot;MAC Hang signature 1 not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

<span class="nl">hang_check_iter:</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">RESET</span><span class="p">,</span>
		<span class="s">&quot;DCU registers: chain %08x complete %08x Hang: state %d pos %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">chain_state</span><span class="p">,</span> <span class="n">comp_state</span><span class="p">,</span> <span class="n">hang_state</span><span class="p">,</span> <span class="n">hang_pos</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_STATUS_READS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chain_state</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">dcs_reg</span><span class="p">);</span>
		<span class="n">chain_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain_state</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="n">hang_pos</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">comp_state</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_DMADBG_6</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">comp_state</span> <span class="o">&amp;</span> <span class="n">DCU_COMPLETE_STATE_MASK</span><span class="p">)</span> <span class="o">!=</span>
					<span class="n">DCU_COMPLETE_STATE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">chain_state</span> <span class="o">!=</span> <span class="n">hang_state</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;MAC Hang signature 1 found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ath9k_hw_check_alive</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">ath9k_hw_detect_mac_hang</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285_12_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_OBS_BUS_1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x7E7FFFEF</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00702400</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x7E000B00</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x1E000000</span>:
		<span class="k">case</span> <span class="mh">0x52000B00</span>:
		<span class="k">case</span> <span class="mh">0x18000B00</span>:
			<span class="k">continue</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_check_alive</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Fast channel change:</span>
<span class="cm"> * (Change synthesizer based on channel freq without resetting chip)</span>
<span class="cm"> *</span>
<span class="cm"> * Don&#39;t do FCC when</span>
<span class="cm"> *   - Flag is not set</span>
<span class="cm"> *   - Chip is just coming out of full sleep</span>
<span class="cm"> *   - Channel to be set is same as current channel</span>
<span class="cm"> *   - Channel flags are different, (eg.,moving from 2GHz to 5GHz channel)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_hw_do_fastcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="o">-&gt;</span><span class="n">ath_bus_type</span> <span class="o">==</span> <span class="n">ATH_PCI</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">chip_fullsleep</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">channelFlags</span> <span class="o">|</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channelFlags</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="n">CHANNEL_HALF</span> <span class="o">|</span> <span class="n">CHANNEL_QUARTER</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">channelFlags</span> <span class="o">&amp;</span> <span class="n">CHANNEL_ALL</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">channelFlags</span> <span class="o">&amp;</span> <span class="n">CHANNEL_ALL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_check_alive</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For AR9462, make sure that calibration data for</span>
<span class="cm">	 * re-using are present.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span> <span class="o">&amp;&amp;</span>
				 <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="o">-&gt;</span><span class="n">done_txiqcal_once</span> <span class="o">||</span>
				  <span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="o">-&gt;</span><span class="n">done_txclcal_once</span> <span class="o">||</span>
				  <span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span><span class="o">-&gt;</span><span class="n">rtt_done</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;FastChannelChange for %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_channel_change</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ath9k_hw_loadnf</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">);</span>
	<span class="n">ath9k_hw_start_nfcal</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_MCI</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ar9003_mci_is_ready</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ar9003_mci_2g5g_switch</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ar9002_hw_load_ani_reg</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ath9k_hw_cal_data</span> <span class="o">*</span><span class="n">caldata</span><span class="p">,</span> <span class="n">bool</span> <span class="n">fastcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">saveLedState</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">saveDefAntenna</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macStaId1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tsf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">start_mci_reset</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">mci</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_MCI</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">save_fullsleep</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">chip_fullsleep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start_mci_reset</span> <span class="o">=</span> <span class="n">ar9003_mci_start_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">start_mci_reset</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">chip_fullsleep</span><span class="p">)</span>
		<span class="n">ath9k_hw_getnf</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">caldata</span> <span class="o">=</span> <span class="n">caldata</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">caldata</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">!=</span> <span class="n">caldata</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">channelFlags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CHANNEL_CW_INT</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="p">(</span><span class="n">caldata</span><span class="o">-&gt;</span><span class="n">channelFlags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CHANNEL_CW_INT</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Operating channel changed, reset channel calibration data */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">caldata</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">caldata</span><span class="p">));</span>
		<span class="n">ath9k_init_nfcal_hist_buffer</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">ath9k_hw_getchan_noise</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fastcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_hw_do_fastcc</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mci</span><span class="p">)</span>
		<span class="n">ar9003_mci_stop_bt</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">save_fullsleep</span><span class="p">);</span>

	<span class="n">saveDefAntenna</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_DEF_ANTENNA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saveDefAntenna</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">saveDefAntenna</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">macStaId1</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_STA_ID1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR_STA_ID1_BASE_RATE_11B</span><span class="p">;</span>

	<span class="cm">/* For chips on which RTC reset is done, save TSF before it gets cleared */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">AR_SREV_9280</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_OL_PWRCTRL</span><span class="p">)))</span>
		<span class="n">tsf</span> <span class="o">=</span> <span class="n">ath9k_hw_gettsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">saveLedState</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CFG_LED</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">AR_CFG_LED_ASSOC_CTL</span> <span class="o">|</span> <span class="n">AR_CFG_LED_MODE_SEL</span> <span class="o">|</span>
		 <span class="n">AR_CFG_LED_BLINK_THRESH_SEL</span> <span class="o">|</span> <span class="n">AR_CFG_LED_BLINK_SLOW</span><span class="p">);</span>

	<span class="n">ath9k_hw_mark_phy_inactive</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_table_write_done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Only required on the first reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">htc_reset_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			  <span class="n">AR9271_RESET_POWER_DOWN_CONTROL</span><span class="p">,</span>
			  <span class="n">AR9271_RADIO_RF_RST</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_chip_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Chip reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Only required on the first reset */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">htc_reset_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">htc_reset_init</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
			  <span class="n">AR9271_RESET_POWER_DOWN_CONTROL</span><span class="p">,</span>
			  <span class="n">AR9271_GATE_MAC_CTL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Restore TSF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tsf</span><span class="p">)</span>
		<span class="n">ath9k_hw_settsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">tsf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_GPIO_INPUT_EN_VAL</span><span class="p">,</span> <span class="n">AR_GPIO_JTAG_DISABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ar9002_hw_enable_async_fifo</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_hw_process_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mci</span><span class="p">)</span>
		<span class="n">ar9003_mci_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">IS_CHAN_2GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span> <span class="n">save_fullsleep</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some AR91xx SoC devices frequently fail to accept TSF writes</span>
<span class="cm">	 * right after the chip reset. When that happens, write a new</span>
<span class="cm">	 * value after the initvals have been applied, with an offset</span>
<span class="cm">	 * based on measured time difference</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ath9k_hw_gettsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tsf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tsf</span> <span class="o">+=</span> <span class="mi">1500</span><span class="p">;</span>
		<span class="n">ath9k_hw_settsf64</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">tsf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Setup MFP options for CCMP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Mask Retry(b11), PwrMgt(b12), MoreData(b13) to 0 in mgmt</span>
<span class="cm">		 * frames when constructing CCMP AAD. */</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_AES_MUTE_MASK1</span><span class="p">,</span> <span class="n">AR_AES_MUTE_MASK1_FC_MGMT</span><span class="p">,</span>
			      <span class="mh">0xc7ff</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">sw_mgmt_crypto</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9160_10_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Disable hardware crypto for management frames */</span>
		<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCU_MISC_MODE2</span><span class="p">,</span>
			    <span class="n">AR_PCU_MISC_MODE2_MGMT_CRYPTO_ENABLE</span><span class="p">);</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCU_MISC_MODE2</span><span class="p">,</span>
			    <span class="n">AR_PCU_MISC_MODE2_NO_CRYPTO_FOR_NON_DATA_PKT</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">sw_mgmt_crypto</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">sw_mgmt_crypto</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_OFDM</span><span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="o">||</span> <span class="n">IS_CHAN_HT</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">ath9k_hw_set_delta_slope</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">ath9k_hw_spur_mitigate_freq</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">set_board_values</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_STA_ID0</span><span class="p">,</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_STA_ID1</span><span class="p">,</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
		  <span class="o">|</span> <span class="n">macStaId1</span>
		  <span class="o">|</span> <span class="n">AR_STA_ID1_RTS_USE_DEF</span>
		  <span class="o">|</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span>
		     <span class="n">ack_6mb</span> <span class="o">?</span> <span class="n">AR_STA_ID1_ACKCTS_6MB</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		  <span class="o">|</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">sta_id1_defaults</span><span class="p">);</span>
	<span class="n">ath_hw_setbssidmask</span><span class="p">(</span><span class="n">common</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_DEF_ANTENNA</span><span class="p">,</span> <span class="n">saveDefAntenna</span><span class="p">);</span>
	<span class="n">ath9k_hw_write_associd</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_ISR</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RSSI_THR</span><span class="p">,</span> <span class="n">INIT_RSSI_THR</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ath9k_hw_set_operating_mode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">ath9k_hw_rf_set_freq</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">ath9k_hw_set_clockrate</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AR_NUM_DCU</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_DQCUMASK</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">intr_txqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ath9k_hw_resettxqueue</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">ath9k_hw_init_interrupt_masks</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">);</span>
	<span class="n">ath9k_hw_ani_cache_ini_regs</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_hw_init_qos</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_RFSILENT</span><span class="p">)</span>
		<span class="n">ath9k_hw_cfg_gpio_input</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">rfkill_gpio</span><span class="p">);</span>

	<span class="n">ath9k_hw_init_global_settings</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">AR_SREV_9287_13_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MAC_PCU_LOGIC_ANALYZER</span><span class="p">,</span>
			    <span class="n">AR_MAC_PCU_LOGIC_ANALYZER_DISBUG20768</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_AHB_MODE</span><span class="p">,</span> <span class="n">AR_AHB_CUSTOM_BURST_EN</span><span class="p">,</span>
			      <span class="n">AR_AHB_CUSTOM_BURST_ASYNC_FIFO_VAL</span><span class="p">);</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCU_MISC_MODE2</span><span class="p">,</span>
			    <span class="n">AR_PCU_MISC_MODE2_ENABLE_AGGWEP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_STA_ID1</span><span class="p">,</span> <span class="n">AR_STA_ID1_PRESERVE_SEQNUM</span><span class="p">);</span>

	<span class="n">ath9k_hw_set_dma</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_OBS</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rx_intr_mitigation</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RIMT</span><span class="p">,</span> <span class="n">AR_RIMT_LAST</span><span class="p">,</span> <span class="mi">500</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RIMT</span><span class="p">,</span> <span class="n">AR_RIMT_FIRST</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">tx_intr_mitigation</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TIMT</span><span class="p">,</span> <span class="n">AR_TIMT_LAST</span><span class="p">,</span> <span class="mi">300</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TIMT</span><span class="p">,</span> <span class="n">AR_TIMT_FIRST</span><span class="p">,</span> <span class="mi">750</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath9k_hw_init_bb</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">caldata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">caldata</span><span class="o">-&gt;</span><span class="n">done_txiqcal_once</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">caldata</span><span class="o">-&gt;</span><span class="n">done_txclcal_once</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_init_cal</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ath9k_hw_loadnf</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">ath9k_hw_start_nfcal</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mci</span> <span class="o">&amp;&amp;</span> <span class="n">ar9003_mci_end_reset</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">caldata</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ath9k_hw_restore_chainmask</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CFG_LED</span><span class="p">,</span> <span class="n">saveLedState</span> <span class="o">|</span> <span class="n">AR_CFG_SCLK_32KHZ</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * For big endian systems turn on swapping for descriptors</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CFG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AR_CFG_SWRB</span> <span class="o">|</span> <span class="n">AR_CFG_SWTB</span> <span class="o">|</span> <span class="n">AR_CFG_SWRG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;CFG Byte Swap Set 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mask</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">=</span>
				<span class="n">INIT_CONFIG_STATUS</span> <span class="o">|</span> <span class="n">AR_CFG_SWRB</span> <span class="o">|</span> <span class="n">AR_CFG_SWTB</span><span class="p">;</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CFG</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
			<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;Setting CFG 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CFG</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span><span class="o">-&gt;</span><span class="n">ath_bus_type</span> <span class="o">==</span> <span class="n">ATH_USB</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Configure AR9271 target WLAN */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CFG</span><span class="p">,</span> <span class="n">AR_CFG_SWRB</span> <span class="o">|</span> <span class="n">AR_CFG_SWTB</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CFG</span><span class="p">,</span> <span class="n">AR_CFG_SWTD</span> <span class="o">|</span> <span class="n">AR_CFG_SWRD</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CFG</span><span class="p">,</span> <span class="n">AR_CFG_SWRB</span> <span class="o">|</span> <span class="n">AR_CFG_SWTB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_CFG</span><span class="p">,</span> <span class="n">AR_CFG_SWTD</span> <span class="o">|</span> <span class="n">AR_CFG_SWRD</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_hw_btcoex_is_enabled</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ath9k_hw_btcoex_enable</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mci</span><span class="p">)</span>
		<span class="n">ar9003_mci_check_bt</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ar9003_hw_bb_watchdog_config</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

		<span class="n">ar9003_hw_disable_phy_restart</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath9k_hw_apply_gpio_override</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_reset</span><span class="p">);</span>

<span class="cm">/******************************/</span>
<span class="cm">/* Power Management (Chipset) */</span>
<span class="cm">/******************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Notify Power Mgt is disabled in self-generated frames.</span>
<span class="cm"> * If requested, force chip to sleep.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_set_power_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">setChip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_STA_ID1</span><span class="p">,</span> <span class="n">AR_STA_ID1_PWR_SAV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setChip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">,</span>
				  <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF00</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_NDP2_TIMER_MODE</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
				  <span class="n">AR_NDP2_TIMER_MODE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF00</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SLP32_INC</span><span class="p">,</span>
				  <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SLP32_INC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF00000</span><span class="p">);</span>
			<span class="cm">/* xxx Required for WLAN only case ? */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MCI_INTERRUPT_RX_MSG_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Clear the RTC force wake bit to allow the</span>
<span class="cm">		 * mac to go to sleep.</span>
<span class="cm">		 */</span>
		<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_WAKE</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_WAKE_EN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RC</span><span class="p">,</span> <span class="n">AR_RC_AHB</span> <span class="o">|</span> <span class="n">AR_RC_HOSTIF</span><span class="p">);</span>

		<span class="cm">/* Shutdown chip. Active low */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_5416</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_RESET</span><span class="p">,</span> <span class="n">AR_RTC_RESET_EN</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Clear Bit 14 of AR_WA after putting chip into Full Sleep mode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_WA</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">WARegVal</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AR_WA_D3_L1_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Notify Power Management is enabled in self-generating</span>
<span class="cm"> * frames. If request, set power mode of chip to</span>
<span class="cm"> * auto/normal.  Duration in units of 128us (1/8 TU).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_set_power_network_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">setChip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_STA_ID1</span><span class="p">,</span> <span class="n">AR_STA_ID1_PWR_SAV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setChip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ath9k_hw_capabilities</span> <span class="o">*</span><span class="n">pCap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_AUTOSLEEP</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Set WakeOnInterrupt bit; clear ForceWake bit */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_WAKE</span><span class="p">,</span>
				  <span class="n">AR_RTC_FORCE_WAKE_ON_INT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="cm">/* When chip goes into network sleep, it could be waken</span>
<span class="cm">			 * up by MCI_INT interrupt caused by BT&#39;s HW messages</span>
<span class="cm">			 * (LNA_xxx, CONT_xxx) which chould be in a very fast</span>
<span class="cm">			 * rate (~100us). This will cause chip to leave and</span>
<span class="cm">			 * re-enter network sleep mode frequently, which in</span>
<span class="cm">			 * consequence will have WLAN MCI HW to generate lots of</span>
<span class="cm">			 * SYS_WAKING and SYS_SLEEPING messages which will make</span>
<span class="cm">			 * BT CPU to busy to process.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MCI_INTERRUPT_RX_MSG_EN</span><span class="p">)</span> <span class="o">&amp;</span>
					<span class="o">~</span><span class="n">AR_MCI_INTERRUPT_RX_HW_MSG_MASK</span><span class="p">;</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MCI_INTERRUPT_RX_MSG_EN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Clear the RTC force wake bit to allow the</span>
<span class="cm">			 * mac to go to sleep.</span>
<span class="cm">			 */</span>
			<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_WAKE</span><span class="p">,</span>
				    <span class="n">AR_RTC_FORCE_WAKE_EN</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Clear Bit 14 of AR_WA after putting chip into Net Sleep mode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_WA</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">WARegVal</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AR_WA_D3_L1_DISABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_hw_set_power_awake</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">setChip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Set Bits 14 and 17 of AR_WA before powering on the chip. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_WA</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">WARegVal</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setChip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_STATUS</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="n">AR_RTC_STATUS_M</span><span class="p">)</span> <span class="o">==</span> <span class="n">AR_RTC_STATUS_SHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_set_reset_reg</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_RESET_POWER_ON</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
				<span class="n">ath9k_hw_init_pll</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_RESET</span><span class="p">,</span>
				    <span class="n">AR_RTC_RESET_EN</span><span class="p">);</span>

		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_WAKE</span><span class="p">,</span>
			    <span class="n">AR_RTC_FORCE_WAKE_EN</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">POWER_UP_TIME</span> <span class="o">/</span> <span class="mi">50</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR_RTC_STATUS_M</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">AR_RTC_STATUS_ON</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_FORCE_WAKE</span><span class="p">,</span>
				    <span class="n">AR_RTC_FORCE_WAKE_EN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span>
				<span class="s">&quot;Failed to wakeup in %uus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">POWER_UP_TIME</span> <span class="o">/</span> <span class="mi">20</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_STA_ID1</span><span class="p">,</span> <span class="n">AR_STA_ID1_PWR_SAV</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">ath9k_hw_setpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ath9k_power_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span> <span class="n">setChip</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;AWAKE&quot;</span><span class="p">,</span>
		<span class="s">&quot;FULL-SLEEP&quot;</span><span class="p">,</span>
		<span class="s">&quot;NETWORK SLEEP&quot;</span><span class="p">,</span>
		<span class="s">&quot;UNDEFINED&quot;</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">RESET</span><span class="p">,</span> <span class="s">&quot;%s -&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">modes</span><span class="p">[</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">],</span> <span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATH9K_PM_AWAKE</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath9k_hw_set_power_awake</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">setChip</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_MCI</span><span class="p">)</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_KEEP_AWAKE</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH9K_PM_FULL_SLEEP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_MCI</span><span class="p">)</span>
			<span class="n">ar9003_mci_set_full_sleep</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

		<span class="n">ath9k_set_power_sleep</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">setChip</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">chip_fullsleep</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ATH9K_PM_NETWORK_SLEEP</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_MCI</span><span class="p">)</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RTC_KEEP_AWAKE</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>

		<span class="n">ath9k_set_power_network_sleep</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">setChip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unknown power mode %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX: If this warning never comes up after a while then</span>
<span class="cm">	 * simply keep the ATH_DBG_WARN_ON_ONCE() but make</span>
<span class="cm">	 * ath9k_hw_setpower() return type void.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_flags</span> <span class="o">&amp;</span> <span class="n">AH_UNPLUGGED</span><span class="p">))</span>
		<span class="n">ATH_DBG_WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_setpower</span><span class="p">);</span>

<span class="cm">/*******************/</span>
<span class="cm">/* Beacon Handling */</span>
<span class="cm">/*******************/</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_beaconinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">next_beacon</span><span class="p">,</span> <span class="n">u32</span> <span class="n">beacon_period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TXCFG</span><span class="p">,</span>
			    <span class="n">AR_TXCFG_ADHOC_BEACON_ATIM_TX_POLICY</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_NEXT_NDP_TIMER</span><span class="p">,</span> <span class="n">next_beacon</span> <span class="o">+</span>
			  <span class="n">TU_TO_USEC</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">atim_window</span> <span class="o">?</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">atim_window</span> <span class="o">:</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">AR_NDP_TIMER_EN</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_NEXT_TBTT_TIMER</span><span class="p">,</span> <span class="n">next_beacon</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_NEXT_DMA_BEACON_ALERT</span><span class="p">,</span> <span class="n">next_beacon</span> <span class="o">-</span>
			  <span class="n">TU_TO_USEC</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">dma_beacon_response_time</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_NEXT_SWBA</span><span class="p">,</span> <span class="n">next_beacon</span> <span class="o">-</span>
			  <span class="n">TU_TO_USEC</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">sw_beacon_response_time</span><span class="p">));</span>
		<span class="n">flags</span> <span class="o">|=</span>
			<span class="n">AR_TBTT_TIMER_EN</span> <span class="o">|</span> <span class="n">AR_DBA_TIMER_EN</span> <span class="o">|</span> <span class="n">AR_SWBA_TIMER_EN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">BEACON</span><span class="p">,</span>
			<span class="s">&quot;%s: unsupported opmode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_BEACON_PERIOD</span><span class="p">,</span> <span class="n">beacon_period</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_DMA_BEACON_PERIOD</span><span class="p">,</span> <span class="n">beacon_period</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SWBA_PERIOD</span><span class="p">,</span> <span class="n">beacon_period</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_NDP_PERIOD</span><span class="p">,</span> <span class="n">beacon_period</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_beaconinit</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_set_sta_beacon_timers</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">ath9k_beacon_state</span> <span class="o">*</span><span class="n">bs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">nextTbtt</span><span class="p">,</span> <span class="n">beaconintval</span><span class="p">,</span> <span class="n">dtimperiod</span><span class="p">,</span> <span class="n">beacontimeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_hw_capabilities</span> <span class="o">*</span><span class="n">pCap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_NEXT_TBTT_TIMER</span><span class="p">,</span> <span class="n">TU_TO_USEC</span><span class="p">(</span><span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_nexttbtt</span><span class="p">));</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_BEACON_PERIOD</span><span class="p">,</span>
		  <span class="n">TU_TO_USEC</span><span class="p">(</span><span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_intval</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_DMA_BEACON_PERIOD</span><span class="p">,</span>
		  <span class="n">TU_TO_USEC</span><span class="p">(</span><span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_intval</span><span class="p">));</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RSSI_THR</span><span class="p">,</span>
		      <span class="n">AR_RSSI_THR_BM_THR</span><span class="p">,</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_bmissthreshold</span><span class="p">);</span>

	<span class="n">beaconintval</span> <span class="o">=</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_intval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_sleepduration</span> <span class="o">&gt;</span> <span class="n">beaconintval</span><span class="p">)</span>
		<span class="n">beaconintval</span> <span class="o">=</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_sleepduration</span><span class="p">;</span>

	<span class="n">dtimperiod</span> <span class="o">=</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_dtimperiod</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_sleepduration</span> <span class="o">&gt;</span> <span class="n">dtimperiod</span><span class="p">)</span>
		<span class="n">dtimperiod</span> <span class="o">=</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_sleepduration</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beaconintval</span> <span class="o">==</span> <span class="n">dtimperiod</span><span class="p">)</span>
		<span class="n">nextTbtt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_nextdtim</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nextTbtt</span> <span class="o">=</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_nexttbtt</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">BEACON</span><span class="p">,</span> <span class="s">&quot;next DTIM %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_nextdtim</span><span class="p">);</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">BEACON</span><span class="p">,</span> <span class="s">&quot;next beacon %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nextTbtt</span><span class="p">);</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">BEACON</span><span class="p">,</span> <span class="s">&quot;beacon period %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">beaconintval</span><span class="p">);</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">BEACON</span><span class="p">,</span> <span class="s">&quot;DTIM period %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dtimperiod</span><span class="p">);</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_NEXT_DTIM</span><span class="p">,</span>
		  <span class="n">TU_TO_USEC</span><span class="p">(</span><span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_nextdtim</span> <span class="o">-</span> <span class="n">SLEEP_SLOP</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_NEXT_TIM</span><span class="p">,</span> <span class="n">TU_TO_USEC</span><span class="p">(</span><span class="n">nextTbtt</span> <span class="o">-</span> <span class="n">SLEEP_SLOP</span><span class="p">));</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SLEEP1</span><span class="p">,</span>
		  <span class="n">SM</span><span class="p">((</span><span class="n">CAB_TIMEOUT_VAL</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">AR_SLEEP1_CAB_TIMEOUT</span><span class="p">)</span>
		  <span class="o">|</span> <span class="n">AR_SLEEP1_ASSUME_DTIM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_AUTOSLEEP</span><span class="p">)</span>
		<span class="n">beacontimeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">BEACON_TIMEOUT_VAL</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">beacontimeout</span> <span class="o">=</span> <span class="n">MIN_BEACON_TIMEOUT_VAL</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SLEEP2</span><span class="p">,</span>
		  <span class="n">SM</span><span class="p">(</span><span class="n">beacontimeout</span><span class="p">,</span> <span class="n">AR_SLEEP2_BEACON_TIMEOUT</span><span class="p">));</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TIM_PERIOD</span><span class="p">,</span> <span class="n">TU_TO_USEC</span><span class="p">(</span><span class="n">beaconintval</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_DTIM_PERIOD</span><span class="p">,</span> <span class="n">TU_TO_USEC</span><span class="p">(</span><span class="n">dtimperiod</span><span class="p">));</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">,</span>
		    <span class="n">AR_TBTT_TIMER_EN</span> <span class="o">|</span> <span class="n">AR_TIM_TIMER_EN</span> <span class="o">|</span>
		    <span class="n">AR_DTIM_TIMER_EN</span><span class="p">);</span>

	<span class="cm">/* TSF Out of Range Threshold */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TSFOOR_THRESHOLD</span><span class="p">,</span> <span class="n">bs</span><span class="o">-&gt;</span><span class="n">bs_tsfoor_threshold</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_set_sta_beacon_timers</span><span class="p">);</span>

<span class="cm">/*******************/</span>
<span class="cm">/* HW Capabilities */</span>
<span class="cm">/*******************/</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">fixup_chainmask</span><span class="p">(</span><span class="n">u8</span> <span class="n">chip_chainmask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">eeprom_chainmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">eeprom_chainmask</span> <span class="o">&amp;=</span> <span class="n">chip_chainmask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom_chainmask</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">eeprom_chainmask</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">chip_chainmask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ath9k_hw_dfs_tested - checks if DFS has been tested with used chipset</span>
<span class="cm"> * @ah: the atheros hardware data structure</span>
<span class="cm"> *</span>
<span class="cm"> * We enable DFS support upstream on chipsets which have passed a series</span>
<span class="cm"> * of tests. The testing requirements are going to be documented. Desired</span>
<span class="cm"> * test requirements are documented at:</span>
<span class="cm"> *</span>
<span class="cm"> * http://wireless.kernel.org/en/users/Drivers/ath9k/dfs</span>
<span class="cm"> *</span>
<span class="cm"> * Once a new chipset gets properly tested an individual commit can be used</span>
<span class="cm"> * to document the testing for DFS for that chipset.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath9k_hw_dfs_tested</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* AR9580 will likely be our first target to get testing on */</span>
	<span class="k">case</span> <span class="n">AR_SREV_VERSION_9580</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_hw_fill_cap_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_hw_capabilities</span> <span class="o">*</span><span class="n">pCap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_regulatory</span> <span class="o">*</span><span class="n">regulatory</span> <span class="o">=</span> <span class="n">ath9k_hw_regulatory</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chip_chainmask</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">eeval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ant_div_ctl1</span><span class="p">,</span> <span class="n">tx_chainmask</span><span class="p">,</span> <span class="n">rx_chainmask</span><span class="p">;</span>

	<span class="n">eeval</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_REG_0</span><span class="p">);</span>
	<span class="n">regulatory</span><span class="o">-&gt;</span><span class="n">current_rd</span> <span class="o">=</span> <span class="n">eeval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">subvendorid</span> <span class="o">==</span> <span class="n">AR_SUBVENDOR_ID_NEW_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regulatory</span><span class="o">-&gt;</span><span class="n">current_rd</span> <span class="o">==</span> <span class="mh">0x64</span> <span class="o">||</span>
		    <span class="n">regulatory</span><span class="o">-&gt;</span><span class="n">current_rd</span> <span class="o">==</span> <span class="mh">0x65</span><span class="p">)</span>
			<span class="n">regulatory</span><span class="o">-&gt;</span><span class="n">current_rd</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regulatory</span><span class="o">-&gt;</span><span class="n">current_rd</span> <span class="o">==</span> <span class="mh">0x41</span><span class="p">)</span>
			<span class="n">regulatory</span><span class="o">-&gt;</span><span class="n">current_rd</span> <span class="o">=</span> <span class="mh">0x43</span><span class="p">;</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">REGULATORY</span><span class="p">,</span> <span class="s">&quot;regdomain mapped to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">regulatory</span><span class="o">-&gt;</span><span class="n">current_rd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">eeval</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_OP_MODE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">eeval</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AR5416_OPFLAGS_11G</span> <span class="o">|</span> <span class="n">AR5416_OPFLAGS_11A</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span>
			<span class="s">&quot;no band has been marked as supported in EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeval</span> <span class="o">&amp;</span> <span class="n">AR5416_OPFLAGS_11A</span><span class="p">)</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_5GHZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeval</span> <span class="o">&amp;</span> <span class="n">AR5416_OPFLAGS_11G</span><span class="p">)</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_2GHZ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9285</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">chip_chainmask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">chip_chainmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">chip_chainmask</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9340</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">chip_chainmask</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chip_chainmask</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">tx_chainmask</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_TX_MASK</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * For AR9271 we will temporarilly uses the rx chainmax as read from</span>
<span class="cm">	 * the EEPROM.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">devid</span> <span class="o">==</span> <span class="n">AR5416_DEVID_PCI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">eeval</span> <span class="o">&amp;</span> <span class="n">AR5416_OPFLAGS_11A</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">)))</span>
		<span class="cm">/* CB71: GPIO 0 is pulled down to indicate 3 rx chains */</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rx_chainmask</span> <span class="o">=</span> <span class="n">ath9k_hw_gpio_get</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x5</span> <span class="o">:</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rx_chainmask</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* Use rx_chainmask from EEPROM. */</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rx_chainmask</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_RX_MASK</span><span class="p">);</span>

	<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">tx_chainmask</span> <span class="o">=</span> <span class="n">fixup_chainmask</span><span class="p">(</span><span class="n">chip_chainmask</span><span class="p">,</span> <span class="n">pCap</span><span class="o">-&gt;</span><span class="n">tx_chainmask</span><span class="p">);</span>
	<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rx_chainmask</span> <span class="o">=</span> <span class="n">fixup_chainmask</span><span class="p">(</span><span class="n">chip_chainmask</span><span class="p">,</span> <span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rx_chainmask</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span> <span class="o">=</span> <span class="n">pCap</span><span class="o">-&gt;</span><span class="n">tx_chainmask</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxchainmask</span> <span class="o">=</span> <span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rx_chainmask</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">misc_mode</span> <span class="o">|=</span> <span class="n">AR_PCU_MIC_NEW_LOC_ENA</span><span class="p">;</span>

	<span class="cm">/* enable key search for every frame in an aggregate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">misc_mode</span> <span class="o">|=</span> <span class="n">AR_PCU_ALWAYS_PERFORM_KEYSEARCH</span><span class="p">;</span>

	<span class="n">common</span><span class="o">-&gt;</span><span class="n">crypt_caps</span> <span class="o">|=</span> <span class="n">ATH_CRYPT_CAP_CIPHER_AESCCM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">devid</span> <span class="o">!=</span> <span class="n">AR2427_DEVID_PCIE</span><span class="p">)</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_HT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_HW_CAP_HT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">num_gpio_pins</span> <span class="o">=</span> <span class="n">AR9271_NUM_GPIO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_DEVID_7010</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">num_gpio_pins</span> <span class="o">=</span> <span class="n">AR7010_NUM_GPIO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">num_gpio_pins</span> <span class="o">=</span> <span class="n">AR9300_NUM_GPIO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287_11_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">num_gpio_pins</span> <span class="o">=</span> <span class="n">AR9287_NUM_GPIO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285_12_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">num_gpio_pins</span> <span class="o">=</span> <span class="n">AR9285_NUM_GPIO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">num_gpio_pins</span> <span class="o">=</span> <span class="n">AR928X_NUM_GPIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">num_gpio_pins</span> <span class="o">=</span> <span class="n">AR_NUM_GPIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9160_10_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rts_aggr_limit</span> <span class="o">=</span> <span class="n">ATH_AMPDU_LIMIT_MAX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rts_aggr_limit</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_RFKILL) || defined(CONFIG_RFKILL_MODULE)</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rfsilent</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_RF_SILENT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rfsilent</span> <span class="o">&amp;</span> <span class="n">EEP_RFSILENT_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rfkill_gpio</span> <span class="o">=</span>
			<span class="n">MS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rfsilent</span><span class="p">,</span> <span class="n">EEP_RFSILENT_GPIO_SEL</span><span class="p">);</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">rfkill_polarity</span> <span class="o">=</span>
			<span class="n">MS</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rfsilent</span><span class="p">,</span> <span class="n">EEP_RFSILENT_POLARITY</span><span class="p">);</span>

		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_RFSILENT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_AUTOSLEEP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_HW_CAP_AUTOSLEEP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9285</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ATH9K_HW_CAP_4KB_SPLITTRANS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_4KB_SPLITTRANS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_EDMA</span> <span class="o">|</span> <span class="n">ATH9K_HW_CAP_FASTCLOCK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_LDPC</span><span class="p">;</span>

		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rx_hp_qdepth</span> <span class="o">=</span> <span class="n">ATH9K_HW_RX_HP_QDEPTH</span><span class="p">;</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rx_lp_qdepth</span> <span class="o">=</span> <span class="n">ATH9K_HW_RX_LP_QDEPTH</span><span class="p">;</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rx_status_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9003_rxs</span><span class="p">);</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">tx_desc_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9003_txc</span><span class="p">);</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">txs_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ar9003_txs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">paprd_disable</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_PAPRD</span><span class="p">))</span>
			<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_PAPRD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">tx_desc_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_FASTCLOCK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_RAC_SUPPORTED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ent_mode</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_ENT_OTP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287_11_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_SGI_20</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_MODAL_VER</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ant_div_ctl1</span> <span class="o">=</span>
				<span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_ANT_DIV_CTL1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ant_div_ctl1</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ant_div_ctl1</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
				<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_ANT_DIV_COMB</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_CHAIN_MASK_REDUCE</span><span class="p">))</span>
			<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_APM</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ant_div_ctl1</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_ANT_DIV_CTL1</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * enable the diversity-combining algorithm only when</span>
<span class="cm">		 * both enable_lna_div and enable_fast_div are set</span>
<span class="cm">		 *		Table for Diversity</span>
<span class="cm">		 * ant_div_alt_lnaconf		bit 0-1</span>
<span class="cm">		 * ant_div_main_lnaconf		bit 2-3</span>
<span class="cm">		 * ant_div_alt_gaintb		bit 4</span>
<span class="cm">		 * ant_div_main_gaintb		bit 5</span>
<span class="cm">		 * enable_ant_div_lnadiv	bit 6</span>
<span class="cm">		 * enable_ant_fast_div		bit 7</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ant_div_ctl1</span> <span class="o">&gt;&gt;</span> <span class="mh">0x6</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3</span><span class="p">)</span>
			<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_ANT_DIV_COMB</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9485_10</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">pcie_lcr_extsync_en</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">pcie_lcr_offset</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath9k_hw_dfs_tested</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_DFS</span><span class="p">;</span>

	<span class="n">tx_chainmask</span> <span class="o">=</span> <span class="n">pCap</span><span class="o">-&gt;</span><span class="n">tx_chainmask</span><span class="p">;</span>
	<span class="n">rx_chainmask</span> <span class="o">=</span> <span class="n">pCap</span><span class="o">-&gt;</span><span class="n">rx_chainmask</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tx_chainmask</span> <span class="o">||</span> <span class="n">rx_chainmask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_chainmask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
			<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">max_txchains</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_chainmask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
			<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">max_rxchains</span><span class="o">++</span><span class="p">;</span>

		<span class="n">tx_chainmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rx_chainmask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">enabled_cals</span> <span class="o">|=</span> <span class="n">TX_IQ_CAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9485_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">enabled_cals</span> <span class="o">|=</span> <span class="n">TX_IQ_ON_AGC_CAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">ent_mode</span> <span class="o">&amp;</span> <span class="n">AR_ENT_OTP_49GHZ_DISABLE</span><span class="p">))</span>
			<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_MCI</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462_20</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">pCap</span><span class="o">-&gt;</span><span class="n">hw_caps</span> <span class="o">|=</span> <span class="n">ATH9K_HW_CAP_RTT</span><span class="p">;</span>

	<span class="p">}</span>


	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************/</span>
<span class="cm">/* GPIO / RFKILL / Antennae */</span>
<span class="cm">/****************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_hw_gpio_cfg_output_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
					 <span class="n">u32</span> <span class="n">gpio</span><span class="p">,</span> <span class="n">u32</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpio_shift</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">AR_GPIO_OUTPUT_MUX3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">AR_GPIO_OUTPUT_MUX2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">AR_GPIO_OUTPUT_MUX1</span><span class="p">;</span>

	<span class="n">gpio_shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">%</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">AR_GPIO_OUTPUT_MUX1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">),</span>
			<span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1F0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1F0</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1f</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_cfg_gpio_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gpio_shift</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">gpio</span> <span class="o">&gt;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_gpio_pins</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_DEVID_7010</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gpio_shift</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>
		<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR7010_GPIO_OE</span><span class="p">,</span>
			<span class="p">(</span><span class="n">AR7010_GPIO_OE_AS_INPUT</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">),</span>
			<span class="p">(</span><span class="n">AR7010_GPIO_OE_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">gpio_shift</span> <span class="o">=</span> <span class="n">gpio</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
		<span class="n">AR_GPIO_OE_OUT</span><span class="p">,</span>
		<span class="p">(</span><span class="n">AR_GPIO_OE_OUT_DRV_NO</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">),</span>
		<span class="p">(</span><span class="n">AR_GPIO_OE_OUT_DRV</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_cfg_gpio_input</span><span class="p">);</span>

<span class="n">u32</span> <span class="nf">ath9k_hw_gpio_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gpio</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define MS_REG_READ(x, y) \</span>
<span class="cp">	(MS(REG_READ(ah, AR_GPIO_IN_OUT), x##_GPIO_IN_VAL) &amp; (AR_GPIO_BIT(y)))</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&gt;=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">num_gpio_pins</span><span class="p">)</span>
		<span class="k">return</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_DEVID_7010</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR7010_GPIO_IN</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">MS</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">AR7010_GPIO_IN_VAL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">AR_GPIO_BIT</span><span class="p">(</span><span class="n">gpio</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">MS</span><span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_GPIO_IN</span><span class="p">),</span> <span class="n">AR9300_GPIO_IN_VAL</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">AR_GPIO_BIT</span><span class="p">(</span><span class="n">gpio</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MS_REG_READ</span><span class="p">(</span><span class="n">AR9271</span><span class="p">,</span> <span class="n">gpio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287_11_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MS_REG_READ</span><span class="p">(</span><span class="n">AR9287</span><span class="p">,</span> <span class="n">gpio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285_12_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MS_REG_READ</span><span class="p">(</span><span class="n">AR9285</span><span class="p">,</span> <span class="n">gpio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MS_REG_READ</span><span class="p">(</span><span class="n">AR928X</span><span class="p">,</span> <span class="n">gpio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">MS_REG_READ</span><span class="p">(</span><span class="n">AR</span><span class="p">,</span> <span class="n">gpio</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_gpio_get</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_cfg_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gpio</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">ah_signal_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gpio_shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_DEVID_7010</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gpio_shift</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>
		<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR7010_GPIO_OE</span><span class="p">,</span>
			<span class="p">(</span><span class="n">AR7010_GPIO_OE_AS_OUTPUT</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">),</span>
			<span class="p">(</span><span class="n">AR7010_GPIO_OE_MASK</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath9k_hw_gpio_cfg_output_mux</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">gpio</span><span class="p">,</span> <span class="n">ah_signal_type</span><span class="p">);</span>
	<span class="n">gpio_shift</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span>
		<span class="n">AR_GPIO_OE_OUT</span><span class="p">,</span>
		<span class="p">(</span><span class="n">AR_GPIO_OE_OUT_DRV_ALL</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">),</span>
		<span class="p">(</span><span class="n">AR_GPIO_OE_OUT_DRV</span> <span class="o">&lt;&lt;</span> <span class="n">gpio_shift</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_cfg_output</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">gpio</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_DEVID_7010</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR7010_GPIO_OUT</span><span class="p">,</span> <span class="p">((</span><span class="n">val</span><span class="o">&amp;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">gpio</span><span class="p">),</span>
			<span class="n">AR_GPIO_BIT</span><span class="p">(</span><span class="n">gpio</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="o">~</span><span class="n">val</span><span class="p">;</span>

	<span class="n">REG_RMW</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_GPIO_IN_OUT</span><span class="p">,</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">gpio</span><span class="p">),</span>
		<span class="n">AR_GPIO_BIT</span><span class="p">(</span><span class="n">gpio</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_set_gpio</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_setantenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">antenna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_DEF_ANTENNA</span><span class="p">,</span> <span class="p">(</span><span class="n">antenna</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_setantenna</span><span class="p">);</span>

<span class="cm">/*********************/</span>
<span class="cm">/* General Operation */</span>
<span class="cm">/*********************/</span>

<span class="n">u32</span> <span class="nf">ath9k_hw_getrxfilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RX_FILTER</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">phybits</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ERR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phybits</span> <span class="o">&amp;</span> <span class="n">AR_PHY_ERR_RADAR</span><span class="p">)</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_PHYRADAR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phybits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">AR_PHY_ERR_OFDM_TIMING</span> <span class="o">|</span> <span class="n">AR_PHY_ERR_CCK_TIMING</span><span class="p">))</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_PHYERR</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bits</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_getrxfilter</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_setrxfilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">phybits</span><span class="p">;</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">ATH9K_RX_FILTER_CONTROL_WRAPPER</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RX_FILTER</span><span class="p">,</span> <span class="n">bits</span><span class="p">);</span>

	<span class="n">phybits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">ATH9K_RX_FILTER_PHYRADAR</span><span class="p">)</span>
		<span class="n">phybits</span> <span class="o">|=</span> <span class="n">AR_PHY_ERR_RADAR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">ATH9K_RX_FILTER_PHYERR</span><span class="p">)</span>
		<span class="n">phybits</span> <span class="o">|=</span> <span class="n">AR_PHY_ERR_OFDM_TIMING</span> <span class="o">|</span> <span class="n">AR_PHY_ERR_CCK_TIMING</span><span class="p">;</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_ERR</span><span class="p">,</span> <span class="n">phybits</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phybits</span><span class="p">)</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RXCFG</span><span class="p">,</span> <span class="n">AR_RXCFG_ZLFDMA</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RXCFG</span><span class="p">,</span> <span class="n">AR_RXCFG_ZLFDMA</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_setrxfilter</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">ath9k_hw_phy_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_set_reset_reg</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_RESET_WARM</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ath9k_hw_init_pll</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">htc_reset_init</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_phy_disable</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">ath9k_hw_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_setpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_PM_AWAKE</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_set_reset_reg</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ATH9K_RESET_COLD</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ath9k_hw_init_pll</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_disable</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_antenna_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">eeprom_param</span> <span class="n">gain_param</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_2GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">gain_param</span> <span class="o">=</span> <span class="n">EEP_ANTENNA_GAIN_2G</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gain_param</span> <span class="o">=</span> <span class="n">EEP_ANTENNA_GAIN_5G</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">gain_param</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_apply_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_regulatory</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ath9k_hw_regulatory</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan_pwr</span><span class="p">,</span> <span class="n">new_pwr</span><span class="p">,</span> <span class="n">max_gain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ant_gain</span><span class="p">,</span> <span class="n">ant_reduction</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">chan_pwr</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">max_power</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MAX_RATE_POWER</span><span class="p">);</span>
	<span class="n">new_pwr</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">chan_pwr</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">power_limit</span><span class="p">);</span>
	<span class="n">max_gain</span> <span class="o">=</span> <span class="n">chan_pwr</span> <span class="o">-</span> <span class="n">new_pwr</span> <span class="o">+</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">max_antenna_gain</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ant_gain</span> <span class="o">=</span> <span class="n">get_antenna_gain</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ant_gain</span> <span class="o">&gt;</span> <span class="n">max_gain</span><span class="p">)</span>
		<span class="n">ant_reduction</span> <span class="o">=</span> <span class="n">ant_gain</span> <span class="o">-</span> <span class="n">max_gain</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">set_txpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
				 <span class="n">ath9k_regd_get_ctl</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">chan</span><span class="p">),</span>
				 <span class="n">ant_reduction</span><span class="p">,</span> <span class="n">new_pwr</span><span class="p">,</span> <span class="n">test</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_set_txpowerlimit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">limit</span><span class="p">,</span> <span class="n">bool</span> <span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_regulatory</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ath9k_hw_regulatory</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">power_limit</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">MAX_RATE_POWER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="p">)</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">max_power</span> <span class="o">=</span> <span class="n">MAX_RATE_POWER</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">ath9k_hw_apply_txpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">test</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="p">)</span>
		<span class="n">channel</span><span class="o">-&gt;</span><span class="n">max_power</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">max_power_level</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_set_txpowerlimit</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_setopmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath9k_hw_set_operating_mode</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_setopmode</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_setmcastfilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">filter0</span><span class="p">,</span> <span class="n">u32</span> <span class="n">filter1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MCAST_FIL0</span><span class="p">,</span> <span class="n">filter0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MCAST_FIL1</span><span class="p">,</span> <span class="n">filter1</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_setmcastfilter</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_write_associd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_BSS_ID0</span><span class="p">,</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span><span class="p">));</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_BSS_ID1</span><span class="p">,</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">curbssid</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
		  <span class="p">((</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">curaid</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">AR_BSS_ID1_AID_S</span><span class="p">));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_write_associd</span><span class="p">);</span>

<span class="cp">#define ATH9K_MAX_TSF_READ 10</span>

<span class="n">u64</span> <span class="nf">ath9k_hw_gettsf64</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tsf_lower</span><span class="p">,</span> <span class="n">tsf_upper1</span><span class="p">,</span> <span class="n">tsf_upper2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tsf_upper1</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TSF_U32</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_MAX_TSF_READ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tsf_lower</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TSF_L32</span><span class="p">);</span>
		<span class="n">tsf_upper2</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TSF_U32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tsf_upper2</span> <span class="o">==</span> <span class="n">tsf_upper1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">tsf_upper1</span> <span class="o">=</span> <span class="n">tsf_upper2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span> <span class="n">i</span> <span class="o">==</span> <span class="n">ATH9K_MAX_TSF_READ</span> <span class="p">);</span>

	<span class="k">return</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">tsf_upper1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">tsf_lower</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_gettsf64</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_settsf64</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tsf64</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TSF_L32</span><span class="p">,</span> <span class="n">tsf64</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TSF_U32</span><span class="p">,</span> <span class="p">(</span><span class="n">tsf64</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_settsf64</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_reset_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath9k_hw_wait</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_SLP32_MODE</span><span class="p">,</span> <span class="n">AR_SLP32_TSF_WRITE_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">AH_TSF_WRITE_TIMEOUT</span><span class="p">))</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">RESET</span><span class="p">,</span>
			<span class="s">&quot;AR_SLP32_TSF_WRITE_STATUS limit exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_RESET_TSF</span><span class="p">,</span> <span class="n">AR_RESET_TSF_ONCE</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_reset_tsf</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_set_tsfadjust</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">setting</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setting</span><span class="p">)</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">misc_mode</span> <span class="o">|=</span> <span class="n">AR_PCU_TX_ADD_TSF</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">misc_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR_PCU_TX_ADD_TSF</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_set_tsfadjust</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_set11nmac2040</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macmode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht40</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cwm_ignore_extcca</span><span class="p">)</span>
		<span class="n">macmode</span> <span class="o">=</span> <span class="n">AR_2040_JOINED_RX_CLEAR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">macmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_2040_MODE</span><span class="p">,</span> <span class="n">macmode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* HW Generic timers configuration */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_gen_timer_configuration</span> <span class="n">gen_tmr_configuration</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP_TIMER</span><span class="p">,</span> <span class="n">AR_NDP_PERIOD</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP_TIMER</span><span class="p">,</span> <span class="n">AR_NDP_PERIOD</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP_TIMER</span><span class="p">,</span> <span class="n">AR_NDP_PERIOD</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP_TIMER</span><span class="p">,</span> <span class="n">AR_NDP_PERIOD</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP_TIMER</span><span class="p">,</span> <span class="n">AR_NDP_PERIOD</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP_TIMER</span><span class="p">,</span> <span class="n">AR_NDP_PERIOD</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP_TIMER</span><span class="p">,</span> <span class="n">AR_NDP_PERIOD</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP_TIMER</span><span class="p">,</span> <span class="n">AR_NDP_PERIOD</span><span class="p">,</span> <span class="n">AR_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP2_TIMER</span><span class="p">,</span> <span class="n">AR_NDP2_PERIOD</span><span class="p">,</span> <span class="n">AR_NDP2_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP2_TIMER</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">AR_NDP2_PERIOD</span> <span class="o">+</span> <span class="mi">1</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
				<span class="n">AR_NDP2_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP2_TIMER</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">AR_NDP2_PERIOD</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
				<span class="n">AR_NDP2_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP2_TIMER</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">AR_NDP2_PERIOD</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
				<span class="n">AR_NDP2_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP2_TIMER</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">AR_NDP2_PERIOD</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
				<span class="n">AR_NDP2_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP2_TIMER</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">AR_NDP2_PERIOD</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
				<span class="n">AR_NDP2_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP2_TIMER</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">AR_NDP2_PERIOD</span> <span class="o">+</span> <span class="mi">6</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
				<span class="n">AR_NDP2_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">},</span>
	<span class="p">{</span><span class="n">AR_NEXT_NDP2_TIMER</span> <span class="o">+</span> <span class="mi">7</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">AR_NDP2_PERIOD</span> <span class="o">+</span> <span class="mi">7</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
				<span class="n">AR_NDP2_TIMER_MODE</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* HW generic timer primitives */</span>

<span class="cm">/* compute and clear index of rightmost 1 */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">rightmost_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_gen_timer_table</span> <span class="o">*</span><span class="n">timer_table</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">b</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">b</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="mi">0</span><span class="o">-</span><span class="n">b</span><span class="p">);</span>
	<span class="o">*</span><span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">b</span><span class="p">;</span>
	<span class="n">b</span> <span class="o">*=</span> <span class="n">debruijn32</span><span class="p">;</span>
	<span class="n">b</span> <span class="o">&gt;&gt;=</span> <span class="mi">27</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">timer_table</span><span class="o">-&gt;</span><span class="n">gen_timer_index</span><span class="p">[</span><span class="n">b</span><span class="p">];</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">ath9k_hw_gettsf32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_TSF_L32</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_gettsf32</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ath_gen_timer</span> <span class="o">*</span><span class="nf">ath_gen_timer_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
					  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">trigger</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
					  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">overflow</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
					  <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="n">timer_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_gen_timer_table</span> <span class="o">*</span><span class="n">timer_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_gen_timers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_gen_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">;</span>

	<span class="n">timer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_gen_timer</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span>
			<span class="s">&quot;Failed to allocate memory for hw timer[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">timer_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate a hardware generic timer slot */</span>
	<span class="n">timer_table</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="n">timer_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">timer</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">timer_index</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">trigger</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">overflow</span> <span class="o">=</span> <span class="n">overflow</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">timer</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath_gen_timer_alloc</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_gen_timer_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ath_gen_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">trig_timeout</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">timer_period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_gen_timer_table</span> <span class="o">*</span><span class="n">timer_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_gen_timers</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tsf</span><span class="p">,</span> <span class="n">timer_next</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">timer_period</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer_table</span><span class="o">-&gt;</span><span class="n">timer_mask</span><span class="p">.</span><span class="n">timer_bits</span><span class="p">);</span>

	<span class="n">tsf</span> <span class="o">=</span> <span class="n">ath9k_hw_gettsf32</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">timer_next</span> <span class="o">=</span> <span class="n">tsf</span> <span class="o">+</span> <span class="n">trig_timeout</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">HWTIMER</span><span class="p">,</span>
		<span class="s">&quot;current tsf %x period %x timer_next %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tsf</span><span class="p">,</span> <span class="n">timer_period</span><span class="p">,</span> <span class="n">timer_next</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Program generic timer registers</span>
<span class="cm">	 */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">gen_tmr_configuration</span><span class="p">[</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">next_addr</span><span class="p">,</span>
		 <span class="n">timer_next</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">gen_tmr_configuration</span><span class="p">[</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">period_addr</span><span class="p">,</span>
		  <span class="n">timer_period</span><span class="p">);</span>
	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">gen_tmr_configuration</span><span class="p">[</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">mode_addr</span><span class="p">,</span>
		    <span class="n">gen_tmr_configuration</span><span class="p">[</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">mode_mask</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Starting from AR9462, each generic timer can select which tsf</span>
<span class="cm">		 * to use. But we still follow the old rule, 0 - 7 use tsf and</span>
<span class="cm">		 * 8 - 15  use tsf2.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">AR_GEN_TIMER_BANK_1_LEN</span><span class="p">))</span>
			<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MAC_PCU_GEN_TIMER_TSF_SEL</span><span class="p">,</span>
				       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MAC_PCU_GEN_TIMER_TSF_SEL</span><span class="p">,</span>
				       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Enable both trigger and thresh interrupt masks */</span>
	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_IMR_S5</span><span class="p">,</span>
		<span class="p">(</span><span class="n">SM</span><span class="p">(</span><span class="n">AR_GENTMR_BIT</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="n">AR_IMR_S5_GENTIMER_THRESH</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">SM</span><span class="p">(</span><span class="n">AR_GENTMR_BIT</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="n">AR_IMR_S5_GENTIMER_TRIG</span><span class="p">)));</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_gen_timer_start</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_gen_timer_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_gen_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_gen_timer_table</span> <span class="o">*</span><span class="n">timer_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_gen_timers</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">AR_FIRST_NDP_TIMER</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ATH_MAX_GEN_TIMER</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear generic timer enable bits. */</span>
	<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">gen_tmr_configuration</span><span class="p">[</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">mode_addr</span><span class="p">,</span>
			<span class="n">gen_tmr_configuration</span><span class="p">[</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">mode_mask</span><span class="p">);</span>

	<span class="cm">/* Disable both trigger and thresh interrupt masks */</span>
	<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_IMR_S5</span><span class="p">,</span>
		<span class="p">(</span><span class="n">SM</span><span class="p">(</span><span class="n">AR_GENTMR_BIT</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="n">AR_IMR_S5_GENTIMER_THRESH</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">SM</span><span class="p">(</span><span class="n">AR_GENTMR_BIT</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span> <span class="n">AR_IMR_S5_GENTIMER_TRIG</span><span class="p">)));</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer_table</span><span class="o">-&gt;</span><span class="n">timer_mask</span><span class="p">.</span><span class="n">timer_bits</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_gen_timer_stop</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">ath_gen_timer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_gen_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_gen_timer_table</span> <span class="o">*</span><span class="n">timer_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_gen_timers</span><span class="p">;</span>

	<span class="cm">/* free the hardware generic timer slot */</span>
	<span class="n">timer_table</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath_gen_timer_free</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Generic Timer Interrupts handling</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">ath_gen_timer_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_gen_timer_table</span> <span class="o">*</span><span class="n">timer_table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_gen_timers</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_gen_timer</span> <span class="o">*</span><span class="n">timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">trigger_mask</span><span class="p">,</span> <span class="n">thresh_mask</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="cm">/* get hardware generic timer interrupt status */</span>
	<span class="n">trigger_mask</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">intr_gen_timer_trigger</span><span class="p">;</span>
	<span class="n">thresh_mask</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">intr_gen_timer_thresh</span><span class="p">;</span>
	<span class="n">trigger_mask</span> <span class="o">&amp;=</span> <span class="n">timer_table</span><span class="o">-&gt;</span><span class="n">timer_mask</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="n">thresh_mask</span> <span class="o">&amp;=</span> <span class="n">timer_table</span><span class="o">-&gt;</span><span class="n">timer_mask</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>

	<span class="n">trigger_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">thresh_mask</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">thresh_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">rightmost_index</span><span class="p">(</span><span class="n">timer_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thresh_mask</span><span class="p">);</span>
		<span class="n">timer</span> <span class="o">=</span> <span class="n">timer_table</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">HWTIMER</span><span class="p">,</span> <span class="s">&quot;TSF overflow for Gen timer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">index</span><span class="p">);</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">overflow</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">trigger_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">rightmost_index</span><span class="p">(</span><span class="n">timer_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">trigger_mask</span><span class="p">);</span>
		<span class="n">timer</span> <span class="o">=</span> <span class="n">timer_table</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">HWTIMER</span><span class="p">,</span>
			<span class="s">&quot;Gen timer[%d] trigger</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">timer</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">(</span><span class="n">timer</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath_gen_timer_isr</span><span class="p">);</span>

<span class="cm">/********/</span>
<span class="cm">/* HTC  */</span>
<span class="cm">/********/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">version</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ath_mac_bb_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Devices with external radios */</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_5416_PCI</span><span class="p">,</span>	<span class="s">&quot;5416&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_5416_PCIE</span><span class="p">,</span>	<span class="s">&quot;5418&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_9100</span><span class="p">,</span>		<span class="s">&quot;9100&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_9160</span><span class="p">,</span>		<span class="s">&quot;9160&quot;</span> <span class="p">},</span>
	<span class="cm">/* Single-chip solutions */</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_9280</span><span class="p">,</span>		<span class="s">&quot;9280&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_9285</span><span class="p">,</span>		<span class="s">&quot;9285&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_9287</span><span class="p">,</span>         <span class="s">&quot;9287&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_9271</span><span class="p">,</span>         <span class="s">&quot;9271&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_9300</span><span class="p">,</span>         <span class="s">&quot;9300&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_9330</span><span class="p">,</span>         <span class="s">&quot;9330&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_9340</span><span class="p">,</span>		<span class="s">&quot;9340&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_9485</span><span class="p">,</span>         <span class="s">&quot;9485&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_SREV_VERSION_9462</span><span class="p">,</span>         <span class="s">&quot;9462&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* For devices with external radios */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">version</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ath_rf_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span>				<span class="s">&quot;5133&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_RAD5133_SREV_MAJOR</span><span class="p">,</span>	<span class="s">&quot;5133&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_RAD5122_SREV_MAJOR</span><span class="p">,</span>	<span class="s">&quot;5122&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_RAD2133_SREV_MAJOR</span><span class="p">,</span>	<span class="s">&quot;2133&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">AR_RAD2122_SREV_MAJOR</span><span class="p">,</span>	<span class="s">&quot;2122&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Return the MAC/BB name. &quot;????&quot; is returned if the MAC/BB is unknown.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ath9k_hw_mac_bb_name</span><span class="p">(</span><span class="n">u32</span> <span class="n">mac_bb_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath_mac_bb_names</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath_mac_bb_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span> <span class="o">==</span> <span class="n">mac_bb_version</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">ath_mac_bb_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;????&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return the RF name. &quot;????&quot; is returned if the RF is unknown.</span>
<span class="cm"> * Used for devices with external radios.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">ath9k_hw_rf_name</span><span class="p">(</span><span class="n">u16</span> <span class="n">rf_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath_rf_names</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ath_rf_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">version</span> <span class="o">==</span> <span class="n">rf_version</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">ath_rf_names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;????&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_hw_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hw_name</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">used</span><span class="p">;</span>

	<span class="cm">/* chipsets &gt;= AR9280 are single-chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">hw_name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			       <span class="s">&quot;Atheros AR%s Rev:%x&quot;</span><span class="p">,</span>
			       <span class="n">ath9k_hw_mac_bb_name</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span><span class="p">),</span>
			       <span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macRev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">used</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">hw_name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			       <span class="s">&quot;Atheros AR%s MAC/BB Rev:%x AR%s RF Rev:%x&quot;</span><span class="p">,</span>
			       <span class="n">ath9k_hw_mac_bb_name</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macVersion</span><span class="p">),</span>
			       <span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">macRev</span><span class="p">,</span>
			       <span class="n">ath9k_hw_rf_name</span><span class="p">((</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">analog5GhzRev</span> <span class="o">&amp;</span>
						<span class="n">AR_RADIO_SREV_MAJOR</span><span class="p">)),</span>
			       <span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">phyRev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hw_name</span><span class="p">[</span><span class="n">used</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ath9k_hw_name</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
