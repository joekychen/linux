<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › ar9003_paprd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ar9003_paprd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &quot;hw.h&quot;</span>
<span class="cp">#include &quot;ar9003_phy.h&quot;</span>

<span class="kt">void</span> <span class="nf">ar9003_paprd_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">bool</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ar9300_eeprom</span> <span class="o">*</span><span class="n">eep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">.</span><span class="n">ar9300_eep</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 3 bits for modalHeader5G.papdRateMaskHt20</span>
<span class="cm">	 * is used for sub-band disabling of PAPRD.</span>
<span class="cm">	 * 5G band is divided into 3 sub-bands -- upper,</span>
<span class="cm">	 * middle, lower.</span>
<span class="cm">	 * if bit 30 of modalHeader5G.papdRateMaskHt20 is set</span>
<span class="cm">	 * -- disable PAPRD for upper band 5GHz</span>
<span class="cm">	 * if bit 29 of modalHeader5G.papdRateMaskHt20 is set</span>
<span class="cm">	 * -- disable PAPRD for middle band 5GHz</span>
<span class="cm">	 * if bit 28 of modalHeader5G.papdRateMaskHt20 is set</span>
<span class="cm">	 * -- disable PAPRD for lower band 5GHz</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_5GHZ</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">UPPER_5G_SUB_BAND_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">eep</span><span class="o">-&gt;</span><span class="n">modalHeader5G</span><span class="p">.</span><span class="n">papdRateMaskHt20</span><span class="p">)</span>
								  <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span>
				<span class="n">val</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">MID_5G_SUB_BAND_START</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">eep</span><span class="o">-&gt;</span><span class="n">modalHeader5G</span><span class="p">.</span><span class="n">papdRateMaskHt20</span><span class="p">)</span>
								  <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">29</span><span class="p">))</span>
				<span class="n">val</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">eep</span><span class="o">-&gt;</span><span class="n">modalHeader5G</span><span class="p">.</span><span class="n">papdRateMaskHt20</span><span class="p">)</span>
								  <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">28</span><span class="p">))</span>
				<span class="n">val</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_table_write_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ath9k_hw_apply_txpower</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_CTRL0_B0</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_CTRL0_PAPRD_ENABLE</span><span class="p">,</span> <span class="o">!!</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">tx_chainmask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_CTRL0_B1</span><span class="p">,</span>
			      <span class="n">AR_PHY_PAPRD_CTRL0_PAPRD_ENABLE</span><span class="p">,</span> <span class="o">!!</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">tx_chainmask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_CTRL0_B2</span><span class="p">,</span>
			      <span class="n">AR_PHY_PAPRD_CTRL0_PAPRD_ENABLE</span><span class="p">,</span> <span class="o">!!</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ar9003_paprd_enable</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ar9003_get_training_power_2g</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">power</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">scale</span> <span class="o">=</span> <span class="n">ar9003_get_paprd_scale_factor</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">power</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_POWERTX_RATE5</span><span class="p">,</span>
			       <span class="n">AR_PHY_POWERTX_RATE5_POWERTXHT20_0</span><span class="p">);</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">abs</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_target_power</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">power</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="n">scale</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">power</span> <span class="o">-=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">delta</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">power</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ar9003_get_training_power_5g</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">power</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">scale</span> <span class="o">=</span> <span class="n">ar9003_get_paprd_scale_factor</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_HT40</span><span class="p">(</span><span class="n">chan</span><span class="p">))</span>
		<span class="n">power</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_POWERTX_RATE8</span><span class="p">,</span>
			<span class="n">AR_PHY_POWERTX_RATE8_POWERTXHT40_5</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">power</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_POWERTX_RATE6</span><span class="p">,</span>
			<span class="n">AR_PHY_POWERTX_RATE6_POWERTXHT20_5</span><span class="p">);</span>

	<span class="n">power</span> <span class="o">+=</span> <span class="n">scale</span><span class="p">;</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="n">abs</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_target_power</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">power</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="n">scale</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">get_streams</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">delta</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">delta</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">delta</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CALIBRATE</span><span class="p">,</span> <span class="s">&quot;Invalid tx-chainmask: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">power</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">power</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ar9003_paprd_setup_single_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ctrl0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">AR_PHY_PAPRD_CTRL0_B0</span><span class="p">,</span>
		<span class="n">AR_PHY_PAPRD_CTRL0_B1</span><span class="p">,</span>
		<span class="n">AR_PHY_PAPRD_CTRL0_B2</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ctrl1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">AR_PHY_PAPRD_CTRL1_B0</span><span class="p">,</span>
		<span class="n">AR_PHY_PAPRD_CTRL1_B1</span><span class="p">,</span>
		<span class="n">AR_PHY_PAPRD_CTRL1_B2</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">training_power</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAN_2GHZ</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">))</span>
		<span class="n">training_power</span> <span class="o">=</span> <span class="n">ar9003_get_training_power_2g</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">training_power</span> <span class="o">=</span> <span class="n">ar9003_get_training_power_5g</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CALIBRATE</span><span class="p">,</span> <span class="s">&quot;Training power: %d, Target power: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">training_power</span><span class="p">,</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_target_power</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">training_power</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CALIBRATE</span><span class="p">,</span>
			<span class="s">&quot;PAPRD target power delta out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_training_power</span> <span class="o">=</span> <span class="n">training_power</span><span class="p">;</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_AM2AM</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_AM2AM_MASK</span><span class="p">,</span>
		      <span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_ratemask</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_AM2PM</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_AM2PM_MASK</span><span class="p">,</span>
		      <span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_ratemask</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_HT40</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_HT40_MASK</span><span class="p">,</span>
		      <span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_ratemask_ht40</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_txchains</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ctrl0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="n">AR_PHY_PAPRD_CTRL0_USE_SINGLE_TABLE_MASK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="n">AR_PHY_PAPRD_CTRL1_ADAPTIVE_AM2PM_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="n">AR_PHY_PAPRD_CTRL1_ADAPTIVE_AM2AM_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="n">AR_PHY_PAPRD_CTRL1_ADAPTIVE_SCALING_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="n">AR_PHY_PAPRD_CTRL1_PA_GAIN_SCALE_FACT_MASK</span><span class="p">,</span> <span class="mi">181</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="n">AR_PHY_PAPRD_CTRL1_PAPRD_MAG_SCALE_FACT</span><span class="p">,</span> <span class="mi">361</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="n">AR_PHY_PAPRD_CTRL1_ADAPTIVE_SCALING_ENA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">ctrl0</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			      <span class="n">AR_PHY_PAPRD_CTRL0_PAPRD_MAG_THRSH</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ar9003_paprd_enable</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_SKIP</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_TX_GAIN_FORCE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_RX_BB_GAIN_FORCE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_IQCORR_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_AGC2_SETTLING</span><span class="p">,</span> <span class="mi">28</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL1_CF_CF_PAPRD_TRAIN_ENABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x91</span> <span class="o">:</span> <span class="mi">147</span><span class="p">;</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL2</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_FINE_CORR_LEN</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_COARSE_CORR_LEN</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_NUM_CORR_STAGES</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_MIN_LOOPBACK_DEL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3</span><span class="p">,</span>
			      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP</span><span class="p">,</span>
			      <span class="o">-</span><span class="mi">3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3</span><span class="p">,</span>
			      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP</span><span class="p">,</span>
			      <span class="o">-</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">10</span> <span class="o">:</span> <span class="o">-</span><span class="mi">15</span><span class="p">;</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE</span><span class="p">,</span>
		      <span class="n">val</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_BBTXMIX_DISABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL4</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_SAFETY_DELTA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL4</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_MIN_CORR</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_CNTL4</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_NUM_TRAIN_SAMPLES</span><span class="p">,</span>
		      <span class="mi">100</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_PRE_POST_SCALE_0_B0</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_PRE_POST_SCALING</span><span class="p">,</span> <span class="mi">261376</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_PRE_POST_SCALE_1_B0</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_PRE_POST_SCALING</span><span class="p">,</span> <span class="mi">248079</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_PRE_POST_SCALE_2_B0</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_PRE_POST_SCALING</span><span class="p">,</span> <span class="mi">233759</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_PRE_POST_SCALE_3_B0</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_PRE_POST_SCALING</span><span class="p">,</span> <span class="mi">220464</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_PRE_POST_SCALE_4_B0</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_PRE_POST_SCALING</span><span class="p">,</span> <span class="mi">208194</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_PRE_POST_SCALE_5_B0</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_PRE_POST_SCALING</span><span class="p">,</span> <span class="mi">196949</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_PRE_POST_SCALE_6_B0</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_PRE_POST_SCALING</span><span class="p">,</span> <span class="mi">185706</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_PRE_POST_SCALE_7_B0</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_PRE_POST_SCALING</span><span class="p">,</span> <span class="mi">175487</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_paprd_get_gain_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_gain_table_entries</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">index</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_gain_table_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">AR_PHY_TXGAIN_TABLE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_gain_table_entries</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_gain_table_index</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PAPRD_GAIN_TABLE_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ar9003_get_desired_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chain</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">target_power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">olpc_gain_delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cl_gain_mod</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">alpha_therm</span><span class="p">,</span> <span class="n">alpha_volt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">therm_cal_value</span><span class="p">,</span> <span class="n">volt_cal_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">therm_value</span><span class="p">,</span> <span class="n">volt_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">thermal_gain_corr</span><span class="p">,</span> <span class="n">voltage_gain_corr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">desired_scale</span><span class="p">,</span> <span class="n">desired_gain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_olpc</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg_cl_gain</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_STAT1</span><span class="p">,</span>
		    <span class="n">AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE</span><span class="p">);</span>
	<span class="n">desired_scale</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TPC_12</span><span class="p">,</span>
				       <span class="n">AR_PHY_TPC_12_DESIRED_SCALE_HT40_5</span><span class="p">);</span>
	<span class="n">alpha_therm</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TPC_19</span><span class="p">,</span>
				     <span class="n">AR_PHY_TPC_19_ALPHA_THERM</span><span class="p">);</span>
	<span class="n">alpha_volt</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TPC_19</span><span class="p">,</span>
				    <span class="n">AR_PHY_TPC_19_ALPHA_VOLT</span><span class="p">);</span>
	<span class="n">therm_cal_value</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TPC_18</span><span class="p">,</span>
					 <span class="n">AR_PHY_TPC_18_THERM_CAL_VALUE</span><span class="p">);</span>
	<span class="n">volt_cal_value</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TPC_18</span><span class="p">,</span>
					<span class="n">AR_PHY_TPC_18_VOLT_CAL_VALUE</span><span class="p">);</span>
	<span class="n">therm_value</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_BB_THERM_ADC_4</span><span class="p">,</span>
				     <span class="n">AR_PHY_BB_THERM_ADC_4_LATEST_THERM_VALUE</span><span class="p">);</span>
	<span class="n">volt_value</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_BB_THERM_ADC_4</span><span class="p">,</span>
				    <span class="n">AR_PHY_BB_THERM_ADC_4_LATEST_VOLT_VALUE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">reg_olpc</span> <span class="o">=</span> <span class="n">AR_PHY_TPC_11_B0</span><span class="p">;</span>
		<span class="n">reg_cl_gain</span> <span class="o">=</span> <span class="n">AR_PHY_CL_TAB_0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">reg_olpc</span> <span class="o">=</span> <span class="n">AR_PHY_TPC_11_B1</span><span class="p">;</span>
		<span class="n">reg_cl_gain</span> <span class="o">=</span> <span class="n">AR_PHY_CL_TAB_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">reg_olpc</span> <span class="o">=</span> <span class="n">AR_PHY_TPC_11_B2</span><span class="p">;</span>
		<span class="n">reg_cl_gain</span> <span class="o">=</span> <span class="n">AR_PHY_CL_TAB_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">CALIBRATE</span><span class="p">,</span>
			<span class="s">&quot;Invalid chainmask: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">olpc_gain_delta</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg_olpc</span><span class="p">,</span>
					 <span class="n">AR_PHY_TPC_11_OLPC_GAIN_DELTA</span><span class="p">);</span>
	<span class="n">cl_gain_mod</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg_cl_gain</span><span class="p">,</span>
					 <span class="n">AR_PHY_CL_TAB_CL_GAIN_MOD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">olpc_gain_delta</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">olpc_gain_delta</span> <span class="o">=</span> <span class="n">olpc_gain_delta</span> <span class="o">-</span> <span class="mi">256</span><span class="p">;</span>

	<span class="n">thermal_gain_corr</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha_therm</span> <span class="o">*</span> <span class="p">(</span><span class="n">therm_value</span> <span class="o">-</span> <span class="n">therm_cal_value</span><span class="p">)</span> <span class="o">+</span>
			     <span class="p">(</span><span class="mi">256</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">voltage_gain_corr</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha_volt</span> <span class="o">*</span> <span class="p">(</span><span class="n">volt_value</span> <span class="o">-</span> <span class="n">volt_cal_value</span><span class="p">)</span> <span class="o">+</span>
			     <span class="p">(</span><span class="mi">128</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">desired_gain</span> <span class="o">=</span> <span class="n">target_power</span> <span class="o">-</span> <span class="n">olpc_gain_delta</span> <span class="o">-</span> <span class="n">thermal_gain_corr</span> <span class="o">-</span>
	    <span class="n">voltage_gain_corr</span> <span class="o">+</span> <span class="n">desired_scale</span> <span class="o">+</span> <span class="n">cl_gain_mod</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">desired_gain</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9003_tx_force_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gain_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">selected_gain_entry</span><span class="p">,</span> <span class="n">txbb1dbgain</span><span class="p">,</span> <span class="n">txbb6dbgain</span><span class="p">,</span> <span class="n">txmxrgain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">padrvgnA</span><span class="p">,</span> <span class="n">padrvgnB</span><span class="p">,</span> <span class="n">padrvgnC</span><span class="p">,</span> <span class="n">padrvgnD</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">gain_table_entries</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_gain_table_entries</span><span class="p">;</span>

	<span class="n">selected_gain_entry</span> <span class="o">=</span> <span class="n">gain_table_entries</span><span class="p">[</span><span class="n">gain_index</span><span class="p">];</span>
	<span class="n">txbb1dbgain</span> <span class="o">=</span> <span class="n">selected_gain_entry</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="n">txbb6dbgain</span> <span class="o">=</span> <span class="p">(</span><span class="n">selected_gain_entry</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="n">txmxrgain</span> <span class="o">=</span> <span class="p">(</span><span class="n">selected_gain_entry</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">padrvgnA</span> <span class="o">=</span> <span class="p">(</span><span class="n">selected_gain_entry</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">padrvgnB</span> <span class="o">=</span> <span class="p">(</span><span class="n">selected_gain_entry</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">padrvgnC</span> <span class="o">=</span> <span class="p">(</span><span class="n">selected_gain_entry</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">padrvgnD</span> <span class="o">=</span> <span class="p">(</span><span class="n">selected_gain_entry</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TX_FORCED_GAIN</span><span class="p">,</span>
		      <span class="n">AR_PHY_TX_FORCED_GAIN_FORCED_TXBB1DBGAIN</span><span class="p">,</span> <span class="n">txbb1dbgain</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TX_FORCED_GAIN</span><span class="p">,</span>
		      <span class="n">AR_PHY_TX_FORCED_GAIN_FORCED_TXBB6DBGAIN</span><span class="p">,</span> <span class="n">txbb6dbgain</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TX_FORCED_GAIN</span><span class="p">,</span>
		      <span class="n">AR_PHY_TX_FORCED_GAIN_FORCED_TXMXRGAIN</span><span class="p">,</span> <span class="n">txmxrgain</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TX_FORCED_GAIN</span><span class="p">,</span>
		      <span class="n">AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNA</span><span class="p">,</span> <span class="n">padrvgnA</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TX_FORCED_GAIN</span><span class="p">,</span>
		      <span class="n">AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNB</span><span class="p">,</span> <span class="n">padrvgnB</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TX_FORCED_GAIN</span><span class="p">,</span>
		      <span class="n">AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNC</span><span class="p">,</span> <span class="n">padrvgnC</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TX_FORCED_GAIN</span><span class="p">,</span>
		      <span class="n">AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGND</span><span class="p">,</span> <span class="n">padrvgnD</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TX_FORCED_GAIN</span><span class="p">,</span>
		      <span class="n">AR_PHY_TX_FORCED_GAIN_FORCED_ENABLE_PAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TX_FORCED_GAIN</span><span class="p">,</span>
		      <span class="n">AR_PHY_TX_FORCED_GAIN_FORCE_TX_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TPC_1</span><span class="p">,</span> <span class="n">AR_PHY_TPC_1_FORCED_DAC_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_TPC_1</span><span class="p">,</span> <span class="n">AR_PHY_TPC_1_FORCE_DAC_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">find_expn</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fls</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">find_proper_scale</span><span class="p">(</span><span class="kt">int</span> <span class="n">expn</span><span class="p">,</span> <span class="kt">int</span> <span class="n">N</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">expn</span> <span class="o">&gt;</span> <span class="n">N</span><span class="p">)</span> <span class="o">?</span> <span class="n">expn</span> <span class="o">-</span> <span class="mi">10</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NUM_BIN 23</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">create_pa_curve</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">data_L</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data_U</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pa_table</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">gain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">thresh_accum_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x_est</span><span class="p">[</span><span class="n">NUM_BIN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">Y</span><span class="p">[</span><span class="n">NUM_BIN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="n">NUM_BIN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">PA_in</span><span class="p">[</span><span class="n">NUM_BIN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">B1_tmp</span><span class="p">[</span><span class="n">NUM_BIN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">B2_tmp</span><span class="p">[</span><span class="n">NUM_BIN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">B1_abs_max</span><span class="p">,</span> <span class="n">B2_abs_max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_index</span><span class="p">,</span> <span class="n">scale_factor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y_est</span><span class="p">[</span><span class="n">NUM_BIN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">x_est_fxp1_nonlin</span><span class="p">,</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">NUM_BIN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x_tilde_abs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">G_fxp</span><span class="p">,</span> <span class="n">Y_intercept</span><span class="p">,</span> <span class="n">order_x_by_y</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">sum_y_sqr</span><span class="p">,</span> <span class="n">sum_y_quad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Q_x</span><span class="p">,</span> <span class="n">Q_B1</span><span class="p">,</span> <span class="n">Q_B2</span><span class="p">,</span> <span class="n">beta_raw</span><span class="p">,</span> <span class="n">alpha_raw</span><span class="p">,</span> <span class="n">scale_B</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Q_scale_B</span><span class="p">,</span> <span class="n">Q_beta</span><span class="p">,</span> <span class="n">Q_alpha</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">order_1</span><span class="p">,</span> <span class="n">order_2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">order1_5x</span><span class="p">,</span> <span class="n">order2_3x</span><span class="p">,</span> <span class="n">order1_5x_rem</span><span class="p">,</span> <span class="n">order2_3x_rem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y5</span><span class="p">,</span> <span class="n">y3</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">theta_low_bin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* disregard any bin that contains &lt;= 16 samples */</span>
	<span class="n">thresh_accum_cnt</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">max_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">theta</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">x_est</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x_est</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Y</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">y_est</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">y_est</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">x_tilde</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x_tilde</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_BIN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="n">accum_cnt</span><span class="p">,</span> <span class="n">accum_tx</span><span class="p">,</span> <span class="n">accum_rx</span><span class="p">,</span> <span class="n">accum_ang</span><span class="p">;</span>

		<span class="cm">/* number of samples */</span>
		<span class="n">accum_cnt</span> <span class="o">=</span> <span class="n">data_L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">accum_cnt</span> <span class="o">&lt;=</span> <span class="n">thresh_accum_cnt</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* sum(tx amplitude) */</span>
		<span class="n">accum_tx</span> <span class="o">=</span> <span class="p">((</span><span class="n">data_L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">data_U</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="cm">/* sum(rx amplitude distance to lower bin edge) */</span>
		<span class="n">accum_rx</span> <span class="o">=</span> <span class="p">((</span><span class="n">data_U</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">data_L</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">23</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

		<span class="cm">/* sum(angles) */</span>
		<span class="n">accum_ang</span> <span class="o">=</span> <span class="p">((</span><span class="n">data_L</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">23</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">data_U</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">23</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">accum_tx</span> <span class="o">&lt;&lt;=</span> <span class="n">scale_factor</span><span class="p">;</span>
		<span class="n">accum_rx</span> <span class="o">&lt;&lt;=</span> <span class="n">scale_factor</span><span class="p">;</span>
		<span class="n">x_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">accum_tx</span> <span class="o">+</span> <span class="n">accum_cnt</span><span class="p">)</span> <span class="o">/</span> <span class="n">accum_cnt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		    <span class="n">scale_factor</span><span class="p">;</span>

		<span class="n">Y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((((</span><span class="n">accum_rx</span> <span class="o">+</span> <span class="n">accum_cnt</span><span class="p">)</span> <span class="o">/</span> <span class="n">accum_cnt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			    <span class="n">scale_factor</span><span class="p">)</span> <span class="o">+</span>
			    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_index</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">accum_ang</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">))</span>
			<span class="n">accum_ang</span> <span class="o">-=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">;</span>

		<span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">accum_ang</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scale_factor</span><span class="p">))</span> <span class="o">+</span> <span class="n">accum_cnt</span><span class="p">)</span> <span class="o">/</span>
		    <span class="n">accum_cnt</span><span class="p">;</span>

		<span class="n">max_index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Find average theta of first 5 bin and all of those to same value.</span>
<span class="cm">	 * Curve is linear at that range.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">theta_low_bin</span> <span class="o">+=</span> <span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">theta_low_bin</span> <span class="o">=</span> <span class="n">theta_low_bin</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_low_bin</span><span class="p">;</span>

	<span class="cm">/* Set values at origin */</span>
	<span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta_low_bin</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">max_index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">theta_low_bin</span><span class="p">;</span>

	<span class="n">x_est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* low signal gain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x_est</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">==</span> <span class="n">x_est</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">G_fxp</span> <span class="o">=</span>
	    <span class="p">(((</span><span class="n">Y</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">+</span>
	     <span class="p">(</span><span class="n">x_est</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_est</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_est</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_est</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="cm">/* prevent division by zero */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">G_fxp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">Y_intercept</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">G_fxp</span> <span class="o">*</span> <span class="p">(</span><span class="n">x_est</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_est</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span>
	     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scale_factor</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">+</span> <span class="n">Y</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">max_index</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">y_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Y_intercept</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">y_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">x_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">y_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">+</span> <span class="n">G_fxp</span><span class="p">)</span> <span class="o">/</span> <span class="n">G_fxp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y_est</span><span class="p">[</span><span class="n">max_index</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">x_est_fxp1_nonlin</span> <span class="o">=</span>
	    <span class="n">x_est</span><span class="p">[</span><span class="n">max_index</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">y_est</span><span class="p">[</span><span class="n">max_index</span><span class="p">]</span> <span class="o">+</span>
				<span class="n">G_fxp</span><span class="p">)</span> <span class="o">/</span> <span class="n">G_fxp</span><span class="p">;</span>

	<span class="n">order_x_by_y</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">x_est_fxp1_nonlin</span> <span class="o">+</span> <span class="n">y_est</span><span class="p">[</span><span class="n">max_index</span><span class="p">])</span> <span class="o">/</span> <span class="n">y_est</span><span class="p">[</span><span class="n">max_index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">order_x_by_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">M</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">order_x_by_y</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">M</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">M</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">I</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_index</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">?</span> <span class="mi">7</span> <span class="o">:</span> <span class="n">max_index</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">L</span> <span class="o">=</span> <span class="n">max_index</span> <span class="o">-</span> <span class="n">I</span><span class="p">;</span>
	<span class="n">scale_factor</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sum_y_sqr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sum_y_quad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">x_tilde_abs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">L</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y_sqr</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y_quad</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp_abs</span><span class="p">;</span>

		<span class="cm">/* prevent division by zero */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">x_est_fxp1_nonlin</span> <span class="o">=</span>
		    <span class="n">x_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">]</span> <span class="o">+</span>
				    <span class="n">G_fxp</span><span class="p">)</span> <span class="o">/</span> <span class="n">G_fxp</span><span class="p">;</span>

		<span class="n">x_tilde</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">x_est_fxp1_nonlin</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">])</span> <span class="o">/</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span>
									  <span class="n">I</span><span class="p">];</span>
		<span class="n">x_tilde</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">x_tilde</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">])</span> <span class="o">/</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">];</span>
		<span class="n">x_tilde</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">x_tilde</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">])</span> <span class="o">/</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">];</span>
		<span class="n">y_sqr</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">]</span> <span class="o">*</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">]</span> <span class="o">+</span>
		     <span class="p">(</span><span class="n">scale_factor</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">scale_factor</span> <span class="o">*</span>
						       <span class="n">scale_factor</span><span class="p">);</span>
		<span class="n">tmp_abs</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">x_tilde</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_abs</span> <span class="o">&gt;</span> <span class="n">x_tilde_abs</span><span class="p">)</span>
			<span class="n">x_tilde_abs</span> <span class="o">=</span> <span class="n">tmp_abs</span><span class="p">;</span>

		<span class="n">y_quad</span> <span class="o">=</span> <span class="n">y_sqr</span> <span class="o">*</span> <span class="n">y_sqr</span><span class="p">;</span>
		<span class="n">sum_y_sqr</span> <span class="o">=</span> <span class="n">sum_y_sqr</span> <span class="o">+</span> <span class="n">y_sqr</span><span class="p">;</span>
		<span class="n">sum_y_quad</span> <span class="o">=</span> <span class="n">sum_y_quad</span> <span class="o">+</span> <span class="n">y_quad</span><span class="p">;</span>
		<span class="n">B1_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_sqr</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">B2_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_sqr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">B1_abs_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">B2_abs_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">L</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">abs_val</span><span class="p">;</span>

		<span class="n">B1_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">sum_y_sqr</span><span class="p">;</span>
		<span class="n">B2_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sum_y_quad</span> <span class="o">-</span> <span class="n">sum_y_sqr</span> <span class="o">*</span> <span class="n">B2_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">abs_val</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">B1_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs_val</span> <span class="o">&gt;</span> <span class="n">B1_abs_max</span><span class="p">)</span>
			<span class="n">B1_abs_max</span> <span class="o">=</span> <span class="n">abs_val</span><span class="p">;</span>

		<span class="n">abs_val</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">B2_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs_val</span> <span class="o">&gt;</span> <span class="n">B2_abs_max</span><span class="p">)</span>
			<span class="n">B2_abs_max</span> <span class="o">=</span> <span class="n">abs_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Q_x</span> <span class="o">=</span> <span class="n">find_proper_scale</span><span class="p">(</span><span class="n">find_expn</span><span class="p">(</span><span class="n">x_tilde_abs</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">Q_B1</span> <span class="o">=</span> <span class="n">find_proper_scale</span><span class="p">(</span><span class="n">find_expn</span><span class="p">(</span><span class="n">B1_abs_max</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">Q_B2</span> <span class="o">=</span> <span class="n">find_proper_scale</span><span class="p">(</span><span class="n">find_expn</span><span class="p">(</span><span class="n">B2_abs_max</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">beta_raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">alpha_raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">L</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x_tilde</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">Q_x</span><span class="p">);</span>
		<span class="n">B1_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">B1_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">Q_B1</span><span class="p">);</span>
		<span class="n">B2_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">B2_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">Q_B2</span><span class="p">);</span>
		<span class="n">beta_raw</span> <span class="o">=</span> <span class="n">beta_raw</span> <span class="o">+</span> <span class="n">B1_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">alpha_raw</span> <span class="o">=</span> <span class="n">alpha_raw</span> <span class="o">+</span> <span class="n">B2_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">x_tilde</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">scale_B</span> <span class="o">=</span>
	    <span class="p">((</span><span class="n">sum_y_quad</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">L</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
	     <span class="p">(</span><span class="n">sum_y_sqr</span> <span class="o">/</span> <span class="n">scale_factor</span><span class="p">)</span> <span class="o">*</span> <span class="n">sum_y_sqr</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_factor</span><span class="p">;</span>

	<span class="n">Q_scale_B</span> <span class="o">=</span> <span class="n">find_proper_scale</span><span class="p">(</span><span class="n">find_expn</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">scale_B</span><span class="p">)),</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">scale_B</span> <span class="o">=</span> <span class="n">scale_B</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">Q_scale_B</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scale_B</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">Q_beta</span> <span class="o">=</span> <span class="n">find_proper_scale</span><span class="p">(</span><span class="n">find_expn</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">beta_raw</span><span class="p">)),</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">Q_alpha</span> <span class="o">=</span> <span class="n">find_proper_scale</span><span class="p">(</span><span class="n">find_expn</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha_raw</span><span class="p">)),</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">beta_raw</span> <span class="o">=</span> <span class="n">beta_raw</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">Q_beta</span><span class="p">);</span>
	<span class="n">alpha_raw</span> <span class="o">=</span> <span class="n">alpha_raw</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">Q_alpha</span><span class="p">);</span>
	<span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha_raw</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_B</span><span class="p">;</span>
	<span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta_raw</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_B</span><span class="p">;</span>
	<span class="n">order_1</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Q_x</span> <span class="o">-</span> <span class="n">Q_B1</span> <span class="o">-</span> <span class="n">Q_beta</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">Q_scale_B</span><span class="p">;</span>
	<span class="n">order_2</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Q_x</span> <span class="o">-</span> <span class="n">Q_B2</span> <span class="o">-</span> <span class="n">Q_alpha</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">Q_scale_B</span><span class="p">;</span>
	<span class="n">order1_5x</span> <span class="o">=</span> <span class="n">order_1</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">order2_3x</span> <span class="o">=</span> <span class="n">order_2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">order1_5x_rem</span> <span class="o">=</span> <span class="n">order_1</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">order1_5x</span><span class="p">;</span>
	<span class="n">order2_3x_rem</span> <span class="o">=</span> <span class="n">order_2</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">order2_3x</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PAPRD_TABLE_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">y5</span> <span class="o">=</span> <span class="p">((</span><span class="n">beta</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">order1_5x</span><span class="p">;</span>
		<span class="n">y5</span> <span class="o">=</span> <span class="p">(</span><span class="n">y5</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">order1_5x</span><span class="p">;</span>
		<span class="n">y5</span> <span class="o">=</span> <span class="p">(</span><span class="n">y5</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">order1_5x</span><span class="p">;</span>
		<span class="n">y5</span> <span class="o">=</span> <span class="p">(</span><span class="n">y5</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">order1_5x</span><span class="p">;</span>
		<span class="n">y5</span> <span class="o">=</span> <span class="p">(</span><span class="n">y5</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">order1_5x</span><span class="p">;</span>
		<span class="n">y5</span> <span class="o">=</span> <span class="n">y5</span> <span class="o">&gt;&gt;</span> <span class="n">order1_5x_rem</span><span class="p">;</span>
		<span class="n">y3</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">order2_3x</span><span class="p">;</span>
		<span class="n">y3</span> <span class="o">=</span> <span class="p">(</span><span class="n">y3</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">order2_3x</span><span class="p">;</span>
		<span class="n">y3</span> <span class="o">=</span> <span class="p">(</span><span class="n">y3</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">order2_3x</span><span class="p">;</span>
		<span class="n">y3</span> <span class="o">=</span> <span class="n">y3</span> <span class="o">&gt;&gt;</span> <span class="n">order2_3x_rem</span><span class="p">;</span>
		<span class="n">PA_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">y5</span> <span class="o">+</span> <span class="n">y3</span> <span class="o">+</span> <span class="p">(</span><span class="mi">256</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="n">G_fxp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">PA_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">PA_in</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">PA_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">PA_in</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">PA_in</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
						    <span class="n">PA_in</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">PA_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">PA_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1400</span><span class="p">)</span> <span class="o">?</span> <span class="n">PA_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="mi">1400</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">beta_raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">alpha_raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">L</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">theta_tilde</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">])</span> <span class="o">/</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">];</span>
		<span class="n">theta_tilde</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">theta_tilde</span> <span class="o">&lt;&lt;</span> <span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">])</span> <span class="o">/</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">];</span>
		<span class="n">theta_tilde</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">theta_tilde</span> <span class="o">&lt;&lt;</span> <span class="n">M</span><span class="p">)</span> <span class="o">+</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">])</span> <span class="o">/</span> <span class="n">y_est</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span><span class="p">];</span>
		<span class="n">beta_raw</span> <span class="o">=</span> <span class="n">beta_raw</span> <span class="o">+</span> <span class="n">B1_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">theta_tilde</span><span class="p">;</span>
		<span class="n">alpha_raw</span> <span class="o">=</span> <span class="n">alpha_raw</span> <span class="o">+</span> <span class="n">B2_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">theta_tilde</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">Q_beta</span> <span class="o">=</span> <span class="n">find_proper_scale</span><span class="p">(</span><span class="n">find_expn</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">beta_raw</span><span class="p">)),</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">Q_alpha</span> <span class="o">=</span> <span class="n">find_proper_scale</span><span class="p">(</span><span class="n">find_expn</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha_raw</span><span class="p">)),</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">beta_raw</span> <span class="o">=</span> <span class="n">beta_raw</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">Q_beta</span><span class="p">);</span>
	<span class="n">alpha_raw</span> <span class="o">=</span> <span class="n">alpha_raw</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">Q_alpha</span><span class="p">);</span>

	<span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha_raw</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_B</span><span class="p">;</span>
	<span class="n">beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">beta_raw</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="n">scale_B</span><span class="p">;</span>
	<span class="n">order_1</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Q_x</span> <span class="o">-</span> <span class="n">Q_B1</span> <span class="o">-</span> <span class="n">Q_beta</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">Q_scale_B</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">order_2</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">M</span> <span class="o">-</span> <span class="n">Q_x</span> <span class="o">-</span> <span class="n">Q_B2</span> <span class="o">-</span> <span class="n">Q_alpha</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">Q_scale_B</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">order1_5x</span> <span class="o">=</span> <span class="n">order_1</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">order2_3x</span> <span class="o">=</span> <span class="n">order_2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">order1_5x_rem</span> <span class="o">=</span> <span class="n">order_1</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">order1_5x</span><span class="p">;</span>
	<span class="n">order2_3x_rem</span> <span class="o">=</span> <span class="n">order_2</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">order2_3x</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PAPRD_TABLE_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">PA_angle</span><span class="p">;</span>

		<span class="cm">/* pa_table[4] is calculated from PA_angle for i=5 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">beta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">y5</span> <span class="o">=</span> <span class="p">(((</span><span class="n">beta</span> <span class="o">*</span> <span class="n">tmp</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span>
			      <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order1_5x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order1_5x</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">y5</span> <span class="o">=</span> <span class="p">((((</span><span class="n">beta</span> <span class="o">*</span> <span class="n">tmp</span> <span class="o">-</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span>
			       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order1_5x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order1_5x</span><span class="p">));</span>

		<span class="n">y5</span> <span class="o">=</span> <span class="p">(</span><span class="n">y5</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order1_5x</span><span class="p">);</span>
		<span class="n">y5</span> <span class="o">=</span> <span class="p">(</span><span class="n">y5</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order1_5x</span><span class="p">);</span>
		<span class="n">y5</span> <span class="o">=</span> <span class="p">(</span><span class="n">y5</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order1_5x</span><span class="p">);</span>
		<span class="n">y5</span> <span class="o">=</span> <span class="p">(</span><span class="n">y5</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order1_5x</span><span class="p">);</span>
		<span class="n">y5</span> <span class="o">=</span> <span class="n">y5</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order1_5x_rem</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">beta</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">y3</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">tmp</span> <span class="o">-</span>
			      <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order2_3x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order2_3x</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">y3</span> <span class="o">=</span> <span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">tmp</span> <span class="o">+</span>
			      <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order2_3x</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order2_3x</span><span class="p">);</span>
		<span class="n">y3</span> <span class="o">=</span> <span class="p">(</span><span class="n">y3</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order2_3x</span><span class="p">);</span>
		<span class="n">y3</span> <span class="o">=</span> <span class="p">(</span><span class="n">y3</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order2_3x</span><span class="p">);</span>
		<span class="n">y3</span> <span class="o">=</span> <span class="n">y3</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order2_3x_rem</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PA_angle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">PA_angle</span> <span class="o">=</span> <span class="n">y5</span> <span class="o">+</span> <span class="n">y3</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">PA_angle</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">150</span><span class="p">)</span>
				<span class="n">PA_angle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">150</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">PA_angle</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">)</span>
				<span class="n">PA_angle</span> <span class="o">=</span> <span class="mi">150</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pa_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">PA_in</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">PA_angle</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PA_angle</span> <span class="o">=</span> <span class="p">(</span><span class="n">PA_angle</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pa_table</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">PA_in</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span>
			    <span class="p">(</span><span class="n">PA_angle</span> <span class="o">&amp;</span> <span class="mh">0x7ff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">gain</span> <span class="o">=</span> <span class="n">G_fxp</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ar9003_paprd_populate_single_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ath9k_hw_cal_data</span> <span class="o">*</span><span class="n">caldata</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">chain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">paprd_table_val</span> <span class="o">=</span> <span class="n">caldata</span><span class="o">-&gt;</span><span class="n">pa_table</span><span class="p">[</span><span class="n">chain</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">small_signal_gain</span> <span class="o">=</span> <span class="n">caldata</span><span class="o">-&gt;</span><span class="n">small_signal_gain</span><span class="p">[</span><span class="n">chain</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">training_power</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_training_power</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">AR_PHY_PAPRD_MEM_TAB_B0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chain</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">AR_PHY_PAPRD_MEM_TAB_B1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chain</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">AR_PHY_PAPRD_MEM_TAB_B2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PAPRD_TABLE_SZ</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">paprd_table_val</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">AR_PHY_PA_GAIN123_B0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chain</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">AR_PHY_PA_GAIN123_B1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">AR_PHY_PA_GAIN123_B2</span><span class="p">;</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">AR_PHY_PA_GAIN123_PA_GAIN1</span><span class="p">,</span> <span class="n">small_signal_gain</span><span class="p">);</span>

	<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_CTRL1_B0</span><span class="p">,</span>
		      <span class="n">AR_PHY_PAPRD_CTRL1_PAPRD_POWER_AT_AM2AM_CAL</span><span class="p">,</span>
		      <span class="n">training_power</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">tx_chainmask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_CTRL1_B1</span><span class="p">,</span>
			      <span class="n">AR_PHY_PAPRD_CTRL1_PAPRD_POWER_AT_AM2AM_CAL</span><span class="p">,</span>
			      <span class="n">training_power</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">tx_chainmask</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
		<span class="cm">/* val AR_PHY_PAPRD_CTRL1_PAPRD_POWER_AT_AM2AM_CAL correct? */</span>
		<span class="n">REG_RMW_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_CTRL1_B2</span><span class="p">,</span>
			      <span class="n">AR_PHY_PAPRD_CTRL1_PAPRD_POWER_AT_AM2AM_CAL</span><span class="p">,</span>
			      <span class="n">training_power</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ar9003_paprd_populate_single_table</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ar9003_paprd_setup_gain_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">desired_gain</span><span class="p">,</span> <span class="n">gain_index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">train_power</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_training_power</span><span class="p">;</span>

	<span class="n">desired_gain</span> <span class="o">=</span> <span class="n">ar9003_get_desired_gain</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">train_power</span><span class="p">);</span>

	<span class="n">gain_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PAPRD_GAIN_TABLE_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">paprd_gain_table_index</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">desired_gain</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">gain_index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ar9003_tx_force_gain</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">gain_index</span><span class="p">);</span>

	<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_STAT1</span><span class="p">,</span>
			<span class="n">AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ar9003_paprd_setup_gain_table</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ar9003_paprd_create_curve</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ath9k_hw_cal_data</span> <span class="o">*</span><span class="n">caldata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">small_signal_gain</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">caldata</span><span class="o">-&gt;</span><span class="n">small_signal_gain</span><span class="p">[</span><span class="n">chain</span><span class="p">];</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pa_table</span> <span class="o">=</span> <span class="n">caldata</span><span class="o">-&gt;</span><span class="n">pa_table</span><span class="p">[</span><span class="n">chain</span><span class="p">];</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">data_L</span><span class="p">,</span> <span class="o">*</span><span class="n">data_U</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">caldata</span><span class="o">-&gt;</span><span class="n">pa_table</span><span class="p">[</span><span class="n">chain</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">caldata</span><span class="o">-&gt;</span><span class="n">pa_table</span><span class="p">[</span><span class="n">chain</span><span class="p">]));</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">48</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">data_L</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">data_U</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span>

	<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CHAN_INFO_MEMORY</span><span class="p">,</span>
		    <span class="n">AR_PHY_CHAN_INFO_MEMORY_CHANINFOMEM_S2_READ</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">AR_PHY_CHAN_INFO_TAB_0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">48</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data_L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_CHAN_INFO_MEMORY</span><span class="p">,</span>
		    <span class="n">AR_PHY_CHAN_INFO_MEMORY_CHANINFOMEM_S2_READ</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">48</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data_U</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">create_pa_curve</span><span class="p">(</span><span class="n">data_L</span><span class="p">,</span> <span class="n">data_U</span><span class="p">,</span> <span class="n">pa_table</span><span class="p">,</span> <span class="n">small_signal_gain</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>

	<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_STAT1</span><span class="p">,</span>
		    <span class="n">AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ar9003_paprd_create_curve</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">ar9003_paprd_init_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ar9003_paprd_setup_single_table</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ar9003_paprd_get_gain_table</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ar9003_paprd_init_table</span><span class="p">);</span>

<span class="n">bool</span> <span class="nf">ar9003_paprd_is_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">paprd_done</span><span class="p">,</span> <span class="n">agc2_pwr</span><span class="p">;</span>
	<span class="n">paprd_done</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_STAT1</span><span class="p">,</span>
				<span class="n">AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">paprd_done</span> <span class="o">==</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">agc2_pwr</span> <span class="o">=</span> <span class="n">REG_READ_FIELD</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_PAPRD_TRAINER_STAT1</span><span class="p">,</span>
				<span class="n">AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_AGC2_PWR</span><span class="p">);</span>

		<span class="n">ath_dbg</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span> <span class="n">CALIBRATE</span><span class="p">,</span>
			<span class="s">&quot;AGC2_PWR = 0x%x training done = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">agc2_pwr</span><span class="p">,</span> <span class="n">paprd_done</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * agc2_pwr range should not be less than &#39;IDEAL_AGC2_PWR_CHANGE&#39;</span>
<span class="cm">	 * when the training is completely done, otherwise retraining is</span>
<span class="cm">	 * done to make sure the value is in ideal range</span>
<span class="cm">	 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">agc2_pwr</span> <span class="o">&lt;=</span> <span class="n">PAPRD_IDEAL_AGC2_PWR_RANGE</span><span class="p">)</span>
			<span class="n">paprd_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">!!</span><span class="n">paprd_done</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">ar9003_paprd_is_done</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
