<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › init.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>init.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/ath9k_platform.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;ath9k.h&quot;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_info</span> <span class="o">=</span> <span class="s">&quot;ath9k&quot;</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Atheros Communications&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Support for Atheros 802.11n wireless LAN cards.&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;Atheros 802.11n WLAN cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ath9k_debug</span> <span class="o">=</span> <span class="n">ATH_DBG_DEFAULT</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">ath9k_debug</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debugging mask&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">ath9k_modparam_nohwcrypt</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">nohwcrypt</span><span class="p">,</span> <span class="n">ath9k_modparam_nohwcrypt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nohwcrypt</span><span class="p">,</span> <span class="s">&quot;Disable hardware encryption&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">led_blink</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">blink</span><span class="p">,</span> <span class="n">led_blink</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">blink</span><span class="p">,</span> <span class="s">&quot;Enable LED blink on activity&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ath9k_btcoex_enable</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">btcoex_enable</span><span class="p">,</span> <span class="n">ath9k_btcoex_enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">btcoex_enable</span><span class="p">,</span> <span class="s">&quot;Enable wifi-BT coexistence&quot;</span><span class="p">);</span>

<span class="n">bool</span> <span class="n">is_ath9k_unloaded</span><span class="p">;</span>
<span class="cm">/* We use the hw_value as an index into our private channel structure */</span>

<span class="cp">#define CHAN2G(_freq, _idx)  { \</span>
<span class="cp">	.band = IEEE80211_BAND_2GHZ, \</span>
<span class="cp">	.center_freq = (_freq), \</span>
<span class="cp">	.hw_value = (_idx), \</span>
<span class="cp">	.max_power = 20, \</span>
<span class="cp">}</span>

<span class="cp">#define CHAN5G(_freq, _idx) { \</span>
<span class="cp">	.band = IEEE80211_BAND_5GHZ, \</span>
<span class="cp">	.center_freq = (_freq), \</span>
<span class="cp">	.hw_value = (_idx), \</span>
<span class="cp">	.max_power = 20, \</span>
<span class="cp">}</span>

<span class="cm">/* Some 2 GHz radios are actually tunable on 2312-2732</span>
<span class="cm"> * on 5 MHz steps, we support the channels which we know</span>
<span class="cm"> * we have calibration data for all cards though to make</span>
<span class="cm"> * this static */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">ath9k_2ghz_chantable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2412</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="cm">/* Channel 1 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2417</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="cm">/* Channel 2 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2422</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="cm">/* Channel 3 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2427</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="cm">/* Channel 4 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2432</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="cm">/* Channel 5 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2437</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="cm">/* Channel 6 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2442</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="cm">/* Channel 7 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2447</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="cm">/* Channel 8 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2452</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="cm">/* Channel 9 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2457</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="cm">/* Channel 10 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2462</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="cm">/* Channel 11 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2467</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span> <span class="cm">/* Channel 12 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2472</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="cm">/* Channel 13 */</span>
	<span class="n">CHAN2G</span><span class="p">(</span><span class="mi">2484</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span> <span class="cm">/* Channel 14 */</span>
<span class="p">};</span>

<span class="cm">/* Some 5 GHz radios are actually tunable on XXXX-YYYY</span>
<span class="cm"> * on 5 MHz steps, we support the channels which we know</span>
<span class="cm"> * we have calibration data for all cards though to make</span>
<span class="cm"> * this static */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">ath9k_5ghz_chantable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* _We_ call this UNII 1 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5180</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span> <span class="cm">/* Channel 36 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5200</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="cm">/* Channel 40 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5220</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="cm">/* Channel 44 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5240</span><span class="p">,</span> <span class="mi">17</span><span class="p">),</span> <span class="cm">/* Channel 48 */</span>
	<span class="cm">/* _We_ call this UNII 2 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5260</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="cm">/* Channel 52 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5280</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span> <span class="cm">/* Channel 56 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5300</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="cm">/* Channel 60 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5320</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span> <span class="cm">/* Channel 64 */</span>
	<span class="cm">/* _We_ call this &quot;Middle band&quot; */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5500</span><span class="p">,</span> <span class="mi">22</span><span class="p">),</span> <span class="cm">/* Channel 100 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5520</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="cm">/* Channel 104 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5540</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span> <span class="cm">/* Channel 108 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5560</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="cm">/* Channel 112 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5580</span><span class="p">,</span> <span class="mi">26</span><span class="p">),</span> <span class="cm">/* Channel 116 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5600</span><span class="p">,</span> <span class="mi">27</span><span class="p">),</span> <span class="cm">/* Channel 120 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5620</span><span class="p">,</span> <span class="mi">28</span><span class="p">),</span> <span class="cm">/* Channel 124 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5640</span><span class="p">,</span> <span class="mi">29</span><span class="p">),</span> <span class="cm">/* Channel 128 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5660</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span> <span class="cm">/* Channel 132 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5680</span><span class="p">,</span> <span class="mi">31</span><span class="p">),</span> <span class="cm">/* Channel 136 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5700</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="cm">/* Channel 140 */</span>
	<span class="cm">/* _We_ call this UNII 3 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5745</span><span class="p">,</span> <span class="mi">33</span><span class="p">),</span> <span class="cm">/* Channel 149 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5765</span><span class="p">,</span> <span class="mi">34</span><span class="p">),</span> <span class="cm">/* Channel 153 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5785</span><span class="p">,</span> <span class="mi">35</span><span class="p">),</span> <span class="cm">/* Channel 157 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5805</span><span class="p">,</span> <span class="mi">36</span><span class="p">),</span> <span class="cm">/* Channel 161 */</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">5825</span><span class="p">,</span> <span class="mi">37</span><span class="p">),</span> <span class="cm">/* Channel 165 */</span>
<span class="p">};</span>

<span class="cm">/* Atheros hardware rate code addition for short premble */</span>
<span class="cp">#define SHPCHECK(__hw_rate, __flags) \</span>
<span class="cp">	((__flags &amp; IEEE80211_RATE_SHORT_PREAMBLE) ? (__hw_rate | 0x04 ) : 0)</span>

<span class="cp">#define RATE(_bitrate, _hw_rate, _flags) {              \</span>
<span class="cp">	.bitrate        = (_bitrate),                   \</span>
<span class="cp">	.flags          = (_flags),                     \</span>
<span class="cp">	.hw_value       = (_hw_rate),                   \</span>
<span class="cp">	.hw_value_short = (SHPCHECK(_hw_rate, _flags))  \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">ath9k_legacy_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">540</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_MAC80211_LEDS</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tpt_blink</span> <span class="n">ath9k_tpt_blink</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">334</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">260</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">220</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">190</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">20</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">170</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">150</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">70</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">130</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">110</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">80</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">300</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">,</span> <span class="p">.</span><span class="n">blink_time</span> <span class="o">=</span> <span class="mi">50</span> <span class="p">},</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ath9k_deinit_softc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Read and write, they both share the same lock. We do this to serialize</span>
<span class="cm"> * reads and writes on Atheros 802.11n PCI devices only. This is required</span>
<span class="cm"> * as the FIFO on these devices can only accept sanely 2 requests.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_iowrite32</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NR_CPUS</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">serialize_regmode</span> <span class="o">==</span> <span class="n">SER_REG_MODE_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_serial_rw</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_serial_rw</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ath9k_ioread32</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NR_CPUS</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">serialize_regmode</span> <span class="o">==</span> <span class="n">SER_REG_MODE_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_serial_rw</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_serial_rw</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">__ath9k_reg_rmw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">set</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">clr</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">set</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">reg_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ath9k_reg_rmw</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">hw_priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">set</span><span class="p">,</span> <span class="n">u32</span> <span class="n">clr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="p">)</span> <span class="n">hw_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="p">)</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">NR_CPUS</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">serialize_regmode</span> <span class="o">==</span> <span class="n">SER_REG_MODE_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_serial_rw</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">__ath9k_reg_rmw</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_serial_rw</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">__ath9k_reg_rmw</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">reg_offset</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************/</span>
<span class="cm">/*     Initialization     */</span>
<span class="cm">/**************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_ht_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">tx_streams</span><span class="p">,</span> <span class="n">rx_streams</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">max_streams</span><span class="p">;</span>

	<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">=</span> <span class="n">IEEE80211_HT_CAP_SUP_WIDTH_20_40</span> <span class="o">|</span>
		       <span class="n">IEEE80211_HT_CAP_SM_PS</span> <span class="o">|</span>
		       <span class="n">IEEE80211_HT_CAP_SGI_40</span> <span class="o">|</span>
		       <span class="n">IEEE80211_HT_CAP_DSSSCCK40</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_LDPC</span><span class="p">)</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_LDPC_CODING</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_SGI_20</span><span class="p">)</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span><span class="p">;</span>

	<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MAX_AMPDU_64K</span><span class="p">;</span>
	<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">ampdu_density</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MPDU_DENSITY_8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9330</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9485</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">max_streams</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9462</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">max_streams</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9300_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">max_streams</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">max_streams</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_streams</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_CAP_TX_STBC</span><span class="p">;</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_HT_CAP_RX_STBC_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set up supported mcs set */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">));</span>
	<span class="n">tx_streams</span> <span class="o">=</span> <span class="n">ath9k_cmn_count_streams</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">txchainmask</span><span class="p">,</span> <span class="n">max_streams</span><span class="p">);</span>
	<span class="n">rx_streams</span> <span class="o">=</span> <span class="n">ath9k_cmn_count_streams</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">rxchainmask</span><span class="p">,</span> <span class="n">max_streams</span><span class="p">);</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;TX streams %d, RX streams: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tx_streams</span><span class="p">,</span> <span class="n">rx_streams</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_streams</span> <span class="o">!=</span> <span class="n">rx_streams</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_MCS_TX_RX_DIFF</span><span class="p">;</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">|=</span> <span class="p">((</span><span class="n">tx_streams</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">IEEE80211_HT_MCS_TX_MAX_STREAMS_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rx_streams</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ht_info</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">tx_params</span> <span class="o">|=</span> <span class="n">IEEE80211_HT_MCS_TX_DEFINED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_reg_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">regulatory_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">wiphy_to_ieee80211_hw</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_regulatory</span> <span class="o">*</span><span class="n">reg</span> <span class="o">=</span> <span class="n">ath9k_hw_regulatory</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath_reg_notifier_apply</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Set tx power */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txpowlimit</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="o">-&gt;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">max_power</span><span class="p">;</span>
		<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
		<span class="n">ath9k_hw_set_txpowerlimit</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txpowlimit</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">curtxpow</span> <span class="o">=</span> <span class="n">ath9k_hw_regulatory</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">power_limit</span><span class="p">;</span>
		<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  This function will allocate both the DMA descriptor structure, and the</span>
<span class="cm"> *  buffers it contains.  These are used to contain the descriptors used</span>
<span class="cm"> *  by the system.</span>
<span class="cm">*/</span>
<span class="kt">int</span> <span class="nf">ath_descdma_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_descdma</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">nbuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ndesc</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_buf</span> <span class="o">*</span><span class="n">bf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bsize</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">desc_len</span><span class="p">;</span>

	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;%s DMA: %u buffers %u desc/buf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">name</span><span class="p">,</span> <span class="n">nbuf</span><span class="p">,</span> <span class="n">ndesc</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_tx</span><span class="p">)</span>
		<span class="n">desc_len</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">tx_desc_len</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">desc_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_desc</span><span class="p">);</span>

	<span class="cm">/* ath_desc must be a multiple of DWORDs */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">desc_len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;ath_desc not DWORD aligned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">((</span><span class="n">desc_len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span> <span class="o">=</span> <span class="n">desc_len</span> <span class="o">*</span> <span class="n">nbuf</span> <span class="o">*</span> <span class="n">ndesc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Need additional DMA memory because we can&#39;t use</span>
<span class="cm">	 * descriptors that cross the 4K page boundary. Assume</span>
<span class="cm">	 * one skipped descriptor per 4K page.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_4KB_SPLITTRANS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">ndesc_skipped</span> <span class="o">=</span>
			<span class="n">ATH_DESC_4KB_BOUND_NUM_SKIPPED</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">dma_len</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">ndesc_skipped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma_len</span> <span class="o">=</span> <span class="n">ndesc_skipped</span> <span class="o">*</span> <span class="n">desc_len</span><span class="p">;</span>
			<span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span> <span class="o">+=</span> <span class="n">dma_len</span><span class="p">;</span>

			<span class="n">ndesc_skipped</span> <span class="o">=</span> <span class="n">ATH_DESC_4KB_BOUND_NUM_SKIPPED</span><span class="p">(</span><span class="n">dma_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* allocate descriptors */</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_paddr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ds</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc</span><span class="p">;</span>
	<span class="n">ath_dbg</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="n">CONFIG</span><span class="p">,</span> <span class="s">&quot;%s DMA map: %p (%u) -&gt; %llx (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">name</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span><span class="p">,</span>
		<span class="n">ito64</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_paddr</span><span class="p">),</span> <span class="cm">/*XXX*/</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span><span class="p">);</span>

	<span class="cm">/* allocate buffers */</span>
	<span class="n">bsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_buf</span><span class="p">)</span> <span class="o">*</span> <span class="n">nbuf</span><span class="p">;</span>
	<span class="n">bf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">bsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_bufptr</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbuf</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">bf</span><span class="o">++</span><span class="p">,</span> <span class="n">ds</span> <span class="o">+=</span> <span class="p">(</span><span class="n">desc_len</span> <span class="o">*</span> <span class="n">ndesc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_desc</span> <span class="o">=</span> <span class="n">ds</span><span class="p">;</span>
		<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_daddr</span> <span class="o">=</span> <span class="n">DS2PHYS</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ds</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span>
		      <span class="n">ATH9K_HW_CAP_4KB_SPLITTRANS</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Skip descriptor addresses which can cause 4KB</span>
<span class="cm">			 * boundary crossing (addr + length) with a 32 dword</span>
<span class="cm">			 * descriptor fetch.</span>
<span class="cm">			 */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">ATH_DESC_4KB_BOUND_CHECK</span><span class="p">(</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_daddr</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">BUG_ON</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_desc</span> <span class="o">&gt;=</span>
				       <span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc</span> <span class="o">+</span>
					<span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span><span class="p">));</span>

				<span class="n">ds</span> <span class="o">+=</span> <span class="p">(</span><span class="n">desc_len</span> <span class="o">*</span> <span class="n">ndesc</span><span class="p">);</span>
				<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_desc</span> <span class="o">=</span> <span class="n">ds</span><span class="p">;</span>
				<span class="n">bf</span><span class="o">-&gt;</span><span class="n">bf_daddr</span> <span class="o">=</span> <span class="n">DS2PHYS</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="n">ds</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail2:</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc</span><span class="p">,</span>
			  <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_paddr</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dd</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_init_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">beaconq</span> <span class="o">=</span> <span class="n">ath9k_hw_beaconq_setup</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">cabq</span> <span class="o">=</span> <span class="n">ath_txq_setup</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH9K_TX_QUEUE_CAB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">cabqReadytime</span> <span class="o">=</span> <span class="n">ATH_CABQ_READY_TIME</span><span class="p">;</span>
	<span class="n">ath_cabq_update</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WME_NUM_AC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ath_txq_setup</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH9K_TX_QUEUE_DATA</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mac80211_qnum</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_init_channels_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">channels</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_2ghz_chantable</span><span class="p">)</span> <span class="o">+</span>
		     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_5ghz_chantable</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">ATH9K_NUM_CHANNELS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channels</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">ath9k_2ghz_chantable</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">ath9k_2ghz_chantable</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channels</span><span class="p">)</span>
		    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">n_channels</span> <span class="o">=</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_2ghz_chantable</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">ath9k_legacy_rates</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">n_bitrates</span> <span class="o">=</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_legacy_rates</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">channels</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">ath9k_5ghz_chantable</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">ath9k_5ghz_chantable</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channels</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">channels</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">channels</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">channels</span> <span class="o">=</span> <span class="n">channels</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">n_channels</span> <span class="o">=</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_5ghz_chantable</span><span class="p">);</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">bitrates</span> <span class="o">=</span>
			<span class="n">ath9k_legacy_rates</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">n_bitrates</span> <span class="o">=</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_legacy_rates</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_init_misc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">ani</span><span class="p">.</span><span class="n">timer</span><span class="p">,</span> <span class="n">ath_ani_calibrate</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txpowlimit</span> <span class="o">=</span> <span class="n">ATH_TXPOWER_MAX</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">bssidmask</span><span class="p">,</span> <span class="n">ath_bcast_mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">slottime</span> <span class="o">=</span> <span class="n">ATH9K_SLOT_TIME_9</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">bslot</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">bslot</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_ANT_DIV_COMB</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ant_comb</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">ATH_ANT_DIV_COMB_INIT_COUNT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath9k_init_softc</span><span class="p">(</span><span class="n">u16</span> <span class="n">devid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_bus_ops</span> <span class="o">*</span><span class="n">bus_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath9k_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">csz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ah</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ah</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">devid</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">reg_ops</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">ath9k_ioread32</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">reg_ops</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">ath9k_iowrite32</span><span class="p">;</span>
	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">reg_ops</span><span class="p">.</span><span class="n">rmw</span> <span class="o">=</span> <span class="n">ath9k_reg_rmw</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">intr_ref_cnt</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span> <span class="o">=</span> <span class="n">ah</span><span class="p">;</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">dfs_detector</span> <span class="o">=</span> <span class="n">dfs_pattern_detector_init</span><span class="p">(</span><span class="n">NL80211_DFS_UNSET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">ah_flags</span> <span class="o">|=</span> <span class="n">AH_USE_EEPROM</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">led_pin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">gpio_mask</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_mask</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">gpio_val</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_val</span><span class="p">;</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">led_pin</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_pin</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">is_clk_25mhz</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">is_clk_25mhz</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">get_mac_revision</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">get_mac_revision</span><span class="p">;</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">external_reset</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">external_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">reg_ops</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">bus_ops</span> <span class="o">=</span> <span class="n">bus_ops</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">ah</span> <span class="o">=</span> <span class="n">ah</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">sc</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">debug_mask</span> <span class="o">=</span> <span class="n">ath9k_debug</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">btcoex_enabled</span> <span class="o">=</span> <span class="n">ath9k_btcoex_enable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">disable_ani</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">cc_lock</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_serial_rw</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_pm_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ATH9K_DEBUGFS</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">nodes_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">nodes</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATH9K_MAC_DEBUG</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">samp_lock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">intr_tq</span><span class="p">,</span> <span class="n">ath9k_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">bcon_tasklet</span><span class="p">,</span> <span class="n">ath_beacon_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sc</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cache line size is used to size and align various</span>
<span class="cm">	 * structures used to communicate with the hardware.</span>
<span class="cm">	 */</span>
	<span class="n">ath_read_cachesize</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csz</span><span class="p">);</span>
	<span class="n">common</span><span class="o">-&gt;</span><span class="n">cachelsz</span> <span class="o">=</span> <span class="n">csz</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* convert to bytes */</span>

	<span class="cm">/* Initializes the hardware for all supported chipsets */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_hw_init</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_init_queues</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_queues</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span>  <span class="n">ath9k_init_btcoex</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_btcoex</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath9k_init_channels_rates</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_btcoex</span><span class="p">;</span>

	<span class="n">ath9k_cmn_init_crypto</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="n">ath9k_init_misc</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_btcoex:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ATH_TXQ_SETUP</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">ath_tx_cleanupq</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="nl">err_queues:</span>
	<span class="n">ath9k_hw_deinit</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="nl">err_hw:</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_init_band_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">];</span>
		<span class="n">ath9k_cmn_update_ichannel</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">NL80211_CHAN_HT20</span><span class="p">);</span>
		<span class="n">ath9k_hw_set_txpowerlimit</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">MAX_RATE_POWER</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_init_txpower_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_2GHZ</span><span class="p">)</span>
		<span class="n">ath9k_init_band_txpower</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_5GHZ</span><span class="p">)</span>
		<span class="n">ath9k_init_band_txpower</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">);</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">curchan</span> <span class="o">=</span> <span class="n">curchan</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_reload_chainmask_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_HT</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_2GHZ</span><span class="p">)</span>
		<span class="n">setup_ht_cap</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">ht_cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_5GHZ</span><span class="p">)</span>
		<span class="n">setup_ht_cap</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">ht_cap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_iface_limit</span> <span class="n">if_limits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>	<span class="p">.</span><span class="n">types</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_WDS</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>	<span class="p">.</span><span class="n">types</span> <span class="o">=</span>
<span class="cp">#ifdef CONFIG_MAC80211_MESH</span>
				 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="o">|</span>
<span class="cp">#endif</span>
				 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">|</span>
				 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_iface_combination</span> <span class="n">if_comb</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">limits</span> <span class="o">=</span> <span class="n">if_limits</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_limits</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">if_limits</span><span class="p">),</span>
	<span class="p">.</span><span class="n">max_interfaces</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">,</span>
	<span class="p">.</span><span class="n">num_different_channels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ath9k_set_hw_capab</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_RX_INCLUDES_FCS</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_HOST_BROADCAST_PS_BUFFERING</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SIGNAL_DBM</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SUPPORTS_PS</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_PS_NULLFUNC_STACK</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SPECTRUM_MGMT</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_REPORTS_TX_ACK_STATUS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_HT</span><span class="p">)</span>
		 <span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_HW_AMPDU_AGGREGATION</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9160_10_OR_LATER</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">ath9k_modparam_nohwcrypt</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_HW_MFP_CAPABLE</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_P2P_GO</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_P2P_CLIENT</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_WDS</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">iface_combinations</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">if_comb</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_iface_combinations</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_5416</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">))</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WIPHY_FLAG_PS_ON_BY_DEFAULT</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_IBSS_RSN</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_SUPPORTS_TDLS</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_HAS_REMAIN_ON_CHANNEL</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_change_time</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_listen_interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rate_tries</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">sta_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_node</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vif_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_vif</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">available_antennas_rx</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_rxchains</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">available_antennas_tx</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">max_txchains</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* single chain devices with rx diversity */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_ANT_DIV_COMB</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">available_antennas_rx</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ant_rx</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">available_antennas_rx</span><span class="p">;</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">ant_tx</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">available_antennas_tx</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ATH9K_RATE_CONTROL</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rate_control_algorithm</span> <span class="o">=</span> <span class="s">&quot;ath9k_rate_control&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_2GHZ</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">.</span><span class="n">hw_caps</span> <span class="o">&amp;</span> <span class="n">ATH9K_HW_CAP_5GHZ</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>

	<span class="n">ath9k_reload_chainmask_settings</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">common</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath9k_init_device</span><span class="p">(</span><span class="n">u16</span> <span class="n">devid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
		    <span class="k">const</span> <span class="k">struct</span> <span class="n">ath_bus_ops</span> <span class="o">*</span><span class="n">bus_ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_common</span> <span class="o">*</span><span class="n">common</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath_regulatory</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Bring up device */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ath9k_init_softc</span><span class="p">(</span><span class="n">devid</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">bus_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_init</span><span class="p">;</span>

	<span class="n">ah</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">;</span>
	<span class="n">common</span> <span class="o">=</span> <span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ath9k_set_hw_capab</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* Initialize regulatory */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ath_regd_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">regulatory</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			      <span class="n">ath9k_reg_notifier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_regd</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">common</span><span class="o">-&gt;</span><span class="n">regulatory</span><span class="p">;</span>

	<span class="cm">/* Setup TX DMA */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ath_tx_init</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH_TXBUF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_tx</span><span class="p">;</span>

	<span class="cm">/* Setup RX DMA */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ath_rx_init</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ATH_RXBUF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_rx</span><span class="p">;</span>

	<span class="n">ath9k_init_txpower_limits</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MAC80211_LEDS</span>
	<span class="cm">/* must be initialized before ieee80211_register_hw */</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">led_cdev</span><span class="p">.</span><span class="n">default_trigger</span> <span class="o">=</span> <span class="n">ieee80211_create_tpt_led_trigger</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
		<span class="n">IEEE80211_TPT_LEDTRIG_FL_RADIO</span><span class="p">,</span> <span class="n">ath9k_tpt_blink</span><span class="p">,</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ath9k_tpt_blink</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_reset_work</span><span class="p">,</span> <span class="n">ath_reset_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_check_work</span><span class="p">,</span> <span class="n">ath_hw_check</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">paprd_work</span><span class="p">,</span> <span class="n">ath_paprd_calibrate</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw_pll_work</span><span class="p">,</span> <span class="n">ath_hw_pll_work</span><span class="p">);</span>

	<span class="cm">/* Register with mac80211 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_register</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ath9k_init_debug</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">common</span><span class="p">,</span> <span class="s">&quot;Unable to create debugfs files</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_world</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle world regulatory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath_is_world_regd</span><span class="p">(</span><span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">regulatory_hint</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_world</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">rx_poll_timer</span><span class="p">,</span> <span class="n">ath_rx_poll</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">last_rssi</span> <span class="o">=</span> <span class="n">ATH_RSSI_DUMMY_MARKER</span><span class="p">;</span>

	<span class="n">ath_init_leds</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ath_start_rfkill_poll</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_world:</span>
	<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="nl">error_register:</span>
	<span class="n">ath_rx_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="nl">error_rx:</span>
	<span class="n">ath_tx_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="nl">error_tx:</span>
	<span class="cm">/* Nothing */</span>
<span class="nl">error_regd:</span>
	<span class="n">ath9k_deinit_softc</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="nl">error_init:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************/</span>
<span class="cm">/*     De-Initialization     */</span>
<span class="cm">/*****************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath9k_deinit_softc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">channels</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">channels</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">channels</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sbands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">channels</span><span class="p">);</span>

	<span class="n">ath9k_deinit_btcoex</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ATH9K_NUM_TX_QUEUES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ATH_TXQ_SETUP</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">ath_tx_cleanupq</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">ath9k_hw_deinit</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dfs_detector</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">sc</span><span class="o">-&gt;</span><span class="n">dfs_detector</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dfs_detector</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span><span class="p">);</span>
	<span class="n">sc</span><span class="o">-&gt;</span><span class="n">sc_ah</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath9k_deinit_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ath9k_ps_wakeup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">wiphy_rfkill_stop_polling</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">ath_deinit_leds</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">ath9k_ps_restore</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>

	<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">ath_rx_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ath_tx_cleanup</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
	<span class="n">ath9k_deinit_softc</span><span class="p">(</span><span class="n">sc</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath_descdma_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_softc</span> <span class="o">*</span><span class="n">sc</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ath_descdma</span> <span class="o">*</span><span class="n">dd</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_len</span><span class="p">,</span> <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc</span><span class="p">,</span>
			  <span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_desc_paddr</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="n">head</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dd</span><span class="o">-&gt;</span><span class="n">dd_bufptr</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dd</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/************************/</span>
<span class="cm">/*     Module Hooks     */</span>
<span class="cm">/************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ath9k_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Register rate control algorithm */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">ath_rate_control_register</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to register rate control algorithm: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ath_pci_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No PCI devices found, driver not installed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_rate_unregister</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ath_ahb_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_pci_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_pci_exit:</span>
	<span class="n">ath_pci_exit</span><span class="p">();</span>

 <span class="nl">err_rate_unregister:</span>
	<span class="n">ath_rate_control_unregister</span><span class="p">();</span>
 <span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">ath9k_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ath9k_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">is_ath9k_unloaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ath_ahb_exit</span><span class="p">();</span>
	<span class="n">ath_pci_exit</span><span class="p">();</span>
	<span class="n">ath_rate_control_unregister</span><span class="p">();</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Driver unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ath9k_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
