<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath9k › ar9002_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>ar9002_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2008-2011 Atheros Communications Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &quot;hw.h&quot;</span>
<span class="cp">#include &quot;ar5008_initvals.h&quot;</span>
<span class="cp">#include &quot;ar9001_initvals.h&quot;</span>
<span class="cp">#include &quot;ar9002_initvals.h&quot;</span>
<span class="cp">#include &quot;ar9002_phy.h&quot;</span>

<span class="kt">int</span> <span class="n">modparam_force_new_ani</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">force_new_ani</span><span class="p">,</span> <span class="n">modparam_force_new_ani</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force_new_ani</span><span class="p">,</span> <span class="s">&quot;Force new ANI for AR5008, AR9001, AR9002&quot;</span><span class="p">);</span>

<span class="cm">/* General hardware code for the A5008/AR9001/AR9002 hadware families */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9002_hw_init_mode_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes</span><span class="p">,</span> <span class="n">ar9271Modes_9271</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9271Modes_9271</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCommon</span><span class="p">,</span> <span class="n">ar9271Common_9271</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9271Common_9271</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes_9271_ANI_reg</span><span class="p">,</span> <span class="n">ar9271Modes_9271_ANI_reg</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9271Modes_9271_ANI_reg</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">pcie_clock_req</span><span class="p">)</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniPcieSerdes</span><span class="p">,</span>
			   <span class="n">ar9280PciePhy_clkreq_off_L1_9280</span><span class="p">,</span>
			   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280PciePhy_clkreq_off_L1_9280</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniPcieSerdes</span><span class="p">,</span>
			   <span class="n">ar9280PciePhy_clkreq_always_on_L1_9280</span><span class="p">,</span>
			   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280PciePhy_clkreq_always_on_L1_9280</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287_11_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes</span><span class="p">,</span> <span class="n">ar9287Modes_9287_1_1</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9287Modes_9287_1_1</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCommon</span><span class="p">,</span> <span class="n">ar9287Common_9287_1_1</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9287Common_9287_1_1</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285_12_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes</span><span class="p">,</span> <span class="n">ar9285Modes_9285_1_2</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9285Modes_9285_1_2</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCommon</span><span class="p">,</span> <span class="n">ar9285Common_9285_1_2</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9285Common_9285_1_2</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes</span><span class="p">,</span> <span class="n">ar9280Modes_9280_2</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280Modes_9280_2</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCommon</span><span class="p">,</span> <span class="n">ar9280Common_9280_2</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280Common_9280_2</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesFastClock</span><span class="p">,</span>
			       <span class="n">ar9280Modes_fast_clock_9280_2</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280Modes_fast_clock_9280_2</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9160_10_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes</span><span class="p">,</span> <span class="n">ar5416Modes_9160</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Modes_9160</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCommon</span><span class="p">,</span> <span class="n">ar5416Common_9160</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Common_9160</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9160_11</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniAddac</span><span class="p">,</span>
				       <span class="n">ar5416Addac_9160_1_1</span><span class="p">,</span>
				       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Addac_9160_1_1</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniAddac</span><span class="p">,</span> <span class="n">ar5416Addac_9160</span><span class="p">,</span>
				       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Addac_9160</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9100_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes</span><span class="p">,</span> <span class="n">ar5416Modes_9100</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Modes_9100</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCommon</span><span class="p">,</span> <span class="n">ar5416Common_9100</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Common_9100</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank6</span><span class="p">,</span> <span class="n">ar5416Bank6_9100</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Bank6_9100</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniAddac</span><span class="p">,</span> <span class="n">ar5416Addac_9100</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Addac_9100</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes</span><span class="p">,</span> <span class="n">ar5416Modes</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Modes</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCommon</span><span class="p">,</span> <span class="n">ar5416Common</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Common</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank6TPC</span><span class="p">,</span> <span class="n">ar5416Bank6TPC</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Bank6TPC</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniAddac</span><span class="p">,</span> <span class="n">ar5416Addac</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Addac</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Common for AR5416, AR913x, AR9160 */</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBB_RfGain</span><span class="p">,</span> <span class="n">ar5416BB_RfGain</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416BB_RfGain</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>

		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank0</span><span class="p">,</span> <span class="n">ar5416Bank0</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Bank0</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank1</span><span class="p">,</span> <span class="n">ar5416Bank1</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Bank1</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank2</span><span class="p">,</span> <span class="n">ar5416Bank2</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Bank2</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank3</span><span class="p">,</span> <span class="n">ar5416Bank3</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Bank3</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank7</span><span class="p">,</span> <span class="n">ar5416Bank7</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Bank7</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>

		<span class="cm">/* Common for AR5416, AR9160 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_9100</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank6</span><span class="p">,</span> <span class="n">ar5416Bank6</span><span class="p">,</span>
				       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Bank6</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>

		<span class="cm">/* Common for AR913x, AR9160 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_5416</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniBank6TPC</span><span class="p">,</span> <span class="n">ar5416Bank6TPC_9100</span><span class="p">,</span>
				       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar5416Bank6TPC_9100</span><span class="p">),</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* iniAddac needs to be modified for these chips */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9160</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">AR_SREV_5416_22_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ar5416IniArray</span> <span class="o">*</span><span class="n">addac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniAddac</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">addac</span><span class="o">-&gt;</span><span class="n">ia_rows</span> <span class="o">*</span> <span class="n">addac</span><span class="o">-&gt;</span><span class="n">ia_columns</span><span class="p">;</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

		<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">addac</span><span class="o">-&gt;</span><span class="n">ia_array</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">addac</span><span class="o">-&gt;</span><span class="n">ia_array</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AR_SREV_5416_22_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* override CLKDRV value */</span>
			<span class="n">INI_RA</span><span class="p">(</span><span class="n">addac</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287_11_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCckfirNormal</span><span class="p">,</span>
		       <span class="n">ar9287Common_normal_cck_fir_coeff_9287_1_1</span><span class="p">,</span>
		       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9287Common_normal_cck_fir_coeff_9287_1_1</span><span class="p">),</span>
		       <span class="mi">2</span><span class="p">);</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniCckfirJapan2484</span><span class="p">,</span>
		       <span class="n">ar9287Common_japan_2484_cck_fir_coeff_9287_1_1</span><span class="p">,</span>
		       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9287Common_japan_2484_cck_fir_coeff_9287_1_1</span><span class="p">),</span>
		       <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9280_20_hw_init_rxgain_ini</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rxgain_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_MINOR_REV</span><span class="p">)</span> <span class="o">&gt;=</span>
	    <span class="n">AR5416_EEP_MINOR_VER_17</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxgain_type</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_RXGAIN_TYPE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxgain_type</span> <span class="o">==</span> <span class="n">AR5416_EEP_RXGAIN_13DB_BACKOFF</span><span class="p">)</span>
			<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesRxGain</span><span class="p">,</span>
			<span class="n">ar9280Modes_backoff_13db_rxgain_9280_2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280Modes_backoff_13db_rxgain_9280_2</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rxgain_type</span> <span class="o">==</span> <span class="n">AR5416_EEP_RXGAIN_23DB_BACKOFF</span><span class="p">)</span>
			<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesRxGain</span><span class="p">,</span>
			<span class="n">ar9280Modes_backoff_23db_rxgain_9280_2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280Modes_backoff_23db_rxgain_9280_2</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesRxGain</span><span class="p">,</span>
			<span class="n">ar9280Modes_original_rxgain_9280_2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280Modes_original_rxgain_9280_2</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesRxGain</span><span class="p">,</span>
			<span class="n">ar9280Modes_original_rxgain_9280_2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280Modes_original_rxgain_9280_2</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9280_20_hw_init_txgain_ini</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">txgain_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_MINOR_REV</span><span class="p">)</span> <span class="o">&gt;=</span>
	    <span class="n">AR5416_EEP_MINOR_VER_19</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txgain_type</span> <span class="o">==</span> <span class="n">AR5416_EEP_TXGAIN_HIGH_POWER</span><span class="p">)</span>
			<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span>
			<span class="n">ar9280Modes_high_power_tx_gain_9280_2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280Modes_high_power_tx_gain_9280_2</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span>
			<span class="n">ar9280Modes_original_tx_gain_9280_2</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280Modes_original_tx_gain_9280_2</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span>
		<span class="n">ar9280Modes_original_tx_gain_9280_2</span><span class="p">,</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9280Modes_original_tx_gain_9280_2</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9271_hw_init_txgain_ini</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="n">u32</span> <span class="n">txgain_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txgain_type</span> <span class="o">==</span> <span class="n">AR5416_EEP_TXGAIN_HIGH_POWER</span><span class="p">)</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span>
			       <span class="n">ar9271Modes_high_power_tx_gain_9271</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9271Modes_high_power_tx_gain_9271</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span>
			       <span class="n">ar9271Modes_normal_power_tx_gain_9271</span><span class="p">,</span>
			       <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9271Modes_normal_power_tx_gain_9271</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9002_hw_init_mode_gain_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">txgain_type</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">eep_ops</span><span class="o">-&gt;</span><span class="n">get_eeprom</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">EEP_TXGAIN_TYPE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287_11_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesRxGain</span><span class="p">,</span>
		<span class="n">ar9287Modes_rx_gain_9287_1_1</span><span class="p">,</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9287Modes_rx_gain_9287_1_1</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ar9280_20_hw_init_rxgain_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ar9271_hw_init_txgain_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">txgain_type</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287_11_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span>
		<span class="n">ar9287Modes_tx_gain_9287_1_1</span><span class="p">,</span>
		<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ar9287Modes_tx_gain_9287_1_1</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ar9280_20_hw_init_txgain_ini</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">txgain_type</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285_12_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* txgain table */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txgain_type</span> <span class="o">==</span> <span class="n">AR5416_EEP_TXGAIN_HIGH_POWER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285E_20</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span>
				<span class="n">ar9285Modes_XE2_0_high_power</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span>
				  <span class="n">ar9285Modes_XE2_0_high_power</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span>
				<span class="n">ar9285Modes_high_power_tx_gain_9285_1_2</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span>
				  <span class="n">ar9285Modes_high_power_tx_gain_9285_1_2</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285E_20</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span>
				<span class="n">ar9285Modes_XE2_0_normal_power</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span>
				  <span class="n">ar9285Modes_XE2_0_normal_power</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">INIT_INI_ARRAY</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModesTxGain</span><span class="p">,</span>
				<span class="n">ar9285Modes_original_tx_gain_9285_1_2</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span>
				  <span class="n">ar9285Modes_original_tx_gain_9285_1_2</span><span class="p">),</span> <span class="mi">5</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Helper for ASPM support.</span>
<span class="cm"> *</span>
<span class="cm"> * Disable PLL when in L0s as well as receiver clock when in L1.</span>
<span class="cm"> * This power saving option must be enabled through the SerDes.</span>
<span class="cm"> *</span>
<span class="cm"> * Programming the SerDes must go through the same 288 bit serial shift</span>
<span class="cm"> * register as the other analog registers.  Hence the 9 writes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ar9002_hw_configpcipowersave</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span>
					 <span class="n">bool</span> <span class="n">power_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Nothing to do on restore for 11N */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">power_off</span> <span class="cm">/* !restore */</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * AR9280 2.0 or later chips use SerDes values from the</span>
<span class="cm">			 * initvals.h initialized depending on chipset during</span>
<span class="cm">			 * __ath9k_hw_init()</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniPcieSerdes</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">INI_RA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniPcieSerdes</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					  <span class="n">INI_RA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniPcieSerdes</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x9248fc00</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x24924924</span><span class="p">);</span>

			<span class="cm">/* RX shut off when elecidle is asserted */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x28000039</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x53160824</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0xe5980579</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Ignore ah-&gt;ah_config.pcie_clock_req setting for</span>
<span class="cm">			 * pre-AR9280 11n</span>
<span class="cm">			 */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x001defff</span><span class="p">);</span>

			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x1aaabe40</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0xbe105554</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES</span><span class="p">,</span> <span class="mh">0x000e3007</span><span class="p">);</span>

			<span class="cm">/* Load the new settings */</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_SERDES2</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

			<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* clear bit 19 to disable L1 */</span>
		<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_PM_CTRL</span><span class="p">,</span> <span class="n">AR_PCIE_PM_CTRL_ENA</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_WA</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set PCIe workaround bits</span>
<span class="cm">		 * In AR9280 and AR9285, bit 14 in WA register (disable L1)</span>
<span class="cm">		 * should only  be set when device enters D3 and be</span>
<span class="cm">		 * cleared when device comes back to D0.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">pcie_waen</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">pcie_waen</span> <span class="o">&amp;</span> <span class="n">AR_WA_D3_L1_DISABLE</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">AR_WA_D3_L1_DISABLE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">AR_SREV_9285</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span>
			      <span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span>
			      <span class="n">AR_SREV_9287</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">AR9285_WA_DEFAULT</span> <span class="o">&amp;</span> <span class="n">AR_WA_D3_L1_DISABLE</span><span class="p">))</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">AR_SREV_9280</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">AR9280_WA_DEFAULT</span> <span class="o">&amp;</span> <span class="n">AR_WA_D3_L1_DISABLE</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">AR_WA_D3_L1_DISABLE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9285</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9287</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Disable bit 6 and 7 before entering D3 to</span>
<span class="cm">			 * prevent system hang.</span>
<span class="cm">			 */</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AR_WA_BIT6</span> <span class="o">|</span> <span class="n">AR_WA_BIT7</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">AR_WA_BIT22</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285E_20</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">AR_WA_BIT23</span><span class="p">;</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_WA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">pcie_waen</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">pcie_waen</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">power_off</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">AR_WA_D3_L1_DISABLE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">AR_SREV_9271</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">AR_SREV_9287</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">AR9285_WA_DEFAULT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">power_off</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">AR_WA_D3_L1_DISABLE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * For AR9280 chips, bit 22 of 0x4004</span>
<span class="cm">				 * needs to be set.</span>
<span class="cm">				 */</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">AR9280_WA_DEFAULT</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">power_off</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">AR_WA_D3_L1_DISABLE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">AR_WA_DEFAULT</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* WAR for ASPM system hang */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285</span><span class="p">(</span><span class="n">ah</span><span class="p">)</span> <span class="o">||</span> <span class="n">AR_SREV_9287</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">AR_WA_BIT6</span> <span class="o">|</span> <span class="n">AR_WA_BIT7</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9285E_20</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">AR_WA_BIT23</span><span class="p">;</span>

		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_WA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="cm">/* set bit 19 to allow forcing of pcie core into L1 state */</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PCIE_PM_CTRL</span><span class="p">,</span> <span class="n">AR_PCIE_PM_CTRL_ENA</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ar9002_hw_get_radiorev</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY</span><span class="p">(</span><span class="mh">0x36</span><span class="p">),</span> <span class="mh">0x00007058</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY</span><span class="p">(</span><span class="mh">0x20</span><span class="p">),</span> <span class="mh">0x00010000</span><span class="p">);</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY</span><span class="p">(</span><span class="mi">256</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ath9k_hw_reverse_bits</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ar9002_hw_rf_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="mh">0x00000007</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">ar9002_hw_get_radiorev</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AR_RADIO_SREV_MAJOR</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">AR_RAD5133_SREV_MAJOR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AR_RAD5133_SREV_MAJOR</span>:
	<span class="k">case</span> <span class="n">AR_RAD5122_SREV_MAJOR</span>:
	<span class="k">case</span> <span class="n">AR_RAD2133_SREV_MAJOR</span>:
	<span class="k">case</span> <span class="n">AR_RAD2122_SREV_MAJOR</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath_err</span><span class="p">(</span><span class="n">ath9k_hw_common</span><span class="p">(</span><span class="n">ah</span><span class="p">),</span>
			<span class="s">&quot;Radio Chip Rev 0x%02X not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="n">AR_RADIO_SREV_MAJOR</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ah</span><span class="o">-&gt;</span><span class="n">hw_version</span><span class="p">.</span><span class="n">analog5GhzRev</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ar9002_hw_enable_async_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9287_13_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MAC_PCU_ASYNC_FIFO_REG3</span><span class="p">,</span>
				<span class="n">AR_MAC_PCU_ASYNC_FIFO_REG3_DATAPATH_SEL</span><span class="p">);</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_PHY_MODE</span><span class="p">,</span> <span class="n">AR_PHY_MODE_ASYNCFIFO</span><span class="p">);</span>
		<span class="n">REG_CLR_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MAC_PCU_ASYNC_FIFO_REG3</span><span class="p">,</span>
				<span class="n">AR_MAC_PCU_ASYNC_FIFO_REG3_SOFT_RESET</span><span class="p">);</span>
		<span class="n">REG_SET_BIT</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">AR_MAC_PCU_ASYNC_FIFO_REG3</span><span class="p">,</span>
				<span class="n">AR_MAC_PCU_ASYNC_FIFO_REG3_SOFT_RESET</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Sets up the AR5008/AR9001/AR9002 hardware familiy callbacks */</span>
<span class="kt">void</span> <span class="nf">ar9002_hw_attach_ops</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath_hw_private_ops</span> <span class="o">*</span><span class="n">priv_ops</span> <span class="o">=</span> <span class="n">ath9k_hw_private_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath_hw_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ath9k_hw_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">init_mode_regs</span> <span class="o">=</span> <span class="n">ar9002_hw_init_mode_regs</span><span class="p">;</span>
	<span class="n">priv_ops</span><span class="o">-&gt;</span><span class="n">init_mode_gain_regs</span> <span class="o">=</span> <span class="n">ar9002_hw_init_mode_gain_regs</span><span class="p">;</span>

	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">config_pci_powersave</span> <span class="o">=</span> <span class="n">ar9002_hw_configpcipowersave</span><span class="p">;</span>

	<span class="n">ar5008_hw_attach_phy_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">AR_SREV_9280_20_OR_LATER</span><span class="p">(</span><span class="n">ah</span><span class="p">))</span>
		<span class="n">ar9002_hw_attach_phy_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="n">ar9002_hw_attach_calib_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
	<span class="n">ar9002_hw_attach_mac_ops</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ar9002_hw_load_ani_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath_hw</span> <span class="o">*</span><span class="n">ah</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath9k_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">modesIndex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">chanmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHANNEL_A</span>:
	<span class="k">case</span> <span class="n">CHANNEL_A_HT20</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_A_HT40PLUS</span>:
	<span class="k">case</span> <span class="n">CHANNEL_A_HT40MINUS</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_G</span>:
	<span class="k">case</span> <span class="n">CHANNEL_G_HT20</span>:
	<span class="k">case</span> <span class="n">CHANNEL_B</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANNEL_G_HT40PLUS</span>:
	<span class="k">case</span> <span class="n">CHANNEL_G_HT40MINUS</span>:
		<span class="n">modesIndex</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ENABLE_REGWRITE_BUFFER</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes_9271_ANI_reg</span><span class="p">.</span><span class="n">ia_rows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">INI_RA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes_9271_ANI_reg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">INI_RA</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ah</span><span class="o">-&gt;</span><span class="n">iniModes_9271_ANI_reg</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">modesIndex</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">val_orig</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">AR_PHY_CCK_DETECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val_orig</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="n">AR_PHY_CCK_DETECT_WEAK_SIG_THR_CCK</span><span class="p">;</span>
			<span class="n">val_orig</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AR_PHY_CCK_DETECT_WEAK_SIG_THR_CCK</span><span class="p">;</span>

			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="o">|</span><span class="n">val_orig</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">ah</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">REGWRITE_BUFFER_FLUSH</span><span class="p">(</span><span class="n">ah</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
