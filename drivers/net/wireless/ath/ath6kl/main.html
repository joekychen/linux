<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath6kl › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2004-2011 Atheros Communications Inc.</span>
<span class="cm"> * Copyright (c) 2011-2012 Qualcomm Atheros, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;hif-ops.h&quot;</span>
<span class="cp">#include &quot;cfg80211.h&quot;</span>
<span class="cp">#include &quot;target.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>

<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="nf">ath6kl_find_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">node_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">max_conn</span><span class="p">;</span>

	<span class="n">max_conn</span> <span class="o">=</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="o">?</span> <span class="n">AP_MAX_NUM_STA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_conn</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">node_addr</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">conn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="nf">ath6kl_find_sta_by_aid</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="n">aid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">conn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ctr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ctr</span> <span class="o">&lt;</span> <span class="n">AP_MAX_NUM_STA</span><span class="p">;</span> <span class="n">ctr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">ctr</span><span class="p">].</span><span class="n">aid</span> <span class="o">==</span> <span class="n">aid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">conn</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">ctr</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">conn</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_add_new_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="n">u16</span> <span class="n">aid</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="o">*</span><span class="n">wpaie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ielen</span><span class="p">,</span> <span class="n">u8</span> <span class="n">keymgmt</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">ucipher</span><span class="p">,</span> <span class="n">u8</span> <span class="n">auth</span><span class="p">,</span> <span class="n">u8</span> <span class="n">apsd_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">free_slot</span><span class="p">;</span>

	<span class="n">free_slot</span> <span class="o">=</span> <span class="n">aid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">free_slot</span><span class="p">];</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ielen</span> <span class="o">&lt;=</span> <span class="n">ATH6KL_MAX_IE</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">wpaie</span><span class="p">,</span> <span class="n">ielen</span><span class="p">);</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">aid</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">keymgmt</span> <span class="o">=</span> <span class="n">keymgmt</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">ucipher</span> <span class="o">=</span> <span class="n">ucipher</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">apsd_info</span> <span class="o">=</span> <span class="n">apsd_info</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list_index</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list_index</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">free_slot</span><span class="p">);</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">ap_stats</span><span class="p">.</span><span class="n">sta</span><span class="p">[</span><span class="n">free_slot</span><span class="p">].</span><span class="n">aid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">aid</span><span class="p">);</span>
	<span class="n">aggr_conn_init</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">aggr_cntxt</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_sta_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ath6kl_mgmt_buff</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* empty the queued pkts in the PS queue if any */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">psq</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">apsdq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">mgmt_psq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">mgmt_psq</span><span class="p">);</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ap_stats</span><span class="p">.</span><span class="n">sta</span><span class="p">[</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_per_sta_stat</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ATH6KL_MAX_IE</span><span class="p">);</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list_index</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list_index</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">aggr_reset_state</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ath6kl_remove_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">removed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">removed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">mac</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span> <span class="s">&quot;deleting all station</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_NUM_STA</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mac</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ath6kl_sta_cleanup</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">removed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AP_MAX_NUM_STA</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mac</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span>
					   <span class="s">&quot;deleting station %pM aid=%d reason=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">mac</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">aid</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
				<span class="n">ath6kl_sta_cleanup</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">removed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">removed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="nf">ath6kl_ac2_endpoint_id</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">devt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">devt</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ac2ep_map</span><span class="p">[</span><span class="n">ac</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ath6kl_cookie</span> <span class="o">*</span><span class="nf">ath6kl_alloc_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_cookie</span> <span class="o">*</span><span class="n">cookie</span><span class="p">;</span>

	<span class="n">cookie</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_list</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cookie</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_list</span> <span class="o">=</span> <span class="n">cookie</span><span class="o">-&gt;</span><span class="n">arc_list_next</span><span class="p">;</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cookie</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_cookie_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_mem</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_COOKIE_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ath6kl_free_cookie</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_mem</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_cookie_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_free_cookie</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath6kl_cookie</span> <span class="o">*</span><span class="n">cookie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Insert first */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span> <span class="o">||</span> <span class="o">!</span><span class="n">cookie</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cookie</span><span class="o">-&gt;</span><span class="n">arc_list_next</span> <span class="o">=</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_list</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_list</span> <span class="o">=</span> <span class="n">cookie</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">cookie_count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Read from the hardware through its diagnostic window. No cooperation</span>
<span class="cm"> * from the firmware is required for this.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ath6kl_diag_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_hif_diag_read32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;failed to read32 through diagnose window: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Write to the ATH6KL through its diagnostic window. No cooperation from</span>
<span class="cm"> * the Target is required for this.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ath6kl_diag_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_hif_diag_write32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to write 0x%x during diagnose window to 0x%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">address</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_diag_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">,</span> <span class="n">address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_diag_read32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_diag_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">length</span> <span class="o">%</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">,</span> <span class="n">address</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_diag_write32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_read_fwlogs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_dbglog_hdr</span> <span class="n">debug_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_dbglog_buf</span> <span class="n">debug_buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">dropped</span><span class="p">,</span> <span class="n">firstbuf</span><span class="p">,</span> <span class="n">debug_hdr_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">loop</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">ATH6KL_FWLOG_PAYLOAD_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">TARG_VTOP</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span>
			    <span class="n">ath6kl_get_hi_item_addr</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span>
						    <span class="n">HI_ITEM</span><span class="p">(</span><span class="n">hi_dbglog_hdr</span><span class="p">)));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_diag_read32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hdr_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Get the contents of the ring buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug_hdr_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Invalid address for debug_hdr_addr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">TARG_VTOP</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span> <span class="n">debug_hdr_addr</span><span class="p">);</span>
	<span class="n">ath6kl_diag_read</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">debug_hdr</span><span class="p">));</span>

	<span class="n">address</span> <span class="o">=</span> <span class="n">TARG_VTOP</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">debug_hdr</span><span class="p">.</span><span class="n">dbuf_addr</span><span class="p">));</span>
	<span class="n">firstbuf</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">dropped</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">debug_hdr</span><span class="p">.</span><span class="n">dropped</span><span class="p">);</span>
	<span class="n">ath6kl_diag_read</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">debug_buf</span><span class="p">));</span>

	<span class="n">loop</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">address</span> <span class="o">=</span> <span class="n">TARG_VTOP</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span>
				    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">debug_buf</span><span class="p">.</span><span class="n">buffer_addr</span><span class="p">));</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">debug_buf</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">debug_buf</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&lt;=</span>
				    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">debug_buf</span><span class="p">.</span><span class="n">bufsize</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_diag_read</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span>
					       <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="n">ath6kl_debug_fwlog_event</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">address</span> <span class="o">=</span> <span class="n">TARG_VTOP</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">target_type</span><span class="p">,</span>
				    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">debug_buf</span><span class="p">.</span><span class="n">next</span><span class="p">));</span>
		<span class="n">ath6kl_diag_read</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">debug_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">debug_buf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">loop</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">address</span> <span class="o">!=</span> <span class="n">firstbuf</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FIXME: move to a better place, target.h? */</span>
<span class="cp">#define AR6003_RESET_CONTROL_ADDRESS 0x00004000</span>
<span class="cp">#define AR6004_RESET_CONTROL_ADDRESS 0x00004000</span>

<span class="kt">void</span> <span class="nf">ath6kl_reset_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u32</span> <span class="n">target_type</span><span class="p">,</span>
			 <span class="n">bool</span> <span class="n">wait_fot_compltn</span><span class="p">,</span> <span class="n">bool</span> <span class="n">cold_reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target_type</span> <span class="o">!=</span> <span class="n">TARGET_TYPE_AR6003</span> <span class="o">&amp;&amp;</span>
	    <span class="n">target_type</span> <span class="o">!=</span> <span class="n">TARGET_TYPE_AR6004</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">cold_reset</span> <span class="o">?</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RESET_CONTROL_COLD_RST</span><span class="p">)</span> <span class="o">:</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RESET_CONTROL_MBOX_RST</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">target_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TARGET_TYPE_AR6003</span>:
		<span class="n">address</span> <span class="o">=</span> <span class="n">AR6003_RESET_CONTROL_ADDRESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TARGET_TYPE_AR6004</span>:
		<span class="n">address</span> <span class="o">=</span> <span class="n">AR6004_RESET_CONTROL_ADDRESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_diag_write32</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to reset target</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_install_static_wep_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">keyusage</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="n">WMI_MAX_KEY_INDEX</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wep_key_list</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">keyusage</span> <span class="o">=</span> <span class="n">GROUP_USAGE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">def_txkey_index</span><span class="p">)</span>
				<span class="n">keyusage</span> <span class="o">|=</span> <span class="n">TX_USAGE</span><span class="p">;</span>

			<span class="n">ath6kl_wmi_addkey_cmd</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					      <span class="n">index</span><span class="p">,</span>
					      <span class="n">WEP_CRYPT</span><span class="p">,</span>
					      <span class="n">keyusage</span><span class="p">,</span>
					      <span class="n">vif</span><span class="o">-&gt;</span><span class="n">wep_key_list</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key_len</span><span class="p">,</span>
					      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="n">vif</span><span class="o">-&gt;</span><span class="n">wep_key_list</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">key</span><span class="p">,</span>
					      <span class="n">KEY_OP_INIT_VAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
					      <span class="n">NO_SYNC_WMIFLAG</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_connect_ap_mode_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_req_key</span> <span class="o">*</span><span class="n">ik</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_rsc</span><span class="p">[</span><span class="n">ATH6KL_KEY_SEQ_LEN</span><span class="p">];</span>

	<span class="n">ik</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ap_mode_bkey</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;AP mode started on %u MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NONE_AUTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">prwise_crypto</span> <span class="o">==</span> <span class="n">WEP_CRYPT</span><span class="p">)</span>
			<span class="n">ath6kl_install_static_wep_keys</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ik</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">||</span> <span class="n">ik</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">!=</span> <span class="n">WAPI_CRYPT</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* for WAPI, we need to set the delayed group key, continue: */</span>
	<span class="k">case</span> <span class="n">WPA_PSK_AUTH</span>:
	<span class="k">case</span> <span class="n">WPA2_PSK_AUTH</span>:
	<span class="k">case</span> <span class="p">(</span><span class="n">WPA_PSK_AUTH</span> <span class="o">|</span> <span class="n">WPA2_PSK_AUTH</span><span class="p">)</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ik</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
			   <span class="s">&quot;Delayed addkey for the initial group key for AP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">key_rsc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key_rsc</span><span class="p">));</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_wmi_addkey_cmd</span><span class="p">(</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">ik</span><span class="o">-&gt;</span><span class="n">key_index</span><span class="p">,</span> <span class="n">ik</span><span class="o">-&gt;</span><span class="n">key_type</span><span class="p">,</span>
			<span class="n">GROUP_USAGE</span><span class="p">,</span> <span class="n">ik</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">key_rsc</span><span class="p">,</span> <span class="n">ATH6KL_KEY_SEQ_LEN</span><span class="p">,</span>
			<span class="n">ik</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
			<span class="n">KEY_OP_INIT_VAL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">SYNC_BOTH_WMIFLAG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span>
				   <span class="s">&quot;Delayed addkey failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">want_ch_switch</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">want_ch_switch</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">);</span>
		<span class="cm">/* we actually don&#39;t know the phymode, default to HT20 */</span>
		<span class="n">ath6kl_cfg80211_ch_switch_notify</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
						 <span class="n">WMI_11G_HT20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath6kl_wmi_bssfilter_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">NONE_BSS_FILTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_connect_ap_mode_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">aid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">keymgmt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ucipher</span><span class="p">,</span> <span class="n">u8</span> <span class="n">auth</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">assoc_req_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">assoc_info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">apsd_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ies</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">wpa_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ies_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">station_info</span> <span class="n">sinfo</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span> <span class="s">&quot;new station %pM aid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">aid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">assoc_req_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">assoc_info</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_assoc_req</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">assoc_req_len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">)</span> <span class="o">+</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">assoc_req</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ies</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">assoc_req</span><span class="p">.</span><span class="n">variable</span><span class="p">;</span>
			<span class="n">ies_len</span> <span class="o">=</span> <span class="n">assoc_info</span> <span class="o">+</span> <span class="n">assoc_req_len</span> <span class="o">-</span> <span class="n">ies</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_reassoc_req</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="n">assoc_req_len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span><span class="p">)</span>
			   <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reassoc_req</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ies</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">reassoc_req</span><span class="p">.</span><span class="n">variable</span><span class="p">;</span>
			<span class="n">ies_len</span> <span class="o">=</span> <span class="n">assoc_info</span> <span class="o">+</span> <span class="n">assoc_req_len</span> <span class="o">-</span> <span class="n">ies</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">ies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">ies</span> <span class="o">+</span> <span class="n">ies_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ies</span> <span class="o">+</span> <span class="n">ies_len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_EID_RSN</span><span class="p">)</span>
			<span class="n">wpa_ie</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span> <span class="cm">/* RSN IE */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_EID_VENDOR_SPECIFIC</span> <span class="o">&amp;&amp;</span>
			 <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
			 <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span>
				<span class="n">wpa_ie</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span> <span class="cm">/* WPA IE */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wpa_ie</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span> <span class="cm">/* WPS IE */</span>
				<span class="k">break</span><span class="p">;</span> <span class="cm">/* overrides WPA/RSN IE */</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x44</span> <span class="o">&amp;&amp;</span> <span class="n">wpa_ie</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Note: WAPI Parameter Set IE re-uses Element ID that</span>
<span class="cm">			 * was officially allocated for BSS AC Access Delay. As</span>
<span class="cm">			 * such, we need to be a bit more careful on when</span>
<span class="cm">			 * parsing the frame. However, BSS AC Access Delay</span>
<span class="cm">			 * element is not supposed to be included in</span>
<span class="cm">			 * (Re)Association Request frames, so this should not</span>
<span class="cm">			 * cause problems.</span>
<span class="cm">			 */</span>
			<span class="n">wpa_ie</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span> <span class="cm">/* WAPI IE */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">ath6kl_add_new_sta</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">wpa_ie</span><span class="p">,</span>
			   <span class="n">wpa_ie</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">wpa_ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">keymgmt</span><span class="p">,</span> <span class="n">ucipher</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="n">apsd_info</span><span class="p">);</span>

	<span class="cm">/* send event to application */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sinfo</span><span class="p">));</span>

	<span class="cm">/* TODO: sinfo.generation */</span>

	<span class="n">sinfo</span><span class="p">.</span><span class="n">assoc_req_ies</span> <span class="o">=</span> <span class="n">ies</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="p">.</span><span class="n">assoc_req_ies_len</span> <span class="o">=</span> <span class="n">ies_len</span><span class="p">;</span>
	<span class="n">sinfo</span><span class="p">.</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_ASSOC_REQ_IES</span><span class="p">;</span>

	<span class="n">cfg80211_new_sta</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sinfo</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">disconnect_timer_handler</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ath6kl_init_profile_info</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="n">ath6kl_disconnect</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_wmi_disconnect_cmd</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Disconnect command is issued, clear the connect pending</span>
<span class="cm">		 * flag. The connected flag will be cleared in</span>
<span class="cm">		 * disconnect event notification.</span>
<span class="cm">		 */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* WMI Event handlers */</span>

<span class="kt">void</span> <span class="nf">ath6kl_ready_event</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">devt</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">datap</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sw_ver</span><span class="p">,</span> <span class="n">u32</span> <span class="n">abi_ver</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">wmi_phy_cap</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">devt</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">datap</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span> <span class="s">&quot;%s: mac addr = %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">wlan_ver</span> <span class="o">=</span> <span class="n">sw_ver</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">abi_ver</span> <span class="o">=</span> <span class="n">abi_ver</span><span class="p">;</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">cap</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span>
		 <span class="s">&quot;%u.%u.%u.%u&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">wlan_ver</span> <span class="o">&amp;</span> <span class="mh">0xf0000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">wlan_ver</span> <span class="o">&amp;</span> <span class="mh">0x0f000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">wlan_ver</span> <span class="o">&amp;</span> <span class="mh">0x00ff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">wlan_ver</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">));</span>

	<span class="cm">/* indicate to the waiting thread that the ready event was received */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">WMI_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_scan_complete_evt</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">aborted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">WMI_SCAN_STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">aborted</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">ath6kl_cfg80211_scan_complete_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">aborted</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">usr_bss_filter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">CLEAR_BSSFILTER_ON_BEACON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ath6kl_wmi_bssfilter_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					 <span class="n">NONE_BSS_FILTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;scan complete: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_commit_ch_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">next_chan</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">.</span><span class="n">ch</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AP_NETWORK</span>:
		<span class="k">return</span> <span class="n">ath6kl_wmi_ap_profile_commit</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">profile</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;won&#39;t switch channels nw_type=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_check_ch_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">,</span> <span class="n">u16</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">want_ch_switch</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">want_ch_switch</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">))</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">ath6kl_commit_ch_switch</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;channel switch failed nw_type %d res %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_connect_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">listen_int</span><span class="p">,</span> <span class="n">u16</span> <span class="n">beacon_int</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">network_type</span> <span class="n">net_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">beacon_ie_len</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">assoc_req_len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">assoc_resp_len</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">assoc_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>

	<span class="n">ath6kl_cfg80211_connect_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span>
				      <span class="n">listen_int</span><span class="p">,</span> <span class="n">beacon_int</span><span class="p">,</span>
				      <span class="n">net_type</span><span class="p">,</span> <span class="n">beacon_ie_len</span><span class="p">,</span>
				      <span class="n">assoc_req_len</span><span class="p">,</span> <span class="n">assoc_resp_len</span><span class="p">,</span>
				      <span class="n">assoc_info</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">));</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_ch</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">INFRA_NETWORK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_wmi_listeninterval_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					      <span class="n">vif</span><span class="o">-&gt;</span><span class="n">listen_intvl_t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ath6kl_check_ch_switch</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* Update connect &amp; link status atomically */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">if_lock</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">if_lock</span><span class="p">);</span>

	<span class="n">aggr_reset_state</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">aggr_cntxt</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">);</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">reconnect_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">ADHOC_NETWORK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ar</span><span class="o">-&gt;</span><span class="n">ibss_ps_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_map</span><span class="p">));</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">node_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">next_ep_id</span> <span class="o">=</span> <span class="n">ENDPOINT_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">usr_bss_filter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CLEAR_BSSFILTER_ON_BEACON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ath6kl_wmi_bssfilter_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					 <span class="n">CURRENT_BSS_FILTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_tkip_micerr_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">keyid</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ismcast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tsc</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * For AP case, keyid will have aid of STA which sent pkt with</span>
<span class="cm">	 * MIC error. Use this aid to get MAC &amp; send it to hostapd.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">ath6kl_find_sta_by_aid</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="p">(</span><span class="n">keyid</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span>
			   <span class="s">&quot;ap tkip mic error received from aid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">keyid</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">tsc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tsc</span><span class="p">));</span> <span class="cm">/* FIX: get correct TSC */</span>
		<span class="n">cfg80211_michael_mic_failure</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span>
					     <span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">,</span> <span class="n">keyid</span><span class="p">,</span>
					     <span class="n">tsc</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ath6kl_cfg80211_tkip_micerr_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">keyid</span><span class="p">,</span> <span class="n">ismcast</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_update_target_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_target_stats</span> <span class="o">*</span><span class="n">tgt_stats</span> <span class="o">=</span>
		<span class="p">(</span><span class="k">struct</span> <span class="n">wmi_target_stats</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">target_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">target_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tkip_ccmp_stats</span> <span class="o">*</span><span class="n">ccmp_stats</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ac</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tgt_stats</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span> <span class="s">&quot;updating target stats</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_pkt</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">pkt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_byte</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">byte</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_ucast_pkt</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">ucast_pkt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_ucast_byte</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">ucast_byte</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_mcast_pkt</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">mcast_pkt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_mcast_byte</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">mcast_byte</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bcast_pkt</span>  <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">bcast_pkt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bcast_byte</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">bcast_byte</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_rts_success_cnt</span> <span class="o">+=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">rts_success_cnt</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ac</span> <span class="o">&lt;</span> <span class="n">WMM_NUM_AC</span><span class="p">;</span> <span class="n">ac</span><span class="o">++</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_pkt_per_ac</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">+=</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">pkt_per_ac</span><span class="p">[</span><span class="n">ac</span><span class="p">]);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">err</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_fail_cnt</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">fail_cnt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_retry_cnt</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">retry_cnt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_mult_retry_cnt</span> <span class="o">+=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">mult_retry_cnt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_rts_fail_cnt</span> <span class="o">+=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">rts_fail_cnt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_ucast_rate</span> <span class="o">=</span>
	    <span class="n">ath6kl_wmi_get_rate</span><span class="p">(</span><span class="n">a_sle32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">ucast_rate</span><span class="p">));</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_pkt</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">pkt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_byte</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">byte</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_ucast_pkt</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">ucast_pkt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_ucast_byte</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">ucast_byte</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_mcast_pkt</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">mcast_pkt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_mcast_byte</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">mcast_byte</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bcast_pkt</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">bcast_pkt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bcast_byte</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">bcast_byte</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frgment_pkt</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">frgment_pkt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">err</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_err</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">crc_err</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_key_cache_miss</span> <span class="o">+=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">key_cache_miss</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_decrypt_err</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">decrypt_err</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dupl_frame</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">dupl_frame</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_ucast_rate</span> <span class="o">=</span>
	    <span class="n">ath6kl_wmi_get_rate</span><span class="p">(</span><span class="n">a_sle32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">ucast_rate</span><span class="p">));</span>

	<span class="n">ccmp_stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tkip_ccmp_stats</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tkip_local_mic_fail</span> <span class="o">+=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ccmp_stats</span><span class="o">-&gt;</span><span class="n">tkip_local_mic_fail</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tkip_cnter_measures_invoked</span> <span class="o">+=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ccmp_stats</span><span class="o">-&gt;</span><span class="n">tkip_cnter_measures_invoked</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tkip_fmt_err</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ccmp_stats</span><span class="o">-&gt;</span><span class="n">tkip_fmt_err</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">ccmp_fmt_err</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ccmp_stats</span><span class="o">-&gt;</span><span class="n">ccmp_fmt_err</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">ccmp_replays</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ccmp_stats</span><span class="o">-&gt;</span><span class="n">ccmp_replays</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">pwr_save_fail_cnt</span> <span class="o">+=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">pm_stats</span><span class="p">.</span><span class="n">pwr_save_failure_cnt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">noise_floor_calib</span> <span class="o">=</span>
		<span class="n">a_sle32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">noise_floor_calib</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">cs_bmiss_cnt</span> <span class="o">+=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cserv_stats</span><span class="p">.</span><span class="n">cs_bmiss_cnt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">cs_low_rssi_cnt</span> <span class="o">+=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cserv_stats</span><span class="p">.</span><span class="n">cs_low_rssi_cnt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">cs_connect_cnt</span> <span class="o">+=</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cserv_stats</span><span class="p">.</span><span class="n">cs_connect_cnt</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">cs_discon_cnt</span> <span class="o">+=</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cserv_stats</span><span class="p">.</span><span class="n">cs_discon_cnt</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">cs_ave_beacon_rssi</span> <span class="o">=</span>
		<span class="n">a_sle16_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cserv_stats</span><span class="p">.</span><span class="n">cs_ave_beacon_rssi</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">cs_last_roam_msec</span> <span class="o">=</span>
		<span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cserv_stats</span><span class="p">.</span><span class="n">cs_last_roam_msec</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">cs_snr</span> <span class="o">=</span> <span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cserv_stats</span><span class="p">.</span><span class="n">cs_snr</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">cs_rssi</span> <span class="o">=</span> <span class="n">a_sle16_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">cserv_stats</span><span class="p">.</span><span class="n">cs_rssi</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">lq_val</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">lq_val</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">wow_pkt_dropped</span> <span class="o">+=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">wow_stats</span><span class="p">.</span><span class="n">wow_pkt_dropped</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">wow_host_pkt_wakeups</span> <span class="o">+=</span>
		<span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">wow_stats</span><span class="p">.</span><span class="n">wow_host_pkt_wakeups</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">wow_host_evt_wakeups</span> <span class="o">+=</span>
		<span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">wow_stats</span><span class="p">.</span><span class="n">wow_host_evt_wakeups</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">wow_evt_discarded</span> <span class="o">+=</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">wow_stats</span><span class="p">.</span><span class="n">wow_evt_discarded</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">arp_received</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">arp_stats</span><span class="p">.</span><span class="n">arp_received</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">arp_replied</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">arp_stats</span><span class="p">.</span><span class="n">arp_replied</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">arp_matched</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tgt_stats</span><span class="o">-&gt;</span><span class="n">arp_stats</span><span class="p">.</span><span class="n">arp_matched</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">STATS_UPDATE_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">STATS_UPDATE_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_add_le32</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">var</span><span class="p">)</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_tgt_stats_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmi_ap_mode_stat</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wmi_ap_mode_stat</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_ap_mode_stat</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ap_stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmi_per_sta_stat</span> <span class="o">*</span><span class="n">st_ap</span><span class="p">,</span> <span class="o">*</span><span class="n">st_p</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ac</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">ac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ac</span> <span class="o">&lt;</span> <span class="n">AP_MAX_NUM_STA</span><span class="p">;</span> <span class="n">ac</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">st_ap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">[</span><span class="n">ac</span><span class="p">];</span>
			<span class="n">st_p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">[</span><span class="n">ac</span><span class="p">];</span>

			<span class="n">ath6kl_add_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ap</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">,</span> <span class="n">st_p</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">);</span>
			<span class="n">ath6kl_add_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ap</span><span class="o">-&gt;</span><span class="n">tx_pkts</span><span class="p">,</span> <span class="n">st_p</span><span class="o">-&gt;</span><span class="n">tx_pkts</span><span class="p">);</span>
			<span class="n">ath6kl_add_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ap</span><span class="o">-&gt;</span><span class="n">tx_error</span><span class="p">,</span> <span class="n">st_p</span><span class="o">-&gt;</span><span class="n">tx_error</span><span class="p">);</span>
			<span class="n">ath6kl_add_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ap</span><span class="o">-&gt;</span><span class="n">tx_discard</span><span class="p">,</span> <span class="n">st_p</span><span class="o">-&gt;</span><span class="n">tx_discard</span><span class="p">);</span>
			<span class="n">ath6kl_add_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ap</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">,</span> <span class="n">st_p</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">);</span>
			<span class="n">ath6kl_add_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ap</span><span class="o">-&gt;</span><span class="n">rx_pkts</span><span class="p">,</span> <span class="n">st_p</span><span class="o">-&gt;</span><span class="n">rx_pkts</span><span class="p">);</span>
			<span class="n">ath6kl_add_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ap</span><span class="o">-&gt;</span><span class="n">rx_error</span><span class="p">,</span> <span class="n">st_p</span><span class="o">-&gt;</span><span class="n">rx_error</span><span class="p">);</span>
			<span class="n">ath6kl_add_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st_ap</span><span class="o">-&gt;</span><span class="n">rx_discard</span><span class="p">,</span> <span class="n">st_p</span><span class="o">-&gt;</span><span class="n">rx_discard</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ath6kl_update_target_stats</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_wakeup_event</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_txpwr_rx_evt</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">devt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tx_pwr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="p">)</span> <span class="n">devt</span><span class="p">;</span>

	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">tx_pwr</span> <span class="o">=</span> <span class="n">tx_pwr</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">event_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_pspoll_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">aid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_sta</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">psq_empty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_mgmt_buff</span> <span class="o">*</span><span class="n">mgmt_buf</span><span class="p">;</span>

	<span class="n">conn</span> <span class="o">=</span> <span class="n">ath6kl_find_sta_by_aid</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">aid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Send out a packet queued on ps queue. When the ps queue</span>
<span class="cm">	 * becomes empty update the PVB for this station.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
	<span class="n">psq_empty</span>  <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psq_empty</span><span class="p">)</span>
		<span class="cm">/* TODO: Send out a NULL data frame */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mgmt_buf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ath6kl_mgmt_buff</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>

		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">|=</span> <span class="n">STA_PS_POLLED</span><span class="p">;</span>
		<span class="n">ath6kl_wmi_send_mgmt_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
					 <span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">,</span>
					 <span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
					 <span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">mgmt_buf</span><span class="o">-&gt;</span><span class="n">no_cck</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STA_PS_POLLED</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mgmt_buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>

		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">|=</span> <span class="n">STA_PS_POLLED</span><span class="p">;</span>
		<span class="n">ath6kl_data_tx</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">conn</span><span class="o">-&gt;</span><span class="n">sta_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STA_PS_POLLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>
	<span class="n">psq_empty</span>  <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">mgmt_psq_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">psq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psq_empty</span><span class="p">)</span>
		<span class="n">ath6kl_wmi_set_pvb_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">conn</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_dtimexpiry_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">mcastq_empty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there are no associated STAs, ignore the DTIM expiry event.</span>
<span class="cm">	 * There can be potential race conditions where the last associated</span>
<span class="cm">	 * STA may disconnect &amp; before the host could clear the &#39;Indicate</span>
<span class="cm">	 * DTIM&#39; request to the firmware, the firmware would have just</span>
<span class="cm">	 * indicated a DTIM expiry event. The race is between &#39;clear DTIM</span>
<span class="cm">	 * expiry cmd&#39; going from the host to the firmware &amp; the DTIM</span>
<span class="cm">	 * expiry event happening from the firmware to the host.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list_index</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>
	<span class="n">mcastq_empty</span> <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mcastq_empty</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* set the STA flag to dtim_expired for the frame to go out */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">DTIM_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>

		<span class="n">ath6kl_data_tx</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">DTIM_EXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* clear the LSB of the BitMapCtl field of the TIM IE */</span>
	<span class="n">ath6kl_wmi_set_pvb_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">MCAST_AID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ath6kl_disconnect_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reason</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">assoc_resp_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">assoc_info</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">prot_reason_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">nw_type</span> <span class="o">==</span> <span class="n">AP_NETWORK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disconnect due to other STA vif switching channels */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">BSS_DISCONNECTED</span> <span class="o">&amp;&amp;</span>
		    <span class="n">prot_reason_status</span> <span class="o">==</span> <span class="n">WMI_AP_REASON_STA_ROAM</span><span class="p">)</span>
			<span class="n">ar</span><span class="o">-&gt;</span><span class="n">want_ch_switch</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_remove_sta</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">prot_reason_status</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="cm">/* if no more associated STAs, empty the mcast PS q */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">sta_list_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>
			<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mcastpsq_lock</span><span class="p">);</span>

			<span class="cm">/* clear the LSB of the TIM IE&#39;s BitMapCtl field */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span>
				<span class="n">ath6kl_wmi_set_pvb_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						       <span class="n">MCAST_AID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">bssid</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* send event to application */</span>
			<span class="n">cfg80211_del_sta</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wep_key_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">wep_key_list</span><span class="p">));</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_cfg80211_disconnect_event</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span>
					 <span class="n">assoc_resp_len</span><span class="p">,</span> <span class="n">assoc_info</span><span class="p">,</span>
					 <span class="n">prot_reason_status</span><span class="p">);</span>

	<span class="n">aggr_reset_state</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">aggr_cntxt</span><span class="o">-&gt;</span><span class="n">aggr_conn</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">disconnect_timer</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_WLAN_CFG</span><span class="p">,</span> <span class="s">&quot;disconnect reason is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the event is due to disconnect cmd from the host, only they</span>
<span class="cm">	 * the target would stop trying to connect. Under any other</span>
<span class="cm">	 * condition, target would keep trying to connect.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">DISCONNECT_CMD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">usr_bss_filter</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">))</span>
			<span class="n">ath6kl_wmi_bssfilter_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						 <span class="n">NONE_BSS_FILTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">CONNECT_PEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">reason</span> <span class="o">==</span> <span class="n">ASSOC_FAILED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">prot_reason_status</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">((</span><span class="n">reason</span> <span class="o">==</span> <span class="n">ASSOC_FAILED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">prot_reason_status</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">reconnect_flag</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* update connect &amp; link status atomically */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">if_lock</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">if_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">CSERV_DISCONNECT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">reconnect_flag</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">vif</span><span class="o">-&gt;</span><span class="n">reconnect_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="n">CSERV_DISCONNECT</span><span class="p">)</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">user_key_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">));</span>
	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ath6kl_tx_data_cleanup</span><span class="p">(</span><span class="n">ar</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="nf">ath6kl_vif_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vif</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">vif_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ath6kl_vif</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">list_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vif</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">WLAN_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CONNECTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ath6kl_cfg80211_stop</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">WLAN_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">ath6kl_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">net_stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_set_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">netdev_features_t</span> <span class="n">features</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_meta_ver</span> <span class="o">!=</span> <span class="n">WMI_META_VERSION_2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_meta_ver</span> <span class="o">=</span> <span class="n">WMI_META_VERSION_2</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_rx_frame_format_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
							 <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
							 <span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_meta_ver</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">features</span> <span class="o">&amp;</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_meta_ver</span> <span class="o">==</span> <span class="n">WMI_META_VERSION_2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_meta_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ath6kl_wmi_set_rx_frame_format_cmd</span><span class="p">(</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
							 <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
							 <span class="n">ar</span><span class="o">-&gt;</span><span class="n">rx_meta_ver</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">mc_all_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mc_count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">found</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ath6kl_mc_filter</span> <span class="o">*</span><span class="n">mc_filter</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">mc_filter_new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WMI_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WLAN_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Enable multicast-all filter. */</span>
	<span class="n">mc_all_on</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!!</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!!</span><span class="p">(</span><span class="n">mc_count</span> <span class="o">&gt;</span> <span class="n">ATH6K_MAX_MC_FILTERS_PER_LIST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mc_all_on</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NETDEV_MCAST_ALL_ON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NETDEV_MCAST_ALL_ON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">mc_all_on</span> <span class="o">=</span> <span class="n">mc_all_on</span> <span class="o">||</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ATH6KL_STATE_ON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_MULTICAST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mc_all_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">NETDEV_MCAST_ALL_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">NETDEV_MCAST_ALL_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable/disable &quot;multicast-all&quot; filter*/</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span> <span class="s">&quot;%s multicast-all filter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">mc_all_on</span> <span class="o">?</span> <span class="s">&quot;enabling&quot;</span> <span class="o">:</span> <span class="s">&quot;disabling&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_mcast_filter_cmd</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span>
						  <span class="n">mc_all_on</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Failed to %s multicast-all receive</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">mc_all_on</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">NETDEV_MCAST_ALL_ON</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Keep the driver and firmware mcast list in sync. */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">mc_filter</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">,</span>
				   <span class="n">ATH6KL_MCAST_FILTER_MAC_ADDR_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Delete the filter which was previously set</span>
<span class="cm">			 * but not in the new request.</span>
<span class="cm">			 */</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span>
				   <span class="s">&quot;Removing %pM from multicast filter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_add_del_mcast_filter_cmd</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">,</span>
					<span class="nb">false</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Failed to remove multicast filter:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc_filter_new</span><span class="p">);</span>

	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">ndev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">mc_filter</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">,</span>
				   <span class="n">ATH6KL_MCAST_FILTER_MAC_ADDR_SIZE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mc_filter</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_mc_filter</span><span class="p">),</span>
					    <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mc_filter</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			       <span class="n">ATH6KL_MCAST_FILTER_MAC_ADDR_SIZE</span><span class="p">);</span>
			<span class="cm">/* Set the multicast filter */</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_TRC</span><span class="p">,</span>
				   <span class="s">&quot;Adding %pM to multicast filter list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ath6kl_wmi_add_del_mcast_filter_cmd</span><span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">wmi</span><span class="p">,</span>
					<span class="n">vif</span><span class="o">-&gt;</span><span class="n">fw_vif_idx</span><span class="p">,</span> <span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">,</span>
					<span class="nb">true</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Failed to add multicast filter :%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">hw_addr</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">mc_filter</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc_filter</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mc_filter_new</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">list_splice_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mc_filter_new</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">mc_filter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ath6kl_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>               <span class="o">=</span> <span class="n">ath6kl_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>               <span class="o">=</span> <span class="n">ath6kl_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>         <span class="o">=</span> <span class="n">ath6kl_data_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>          <span class="o">=</span> <span class="n">ath6kl_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_features</span>       <span class="o">=</span> <span class="n">ath6kl_set_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">ath6kl_set_multicast_list</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">init_netdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath6kl_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">free_netdev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">ATH6KL_TX_TIMEOUT</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_headroom</span> <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">needed_headroom</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_llc_snap_hdr</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmi_data_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span>
				<span class="o">+</span> <span class="n">WMI_MAX_TX_META_SZ</span> <span class="o">+</span> <span class="n">ATH6KL_HTC_ALIGN_BYTES</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_features</span> <span class="o">|=</span> <span class="n">NETIF_F_IP_CSUM</span> <span class="o">|</span> <span class="n">NETIF_F_RXCSUM</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
