<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ath › ath6kl › htc_mbox.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>htc_mbox.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2007-2011 Atheros Communications Inc.</span>
<span class="cm"> * Copyright (c) 2011-2012 Qualcomm Atheros, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR</span>
<span class="cm"> * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN</span>
<span class="cm"> * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF</span>
<span class="cm"> * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;core.h&quot;</span>
<span class="cp">#include &quot;hif.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;hif-ops.h&quot;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#define CALC_TXRX_PADDED_LEN(dev, len)  (__ALIGN_MASK((len), (dev)-&gt;block_mask))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ath6kl_htc_mbox_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ath6kl_htc_mbox_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ath6kl_htc_mbox_add_rxbuf_multiple</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pkt_queue</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ath6kl_htc_set_credit_dist</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span> <span class="o">*</span><span class="n">cred_info</span><span class="p">,</span>
				       <span class="n">u16</span> <span class="n">svc_pri_order</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>

<span class="cm">/* threshold to re-enable Tx bundling for an AC*/</span>
<span class="cp">#define TX_RESUME_BUNDLE_THRESHOLD	1500</span>

<span class="cm">/* Functions for Tx credit handling */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_credit_deposit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span> <span class="o">*</span><span class="n">cred_info</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">htc_endpoint_credit_dist</span> <span class="o">*</span><span class="n">ep_dist</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">credits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot;credit deposit ep %d credits %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>

	<span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">+=</span> <span class="n">credits</span><span class="p">;</span>
	<span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">cred_assngd</span> <span class="o">+=</span> <span class="n">credits</span><span class="p">;</span>
	<span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span> <span class="o">-=</span> <span class="n">credits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_credit_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span> <span class="o">*</span><span class="n">cred_info</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ep_list</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">tot_credits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint_credit_dist</span> <span class="o">*</span><span class="n">cur_ep_dist</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot;credit init total %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tot_credits</span><span class="p">);</span>

	<span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span> <span class="o">=</span> <span class="n">tot_credits</span><span class="p">;</span>
	<span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">total_avail_credits</span> <span class="o">=</span> <span class="n">tot_credits</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cur_ep_dist</span><span class="p">,</span> <span class="n">ep_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">==</span> <span class="n">ENDPOINT_0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_min</span> <span class="o">=</span> <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_per_msg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tot_credits</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">WMI_DATA_BK_SVC</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">WMI_DATA_BE_SVC</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ath6kl_credit_deposit</span><span class="p">(</span><span class="n">cred_info</span><span class="p">,</span>
						      <span class="n">cur_ep_dist</span><span class="p">,</span>
						      <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_min</span><span class="p">);</span>
				<span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">dist_flags</span> <span class="o">|=</span> <span class="n">HTC_EP_ACTIVE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">WMI_CONTROL_SVC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_credit_deposit</span><span class="p">(</span><span class="n">cred_info</span><span class="p">,</span> <span class="n">cur_ep_dist</span><span class="p">,</span>
					      <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_min</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Control service is always marked active, it</span>
<span class="cm">			 * never goes inactive EVER.</span>
<span class="cm">			 */</span>
			<span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">dist_flags</span> <span class="o">|=</span> <span class="n">HTC_EP_ACTIVE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Streams have to be created (explicit | implicit) for all</span>
<span class="cm">		 * kinds of traffic. BE endpoints are also inactive in the</span>
<span class="cm">		 * beginning. When BE traffic starts it creates implicit</span>
<span class="cm">		 * streams that redistributes credits.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Note: all other endpoints have minimums set but are</span>
<span class="cm">		 * initially given NO credits. credits will be distributed</span>
<span class="cm">		 * as traffic activity demands</span>
<span class="cm">		 */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * For ath6kl_credit_seek function,</span>
<span class="cm">	 * it use list_for_each_entry_reverse to walk around the whole ep list.</span>
<span class="cm">	 * Therefore assign this lowestpri_ep_dist after walk around the ep_list</span>
<span class="cm">	 */</span>
	<span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">lowestpri_ep_dist</span> <span class="o">=</span> <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cur_ep_dist</span><span class="p">,</span> <span class="n">ep_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">==</span> <span class="n">ENDPOINT_0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">WMI_CONTROL_SVC</span><span class="p">)</span>
			<span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_norm</span> <span class="o">=</span> <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_per_msg</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * For the remaining data endpoints, we assume that</span>
<span class="cm">			 * each cred_per_msg are the same. We use a simple</span>
<span class="cm">			 * calculation here, we take the remaining credits</span>
<span class="cm">			 * and determine how many max messages this can</span>
<span class="cm">			 * cover and then set each endpoint&#39;s normal value</span>
<span class="cm">			 * equal to 3/4 this amount.</span>
<span class="cm">			 */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span> <span class="o">/</span>
				 <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_per_msg</span><span class="p">)</span>
				<span class="o">*</span> <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_per_msg</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_per_msg</span><span class="p">);</span>
			<span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_norm</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

		<span class="p">}</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span>
			   <span class="s">&quot;credit ep %d svc_id %d credits %d per_msg %d norm %d min %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span>
			   <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">,</span>
			   <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">,</span>
			   <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_per_msg</span><span class="p">,</span>
			   <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_norm</span><span class="p">,</span>
			   <span class="n">cur_ep_dist</span><span class="o">-&gt;</span><span class="n">cred_min</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* initialize and setup credit distribution */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_mbox_credit_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">htc_target</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span> <span class="o">*</span><span class="n">cred_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">servicepriority</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cred_info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span><span class="p">));</span>

	<span class="n">servicepriority</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WMI_CONTROL_SVC</span><span class="p">;</span>  <span class="cm">/* highest */</span>
	<span class="n">servicepriority</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">WMI_DATA_VO_SVC</span><span class="p">;</span>
	<span class="n">servicepriority</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">WMI_DATA_VI_SVC</span><span class="p">;</span>
	<span class="n">servicepriority</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">WMI_DATA_BE_SVC</span><span class="p">;</span>
	<span class="n">servicepriority</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">WMI_DATA_BK_SVC</span><span class="p">;</span> <span class="cm">/* lowest */</span>

	<span class="cm">/* set priority list */</span>
	<span class="n">ath6kl_htc_set_credit_dist</span><span class="p">(</span><span class="n">htc_target</span><span class="p">,</span> <span class="n">cred_info</span><span class="p">,</span> <span class="n">servicepriority</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* reduce an ep&#39;s credits back to a set limit */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_credit_reduce</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span> <span class="o">*</span><span class="n">cred_info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">htc_endpoint_credit_dist</span> <span class="o">*</span><span class="n">ep_dist</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">credits</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot;credit reduce ep %d limit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>

	<span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">cred_assngd</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">&lt;=</span> <span class="n">limit</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">credits</span> <span class="o">=</span> <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">-</span> <span class="n">limit</span><span class="p">;</span>
	<span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">-=</span> <span class="n">credits</span><span class="p">;</span>
	<span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span> <span class="o">+=</span> <span class="n">credits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_credit_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span> <span class="o">*</span><span class="n">cred_info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">epdist_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint_credit_dist</span> <span class="o">*</span><span class="n">cur_list</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cur_list</span><span class="p">,</span> <span class="n">epdist_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">==</span> <span class="n">ENDPOINT_0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">cred_to_dist</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">+=</span> <span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">cred_to_dist</span><span class="p">;</span>
			<span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">cred_to_dist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">&gt;</span> <span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">cred_assngd</span><span class="p">)</span>
				<span class="n">ath6kl_credit_reduce</span><span class="p">(</span><span class="n">cred_info</span><span class="p">,</span>
						     <span class="n">cur_list</span><span class="p">,</span>
						     <span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">cred_assngd</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">credits</span> <span class="o">&gt;</span> <span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">cred_norm</span><span class="p">)</span>
				<span class="n">ath6kl_credit_reduce</span><span class="p">(</span><span class="n">cred_info</span><span class="p">,</span> <span class="n">cur_list</span><span class="p">,</span>
						     <span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">cred_norm</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">dist_flags</span> <span class="o">&amp;</span> <span class="n">HTC_EP_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">cur_list</span><span class="o">-&gt;</span><span class="n">txq_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">ath6kl_credit_reduce</span><span class="p">(</span><span class="n">cred_info</span><span class="p">,</span>
							     <span class="n">cur_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * HTC has an endpoint that needs credits, ep_dist is the endpoint in</span>
<span class="cm"> * question.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_credit_seek</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span> <span class="o">*</span><span class="n">cred_info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">htc_endpoint_credit_dist</span> <span class="o">*</span><span class="n">ep_dist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint_credit_dist</span> <span class="o">*</span><span class="n">curdist_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">credits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">WMI_CONTROL_SVC</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">WMI_DATA_VI_SVC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">WMI_DATA_VO_SVC</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">cred_assngd</span> <span class="o">&gt;=</span> <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">cred_norm</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For all other services, we follow a simple algorithm of:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1. checking the free pool for credits</span>
<span class="cm">	 * 2. checking lower priority endpoints for credits to take</span>
<span class="cm">	 */</span>

	<span class="n">credits</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span><span class="p">,</span> <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">seek_cred</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">credits</span> <span class="o">&gt;=</span> <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">seek_cred</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We don&#39;t have enough in the free pool, try taking away from</span>
<span class="cm">	 * lower priority services The rule for taking away credits:</span>
<span class="cm">	 *</span>
<span class="cm">	 *   1. Only take from lower priority endpoints</span>
<span class="cm">	 *   2. Only take what is allocated above the minimum (never</span>
<span class="cm">	 *      starve an endpoint completely)</span>
<span class="cm">	 *   3. Only take what you need.</span>
<span class="cm">	 */</span>

	<span class="n">list_for_each_entry_reverse</span><span class="p">(</span><span class="n">curdist_list</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">lowestpri_ep_dist</span><span class="p">,</span>
				    <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curdist_list</span> <span class="o">==</span> <span class="n">ep_dist</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">need</span> <span class="o">=</span> <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">seek_cred</span> <span class="o">-</span> <span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">cred_assngd</span> <span class="o">-</span> <span class="n">need</span><span class="p">)</span> <span class="o">&gt;=</span>
		     <span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">cred_min</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * The current one has been allocated more than</span>
<span class="cm">			 * it&#39;s minimum and it has enough credits assigned</span>
<span class="cm">			 * above it&#39;s minimum to fulfill our need try to</span>
<span class="cm">			 * take away just enough to fulfill our need.</span>
<span class="cm">			 */</span>
			<span class="n">ath6kl_credit_reduce</span><span class="p">(</span><span class="n">cred_info</span><span class="p">,</span> <span class="n">curdist_list</span><span class="p">,</span>
					     <span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">cred_assngd</span> <span class="o">-</span> <span class="n">need</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span> <span class="o">&gt;=</span>
			    <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">seek_cred</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">==</span> <span class="n">ENDPOINT_0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">credits</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span><span class="p">,</span> <span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">seek_cred</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="cm">/* did we find some credits? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">credits</span><span class="p">)</span>
		<span class="n">ath6kl_credit_deposit</span><span class="p">(</span><span class="n">cred_info</span><span class="p">,</span> <span class="n">ep_dist</span><span class="p">,</span> <span class="n">credits</span><span class="p">);</span>

	<span class="n">ep_dist</span><span class="o">-&gt;</span><span class="n">seek_cred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* redistribute credits based on activity change */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_credit_redistribute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ep_dist_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint_credit_dist</span> <span class="o">*</span><span class="n">curdist_list</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">curdist_list</span><span class="p">,</span> <span class="n">ep_dist_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">==</span> <span class="n">ENDPOINT_0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">WMI_DATA_BK_SVC</span><span class="p">)</span>  <span class="o">||</span>
		    <span class="p">(</span><span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">WMI_DATA_BE_SVC</span><span class="p">))</span>
			<span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">dist_flags</span> <span class="o">|=</span> <span class="n">HTC_EP_ACTIVE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">!=</span> <span class="n">WMI_CONTROL_SVC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">dist_flags</span> <span class="o">&amp;</span> <span class="n">HTC_EP_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">txq_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ath6kl_credit_reduce</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">curdist_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ath6kl_credit_reduce</span><span class="p">(</span><span class="n">info</span><span class="p">,</span>
						     <span class="n">curdist_list</span><span class="p">,</span>
						     <span class="n">curdist_list</span><span class="o">-&gt;</span><span class="n">cred_min</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * This function is invoked whenever endpoints require credit</span>
<span class="cm"> * distributions. A lock is held while this function is invoked, this</span>
<span class="cm"> * function shall NOT block. The ep_dist_list is a list of distribution</span>
<span class="cm"> * structures in prioritized order as defined by the call to the</span>
<span class="cm"> * htc_set_credit_dist() api.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_credit_distribute</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span> <span class="o">*</span><span class="n">cred_info</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ep_dist_list</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">htc_credit_dist_reason</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HTC_CREDIT_DIST_SEND_COMPLETE</span>:
		<span class="n">ath6kl_credit_update</span><span class="p">(</span><span class="n">cred_info</span><span class="p">,</span> <span class="n">ep_dist_list</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HTC_CREDIT_DIST_ACTIVITY_CHANGE</span>:
		<span class="n">ath6kl_credit_redistribute</span><span class="p">(</span><span class="n">cred_info</span><span class="p">,</span> <span class="n">ep_dist_list</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span> <span class="o">&gt;</span> <span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">total_avail_credits</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">cred_info</span><span class="o">-&gt;</span><span class="n">cur_free_credits</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_tx_buf_align</span><span class="p">(</span><span class="n">u8</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">align_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ALIGNED</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">align_addr</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">align_addr</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">align_addr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_tx_prep_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flags</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="n">ctrl0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ctrl1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">-=</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span>  <span class="p">(</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* Endianess? */</span>
	<span class="n">put_unaligned</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">payld_len</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl0</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ctrl1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_reclaim_txctrl_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_ctrl_txbuf</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="nf">htc_get_control_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					      <span class="n">bool</span> <span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">buf_list</span><span class="p">;</span>

	<span class="n">buf_list</span> <span class="o">=</span> <span class="n">tx</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_ctrl_txbuf</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_ctrl_rxbuf</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">buf_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">buf_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="p">)</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_start</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">packet</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_tx_comp_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;req failed (status:%d, ep:%d, len:%d creds:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">,</span>
		   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">cred_used</span><span class="p">);</span>

	<span class="cm">/* on failure to submit, reclaim credits for this packet */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_to_dist</span> <span class="o">+=</span>
				<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">cred_used</span><span class="p">;</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">txq_depth</span> <span class="o">=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;htc tx ctxt 0x%p dist 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">);</span>

	<span class="n">ath6kl_credit_distribute</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">,</span>
				 <span class="n">HTC_CREDIT_DIST_SEND_COMPLETE</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_tx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">txq</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;htc tx complete ep %d pkts %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">txq</span><span class="p">));</span>

	<span class="n">ath6kl_tx_complete</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_tx_comp_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">container</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;htc tx complete seqno %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">seqno</span><span class="p">);</span>

	<span class="n">htc_tx_comp_update</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
	<span class="cm">/* do completion */</span>
	<span class="n">htc_tx_complete</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_async_tx_scat_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">hif_scatter_req</span> <span class="o">*</span><span class="n">scat_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">tx_compq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_compq</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;htc tx scat complete len %d entries %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_entries</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;send scatter req failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">packet</span> <span class="o">=</span> <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">packet</span><span class="p">;</span>
	<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">];</span>

	<span class="cm">/* walk through the scatter list and process */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">packet</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="n">htc_tx_comp_update</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_compq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* free scatter request */</span>
	<span class="n">hif_scatter_req_add</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span> <span class="n">scat_req</span><span class="p">);</span>

	<span class="cm">/* complete all packets */</span>
	<span class="n">htc_tx_complete</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_compq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_tx_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sync</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">padded_len</span><span class="p">,</span> <span class="n">send_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">)</span>
		<span class="n">sync</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">send_len</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>

	<span class="n">padded_len</span> <span class="o">=</span> <span class="n">CALC_TXRX_PADDED_LEN</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">send_len</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;htc tx issue len %d seqno %d padded_len %d mbox 0x%X %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">send_len</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">seqno</span><span class="p">,</span> <span class="n">padded_len</span><span class="p">,</span>
		   <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mbox_info</span><span class="p">.</span><span class="n">htc_addr</span><span class="p">,</span>
		   <span class="n">sync</span> <span class="o">?</span> <span class="s">&quot;sync&quot;</span> <span class="o">:</span> <span class="s">&quot;async&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">hif_read_write_sync</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mbox_info</span><span class="p">.</span><span class="n">htc_addr</span><span class="p">,</span>
				 <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">padded_len</span><span class="p">,</span>
				 <span class="n">HIF_WR_SYNC_BLOCK_INC</span><span class="p">);</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">hif_write_async</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mbox_info</span><span class="p">.</span><span class="n">htc_addr</span><span class="p">,</span>
				<span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">padded_len</span><span class="p">,</span>
				<span class="n">HIF_WR_ASYNC_BLOCK_INC</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_check_credits</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">eid</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">req_cred</span><span class="p">)</span>
<span class="p">{</span>

	<span class="o">*</span><span class="n">req_cred</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">)</span> <span class="o">?</span>
		     <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span> <span class="s">&quot;credit check need %d got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="o">*</span><span class="n">req_cred</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">req_cred</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eid</span> <span class="o">==</span> <span class="n">ENDPOINT_0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* Seek more credits */</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">seek_cred</span> <span class="o">=</span> <span class="o">*</span><span class="n">req_cred</span> <span class="o">-</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span><span class="p">;</span>

		<span class="n">ath6kl_credit_seek</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">);</span>

		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">seek_cred</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">req_cred</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span>
				   <span class="s">&quot;credit not found for ep %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">eid</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">-=</span> <span class="o">*</span><span class="n">req_cred</span><span class="p">;</span>
	<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">cred_cosumd</span> <span class="o">+=</span> <span class="o">*</span><span class="n">req_cred</span><span class="p">;</span>

	 <span class="cm">/* When we are getting low on credits, ask for more */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_per_msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">seek_cred</span> <span class="o">=</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_per_msg</span> <span class="o">-</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span><span class="p">;</span>

		<span class="n">ath6kl_credit_seek</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">);</span>

		<span class="cm">/* see if we were successful in getting more */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">&lt;</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_per_msg</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* tell the target we need credits ASAP! */</span>
			<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HTC_FLAGS_NEED_CREDIT_UPDATE</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">cred_low_indicate</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span>
				   <span class="s">&quot;credit we need credits asap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_tx_pkts_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">req_cred</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span>
					  <span class="n">list</span><span class="p">);</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;htc tx got packet 0x%p queue depth %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">packet</span><span class="p">,</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">));</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">CALC_TXRX_PADDED_LEN</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
					   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">htc_check_credits</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span>
				      <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req_cred</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* now we can fully move onto caller&#39;s queue */</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span>
					  <span class="n">list</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

		<span class="cm">/* save the number of credits this packet consumed */</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">cred_used</span> <span class="o">=</span> <span class="n">req_cred</span><span class="p">;</span>

		<span class="cm">/* all TX packets are handled asynchronously */</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">=</span> <span class="n">htc_tx_comp_handler</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">tx_issued</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* save send flags */</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="p">;</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">seqno</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* See if the padded tx length falls on a credit boundary */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_get_credit_padding</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cred_sz</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rem_cred</span><span class="p">,</span> <span class="n">cred_pad</span><span class="p">;</span>

	<span class="n">rem_cred</span> <span class="o">=</span> <span class="o">*</span><span class="n">len</span> <span class="o">%</span> <span class="n">cred_sz</span><span class="p">;</span>

	<span class="cm">/* No padding needed */</span>
	<span class="k">if</span>  <span class="p">(</span><span class="o">!</span><span class="n">rem_cred</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">&amp;</span> <span class="n">HTC_FLGS_TX_BNDL_PAD_EN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The transfer consumes a &quot;partial&quot; credit, this</span>
<span class="cm">	 * packet cannot be bundled unless we add</span>
<span class="cm">	 * additional &quot;dummy&quot; padding (max 255 bytes) to</span>
<span class="cm">	 * consume the entire credit.</span>
<span class="cm">	 */</span>
	<span class="n">cred_pad</span> <span class="o">=</span> <span class="o">*</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">cred_sz</span> <span class="o">?</span> <span class="p">(</span><span class="n">cred_sz</span> <span class="o">-</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="o">:</span> <span class="n">rem_cred</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cred_pad</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cred_pad</span> <span class="o">&lt;=</span> <span class="mi">255</span><span class="p">))</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">+=</span> <span class="n">cred_pad</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* The amount of padding is too large, send as non-bundled */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cred_pad</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_tx_setup_scat_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">hif_scatter_req</span> <span class="o">*</span><span class="n">scat_req</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">n_scat</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rem_scat</span><span class="p">,</span> <span class="n">cred_pad</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">rem_scat</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_tx_bndl_sz</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_scat</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">CALC_TXRX_PADDED_LEN</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
					   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">);</span>

		<span class="n">cred_pad</span> <span class="o">=</span> <span class="n">htc_get_credit_padding</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cred_pad</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rem_scat</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rem_scat</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
		<span class="cm">/* now remove it from the queue */</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">packet</span> <span class="o">=</span> <span class="n">packet</span><span class="p">;</span>
		<span class="cm">/* prepare packet and flag message as part of a send bundle */</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span> <span class="o">|</span> <span class="n">HTC_FLAGS_SEND_BUNDLE</span><span class="p">;</span>
		<span class="n">ath6kl_htc_tx_prep_pkt</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
				       <span class="n">cred_pad</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">seqno</span><span class="p">);</span>
		<span class="cm">/* Make sure the buffer is 4-byte aligned */</span>
		<span class="n">ath6kl_htc_tx_buf_align</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
					<span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">);</span>
		<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_entries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;htc tx adding (%d) pkt 0x%p seqno %d len %d remaining %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">seqno</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rem_scat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Roll back scatter setup in case of any failure */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_entries</span> <span class="o">&lt;</span> <span class="n">HTC_MIN_HTC_MSGS_TO_BUNDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">packet</span> <span class="o">=</span> <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">packet</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>
				<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Drain a queue and send as bundles this function may return without fully</span>
<span class="cm"> * draining the queue when</span>
<span class="cm"> *</span>
<span class="cm"> *    1. scatter resources are exhausted</span>
<span class="cm"> *    2. a message that will consume a partial credit will stop the</span>
<span class="cm"> *    bundling process early</span>
<span class="cm"> *    3. we drop below the minimum number of messages for a bundle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_tx_bundle</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="o">*</span><span class="n">sent_bundle</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">n_bundle_pkts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hif_scatter_req</span> <span class="o">*</span><span class="n">scat_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_scat</span><span class="p">,</span> <span class="n">n_sent_bundle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tot_pkts_bundle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txb_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ac</span> <span class="o">=</span> <span class="n">WMM_NUM_AC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">HTC_CTRL_RSVD_SVC</span> <span class="o">!=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">WMI_CONTROL_SVC</span> <span class="o">!=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">))</span>
		<span class="n">ac</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ep2ac_map</span><span class="p">[</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">n_scat</span> <span class="o">=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">n_scat</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">n_scat</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n_scat</span> <span class="o">&lt;</span> <span class="n">HTC_MIN_HTC_MSGS_TO_BUNDLE</span><span class="p">)</span>
			<span class="cm">/* not enough to bundle */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">scat_req</span> <span class="o">=</span> <span class="n">hif_scatter_req_get</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scat_req</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no scatter resources  */</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;htc tx no more scatter resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ac</span> <span class="o">&lt;</span> <span class="n">WMM_NUM_AC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ac</span> <span class="o">!=</span> <span class="n">WMM_AC_BK</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">WMM_AC_BE</span> <span class="o">==</span> <span class="n">ac</span><span class="p">)</span>
				<span class="cm">/*</span>
<span class="cm">				 * BE, BK have priorities and bit</span>
<span class="cm">				 * positions reversed</span>
<span class="cm">				 */</span>
				<span class="n">txb_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WMM_AC_BK</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="cm">/*</span>
<span class="cm">				 * any AC with priority lower than</span>
<span class="cm">				 * itself</span>
<span class="cm">				 */</span>
				<span class="n">txb_mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ac</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * when the scatter request resources drop below a</span>
<span class="cm">			 * certain threshold, disable Tx bundling for all</span>
<span class="cm">			 * AC&#39;s with priority lower than the current requesting</span>
<span class="cm">			 * AC. Otherwise re-enable Tx bundling for them</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_q_depth</span> <span class="o">&lt;</span> <span class="n">ATH6KL_SCATTER_REQS</span><span class="p">)</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_bndl_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">txb_mask</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_bndl_mask</span> <span class="o">|=</span> <span class="n">txb_mask</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;htc tx pkts to scatter: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">n_scat</span><span class="p">);</span>

		<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_tx_setup_scat_list</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span>
						       <span class="n">scat_req</span><span class="p">,</span> <span class="n">n_scat</span><span class="p">,</span>
						       <span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hif_scatter_req_add</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span> <span class="n">scat_req</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* send path is always asynchronous */</span>
		<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">htc_async_tx_scat_complete</span><span class="p">;</span>
		<span class="n">n_sent_bundle</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tot_pkts_bundle</span> <span class="o">+=</span> <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_entries</span><span class="p">;</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;htc tx scatter bytes %d entries %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_entries</span><span class="p">);</span>
		<span class="n">ath6kl_hif_submit_scat_req</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">scat_req</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">sent_bundle</span> <span class="o">=</span> <span class="n">n_sent_bundle</span><span class="p">;</span>
	<span class="o">*</span><span class="n">n_bundle_pkts</span> <span class="o">=</span> <span class="n">tot_pkts_bundle</span><span class="p">;</span>
	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;htc tx bundle sent %d pkts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">n_sent_bundle</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_tx_from_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">txq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bundle_sent</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_pkts_bundle</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ac</span> <span class="o">=</span> <span class="n">WMM_NUM_AC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">tx_proc_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">tx_proc_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">tx_proc_cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;htc tx busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * drain the endpoint TX queue for transmission as long</span>
<span class="cm">	 * as we have enough credits.</span>
<span class="cm">	 */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">HTC_CTRL_RSVD_SVC</span> <span class="o">!=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">WMI_CONTROL_SVC</span> <span class="o">!=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">))</span>
		<span class="n">ac</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ep2ac_map</span><span class="p">[</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ath6kl_htc_tx_pkts_get</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

		<span class="n">bundle_sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">n_pkts_bundle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* try to send a bundle on each pass */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_bndl_mask</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="p">)</span> <span class="o">&gt;=</span>
			    <span class="n">HTC_MIN_HTC_MSGS_TO_BUNDLE</span><span class="p">))</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">temp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temp2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* check if bundling is enabled for an AC */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_bndl_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ac</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">ath6kl_htc_tx_bundle</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="p">,</span>
							     <span class="o">&amp;</span><span class="n">temp1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp2</span><span class="p">);</span>
					<span class="n">bundle_sent</span> <span class="o">+=</span> <span class="n">temp1</span><span class="p">;</span>
					<span class="n">n_pkts_bundle</span> <span class="o">+=</span> <span class="n">temp2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span>
						  <span class="n">list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

			<span class="n">ath6kl_htc_tx_prep_pkt</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>
					       <span class="mi">0</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">seqno</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_tx_issue</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
				<span class="n">packet</span><span class="o">-&gt;</span><span class="n">completion</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">tx_bundles</span> <span class="o">+=</span> <span class="n">bundle_sent</span><span class="p">;</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">tx_pkt_bundled</span> <span class="o">+=</span> <span class="n">n_pkts_bundle</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * if an AC has bundling disabled and no tx bundling</span>
<span class="cm">		 * has occured continously for a certain number of TX,</span>
<span class="cm">		 * enable tx bundling for this AC</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bundle_sent</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_bndl_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ac</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ac</span> <span class="o">&lt;</span> <span class="n">WMM_NUM_AC</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ac_tx_count</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">&gt;=</span>
					<span class="n">TX_RESUME_BUNDLE_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">target</span><span class="o">-&gt;</span><span class="n">ac_tx_count</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_bndl_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ac</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* tx bundling will reset the counter */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ac</span> <span class="o">&lt;</span> <span class="n">WMM_NUM_AC</span><span class="p">)</span>
				<span class="n">target</span><span class="o">-&gt;</span><span class="n">ac_tx_count</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">tx_proc_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">ath6kl_htc_tx_try</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">tx_pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_ep_callbacks</span> <span class="n">ep_cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txq_depth</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">overflow</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ep_cb</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">txq_depth</span> <span class="o">=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq_depth</span> <span class="o">&gt;=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">max_txq_depth</span><span class="p">)</span>
		<span class="n">overflow</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overflow</span><span class="p">)</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;htc tx overflow ep %d depth %d max %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span> <span class="n">txq_depth</span><span class="p">,</span>
			   <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">max_txq_depth</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">overflow</span> <span class="o">&amp;&amp;</span> <span class="n">ep_cb</span><span class="p">.</span><span class="n">tx_full</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">tx_full</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">tx_pkt</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">HTC_SEND_FULL_DROP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">tx_dropped</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_pkt</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">ath6kl_htc_tx_from_queue</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_chk_ep_txq</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint_credit_dist</span> <span class="o">*</span><span class="n">cred_dist</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Run through the credit distribution list to see if there are</span>
<span class="cm">	 * packets queued. NOTE: no locks need to be taken since the</span>
<span class="cm">	 * distribution list is not dynamic (cannot be re-ordered) and we</span>
<span class="cm">	 * are not modifying any state.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cred_dist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">endpoint</span> <span class="o">=</span> <span class="n">cred_dist</span><span class="o">-&gt;</span><span class="n">htc_ep</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;htc creds ep %d credits %d pkts %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">cred_dist</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span>
				   <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span><span class="p">,</span>
				   <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">));</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Try to start the stalled queue, this list is</span>
<span class="cm">			 * ordered by priority. If there are credits</span>
<span class="cm">			 * available the highest priority queue will get a</span>
<span class="cm">			 * chance to reclaim credits from lower priority</span>
<span class="cm">			 * ones.</span>
<span class="cm">			 */</span>
			<span class="n">ath6kl_htc_tx_from_queue</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_setup_tx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">send_pkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">send_pkt</span> <span class="o">=</span> <span class="n">htc_get_control_buf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">send_pkt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_tgt_ver</span> <span class="o">&gt;=</span> <span class="n">HTC_VERSION_2P1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">htc_setup_comp_ext_msg</span> <span class="o">*</span><span class="n">setup_comp_ext</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">setup_comp_ext</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">htc_setup_comp_ext_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">send_pkt</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">setup_comp_ext</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">setup_comp_ext</span><span class="p">));</span>
		<span class="n">setup_comp_ext</span><span class="o">-&gt;</span><span class="n">msg_id</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HTC_MSG_SETUP_COMPLETE_EX_ID</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Indicate HTC bundling to the target */</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">HTC_SETUP_COMP_FLG_RX_BNDL_EN</span><span class="p">;</span>
			<span class="n">setup_comp_ext</span><span class="o">-&gt;</span><span class="n">msg_per_rxbndl</span> <span class="o">=</span>
						<span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup_comp_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">setup_comp_ext</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
		<span class="n">set_htc_pkt_info</span><span class="p">(</span><span class="n">send_pkt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">setup_comp_ext</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_setup_comp_ext_msg</span><span class="p">),</span>
				 <span class="n">ENDPOINT_0</span><span class="p">,</span> <span class="n">HTC_SERVICE_TX_PACKET_TAG</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">htc_setup_comp_msg</span> <span class="o">*</span><span class="n">setup_comp</span><span class="p">;</span>
		<span class="n">setup_comp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_setup_comp_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">send_pkt</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">setup_comp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_setup_comp_msg</span><span class="p">));</span>
		<span class="n">setup_comp</span><span class="o">-&gt;</span><span class="n">msg_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HTC_MSG_SETUP_COMPLETE_ID</span><span class="p">);</span>
		<span class="n">set_htc_pkt_info</span><span class="p">(</span><span class="n">send_pkt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">setup_comp</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_setup_comp_msg</span><span class="p">),</span>
				 <span class="n">ENDPOINT_0</span><span class="p">,</span> <span class="n">HTC_SERVICE_TX_PACKET_TAG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* we want synchronous operation */</span>
	<span class="n">send_pkt</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ath6kl_htc_tx_prep_pkt</span><span class="p">(</span><span class="n">send_pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_tx_issue</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">send_pkt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_pkt</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">htc_reclaim_txctrl_buf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">send_pkt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_set_credit_dist</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ath6kl_htc_credit_info</span> <span class="o">*</span><span class="n">credit_info</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">srvc_pri_order</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">list_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ep</span><span class="p">;</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span> <span class="o">=</span> <span class="n">credit_info</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">ENDPOINT_0</span><span class="p">].</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">list</span><span class="p">,</span>
		      <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="n">ENDPOINT_1</span><span class="p">;</span> <span class="n">ep</span> <span class="o">&lt;</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span> <span class="n">ep</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">ep</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">srvc_pri_order</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">list</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_mbox_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queue</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;htc tx ep id %d buf 0x%p len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ath6kl_htc_tx_try</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">packet</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_flags</span> <span class="o">&amp;</span> <span class="n">HTC_OP_STATE_STOPPING</span><span class="p">)</span> <span class="o">?</span>
				 <span class="o">-</span><span class="n">ECANCELED</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">htc_tx_complete</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* flush endpoint TX queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_mbox_flush_txep</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">eid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">discard_q</span><span class="p">,</span> <span class="n">container</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">eid</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize the discard queue */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">discard_q</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tag</span> <span class="o">==</span> <span class="n">HTC_TX_PACKET_TAG_ALL</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">tag</span> <span class="o">==</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tag</span><span class="p">))</span>
			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">discard_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">discard_q</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;htc tx flushing pkt 0x%p len %d  ep %d tag 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">,</span>
			   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tag</span><span class="p">);</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
		<span class="n">htc_tx_complete</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">container</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_flush_txep_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dump_cred_dist_stats</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ENDPOINT_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="cm">/* not in use.. */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ath6kl_htc_mbox_flush_txep</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">HTC_TX_PACKET_TAG_ALL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_mbox_activity_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					     <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">eid</span><span class="p">,</span>
					     <span class="n">bool</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">eid</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">dist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">dist_flags</span> <span class="o">&amp;</span> <span class="n">HTC_EP_ACTIVE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">dist_flags</span> <span class="o">|=</span> <span class="n">HTC_EP_ACTIVE</span><span class="p">;</span>
			<span class="n">dist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">dist_flags</span> <span class="o">&amp;</span> <span class="n">HTC_EP_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">dist_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HTC_EP_ACTIVE</span><span class="p">;</span>
			<span class="n">dist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">txq_depth</span> <span class="o">=</span>
			<span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;htc tx activity ctxt 0x%p dist 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">);</span>

		<span class="n">ath6kl_credit_distribute</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">,</span>
					 <span class="n">HTC_CREDIT_DIST_ACTIVITY_CHANGE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">active</span><span class="p">)</span>
		<span class="n">htc_chk_ep_txq</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* HTC Rx */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_rx_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">,</span>
					      <span class="kt">int</span> <span class="n">n_look_ahds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">rx_pkts</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_look_ahds</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">rx_lkahds</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n_look_ahds</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">rx_bundle_lkahd</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">htc_valid_rx_frame_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">eid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">eid</span> <span class="o">==</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">ctrl_ep</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">len</span> <span class="o">&lt;=</span> <span class="n">ATH6KL_BUFFER_SIZE</span> <span class="o">:</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="n">ATH6KL_AMSDU_BUFFER_SIZE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_add_rxbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queue</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ath6kl_htc_mbox_add_rxbuf_multiple</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_reclaim_rxbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">HTC_RX_PKT_NO_RECYCLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">htc_rxpkt_reset</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">;</span>
		<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">htc_rxpkt_reset</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
		<span class="n">htc_add_rxbuf</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">target</span><span class="p">),</span> <span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reclaim_rx_ctrl_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_ctrl_rxbuf</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_rx_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">rx_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ath6kl_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">padded_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">padded_len</span> <span class="o">=</span> <span class="n">CALC_TXRX_PADDED_LEN</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padded_len</span> <span class="o">&gt;</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;not enough receive space for packet - padlen %d recvlen %d bufferlen %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">padded_len</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;htc rx 0x%p hdr x%x len %d mbox 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">exp_hdr</span><span class="p">,</span>
		   <span class="n">padded_len</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mbox_info</span><span class="p">.</span><span class="n">htc_addr</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">hif_read_write_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span>
				     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mbox_info</span><span class="p">.</span><span class="n">htc_addr</span><span class="p">,</span>
				     <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">padded_len</span><span class="p">,</span>
				     <span class="n">HIF_RD_SYNC_BLOCK_FIX</span><span class="p">);</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * optimization for recv packets, we can indicate a</span>
<span class="cm"> * &quot;hint&quot; that there are more  single-packets to fetch</span>
<span class="cm"> * on this endpoint.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_rx_set_indicate</span><span class="p">(</span><span class="n">u32</span> <span class="n">lk_ahd</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="n">htc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lk_ahd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">==</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">))</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">indicat_flags</span> <span class="o">|=</span>
					<span class="n">HTC_RX_FLAGS_INDICATE_MORE_PKTS</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_rx_chk_water_mark</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_ep_callbacks</span> <span class="n">ep_cb</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_refill_thresh</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">)</span>
		    <span class="o">&lt;</span> <span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_refill_thresh</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
			<span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_refill</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* This function is called with rx_lock held */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_rx_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="o">*</span><span class="n">lk_ahds</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="cm">/* FIXME: type of lk_ahds can&#39;t be right */</span>
	<span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="n">htc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">lk_ahds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_ep_callbacks</span> <span class="n">ep_cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">full_len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">no_recycle</span><span class="p">;</span>

	<span class="n">full_len</span> <span class="o">=</span> <span class="n">CALC_TXRX_PADDED_LEN</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">payld_len</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">htc_hdr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">htc_valid_rx_frame_len</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span> <span class="n">full_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;Rx buffer requested with invalid length htc_hdr:eid %d, flags 0x%x, len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span> <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">payld_len</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ep_cb</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n_msg</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Reset flag, any packets allocated using the</span>
<span class="cm">		 * rx_alloc() API cannot be recycled on</span>
<span class="cm">		 * cleanup,they must be explicitly returned.</span>
<span class="cm">		 */</span>
		<span class="n">no_recycle</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_allocthresh</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">full_len</span> <span class="o">&gt;</span> <span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_alloc_thresh</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">rx_alloc_thresh_hit</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">rxalloc_thresh_byte</span> <span class="o">+=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">payld_len</span><span class="p">);</span>

			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
			<span class="n">no_recycle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="n">packet</span> <span class="o">=</span> <span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_allocthresh</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span>
						      <span class="n">full_len</span><span class="p">);</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* refill handler is being used */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_refill</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
					<span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_refill</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">);</span>
					<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">))</span>
				<span class="n">packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_st_flags</span> <span class="o">|=</span> <span class="n">HTC_RECV_WAIT_BUFFERS</span><span class="p">;</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">ep_waiting</span> <span class="o">=</span> <span class="n">ep</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* clear flags */</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">indicat_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">no_recycle</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * flag that these packets cannot be</span>
<span class="cm">			 * recycled, they have to be returned to</span>
<span class="cm">			 * the user</span>
<span class="cm">			 */</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">HTC_RX_PKT_NO_RECYCLE</span><span class="p">;</span>

		<span class="cm">/* Caller needs to free this upon any failure */</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_flags</span> <span class="o">&amp;</span> <span class="n">HTC_OP_STATE_STOPPING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">HTC_RX_PKT_REFRESH_HDR</span><span class="p">;</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">exp_hdr</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* set expected look ahead */</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">exp_hdr</span> <span class="o">=</span> <span class="o">*</span><span class="n">lk_ahds</span><span class="p">;</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">payld_len</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_rx_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">lk_ahds</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">msg</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="n">htc_hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n_msg</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">htc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lk_ahds</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid ep in look-ahead: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">!=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid ep in look-ahead: %d should be : %d (index:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">payld_len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">HTC_MAX_PAYLOAD_LENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;payload len %d exceeds max htc : %d !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">payld_len</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">HTC_MAX_PAYLOAD_LENGTH</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;ep %d is not connected !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HTC_FLG_RX_BNDL_CNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * HTC header indicates that every packet to follow</span>
<span class="cm">			 * has the same padded length so that it can be</span>
<span class="cm">			 * optimally fetched as a full bundle.</span>
<span class="cm">			 */</span>
			<span class="n">n_msg</span> <span class="o">=</span> <span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HTC_FLG_RX_BNDL_CNT</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">HTC_FLG_RX_BNDL_CNT_S</span><span class="p">;</span>

			<span class="cm">/* the count doesn&#39;t include the starter frame */</span>
			<span class="n">n_msg</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n_msg</span> <span class="o">&gt;</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">rx_bundle_from_hdr</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;htc rx bundle pkts %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">n_msg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* HTC header only indicates 1 message to fetch */</span>
			<span class="n">n_msg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Setup packet buffers for each message */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_rx_setup</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lk_ahds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					     <span class="n">queue</span><span class="p">,</span> <span class="n">n_msg</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * This is due to unavailabilty of buffers to rx entire data.</span>
<span class="cm">		 * Return no error so that free buffers from queue can be used</span>
<span class="cm">		 * to receive partial data.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">htc_reclaim_rxbuf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_ctrl_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packets</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packets</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">!=</span> <span class="n">ENDPOINT_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packets</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reclaim_rx_ctrl_buf</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">packets</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packets</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;htc_ctrl_rx, got message with len:%zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">packets</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">);</span>

		<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				<span class="s">&quot;htc rx unexpected endpoint 0 message&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">packets</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">-</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">,</span>
				<span class="n">packets</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">htc_reclaim_rxbuf</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">packets</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_proc_cred_rpt</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">htc_credit_report</span> <span class="o">*</span><span class="n">rpt</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">n_entries</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">from_ep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tot_credits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">dist</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">rpt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rpt</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">rpt</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">];</span>

		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_CREDIT</span><span class="p">,</span>
			   <span class="s">&quot;credit report ep %d credits %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span> <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">);</span>

		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">tx_cred_rpt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">cred_retnd</span> <span class="o">+=</span> <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">from_ep</span> <span class="o">==</span> <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This credit report arrived on the same endpoint</span>
<span class="cm">			 * indicating it arrived in an RX packet.</span>
<span class="cm">			 */</span>
			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">cred_from_rx</span> <span class="o">+=</span> <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">;</span>
			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">cred_rpt_from_rx</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">from_ep</span> <span class="o">==</span> <span class="n">ENDPOINT_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* credit arrived on endpoint 0 as a NULL message */</span>
			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">cred_from_ep0</span> <span class="o">+=</span> <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">;</span>
			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">cred_rpt_ep0</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">cred_from_other</span> <span class="o">+=</span> <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">;</span>
			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">cred_rpt_from_other</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rpt</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">==</span> <span class="n">ENDPOINT_0</span><span class="p">)</span>
			<span class="cm">/* always give endpoint 0 credits back */</span>
			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">credits</span> <span class="o">+=</span> <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_to_dist</span> <span class="o">+=</span> <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">;</span>
			<span class="n">dist</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Refresh tx depth for distribution function that will</span>
<span class="cm">		 * recover these credits NOTE: this is only valid when</span>
<span class="cm">		 * there are credits to recover!</span>
<span class="cm">		 */</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">txq_depth</span> <span class="o">=</span>
			<span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

		<span class="n">tot_credits</span> <span class="o">+=</span> <span class="n">rpt</span><span class="o">-&gt;</span><span class="n">credits</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dist</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This was a credit return based on a completed send</span>
<span class="cm">		 * operations note, this is done with the lock held</span>
<span class="cm">		 */</span>
		<span class="n">ath6kl_credit_distribute</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">,</span>
					 <span class="n">HTC_CREDIT_DIST_SEND_COMPLETE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tot_credits</span><span class="p">)</span>
		<span class="n">htc_chk_ep_txq</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_parse_trailer</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">htc_record_hdr</span> <span class="o">*</span><span class="n">record</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="o">*</span><span class="n">record_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">next_lk_ahds</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">endpoint</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="o">*</span><span class="n">n_lk_ahds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_bundle_lkahd_rpt</span> <span class="o">*</span><span class="n">bundle_lkahd_rpt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_lookahead_report</span> <span class="o">*</span><span class="n">lk_ahd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">rec_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HTC_RECORD_CREDITS</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_credit_report</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">htc_proc_cred_rpt</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
				  <span class="p">(</span><span class="k">struct</span> <span class="n">htc_credit_report</span> <span class="o">*</span><span class="p">)</span> <span class="n">record_buf</span><span class="p">,</span>
				  <span class="n">len</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HTC_RECORD_LOOKAHEAD</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lk_ahd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">lk_ahd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_lookahead_report</span> <span class="o">*</span><span class="p">)</span> <span class="n">record_buf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lk_ahd</span><span class="o">-&gt;</span><span class="n">pre_valid</span> <span class="o">==</span> <span class="p">((</span><span class="o">~</span><span class="n">lk_ahd</span><span class="o">-&gt;</span><span class="n">post_valid</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">next_lk_ahds</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;htc rx lk_ahd found pre_valid 0x%x post_valid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">lk_ahd</span><span class="o">-&gt;</span><span class="n">pre_valid</span><span class="p">,</span> <span class="n">lk_ahd</span><span class="o">-&gt;</span><span class="n">post_valid</span><span class="p">);</span>

			<span class="cm">/* look ahead bytes are valid, copy them over */</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">next_lk_ahds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lk_ahd</span><span class="o">-&gt;</span><span class="n">lk_ahd</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
					<span class="s">&quot;htc rx next look ahead&quot;</span><span class="p">,</span>
					<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">next_lk_ahds</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

			<span class="o">*</span><span class="n">n_lk_ahds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HTC_RECORD_LOOKAHEAD_BUNDLE</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bundle_lkahd_rpt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">HTC_HOST_MAX_MSG_PER_BUNDLE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">next_lk_ahds</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">bundle_lkahd_rpt</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">htc_bundle_lkahd_rpt</span> <span class="o">*</span><span class="p">)</span> <span class="n">record_buf</span><span class="p">;</span>

			<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;htc rx bundle lk_ahd&quot;</span><span class="p">,</span>
					<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">record_buf</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">next_lk_ahds</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				       <span class="n">bundle_lkahd_rpt</span><span class="o">-&gt;</span><span class="n">lk_ahd</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">bundle_lkahd_rpt</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="o">*</span><span class="n">n_lk_ahds</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unhandled record: id:%d len:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">record</span><span class="o">-&gt;</span><span class="n">rec_id</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">htc_proc_trailer</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">next_lk_ahds</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="o">*</span><span class="n">n_lk_ahds</span><span class="p">,</span> <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">endpoint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_record_hdr</span> <span class="o">*</span><span class="n">record</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">record_buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">orig_buf</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;htc rx trailer len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">orig_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">orig_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_record_hdr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* these are byte aligned structs */</span>
		<span class="n">record</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_record_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_record_hdr</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_record_hdr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;invalid record len: %d (id:%d) buf has: %d bytes left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">rec_id</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">record_buf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">htc_parse_trailer</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">record_buf</span><span class="p">,</span>
					   <span class="n">next_lk_ahds</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="n">n_lk_ahds</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* advance buffer past this record for next time around */</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">record</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;htc rx bad trailer&quot;</span><span class="p">,</span>
				<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">orig_buf</span><span class="p">,</span> <span class="n">orig_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_rx_process_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="o">*</span><span class="n">next_lkahds</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">n_lkahds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">payload_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lk_ahd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="n">htc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n_lkahds</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">n_lkahds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * NOTE: we cannot assume the alignment of buf, so we use the safe</span>
<span class="cm">	 * macros to retrieve 16 bit fields.</span>
<span class="cm">	 */</span>
	<span class="n">payload_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">get_unaligned</span><span class="p">(</span><span class="o">&amp;</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">payld_len</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lk_ahd</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lk_ahd</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">HTC_RX_PKT_REFRESH_HDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Refresh the expected header and the actual length as it</span>
<span class="cm">		 * was unknown when this packet was grabbed as part of the</span>
<span class="cm">		 * bundle.</span>
<span class="cm">		 */</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">exp_hdr</span> <span class="o">=</span> <span class="n">lk_ahd</span><span class="p">;</span>
		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">=</span> <span class="n">payload_len</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>

		<span class="cm">/* validate the actual header that was refreshed  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">&gt;</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;refreshed hdr payload len (%d) in bundled recv is invalid (hdr: 0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">payload_len</span><span class="p">,</span> <span class="n">lk_ahd</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Limit this to max buffer just to print out some</span>
<span class="cm">			 * of the buffer.</span>
<span class="cm">			 */</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_rx</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">!=</span> <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;refreshed hdr ep (%d) does not match expected ep (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_rx</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lk_ahd</span> <span class="o">!=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">exp_hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;%s(): lk_ahd mismatch! (pPkt:0x%p flags:0x%X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span><span class="p">);</span>
		<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;htc rx expected lk_ahd&quot;</span><span class="p">,</span>
				<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">exp_hdr</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;htc rx current header&quot;</span><span class="p">,</span>
				<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">lk_ahd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lk_ahd</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_rx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HTC_FLG_RX_TRAILER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_record_hdr</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">payload_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;%s(): invalid hdr (payload len should be :%d, CB[0] is:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_rx</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">HTC_RX_PKT_IGNORE_LOOKAHEAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next_lkahds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">n_lkahds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">htc_proc_trailer</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span>
					  <span class="o">+</span> <span class="n">payload_len</span> <span class="o">-</span> <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					  <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">next_lkahds</span><span class="p">,</span>
					   <span class="n">n_lkahds</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_rx</span><span class="p">;</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">-=</span> <span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+=</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">-=</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>

<span class="nl">fail_rx:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">ath6kl_dbg_dump</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span> <span class="s">&quot;htc rx bad packet&quot;</span><span class="p">,</span>
				<span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_rx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">)</span>
<span class="p">{</span>
		<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
			   <span class="s">&quot;htc rx complete ep %d packet 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_rx_bundle</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">rxq</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">sync_compq</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">n_pkt_fetched</span><span class="p">,</span> <span class="n">bool</span> <span class="n">part_bundle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hif_scatter_req</span> <span class="o">*</span><span class="n">scat_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rem_space</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_rx_bndl_sz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_scat_pkt</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">n_scat_pkt</span> <span class="o">=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">rxq</span><span class="p">);</span>
	<span class="n">n_scat_pkt</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">n_scat_pkt</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">get_queue_depth</span><span class="p">(</span><span class="n">rxq</span><span class="p">)</span> <span class="o">-</span> <span class="n">n_scat_pkt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We were forced to split this bundle receive operation</span>
<span class="cm">		 * all packets in this partial bundle must have their</span>
<span class="cm">		 * lookaheads ignored.</span>
<span class="cm">		 */</span>
		<span class="n">part_bundle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * This would only happen if the target ignored our max</span>
<span class="cm">		 * bundle limit.</span>
<span class="cm">		 */</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;%s(): partial bundle detected num:%d , %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">__func__</span><span class="p">,</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">rxq</span><span class="p">),</span> <span class="n">n_scat_pkt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;htc rx bundle depth %d pkts %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">rxq</span><span class="p">),</span> <span class="n">n_scat_pkt</span><span class="p">);</span>

	<span class="n">scat_req</span> <span class="o">=</span> <span class="n">hif_scatter_req_get</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scat_req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_rx_pkt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_scat_pkt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pad_len</span><span class="p">;</span>

		<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">rxq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="n">pad_len</span> <span class="o">=</span> <span class="n">CALC_TXRX_PADDED_LEN</span><span class="p">(</span><span class="n">target</span><span class="p">,</span>
						   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rem_space</span> <span class="o">-</span> <span class="n">pad_len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">rxq</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rem_space</span> <span class="o">-=</span> <span class="n">pad_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">part_bundle</span> <span class="o">||</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n_scat_pkt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="cm">/*</span>
<span class="cm">			 * Packet 0..n-1 cannot be checked for look-aheads</span>
<span class="cm">			 * since we are fetching a bundle the last packet</span>
<span class="cm">			 * however can have it&#39;s lookahead used</span>
<span class="cm">			 */</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">|=</span>
			    <span class="n">HTC_RX_PKT_IGNORE_LOOKAHEAD</span><span class="p">;</span>

		<span class="cm">/* NOTE: 1 HTC packet per scatter entry */</span>
		<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">pad_len</span><span class="p">;</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">|=</span> <span class="n">HTC_RX_PKT_PART_OF_BUNDLE</span><span class="p">;</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="n">sync_compq</span><span class="p">);</span>

		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">scat_req</span><span class="o">-&gt;</span><span class="n">scat_entries</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_hif_submit_scat_req</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">scat_req</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="o">*</span><span class="n">n_pkt_fetched</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* free scatter request */</span>
	<span class="n">hif_scatter_req_add</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">,</span> <span class="n">scat_req</span><span class="p">);</span>

<span class="nl">fail_rx_pkt:</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_rx_process_packets</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">comp_pktq</span><span class="p">,</span>
					 <span class="n">u32</span> <span class="n">lk_ahds</span><span class="p">[],</span>
					 <span class="kt">int</span> <span class="o">*</span><span class="n">n_lk_ahd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="n">comp_pktq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">];</span>

		<span class="cm">/* process header for each of the recv packet */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_rx_process_hdr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">lk_ahds</span><span class="p">,</span>
						   <span class="n">n_lk_ahd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">comp_pktq</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Last packet&#39;s more packet flag is set</span>
<span class="cm">			 * based on the lookahead.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">n_lk_ahd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">ath6kl_htc_rx_set_indicate</span><span class="p">(</span><span class="n">lk_ahds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
							   <span class="n">ep</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/*</span>
<span class="cm">			 * Packets in a bundle automatically have</span>
<span class="cm">			 * this flag set.</span>
<span class="cm">			 */</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">indicat_flags</span> <span class="o">|=</span>
				<span class="n">HTC_RX_FLAGS_INDICATE_MORE_PKTS</span><span class="p">;</span>

		<span class="n">ath6kl_htc_rx_update_stats</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="o">*</span><span class="n">n_lk_ahd</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">&amp;</span> <span class="n">HTC_RX_PKT_PART_OF_BUNDLE</span><span class="p">)</span>
			<span class="n">ep</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">.</span><span class="n">rx_bundl</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">ath6kl_htc_rx_complete</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_rx_fetch</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">rx_pktq</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">comp_pktq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fetched_pkts</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">part_bundle</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">tmp_rxq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">;</span>

	<span class="cm">/* now go fetch the list of HTC packets */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">rx_pktq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fetched_pkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_rxq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_bndl_enable</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">get_queue_depth</span><span class="p">(</span><span class="n">rx_pktq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * There are enough packets to attempt a</span>
<span class="cm">			 * bundle transfer and recv bundling is</span>
<span class="cm">			 * allowed.</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_rx_bundle</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">rx_pktq</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">tmp_rxq</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">fetched_pkts</span><span class="p">,</span>
						      <span class="n">part_bundle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail_rx</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="n">rx_pktq</span><span class="p">))</span>
				<span class="n">part_bundle</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_rxq</span><span class="p">,</span> <span class="n">comp_pktq</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fetched_pkts</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">packet</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">rx_pktq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span>
						   <span class="n">list</span><span class="p">);</span>

			<span class="cm">/* fully synchronous */</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_is_singular</span><span class="p">(</span><span class="n">rx_pktq</span><span class="p">))</span>
				<span class="cm">/*</span>
<span class="cm">				 * look_aheads in all packet</span>
<span class="cm">				 * except the last one in the</span>
<span class="cm">				 * bundle must be ignored</span>
<span class="cm">				 */</span>
				<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">|=</span>
					<span class="n">HTC_RX_PKT_IGNORE_LOOKAHEAD</span><span class="p">;</span>

			<span class="cm">/* go fetch the packet */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_rx_packet</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span>
						      <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">);</span>

			<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_rxq</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail_rx</span><span class="p">;</span>

			<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_rxq</span><span class="p">,</span> <span class="n">comp_pktq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_rx:</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cleanup any packets we allocated but didn&#39;t use to</span>
<span class="cm">	 * actually fetch any packets.</span>
<span class="cm">	 */</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="n">rx_pktq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">htc_reclaim_rxbuf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp_rxq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">htc_reclaim_rxbuf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ath6kl_htc_rxmsg_pending_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">msg_look_ahead</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">num_pkts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packets</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">rx_pktq</span><span class="p">,</span> <span class="n">comp_pktq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">look_aheads</span><span class="p">[</span><span class="n">HTC_HOST_MAX_MSG_PER_BUNDLE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">num_look_ahead</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_fetched</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comp_pktq</span><span class="p">);</span>
	<span class="o">*</span><span class="n">num_pkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * On first entry copy the look_aheads into our temp array for</span>
<span class="cm">	 * processing</span>
<span class="cm">	 */</span>
	<span class="n">look_aheads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">msg_look_ahead</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * First lookahead sets the expected endpoint IDs for all</span>
<span class="cm">		 * packets in a bundle.</span>
<span class="cm">		 */</span>
		<span class="n">id</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">look_aheads</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">;</span>
		<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;MsgPend, invalid endpoint in look-ahead: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">id</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_pktq</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comp_pktq</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Try to allocate as many HTC RX packets indicated by the</span>
<span class="cm">		 * look_aheads.</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_rx_alloc</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">look_aheads</span><span class="p">,</span>
					     <span class="n">num_look_ahead</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">rx_pktq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_pktq</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * A recv bundle was detected, force IRQ status</span>
<span class="cm">			 * re-check again</span>
<span class="cm">			 */</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">chk_irq_status_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">n_fetched</span> <span class="o">+=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_pktq</span><span class="p">);</span>

		<span class="n">num_look_ahead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_rx_fetch</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_pktq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp_pktq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="n">ath6kl_htc_rx_chk_water_mark</span><span class="p">(</span><span class="n">endpoint</span><span class="p">);</span>

		<span class="cm">/* Process fetched packets */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_rx_process_packets</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp_pktq</span><span class="p">,</span>
						       <span class="n">look_aheads</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">num_look_ahead</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">num_look_ahead</span> <span class="o">||</span> <span class="n">status</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * For SYNCH processing, if we get here, we are running</span>
<span class="cm">		 * through the loop again due to a detected lookahead. Set</span>
<span class="cm">		 * flag that we should re-check IRQ status registers again</span>
<span class="cm">		 * before leaving IRQ processing, this can net better</span>
<span class="cm">		 * performance in high throughput situations.</span>
<span class="cm">		 */</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">chk_irq_status_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;failed to get pending recv messages: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">status</span><span class="p">);</span>

		<span class="cm">/* cleanup any packets in sync completion queue */</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packets</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp_pktq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packets</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">htc_reclaim_rxbuf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packets</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">packets</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_flags</span> <span class="o">&amp;</span> <span class="n">HTC_OP_STATE_STOPPING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;host is going to stop blocking receiver for htc_stop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ath6kl_hif_rx_control</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Before leaving, check to see if host ran out of buffers and</span>
<span class="cm">	 * needs to stop the receiver.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_st_flags</span> <span class="o">&amp;</span> <span class="n">HTC_RECV_WAIT_BUFFERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;host has no rx buffers blocking receiver to prevent overrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ath6kl_hif_rx_control</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">num_pkts</span> <span class="o">=</span> <span class="n">n_fetched</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Synchronously wait for a control message from the target,</span>
<span class="cm"> * This function is used at initialization time ONLY.  At init messages</span>
<span class="cm"> * on ENDPOINT 0 are expected.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="nf">htc_wait_for_ctrl_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="n">htc_hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">look_ahead</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_hif_poll_mboxmsg_rx</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">look_ahead</span><span class="p">,</span>
				       <span class="n">HTC_TARGET_RESPONSE_TIMEOUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;htc rx wait ctrl look_ahead 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">look_ahead</span><span class="p">);</span>

	<span class="n">htc_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_frame_hdr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">look_ahead</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">!=</span> <span class="n">ENDPOINT_0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">packet</span> <span class="o">=</span> <span class="n">htc_get_control_buf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">exp_hdr</span> <span class="o">=</span> <span class="n">look_ahead</span><span class="p">;</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">htc_hdr</span><span class="o">-&gt;</span><span class="n">payld_len</span><span class="p">)</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">&gt;</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_ctrl_rx</span><span class="p">;</span>

	<span class="cm">/* we want synchronous operation */</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* get the message from the device, this will block */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_htc_rx_packet</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail_ctrl_rx</span><span class="p">;</span>

	<span class="cm">/* process receive header */</span>
	<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_rx_process_hdr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;htc_wait_for_ctrl_msg, ath6kl_htc_rx_process_hdr failed (status = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_ctrl_rx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">packet</span><span class="p">;</span>

<span class="nl">fail_ctrl_rx:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">htc_rxpkt_reset</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
		<span class="n">reclaim_rx_ctrl_buf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_mbox_add_rxbuf_multiple</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">pkt_queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">first_pkt</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rx_unblock</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">depth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">first_pkt</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">htc_packet</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_pkt</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">depth</span> <span class="o">=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;htc rx add multiple ep id %d cnt %d len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">first_pkt</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">first_pkt</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">);</span>

	<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">first_pkt</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_flags</span> <span class="o">&amp;</span> <span class="n">HTC_OP_STATE_STOPPING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">;</span>

		<span class="cm">/* walk through queue and mark each one canceled */</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span> <span class="n">pkt_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">;</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">ath6kl_htc_rx_complete</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="n">list_splice_tail_init</span><span class="p">(</span><span class="n">pkt_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">);</span>

	<span class="cm">/* check if we are blocked waiting for a new buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_st_flags</span> <span class="o">&amp;</span> <span class="n">HTC_RECV_WAIT_BUFFERS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">ep_waiting</span> <span class="o">==</span> <span class="n">first_pkt</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;htc rx blocked on ep %d, unblocking</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">target</span><span class="o">-&gt;</span><span class="n">ep_waiting</span><span class="p">);</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_st_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HTC_RECV_WAIT_BUFFERS</span><span class="p">;</span>
			<span class="n">target</span><span class="o">-&gt;</span><span class="n">ep_waiting</span> <span class="o">=</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span>
			<span class="n">rx_unblock</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_unblock</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_flags</span> <span class="o">&amp;</span> <span class="n">HTC_OP_STATE_STOPPING</span><span class="p">))</span>
		<span class="cm">/* TODO : implement a buffer threshold count? */</span>
		<span class="n">ath6kl_hif_rx_control</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_mbox_flush_rx_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_pkt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ENDPOINT_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">)</span>
			<span class="cm">/* not in use.. */</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_pkt</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
			<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
				   <span class="s">&quot;htc rx flush pkt 0x%p  len %d  ep %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">packet</span><span class="p">,</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_len</span><span class="p">,</span>
				   <span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * packets in rx_bufq of endpoint 0 have originally</span>
<span class="cm">			 * been queued from target-&gt;free_ctrl_rxbuf where</span>
<span class="cm">			 * packet and packet-&gt;buf_start are allocated</span>
<span class="cm">			 * separately using kmalloc(). For other endpoint</span>
<span class="cm">			 * rx_bufq, it is allocated as skb where packet is</span>
<span class="cm">			 * skb-&gt;head. Take care of this difference while freeing</span>
<span class="cm">			 * the memory.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">==</span> <span class="n">ENDPOINT_0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_start</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">pkt_cntxt</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_mbox_conn_service</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">htc_service_connect_req</span> <span class="o">*</span><span class="n">conn_req</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">htc_service_connect_resp</span> <span class="o">*</span><span class="n">conn_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">rx_pkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">tx_pkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_conn_service_resp</span> <span class="o">*</span><span class="n">resp_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_conn_service_msg</span> <span class="o">*</span><span class="n">conn_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">assigned_ep</span> <span class="o">=</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_msg_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">msg_id</span><span class="p">;</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_HTC</span><span class="p">,</span>
		   <span class="s">&quot;htc connect service target 0x%p service id 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">target</span><span class="p">,</span> <span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">==</span> <span class="n">HTC_CTRL_RSVD_SVC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* special case for pseudo control service */</span>
		<span class="n">assigned_ep</span> <span class="o">=</span> <span class="n">ENDPOINT_0</span><span class="p">;</span>
		<span class="n">max_msg_sz</span> <span class="o">=</span> <span class="n">HTC_MAX_CTRL_MSG_LEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* allocate a packet to send to the target */</span>
		<span class="n">tx_pkt</span> <span class="o">=</span> <span class="n">htc_get_control_buf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_pkt</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">conn_msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_conn_service_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">tx_pkt</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">conn_msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">conn_msg</span><span class="p">));</span>
		<span class="n">conn_msg</span><span class="o">-&gt;</span><span class="n">msg_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HTC_MSG_CONN_SVC_ID</span><span class="p">);</span>
		<span class="n">conn_msg</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">);</span>
		<span class="n">conn_msg</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">conn_flags</span><span class="p">);</span>

		<span class="n">set_htc_pkt_info</span><span class="p">(</span><span class="n">tx_pkt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">conn_msg</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">conn_msg</span><span class="p">)</span> <span class="o">+</span> <span class="n">conn_msg</span><span class="o">-&gt;</span><span class="n">svc_meta_len</span><span class="p">,</span>
				 <span class="n">ENDPOINT_0</span><span class="p">,</span> <span class="n">HTC_SERVICE_TX_PACKET_TAG</span><span class="p">);</span>

		<span class="cm">/* we want synchronous operation */</span>
		<span class="n">tx_pkt</span><span class="o">-&gt;</span><span class="n">completion</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ath6kl_htc_tx_prep_pkt</span><span class="p">(</span><span class="n">tx_pkt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_tx_issue</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tx_pkt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>

		<span class="cm">/* wait for response */</span>
		<span class="n">rx_pkt</span> <span class="o">=</span> <span class="n">htc_wait_for_ctrl_msg</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_pkt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">resp_msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_conn_service_resp</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">msg_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">msg_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">msg_id</span> <span class="o">!=</span> <span class="n">HTC_MSG_CONN_SVC_RESP_ID</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">resp_msg</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">conn_resp</span><span class="o">-&gt;</span><span class="n">resp_code</span> <span class="o">=</span> <span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
		<span class="cm">/* check response status */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">HTC_SERVICE_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;target failed service 0x%X connect request (status:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">,</span> <span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">assigned_ep</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">htc_endpoint_id</span><span class="p">)</span><span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">eid</span><span class="p">;</span>
		<span class="n">max_msg_sz</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp_msg</span><span class="o">-&gt;</span><span class="n">max_msg_sz</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">assigned_ep</span> <span class="o">&gt;=</span> <span class="n">ENDPOINT_MAX</span> <span class="o">||</span> <span class="o">!</span><span class="n">max_msg_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">assigned_ep</span><span class="p">];</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">eid</span> <span class="o">=</span> <span class="n">assigned_ep</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* return assigned endpoint to caller */</span>
	<span class="n">conn_resp</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">assigned_ep</span><span class="p">;</span>
	<span class="n">conn_resp</span><span class="o">-&gt;</span><span class="n">len_max</span> <span class="o">=</span> <span class="n">max_msg_sz</span><span class="p">;</span>

	<span class="cm">/* setup the endpoint */</span>

	<span class="cm">/* this marks the endpoint in use */</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">;</span>

	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">max_txq_depth</span> <span class="o">=</span> <span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">max_txq_depth</span><span class="p">;</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">len_max</span> <span class="o">=</span> <span class="n">max_msg_sz</span><span class="p">;</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_cb</span> <span class="o">=</span> <span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">ep_cb</span><span class="p">;</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">;</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">htc_ep</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">;</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">assigned_ep</span><span class="p">;</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_sz</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WMI_DATA_BK_SVC</span>:
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">tx_drop_packet_threshold</span> <span class="o">=</span> <span class="n">MAX_DEF_COOKIE_NUM</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">tx_drop_packet_threshold</span> <span class="o">=</span> <span class="n">MAX_HI_COOKIE_NUM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">max_rxmsg_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Override cred_per_msg calculation, this optimizes</span>
<span class="cm">		 * the credit-low indications since the host will actually</span>
<span class="cm">		 * issue smaller messages in the Send path.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">max_rxmsg_sz</span> <span class="o">&gt;</span> <span class="n">max_msg_sz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_tx</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_per_msg</span> <span class="o">=</span>
		    <span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">max_rxmsg_sz</span> <span class="o">/</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_per_msg</span> <span class="o">=</span>
		    <span class="n">max_msg_sz</span> <span class="o">/</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_per_msg</span><span class="p">)</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">.</span><span class="n">cred_per_msg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* save local connection flags */</span>
	<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">conn_flags</span> <span class="o">=</span> <span class="n">conn_req</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

<span class="nl">fail_tx:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx_pkt</span><span class="p">)</span>
		<span class="n">htc_reclaim_txctrl_buf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tx_pkt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_pkt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">htc_rxpkt_reset</span><span class="p">(</span><span class="n">rx_pkt</span><span class="p">);</span>
		<span class="n">reclaim_rx_ctrl_buf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">rx_pkt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_ep_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_endpoint</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ENDPOINT_0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">cred_dist</span><span class="p">));</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">svc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">len_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">max_txq_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">ep_st</span><span class="p">));</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">rx_bufq</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>
		<span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reset distribution list */</span>
	<span class="cm">/* FIXME: free existing entries */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_mbox_get_rxbuf_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">htc_endpoint_id</span> <span class="n">endpoint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">num</span> <span class="o">=</span> <span class="n">get_queue_depth</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">endpoint</span><span class="p">].</span><span class="n">rx_bufq</span><span class="p">));</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">htc_setup_msg_bndl</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* limit what HTC can handle */</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">HTC_HOST_MAX_MSG_PER_BUNDLE</span><span class="p">,</span>
				       <span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ath6kl_hif_enable_scatter</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* limit bundle what the device layer can handle */</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">max_scat_entries</span><span class="p">,</span>
				       <span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
		   <span class="s">&quot;htc bundling allowed msg_per_bndl_max %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span><span class="p">);</span>

	<span class="cm">/* Max rx bundle size is limited by the max tx bundle size */</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">max_rx_bndl_sz</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_xfer_szper_scatreq</span><span class="p">;</span>
	<span class="cm">/* Max tx bundle size if limited by the extended mbox address range */</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">max_tx_bndl_sz</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">HIF_MBOX0_EXT_WIDTH</span><span class="p">,</span>
				     <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_xfer_szper_scatreq</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;htc max_rx_bndl_sz %d max_tx_bndl_sz %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_rx_bndl_sz</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">max_tx_bndl_sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">max_tx_bndl_sz</span><span class="p">)</span>
		<span class="cm">/* tx_bndl_mask is enabled per AC, each has 1 bit */</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_bndl_mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">WMM_NUM_AC</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">max_rx_bndl_sz</span><span class="p">)</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_bndl_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span> <span class="o">%</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">block_sz</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_warn</span><span class="p">(</span><span class="s">&quot;credit size: %d is not block aligned! Disabling send bundling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Disallow send bundling since the credit size is</span>
<span class="cm">		 * not aligned to a block size the I/O block</span>
<span class="cm">		 * padding will spill into the next credit buffer</span>
<span class="cm">		 * which is fatal.</span>
<span class="cm">		 */</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_bndl_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_mbox_wait_target</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_ready_ext_msg</span> <span class="o">*</span><span class="n">rdy_msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_service_connect_req</span> <span class="n">connect</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_service_connect_resp</span> <span class="n">resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* FIXME: remove once USB support is implemented */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hif_type</span> <span class="o">==</span> <span class="n">ATH6KL_HIF_TYPE_USB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;HTC doesn&#39;t support USB yet. Patience!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we should be getting 1 control message that the target is ready */</span>
	<span class="n">packet</span> <span class="o">=</span> <span class="n">htc_wait_for_ctrl_msg</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* we controlled the buffer creation so it&#39;s properly aligned */</span>
	<span class="n">rdy_msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">htc_ready_ext_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rdy_msg</span><span class="o">-&gt;</span><span class="n">ver2_0_info</span><span class="p">.</span><span class="n">msg_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HTC_MSG_READY_ID</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_ready_msg</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_wait_target</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdy_msg</span><span class="o">-&gt;</span><span class="n">ver2_0_info</span><span class="p">.</span><span class="n">cred_cnt</span> <span class="o">||</span> <span class="o">!</span><span class="n">rdy_msg</span><span class="o">-&gt;</span><span class="n">ver2_0_info</span><span class="p">.</span><span class="n">cred_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_wait_target</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_creds</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rdy_msg</span><span class="o">-&gt;</span><span class="n">ver2_0_info</span><span class="p">.</span><span class="n">cred_cnt</span><span class="p">);</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rdy_msg</span><span class="o">-&gt;</span><span class="n">ver2_0_info</span><span class="p">.</span><span class="n">cred_sz</span><span class="p">);</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span>
		   <span class="s">&quot;htc target ready credits %d size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_creds</span><span class="p">,</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_cred_sz</span><span class="p">);</span>

	<span class="cm">/* check if this is an extended ready message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_ready_ext_msg</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* this is an extended message */</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_tgt_ver</span> <span class="o">=</span> <span class="n">rdy_msg</span><span class="o">-&gt;</span><span class="n">htc_ver</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span> <span class="o">=</span> <span class="n">rdy_msg</span><span class="o">-&gt;</span><span class="n">msg_per_htc_bndl</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* legacy */</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_tgt_ver</span> <span class="o">=</span> <span class="n">HTC_VERSION_2P0</span><span class="p">;</span>
		<span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ath6kl_dbg</span><span class="p">(</span><span class="n">ATH6KL_DBG_BOOT</span><span class="p">,</span> <span class="s">&quot;htc using protocol %s (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_tgt_ver</span> <span class="o">==</span> <span class="n">HTC_VERSION_2P0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;2.0&quot;</span> <span class="o">:</span> <span class="s">&quot;&gt;= 2.1&quot;</span><span class="p">,</span>
		   <span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_tgt_ver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">msg_per_bndl_max</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">htc_setup_msg_bndl</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="cm">/* setup our pseudo HTC control endpoint connection */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">connect</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">resp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">resp</span><span class="p">));</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx</span> <span class="o">=</span> <span class="n">htc_ctrl_rx</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">rx_refill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">ep_cb</span><span class="p">.</span><span class="n">tx_full</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">max_txq_depth</span> <span class="o">=</span> <span class="n">NUM_CONTROL_BUFFERS</span><span class="p">;</span>
	<span class="n">connect</span><span class="p">.</span><span class="n">svc_id</span> <span class="o">=</span> <span class="n">HTC_CTRL_RSVD_SVC</span><span class="p">;</span>

	<span class="cm">/* connect fake service */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_conn_service</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connect</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: this call doesn&#39;t make sense, the caller should</span>
<span class="cm">		 * call ath6kl_htc_mbox_cleanup() when it wants remove htc</span>
<span class="cm">		 */</span>
		<span class="n">ath6kl_hif_cleanup_scatter</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">);</span>

<span class="nl">fail_wait_target:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">packet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">htc_rxpkt_reset</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
		<span class="n">reclaim_rx_ctrl_buf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Start HTC, enable interrupts and let the target know</span>
<span class="cm"> * host has finished setup.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_mbox_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_proc_reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_proc_reg</span><span class="p">));</span>

	<span class="cm">/* Disable interrupts at the chip level */</span>
	<span class="n">ath6kl_hif_disable_intrs</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_st_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Push control receive buffers into htc control endpoint */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">packet</span> <span class="o">=</span> <span class="n">htc_get_control_buf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">htc_add_rxbuf</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">packet</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NOTE: the first entry in the distribution list is ENDPOINT_0 */</span>
	<span class="n">ath6kl_credit_init</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">credit_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">,</span>
			   <span class="n">target</span><span class="o">-&gt;</span><span class="n">tgt_creds</span><span class="p">);</span>

	<span class="n">dump_cred_dist_stats</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="cm">/* Indicate to the target of the setup completion */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">htc_setup_tx_complete</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* unmask interrupts */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_hif_unmask_intrs</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">ath6kl_htc_mbox_stop</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ath6kl_htc_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">ctrl_bufsz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">reset_ep_state</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="n">block_size</span> <span class="o">=</span> <span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">mbox_info</span><span class="p">.</span><span class="n">block_size</span><span class="p">;</span>

	<span class="n">ctrl_bufsz</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_size</span> <span class="o">&gt;</span> <span class="n">HTC_MAX_CTRL_MSG_LEN</span><span class="p">)</span> <span class="o">?</span>
		      <span class="p">(</span><span class="n">block_size</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">)</span> <span class="o">:</span>
		      <span class="p">(</span><span class="n">HTC_MAX_CTRL_MSG_LEN</span> <span class="o">+</span> <span class="n">HTC_HDR_LENGTH</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_CONTROL_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">packet</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">packet</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_start</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ctrl_bufsz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_len</span> <span class="o">=</span> <span class="n">ctrl_bufsz</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_CONTROL_RX_BUFFERS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">act_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_start</span><span class="p">;</span>
			<span class="n">packet</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">=</span> <span class="n">ENDPOINT_0</span><span class="p">;</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_ctrl_rxbuf</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_ctrl_txbuf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* htc_stop: stop interrupt reception, and flush all queued buffers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_mbox_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_lock</span><span class="p">);</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_flags</span> <span class="o">|=</span> <span class="n">HTC_OP_STATE_STOPPING</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Masking interrupts is a synchronous operation, when this</span>
<span class="cm">	 * function returns all pending HIF I/O has completed, we can</span>
<span class="cm">	 * safely flush the queues.</span>
<span class="cm">	 */</span>
	<span class="n">ath6kl_hif_mask_intrs</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ath6kl_htc_flush_txep_all</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="n">ath6kl_htc_mbox_flush_rx_buf</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="n">ath6kl_htc_reset</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">ath6kl_htc_mbox_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">target</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">target</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ath6kl_err</span><span class="p">(</span><span class="s">&quot;unable to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_htc_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">htc_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_ctrl_txbuf</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_ctrl_rxbuf</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">cred_dist_list</span><span class="p">);</span>

	<span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">htc_cnxt</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
	<span class="n">target</span><span class="o">-&gt;</span><span class="n">ep_waiting</span> <span class="o">=</span> <span class="n">ENDPOINT_MAX</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_hif_setup</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_htc_cleanup</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ath6kl_htc_reset</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_htc_cleanup</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">target</span><span class="p">;</span>

<span class="nl">err_htc_cleanup:</span>
	<span class="n">ath6kl_htc_mbox_cleanup</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* cleanup the HTC instance */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ath6kl_htc_mbox_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">htc_target</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">htc_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_packet</span><span class="p">;</span>

	<span class="cm">/* FIXME: remove check once USB support is implemented */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="o">-&gt;</span><span class="n">hif_type</span> <span class="o">!=</span> <span class="n">ATH6KL_HIF_TYPE_USB</span><span class="p">)</span>
		<span class="n">ath6kl_hif_cleanup_scatter</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ar</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_packet</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_ctrl_txbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_start</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">tmp_packet</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">free_ctrl_rxbuf</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">packet</span><span class="o">-&gt;</span><span class="n">buf_start</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">packet</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">target</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ath6kl_htc_ops</span> <span class="n">ath6kl_htc_mbox_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_create</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_target</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_wait_target</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conn_service</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_conn_service</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cleanup</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_txep</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_flush_txep</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_rx_buf</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_flush_rx_buf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">activity_changed</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_activity_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rxbuf_num</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_get_rxbuf_num</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_rxbuf_multiple</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_add_rxbuf_multiple</span><span class="p">,</span>
	<span class="p">.</span><span class="n">credit_setup</span> <span class="o">=</span> <span class="n">ath6kl_htc_mbox_credit_setup</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ath6kl_htc_mbox_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ath6kl</span> <span class="o">*</span><span class="n">ar</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ar</span><span class="o">-&gt;</span><span class="n">htc_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ath6kl_htc_mbox_ops</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
